cscope 15 $HOME/Desktop/module_test/FS_module/pxt4/jbd3               0000177928
	@checkpoint.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<Œaû/ev’ts/jbd3.h
>

30 
šlše
 
	$__bufãr_uÆšk_fœ¡
(
jouº®_h—d
 *
jh
)

32 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

34 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh->b_cpprev;

35 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh->b_cpnext;

36 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
) {

37 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
->
b_ıÃxt
;

38 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
jh
)

39 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
NULL
;

41 
	}
}

48 
šlše
 
	$__bufãr_uÆšk
(
jouº®_h—d
 *
jh
)

50 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

52 
	`__bufãr_uÆšk_fœ¡
(
jh
);

53 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
) {

54 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
->
b_ıÃxt
;

55 ià(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
jh
)

56 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
NULL
;

58 
	}
}

65 
šlše
 
	$__bufãr_»lšk_io
(
jouº®_h—d
 *
jh
)

67 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

69 
	`__bufãr_uÆšk_fœ¡
(
jh
);

71 ià(!
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

72 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

74 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

75 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
->b_cpprev;

76 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

77 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

79 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 = 
jh
;

80 
	}
}

89 
	$__Œy_to_ä“_ı_buf
(
jouº®_h—d
 *
jh
)

91 
»t
 = 0;

92 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

94 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 && !
	`bufãr_locked
(
bh
) &&

95 !
	`bufãr_dœty
(
bh
è&& !
	`bufãr_wr™e_io_”rÜ
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

97 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

99  
»t
;

100 
	}
}

108 
	$__jbd3_log_wa™_fÜ_¥aû
(
jouº®_t
 *
jouº®
)

110 
nblocks
, 
¥aû_Ëá
;

113 
nblocks
 = 
	`jbd3_¥aû_Ãeded
(
jouº®
);

114 
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
nblocks
) {

115 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

116 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

129 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

130 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

131 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

134 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

135 
nblocks
 = 
	`jbd3_¥aû_Ãeded
(
jouº®
);

136 
¥aû_Ëá
 = 
	`jbd3_log_¥aû_Ëá
(
jouº®
);

137 ià(
¥aû_Ëá
 < 
nblocks
) {

138 
chk±
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
;

139 
tid_t
 
tid
 = 0;

141 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

142 
tid
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

143 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

144 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

145 ià(
chk±
) {

146 
	`jbd3_log_do_checkpošt
(
jouº®
);

147 } ià(
	`jbd3_ş—nup_jouº®_
(
jouº®
) == 0) {

150 } ià(
tid
) {

156 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

157 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

158 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

161 
	`´štk
(
KERN_ERR
 "%s:‚eeded %d blocks‡nd "

163 
__func__
, 
nblocks
, 
¥aû_Ëá
);

164 
	`´štk
(
KERN_ERR
 "%s:‚o wayo get more "

165 "jouº® s·û iÀ%s\n", 
__func__
,

166 
jouº®
->
j_devÇme
);

167 
	`WARN_ON
(1);

168 
	`jbd3_jouº®_abÜt
(
jouº®
, 0);

170 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

172 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

174 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

176 
	}
}

179 
	$__æush_b©ch
(
jouº®_t
 *
jouº®
, *
b©ch_couÁ
)

181 
i
;

182 
blk_¶ug
 
¶ug
;

184 
	`blk_¡¬t_¶ug
(&
¶ug
);

185 
i
 = 0; i < *
b©ch_couÁ
; i++)

186 
	`wr™e_dœty_bufãr
(
jouº®
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

187 
	`blk_fšish_¶ug
(&
¶ug
);

189 
i
 = 0; i < *
b©ch_couÁ
; i++) {

190 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_chk±_bhs
[
i
];

191 
	`BUFFER_TRACE
(
bh
, "brelse");

192 
	`__b»l£
(
bh
);

194 *
b©ch_couÁ
 = 0;

195 
	}
}

205 
	$jbd3_log_do_checkpošt
(
jouº®_t
 *
jouº®
)

207 
jouº®_h—d
 *
jh
;

208 
bufãr_h—d
 *
bh
;

209 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

210 
tid_t
 
this_tid
;

211 
»suÉ
, 
b©ch_couÁ
 = 0;

213 
	`jbd_debug
(1, "Start checkpoint\n");

220 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

221 
	`Œaû_jbd3_checkpošt
(
jouº®
, 
»suÉ
);

222 
	`jbd_debug
(1, "ş—nup_jouº®_„‘uºed %d\n", 
»suÉ
);

223 ià(
»suÉ
 <= 0)

224  
»suÉ
;

230 
»suÉ
 = 0;

231 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

232 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
)

233 
out
;

234 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

235 ià(
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 == 0)

236 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_chp_time
 = 
jiff›s
;

237 
this_tid
 = 
Œª§ùiÚ
->
t_tid
;

238 
»¡¬t
:

244 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

245 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

246 
out
;

249 
Œª§ùiÚ
->
t_checkpošt_li¡
) {

250 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

251 
bh
 = 
	`jh2bh
(
jh
);

253 ià(
	`bufãr_locked
(
bh
)) {

254 
	`g‘_bh
(
bh
);

255 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

256 
	`wa™_Ú_bufãr
(
bh
);

258 
	`BUFFER_TRACE
(
bh
, "brelse");

259 
	`__b»l£
(
bh
);

260 
»Œy
;

262 ià(
jh
->
b_Œª§ùiÚ
 !ğ
NULL
) {

263 
Œª§ùiÚ_t
 *
t
 = 
jh
->
b_Œª§ùiÚ
;

264 
tid_t
 
tid
 = 
t
->
t_tid
;

266 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_fÜûd_to_şo£
++;

267 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

268 ià(
	`uÆik–y
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
))

275 
	`´štk
(
KERN_ERR


277 
jouº®
->
j_devÇme
, (è
bh
->
b_blockÄ
);

279 ià(
b©ch_couÁ
)

280 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

281 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

290 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

291 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

292 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

293 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

294 
»¡¬t
;

296 ià(!
	`bufãr_dœty
(
bh
)) {

297 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

298 
»suÉ
 = -
EIO
;

299 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

300 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

302 
out
;

313 
	`BUFFER_TRACE
(
bh
, "queue");

314 
	`g‘_bh
(
bh
);

315 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jwr™e
(bh));

316 
jouº®
->
j_chk±_bhs
[
b©ch_couÁ
++] = 
bh
;

317 
	`__bufãr_»lšk_io
(
jh
);

318 
Œª§ùiÚ
->
t_chp_¡©s
.
cs_wr™‹n
++;

319 ià((
b©ch_couÁ
 =ğ
JBD3_NR_BATCH
) ||

320 
	`Ãed_»sched
() ||

321 
	`¥š_Ãedb»ak
(&
jouº®
->
j_li¡_lock
))

322 
uÆock_ªd_æush
;

325 ià(
b©ch_couÁ
) {

326 
uÆock_ªd_æush
:

327 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

328 
»Œy
:

329 ià(
b©ch_couÁ
)

330 
	`__æush_b©ch
(
jouº®
, &
b©ch_couÁ
);

331 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

332 
»¡¬t
;

339 
»¡¬t2
:

341 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
Œª§ùiÚ
 ||

342 
Œª§ùiÚ
->
t_tid
 !ğ
this_tid
)

343 
out
;

345 
Œª§ùiÚ
->
t_checkpošt_io_li¡
) {

346 
jh
 = 
Œª§ùiÚ
->
t_checkpošt_io_li¡
;

347 
bh
 = 
	`jh2bh
(
jh
);

348 ià(
	`bufãr_locked
(
bh
)) {

349 
	`g‘_bh
(
bh
);

350 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

351 
	`wa™_Ú_bufãr
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "brelse");

354 
	`__b»l£
(
bh
);

355 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

356 
»¡¬t2
;

358 ià(
	`uÆik–y
(
	`bufãr_wr™e_io_”rÜ
(
bh
)è&& !
»suÉ
)

359 
»suÉ
 = -
EIO
;

366 ià(
	`__jbd3_jouº®_»move_checkpošt
(
jh
))

369 
out
:

370 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

371 ià(
»suÉ
 < 0)

372 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»suÉ
);

374 
»suÉ
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

376  (
»suÉ
 < 0) ?„esult : 0;

377 
	}
}

397 
	$jbd3_ş—nup_jouº®_
(
jouº®_t
 *
jouº®
)

399 
tid_t
 
fœ¡_tid
;

400 
blockÄ
;

402 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

403  -
EIO
;

405 ià(!
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
blockÄ
))

407 
	`J_ASSERT
(
blockÄ
 != 0);

417 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
)

418 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

420  
	`__jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
blockÄ
);

421 
	}
}

435 
	$jouº®_ş—n_Úe_ı_li¡
(
jouº®_h—d
 *
jh
, 
boŞ
 
de¡roy
)

437 
jouº®_h—d
 *
Ï¡_jh
;

438 
jouº®_h—d
 *
Ãxt_jh
 = 
jh
;

439 
»t
;

441 ià(!
jh
)

444 
Ï¡_jh
 = 
jh
->
b_ı´ev
;

446 
jh
 = 
Ãxt_jh
;

447 
Ãxt_jh
 = 
jh
->
b_ıÃxt
;

448 ià(!
de¡roy
)

449 
»t
 = 
	`__Œy_to_ä“_ı_buf
(
jh
);

451 
»t
 = 
	`__jbd3_jouº®_»move_checkpošt
(
jh
) + 1;

452 ià(!
»t
)

454 ià(
»t
 == 2)

462 ià(
	`Ãed_»sched
())

464 } 
jh
 !ğ
Ï¡_jh
);

467 
	}
}

477 
	$__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®_t
 *
jouº®
, 
boŞ
 
de¡roy
)

479 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ï¡_Œª§ùiÚ
, *
Ãxt_Œª§ùiÚ
;

480 
»t
;

482 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

483 ià(!
Œª§ùiÚ
)

486 
Ï¡_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ı´ev
;

487 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

489 
Œª§ùiÚ
 = 
Ãxt_Œª§ùiÚ
;

490 
Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
->
t_ıÃxt
;

491 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->
t_checkpošt_li¡
,

492 
de¡roy
);

498 ià(
	`Ãed_»sched
())

500 ià(
»t
)

507 
»t
 = 
	`jouº®_ş—n_Úe_ı_li¡
(
Œª§ùiÚ
->

508 
t_checkpošt_io_li¡
, 
de¡roy
);

509 ià(
	`Ãed_»sched
())

516 ià(!
»t
)

518 } 
Œª§ùiÚ
 !ğ
Ï¡_Œª§ùiÚ
);

519 
	}
}

525 
	$jbd3_jouº®_de¡roy_checkpošt
(
jouº®_t
 *
jouº®
)

532 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

533 ià(!
jouº®
->
j_checkpošt_Œª§ùiÚs
) {

534 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

537 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
Œue
);

538 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

539 
	`cÚd_»sched
();

541 
	}
}

561 
	$__jbd3_jouº®_»move_checkpošt
(
jouº®_h—d
 *
jh
)

563 
Œª§ùiÚ_chp_¡©s_s
 *
¡©s
;

564 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

565 
jouº®_t
 *
jouº®
;

566 
»t
 = 0;

568 
	`JBUFFER_TRACE
(
jh
, "entry");

570 ià((
Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
è=ğ
NULL
) {

571 
	`JBUFFER_TRACE
(
jh
, "not onransaction");

572 
out
;

574 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

576 
	`JBUFFER_TRACE
(
jh
, "removing fromransaction");

577 
	`__bufãr_uÆšk
(
jh
);

578 
jh
->
b_ı_Œª§ùiÚ
 = 
NULL
;

579 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

581 ià(
Œª§ùiÚ
->
t_checkpošt_li¡
 !ğ
NULL
 ||

582 
Œª§ùiÚ
->
t_checkpošt_io_li¡
 !ğ
NULL
)

583 
out
;

594 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_FINISHED
)

595 
out
;

599 
¡©s
 = &
Œª§ùiÚ
->
t_chp_¡©s
;

600 ià(
¡©s
->
cs_chp_time
)

601 
¡©s
->
cs_chp_time
 = 
	`jbd3_time_diff
(stats->cs_chp_time,

602 
jiff›s
);

603 
	`Œaû_jbd3_checkpošt_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

604 
Œª§ùiÚ
->
t_tid
, 
¡©s
);

606 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

607 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ
);

608 
»t
 = 1;

609 
out
:

610  
»t
;

611 
	}
}

621 
	$__jbd3_jouº®_š£¹_checkpošt
(
jouº®_h—d
 *
jh
,

622 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

624 
	`JBUFFER_TRACE
(
jh
, "entry");

625 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_dœty
(
	`jh2bh
(jh)è|| 
	`bufãr_jbddœty
(jh2bh(jh)));

626 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

629 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
	`jh2bh
(
jh
));

630 
jh
->
b_ı_Œª§ùiÚ
 = 
Œª§ùiÚ
;

632 ià(!
Œª§ùiÚ
->
t_checkpošt_li¡
) {

633 
jh
->
b_ıÃxt
 = jh->
b_ı´ev
 = jh;

635 
jh
->
b_ıÃxt
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
;

636 
jh
->
b_ı´ev
 = 
Œª§ùiÚ
->
t_checkpošt_li¡
->b_cpprev;

637 
jh
->
b_ı´ev
->
b_ıÃxt
 = jh;

638 
jh
->
b_ıÃxt
->
b_ı´ev
 = jh;

640 
Œª§ùiÚ
->
t_checkpošt_li¡
 = 
jh
;

641 
	}
}

653 
	$__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

655 
	`as£¹_¥š_locked
(&
jouº®
->
j_li¡_lock
);

656 ià(
Œª§ùiÚ
->
t_ıÃxt
) {

657 
Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =ransaction->t_cpprev;

658 
Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =ransaction->t_cpnext;

659 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

660 
jouº®
->
j_checkpošt_Œª§ùiÚs
 =

661 
Œª§ùiÚ
->
t_ıÃxt
;

662 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
Œª§ùiÚ
)

663 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
NULL
;

666 
	`J_ASSERT
(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_FINISHED
);

667 
	`J_ASSERT
(
Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

668 
	`J_ASSERT
(
Œª§ùiÚ
->
t_fÜg‘
 =ğ
NULL
);

669 
	`J_ASSERT
(
Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

670 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

671 
	`J_ASSERT
(
Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
);

672 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) == 0);

673 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

674 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
Œª§ùiÚ
);

676 
	`Œaû_jbd3_drİ_Œª§ùiÚ
(
jouº®
, 
Œª§ùiÚ
);

678 
	`jbd_debug
(1, "Drİpšg¿n§ùiÚ %d,‡Î dÚe\n", 
Œª§ùiÚ
->
t_tid
);

679 
	}
}

	@commit.c

13 
	~<lšux/time.h
>

14 
	~<lšux/fs.h
>

15 
	~<lšux/jbd3.h
>

16 
	~<lšux/”ºo.h
>

17 
	~<lšux/¦ab.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/jiff›s.h
>

21 
	~<lšux/üc32.h
>

22 
	~<lšux/wr™eback.h
>

23 
	~<lšux/backšg-dev.h
>

24 
	~<lšux/bio.h
>

25 
	~<lšux/blkdev.h
>

26 
	~<lšux/b™İs.h
>

27 
	~<Œaû/ev’ts/jbd3.h
>

32 
	$jouº®_’d_bufãr_io_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

34 
bufãr_h—d
 *
Üig_bh
 = 
bh
->
b_´iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 ià(
u±od©e
)

38 
	`£t_bufãr_u±od©e
(
bh
);

40 
	`ş—r_bufãr_u±od©e
(
bh
);

41 ià(
Üig_bh
) {

42 
	`ş—r_b™_uÆock
(
BH_Shadow
, &
Üig_bh
->
b_¡©e
);

43 
	`smp_mb__aá”_©omic
();

44 
	`wake_up_b™
(&
Üig_bh
->
b_¡©e
, 
BH_Shadow
);

46 
	`uÆock_bufãr
(
bh
);

47 
	}
}

63 
	$»Ëa£_bufãr_·ge
(
bufãr_h—d
 *
bh
)

65 
·ge
 *page;

67 ià(
	`bufãr_dœty
(
bh
))

68 
nİe
;

69 ià(
	`©omic_»ad
(&
bh
->
b_couÁ
) != 1)

70 
nİe
;

71 
·ge
 = 
bh
->
b_·ge
;

72 ià(!
·ge
)

73 
nİe
;

74 ià(
·ge
->
m­pšg
)

75 
nİe
;

78 ià(!
	`Œylock_·ge
(
·ge
))

79 
nİe
;

81 
	`g‘_·ge
(
·ge
);

82 
	`__b»l£
(
bh
);

83 
	`Œy_to_ä“_bufãrs
(
·ge
);

84 
	`uÆock_·ge
(
·ge
);

85 
	`put_·ge
(
·ge
);

88 
nİe
:

89 
	`__b»l£
(
bh
);

90 
	}
}

92 
	$jbd3_comm™_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

94 
comm™_h—d”
 *
h
;

95 
__u32
 
csum
;

97 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

100 
h
 = (
comm™_h—d”
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty³
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`ıu_to_be32
(
csum
);

106 
	}
}

116 
	$jouº®_subm™_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

117 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
,

118 
bufãr_h—d
 **
cbh
,

119 
__u32
 
üc32_sum
)

121 
comm™_h—d”
 *
tmp
;

122 
bufãr_h—d
 *
bh
;

123 
»t
;

124 
time¥ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

131 
bh
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
comm™_Œª§ùiÚ
,

132 
JBD3_COMMIT_BLOCK
);

133 ià(!
bh
)

136 
tmp
 = (
comm™_h—d”
 *)
bh
->
b_d©a
;

137 
	`ktime_g‘_cßr£_»®_ts64
(&
now
);

138 
tmp
->
h_comm™_£c
 = 
	`ıu_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_comm™_n£c
 = 
	`ıu_to_be32
(
now
.
tv_n£c
);

141 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

142 
tmp
->
h_chksum_ty³
 = 
JBD3_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD3_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`ıu_to_be32
(
üc32_sum
);

146 
	`jbd3_comm™_block_csum_£t
(
jouº®
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_bufãr
(
bh
);

150 
	`ş—r_bufãr_dœty
(
bh
);

151 
	`£t_bufãr_u±od©e
(
bh
);

152 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

154 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
 &&

155 !
	`jbd3_has_ã©u»_async_comm™
(
jouº®
))

156 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
»t
;

163 
	}
}

169 
	$jouº®_wa™_Ú_comm™_»cÜd
(
jouº®_t
 *
jouº®
,

170 
bufãr_h—d
 *
bh
)

172 
»t
 = 0;

174 
	`ş—r_bufãr_dœty
(
bh
);

175 
	`wa™_Ú_bufãr
(
bh
);

177 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

178 
»t
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
»t
;

182 
	}
}

190 
	$jouº®_subm™_šode_d©a_bufãrs
(
add»ss_¥aû
 *
m­pšg
)

192 
»t
;

193 
wr™eback_cÚŒŞ
 
wbc
 = {

194 .
sync_mode
 = 
WB_SYNC_ALL
,

195 .
Ä_to_wr™e
 = 
m­pšg
->
Ä·ges
 * 2,

196 .
¿nge_¡¬t
 = 0,

197 .
¿nge_’d
 = 
	`i_size_»ad
(
m­pšg
->
ho¡
),

200 
»t
 = 
	`g’”ic_wr™•ages
(
m­pšg
, &
wbc
);

201  
»t
;

202 
	}
}

212 
	$jouº®_subm™_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

213 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

215 
jbd3_šode
 *
jšode
;

216 
”r
, 
»t
 = 0;

217 
add»ss_¥aû
 *
m­pšg
;

219 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

220 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

221 ià(!(
jšode
->
i_æags
 & 
JI_WRITE_DATA
))

223 
m­pšg
 = 
jšode
->
i_vfs_šode
->
i_m­pšg
;

224 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

225 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

232 
	`Œaû_jbd3_subm™_šode_d©a
(
jšode
->
i_vfs_šode
);

233 
”r
 = 
	`jouº®_subm™_šode_d©a_bufãrs
(
m­pšg
);

234 ià(!
»t
)

235 
»t
 = 
”r
;

236 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

237 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

238 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

239 
	`smp_mb
();

240 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

242 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

243  
»t
;

244 
	}
}

251 
	$jouº®_fšish_šode_d©a_bufãrs
(
jouº®_t
 *
jouº®
,

252 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
)

254 
jbd3_šode
 *
jšode
, *
Ãxt_i
;

255 
”r
, 
»t
 = 0;

258 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

259 
	`li¡_fÜ_—ch_’Œy
(
jšode
, &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

260 ià(!(
jšode
->
i_æags
 & 
JI_WAIT_DATA
))

262 
jšode
->
i_æags
 |ğ
JI_COMMIT_RUNNING
;

263 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

264 
”r
 = 
	`fem­_fd©awa™_k“p_”rÜs
(

265 
jšode
->
i_vfs_šode
->
i_m­pšg
);

266 ià(!
»t
)

267 
»t
 = 
”r
;

268 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

269 
jšode
->
i_æags
 &ğ~
JI_COMMIT_RUNNING
;

270 
	`smp_mb
();

271 
	`wake_up_b™
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

275 
	`li¡_fÜ_—ch_’Œy_§ã
(
jšode
, 
Ãxt_i
,

276 &
comm™_Œª§ùiÚ
->
t_šode_li¡
, 
i_li¡
) {

277 
	`li¡_d–
(&
jšode
->
i_li¡
);

278 ià(
jšode
->
i_Ãxt_Œª§ùiÚ
) {

279 
jšode
->
i_Œª§ùiÚ
 = jšode->
i_Ãxt_Œª§ùiÚ
;

280 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

281 
	`li¡_add
(&
jšode
->
i_li¡
,

282 &
jšode
->
i_Œª§ùiÚ
->
t_šode_li¡
);

284 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

287 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

289  
»t
;

290 
	}
}

292 
__u32
 
	$jbd3_checksum_d©a
(
__u32
 
üc32_sum
, 
bufãr_h—d
 *
bh
)

294 
·ge
 *·gğ
bh
->
b_·ge
;

295 *
addr
;

296 
__u32
 
checksum
;

298 
addr
 = 
	`km­_©omic
(
·ge
);

299 
checksum
 = 
	`üc32_be
(
üc32_sum
,

300 (*)(
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
)), bh->
b_size
);

301 
	`kunm­_©omic
(
addr
);

303  
checksum
;

304 
	}
}

306 
	$wr™e_g_block
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

307 
block
)

309 
g
->
t_blockÄ
 = 
	`ıu_to_be32
(
block
 & (
u32
)~0);

310 ià(
	`jbd3_has_ã©u»_64b™
(
j
))

311 
g
->
t_blockÄ_high
 = 
	`ıu_to_be32
((
block
 >> 31) >> 1);

312 
	}
}

314 
	$jbd3_block_g_csum_£t
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

315 
bufãr_h—d
 *
bh
, 
__u32
 
£qu’û
)

317 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

318 
·ge
 *·gğ
bh
->
b_·ge
;

319 
__u8
 *
addr
;

320 
__u32
 
csum32
;

321 
__be32
 
£q
;

323 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

326 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

327 
addr
 = 
	`km­_©omic
(
·ge
);

328 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

329 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
addr
 + 
	`off£t_š_·ge
(
bh
->
b_d©a
),

330 
bh
->
b_size
);

331 
	`kunm­_©omic
(
addr
);

333 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

334 
g3
->
t_checksum
 = 
	`ıu_to_be32
(
csum32
);

336 
g
->
t_checksum
 = 
	`ıu_to_be16
(
csum32
);

337 
	}
}

344 
	$jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®_t
 *
jouº®
)

346 
Œª§ùiÚ_¡©s_s
 
¡©s
;

347 
Œª§ùiÚ_t
 *
comm™_Œª§ùiÚ
;

348 
jouº®_h—d
 *
jh
;

349 
bufãr_h—d
 *
desütÜ
;

350 
bufãr_h—d
 **
wbuf
 = 
jouº®
->
j_wbuf
;

351 
bufs
;

352 
æags
;

353 
”r
;

354 
blockÄ
;

355 
ktime_t
 
¡¬t_time
;

356 
u64
 
comm™_time
;

357 *
gp
 = 
NULL
;

358 
jouº®_block_g_t
 *
g
 = 
NULL
;

359 
¥aû_Ëá
 = 0;

360 
fœ¡_g
 = 0;

361 
g_æag
;

362 
i
;

363 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

364 
bufãr_h—d
 *
cbh
 = 
NULL
;

365 
__u32
 
üc32_sum
 = ~0;

366 
blk_¶ug
 
¶ug
;

368 
fœ¡_block
;

369 
tid_t
 
fœ¡_tid
;

370 
upd©e_
;

371 
csum_size
 = 0;

372 
	`LIST_HEAD
(
io_bufs
);

373 
	`LIST_HEAD
(
log_bufs
);

375 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

376 
csum_size
 = (
jbd3_jouº®_block_
);

384 ià(
jouº®
->
j_æags
 & 
JBD3_FLUSHED
) {

385 
	`jbd_debug
(3, "super block updated\n");

386 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

393 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

394 
jouº®
->
j__£qu’û
,

395 
jouº®
->
j_
,

396 
REQ_SYNC
);

397 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

399 
	`jbd_debug
(3, "superblock‚ot updated\n");

402 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 !ğ
NULL
);

403 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

405 
comm™_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

407 
	`Œaû_jbd3_¡¬t_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

408 
	`jbd_debug
(1, "JBD3: starting commit ofransaction %d\n",

409 
comm™_Œª§ùiÚ
->
t_tid
);

411 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

412 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

413 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_LOCKED
;

415 
	`Œaû_jbd3_comm™_lockšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

416 
¡©s
.
run
.
rs_wa™
 = 
comm™_Œª§ùiÚ
->
t_max_wa™
;

417 
¡©s
.
run
.
rs_»que¡_d–ay
 = 0;

418 
¡©s
.
run
.
rs_locked
 = 
jiff›s
;

419 ià(
comm™_Œª§ùiÚ
->
t_»que¡ed
)

420 
¡©s
.
run
.
rs_»que¡_d–ay
 =

421 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_»que¡ed
,

422 
¡©s
.
run
.
rs_locked
);

423 
¡©s
.
run
.
rs_ruÂšg
 = 
	`jbd3_time_diff
(
comm™_Œª§ùiÚ
->
t_¡¬t
,

424 
¡©s
.
run
.
rs_locked
);

426 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

427 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

428 
	`DEFINE_WAIT
(
wa™
);

430 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

431 
TASK_UNINTERRUPTIBLE
);

432 ià(
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_upd©es
)) {

433 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

434 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

435 
	`scheduË
();

436 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

437 
	`¥š_lock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

439 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

441 
	`¥š_uÆock
(&
comm™_Œª§ùiÚ
->
t_hªdË_lock
);

442 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_SWITCH
;

443 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

445 
	`J_ASSERT
 (
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) <=

446 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

464 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
) {

465 
jh
 = 
comm™_Œª§ùiÚ
->
t_»£rved_li¡
;

466 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:„efile");

471 ià(
jh
->
b_comm™‹d_d©a
) {

472 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

474 
	`jbd_lock_bh_¡©e
(
bh
);

475 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

476 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

477 
	`jbd_uÆock_bh_¡©e
(
bh
);

479 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

487 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

488 
	`__jbd3_jouº®_ş—n_checkpošt_li¡
(
jouº®
, 
çl£
);

489 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

491 
	`jbd_debug
(3, "JBD3: commit…hase 1\n");

497 
	`jbd3_ş—r_bufãr_»voked_æags
(
jouº®
);

502 
	`jbd3_jouº®_sw™ch_»voke_bË
(
jouº®
);

507 
	`©omic_sub
(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
),

508 &
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

510 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

511 
	`Œaû_jbd3_comm™_æushšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

512 
¡©s
.
run
.
rs_æushšg
 = 
jiff›s
;

513 
¡©s
.
run
.
rs_locked
 = 
	`jbd3_time_diff
(stats.run.rs_locked,

514 
¡©s
.
run
.
rs_æushšg
);

516 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FLUSH
;

517 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
comm™_Œª§ùiÚ
;

518 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
NULL
;

519 
¡¬t_time
 = 
	`ktime_g‘
();

520 
comm™_Œª§ùiÚ
->
t_log_¡¬t
 = 
jouº®
->
j_h—d
;

521 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

522 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

524 
	`jbd_debug
(3, "JBD3: commit…hase 2a\n");

530 
”r
 = 
	`jouº®_subm™_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

531 ià(
”r
)

532 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

534 
	`blk_¡¬t_¶ug
(&
¶ug
);

535 
	`jbd3_jouº®_wr™e_»voke_»cÜds
(
comm™_Œª§ùiÚ
, &
log_bufs
);

537 
	`jbd_debug
(3, "JBD3: commit…hase 2b\n");

544 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

545 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT
;

546 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

548 
	`Œaû_jbd3_comm™_loggšg
(
jouº®
, 
comm™_Œª§ùiÚ
);

549 
¡©s
.
run
.
rs_loggšg
 = 
jiff›s
;

550 
¡©s
.
run
.
rs_æushšg
 = 
	`jbd3_time_diff
(stats.run.rs_flushing,

551 
¡©s
.
run
.
rs_loggšg
);

552 
¡©s
.
run
.
rs_blocks
 =

553 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

554 
¡©s
.
run
.
rs_blocks_logged
 = 0;

556 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_Ä_bufãrs
 <=

557 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
));

559 
”r
 = 0;

560 
bufs
 = 0;

561 
desütÜ
 = 
NULL
;

562 
comm™_Œª§ùiÚ
->
t_bufãrs
) {

566 
jh
 = 
comm™_Œª§ùiÚ
->
t_bufãrs
;

571 ià(
	`is_jouº®_abÜ‹d
(
jouº®
)) {

572 
	`ş—r_bufãr_jbddœty
(
	`jh2bh
(
jh
));

573 
	`JBUFFER_TRACE
(
jh
, "journal is‡borting:„efile");

574 
	`jbd3_bufãr_abÜt_Œigg”
(
jh
,

575 
jh
->
b_äoz’_d©a
 ?

576 
jh
->
b_äoz’_Œigg”s
 :

577 
jh
->
b_Œigg”s
);

578 
	`jbd3_jouº®_»fe_bufãr
(
jouº®
, 
jh
);

583 ià(!
comm™_Œª§ùiÚ
->
t_bufãrs
)

584 
¡¬t_jouº®_io
;

591 ià(!
desütÜ
) {

592 
	`J_ASSERT
 (
bufs
 == 0);

594 
	`jbd_debug
(4, "JBD3: get descriptor\n");

596 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(

597 
comm™_Œª§ùiÚ
,

598 
JBD3_DESCRIPTOR_BLOCK
);

599 ià(!
desütÜ
) {

600 
	`jbd3_jouº®_abÜt
(
jouº®
, -
EIO
);

604 
	`jbd_debug
(4, "JBD3: got buffer %llu (%p)\n",

605 ()
desütÜ
->
b_blockÄ
,

606 
desütÜ
->
b_d©a
);

607 
gp
 = &
desütÜ
->
b_d©a
[(
jouº®_h—d”_t
)];

608 
¥aû_Ëá
 = 
desütÜ
->
b_size
 -

609 (
jouº®_h—d”_t
);

610 
fœ¡_g
 = 1;

611 
	`£t_bufãr_jwr™e
(
desütÜ
);

612 
	`£t_bufãr_dœty
(
desütÜ
);

613 
wbuf
[
bufs
++] = 
desütÜ
;

617 
	`BUFFER_TRACE
(
desütÜ
, "ph3: file‡s descriptor");

618 
	`jbd3_fe_log_bh
(&
log_bufs
, 
desütÜ
);

623 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

627 ià(
”r
) {

628 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

637 
	`©omic_dec
(&
comm™_Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

642 
	`©omic_šc
(&
	`jh2bh
(
jh
)->
b_couÁ
);

648 
	`£t_b™
(
BH_JWr™e
, &
	`jh2bh
(
jh
)->
b_¡©e
);

649 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

650 
æags
 = 
	`jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
comm™_Œª§ùiÚ
,

651 
jh
, &
wbuf
[
bufs
], 
blockÄ
);

652 ià(
æags
 < 0) {

653 
	`jbd3_jouº®_abÜt
(
jouº®
, 
æags
);

656 
	`jbd3_fe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

661 
g_æag
 = 0;

662 ià(
æags
 & 1)

663 
g_æag
 |ğ
JBD3_FLAG_ESCAPE
;

664 ià(!
fœ¡_g
)

665 
g_æag
 |ğ
JBD3_FLAG_SAME_UUID
;

667 
g
 = (
jouº®_block_g_t
 *è
gp
;

668 
	`wr™e_g_block
(
jouº®
, 
g
, 
	`jh2bh
(
jh
)->
b_blockÄ
);

669 
g
->
t_æags
 = 
	`ıu_to_be16
(
g_æag
);

670 
	`jbd3_block_g_csum_£t
(
jouº®
, 
g
, 
wbuf
[
bufs
],

671 
comm™_Œª§ùiÚ
->
t_tid
);

672 
gp
 +ğ
g_by‹s
;

673 
¥aû_Ëá
 -ğ
g_by‹s
;

674 
bufs
++;

676 ià(
fœ¡_g
) {

677 
	`memıy
 (
gp
, 
jouº®
->
j_uuid
, 16);

678 
gp
 += 16;

679 
¥aû_Ëá
 -= 16;

680 
fœ¡_g
 = 0;

686 ià(
bufs
 =ğ
jouº®
->
j_wbufsize
 ||

687 
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
 ||

688 
¥aû_Ëá
 < 
g_by‹s
 + 16 + 
csum_size
) {

690 
	`jbd_debug
(4, "JBD3: Subm™ %d IOs\n", 
bufs
);

696 
g
->
t_æags
 |ğ
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
);

697 
¡¬t_jouº®_io
:

698 ià(
desütÜ
)

699 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
,

700 
desütÜ
);

702 
i
 = 0; i < 
bufs
; i++) {

703 
bufãr_h—d
 *
bh
 = 
wbuf
[
i
];

707 ià(
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

708 
üc32_sum
 =

709 
	`jbd3_checksum_d©a
(
üc32_sum
, 
bh
);

712 
	`lock_bufãr
(
bh
);

713 
	`ş—r_bufãr_dœty
(
bh
);

714 
	`£t_bufãr_u±od©e
(
bh
);

715 
bh
->
b_’d_io
 = 
jouº®_’d_bufãr_io_sync
;

716 
	`subm™_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

718 
	`cÚd_»sched
();

719 
¡©s
.
run
.
rs_blocks_logged
 +ğ
bufs
;

723 
desütÜ
 = 
NULL
;

724 
bufs
 = 0;

728 
”r
 = 
	`jouº®_fšish_šode_d©a_bufãrs
(
jouº®
, 
comm™_Œª§ùiÚ
);

729 ià(
”r
) {

730 
	`´štk
(
KERN_WARNING


732 "Ú %s\n", 
jouº®
->
j_devÇme
);

733 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT_ON_SYNCDATA_ERR
)

734 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

735 
”r
 = 0;

745 
upd©e_
 =

746 
	`jbd3_jouº®_g‘_log_
(
jouº®
, &
fœ¡_tid
, &
fœ¡_block
);

748 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

749 ià(
upd©e_
) {

750 
ä“d
 = 
fœ¡_block
 - 
jouº®
->
j_
;

752 ià(
fœ¡_block
 < 
jouº®
->
j_
)

753 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

755 ià(
ä“d
 < 
jouº®
->
j_maxËn
 / 4)

756 
upd©e_
 = 0;

758 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT
);

759 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_DFLUSH
;

760 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

767 ià(
comm™_Œª§ùiÚ
->
t_Ãed_d©a_æush
 &&

768 (
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) &&

769 (
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

770 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

773 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

774 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

775 &
cbh
, 
üc32_sum
);

776 ià(
”r
)

777 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

780 
	`blk_fšish_¶ug
(&
¶ug
);

793 
	`jbd_debug
(3, "JBD3: commit…hase 3\n");

795 !
	`li¡_em±y
(&
io_bufs
)) {

796 
bufãr_h—d
 *
bh
 = 
	`li¡_’Œy
(
io_bufs
.
´ev
,

797 
bufãr_h—d
,

798 
b_assoc_bufãrs
);

800 
	`wa™_Ú_bufãr
(
bh
);

801 
	`cÚd_»sched
();

803 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

804 
”r
 = -
EIO
;

805 
	`jbd3_unfe_log_bh
(
bh
);

811 
	`BUFFER_TRACE
(
bh
, "dumpingemporary bh");

812 
	`__b»l£
(
bh
);

813 
	`J_ASSERT_BH
(
bh
, 
	`©omic_»ad
(&bh->
b_couÁ
) == 0);

814 
	`ä“_bufãr_h—d
(
bh
);

817 
jh
 = 
comm™_Œª§ùiÚ
->
t_shadow_li¡
->
b_»v
;

818 
bh
 = 
	`jh2bh
(
jh
);

819 
	`ş—r_bufãr_jwr™e
(
bh
);

820 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbddœty
(bh));

821 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_shadow
(bh));

827 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Forget");

828 
	`jbd3_jouº®_fe_bufãr
(
jh
, 
comm™_Œª§ùiÚ
, 
BJ_FÜg‘
);

829 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

830 
	`__b»l£
(
bh
);

833 
	`J_ASSERT
 (
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

835 
	`jbd_debug
(3, "JBD3: commit…hase 4\n");

838 !
	`li¡_em±y
(&
log_bufs
)) {

839 
bufãr_h—d
 *
bh
;

841 
bh
 = 
	`li¡_’Œy
(
log_bufs
.
´ev
, 
bufãr_h—d
, 
b_assoc_bufãrs
);

842 
	`wa™_Ú_bufãr
(
bh
);

843 
	`cÚd_»sched
();

845 ià(
	`uÆik–y
(!
	`bufãr_u±od©e
(
bh
)))

846 
”r
 = -
EIO
;

848 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

849 
	`ş—r_bufãr_jwr™e
(
bh
);

850 
	`jbd3_unfe_log_bh
(
bh
);

851 
	`__b»l£
(
bh
);

855 ià(
”r
)

856 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

858 
	`jbd_debug
(3, "JBD3: commit…hase 5\n");

859 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

860 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_DFLUSH
);

861 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_JFLUSH
;

862 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

864 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

865 
”r
 = 
	`jouº®_subm™_comm™_»cÜd
(
jouº®
, 
comm™_Œª§ùiÚ
,

866 &
cbh
, 
üc32_sum
);

867 ià(
”r
)

868 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

870 ià(
cbh
)

871 
”r
 = 
	`jouº®_wa™_Ú_comm™_»cÜd
(
jouº®
, 
cbh
);

872 ià(
	`jbd3_has_ã©u»_async_comm™
(
jouº®
) &&

873 
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

874 
	`blkdev_issue_æush
(
jouº®
->
j_dev
, 
GFP_NOFS
, 
NULL
);

877 ià(
”r
)

878 
	`jbd3_jouº®_abÜt
(
jouº®
, 
”r
);

885 ià(
upd©e_
)

886 
	`jbd3_upd©e_log_
(
jouº®
, 
fœ¡_tid
, 
fœ¡_block
);

893 
	`jbd_debug
(3, "JBD3: commit…hase 6\n");

895 
	`J_ASSERT
(
	`li¡_em±y
(&
comm™_Œª§ùiÚ
->
t_šode_li¡
));

896 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_bufãrs
 =ğ
NULL
);

897 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
);

898 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_shadow_li¡
 =ğ
NULL
);

900 
»¡¬t_loİ
:

905 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

906 
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

907 
Œª§ùiÚ_t
 *
ı_Œª§ùiÚ
;

908 
bufãr_h—d
 *
bh
;

909 
Œy_to_ä“
 = 0;

911 
jh
 = 
comm™_Œª§ùiÚ
->
t_fÜg‘
;

912 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

913 
bh
 = 
	`jh2bh
(
jh
);

918 
	`g‘_bh
(
bh
);

919 
	`jbd_lock_bh_¡©e
(
bh
);

920 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
comm™_Œª§ùiÚ
);

935 ià(
jh
->
b_comm™‹d_d©a
) {

936 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

937 
jh
->
b_comm™‹d_d©a
 = 
NULL
;

938 ià(
jh
->
b_äoz’_d©a
) {

939 
jh
->
b_comm™‹d_d©a
 = jh->
b_äoz’_d©a
;

940 
jh
->
b_äoz’_d©a
 = 
NULL
;

941 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

943 } ià(
jh
->
b_äoz’_d©a
) {

944 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

945 
jh
->
b_äoz’_d©a
 = 
NULL
;

946 
jh
->
b_äoz’_Œigg”s
 = 
NULL
;

949 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

950 
ı_Œª§ùiÚ
 = 
jh
->
b_ı_Œª§ùiÚ
;

951 ià(
ı_Œª§ùiÚ
) {

952 
	`JBUFFER_TRACE
(
jh
, "remove from old cpransaction");

953 
ı_Œª§ùiÚ
->
t_chp_¡©s
.
cs_drİ³d
++;

954 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

967 ià(
	`bufãr_ä“d
(
bh
)) {

983 
jh
->
b_modif›d
 = 0;

984 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

985 
	`ş—r_bufãr_ä“d
(
bh
);

986 
	`ş—r_bufãr_jbddœty
(
bh
);

987 
	`ş—r_bufãr_m­³d
(
bh
);

988 
	`ş—r_bufãr_Ãw
(
bh
);

989 
	`ş—r_bufãr_»q
(
bh
);

990 
bh
->
b_bdev
 = 
NULL
;

994 ià(
	`bufãr_jbddœty
(
bh
)) {

995 
	`JBUFFER_TRACE
(
jh
, "addo‚ew checkpointingrans");

996 
	`__jbd3_jouº®_š£¹_checkpošt
(
jh
, 
comm™_Œª§ùiÚ
);

997 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

998 
	`ş—r_bufãr_jbddœty
(
bh
);

1000 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_dœty
(bh));

1010 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
)

1011 
Œy_to_ä“
 = 1;

1013 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1014 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

1015 
	`jbd_uÆock_bh_¡©e
(
bh
);

1016 ià(
Œy_to_ä“
)

1017 
	`»Ëa£_bufãr_·ge
(
bh
);

1019 
	`__b»l£
(
bh
);

1020 
	`cÚd_»sched_lock
(&
jouº®
->
j_li¡_lock
);

1022 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1029 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1030 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1035 ià(
comm™_Œª§ùiÚ
->
t_fÜg‘
) {

1036 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1037 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1038 
»¡¬t_loİ
;

1044 ià(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
) {

1045 
jouº®
->
j_checkpošt_Œª§ùiÚs
 = 
comm™_Œª§ùiÚ
;

1046 
comm™_Œª§ùiÚ
->
t_ıÃxt
 = commit_transaction;

1047 
comm™_Œª§ùiÚ
->
t_ı´ev
 = commit_transaction;

1049 
comm™_Œª§ùiÚ
->
t_ıÃxt
 =

1050 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

1051 
comm™_Œª§ùiÚ
->
t_ı´ev
 =

1052 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
;

1053 
comm™_Œª§ùiÚ
->
t_ıÃxt
->
t_ı´ev
 =

1054 
comm™_Œª§ùiÚ
;

1055 
comm™_Œª§ùiÚ
->
t_ı´ev
->
t_ıÃxt
 =

1056 
comm™_Œª§ùiÚ
;

1058 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1062 
	`jbd_debug
(3, "JBD3: commit…hase 7\n");

1064 
	`J_ASSERT
(
comm™_Œª§ùiÚ
->
t_¡©e
 =ğ
T_COMMIT_JFLUSH
);

1066 
comm™_Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

1067 
¡©s
.
run
.
rs_loggšg
 = 
	`jbd3_time_diff
(stats.run.rs_logging,

1068 
comm™_Œª§ùiÚ
->
t_¡¬t
);

1073 
¡©s
.
ts_tid
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1074 
¡©s
.
run
.
rs_hªdË_couÁ
 =

1075 
	`©omic_»ad
(&
comm™_Œª§ùiÚ
->
t_hªdË_couÁ
);

1076 
	`Œaû_jbd3_run_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1077 
comm™_Œª§ùiÚ
->
t_tid
, &
¡©s
.
run
);

1078 
¡©s
.
ts_»que¡ed
 = (
comm™_Œª§ùiÚ
->
t_»que¡ed
) ? 1 : 0;

1080 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_COMMIT_CALLBACK
;

1081 
	`J_ASSERT
(
comm™_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

1082 
jouº®
->
j_comm™_£qu’û
 = 
comm™_Œª§ùiÚ
->
t_tid
;

1083 
jouº®
->
j_comm™tšg_Œª§ùiÚ
 = 
NULL
;

1084 
comm™_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t_time
));

1090 ià(
	`lik–y
(
jouº®
->
j_av”age_comm™_time
))

1091 
jouº®
->
j_av”age_comm™_time
 = (
comm™_time
 +

1092 
jouº®
->
j_av”age_comm™_time
*3) / 4;

1094 
jouº®
->
j_av”age_comm™_time
 = 
comm™_time
;

1096 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1098 ià(
jouº®
->
j_comm™_ÿÎback
)

1099 
jouº®
->
	`j_comm™_ÿÎback
(jouº®, 
comm™_Œª§ùiÚ
);

1101 
	`Œaû_jbd3_’d_comm™
(
jouº®
, 
comm™_Œª§ùiÚ
);

1102 
	`jbd_debug
(1, "JBD3: commit %d complete, head %d\n",

1103 
jouº®
->
j_comm™_£qu’û
, jouº®->
j__£qu’û
);

1105 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1106 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1107 
comm™_Œª§ùiÚ
->
t_¡©e
 = 
T_FINISHED
;

1109 ià(
comm™_Œª§ùiÚ
->
t_checkpošt_li¡
 =ğ
NULL
 &&

1110 
comm™_Œª§ùiÚ
->
t_checkpošt_io_li¡
 =ğ
NULL
) {

1111 
	`__jbd3_jouº®_drİ_Œª§ùiÚ
(
jouº®
, 
comm™_Œª§ùiÚ
);

1112 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
comm™_Œª§ùiÚ
);

1114 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1115 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1116 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

1121 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1122 
jouº®
->
j_¡©s
.
ts_tid
++;

1123 
jouº®
->
j_¡©s
.
ts_»que¡ed
 +ğ
¡©s
.ts_requested;

1124 
jouº®
->
j_¡©s
.
run
.
rs_wa™
 +ğ
¡©s
.run.rs_wait;

1125 
jouº®
->
j_¡©s
.
run
.
rs_»que¡_d–ay
 +ğ
¡©s
.run.rs_request_delay;

1126 
jouº®
->
j_¡©s
.
run
.
rs_ruÂšg
 +ğ
¡©s
.run.rs_running;

1127 
jouº®
->
j_¡©s
.
run
.
rs_locked
 +ğ
¡©s
.run.rs_locked;

1128 
jouº®
->
j_¡©s
.
run
.
rs_æushšg
 +ğ
¡©s
.run.rs_flushing;

1129 
jouº®
->
j_¡©s
.
run
.
rs_loggšg
 +ğ
¡©s
.run.rs_logging;

1130 
jouº®
->
j_¡©s
.
run
.
rs_hªdË_couÁ
 +ğ
¡©s
.run.rs_handle_count;

1131 
jouº®
->
j_¡©s
.
run
.
rs_blocks
 +ğ
¡©s
.run.rs_blocks;

1132 
jouº®
->
j_¡©s
.
run
.
rs_blocks_logged
 +ğ
¡©s
.run.rs_blocks_logged;

1133 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1134 
	}
}

	@jbd3.mod.c

1 
	~<lšux/bud-§É.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/v”magic.h
>

4 
	~<lšux/comp”.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

11 
__visibË
 
moduË
 
__this_moduË


12 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

13 .
Çme
 = 
KBUILD_MODNAME
,

14 .
	gš™
 = 
š™_moduË
,

15 #ifdeà
CONFIG_MODULE_UNLOAD


16 .
	gex™
 = 
ş—nup_moduË
,

18 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

21 #ifdeà
CONFIG_RETPOLINE


22 
MODULE_INFO
(
»Şše
, "Y");

25 cÚ¡ 
	g__moduË_d•’ds
[]

26 
__u£d


27 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

31 
MODULE_INFO
(
¤cv”siÚ
, "EFBBFAF13E886D603FAED2E");

	@journal.c

22 
	~<lšux/moduË.h
>

23 
	~<lšux/time.h
>

24 
	~<lšux/fs.h
>

25 
	~<lšux/jbd3.h
>

26 
	~<lšux/”ºo.h
>

27 
	~<lšux/¦ab.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/mm.h
>

30 
	~<lšux/ä“z”.h
>

31 
	~<lšux/·gem­.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/poisÚ.h
>

34 
	~<lšux/´oc_fs.h
>

35 
	~<lšux/£q_fe.h
>

36 
	~<lšux/m©h64.h
>

37 
	~<lšux/hash.h
>

38 
	~<lšux/log2.h
>

39 
	~<lšux/vm®loc.h
>

40 
	~<lšux/backšg-dev.h
>

41 
	~<lšux/b™İs.h
>

42 
	~<lšux/¿‹lim™.h
>

43 
	~<lšux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<Œaû/ev’ts/jbd3.h
>

48 
	~<lšux/uacûss.h
>

49 
	~<asm/·ge.h
>

51 #ifdeà
CONFIG_JBD3_DEBUG


52 
ushÜt
 
jbd3_jouº®_’abË_debug
 
	g__»ad_mo¡ly
;

53 
EXPORT_SYMBOL
(
jbd3_jouº®_’abË_debug
);

55 
moduË_·¿m_Çmed
(
jbd3_debug
, 
jbd3_jouº®_’abË_debug
, 
ushÜt
, 0644);

56 
MODULE_PARM_DESC
(
jbd3_debug
, "Debugging†evel for jbd3");

59 
EXPORT_SYMBOL
(
jbd3_jouº®_ex‹nd
);

60 
EXPORT_SYMBOL
(
jbd3_jouº®_¡İ
);

61 
EXPORT_SYMBOL
(
jbd3_jouº®_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd3_jouº®_uÆock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_wr™e_acûss
);

64 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_ü—‹_acûss
);

65 
EXPORT_SYMBOL
(
jbd3_jouº®_g‘_undo_acûss
);

66 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_Œigg”s
);

67 
EXPORT_SYMBOL
(
jbd3_jouº®_dœty_m‘ad©a
);

68 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜg‘
);

70 
EXPORT_SYMBOL
(
jouº®_sync_bufãr
);

72 
EXPORT_SYMBOL
(
jbd3_jouº®_æush
);

73 
EXPORT_SYMBOL
(
jbd3_jouº®_»voke
);

75 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_dev
);

76 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_šode
);

77 
EXPORT_SYMBOL
(
jbd3_jouº®_check_u£d_ã©u»s
);

78 
EXPORT_SYMBOL
(
jbd3_jouº®_check_avaabË_ã©u»s
);

79 
EXPORT_SYMBOL
(
jbd3_jouº®_£t_ã©u»s
);

80 
EXPORT_SYMBOL
(
jbd3_jouº®_lßd
);

81 
EXPORT_SYMBOL
(
jbd3_jouº®_de¡roy
);

82 
EXPORT_SYMBOL
(
jbd3_jouº®_abÜt
);

83 
EXPORT_SYMBOL
(
jbd3_jouº®_”ºo
);

84 
EXPORT_SYMBOL
(
jbd3_jouº®_ack_”r
);

85 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_”r
);

86 
EXPORT_SYMBOL
(
jbd3_log_wa™_comm™
);

87 
EXPORT_SYMBOL
(
jbd3_log_¡¬t_comm™
);

88 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_comm™
);

89 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™_Ã¡ed
);

90 
EXPORT_SYMBOL
(
jbd3_jouº®_we
);

91 
EXPORT_SYMBOL
(
jbd3_jouº®_blocks_³r_·ge
);

92 
EXPORT_SYMBOL
(
jbd3_jouº®_šv®id©•age
);

93 
EXPORT_SYMBOL
(
jbd3_jouº®_Œy_to_ä“_bufãrs
);

94 
EXPORT_SYMBOL
(
jbd3_jouº®_fÜû_comm™
);

95 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_add_wr™e
);

96 
EXPORT_SYMBOL
(
jbd3_jouº®_šode_add_wa™
);

97 
EXPORT_SYMBOL
(
jbd3_jouº®_š™_jbd_šode
);

98 
EXPORT_SYMBOL
(
jbd3_jouº®_»Ëa£_jbd_šode
);

99 
EXPORT_SYMBOL
(
jbd3_jouº®_begš_Üd”ed_Œunÿ‹
);

100 
EXPORT_SYMBOL
(
jbd3_šode_ÿche
);

102 
__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
);

103 
jbd3_jouº®_ü—‹_¦ab
(
size_t
 
¦ab_size
);

105 #ifdeà
CONFIG_JBD3_DEBUG


106 
	$__jbd3_debug
(
Ëv–
, cÚ¡ *
fe
, cÚ¡ *
func
,

107 
lše
, cÚ¡ *
fmt
, ...)

109 
va_fÜm©
 
vaf
;

110 
va_li¡
 
¬gs
;

112 ià(
Ëv–
 > 
jbd3_jouº®_’abË_debug
)

114 
	`va_¡¬t
(
¬gs
, 
fmt
);

115 
vaf
.
fmt
 = fmt;

116 
vaf
.
va
 = &
¬gs
;

117 
	`´štk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fe
, 
func
, 
lše
, &
vaf
);

118 
	`va_’d
(
¬gs
);

119 
	}
}

120 
EXPORT_SYMBOL
(
__jbd3_debug
);

124 
	$jbd3_v”ify_csum_ty³
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

126 ià(!
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
j
))

129  
sb
->
s_checksum_ty³
 =ğ
JBD3_CRC32C_CHKSUM
;

130 
	}
}

132 
__be32
 
	$jbd3_su³rblock_csum
(
jouº®_t
 *
j
, 
jouº®_su³rblock_t
 *
sb
)

134 
__u32
 
csum
;

135 
__be32
 
Şd_csum
;

137 
Şd_csum
 = 
sb
->
s_checksum
;

138 
sb
->
s_checksum
 = 0;

139 
csum
 = 
	`jbd3_chksum
(
j
, ~0, (*)
sb
, (
jouº®_su³rblock_t
));

140 
sb
->
s_checksum
 = 
Şd_csum
;

142  
	`ıu_to_be32
(
csum
);

143 
	}
}

149 
	$comm™_timeout
(
tim”_li¡
 *
t
)

151 
jouº®_t
 *
jouº®
 = 
	`äom_tim”
(jouº®, 
t
, 
j_comm™_tim”
);

153 
	`wake_up_´oûss
(
jouº®
->
j_sk
);

154 
	}
}

172 
	$kjouº®d2
(*
¬g
)

174 
jouº®_t
 *
jouº®
 = 
¬g
;

175 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

181 
	`tim”_£tup
(&
jouº®
->
j_comm™_tim”
, 
comm™_timeout
, 0);

183 
	`£t_ä“zabË
();

186 
jouº®
->
j_sk
 = 
cu¼’t
;

187 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

195 
	`mem®loc_nofs_§ve
();

200 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

202 
loİ
:

203 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

204 
’d_loİ
;

206 
	`jbd_debug
(1, "commit_sequence=%d, commit_request=%d\n",

207 
jouº®
->
j_comm™_£qu’û
, jouº®->
j_comm™_»que¡
);

209 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
) {

210 
	`jbd_debug
(1, "OK,„equests differ\n");

211 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

212 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

213 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

214 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

215 
loİ
;

218 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

219 ià(
	`ä“zšg
(
cu¼’t
)) {

225 
	`jbd_debug
(1, "Now suspending kjournald2\n");

226 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

227 
	`Œy_to_ä“ze
();

228 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

234 
	`DEFINE_WAIT
(
wa™
);

235 
should_¦“p
 = 1;

237 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
,

238 
TASK_INTERRUPTIBLE
);

239 ià(
jouº®
->
j_comm™_£qu’û
 !ğjouº®->
j_comm™_»que¡
)

240 
should_¦“p
 = 0;

241 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

242 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,

243 
Œª§ùiÚ
->
t_expœes
))

244 
should_¦“p
 = 0;

245 ià(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
)

246 
should_¦“p
 = 0;

247 ià(
should_¦“p
) {

248 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

249 
	`scheduË
();

250 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

252 
	`fšish_wa™
(&
jouº®
->
j_wa™_comm™
, &
wa™
);

255 
	`jbd_debug
(1, "kjournald2 wakes\n");

260 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

261 ià(
Œª§ùiÚ
 && 
	`time_aá”_eq
(
jiff›s
,¿n§ùiÚ->
t_expœes
)) {

262 
jouº®
->
j_comm™_»que¡
 = 
Œª§ùiÚ
->
t_tid
;

263 
	`jbd_debug
(1, "woke because ofimeout\n");

265 
loİ
;

267 
’d_loİ
:

268 
	`d–_tim”_sync
(&
jouº®
->
j_comm™_tim”
);

269 
jouº®
->
j_sk
 = 
NULL
;

270 
	`wake_up
(&
jouº®
->
j_wa™_dÚe_comm™
);

271 
	`jbd_debug
(1, "Journalhreadƒxiting.\n");

272 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

274 
	}
}

276 
	$jbd3_jouº®_¡¬t_th»ad
(
jouº®_t
 *
jouº®
)

278 
sk_¡ruù
 *
t
;

280 
t
 = 
	`kth»ad_run
(
kjouº®d2
, 
jouº®
, "jbd3/%s",

281 
jouº®
->
j_devÇme
);

282 ià(
	`IS_ERR
(
t
))

283  
	`PTR_ERR
(
t
);

285 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 !ğ
NULL
);

287 
	}
}

289 
	$jouº®_kl_th»ad
(
jouº®_t
 *
jouº®
)

291 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

292 
jouº®
->
j_æags
 |ğ
JBD3_UNMOUNT
;

294 
jouº®
->
j_sk
) {

295 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

296 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

297 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
, jouº®->
j_sk
 =ğ
NULL
);

298 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

300 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

301 
	}
}

338 
	$jbd3_jouº®_wr™e_m‘ad©a_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

339 
jouº®_h—d
 *
jh_š
,

340 
bufãr_h—d
 **
bh_out
,

341 
£ùÜ_t
 
blockÄ
)

343 
Ãed_cİy_out
 = 0;

344 
dÚe_cİy_out
 = 0;

345 
do_esÿ³
 = 0;

346 *
m­³d_d©a
;

347 
bufãr_h—d
 *
Ãw_bh
;

348 
·ge
 *
Ãw_·ge
;

349 
Ãw_off£t
;

350 
bufãr_h—d
 *
bh_š
 = 
	`jh2bh
(
jh_š
);

351 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

362 
	`J_ASSERT_BH
(
bh_š
, 
	`bufãr_jbddœty
(bh_in));

364 
Ãw_bh
 = 
	`®loc_bufãr_h—d
(
GFP_NOFS
|
__GFP_NOFAIL
);

367 
	`©omic_£t
(&
Ãw_bh
->
b_couÁ
, 1);

369 
	`jbd_lock_bh_¡©e
(
bh_š
);

370 
»³©
:

375 ià(
jh_š
->
b_äoz’_d©a
) {

376 
dÚe_cİy_out
 = 1;

377 
Ãw_·ge
 = 
	`vœt_to_·ge
(
jh_š
->
b_äoz’_d©a
);

378 
Ãw_off£t
 = 
	`off£t_š_·ge
(
jh_š
->
b_äoz’_d©a
);

380 
Ãw_·ge
 = 
	`jh2bh
(
jh_š
)->
b_·ge
;

381 
Ãw_off£t
 = 
	`off£t_š_·ge
(
	`jh2bh
(
jh_š
)->
b_d©a
);

384 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

391 ià(!
dÚe_cİy_out
)

392 
	`jbd3_bufãr_äoz’_Œigg”
(
jh_š
, 
m­³d_d©a
 + 
Ãw_off£t
,

393 
jh_š
->
b_Œigg”s
);

398 ià(*((
__be32
 *)(
m­³d_d©a
 + 
Ãw_off£t
)) ==

399 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

400 
Ãed_cİy_out
 = 1;

401 
do_esÿ³
 = 1;

403 
	`kunm­_©omic
(
m­³d_d©a
);

408 ià(
Ãed_cİy_out
 && !
dÚe_cİy_out
) {

409 *
tmp
;

411 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

412 
tmp
 = 
	`jbd3_®loc
(
bh_š
->
b_size
, 
GFP_NOFS
);

413 ià(!
tmp
) {

414 
	`b»l£
(
Ãw_bh
);

415  -
ENOMEM
;

417 
	`jbd_lock_bh_¡©e
(
bh_š
);

418 ià(
jh_š
->
b_äoz’_d©a
) {

419 
	`jbd3_ä“
(
tmp
, 
bh_š
->
b_size
);

420 
»³©
;

423 
jh_š
->
b_äoz’_d©a
 = 
tmp
;

424 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

425 
	`memıy
(
tmp
, 
m­³d_d©a
 + 
Ãw_off£t
, 
bh_š
->
b_size
);

426 
	`kunm­_©omic
(
m­³d_d©a
);

428 
Ãw_·ge
 = 
	`vœt_to_·ge
(
tmp
);

429 
Ãw_off£t
 = 
	`off£t_š_·ge
(
tmp
);

430 
dÚe_cİy_out
 = 1;

437 
jh_š
->
b_äoz’_Œigg”s
 = jh_š->
b_Œigg”s
;

444 ià(
do_esÿ³
) {

445 
m­³d_d©a
 = 
	`km­_©omic
(
Ãw_·ge
);

446 *((*)(
m­³d_d©a
 + 
Ãw_off£t
)) = 0;

447 
	`kunm­_©omic
(
m­³d_d©a
);

450 
	`£t_bh_·ge
(
Ãw_bh
, 
Ãw_·ge
, 
Ãw_off£t
);

451 
Ãw_bh
->
b_size
 = 
bh_š
->b_size;

452 
Ãw_bh
->
b_bdev
 = 
jouº®
->
j_dev
;

453 
Ãw_bh
->
b_blockÄ
 = 
blockÄ
;

454 
Ãw_bh
->
b_´iv©e
 = 
bh_š
;

455 
	`£t_bufãr_m­³d
(
Ãw_bh
);

456 
	`£t_bufãr_dœty
(
Ãw_bh
);

458 *
bh_out
 = 
Ãw_bh
;

465 
	`JBUFFER_TRACE
(
jh_š
, "file‡s BJ_Shadow");

466 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

467 
	`__jbd3_jouº®_fe_bufãr
(
jh_š
, 
Œª§ùiÚ
, 
BJ_Shadow
);

468 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

469 
	`£t_bufãr_shadow
(
bh_š
);

470 
	`jbd_uÆock_bh_¡©e
(
bh_š
);

472  
do_esÿ³
 | (
dÚe_cİy_out
 << 1);

473 
	}
}

484 
	$__jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
rg‘
)

487 ià(
jouº®
->
j_comm™_»que¡
 =ğ
rg‘
)

495 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

496 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
rg‘
) {

502 
jouº®
->
j_comm™_»que¡
 = 
rg‘
;

503 
	`jbd_debug
(1, "JBD3:„equesting commit %d/%d\n",

504 
jouº®
->
j_comm™_»que¡
,

505 
jouº®
->
j_comm™_£qu’û
);

506 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_»que¡ed
 = 
jiff›s
;

507 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

509 } ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
rg‘
))

513 
	`WARN_ONCE
(1, "JBD3: bad†og_start_commit: %u %u %u %u\n",

514 
jouº®
->
j_comm™_»que¡
,

515 
jouº®
->
j_comm™_£qu’û
,

516 
rg‘
, 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

517 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

519 
	}
}

521 
	$jbd3_log_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

523 
»t
;

525 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

526 
»t
 = 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

527 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

528  
»t
;

529 
	}
}

538 
	$__jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

540 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

541 
tid_t
 
tid
;

542 
Ãed_to_¡¬t
 = 0, 
»t
 = 0;

544 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

545 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && !
cu¼’t
->
jouº®_šfo
) {

546 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

547 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
Œª§ùiÚ
->
t_tid
))

548 
Ãed_to_¡¬t
 = 1;

549 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

550 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

552 ià(!
Œª§ùiÚ
) {

554 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

557 
tid
 = 
Œª§ùiÚ
->
t_tid
;

558 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

559 ià(
Ãed_to_¡¬t
)

560 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

561 
»t
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

562 ià(!
»t
)

563 
»t
 = 1;

565  
»t
;

566 
	}
}

576 
	$jbd3_jouº®_fÜû_comm™_Ã¡ed
(
jouº®_t
 *
jouº®
)

578 
»t
;

580 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

581  
»t
 > 0;

582 
	}
}

591 
	$jbd3_jouº®_fÜû_comm™
(
jouº®_t
 *
jouº®
)

593 
»t
;

595 
	`J_ASSERT
(!
cu¼’t
->
jouº®_šfo
);

596 
»t
 = 
	`__jbd3_jouº®_fÜû_comm™
(
jouº®
);

597 ià(
»t
 > 0)

598 
»t
 = 0;

599  
»t
;

600 
	}
}

607 
	$jbd3_jouº®_¡¬t_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 *
±id
)

609 
»t
 = 0;

611 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

612 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

613 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

615 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

618 ià(
±id
)

619 *
±id
 = 
tid
;

620 
»t
 = 1;

621 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

626 ià(
±id
)

627 *
±id
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
;

628 
»t
 = 1;

630 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

631  
»t
;

632 
	}
}

640 
	$jbd3_Œªs_wl_£nd_d©a_b¬r›r
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

642 
»t
 = 0;

643 
Œª§ùiÚ_t
 *
comm™_Œªs
;

645 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

647 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

649 ià(
	`tid_geq
(
jouº®
->
j_comm™_£qu’û
, 
tid
))

650 
out
;

651 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

652 ià(!
comm™_Œªs
 || comm™_Œªs->
t_tid
 !ğ
tid
) {

653 
»t
 = 1;

654 
out
;

660 ià(
jouº®
->
j_fs_dev
 !ğjouº®->
j_dev
) {

661 ià(!
comm™_Œªs
->
t_Ãed_d©a_æush
 ||

662 
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_DFLUSH
)

663 
out
;

665 ià(
comm™_Œªs
->
t_¡©e
 >ğ
T_COMMIT_JFLUSH
)

666 
out
;

668 
»t
 = 1;

669 
out
:

670 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

671  
»t
;

672 
	}
}

673 
EXPORT_SYMBOL
(
jbd3_Œªs_wl_£nd_d©a_b¬r›r
);

679 
	$jbd3_log_wa™_comm™
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

681 
”r
 = 0;

683 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

684 #ifdeà
CONFIG_PROVE_LOCKING


690 ià(
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
) &&

691 (!
jouº®
->
j_comm™tšg_Œª§ùiÚ
 ||

692 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 !ğ
tid
)) {

693 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

694 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

695 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

698 #ifdeà
CONFIG_JBD3_DEBUG


699 ià(!
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
)) {

700 
	`´štk
(
KERN_ERR


702 
__func__
, 
jouº®
->
j_comm™_»que¡
, 
tid
);

705 
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
)) {

706 
	`jbd_debug
(1, "JBD3: want %d, j_commit_sequence=%d\n",

707 
tid
, 
jouº®
->
j_comm™_£qu’û
);

708 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

709 
	`wake_up
(&
jouº®
->
j_wa™_comm™
);

710 
	`wa™_ev’t
(
jouº®
->
j_wa™_dÚe_comm™
,

711 !
	`tid_gt
(
tid
, 
jouº®
->
j_comm™_£qu’û
));

712 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

714 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

716 ià(
	`uÆik–y
(
	`is_jouº®_abÜ‹d
(
jouº®
)))

717 
”r
 = -
EIO
;

718  
”r
;

719 
	}
}

722 
	$jbd3_Œª§ùiÚ_comm™‹d
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

724 
»t
 = 1;

726 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

727 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

728 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

729 
»t
 = 0;

730 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

731 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
)

732 
»t
 = 0;

733 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

734  
»t
;

735 
	}
}

736 
EXPORT_SYMBOL
(
jbd3_Œª§ùiÚ_comm™‹d
);

745 
	$jbd3_com¶‘e_Œª§ùiÚ
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
)

747 
Ãed_to_wa™
 = 1;

749 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

750 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

751 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
) {

752 ià(
jouº®
->
j_comm™_»que¡
 !ğ
tid
) {

754 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

755 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

756 
wa™_comm™
;

758 } ià(!(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

759 
jouº®
->
j_comm™tšg_Œª§ùiÚ
->
t_tid
 =ğ
tid
))

760 
Ãed_to_wa™
 = 0;

761 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

762 ià(!
Ãed_to_wa™
)

764 
wa™_comm™
:

765  
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

766 
	}
}

767 
EXPORT_SYMBOL
(
jbd3_com¶‘e_Œª§ùiÚ
);

773 
	$jbd3_jouº®_Ãxt_log_block
(
jouº®_t
 *
jouº®
, *
»
)

775 
blockÄ
;

777 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

778 
	`J_ASSERT
(
jouº®
->
j_ä“
 > 1);

780 
blockÄ
 = 
jouº®
->
j_h—d
;

781 
jouº®
->
j_h—d
++;

782 
jouº®
->
j_ä“
--;

783 ià(
jouº®
->
j_h—d
 =ğjouº®->
j_Ï¡
)

784 
jouº®
->
j_h—d
 = jouº®->
j_fœ¡
;

785 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

786  
	`jbd3_jouº®_bm­
(
jouº®
, 
blockÄ
, 
»
);

787 
	}
}

796 
	$jbd3_jouº®_bm­
(
jouº®_t
 *
jouº®
, 
blockÄ
,

797 *
»
)

799 
”r
 = 0;

800 
»t
;

802 ià(
jouº®
->
j_šode
) {

803 
»t
 = 
	`bm­
(
jouº®
->
j_šode
, 
blockÄ
);

804 ià(
»t
)

805 *
»
 = 
»t
;

807 
	`´štk
(
KERN_ALERT
 "%s: journal block‚ot found "

809 
__func__
, 
blockÄ
, 
jouº®
->
j_devÇme
);

810 
”r
 = -
EIO
;

811 
	`__jouº®_abÜt_soá
(
jouº®
, 
”r
);

814 *
»
 = 
blockÄ
;

816  
”r
;

817 
	}
}

829 
bufãr_h—d
 *

830 
	$jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
ty³
)

832 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

833 
bufãr_h—d
 *
bh
;

834 
blockÄ
;

835 
jouº®_h—d”_t
 *
h—d”
;

836 
”r
;

838 
”r
 = 
	`jbd3_jouº®_Ãxt_log_block
(
jouº®
, &
blockÄ
);

840 ià(
”r
)

841  
NULL
;

843 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

844 ià(!
bh
)

845  
NULL
;

846 
	`lock_bufãr
(
bh
);

847 
	`mem£t
(
bh
->
b_d©a
, 0, 
jouº®
->
j_blocksize
);

848 
h—d”
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

849 
h—d”
->
h_magic
 = 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

850 
h—d”
->
h_blockty³
 = 
	`ıu_to_be32
(
ty³
);

851 
h—d”
->
h_£qu’û
 = 
	`ıu_to_be32
(
Œª§ùiÚ
->
t_tid
);

852 
	`£t_bufãr_u±od©e
(
bh
);

853 
	`uÆock_bufãr
(
bh
);

854 
	`BUFFER_TRACE
(
bh
, "returnhis buffer");

855  
bh
;

856 
	}
}

858 
	$jbd3_desütÜ_block_csum_£t
(
jouº®_t
 *
j
, 
bufãr_h—d
 *
bh
)

860 
jbd3_jouº®_block_
 *

;

861 
__u32
 
csum
;

863 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

866 

 = (
jbd3_jouº®_block_
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

867 (
jbd3_jouº®_block_
));

868 

->
t_checksum
 = 0;

869 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

870 

->
t_checksum
 = 
	`ıu_to_be32
(
csum
);

871 
	}
}

883 
	$jbd3_jouº®_g‘_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 *
tid
,

884 *
block
)

886 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

887 
»t
;

889 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

890 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

891 
Œª§ùiÚ
 = 
jouº®
->
j_checkpošt_Œª§ùiÚs
;

892 ià(
Œª§ùiÚ
) {

893 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

894 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

895 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
è!ğ
NULL
) {

896 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

897 *
block
 = 
Œª§ùiÚ
->
t_log_¡¬t
;

898 } ià((
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
è!ğ
NULL
) {

899 *
tid
 = 
Œª§ùiÚ
->
t_tid
;

900 *
block
 = 
jouº®
->
j_h—d
;

902 *
tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
;

903 *
block
 = 
jouº®
->
j_h—d
;

905 
»t
 = 
	`tid_gt
(*
tid
, 
jouº®
->
j__£qu’û
);

906 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

907 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

909  
»t
;

910 
	}
}

922 
	$__jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

924 
ä“d
;

925 
»t
;

927 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

935 
»t
 = 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
, 
tid
, 
block
,

936 
REQ_SYNC
 | 
REQ_FUA
);

937 ià(
»t
)

938 
out
;

940 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

941 
ä“d
 = 
block
 - 
jouº®
->
j_
;

942 ià(
block
 < 
jouº®
->
j_
)

943 
ä“d
 +ğ
jouº®
->
j_Ï¡
 - jouº®->
j_fœ¡
;

945 
	`Œaû_jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
, 
ä“d
);

946 
	`jbd_debug
(1,

949 
jouº®
->
j__£qu’û
, 
tid
, 
block
, 
ä“d
);

951 
jouº®
->
j_ä“
 +ğ
ä“d
;

952 
jouº®
->
j__£qu’û
 = 
tid
;

953 
jouº®
->
j_
 = 
block
;

954 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

956 
out
:

957  
»t
;

958 
	}
}

965 
	$jbd3_upd©e_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
tid
, 
block
)

967 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

968 ià(
	`tid_gt
(
tid
, 
jouº®
->
j__£qu’û
))

969 
	`__jbd3_upd©e_log_
(
jouº®
, 
tid
, 
block
);

970 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

971 
	}
}

973 
	sjbd3_¡©s_´oc_£ssiÚ
 {

974 
jouº®_t
 *
	mjouº®
;

975 
Œª§ùiÚ_¡©s_s
 *
	m¡©s
;

976 
	m¡¬t
;

977 
	mmax
;

980 *
	$jbd3_£q_šfo_¡¬t
(
£q_fe
 *
£q
, 
loff_t
 *
pos
)

982  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

983 
	}
}

985 *
	$jbd3_£q_šfo_Ãxt
(
£q_fe
 *
£q
, *
v
, 
loff_t
 *
pos
)

987  
NULL
;

988 
	}
}

990 
	$jbd3_£q_šfo_show
(
£q_fe
 *
£q
, *
v
)

992 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

994 ià(
v
 !ğ
SEQ_START_TOKEN
)

996 
	`£q_´štf
(
£q
, "%luransactions (%lu„equested), "

998 
s
->
¡©s
->
ts_tid
, s->¡©s->
ts_»que¡ed
,

999 
s
->
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

1000 ià(
s
->
¡©s
->
ts_tid
 == 0)

1002 
	`£q_´štf
(
£q
, "average: \n %ums waiting forransaction\n",

1003 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_wa™
 / s->¡©s->
ts_tid
));

1004 
	`£q_´štf
(
£q
, " %ums„equest delay\n",

1005 (
s
->
¡©s
->
ts_»que¡ed
 == 0) ? 0 :

1006 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_»que¡_d–ay
 /

1007 
s
->
¡©s
->
ts_»que¡ed
));

1008 
	`£q_´štf
(
£q
, " %ums„unningransaction\n",

1009 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_ruÂšg
 / s->¡©s->
ts_tid
));

1010 
	`£q_´štf
(
£q
, " %umsransaction was being†ocked\n",

1011 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_locked
 / s->¡©s->
ts_tid
));

1012 
	`£q_´štf
(
£q
, " %ums flushing data (in ordered mode)\n",

1013 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_æushšg
 / s->¡©s->
ts_tid
));

1014 
	`£q_´štf
(
£q
, " %ums†oggingransaction\n",

1015 
	`jiff›s_to_m£cs
(
s
->
¡©s
->
run
.
rs_loggšg
 / s->¡©s->
ts_tid
));

1016 
	`£q_´štf
(
£q
, " %lluus‡verageransaction commitime\n",

1017 
	`div_u64
(
s
->
jouº®
->
j_av”age_comm™_time
, 1000));

1018 
	`£q_´štf
(
£q
, " %lu handles…erransaction\n",

1019 
s
->
¡©s
->
run
.
rs_hªdË_couÁ
 / s->¡©s->
ts_tid
);

1020 
	`£q_´štf
(
£q
, " %lu blocks…erransaction\n",

1021 
s
->
¡©s
->
run
.
rs_blocks
 / s->¡©s->
ts_tid
);

1022 
	`£q_´štf
(
£q
, " %lu†ogged blocks…erransaction\n",

1023 
s
->
¡©s
->
run
.
rs_blocks_logged
 / s->¡©s->
ts_tid
);

1025 
	}
}

1027 
	$jbd3_£q_šfo_¡İ
(
£q_fe
 *
£q
, *
v
)

1029 
	}
}

1031 cÚ¡ 
£q_İ”©iÚs
 
	gjbd3_£q_šfo_İs
 = {

1032 .
¡¬t
 = 
jbd3_£q_šfo_¡¬t
,

1033 .
	gÃxt
 = 
jbd3_£q_šfo_Ãxt
,

1034 .
	g¡İ
 = 
jbd3_£q_šfo_¡İ
,

1035 .
	gshow
 = 
jbd3_£q_šfo_show
,

1038 
	$jbd3_£q_šfo_İ’
(
šode
 *šode, 
fe
 *file)

1040 
jouº®_t
 *
jouº®
 = 
	`PDE_DATA
(
šode
);

1041 
jbd3_¡©s_´oc_£ssiÚ
 *
s
;

1042 
rc
, 
size
;

1044 
s
 = 
	`km®loc
((*s), 
GFP_KERNEL
);

1045 ià(
s
 =ğ
NULL
)

1046  -
ENOMEM
;

1047 
size
 = (
Œª§ùiÚ_¡©s_s
);

1048 
s
->
¡©s
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

1049 ià(
s
->
¡©s
 =ğ
NULL
) {

1050 
	`kä“
(
s
);

1051  -
ENOMEM
;

1053 
	`¥š_lock
(&
jouº®
->
j_hi¡Üy_lock
);

1054 
	`memıy
(
s
->
¡©s
, &
jouº®
->
j_¡©s
, 
size
);

1055 
s
->
jouº®
 = journal;

1056 
	`¥š_uÆock
(&
jouº®
->
j_hi¡Üy_lock
);

1058 
rc
 = 
	`£q_İ’
(
fe
, &
jbd3_£q_šfo_İs
);

1059 ià(
rc
 == 0) {

1060 
£q_fe
 *
m
 = 
fe
->
´iv©e_d©a
;

1061 
m
->
´iv©e
 = 
s
;

1063 
	`kä“
(
s
->
¡©s
);

1064 
	`kä“
(
s
);

1066  
rc
;

1068 
	}
}

1070 
	$jbd3_£q_šfo_»Ëa£
(
šode
 *šode, 
fe
 *file)

1072 
£q_fe
 *
£q
 = 
fe
->
´iv©e_d©a
;

1073 
jbd3_¡©s_´oc_£ssiÚ
 *
s
 = 
£q
->
´iv©e
;

1074 
	`kä“
(
s
->
¡©s
);

1075 
	`kä“
(
s
);

1076  
	`£q_»Ëa£
(
šode
, 
fe
);

1077 
	}
}

1079 cÚ¡ 
fe_İ”©iÚs
 
	gjbd3_£q_šfo_fİs
 = {

1080 .
owÃr
 = 
THIS_MODULE
,

1081 .
	gİ’
 = 
jbd3_£q_šfo_İ’
,

1082 .
	g»ad
 = 
£q_»ad
,

1083 .
	gÎ£ek
 = 
£q_l£ek
,

1084 .
	g»Ëa£
 = 
jbd3_£q_šfo_»Ëa£
,

1087 
´oc_dœ_’Œy
 *
	g´oc_jbd3_¡©s
;

1089 
	$jbd3_¡©s_´oc_š™
(
jouº®_t
 *
jouº®
)

1091 
jouº®
->
j_´oc_’Œy
 = 
	`´oc_mkdœ
(jouº®->
j_devÇme
, 
´oc_jbd3_¡©s
);

1092 ià(
jouº®
->
j_´oc_’Œy
) {

1093 
	`´oc_ü—‹_d©a
("šfo", 
S_IRUGO
, 
jouº®
->
j_´oc_’Œy
,

1094 &
jbd3_£q_šfo_fİs
, 
jouº®
);

1096 
	}
}

1098 
	$jbd3_¡©s_´oc_ex™
(
jouº®_t
 *
jouº®
)

1100 
	`»move_´oc_’Œy
("šfo", 
jouº®
->
j_´oc_’Œy
);

1101 
	`»move_´oc_’Œy
(
jouº®
->
j_devÇme
, 
´oc_jbd3_¡©s
);

1102 
	}
}

1113 
jouº®_t
 *
	$jouº®_š™_commÚ
(
block_deviû
 *
bdev
,

1114 
block_deviû
 *
fs_dev
,

1115 
¡¬t
, 
Ën
, 
blocksize
)

1117 
lock_şass_key
 
jbd3_Œªs_comm™_key
;

1118 
jouº®_t
 *
jouº®
;

1119 
”r
;

1120 
bufãr_h—d
 *
bh
;

1121 
n
;

1123 
jouº®
 = 
	`kz®loc
((*jouº®), 
GFP_KERNEL
);

1124 ià(!
jouº®
)

1125  
NULL
;

1127 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1128 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_dÚe_comm™
);

1129 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_comm™
);

1130 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_upd©es
);

1131 
	`š™_wa™queue_h—d
(&
jouº®
->
j_wa™_»£rved
);

1132 
	`mu‹x_š™
(&
jouº®
->
j_b¬r›r
);

1133 
	`mu‹x_š™
(&
jouº®
->
j_checkpošt_mu‹x
);

1134 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

1135 
	`¥š_lock_š™
(&
jouº®
->
j_li¡_lock
);

1136 
	`rwlock_š™
(&
jouº®
->
j_¡©e_lock
);

1138 
jouº®
->
j_comm™_š‹rv®
 = (
HZ
 * 
JBD3_DEFAULT_MAX_COMMIT_AGE
);

1139 
jouº®
->
j_mš_b©ch_time
 = 0;

1140 
jouº®
->
j_max_b©ch_time
 = 15000;

1141 
	`©omic_£t
(&
jouº®
->
j_»£rved_üed™s
, 0);

1144 
jouº®
->
j_æags
 = 
JBD3_ABORT
;

1147 
”r
 = 
	`jbd3_jouº®_š™_»voke
(
jouº®
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1148 ià(
”r
)

1149 
”r_ş—nup
;

1151 
	`¥š_lock_š™
(&
jouº®
->
j_hi¡Üy_lock
);

1153 
	`lockd•_š™_m­
(&
jouº®
->
j_Œªs_comm™_m­
, "jbd3_handle",

1154 &
jbd3_Œªs_comm™_key
, 0);

1157 
jouº®
->
j_blocksize
 = 
blocksize
;

1158 
jouº®
->
j_dev
 = 
bdev
;

1159 
jouº®
->
j_fs_dev
 = 
fs_dev
;

1160 
jouº®
->
j_blk_off£t
 = 
¡¬t
;

1161 
jouº®
->
j_maxËn
 = 
Ën
;

1162 
n
 = 
jouº®
->
j_blocksize
 / (
jouº®_block_g_t
);

1163 
jouº®
->
j_wbufsize
 = 
n
;

1164 
jouº®
->
j_wbuf
 = 
	`km®loc_¬¿y
(
n
, (
bufãr_h—d
 *),

1165 
GFP_KERNEL
);

1166 ià(!
jouº®
->
j_wbuf
)

1167 
”r_ş—nup
;

1169 
bh
 = 
	`g‘blk_unmovabË
(
jouº®
->
j_dev
, 
¡¬t
, jouº®->
j_blocksize
);

1170 ià(!
bh
) {

1171 
	`´_”r
("%s: Cannot get buffer for journal superblock\n",

1172 
__func__
);

1173 
”r_ş—nup
;

1175 
jouº®
->
j_sb_bufãr
 = 
bh
;

1176 
jouº®
->
j_su³rblock
 = (
jouº®_su³rblock_t
 *)
bh
->
b_d©a
;

1178  
jouº®
;

1180 
”r_ş—nup
:

1181 
	`kä“
(
jouº®
->
j_wbuf
);

1182 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1183 
	`kä“
(
jouº®
);

1184  
NULL
;

1185 
	}
}

1210 
jouº®_t
 *
	$jbd3_jouº®_š™_dev
(
block_deviû
 *
bdev
,

1211 
block_deviû
 *
fs_dev
,

1212 
¡¬t
, 
Ën
, 
blocksize
)

1214 
jouº®_t
 *
jouº®
;

1216 
jouº®
 = 
	`jouº®_š™_commÚ
(
bdev
, 
fs_dev
, 
¡¬t
, 
Ën
, 
blocksize
);

1217 ià(!
jouº®
)

1218  
NULL
;

1220 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1221 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1222 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1224  
jouº®
;

1225 
	}
}

1235 
jouº®_t
 *
	$jbd3_jouº®_š™_šode
(
šode
 *inode)

1237 
jouº®_t
 *
jouº®
;

1238 *
p
;

1239 
blockÄ
;

1241 
blockÄ
 = 
	`bm­
(
šode
, 0);

1242 ià(!
blockÄ
) {

1243 
	`´_”r
("%s: Cannot†ocate journal superblock\n",

1244 
__func__
);

1245  
NULL
;

1248 
	`jbd_debug
(1, "JBD3: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1249 
šode
->
i_sb
->
s_id
, inode->
i_šo
, (èšode->
i_size
,

1250 
šode
->
i_sb
->
s_blocksize_b™s
, inode->i_sb->
s_blocksize
);

1252 
jouº®
 = 
	`jouº®_š™_commÚ
(
šode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1253 
blockÄ
, 
šode
->
i_size
 >> inode->
i_sb
->
s_blocksize_b™s
,

1254 
šode
->
i_sb
->
s_blocksize
);

1255 ià(!
jouº®
)

1256  
NULL
;

1258 
jouº®
->
j_šode
 = 
šode
;

1259 
	`bdevÇme
(
jouº®
->
j_dev
, jouº®->
j_devÇme
);

1260 
p
 = 
	`¡¼•Ïû
(
jouº®
->
j_devÇme
, '/', '!');

1261 
	`¥rštf
(
p
, "-%lu", 
jouº®
->
j_šode
->
i_šo
);

1262 
	`jbd3_¡©s_´oc_š™
(
jouº®
);

1264  
jouº®
;

1265 
	}
}

1272 
	$jouº®_ç_su³rblock
 (
jouº®_t
 *
jouº®
)

1274 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1275 
	`b»l£
(
bh
);

1276 
jouº®
->
j_sb_bufãr
 = 
NULL
;

1277 
	}
}

1286 
	$jouº®_»£t
(
jouº®_t
 *
jouº®
)

1288 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1289 
fœ¡
, 
Ï¡
;

1291 
fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1292 
Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1293 ià(
fœ¡
 + 
JBD3_MIN_JOURNAL_BLOCKS
 > 
Ï¡
 + 1) {

1294 
	`´štk
(
KERN_ERR
 "JBD3: Journaloo short (blocks %llu-%llu).\n",

1295 
fœ¡
, 
Ï¡
);

1296 
	`jouº®_ç_su³rblock
(
jouº®
);

1297  -
EINVAL
;

1300 
jouº®
->
j_fœ¡
 = 
fœ¡
;

1301 
jouº®
->
j_Ï¡
 = 
Ï¡
;

1303 
jouº®
->
j_h—d
 = 
fœ¡
;

1304 
jouº®
->
j_
 = 
fœ¡
;

1305 
jouº®
->
j_ä“
 = 
Ï¡
 - 
fœ¡
;

1307 
jouº®
->
j__£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
;

1308 
jouº®
->
j_comm™_£qu’û
 = jouº®->
j_Œª§ùiÚ_£qu’û
 - 1;

1309 
jouº®
->
j_comm™_»que¡
 = jouº®->
j_comm™_£qu’û
;

1311 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 = jouº®->
j_maxËn
 / 4;

1319 ià(
sb
->
s_¡¬t
 == 0) {

1320 
	`jbd_debug
(1, "JBD3: Skipping superblock update on„ecovered sb "

1322 
jouº®
->
j_
, jouº®->
j__£qu’û
,

1323 
jouº®
->
j_”ºo
);

1324 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1327 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1334 
	`jbd3_jouº®_upd©e_sb_log_
(
jouº®
,

1335 
jouº®
->
j__£qu’û
,

1336 
jouº®
->
j_
,

1337 
REQ_SYNC
 | 
REQ_FUA
);

1338 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1340  
	`jbd3_jouº®_¡¬t_th»ad
(
jouº®
);

1341 
	}
}

1347 
	$jbd3_wr™e_su³rblock
(
jouº®_t
 *
jouº®
, 
wr™e_æags
)

1349 
bufãr_h—d
 *
bh
 = 
jouº®
->
j_sb_bufãr
;

1350 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1351 
»t
;

1354 ià(!
	`bufãr_m­³d
(
bh
))

1355  -
EIO
;

1357 
	`Œaû_jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_æags
);

1358 ià(!(
jouº®
->
j_æags
 & 
JBD3_BARRIER
))

1359 
wr™e_æags
 &ğ~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1360 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1369 
	`´štk
(
KERN_ERR
 "JBD3:…revious I/Oƒrror detected "

1371 
jouº®
->
j_devÇme
);

1372 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1373 
	`£t_bufãr_u±od©e
(
bh
);

1375 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

1376 
sb
->
s_checksum
 = 
	`jbd3_su³rblock_csum
(
jouº®
, sb);

1377 
	`g‘_bh
(
bh
);

1378 
bh
->
b_’d_io
 = 
’d_bufãr_wr™e_sync
;

1379 
»t
 = 
	`subm™_bh
(
REQ_OP_WRITE
, 
wr™e_æags
, 
bh
);

1380 
	`wa™_Ú_bufãr
(
bh
);

1381 ià(
	`bufãr_wr™e_io_”rÜ
(
bh
)) {

1382 
	`ş—r_bufãr_wr™e_io_”rÜ
(
bh
);

1383 
	`£t_bufãr_u±od©e
(
bh
);

1384 
»t
 = -
EIO
;

1386 ià(
»t
) {

1387 
	`´štk
(
KERN_ERR
 "JBD3: Error %d detected when updating "

1388 "jouº® su³rblock fÜ %s.\n", 
»t
,

1389 
jouº®
->
j_devÇme
);

1390 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

1393  
»t
;

1394 
	}
}

1406 
	$jbd3_jouº®_upd©e_sb_log_
(
jouº®_t
 *
jouº®
, 
tid_t
 
_tid
,

1407 
_block
, 
wr™e_İ
)

1409 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1410 
»t
;

1412 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

1413  -
EIO
;

1415 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1416 
	`jbd_debug
(1, "JBD3: updating superblock (start %lu, seq %u)\n",

1417 
_block
, 
_tid
);

1419 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1420 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
_tid
);

1421 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(
_block
);

1423 
»t
 = 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1424 ià(
»t
)

1425 
out
;

1428 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1429 
	`WARN_ON
(!
sb
->
s_£qu’û
);

1430 
jouº®
->
j_æags
 &ğ~
JBD3_FLUSHED
;

1431 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1433 
out
:

1434  
»t
;

1435 
	}
}

1445 
	$jbd3_m¬k_jouº®_em±y
(
jouº®_t
 *
jouº®
, 
wr™e_İ
)

1447 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1449 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
jouº®
->
j_checkpošt_mu‹x
));

1450 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1451 ià(
sb
->
s_¡¬t
 == 0) {

1452 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1456 
	`jbd_debug
(1, "JBD3: Marking journal‡sƒmpty (seq %d)\n",

1457 
jouº®
->
j__£qu’û
);

1459 
sb
->
s_£qu’û
 = 
	`ıu_to_be32
(
jouº®
->
j__£qu’û
);

1460 
sb
->
s_¡¬t
 = 
	`ıu_to_be32
(0);

1462 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
wr™e_İ
);

1465 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1466 
jouº®
->
j_æags
 |ğ
JBD3_FLUSHED
;

1467 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1468 
	}
}

1478 
	$jbd3_jouº®_upd©e_sb_”ºo
(
jouº®_t
 *
jouº®
)

1480 
jouº®_su³rblock_t
 *
sb
 = 
jouº®
->
j_su³rblock
;

1481 
”rcode
;

1483 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1484 
”rcode
 = 
jouº®
->
j_”ºo
;

1485 ià(
”rcode
 =ğ-
ESHUTDOWN
)

1486 
”rcode
 = 0;

1487 
	`jbd_debug
(1, "JBD3: upd©šg su³rblockƒ¼Ü (”ºØ%d)\n", 
”rcode
);

1488 
sb
->
s_”ºo
 = 
	`ıu_to_be32
(
”rcode
);

1490 
	`jbd3_wr™e_su³rblock
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

1491 
	}
}

1492 
EXPORT_SYMBOL
(
jbd3_jouº®_upd©e_sb_”ºo
);

1498 
	$jouº®_g‘_su³rblock
(
jouº®_t
 *
jouº®
)

1500 
bufãr_h—d
 *
bh
;

1501 
jouº®_su³rblock_t
 *
sb
;

1502 
”r
 = -
EIO
;

1504 
bh
 = 
jouº®
->
j_sb_bufãr
;

1506 
	`J_ASSERT
(
bh
 !ğ
NULL
);

1507 ià(!
	`bufãr_u±od©e
(
bh
)) {

1508 
	`Î_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1509 
	`wa™_Ú_bufãr
(
bh
);

1510 ià(!
	`bufãr_u±od©e
(
bh
)) {

1511 
	`´štk
(
KERN_ERR


1513 
out
;

1517 ià(
	`bufãr_v”if›d
(
bh
))

1520 
sb
 = 
jouº®
->
j_su³rblock
;

1522 
”r
 = -
EINVAL
;

1524 ià(
sb
->
s_h—d”
.
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
) ||

1525 
sb
->
s_blocksize
 !ğ
	`ıu_to_be32
(
jouº®
->
j_blocksize
)) {

1526 
	`´štk
(
KERN_WARNING
 "JBD3:‚o valid journal superblock found\n");

1527 
out
;

1530 
	`be32_to_ıu
(
sb
->
s_h—d”
.
h_blockty³
)) {

1531 
JBD3_SUPERBLOCK_V1
:

1532 
jouº®
->
j_fÜm©_v”siÚ
 = 1;

1534 
JBD3_SUPERBLOCK_V2
:

1535 
jouº®
->
j_fÜm©_v”siÚ
 = 2;

1538 
	`´štk
(
KERN_WARNING
 "JBD3: unrecognised superblock format ID\n");

1539 
out
;

1542 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è< 
jouº®
->
j_maxËn
)

1543 
jouº®
->
j_maxËn
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1544 ià(
	`be32_to_ıu
(
sb
->
s_maxËn
è> 
jouº®
->
j_maxËn
) {

1545 
	`´štk
(
KERN_WARNING
 "JBD3: journal fileoo short\n");

1546 
out
;

1549 ià(
	`be32_to_ıu
(
sb
->
s_fœ¡
) == 0 ||

1550 
	`be32_to_ıu
(
sb
->
s_fœ¡
è>ğ
jouº®
->
j_maxËn
) {

1551 
	`´štk
(
KERN_WARNING


1553 
	`be32_to_ıu
(
sb
->
s_fœ¡
));

1554 
out
;

1557 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
) &&

1558 
	`jbd3_has_ã©u»_csum3
(
jouº®
)) {

1560 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v2‡nd v3 "

1562 
out
;

1565 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
) &&

1566 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

1568 
	`´štk
(
KERN_ERR
 "JBD3: Can'tƒnable checksumming v1‡nd v2/3 "

1570 
out
;

1573 ià(!
	`jbd3_v”ify_csum_ty³
(
jouº®
, 
sb
)) {

1574 
	`´štk
(
KERN_ERR
 "JBD3: Unknown checksumype\n");

1575 
out
;

1579 ià(
	`jbd3_jouº®_has_csum_v2Ü3_ã©u»
(
jouº®
)) {

1580 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1581 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1582 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1583 
”r
 = 
	`PTR_ERR
(
jouº®
->
j_chksum_driv”
);

1584 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1585 
out
;

1589 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
)) {

1591 ià(
sb
->
s_checksum
 !ğ
	`jbd3_su³rblock_csum
(
jouº®
, sb)) {

1592 
	`´štk
(
KERN_ERR
 "JBD3: journal checksumƒrror\n");

1593 
”r
 = -
EFSBADCRC
;

1594 
out
;

1598 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1599 (
sb
->
s_uuid
));

1602 
	`£t_bufãr_v”if›d
(
bh
);

1606 
out
:

1607 
	`jouº®_ç_su³rblock
(
jouº®
);

1608  
”r
;

1609 
	}
}

1616 
	$lßd_su³rblock
(
jouº®_t
 *
jouº®
)

1618 
”r
;

1619 
jouº®_su³rblock_t
 *
sb
;

1621 
”r
 = 
	`jouº®_g‘_su³rblock
(
jouº®
);

1622 ià(
”r
)

1623  
”r
;

1625 
sb
 = 
jouº®
->
j_su³rblock
;

1627 
jouº®
->
j__£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

1628 
jouº®
->
j_
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

1629 
jouº®
->
j_fœ¡
 = 
	`be32_to_ıu
(
sb
->
s_fœ¡
);

1630 
jouº®
->
j_Ï¡
 = 
	`be32_to_ıu
(
sb
->
s_maxËn
);

1631 
jouº®
->
j_”ºo
 = 
	`be32_to_ıu
(
sb
->
s_”ºo
);

1634 
	}
}

1645 
	$jbd3_jouº®_lßd
(
jouº®_t
 *
jouº®
)

1647 
”r
;

1648 
jouº®_su³rblock_t
 *
sb
;

1650 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

1651 ià(
”r
)

1652  
”r
;

1654 
sb
 = 
jouº®
->
j_su³rblock
;

1658 ià(
jouº®
->
j_fÜm©_v”siÚ
 >= 2) {

1659 ià((
sb
->
s_ã©u»_ro_com·t
 &

1660 ~
	`ıu_to_be32
(
JBD3_KNOWN_ROCOMPAT_FEATURES
)) ||

1661 (
sb
->
s_ã©u»_šcom·t
 &

1662 ~
	`ıu_to_be32
(
JBD3_KNOWN_INCOMPAT_FEATURES
))) {

1663 
	`´štk
(
KERN_WARNING


1665  -
EINVAL
;

1672 
”r
 = 
	`jbd3_jouº®_ü—‹_¦ab
(
	`be32_to_ıu
(
sb
->
s_blocksize
));

1673 ià(
”r
)

1674  
”r
;

1678 ià(
	`jbd3_jouº®_»cov”
(
jouº®
))

1679 
»cov”y_”rÜ
;

1681 ià(
jouº®
->
j_çed_comm™
) {

1682 
	`´štk
(
KERN_ERR
 "JBD3: journalransaction %u on %s "

1683 "i cÜru±.\n", 
jouº®
->
j_çed_comm™
,

1684 
jouº®
->
j_devÇme
);

1685  -
EFSCORRUPTED
;

1691 ià(
	`jouº®_»£t
(
jouº®
))

1692 
»cov”y_”rÜ
;

1694 
jouº®
->
j_æags
 &ğ~
JBD3_ABORT
;

1695 
jouº®
->
j_æags
 |ğ
JBD3_LOADED
;

1698 
»cov”y_”rÜ
:

1699 
	`´štk
(
KERN_WARNING
 "JBD3:„ecovery failed\n");

1700  -
EIO
;

1701 
	}
}

1711 
	$jbd3_jouº®_de¡roy
(
jouº®_t
 *
jouº®
)

1713 
”r
 = 0;

1716 
	`jouº®_kl_th»ad
(
jouº®
);

1719 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
)

1720 
	`jbd3_jouº®_comm™_Œª§ùiÚ
(
jouº®
);

1725 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1726 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1727 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1728 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1729 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

1730 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1735 ià(
”r
) {

1736 
	`jbd3_jouº®_de¡roy_checkpošt
(
jouº®
);

1737 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1740 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1743 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

1744 
	`J_ASSERT
(
jouº®
->
j_comm™tšg_Œª§ùiÚ
 =ğ
NULL
);

1745 
	`J_ASSERT
(
jouº®
->
j_checkpošt_Œª§ùiÚs
 =ğ
NULL
);

1746 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1748 ià(
jouº®
->
j_sb_bufãr
) {

1749 ià(!
	`is_jouº®_abÜ‹d
(
jouº®
)) {

1750 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1752 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1753 
jouº®
->
j__£qu’û
 =

1754 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

1755 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1757 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
,

1758 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1759 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1761 
”r
 = -
EIO
;

1762 
	`b»l£
(
jouº®
->
j_sb_bufãr
);

1765 ià(
jouº®
->
j_´oc_’Œy
)

1766 
	`jbd3_¡©s_´oc_ex™
(
jouº®
);

1767 
	`ut
(
jouº®
->
j_šode
);

1768 ià(
jouº®
->
j_»voke
)

1769 
	`jbd3_jouº®_de¡roy_»voke
(
jouº®
);

1770 ià(
jouº®
->
j_chksum_driv”
)

1771 
	`üy±o_ä“_shash
(
jouº®
->
j_chksum_driv”
);

1772 
	`kä“
(
jouº®
->
j_wbuf
);

1773 
	`kä“
(
jouº®
);

1775  
”r
;

1776 
	}
}

1790 
	$jbd3_jouº®_check_u£d_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1791 
ro
, 
šcom·t
)

1793 
jouº®_su³rblock_t
 *
sb
;

1795 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1798 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 0 &&

1799 
	`jouº®_g‘_su³rblock
(
jouº®
) != 0)

1801 ià(
jouº®
->
j_fÜm©_v”siÚ
 == 1)

1804 
sb
 = 
jouº®
->
j_su³rblock
;

1806 ià(((
	`be32_to_ıu
(
sb
->
s_ã©u»_com·t
è& 
com·t
) == compat) &&

1807 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_ro_com·t
è& 
ro
) ==„o) &&

1808 ((
	`be32_to_ıu
(
sb
->
s_ã©u»_šcom·t
è& 
šcom·t
) == incompat))

1812 
	}
}

1825 
	$jbd3_jouº®_check_avaabË_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1826 
ro
, 
šcom·t
)

1828 ià(!
com·t
 && !
ro
 && !
šcom·t
)

1835 ià(
jouº®
->
j_fÜm©_v”siÚ
 != 2)

1838 ià((
com·t
 & 
JBD3_KNOWN_COMPAT_FEATURES
) == compat &&

1839 (
ro
 & 
JBD3_KNOWN_ROCOMPAT_FEATURES
) ==„o &&

1840 (
šcom·t
 & 
JBD3_KNOWN_INCOMPAT_FEATURES
) == incompat)

1844 
	}
}

1858 
	$jbd3_jouº®_£t_ã©u»s
 (
jouº®_t
 *
jouº®
, 
com·t
,

1859 
ro
, 
šcom·t
)

1861 
	#INCOMPAT_FEATURE_ON
(
f
) \

1862 ((
šcom·t
 & (
f
)è&& !(
sb
->
s_ã©u»_šcom·t
 & 
	`ıu_to_be32
(f)))

	)

1863 
	#COMPAT_FEATURE_ON
(
f
) \

1864 ((
com·t
 & (
f
)è&& !(
sb
->
s_ã©u»_com·t
 & 
	`ıu_to_be32
(f)))

	)

1865 
jouº®_su³rblock_t
 *
sb
;

1867 ià(
	`jbd3_jouº®_check_u£d_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1870 ià(!
	`jbd3_jouº®_check_avaabË_ã©u»s
(
jouº®
, 
com·t
, 
ro
, 
šcom·t
))

1874 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V2
) {

1875 
šcom·t
 &ğ~
JBD3_FEATURE_INCOMPAT_CSUM_V2
;

1876 
šcom·t
 |ğ
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

1880 ià(
šcom·t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 &&

1881 
com·t
 & 
JBD3_FEATURE_COMPAT_CHECKSUM
)

1882 
com·t
 &ğ~
JBD3_FEATURE_COMPAT_CHECKSUM
;

1884 
	`jbd_debug
(1, "Setting‚ew features 0x%lx/0x%lx/0x%lx\n",

1885 
com·t
, 
ro
, 
šcom·t
);

1887 
sb
 = 
jouº®
->
j_su³rblock
;

1890 ià((
jouº®
->
j_chksum_driv”
 =ğ
NULL
) &&

1891 
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1892 
jouº®
->
j_chksum_driv”
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

1893 ià(
	`IS_ERR
(
jouº®
->
j_chksum_driv”
)) {

1894 
	`´štk
(
KERN_ERR
 "JBD3: Cannot†oad crc32c driver.\n");

1895 
jouº®
->
j_chksum_driv”
 = 
NULL
;

1899 
jouº®
->
j_csum_£ed
 = 
	`jbd3_chksum
(jouº®, ~0, 
sb
->
s_uuid
,

1900 (
sb
->
s_uuid
));

1903 
	`lock_bufãr
(
jouº®
->
j_sb_bufãr
);

1906 ià(
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1907 
sb
->
s_checksum_ty³
 = 
JBD3_CRC32C_CHKSUM
;

1908 
sb
->
s_ã©u»_com·t
 &=

1909 ~
	`ıu_to_be32
(
JBD3_FEATURE_COMPAT_CHECKSUM
);

1913 ià(
	`COMPAT_FEATURE_ON
(
JBD3_FEATURE_COMPAT_CHECKSUM
))

1914 
sb
->
s_ã©u»_šcom·t
 &=

1915 ~
	`ıu_to_be32
(
JBD3_FEATURE_INCOMPAT_CSUM_V2
 |

1916 
JBD3_FEATURE_INCOMPAT_CSUM_V3
);

1918 
sb
->
s_ã©u»_com·t
 |ğ
	`ıu_to_be32
(
com·t
);

1919 
sb
->
s_ã©u»_ro_com·t
 |ğ
	`ıu_to_be32
(
ro
);

1920 
sb
->
s_ã©u»_šcom·t
 |ğ
	`ıu_to_be32
(
šcom·t
);

1921 
	`uÆock_bufãr
(
jouº®
->
j_sb_bufãr
);

1924 #undeà
COMPAT_FEATURE_ON


1925 #undeà
INCOMPAT_FEATURE_ON


1926 
	}
}

1939 
	$jbd3_jouº®_ş—r_ã©u»s
(
jouº®_t
 *
jouº®
, 
com·t
,

1940 
ro
, 
šcom·t
)

1942 
jouº®_su³rblock_t
 *
sb
;

1944 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1945 
com·t
, 
ro
, 
šcom·t
);

1947 
sb
 = 
jouº®
->
j_su³rblock
;

1949 
sb
->
s_ã©u»_com·t
 &ğ~
	`ıu_to_be32
(
com·t
);

1950 
sb
->
s_ã©u»_ro_com·t
 &ğ~
	`ıu_to_be32
(
ro
);

1951 
sb
->
s_ã©u»_šcom·t
 &ğ~
	`ıu_to_be32
(
šcom·t
);

1952 
	}
}

1953 
EXPORT_SYMBOL
(
jbd3_jouº®_ş—r_ã©u»s
);

1964 
	$jbd3_jouº®_æush
(
jouº®_t
 *
jouº®
)

1966 
”r
 = 0;

1967 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
NULL
;

1969 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

1972 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

1973 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

1974 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1975 } ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
)

1976 
Œª§ùiÚ
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

1979 ià(
Œª§ùiÚ
) {

1980 
tid_t
 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1982 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1983 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

1985 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

1989 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1990 !
”r
 && 
jouº®
->
j_checkpošt_Œª§ùiÚs
 !ğ
NULL
) {

1991 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1992 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

1993 
”r
 = 
	`jbd3_log_do_checkpošt
(
jouº®
);

1994 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

1995 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1997 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1999 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

2000  -
EIO
;

2002 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2003 ià(!
”r
) {

2004 
”r
 = 
	`jbd3_ş—nup_jouº®_
(
jouº®
);

2005 ià(
”r
 < 0) {

2006 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2007 
out
;

2009 
”r
 = 0;

2017 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2018 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2019 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2020 
	`J_ASSERT
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2021 
	`J_ASSERT
(!
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2022 
	`J_ASSERT
(!
jouº®
->
j_checkpošt_Œª§ùiÚs
);

2023 
	`J_ASSERT
(
jouº®
->
j_h—d
 =ğjouº®->
j_
);

2024 
	`J_ASSERT
(
jouº®
->
j__£qu’û
 =ğjouº®->
j_Œª§ùiÚ_£qu’û
);

2025 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2026 
out
:

2027  
”r
;

2028 
	}
}

2043 
	$jbd3_jouº®_we
(
jouº®_t
 *
jouº®
, 
wr™e
)

2045 
”r
 = 0;

2047 
	`J_ASSERT
 (!(
jouº®
->
j_æags
 & 
JBD3_LOADED
));

2049 
”r
 = 
	`lßd_su³rblock
(
jouº®
);

2050 ià(
”r
)

2051  
”r
;

2053 ià(!
jouº®
->
j_
)

2054 
no_»cov”y
;

2056 
	`´štk
(
KERN_WARNING
 "JBD3: %s„ecovery information on journal\n",

2057 
wr™e
 ? "Clearing" : "Ignoring");

2059 
”r
 = 
	`jbd3_jouº®_sk_»cov”y
(
jouº®
);

2060 ià(
wr™e
) {

2062 
	`mu‹x_lock_io
(&
jouº®
->
j_checkpošt_mu‹x
);

2063 
	`jbd3_m¬k_jouº®_em±y
(
jouº®
, 
REQ_SYNC
 | 
REQ_FUA
);

2064 
	`mu‹x_uÆock
(&
jouº®
->
j_checkpošt_mu‹x
);

2067 
no_»cov”y
:

2068  
”r
;

2069 
	}
}

2084 
	$__jbd3_jouº®_abÜt_h¬d
(
jouº®_t
 *
jouº®
)

2086 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2088 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2091 
	`´štk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2092 
jouº®
->
j_devÇme
);

2094 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2095 
jouº®
->
j_æags
 |ğ
JBD3_ABORT
;

2096 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2097 ià(
Œª§ùiÚ
)

2098 
	`__jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

2099 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2100 
	}
}

2104 
	$__jouº®_abÜt_soá
 (
jouº®_t
 *
jouº®
, 
”ºo
)

2106 
Şd_”ºo
;

2108 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2109 
Şd_”ºo
 = 
jouº®
->
j_”ºo
;

2110 ià(!
jouº®
->
j_”ºo
 || 
”ºo
 =ğ-
ESHUTDOWN
)

2111 
jouº®
->
j_”ºo
 = 
”ºo
;

2113 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
) {

2114 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2115 ià(!
Şd_”ºo
 && old_”ºØ!ğ-
ESHUTDOWN
 &&

2116 
”ºo
 =ğ-
ESHUTDOWN
)

2117 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2120 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2122 
	`__jbd3_jouº®_abÜt_h¬d
(
jouº®
);

2124 ià(
”ºo
) {

2125 
	`jbd3_jouº®_upd©e_sb_”ºo
(
jouº®
);

2126 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2127 
jouº®
->
j_æags
 |ğ
JBD3_REC_ERR
;

2128 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2130 
	}
}

2178 
	$jbd3_jouº®_abÜt
(
jouº®_t
 *
jouº®
, 
”ºo
)

2180 
	`__jouº®_abÜt_soá
(
jouº®
, 
”ºo
);

2181 
	}
}

2194 
	$jbd3_jouº®_”ºo
(
jouº®_t
 *
jouº®
)

2196 
”r
;

2198 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2199 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2200 
”r
 = -
EROFS
;

2202 
”r
 = 
jouº®
->
j_”ºo
;

2203 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2204  
”r
;

2205 
	}
}

2214 
	$jbd3_jouº®_ş—r_”r
(
jouº®_t
 *
jouº®
)

2216 
”r
 = 0;

2218 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2219 ià(
jouº®
->
j_æags
 & 
JBD3_ABORT
)

2220 
”r
 = -
EROFS
;

2222 
jouº®
->
j_”ºo
 = 0;

2223 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2224  
”r
;

2225 
	}
}

2234 
	$jbd3_jouº®_ack_”r
(
jouº®_t
 *
jouº®
)

2236 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2237 ià(
jouº®
->
j_”ºo
)

2238 
jouº®
->
j_æags
 |ğ
JBD3_ACK_ERR
;

2239 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2240 
	}
}

2242 
	$jbd3_jouº®_blocks_³r_·ge
(
šode
 *inode)

2244  1 << (
PAGE_SHIFT
 - 
šode
->
i_sb
->
s_blocksize_b™s
);

2245 
	}
}

2250 
size_t
 
	$jouº®_g_by‹s
(
jouº®_t
 *
jouº®
)

2252 
size_t
 
sz
;

2254 ià(
	`jbd3_has_ã©u»_csum3
(
jouº®
))

2255  (
jouº®_block_g3_t
);

2257 
sz
 = (
jouº®_block_g_t
);

2259 ià(
	`jbd3_has_ã©u»_csum2
(
jouº®
))

2260 
sz
 +ğ(
__u16
);

2262 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

2263  
sz
;

2265  
sz
 - (
__u32
);

2266 
	}
}

2283 
	#JBD3_MAX_SLABS
 8

	)

2284 
kmem_ÿche
 *
	gjbd3_¦ab
[
JBD3_MAX_SLABS
];

2286 cÚ¡ *
	gjbd3_¦ab_Çmes
[
JBD3_MAX_SLABS
] = {

2292 
	$jbd3_jouº®_de¡roy_¦abs
()

2294 
i
;

2296 
i
 = 0; i < 
JBD3_MAX_SLABS
; i++) {

2297 
	`kmem_ÿche_de¡roy
(
jbd3_¦ab
[
i
]);

2298 
jbd3_¦ab
[
i
] = 
NULL
;

2300 
	}
}

2302 
	$jbd3_jouº®_ü—‹_¦ab
(
size_t
 
size
)

2304 
	`DEFINE_MUTEX
(
jbd3_¦ab_ü—‹_mu‹x
);

2305 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2306 
size_t
 
¦ab_size
;

2308 ià(
size
 =ğ
PAGE_SIZE
)

2311 ià(
i
 >ğ
JBD3_MAX_SLABS
)

2312  -
EINVAL
;

2314 ià(
	`uÆik–y
(
i
 < 0))

2315 
i
 = 0;

2316 
	`mu‹x_lock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2317 ià(
jbd3_¦ab
[
i
]) {

2318 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2322 
¦ab_size
 = 1 << (
i
+10);

2323 
jbd3_¦ab
[
i
] = 
	`kmem_ÿche_ü—‹
(
jbd3_¦ab_Çmes
[i], 
¦ab_size
,

2324 
¦ab_size
, 0, 
NULL
);

2325 
	`mu‹x_uÆock
(&
jbd3_¦ab_ü—‹_mu‹x
);

2326 ià(!
jbd3_¦ab
[
i
]) {

2327 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for jbd3_slab cache\n");

2328  -
ENOMEM
;

2331 
	}
}

2333 
kmem_ÿche
 *
	$g‘_¦ab
(
size_t
 
size
)

2335 
i
 = 
	`Üd”_ba£_2
(
size
) - 10;

2337 
	`BUG_ON
(
i
 >ğ
JBD3_MAX_SLABS
);

2338 ià(
	`uÆik–y
(
i
 < 0))

2339 
i
 = 0;

2340 
	`BUG_ON
(
jbd3_¦ab
[
i
] =ğ
NULL
);

2341  
jbd3_¦ab
[
i
];

2342 
	}
}

2344 *
	$jbd3_®loc
(
size_t
 
size
, 
gå_t
 
æags
)

2346 *
±r
;

2348 
	`BUG_ON
(
size
 & (size-1));

2350 ià(
size
 < 
PAGE_SIZE
)

2351 
±r
 = 
	`kmem_ÿche_®loc
(
	`g‘_¦ab
(
size
), 
æags
);

2353 
±r
 = (*)
	`__g‘_ä“_·ges
(
æags
, 
	`g‘_Üd”
(
size
));

2357 
	`BUG_ON
(((è
±r
è& (
size
-1));

2359  
±r
;

2360 
	}
}

2362 
	$jbd3_ä“
(*
±r
, 
size_t
 
size
)

2364 ià(
size
 < 
PAGE_SIZE
)

2365 
	`kmem_ÿche_ä“
(
	`g‘_¦ab
(
size
), 
±r
);

2367 
	`ä“_·ges
(()
±r
, 
	`g‘_Üd”
(
size
));

2368 
	}
};

2373 
kmem_ÿche
 *
	gjbd3_jouº®_h—d_ÿche
;

2374 #ifdeà
CONFIG_JBD3_DEBUG


2375 
©omic_t
 
	gÄ_jouº®_h—ds
 = 
ATOMIC_INIT
(0);

2378 
__š™
 
	$jbd3_jouº®_š™_jouº®_h—d_ÿche
()

2380 
	`J_ASSERT
(!
jbd3_jouº®_h—d_ÿche
);

2381 
jbd3_jouº®_h—d_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_journal_head",

2382 (
jouº®_h—d
),

2384 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2385 
NULL
);

2386 ià(!
jbd3_jouº®_h—d_ÿche
) {

2387 
	`´štk
(
KERN_EMERG
 "JBD3:‚o memory for journal_head cache\n");

2388  -
ENOMEM
;

2391 
	}
}

2393 
	$jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
()

2395 
	`kmem_ÿche_de¡roy
(
jbd3_jouº®_h—d_ÿche
);

2396 
jbd3_jouº®_h—d_ÿche
 = 
NULL
;

2397 
	}
}

2402 
jouº®_h—d
 *
	$jouº®_®loc_jouº®_h—d
()

2404 
jouº®_h—d
 *
»t
;

2406 #ifdeà
CONFIG_JBD3_DEBUG


2407 
	`©omic_šc
(&
Ä_jouº®_h—ds
);

2409 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
, 
GFP_NOFS
);

2410 ià(!
»t
) {

2411 
	`jbd_debug
(1, "out of memory for journal_head\n");

2412 
	`´_nÙiû_¿‹lim™ed
("ENOMEM iÀ%s,„‘ryšg.\n", 
__func__
);

2413 
»t
 = 
	`kmem_ÿche_z®loc
(
jbd3_jouº®_h—d_ÿche
,

2414 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2416  
»t
;

2417 
	}
}

2419 
	$jouº®_ä“_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2421 #ifdeà
CONFIG_JBD3_DEBUG


2422 
	`©omic_dec
(&
Ä_jouº®_h—ds
);

2423 
	`mem£t
(
jh
, 
JBD3_POISON_FREE
, (*jh));

2425 
	`kmem_ÿche_ä“
(
jbd3_jouº®_h—d_ÿche
, 
jh
);

2426 
	}
}

2469 
jouº®_h—d
 *
	$jbd3_jouº®_add_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2471 
jouº®_h—d
 *
jh
;

2472 
jouº®_h—d
 *
Ãw_jh
 = 
NULL
;

2474 
»³©
:

2475 ià(!
	`bufãr_jbd
(
bh
))

2476 
Ãw_jh
 = 
	`jouº®_®loc_jouº®_h—d
();

2478 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2479 ià(
	`bufãr_jbd
(
bh
)) {

2480 
jh
 = 
	`bh2jh
(
bh
);

2482 
	`J_ASSERT_BH
(
bh
,

2483 (
	`©omic_»ad
(&
bh
->
b_couÁ
) > 0) ||

2484 (
bh
->
b_·ge
 && bh->b_·ge->
m­pšg
));

2486 ià(!
Ãw_jh
) {

2487 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2488 
»³©
;

2491 
jh
 = 
Ãw_jh
;

2492 
Ãw_jh
 = 
NULL
;

2493 
	`£t_bufãr_jbd
(
bh
);

2494 
bh
->
b_´iv©e
 = 
jh
;

2495 
jh
->
b_bh
 = 
bh
;

2496 
	`g‘_bh
(
bh
);

2497 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2499 
jh
->
b_jcouÁ
++;

2500 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2501 ià(
Ãw_jh
)

2502 
	`jouº®_ä“_jouº®_h—d
(
Ãw_jh
);

2503  
bh
->
b_´iv©e
;

2504 
	}
}

2510 
jouº®_h—d
 *
	$jbd3_jouº®_g¿b_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2512 
jouº®_h—d
 *
jh
 = 
NULL
;

2514 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2515 ià(
	`bufãr_jbd
(
bh
)) {

2516 
jh
 = 
	`bh2jh
(
bh
);

2517 
jh
->
b_jcouÁ
++;

2519 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2520  
jh
;

2521 
	}
}

2523 
	$__jouº®_»move_jouº®_h—d
(
bufãr_h—d
 *
bh
)

2525 
jouº®_h—d
 *
jh
 = 
	`bh2jh
(
bh
);

2527 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 >= 0);

2528 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
NULL
);

2529 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2530 
	`J_ASSERT_JH
(
jh
, jh->
b_ı_Œª§ùiÚ
 =ğ
NULL
);

2531 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 =ğ
BJ_NÚe
);

2532 
	`J_ASSERT_BH
(
bh
, 
	`bufãr_jbd
(bh));

2533 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2534 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2535 ià(
jh
->
b_äoz’_d©a
) {

2536 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_äoz’_d©a\n", 
__func__
);

2537 
	`jbd3_ä“
(
jh
->
b_äoz’_d©a
, 
bh
->
b_size
);

2539 ià(
jh
->
b_comm™‹d_d©a
) {

2540 
	`´štk
(
KERN_WARNING
 "%s: f»ešg b_comm™‹d_d©a\n", 
__func__
);

2541 
	`jbd3_ä“
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_size
);

2543 
bh
->
b_´iv©e
 = 
NULL
;

2544 
jh
->
b_bh
 = 
NULL
;

2545 
	`ş—r_bufãr_jbd
(
bh
);

2546 
	`jouº®_ä“_jouº®_h—d
(
jh
);

2547 
	}
}

2553 
	$jbd3_jouº®_put_jouº®_h—d
(
jouº®_h—d
 *
jh
)

2555 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2557 
	`jbd_lock_bh_jouº®_h—d
(
bh
);

2558 
	`J_ASSERT_JH
(
jh
, jh->
b_jcouÁ
 > 0);

2559 --
jh
->
b_jcouÁ
;

2560 ià(!
jh
->
b_jcouÁ
) {

2561 
	`__jouº®_»move_jouº®_h—d
(
bh
);

2562 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2563 
	`__b»l£
(
bh
);

2565 
	`jbd_uÆock_bh_jouº®_h—d
(
bh
);

2566 
	}
}

2571 
	$jbd3_jouº®_š™_jbd_šode
(
jbd3_šode
 *
jšode
, 
šode
 *inode)

2573 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2574 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
NULL
;

2575 
jšode
->
i_vfs_šode
 = 
šode
;

2576 
jšode
->
i_æags
 = 0;

2577 
	`INIT_LIST_HEAD
(&
jšode
->
i_li¡
);

2578 
	}
}

2585 
	$jbd3_jouº®_»Ëa£_jbd_šode
(
jouº®_t
 *
jouº®
,

2586 
jbd3_šode
 *
jšode
)

2588 ià(!
jouº®
)

2590 
»¡¬t
:

2591 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2593 ià(
jšode
->
i_æags
 & 
JI_COMMIT_RUNNING
) {

2594 
wa™_queue_h—d_t
 *
wq
;

2595 
	`DEFINE_WAIT_BIT
(
wa™
, &
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2596 
wq
 = 
	`b™_wa™queue
(&
jšode
->
i_æags
, 
__JI_COMMIT_RUNNING
);

2597 
	`´•¬e_to_wa™
(
wq
, &
wa™
.
wq_’Œy
, 
TASK_UNINTERRUPTIBLE
);

2598 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2599 
	`scheduË
();

2600 
	`fšish_wa™
(
wq
, &
wa™
.
wq_’Œy
);

2601 
»¡¬t
;

2604 ià(
jšode
->
i_Œª§ùiÚ
) {

2605 
	`li¡_d–
(&
jšode
->
i_li¡
);

2606 
jšode
->
i_Œª§ùiÚ
 = 
NULL
;

2608 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2609 
	}
}

2612 #ifdeà
CONFIG_PROC_FS


2614 
	#JBD3_STATS_PROC_NAME
 "fs/jbd3"

	)

2616 
__š™
 
	$jbd3_ü—‹_jbd_¡©s_´oc_’Œy
()

2618 
´oc_jbd3_¡©s
 = 
	`´oc_mkdœ
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2619 
	}
}

2621 
__ex™
 
	$jbd3_»move_jbd_¡©s_´oc_’Œy
()

2623 ià(
´oc_jbd3_¡©s
)

2624 
	`»move_´oc_’Œy
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2625 
	}
}

2629 
	#jbd3_ü—‹_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2630 
	#jbd3_»move_jbd_¡©s_´oc_’Œy
(èdØ{} 0)

	)

2634 
kmem_ÿche
 *
	gjbd3_hªdË_ÿche
, *
	gjbd3_šode_ÿche
;

2636 
__š™
 
	$jbd3_jouº®_š™_šode_ÿche
()

2638 
	`J_ASSERT
(!
jbd3_šode_ÿche
);

2639 
jbd3_šode_ÿche
 = 
	`KMEM_CACHE
(
jbd3_šode
, 0);

2640 ià(!
jbd3_šode_ÿche
) {

2641 
	`´_em”g
("JBD3: failedo create inode cache\n");

2642  -
ENOMEM
;

2645 
	}
}

2647 
__š™
 
	$jbd3_jouº®_š™_hªdË_ÿche
()

2649 
	`J_ASSERT
(!
jbd3_hªdË_ÿche
);

2650 
jbd3_hªdË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_jouº®_hªdË
, 
SLAB_TEMPORARY
);

2651 ià(!
jbd3_hªdË_ÿche
) {

2652 
	`´štk
(
KERN_EMERG
 "JBD3: failedo create handle cache\n");

2653  -
ENOMEM
;

2656 
	}
}

2658 
	$jbd3_jouº®_de¡roy_šode_ÿche
()

2660 
	`kmem_ÿche_de¡roy
(
jbd3_šode_ÿche
);

2661 
jbd3_šode_ÿche
 = 
NULL
;

2662 
	}
}

2664 
	$jbd3_jouº®_de¡roy_hªdË_ÿche
()

2666 
	`kmem_ÿche_de¡roy
(
jbd3_hªdË_ÿche
);

2667 
jbd3_hªdË_ÿche
 = 
NULL
;

2668 
	}
}

2674 
__š™
 
	$jouº®_š™_ÿches
()

2676 
»t
;

2678 
»t
 = 
	`jbd3_jouº®_š™_»voke_»cÜd_ÿche
();

2679 ià(
»t
 == 0)

2680 
»t
 = 
	`jbd3_jouº®_š™_»voke_bË_ÿche
();

2681 ià(
»t
 == 0)

2682 
»t
 = 
	`jbd3_jouº®_š™_jouº®_h—d_ÿche
();

2683 ià(
»t
 == 0)

2684 
»t
 = 
	`jbd3_jouº®_š™_hªdË_ÿche
();

2685 ià(
»t
 == 0)

2686 
»t
 = 
	`jbd3_jouº®_š™_šode_ÿche
();

2687 ià(
»t
 == 0)

2688 
»t
 = 
	`jbd3_jouº®_š™_Œª§ùiÚ_ÿche
();

2689  
»t
;

2690 
	}
}

2692 
	$jbd3_jouº®_de¡roy_ÿches
()

2694 
	`jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
();

2695 
	`jbd3_jouº®_de¡roy_»voke_bË_ÿche
();

2696 
	`jbd3_jouº®_de¡roy_jouº®_h—d_ÿche
();

2697 
	`jbd3_jouº®_de¡roy_hªdË_ÿche
();

2698 
	`jbd3_jouº®_de¡roy_šode_ÿche
();

2699 
	`jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
();

2700 
	`jbd3_jouº®_de¡roy_¦abs
();

2701 
	}
}

2703 
__š™
 
	$jouº®_š™
()

2705 
»t
;

2707 
	`BUILD_BUG_ON
((
jouº®_su³rblock_s
) != 1024);

2709 
»t
 = 
	`jouº®_š™_ÿches
();

2710 ià(
»t
 == 0) {

2711 
	`jbd3_ü—‹_jbd_¡©s_´oc_’Œy
();

2713 
	`jbd3_jouº®_de¡roy_ÿches
();

2715  
»t
;

2716 
	}
}

2718 
__ex™
 
	$jouº®_ex™
()

2720 #ifdeà
CONFIG_JBD3_DEBUG


2721 
n
 = 
	`©omic_»ad
(&
Ä_jouº®_h—ds
);

2722 ià(
n
)

2723 
	`´štk
(
KERN_ERR
 "JBD3:†—ked %d jouº®_h—ds!\n", 
n
);

2725 
	`jbd3_»move_jbd_¡©s_´oc_’Œy
();

2726 
	`jbd3_jouº®_de¡roy_ÿches
();

2727 
	}
}

2729 
MODULE_LICENSE
("GPL");

2730 
moduË_š™
(
jouº®_š™
);

2731 
moduË_ex™
(
jouº®_ex™
);

	@recovery.c

13 #iâdeà
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<lšux/time.h
>

17 
	~<lšux/fs.h
>

18 
	~<lšux/jbd3.h
>

19 
	~<lšux/”ºo.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/blkdev.h
>

28 
	s»cov”y_šfo


30 
tid_t
 
	m¡¬t_Œª§ùiÚ
;

31 
tid_t
 
	m’d_Œª§ùiÚ
;

33 
	mÄ_»¶ays
;

34 
	mÄ_»vokes
;

35 
	mÄ_»voke_h™s
;

38 
	e·s¡y³
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_Úe_·ss
(
jouº®_t
 *
jouº®
,

40 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
);

41 
sÿn_»voke_»cÜds
(
jouº®_t
 *, 
bufãr_h—d
 *,

42 
tid_t
, 
»cov”y_šfo
 *);

44 #ifdeà
__KERNEL__


47 
	$jouº®_b»l£_¬¿y
(
bufãr_h—d
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`b»l£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_»adah—d
(
jouº®_t
 *
jouº®
, 
¡¬t
)

69 
”r
;

70 
max
, 
nbufs
, 
Ãxt
;

71 
blockÄ
;

72 
bufãr_h—d
 *
bh
;

74 
bufãr_h—d
 * 
bufs
[
MAXBUF
];

77 
max
 = 
¡¬t
 + (128 * 1024 / 
jouº®
->
j_blocksize
);

78 ià(
max
 > 
jouº®
->
j_maxËn
)

79 
max
 = 
jouº®
->
j_maxËn
;

84 
nbufs
 = 0;

86 
Ãxt
 = 
¡¬t
;‚exˆ< 
max
;‚ext++) {

87 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
Ãxt
, &
blockÄ
);

89 ià(
”r
) {

90 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

91 
Ãxt
);

92 
çed
;

95 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

96 ià(!
bh
) {

97 
”r
 = -
ENOMEM
;

98 
çed
;

101 ià(!
	`bufãr_u±od©e
(
bh
è&& !
	`bufãr_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 ià(
nbufs
 =ğ
MAXBUF
) {

104 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`b»l£
(
bh
);

112 ià(
nbufs
)

113 
	`Î_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
”r
 = 0;

116 
çed
:

117 ià(
nbufs
)

118 
	`jouº®_b»l£_¬¿y
(
bufs
, 
nbufs
);

119  
”r
;

120 
	}
}

129 
	$j»ad
(
bufãr_h—d
 **
bhp
, 
jouº®_t
 *
jouº®
,

130 
off£t
)

132 
”r
;

133 
blockÄ
;

134 
bufãr_h—d
 *
bh
;

136 *
bhp
 = 
NULL
;

138 ià(
off£t
 >ğ
jouº®
->
j_maxËn
) {

139 
	`´štk
(
KERN_ERR
 "JBD3: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
”r
 = 
	`jbd3_jouº®_bm­
(
jouº®
, 
off£t
, &
blockÄ
);

145 ià(
”r
) {

146 
	`´štk
(
KERN_ERR
 "JBD3: bad block‡t offset %u\n",

147 
off£t
);

148  
”r
;

151 
bh
 = 
	`__g‘blk
(
jouº®
->
j_dev
, 
blockÄ
, jouº®->
j_blocksize
);

152 ià(!
bh
)

153  -
ENOMEM
;

155 ià(!
	`bufãr_u±od©e
(
bh
)) {

158 ià(!
	`bufãr_»q
(
bh
))

159 
	`do_»adah—d
(
jouº®
, 
off£t
);

160 
	`wa™_Ú_bufãr
(
bh
);

163 ià(!
	`bufãr_u±od©e
(
bh
)) {

164 
	`´štk
(
KERN_ERR
 "JBD3: Failedo„ead block‡t offset %u\n",

165 
off£t
);

166 
	`b»l£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd3_desütÜ_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

176 
jbd3_jouº®_block_
 *

;

177 
__be32
 
´ovided
;

178 
__u32
 
ÿlcuÏ‹d
;

180 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

183 

 = (
jbd3_jouº®_block_
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd3_jouº®_block_
));

185 
´ovided
 = 

->
t_checksum
;

186 

->
t_checksum
 = 0;

187 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 

->
t_checksum
 = 
´ovided
;

190  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

191 
	}
}

197 
	$couÁ_gs
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

199 * 
gp
;

200 
jouº®_block_g_t
 * 
g
;

201 
Ä
 = 0, 
size
 = 
jouº®
->
j_blocksize
;

202 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

204 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

205 
size
 -ğ(
jbd3_jouº®_block_
);

207 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

209 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
è<ğ
size
) {

210 
g
 = (
jouº®_block_g_t
 *è
gp
;

212 
Ä
++;

213 
gp
 +ğ
g_by‹s
;

214 ià(!(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_SAME_UUID
)))

215 
gp
 += 16;

217 ià(
g
->
t_æags
 & 
	`ıu_to_be16
(
JBD3_FLAG_LAST_TAG
))

221  
Ä
;

222 
	}
}

226 
	#w¿p
(
jouº®
, 
v¬
) \

228 ià(
v¬
 >ğ(
jouº®
)->
j_Ï¡
) \

229 
v¬
 -ğ((
jouº®
)->
j_Ï¡
 - (jouº®)->
j_fœ¡
); \

230 } 0)

	)

244 
	$jbd3_jouº®_»cov”
(
jouº®_t
 *
jouº®
)

246 
”r
, 
”r2
;

247 
jouº®_su³rblock_t
 * 
sb
;

249 
»cov”y_šfo
 
šfo
;

251 
	`mem£t
(&
šfo
, 0, (info));

252 
sb
 = 
jouº®
->
j_su³rblock
;

260 ià(!
sb
->
s_¡¬t
) {

261 
	`jbd_debug
(1, "No„ecovery„equired,†astransaction %d\n",

262 
	`be32_to_ıu
(
sb
->
s_£qu’û
));

263 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
) + 1;

267 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

268 ià(!
”r
)

269 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REVOKE
);

270 ià(!
”r
)

271 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD3:„ecovery,ƒxit status %d, "

275 
”r
, 
šfo
.
¡¬t_Œª§ùiÚ
, info.
’d_Œª§ùiÚ
);

276 
	`jbd_debug
(1, "JBD3: Replayed %d‡nd„evoked %d/%d blocks\n",

277 
šfo
.
Ä_»¶ays
, info.
Ä_»voke_h™s
, info.
Ä_»vokes
);

281 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

283 
	`jbd3_jouº®_ş—r_»voke
(
jouº®
);

284 
”r2
 = 
	`sync_blockdev
(
jouº®
->
j_fs_dev
);

285 ià(!
”r
)

286 
”r
 = 
”r2
;

288 ià(
jouº®
->
j_æags
 & 
JBD3_BARRIER
) {

289 
”r2
 = 
	`blkdev_issue_æush
(
jouº®
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 ià(!
”r
)

291 
”r
 = 
”r2
;

293  
”r
;

294 
	}
}

309 
	$jbd3_jouº®_sk_»cov”y
(
jouº®_t
 *
jouº®
)

311 
”r
;

313 
»cov”y_šfo
 
šfo
;

315 
	`mem£t
 (&
šfo
, 0, (info));

317 
”r
 = 
	`do_Úe_·ss
(
jouº®
, &
šfo
, 
PASS_SCAN
);

319 ià(
”r
) {

320 
	`´štk
(
KERN_ERR
 "JBD3:ƒ¼Ü %d sÿÂšg jouº®\n", 
”r
);

321 ++
jouº®
->
j_Œª§ùiÚ_£qu’û
;

323 #ifdeà
CONFIG_JBD3_DEBUG


324 
drİ³d
 = 
šfo
.
’d_Œª§ùiÚ
 -

325 
	`be32_to_ıu
(
jouº®
->
j_su³rblock
->
s_£qu’û
);

326 
	`jbd_debug
(1,

328 
drİ³d
, (dropped == 1) ? "" : "s");

330 
jouº®
->
j_Œª§ùiÚ_£qu’û
 = ++
šfo
.
’d_Œª§ùiÚ
;

333 
jouº®
->
j_
 = 0;

334  
”r
;

335 
	}
}

337 
šlše
 
	$»ad_g_block
(
jouº®_t
 *
jouº®
,

338 
jouº®_block_g_t
 *
g
)

340 
block
 = 
	`be32_to_ıu
(
g
->
t_blockÄ
);

341 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

342 
block
 |ğ(
u64
)
	`be32_to_ıu
(
g
->
t_blockÄ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ÿlc_chksums
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

351 *
Ãxt_log_block
, 
__u32
 *
üc32_sum
)

353 
i
, 
num_blks
, 
”r
;

354 
io_block
;

355 
bufãr_h—d
 *
obh
;

357 
num_blks
 = 
	`couÁ_gs
(
jouº®
, 
bh
);

359 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
Ãxt_log_block
)++;

363 
	`w¿p
(
jouº®
, *
Ãxt_log_block
);

364 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

365 ià(
”r
) {

366 
	`´štk
(
KERN_ERR
 "JBD3: IOƒrror %d„ecovering block "

367 "%lu iÀlog\n", 
”r
, 
io_block
);

370 *
üc32_sum
 = 
	`üc32_be
(*üc32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd3_comm™_block_csum_v”ify
(
jouº®_t
 *
j
, *
buf
)

380 
comm™_h—d”
 *
h
;

381 
__be32
 
´ovided
;

382 
__u32
 
ÿlcuÏ‹d
;

384 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

387 
h
 = 
buf
;

388 
´ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ÿlcuÏ‹d
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
´ovided
;

393  
´ovided
 =ğ
	`ıu_to_be32
(
ÿlcuÏ‹d
);

394 
	}
}

396 
	$jbd3_block_g_csum_v”ify
(
jouº®_t
 *
j
, 
jouº®_block_g_t
 *
g
,

397 *
buf
, 
__u32
 
£qu’û
)

399 
jouº®_block_g3_t
 *
g3
 = (jouº®_block_g3_ˆ*)
g
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 ià(!
	`jbd3_jouº®_has_csum_v2Ü3
(
j
))

406 
£q
 = 
	`ıu_to_be32
(
£qu’û
);

407 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 ià(
	`jbd3_has_ã©u»_csum3
(
j
))

411  
g3
->
t_checksum
 =ğ
	`ıu_to_be32
(
csum32
);

413  
g
->
t_checksum
 =ğ
	`ıu_to_be16
(
csum32
);

414 
	}
}

416 
	$do_Úe_·ss
(
jouº®_t
 *
jouº®
,

417 
»cov”y_šfo
 *
šfo
, 
·s¡y³
 
·ss
)

419 
fœ¡_comm™_ID
, 
Ãxt_comm™_ID
;

420 
Ãxt_log_block
;

421 
”r
, 
sucûss
 = 0;

422 
jouº®_su³rblock_t
 * 
sb
;

423 
jouº®_h—d”_t
 * 
tmp
;

424 
bufãr_h—d
 * 
bh
;

425 
£qu’û
;

426 
blockty³
;

427 
g_by‹s
 = 
	`jouº®_g_by‹s
(
jouº®
);

428 
__u32
 
üc32_sum
 = ~0;

429 
desü_csum_size
 = 0;

430 
block_”rÜ
 = 0;

438 
sb
 = 
jouº®
->
j_su³rblock
;

439 
Ãxt_comm™_ID
 = 
	`be32_to_ıu
(
sb
->
s_£qu’û
);

440 
Ãxt_log_block
 = 
	`be32_to_ıu
(
sb
->
s_¡¬t
);

442 
fœ¡_comm™_ID
 = 
Ãxt_comm™_ID
;

443 ià(
·ss
 =ğ
PASS_SCAN
)

444 
šfo
->
¡¬t_Œª§ùiÚ
 = 
fœ¡_comm™_ID
;

446 
	`jbd_debug
(1, "S¹šg„ecov”y…as %d\n", 
·ss
);

456 
æags
;

457 * 
gp
;

458 
jouº®_block_g_t
 * 
g
;

459 
bufãr_h—d
 * 
obh
;

460 
bufãr_h—d
 * 
nbh
;

462 
	`cÚd_»sched
();

468 ià(
·ss
 !ğ
PASS_SCAN
)

469 ià(
	`tid_geq
(
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %u‡t %lu/%lu\n",

473 
Ãxt_comm™_ID
, 
Ãxt_log_block
, 
jouº®
->
j_Ï¡
);

479 
	`jbd_debug
(3, "JBD3: checkšg block %ld\n", 
Ãxt_log_block
);

480 
”r
 = 
	`j»ad
(&
bh
, 
jouº®
, 
Ãxt_log_block
);

481 ià(
”r
)

482 
çed
;

484 
Ãxt_log_block
++;

485 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

493 
tmp
 = (
jouº®_h—d”_t
 *)
bh
->
b_d©a
;

495 ià(
tmp
->
h_magic
 !ğ
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
)) {

496 
	`b»l£
(
bh
);

500 
blockty³
 = 
	`be32_to_ıu
(
tmp
->
h_blockty³
);

501 
£qu’û
 = 
	`be32_to_ıu
(
tmp
->
h_£qu’û
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty³
, 
£qu’û
);

505 ià(
£qu’û
 !ğ
Ãxt_comm™_ID
) {

506 
	`b»l£
(
bh
);

514 
blockty³
) {

515 
JBD3_DESCRIPTOR_BLOCK
:

517 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

518 
desü_csum_size
 =

519 (
jbd3_jouº®_block_
);

520 ià(
desü_csum_size
 > 0 &&

521 !
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
,

522 
bh
->
b_d©a
)) {

523 
	`´štk
(
KERN_ERR
 "JBD3: Invalid checksum "

525 
Ãxt_log_block
);

526 
”r
 = -
EFSBADCRC
;

527 
	`b»l£
(
bh
);

528 
çed
;

535 ià(
·ss
 !ğ
PASS_REPLAY
) {

536 ià(
·ss
 =ğ
PASS_SCAN
 &&

537 
	`jbd3_has_ã©u»_checksum
(
jouº®
) &&

538 !
šfo
->
’d_Œª§ùiÚ
) {

539 ià(
	`ÿlc_chksums
(
jouº®
, 
bh
,

540 &
Ãxt_log_block
,

541 &
üc32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
Ãxt_log_block
 +ğ
	`couÁ_gs
(
jouº®
, 
bh
);

549 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

550 
	`put_bh
(
bh
);

558 
gp
 = &
bh
->
b_d©a
[(
jouº®_h—d”_t
)];

559 (
gp
 - 
bh
->
b_d©a
 + 
g_by‹s
)

560 <ğ
jouº®
->
j_blocksize
 - 
desü_csum_size
) {

561 
io_block
;

563 
g
 = (
jouº®_block_g_t
 *è
gp
;

564 
æags
 = 
	`be16_to_ıu
(
g
->
t_æags
);

566 
io_block
 = 
Ãxt_log_block
++;

567 
	`w¿p
(
jouº®
, 
Ãxt_log_block
);

568 
”r
 = 
	`j»ad
(&
obh
, 
jouº®
, 
io_block
);

569 ià(
”r
) {

572 
sucûss
 = 
”r
;

573 
	`´štk
(
KERN_ERR


576 
”r
, 
io_block
);

578 
blockÄ
;

580 
	`J_ASSERT
(
obh
 !ğ
NULL
);

581 
blockÄ
 = 
	`»ad_g_block
(
jouº®
,

582 
g
);

587 ià(
jbd3_jouº®_‹¡_»voke


588 (
jouº®
, 
blockÄ
,

589 
Ãxt_comm™_ID
)) {

590 
	`b»l£
(
obh
);

591 ++
šfo
->
Ä_»voke_h™s
;

592 
sk_wr™e
;

596 ià(!
	`jbd3_block_g_csum_v”ify
(

597 
jouº®
, 
g
, 
obh
->
b_d©a
,

598 
	`be32_to_ıu
(
tmp
->
h_£qu’û
))) {

599 
	`b»l£
(
obh
);

600 
sucûss
 = -
EFSBADCRC
;

601 
	`´štk
(
KERN_ERR
 "JBD3: Invalid "

604 "log\n", 
blockÄ
);

605 
block_”rÜ
 = 1;

606 
sk_wr™e
;

611 
nbh
 = 
	`__g‘blk
(
jouº®
->
j_fs_dev
,

612 
blockÄ
,

613 
jouº®
->
j_blocksize
);

614 ià(
nbh
 =ğ
NULL
) {

615 
	`´štk
(
KERN_ERR


618 
”r
 = -
ENOMEM
;

619 
	`b»l£
(
bh
);

620 
	`b»l£
(
obh
);

621 
çed
;

624 
	`lock_bufãr
(
nbh
);

625 
	`memıy
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jouº®
->
j_blocksize
);

627 ià(
æags
 & 
JBD3_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`ıu_to_be32
(
JBD3_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_bufãr_u±od©e
(
nbh
);

634 
	`m¬k_bufãr_dœty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
šfo
->
Ä_»¶ays
;

638 
	`uÆock_bufãr
(
nbh
);

639 
	`b»l£
(
obh
);

640 
	`b»l£
(
nbh
);

643 
sk_wr™e
:

644 
gp
 +ğ
g_by‹s
;

645 ià(!(
æags
 & 
JBD3_FLAG_SAME_UUID
))

646 
gp
 += 16;

648 ià(
æags
 & 
JBD3_FLAG_LAST_TAG
)

652 
	`b»l£
(
bh
);

655 
JBD3_COMMIT_BLOCK
:

691 ià(
·ss
 =ğ
PASS_SCAN
 &&

692 
	`jbd3_has_ã©u»_checksum
(
jouº®
)) {

693 
chksum_”r
, 
chksum_£’
;

694 
comm™_h—d”
 *
cbh
 =

695 (
comm™_h—d”
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_ıu
(
cbh
->
h_chksum
[0]);

699 
chksum_”r
 = 
chksum_£’
 = 0;

701 ià(
šfo
->
’d_Œª§ùiÚ
) {

702 
jouº®
->
j_çed_comm™
 =

703 
šfo
->
’d_Œª§ùiÚ
;

704 
	`b»l£
(
bh
);

708 ià(
üc32_sum
 =ğ
found_chksum
 &&

709 
cbh
->
h_chksum_ty³
 =ğ
JBD3_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD3_CRC32_CHKSUM_SIZE
)

712 
chksum_£’
 = 1;

713 ià(!(
cbh
->
h_chksum_ty³
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£’
))

727 
chksum_”r
 = 1;

729 ià(
chksum_”r
) {

730 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

732 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

733 
jouº®
->
j_çed_comm™
 =

734 
Ãxt_comm™_ID
;

735 
	`b»l£
(
bh
);

739 
üc32_sum
 = ~0;

741 ià(
·ss
 =ğ
PASS_SCAN
 &&

742 !
	`jbd3_comm™_block_csum_v”ify
(
jouº®
,

743 
bh
->
b_d©a
)) {

744 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

746 ià(!
	`jbd3_has_ã©u»_async_comm™
(
jouº®
)) {

747 
jouº®
->
j_çed_comm™
 =

748 
Ãxt_comm™_ID
;

749 
	`b»l£
(
bh
);

753 
	`b»l£
(
bh
);

754 
Ãxt_comm™_ID
++;

757 
JBD3_REVOKE_BLOCK
:

760 ià(
·ss
 !ğ
PASS_REVOKE
) {

761 
	`b»l£
(
bh
);

765 
”r
 = 
	`sÿn_»voke_»cÜds
(
jouº®
, 
bh
,

766 
Ãxt_comm™_ID
, 
šfo
);

767 
	`b»l£
(
bh
);

768 ià(
”r
)

769 
çed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,ƒnd of scan.\n",

774 
blockty³
);

775 
	`b»l£
(
bh
);

776 
dÚe
;

780 
dÚe
:

788 ià(
·ss
 =ğ
PASS_SCAN
) {

789 ià(!
šfo
->
’d_Œª§ùiÚ
)

790 
šfo
->
’d_Œª§ùiÚ
 = 
Ãxt_comm™_ID
;

794 ià(
šfo
->
’d_Œª§ùiÚ
 !ğ
Ãxt_comm™_ID
) {

795 
	`´štk
(
KERN_ERR
 "JBD3:„ecovery…ass %dƒnded‡t "

797 
·ss
, 
Ãxt_comm™_ID
, 
šfo
->
’d_Œª§ùiÚ
);

798 ià(!
sucûss
)

799 
sucûss
 = -
EIO
;

802 ià(
block_”rÜ
 && 
sucûss
 == 0)

803 
sucûss
 = -
EIO
;

804  
sucûss
;

806 
çed
:

807  
”r
;

808 
	}
}

812 
	$sÿn_»voke_»cÜds
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

813 
tid_t
 
£qu’û
, 
»cov”y_šfo
 *
šfo
)

815 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcouÁ
;

819 
»cÜd_Ën
 = 4;

821 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *è
bh
->
b_d©a
;

822 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

823 
rcouÁ
 = 
	`be32_to_ıu
(
h—d”
->
r_couÁ
);

825 ià(!
	`jbd3_desütÜ_block_csum_v”ify
(
jouº®
, 
h—d”
))

826  -
EFSBADCRC
;

828 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

829 
csum_size
 = (
jbd3_jouº®_block_
);

830 ià(
rcouÁ
 > 
jouº®
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcouÁ
;

834 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

835 
»cÜd_Ën
 = 8;

837 
off£t
 + 
»cÜd_Ën
 <ğ
max
) {

838 
blockÄ
;

839 
”r
;

841 ià(
»cÜd_Ën
 == 4)

842 
blockÄ
 = 
	`be32_to_ıu
(* ((
__be32
 *è(
bh
->
b_d©a
+
off£t
)));

844 
blockÄ
 = 
	`be64_to_ıu
(* ((
__be64
 *è(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +ğ
»cÜd_Ën
;

846 
”r
 = 
	`jbd3_jouº®_£t_»voke
(
jouº®
, 
blockÄ
, 
£qu’û
);

847 ià(
”r
)

848  
”r
;

849 ++
šfo
->
Ä_»vokes
;

852 
	}
}

	@revoke.c

80 #iâdeà
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<lšux/time.h
>

84 
	~<lšux/fs.h
>

85 
	~<lšux/jbd3.h
>

86 
	~<lšux/”ºo.h
>

87 
	~<lšux/¦ab.h
>

88 
	~<lšux/li¡.h
>

89 
	~<lšux/š™.h
>

90 
	~<lšux/bio.h
>

91 
	~<lšux/log2.h
>

92 
	~<lšux/hash.h
>

95 
kmem_ÿche
 *
	gjbd3_»voke_»cÜd_ÿche
;

96 
kmem_ÿche
 *
	gjbd3_»voke_bË_ÿche
;

102 
	sjbd3_»voke_»cÜd_s


104 
li¡_h—d
 
	mhash
;

105 
tid_t
 
	m£qu’û
;

106 
	mblockÄ
;

111 
	sjbd3_»voke_bË_s


115 
	mhash_size
;

116 
	mhash_shiá
;

117 
li¡_h—d
 *
	mhash_bË
;

121 #ifdeà
__KERNEL__


122 
wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *,

123 
li¡_h—d
 *,

124 
bufãr_h—d
 **, *,

125 
jbd3_»voke_»cÜd_s
 *);

126 
æush_desütÜ
(
jouº®_t
 *, 
bufãr_h—d
 *, );

131 
šlše
 
	$hash
(
jouº®_t
 *
jouº®
, 
block
)

133  
	`hash_64
(
block
, 
jouº®
->
j_»voke
->
hash_shiá
);

134 
	}
}

136 
	$š£¹_»voke_hash
(
jouº®_t
 *
jouº®
, 
blockÄ
,

137 
tid_t
 
£q
)

139 
li¡_h—d
 *
hash_li¡
;

140 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

141 
gå_t
 
gå_mask
 = 
GFP_NOFS
;

143 ià(
jouº®_oom_»Œy
)

144 
gå_mask
 |ğ
__GFP_NOFAIL
;

145 
»cÜd
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_»cÜd_ÿche
, 
gå_mask
);

146 ià(!
»cÜd
)

147  -
ENOMEM
;

149 
»cÜd
->
£qu’û
 = 
£q
;

150 
»cÜd
->
blockÄ
 = blocknr;

151 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

152 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

153 
	`li¡_add
(&
»cÜd
->
hash
, 
hash_li¡
);

154 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

156 
	}
}

160 
jbd3_»voke_»cÜd_s
 *
	$fšd_»voke_»cÜd
(
jouº®_t
 *
jouº®
,

161 
blockÄ
)

163 
li¡_h—d
 *
hash_li¡
;

164 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

166 
hash_li¡
 = &
jouº®
->
j_»voke
->
hash_bË
[
	`hash
(jouº®, 
blockÄ
)];

168 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

169 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è
hash_li¡
->
Ãxt
;

170 &(
»cÜd
->
hash
è!ğ
hash_li¡
) {

171 ià(
»cÜd
->
blockÄ
 == blocknr) {

172 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

173  
»cÜd
;

175 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *è»cÜd->
hash
.
Ãxt
;

177 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd3_jouº®_de¡roy_»voke_»cÜd_ÿche
()

183 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_»cÜd_ÿche
);

184 
jbd3_»voke_»cÜd_ÿche
 = 
NULL
;

185 
	}
}

187 
	$jbd3_jouº®_de¡roy_»voke_bË_ÿche
()

189 
	`kmem_ÿche_de¡roy
(
jbd3_»voke_bË_ÿche
);

190 
jbd3_»voke_bË_ÿche
 = 
NULL
;

191 
	}
}

193 
__š™
 
	$jbd3_jouº®_š™_»voke_»cÜd_ÿche
()

195 
	`J_ASSERT
(!
jbd3_»voke_»cÜd_ÿche
);

196 
jbd3_»voke_»cÜd_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_»cÜd_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 ià(!
jbd3_»voke_»cÜd_ÿche
) {

200 
	`´_em”g
("JBD3: failedo create„evoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__š™
 
	$jbd3_jouº®_š™_»voke_bË_ÿche
()

208 
	`J_ASSERT
(!
jbd3_»voke_bË_ÿche
);

209 
jbd3_»voke_bË_ÿche
 = 
	`KMEM_CACHE
(
jbd3_»voke_bË_s
,

210 
SLAB_TEMPORARY
);

211 ià(!
jbd3_»voke_bË_ÿche
) {

212 
	`´_em”g
("JBD3: failedo create„evoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd3_»voke_bË_s
 *
	$jbd3_jouº®_š™_»voke_bË
(
hash_size
)

220 
shiá
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd3_»voke_bË_s
 *
bË
;

224 
bË
 = 
	`kmem_ÿche_®loc
(
jbd3_»voke_bË_ÿche
, 
GFP_KERNEL
);

225 ià(!
bË
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shiá
++;

231 
bË
->
hash_size
 = hash_size;

232 
bË
->
hash_shiá
 = 
shiá
;

233 
bË
->
hash_bË
 =

234 
	`km®loc_¬¿y
(
hash_size
, (
li¡_h—d
), 
GFP_KERNEL
);

235 ià(!
bË
->
hash_bË
) {

236 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

237 
bË
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;m°< 
hash_size
;mp++)

242 
	`INIT_LIST_HEAD
(&
bË
->
hash_bË
[
tmp
]);

244 
out
:

245  
bË
;

246 
	}
}

248 
	$jbd3_jouº®_de¡roy_»voke_bË
(
jbd3_»voke_bË_s
 *
bË
)

250 
i
;

251 
li¡_h—d
 *
hash_li¡
;

253 
i
 = 0; i < 
bË
->
hash_size
; i++) {

254 
hash_li¡
 = &
bË
->
hash_bË
[
i
];

255 
	`J_ASSERT
(
	`li¡_em±y
(
hash_li¡
));

258 
	`kä“
(
bË
->
hash_bË
);

259 
	`kmem_ÿche_ä“
(
jbd3_»voke_bË_ÿche
, 
bË
);

260 
	}
}

263 
	$jbd3_jouº®_š™_»voke
(
jouº®_t
 *
jouº®
, 
hash_size
)

265 
	`J_ASSERT
(
jouº®
->
j_»voke_bË
[0] =ğ
NULL
);

266 
	`J_ASSERT
(
	`is_pow”_of_2
(
hash_size
));

268 
jouº®
->
j_»voke_bË
[0] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

269 ià(!
jouº®
->
j_»voke_bË
[0])

270 
ç0
;

272 
jouº®
->
j_»voke_bË
[1] = 
	`jbd3_jouº®_š™_»voke_bË
(
hash_size
);

273 ià(!
jouº®
->
j_»voke_bË
[1])

274 
ç1
;

276 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

278 
	`¥š_lock_š™
(&
jouº®
->
j_»voke_lock
);

282 
ç1
:

283 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

284 
jouº®
->
j_»voke_bË
[0] = 
NULL
;

285 
ç0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd3_jouº®_de¡roy_»voke
(
jouº®_t
 *
jouº®
)

292 
jouº®
->
j_»voke
 = 
NULL
;

293 ià(
jouº®
->
j_»voke_bË
[0])

294 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[0]);

295 ià(
jouº®
->
j_»voke_bË
[1])

296 
	`jbd3_jouº®_de¡roy_»voke_bË
(
jouº®
->
j_»voke_bË
[1]);

297 
	}
}

300 #ifdeà
__KERNEL__


326 
	$jbd3_jouº®_»voke
(
hªdË_t
 *
hªdË
, 
blockÄ
,

327 
bufãr_h—d
 *
bh_š
)

329 
bufãr_h—d
 *
bh
 = 
NULL
;

330 
jouº®_t
 *
jouº®
;

331 
block_deviû
 *
bdev
;

332 
”r
;

334 
	`might_¦“p
();

335 ià(
bh_š
)

336 
	`BUFFER_TRACE
(
bh_š
, "enter");

338 
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

339 ià(!
	`jbd3_jouº®_£t_ã©u»s
(
jouº®
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot set„evoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jouº®
->
j_fs_dev
;

345 
bh
 = 
bh_š
;

347 ià(!
bh
) {

348 
bh
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

349 ià(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifdeà
JBD3_EXPENSIVE_CHECKING


354 
bufãr_h—d
 *
bh2
;

358 
bh2
 = 
	`__fšd_g‘_block
(
bdev
, 
blockÄ
, 
jouº®
->
j_blocksize
);

359 ià(
bh2
) {

361 ià(
bh2
 !ğ
bh
 && 
	`bufãr_»vokev®id
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`bufãr_»voked
(bh2));

369 
	`put_bh
(
bh2
);

377 ià(
bh
) {

378 ià(!
	`J_EXPECT_BH
(
bh
, !
	`bufãr_»voked
(bh),

380 ià(!
bh_š
)

381 
	`b»l£
(
bh
);

382  -
EIO
;

384 
	`£t_bufãr_»voked
(
bh
);

385 
	`£t_bufãr_»vokev®id
(
bh
);

386 ià(
bh_š
) {

387 
	`BUFFER_TRACE
(
bh_š
, "call jbd3_journal_forget");

388 
	`jbd3_jouº®_fÜg‘
(
hªdË
, 
bh_š
);

390 
	`BUFFER_TRACE
(
bh
, "call brelse");

391 
	`__b»l£
(
bh
);

395 
	`jbd_debug
(2, "š£¹„evokfÜ block %Îu, bh_š=%p\n",
blockÄ
, 
bh_š
);

396 
”r
 = 
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
,

397 
hªdË
->
h_Œª§ùiÚ
->
t_tid
);

398 
	`BUFFER_TRACE
(
bh_š
, "exit");

399  
”r
;

400 
	}
}

417 
	$jbd3_jouº®_ÿnûl_»voke
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
)

419 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

420 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
;

421 
Ãed_ÿnûl
;

422 
did_»voke
 = 0;

423 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

425 
	`jbd_debug
(4, "jouº®_h—d %p, cªûÎšg„evoke\n", 
jh
);

431 ià(
	`‹¡_£t_bufãr_»vokev®id
(
bh
)) {

432 
Ãed_ÿnûl
 = 
	`‹¡_ş—r_bufãr_»voked
(
bh
);

434 
Ãed_ÿnûl
 = 1;

435 
	`ş—r_bufãr_»voked
(
bh
);

438 ià(
Ãed_ÿnûl
) {

439 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

440 ià(
»cÜd
) {

441 
	`jbd_debug
(4, "cancelledƒxisting„evoke on "

442 "blockÄ %Îu\n", ()
bh
->
b_blockÄ
);

443 
	`¥š_lock
(&
jouº®
->
j_»voke_lock
);

444 
	`li¡_d–
(&
»cÜd
->
hash
);

445 
	`¥š_uÆock
(&
jouº®
->
j_»voke_lock
);

446 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

447 
did_»voke
 = 1;

451 #ifdeà
JBD3_EXPENSIVE_CHECKING


453 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
bh
->
b_blockÄ
);

454 
	`J_ASSERT_JH
(
jh
, 
»cÜd
 =ğ
NULL
);

461 ià(
Ãed_ÿnûl
) {

462 
bufãr_h—d
 *
bh2
;

463 
bh2
 = 
	`__fšd_g‘_block
(
bh
->
b_bdev
, bh->
b_blockÄ
, bh->
b_size
);

464 ià(
bh2
) {

465 ià(
bh2
 !ğ
bh
)

466 
	`ş—r_bufãr_»voked
(
bh2
);

467 
	`__b»l£
(
bh2
);

470  
did_»voke
;

471 
	}
}

478 
	$jbd3_ş—r_bufãr_»voked_æags
(
jouº®_t
 *
jouº®
)

480 
jbd3_»voke_bË_s
 *
»voke
 = 
jouº®
->
j_»voke
;

481 
i
 = 0;

483 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

484 
li¡_h—d
 *
hash_li¡
;

485 
li¡_h—d
 *
li¡_’Œy
;

486 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

488 
	`li¡_fÜ_—ch
(
li¡_’Œy
, 
hash_li¡
) {

489 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

490 
bufãr_h—d
 *
bh
;

491 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)
li¡_’Œy
;

492 
bh
 = 
	`__fšd_g‘_block
(
jouº®
->
j_fs_dev
,

493 
»cÜd
->
blockÄ
,

494 
jouº®
->
j_blocksize
);

495 ià(
bh
) {

496 
	`ş—r_bufãr_»voked
(
bh
);

497 
	`__b»l£
(
bh
);

501 
	}
}

507 
	$jbd3_jouº®_sw™ch_»voke_bË
(
jouº®_t
 *
jouº®
)

509 
i
;

511 ià(
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0])

512 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[1];

514 
jouº®
->
j_»voke
 = jouº®->
j_»voke_bË
[0];

516 
i
 = 0; i < 
jouº®
->
j_»voke
->
hash_size
; i++)

517 
	`INIT_LIST_HEAD
(&
jouº®
->
j_»voke
->
hash_bË
[
i
]);

518 
	}
}

524 
	$jbd3_jouº®_wr™e_»voke_»cÜds
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

525 
li¡_h—d
 *
log_bufs
)

527 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

528 
bufãr_h—d
 *
desütÜ
;

529 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

530 
jbd3_»voke_bË_s
 *
»voke
;

531 
li¡_h—d
 *
hash_li¡
;

532 
i
, 
off£t
, 
couÁ
;

534 
desütÜ
 = 
NULL
;

535 
off£t
 = 0;

536 
couÁ
 = 0;

539 
»voke
 = 
jouº®
->
j_»voke
 =ğjouº®->
j_»voke_bË
[0] ?

540 
jouº®
->
j_»voke_bË
[1] : journal->j_revoke_table[0];

542 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

543 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

545 !
	`li¡_em±y
(
hash_li¡
)) {

546 
»cÜd
 = (
jbd3_»voke_»cÜd_s
 *)

547 
hash_li¡
->
Ãxt
;

548 
	`wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ
, 
log_bufs
,

549 &
desütÜ
, &
off£t
, 
»cÜd
);

550 
couÁ
++;

551 
	`li¡_d–
(&
»cÜd
->
hash
);

552 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

555 ià(
desütÜ
)

556 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

557 
	`jbd_debug
(1, "WrÙ%d„evok»cÜds\n", 
couÁ
);

558 
	}
}

565 
	$wr™e_Úe_»voke_»cÜd
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

566 
li¡_h—d
 *
log_bufs
,

567 
bufãr_h—d
 **
desütÜp
,

568 *
off£
,

569 
jbd3_»voke_»cÜd_s
 *
»cÜd
)

571 
jouº®_t
 *
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

572 
csum_size
 = 0;

573 
bufãr_h—d
 *
desütÜ
;

574 
sz
, 
off£t
;

580 ià(
	`is_jouº®_abÜ‹d
(
jouº®
))

583 
desütÜ
 = *
desütÜp
;

584 
off£t
 = *
off£
;

587 ià(
	`jbd3_jouº®_has_csum_v2Ü3
(
jouº®
))

588 
csum_size
 = (
jbd3_jouº®_block_
);

590 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

591 
sz
 = 8;

593 
sz
 = 4;

596 ià(
desütÜ
) {

597 ià(
off£t
 + 
sz
 > 
jouº®
->
j_blocksize
 - 
csum_size
) {

598 
	`æush_desütÜ
(
jouº®
, 
desütÜ
, 
off£t
);

599 
desütÜ
 = 
NULL
;

603 ià(!
desütÜ
) {

604 
desütÜ
 = 
	`jbd3_jouº®_g‘_desütÜ_bufãr
(
Œª§ùiÚ
,

605 
JBD3_REVOKE_BLOCK
);

606 ià(!
desütÜ
)

610 
	`BUFFER_TRACE
(
desütÜ
, "file in†og_bufs");

611 
	`jbd3_fe_log_bh
(
log_bufs
, 
desütÜ
);

613 
off£t
 = (
jbd3_jouº®_»voke_h—d”_t
);

614 *
desütÜp
 = 
desütÜ
;

617 ià(
	`jbd3_has_ã©u»_64b™
(
jouº®
))

618 * ((
__be64
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

619 
	`ıu_to_be64
(
»cÜd
->
blockÄ
);

621 * ((
__be32
 *)(&
desütÜ
->
b_d©a
[
off£t
])) =

622 
	`ıu_to_be32
(
»cÜd
->
blockÄ
);

623 
off£t
 +ğ
sz
;

625 *
off£
 = 
off£t
;

626 
	}
}

635 
	$æush_desütÜ
(
jouº®_t
 *
jouº®
,

636 
bufãr_h—d
 *
desütÜ
,

637 
off£t
)

639 
jbd3_jouº®_»voke_h—d”_t
 *
h—d”
;

641 ià(
	`is_jouº®_abÜ‹d
(
jouº®
)) {

642 
	`put_bh
(
desütÜ
);

646 
h—d”
 = (
jbd3_jouº®_»voke_h—d”_t
 *)
desütÜ
->
b_d©a
;

647 
h—d”
->
r_couÁ
 = 
	`ıu_to_be32
(
off£t
);

648 
	`jbd3_desütÜ_block_csum_£t
(
jouº®
, 
desütÜ
);

650 
	`£t_bufãr_jwr™e
(
desütÜ
);

651 
	`BUFFER_TRACE
(
desütÜ
, "write");

652 
	`£t_bufãr_dœty
(
desütÜ
);

653 
	`wr™e_dœty_bufãr
(
desütÜ
, 
REQ_SYNC
);

654 
	}
}

679 
	$jbd3_jouº®_£t_»voke
(
jouº®_t
 *
jouº®
,

680 
blockÄ
,

681 
tid_t
 
£qu’û
)

683 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

685 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

686 ià(
»cÜd
) {

689 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

690 
»cÜd
->
£qu’û
 = sequence;

693  
	`š£¹_»voke_hash
(
jouº®
, 
blockÄ
, 
£qu’û
);

694 
	}
}

703 
	$jbd3_jouº®_‹¡_»voke
(
jouº®_t
 *
jouº®
,

704 
blockÄ
,

705 
tid_t
 
£qu’û
)

707 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

709 
»cÜd
 = 
	`fšd_»voke_»cÜd
(
jouº®
, 
blockÄ
);

710 ià(!
»cÜd
)

712 ià(
	`tid_gt
(
£qu’û
, 
»cÜd
->sequence))

715 
	}
}

722 
	$jbd3_jouº®_ş—r_»voke
(
jouº®_t
 *
jouº®
)

724 
i
;

725 
li¡_h—d
 *
hash_li¡
;

726 
jbd3_»voke_»cÜd_s
 *
»cÜd
;

727 
jbd3_»voke_bË_s
 *
»voke
;

729 
»voke
 = 
jouº®
->
j_»voke
;

731 
i
 = 0; i < 
»voke
->
hash_size
; i++) {

732 
hash_li¡
 = &
»voke
->
hash_bË
[
i
];

733 !
	`li¡_em±y
(
hash_li¡
)) {

734 
»cÜd
 = (
jbd3_»voke_»cÜd_s
*è
hash_li¡
->
Ãxt
;

735 
	`li¡_d–
(&
»cÜd
->
hash
);

736 
	`kmem_ÿche_ä“
(
jbd3_»voke_»cÜd_ÿche
, 
»cÜd
);

739 
	}
}

	@transaction.c

17 
	~<lšux/time.h
>

18 
	~<lšux/fs.h
>

19 
	~<lšux/jbd3.h
>

20 
	~<lšux/”ºo.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/tim”.h
>

23 
	~<lšux/mm.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/h¹im”.h
>

26 
	~<lšux/backšg-dev.h
>

27 
	~<lšux/bug.h
>

28 
	~<lšux/moduË.h
>

29 
	~<lšux/sched/mm.h
>

31 
	~<Œaû/ev’ts/jbd3.h
>

33 
__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
);

34 
__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
);

36 
kmem_ÿche
 *
	gŒª§ùiÚ_ÿche
;

37 
__š™
 
	$jbd3_jouº®_š™_Œª§ùiÚ_ÿche
()

39 
	`J_ASSERT
(!
Œª§ùiÚ_ÿche
);

40 
Œª§ùiÚ_ÿche
 = 
	`kmem_ÿche_ü—‹
("jbd3_transaction_s",

41 (
Œª§ùiÚ_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 ià(!
Œª§ùiÚ_ÿche
) {

46 
	`´_em”g
("JBD3: failedo createransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd3_jouº®_de¡roy_Œª§ùiÚ_ÿche
()

54 
	`kmem_ÿche_de¡roy
(
Œª§ùiÚ_ÿche
);

55 
Œª§ùiÚ_ÿche
 = 
NULL
;

56 
	}
}

58 
	$jbd3_jouº®_ä“_Œª§ùiÚ
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

60 ià(
	`uÆik–y
(
	`ZERO_OR_NULL_PTR
(
Œª§ùiÚ
)))

62 
	`kmem_ÿche_ä“
(
Œª§ùiÚ_ÿche
, 
Œª§ùiÚ
);

63 
	}
}

80 
	$jbd3_g‘_Œª§ùiÚ
(
jouº®_t
 *
jouº®
,

81 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

83 
Œª§ùiÚ
->
t_jouº®
 = 
jouº®
;

84 
Œª§ùiÚ
->
t_¡©e
 = 
T_RUNNING
;

85 
Œª§ùiÚ
->
t_¡¬t_time
 = 
	`ktime_g‘
();

86 
Œª§ùiÚ
->
t_tid
 = 
jouº®
->
j_Œª§ùiÚ_£qu’û
++;

87 
Œª§ùiÚ
->
t_expœes
 = 
jiff›s
 + 
jouº®
->
j_comm™_š‹rv®
;

88 
	`¥š_lock_š™
(&
Œª§ùiÚ
->
t_hªdË_lock
);

89 
	`©omic_£t
(&
Œª§ùiÚ
->
t_upd©es
, 0);

90 
	`©omic_£t
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
,

91 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
));

92 
	`©omic_£t
(&
Œª§ùiÚ
->
t_hªdË_couÁ
, 0);

93 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_šode_li¡
);

94 
	`INIT_LIST_HEAD
(&
Œª§ùiÚ
->
t_´iv©e_li¡
);

97 
jouº®
->
j_comm™_tim”
.
expœes
 = 
	`round_jiff›s_up
(
Œª§ùiÚ
->
t_expœes
);

98 
	`add_tim”
(&
jouº®
->
j_comm™_tim”
);

100 
	`J_ASSERT
(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 =ğ
NULL
);

101 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 = 
Œª§ùiÚ
;

102 
Œª§ùiÚ
->
t_max_wa™
 = 0;

103 
Œª§ùiÚ
->
t_¡¬t
 = 
jiff›s
;

104 
Œª§ùiÚ
->
t_»que¡ed
 = 0;

105 
	}
}

125 
šlše
 
	$upd©e_t_max_wa™
(
Œª§ùiÚ_t
 *
Œª§ùiÚ
,

126 
ts
)

128 #ifdeà
CONFIG_JBD3_DEBUG


129 ià(
jbd3_jouº®_’abË_debug
 &&

130 
	`time_aá”
(
Œª§ùiÚ
->
t_¡¬t
, 
ts
)) {

131 
ts
 = 
	`jbd3_time_diff
Ñs, 
Œª§ùiÚ
->
t_¡¬t
);

132 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

133 ià(
ts
 > 
Œª§ùiÚ
->
t_max_wa™
)

134 
Œª§ùiÚ
->
t_max_wa™
 = 
ts
;

135 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

138 
	}
}

145 
	$wa™_Œª§ùiÚ_locked
(
jouº®_t
 *
jouº®
)

146 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

148 
	`DEFINE_WAIT
(
wa™
);

149 
Ãed_to_¡¬t
;

150 
tid_t
 
tid
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
;

152 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

153 
TASK_UNINTERRUPTIBLE
);

154 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

155 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

156 ià(
Ãed_to_¡¬t
)

157 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

158 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

159 
	`scheduË
();

160 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

161 
	}
}

168 
	$wa™_Œª§ùiÚ_sw™chšg
(
jouº®_t
 *
jouº®
)

169 
	`__»Ëa£s
(
jouº®
->
j_¡©e_lock
)

171 
	`DEFINE_WAIT
(
wa™
);

173 ià(
	`WARN_ON
(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ||

174 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_¡©e
 !ğ
T_SWITCH
))

176 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
,

177 
TASK_UNINTERRUPTIBLE
);

178 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

185 
	`scheduË
();

186 
	`fšish_wa™
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
, &
wa™
);

187 
	}
}

189 
	$sub_»£rved_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
)

191 
	`©omic_sub
(
blocks
, &
jouº®
->
j_»£rved_üed™s
);

192 
	`wake_up
(&
jouº®
->
j_wa™_»£rved
);

193 
	}
}

201 
	$add_Œª§ùiÚ_üed™s
(
jouº®_t
 *
jouº®
, 
blocks
,

202 
rsv_blocks
)

204 
Œª§ùiÚ_t
 *
t
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

205 
Ãeded
;

206 
tÙ®
 = 
blocks
 + 
rsv_blocks
;

212 ià(
t
->
t_¡©e
 !ğ
T_RUNNING
) {

213 
	`WARN_ON_ONCE
(
t
->
t_¡©e
 >ğ
T_FLUSH
);

214 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

223 
Ãeded
 = 
	`©omic_add_»tuº
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

224 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

230 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

236 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 >

237 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

238 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

239 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

240 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

241 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
tÙ®
 <=

242 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

246 
	`wa™_Œª§ùiÚ_locked
(
jouº®
);

261 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
	`jbd3_¥aû_Ãeded
(journal)) {

262 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

263 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

264 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

265 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

266 ià(
	`jbd3_log_¥aû_Ëá
(
jouº®
è< 
	`jbd3_¥aû_Ãeded
(journal))

267 
	`__jbd3_log_wa™_fÜ_¥aû
(
jouº®
);

268 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

273 ià(!
rsv_blocks
)

276 
Ãeded
 = 
	`©omic_add_»tuº
(
rsv_blocks
, &
jouº®
->
j_»£rved_üed™s
);

278 ià(
Ãeded
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) {

279 
	`sub_»£rved_üed™s
(
jouº®
, 
rsv_blocks
);

280 
	`©omic_sub
(
tÙ®
, &
t
->
t_out¡ªdšg_üed™s
);

281 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

282 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

283 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

284 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
è+ 
rsv_blocks


285 <ğ
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2);

289 
	}
}

298 
	$¡¬t_this_hªdË
(
jouº®_t
 *
jouº®
, 
hªdË_t
 *
hªdË
,

299 
gå_t
 
gå_mask
)

301 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, *
Ãw_Œª§ùiÚ
 = 
NULL
;

302 
blocks
 = 
hªdË
->
h_bufãr_üed™s
;

303 
rsv_blocks
 = 0;

304 
ts
 = 
jiff›s
;

306 ià(
hªdË
->
h_rsv_hªdË
)

307 
rsv_blocks
 = 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
;

314 ià((
rsv_blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
 / 2) ||

315 (
rsv_blocks
 + 
blocks
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
)) {

316 
	`´štk
(
KERN_ERR
 "JBD3: %s wantsoo many credits "

318 
cu¼’t
->
comm
, 
blocks
, 
rsv_blocks
,

319 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
);

320 
	`WARN_ON
(1);

321  -
ENOSPC
;

324 
®loc_Œª§ùiÚ
:

325 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

330 ià((
gå_mask
 & 
__GFP_FS
) == 0)

331 
gå_mask
 |ğ
__GFP_NOFAIL
;

332 
Ãw_Œª§ùiÚ
 = 
	`kmem_ÿche_z®loc
(
Œª§ùiÚ_ÿche
,

333 
gå_mask
);

334 ià(!
Ãw_Œª§ùiÚ
)

335  -
ENOMEM
;

338 
	`jbd_debug
(3, "New hªdË %°gošg†ive.\n", 
hªdË
);

344 
»³©
:

345 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

346 
	`BUG_ON
(
jouº®
->
j_æags
 & 
JBD3_UNMOUNT
);

347 ià(
	`is_jouº®_abÜ‹d
(
jouº®
) ||

348 (
jouº®
->
j_”ºo
 !ğ0 && !(jouº®->
j_æags
 & 
JBD3_ACK_ERR
))) {

349 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

350 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

351  -
EROFS
;

359 ià(!
hªdË
->
h_»£rved
 && 
jouº®
->
j_b¬r›r_couÁ
) {

360 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

361 
	`wa™_ev’t
(
jouº®
->
j_wa™_Œª§ùiÚ_locked
,

362 
jouº®
->
j_b¬r›r_couÁ
 == 0);

363 
»³©
;

366 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

367 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

368 ià(!
Ãw_Œª§ùiÚ
)

369 
®loc_Œª§ùiÚ
;

370 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

371 ià(!
jouº®
->
j_ruÂšg_Œª§ùiÚ
 &&

372 (
hªdË
->
h_»£rved
 || !
jouº®
->
j_b¬r›r_couÁ
)) {

373 
	`jbd3_g‘_Œª§ùiÚ
(
jouº®
, 
Ãw_Œª§ùiÚ
);

374 
Ãw_Œª§ùiÚ
 = 
NULL
;

376 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

377 
»³©
;

380 
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

382 ià(!
hªdË
->
h_»£rved
) {

384 ià(
	`add_Œª§ùiÚ_üed™s
(
jouº®
, 
blocks
, 
rsv_blocks
))

385 
»³©
;

394 ià(
Œª§ùiÚ
->
t_¡©e
 =ğ
T_SWITCH
) {

395 
	`wa™_Œª§ùiÚ_sw™chšg
(
jouº®
);

396 
»³©
;

398 
	`sub_»£rved_üed™s
(
jouº®
, 
blocks
);

399 
hªdË
->
h_»£rved
 = 0;

405 
	`upd©e_t_max_wa™
(
Œª§ùiÚ
, 
ts
);

406 
hªdË
->
h_Œª§ùiÚ
 = 
Œª§ùiÚ
;

407 
hªdË
->
h_»que¡ed_üed™s
 = 
blocks
;

408 
hªdË
->
h_¡¬t_jiff›s
 = 
jiff›s
;

409 
	`©omic_šc
(&
Œª§ùiÚ
->
t_upd©es
);

410 
	`©omic_šc
(&
Œª§ùiÚ
->
t_hªdË_couÁ
);

411 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

412 
hªdË
, 
blocks
,

413 
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
),

414 
	`jbd3_log_¥aû_Ëá
(
jouº®
));

415 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

416 
cu¼’t
->
jouº®_šfo
 = 
hªdË
;

418 
	`rw£m_acquœe_»ad
(&
jouº®
->
j_Œªs_comm™_m­
, 0, 0, 
_THIS_IP_
);

419 
	`jbd3_jouº®_ä“_Œª§ùiÚ
(
Ãw_Œª§ùiÚ
);

424 
hªdË
->
§ved_®loc_cÚ‹xt
 = 
	`mem®loc_nofs_§ve
();

426 
	}
}

429 
hªdË_t
 *
	$Ãw_hªdË
(
nblocks
)

431 
hªdË_t
 *
hªdË
 = 
	`jbd3_®loc_hªdË
(
GFP_NOFS
);

432 ià(!
hªdË
)

433  
NULL
;

434 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

435 
hªdË
->
h_»f
 = 1;

437  
hªdË
;

438 
	}
}

440 
hªdË_t
 *
	$jbd3__jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
, 
rsv_blocks
,

441 
gå_t
 
gå_mask
, 
ty³
,

442 
lše_no
)

444 
hªdË_t
 *
hªdË
 = 
	`jouº®_cu¼’t_hªdË
();

445 
”r
;

447 ià(!
jouº®
)

448  
	`ERR_PTR
(-
EROFS
);

450 ià(
hªdË
) {

451 
	`J_ASSERT
(
hªdË
->
h_Œª§ùiÚ
->
t_jouº®
 =ğ
jouº®
);

452 
hªdË
->
h_»f
++;

453  
hªdË
;

456 
hªdË
 = 
	`Ãw_hªdË
(
nblocks
);

457 ià(!
hªdË
)

458  
	`ERR_PTR
(-
ENOMEM
);

459 ià(
rsv_blocks
) {

460 
hªdË_t
 *
rsv_hªdË
;

462 
rsv_hªdË
 = 
	`Ãw_hªdË
(
rsv_blocks
);

463 ià(!
rsv_hªdË
) {

464 
	`jbd3_ä“_hªdË
(
hªdË
);

465  
	`ERR_PTR
(-
ENOMEM
);

467 
rsv_hªdË
->
h_»£rved
 = 1;

468 
rsv_hªdË
->
h_jouº®
 = 
jouº®
;

469 
hªdË
->
h_rsv_hªdË
 = 
rsv_hªdË
;

472 
”r
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

473 ià(
”r
 < 0) {

474 ià(
hªdË
->
h_rsv_hªdË
)

475 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

476 
	`jbd3_ä“_hªdË
(
hªdË
);

477  
	`ERR_PTR
(
”r
);

479 
hªdË
->
h_ty³
 = 
ty³
;

480 
hªdË
->
h_lše_no
 = 
lše_no
;

481 
	`Œaû_jbd3_hªdË_¡¬t
(
jouº®
->
j_fs_dev
->
bd_dev
,

482 
hªdË
->
h_Œª§ùiÚ
->
t_tid
, 
ty³
,

483 
lše_no
, 
nblocks
);

485  
hªdË
;

486 
	}
}

487 
EXPORT_SYMBOL
(
jbd3__jouº®_¡¬t
);

509 
hªdË_t
 *
	$jbd3_jouº®_¡¬t
(
jouº®_t
 *
jouº®
, 
nblocks
)

511  
	`jbd3__jouº®_¡¬t
(
jouº®
, 
nblocks
, 0, 
GFP_NOFS
, 0, 0);

512 
	}
}

513 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t
);

515 
	$jbd3_jouº®_ä“_»£rved
(
hªdË_t
 *
hªdË
)

517 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

519 
	`WARN_ON
(!
hªdË
->
h_»£rved
);

520 
	`sub_»£rved_üed™s
(
jouº®
, 
hªdË
->
h_bufãr_üed™s
);

521 
	`jbd3_ä“_hªdË
(
hªdË
);

522 
	}
}

523 
EXPORT_SYMBOL
(
jbd3_jouº®_ä“_»£rved
);

539 
	$jbd3_jouº®_¡¬t_»£rved
(
hªdË_t
 *
hªdË
, 
ty³
,

540 
lše_no
)

542 
jouº®_t
 *
jouº®
 = 
hªdË
->
h_jouº®
;

543 
»t
 = -
EIO
;

545 ià(
	`WARN_ON
(!
hªdË
->
h_»£rved
)) {

547 
	`jbd3_jouº®_¡İ
(
hªdË
);

548  
»t
;

554 ià(
	`WARN_ON
(
cu¼’t
->
jouº®_šfo
)) {

555 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

556  
»t
;

559 
hªdË
->
h_jouº®
 = 
NULL
;

564 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
GFP_NOFS
);

565 ià(
»t
 < 0) {

566 
hªdË
->
h_jouº®
 = 
jouº®
;

567 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
);

568  
»t
;

570 
hªdË
->
h_ty³
 = 
ty³
;

571 
hªdË
->
h_lše_no
 = 
lše_no
;

573 
	}
}

574 
EXPORT_SYMBOL
(
jbd3_jouº®_¡¬t_»£rved
);

596 
	$jbd3_jouº®_ex‹nd
(
hªdË_t
 *
hªdË
, 
nblocks
)

598 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

599 
jouº®_t
 *
jouº®
;

600 
»suÉ
;

601 
wª‹d
;

603 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

604  -
EROFS
;

605 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

607 
»suÉ
 = 1;

609 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

612 ià(
Œª§ùiÚ
->
t_¡©e
 !ğ
T_RUNNING
) {

613 
	`jbd_debug
(3, "denied handle %p %d blocks: "

614 "Œª§ùiÚ‚Ù„uÂšg\n", 
hªdË
, 
nblocks
);

615 
”rÜ_out
;

618 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

619 
wª‹d
 = 
	`©omic_add_»tuº
(
nblocks
,

620 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

622 ià(
wª‹d
 > 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) {

623 
	`jbd_debug
(3, "denied handle %p %d blocks: "

624 "Œª§ùiÚoØÏrge\n", 
hªdË
, 
nblocks
);

625 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

626 
uÆock
;

629 ià(
wª‹d
 + (wª‹d >> 
JBD3_CONTROL_BLOCKS_SHIFT
) >

630 
	`jbd3_log_¥aû_Ëá
(
jouº®
)) {

631 
	`jbd_debug
(3, "denied handle %p %d blocks: "

632 "šsuffic›Á†og s·û\n", 
hªdË
, 
nblocks
);

633 
	`©omic_sub
(
nblocks
, &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

634 
uÆock
;

637 
	`Œaû_jbd3_hªdË_ex‹nd
(
jouº®
->
j_fs_dev
->
bd_dev
,

638 
Œª§ùiÚ
->
t_tid
,

639 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

640 
hªdË
->
h_bufãr_üed™s
,

641 
nblocks
);

643 
hªdË
->
h_bufãr_üed™s
 +ğ
nblocks
;

644 
hªdË
->
h_»que¡ed_üed™s
 +ğ
nblocks
;

645 
»suÉ
 = 0;

647 
	`jbd_debug
(3, "ex‹nded hªdË %°by %d\n", 
hªdË
, 
nblocks
);

648 
uÆock
:

649 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

650 
”rÜ_out
:

651 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

652  
»suÉ
;

653 
	}
}

672 
	$jbd3__jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
, 
gå_t
 
gå_mask
)

674 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

675 
jouº®_t
 *
jouº®
;

676 
tid_t
 
tid
;

677 
Ãed_to_¡¬t
, 
»t
;

681 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

683 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

689 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

690 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

692 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

693 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

694 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

695 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

696 ià(
hªdË
->
h_rsv_hªdË
) {

697 
	`sub_»£rved_üed™s
(
jouº®
,

698 
hªdË
->
h_rsv_hªdË
->
h_bufãr_üed™s
);

700 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
))

701 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

702 
tid
 = 
Œª§ùiÚ
->
t_tid
;

703 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

704 
hªdË
->
h_Œª§ùiÚ
 = 
NULL
;

705 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

707 
	`jbd_debug
(2, "»¡¬tšg hªdË %p\n", 
hªdË
);

708 
Ãed_to_¡¬t
 = !
	`tid_geq
(
jouº®
->
j_comm™_»que¡
, 
tid
);

709 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

710 ià(
Ãed_to_¡¬t
)

711 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
tid
);

713 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

714 
hªdË
->
h_bufãr_üed™s
 = 
nblocks
;

720 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

721 
»t
 = 
	`¡¬t_this_hªdË
(
jouº®
, 
hªdË
, 
gå_mask
);

722  
»t
;

723 
	}
}

724 
EXPORT_SYMBOL
(
jbd3__jouº®_»¡¬t
);

727 
	$jbd3_jouº®_»¡¬t
(
hªdË_t
 *
hªdË
, 
nblocks
)

729  
	`jbd3__jouº®_»¡¬t
(
hªdË
, 
nblocks
, 
GFP_NOFS
);

730 
	}
}

731 
EXPORT_SYMBOL
(
jbd3_jouº®_»¡¬t
);

743 
	$jbd3_jouº®_lock_upd©es
(
jouº®_t
 *
jouº®
)

745 
	`DEFINE_WAIT
(
wa™
);

747 
	`jbd3_might_wa™_fÜ_comm™
(
jouº®
);

749 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

750 ++
jouº®
->
j_b¬r›r_couÁ
;

753 ià(
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
)) {

754 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

755 
	`wa™_ev’t
(
jouº®
->
j_wa™_»£rved
,

756 
	`©omic_»ad
(&
jouº®
->
j_»£rved_üed™s
) == 0);

757 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

762 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

764 ià(!
Œª§ùiÚ
)

767 
	`¥š_lock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

768 
	`´•¬e_to_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
,

769 
TASK_UNINTERRUPTIBLE
);

770 ià(!
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
)) {

771 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

772 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

775 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_hªdË_lock
);

776 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

777 
	`scheduË
();

778 
	`fšish_wa™
(&
jouº®
->
j_wa™_upd©es
, &
wa™
);

779 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

781 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

789 
	`mu‹x_lock
(&
jouº®
->
j_b¬r›r
);

790 
	}
}

800 
	$jbd3_jouº®_uÆock_upd©es
 (
jouº®_t
 *
jouº®
)

802 
	`J_ASSERT
(
jouº®
->
j_b¬r›r_couÁ
 != 0);

804 
	`mu‹x_uÆock
(&
jouº®
->
j_b¬r›r
);

805 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

806 --
jouº®
->
j_b¬r›r_couÁ
;

807 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

808 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

809 
	}
}

811 
	$w¬n_dœty_bufãr
(
bufãr_h—d
 *
bh
)

813 
	`´štk
(
KERN_WARNING


817 
bh
->
b_bdev
, ()bh->
b_blockÄ
);

818 
	}
}

821 
	$jbd3_ä“ze_jh_d©a
(
jouº®_h—d
 *
jh
)

823 
·ge
 *page;

824 
off£t
;

825 *
sourû
;

826 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

828 
	`J_EXPECT_JH
(
jh
, 
	`bufãr_u±od©e
(
bh
), "Possible IO failure.\n");

829 
·ge
 = 
bh
->
b_·ge
;

830 
off£t
 = 
	`off£t_š_·ge
(
bh
->
b_d©a
);

831 
sourû
 = 
	`km­_©omic
(
·ge
);

833 
	`jbd3_bufãr_äoz’_Œigg”
(
jh
, 
sourû
 + 
off£t
, jh->
b_Œigg”s
);

834 
	`memıy
(
jh
->
b_äoz’_d©a
, 
sourû
 + 
off£t
, 
bh
->
b_size
);

835 
	`kunm­_©omic
(
sourû
);

841 
jh
->
b_äoz’_Œigg”s
 = jh->
b_Œigg”s
;

842 
	}
}

855 
	$do_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
jouº®_h—d
 *
jh
,

856 
fÜû_cİy
)

858 
bufãr_h—d
 *
bh
;

859 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

860 
jouº®_t
 *
jouº®
;

861 
”rÜ
;

862 *
äoz’_bufãr
 = 
NULL
;

863 
¡¬t_lock
, 
time_lock
;

865 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

866  -
EROFS
;

867 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

869 
	`jbd_debug
(5, "jouº®_h—d %p, fÜû_cİy %d\n", 
jh
, 
fÜû_cİy
);

871 
	`JBUFFER_TRACE
(
jh
, "entry");

872 
»³©
:

873 
bh
 = 
	`jh2bh
(
jh
);

877 
¡¬t_lock
 = 
jiff›s
;

878 
	`lock_bufãr
(
bh
);

879 
	`jbd_lock_bh_¡©e
(
bh
);

882 
time_lock
 = 
	`jbd3_time_diff
(
¡¬t_lock
, 
jiff›s
);

883 ià(
time_lock
 > 
HZ
/10)

884 
	`Œaû_jbd3_lock_bufãr_¡®l
(
bh
->
b_bdev
->
bd_dev
,

885 
	`jiff›s_to_m£cs
(
time_lock
));

900 ià(
	`bufãr_dœty
(
bh
)) {

905 ià(
jh
->
b_Œª§ùiÚ
) {

906 
	`J_ASSERT_JH
(
jh
,

907 
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

908 
jh
->
b_Œª§ùiÚ
 ==

909 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

910 ià(
jh
->
b_Ãxt_Œª§ùiÚ
)

911 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 ==

912 
Œª§ùiÚ
);

913 
	`w¬n_dœty_bufãr
(
bh
);

920 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

921 
	`ş—r_bufãr_dœty
(
bh
);

922 
	`£t_bufãr_jbddœty
(
bh
);

925 
	`uÆock_bufãr
(
bh
);

927 
”rÜ
 = -
EROFS
;

928 ià(
	`is_hªdË_abÜ‹d
(
hªdË
)) {

929 
	`jbd_uÆock_bh_¡©e
(
bh
);

930 
out
;

932 
”rÜ
 = 0;

938 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

939 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

940 
dÚe
;

946 
jh
->
b_modif›d
 = 0;

953 ià(!
jh
->
b_Œª§ùiÚ
) {

954 
	`JBUFFER_TRACE
(
jh
, "noransaction");

955 
	`J_ASSERT_JH
(
jh
, !jh->
b_Ãxt_Œª§ùiÚ
);

956 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

962 
	`smp_wmb
();

963 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

964 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

965 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

966 
dÚe
;

972 ià(
jh
->
b_äoz’_d©a
) {

973 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

974 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

975 
©ch_Ãxt
;

978 
	`JBUFFER_TRACE
(
jh
, "owned by olderransaction");

979 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

980 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

991 ià(
	`bufãr_shadow
(
bh
)) {

992 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

993 
	`jbd_uÆock_bh_¡©e
(
bh
);

994 
	`wa™_Ú_b™_io
(&
bh
->
b_¡©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

995 
»³©
;

1010 ià(
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
 || 
fÜû_cİy
) {

1011 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1012 ià(!
äoz’_bufãr
) {

1013 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1014 
	`jbd_uÆock_bh_¡©e
(
bh
);

1015 
äoz’_bufãr
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1016 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1017 
»³©
;

1019 
jh
->
b_äoz’_d©a
 = 
äoz’_bufãr
;

1020 
äoz’_bufãr
 = 
NULL
;

1021 
	`jbd3_ä“ze_jh_d©a
(
jh
);

1023 
©ch_Ãxt
:

1029 
	`smp_wmb
();

1030 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1032 
dÚe
:

1033 
	`jbd_uÆock_bh_¡©e
(
bh
);

1039 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1041 
out
:

1042 ià(
	`uÆik–y
(
äoz’_bufãr
))

1043 
	`jbd3_ä“
(
äoz’_bufãr
, 
bh
->
b_size
);

1045 
	`JBUFFER_TRACE
(
jh
, "exit");

1046  
”rÜ
;

1047 
	}
}

1050 
boŞ
 
	$jbd3_wr™e_acûss_g¿Áed
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
,

1051 
boŞ
 
undo
)

1053 
jouº®_h—d
 *
jh
;

1054 
boŞ
 
»t
 = 
çl£
;

1057 ià(
	`bufãr_dœty
(
bh
))

1058  
çl£
;

1071 
	`rcu_»ad_lock
();

1072 ià(!
	`bufãr_jbd
(
bh
))

1073 
out
;

1075 
jh
 = 
	`READ_ONCE
(
bh
->
b_´iv©e
);

1076 ià(!
jh
)

1077 
out
;

1079 ià(
undo
 && !
jh
->
b_comm™‹d_d©a
)

1080 
out
;

1081 ià(
jh
->
b_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
 &&

1082 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
hªdË
->
h_Œª§ùiÚ
)

1083 
out
;

1093 
	`smp_mb
();

1094 ià(
	`uÆik–y
(
jh
->
b_bh
 !ğ
bh
))

1095 
out
;

1096 
»t
 = 
Œue
;

1097 
out
:

1098 
	`rcu_»ad_uÆock
();

1099  
»t
;

1100 
	}
}

1113 
	$jbd3_jouº®_g‘_wr™e_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1115 
jouº®_h—d
 *
jh
;

1116 
rc
;

1118 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
çl£
))

1121 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1125 
rc
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 0);

1126 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1127  
rc
;

1128 
	}
}

1150 
	$jbd3_jouº®_g‘_ü—‹_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1152 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1153 
jouº®_t
 *
jouº®
;

1154 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1155 
”r
;

1157 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1158 
”r
 = -
EROFS
;

1159 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1160 
out
;

1161 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1162 
”r
 = 0;

1164 
	`JBUFFER_TRACE
(
jh
, "entry");

1172 
	`jbd_lock_bh_¡©e
(
bh
);

1173 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1174 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
 ||

1175 (
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
 &&

1176 
jh
->
b_jli¡
 =ğ
BJ_FÜg‘
)));

1178 
	`J_ASSERT_JH
(
jh
, jh->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

1179 
	`J_ASSERT_JH
(
jh
, 
	`bufãr_locked
(
	`jh2bh
(jh)));

1181 ià(
jh
->
b_Œª§ùiÚ
 =ğ
NULL
) {

1190 
	`ş—r_bufãr_dœty
(
	`jh2bh
(
jh
));

1192 
jh
->
b_modif›d
 = 0;

1194 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Reserved");

1195 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1196 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_Re£rved
);

1197 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1198 } ià(
jh
->
b_Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

1200 
jh
->
b_modif›d
 = 0;

1202 
	`JBUFFER_TRACE
(
jh
, "set‚extransaction");

1203 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1204 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1205 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1207 
	`jbd_uÆock_bh_¡©e
(
bh
);

1216 
	`JBUFFER_TRACE
(
jh
, "cancelling„evoke");

1217 
	`jbd3_jouº®_ÿnûl_»voke
(
hªdË
, 
jh
);

1218 
out
:

1219 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1220  
”r
;

1221 
	}
}

1249 
	$jbd3_jouº®_g‘_undo_acûss
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1251 
”r
;

1252 
jouº®_h—d
 *
jh
;

1253 *
comm™‹d_d©a
 = 
NULL
;

1255 ià(
	`jbd3_wr™e_acûss_g¿Áed
(
hªdË
, 
bh
, 
Œue
))

1258 
jh
 = 
	`jbd3_jouº®_add_jouº®_h—d
(
bh
);

1259 
	`JBUFFER_TRACE
(
jh
, "entry");

1266 
”r
 = 
	`do_g‘_wr™e_acûss
(
hªdË
, 
jh
, 1);

1267 ià(
”r
)

1268 
out
;

1270 
»³©
:

1271 ià(!
jh
->
b_comm™‹d_d©a
)

1272 
comm™‹d_d©a
 = 
	`jbd3_®loc
(
	`jh2bh
(
jh
)->
b_size
,

1273 
GFP_NOFS
|
__GFP_NOFAIL
);

1275 
	`jbd_lock_bh_¡©e
(
bh
);

1276 ià(!
jh
->
b_comm™‹d_d©a
) {

1279 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1280 ià(!
comm™‹d_d©a
) {

1281 
	`jbd_uÆock_bh_¡©e
(
bh
);

1282 
»³©
;

1285 
jh
->
b_comm™‹d_d©a
 = 
comm™‹d_d©a
;

1286 
comm™‹d_d©a
 = 
NULL
;

1287 
	`memıy
(
jh
->
b_comm™‹d_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1289 
	`jbd_uÆock_bh_¡©e
(
bh
);

1290 
out
:

1291 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1292 ià(
	`uÆik–y
(
comm™‹d_d©a
))

1293 
	`jbd3_ä“
(
comm™‹d_d©a
, 
bh
->
b_size
);

1294  
”r
;

1295 
	}
}

1308 
	$jbd3_jouº®_£t_Œigg”s
(
bufãr_h—d
 *
bh
,

1309 
jbd3_bufãr_Œigg”_ty³
 *
ty³
)

1311 
jouº®_h—d
 *
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

1313 ià(
	`WARN_ON
(!
jh
))

1315 
jh
->
b_Œigg”s
 = 
ty³
;

1316 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1317 
	}
}

1319 
	$jbd3_bufãr_äoz’_Œigg”
(
jouº®_h—d
 *
jh
, *
m­³d_d©a
,

1320 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1322 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1324 ià(!
Œigg”s
 || !Œigg”s->
t_äoz’
)

1327 
Œigg”s
->
	`t_äoz’
Ñrigg”s, 
bh
, 
m­³d_d©a
, bh->
b_size
);

1328 
	}
}

1330 
	$jbd3_bufãr_abÜt_Œigg”
(
jouº®_h—d
 *
jh
,

1331 
jbd3_bufãr_Œigg”_ty³
 *
Œigg”s
)

1333 ià(!
Œigg”s
 || !Œigg”s->
t_abÜt
)

1336 
Œigg”s
->
	`t_abÜt
Ñrigg”s, 
	`jh2bh
(
jh
));

1337 
	}
}

1362 
	$jbd3_jouº®_dœty_m‘ad©a
(
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1364 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1365 
jouº®_t
 *
jouº®
;

1366 
jouº®_h—d
 *
jh
;

1367 
»t
 = 0;

1369 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1370  -
EROFS
;

1371 ià(!
	`bufãr_jbd
(
bh
))

1372  -
EUCLEAN
;

1378 
jh
 = 
	`bh2jh
(
bh
);

1379 
	`jbd_debug
(5, "jouº®_h—d %p\n", 
jh
);

1380 
	`JBUFFER_TRACE
(
jh
, "entry");

1388 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 &&

1389 
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1390 
	`jbd_lock_bh_¡©e
(
bh
);

1391 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

1392 
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1393 
	`jbd_uÆock_bh_¡©e
(
bh
);

1395 ià(
jh
->
b_modif›d
 == 1) {

1397 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1398 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
) {

1399 
	`jbd_lock_bh_¡©e
(
bh
);

1400 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 &&

1401 
jh
->
b_jli¡
 !ğ
BJ_M‘ad©a
)

1402 
	`´_”r
("JBD3:‡ssertion failure: h_type=%u "

1404 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1405 (è
bh
->
b_blockÄ
,

1406 
jh
->
b_jli¡
);

1407 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
 ||

1408 
jh
->
b_jli¡
 =ğ
BJ_M‘ad©a
);

1409 
	`jbd_uÆock_bh_¡©e
(
bh
);

1411 
out
;

1414 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1415 
	`jbd_lock_bh_¡©e
(
bh
);

1417 ià(
jh
->
b_modif›d
 == 0) {

1423 ià(
hªdË
->
h_bufãr_üed™s
 <= 0) {

1424 
»t
 = -
ENOSPC
;

1425 
out_uÆock_bh
;

1427 
jh
->
b_modif›d
 = 1;

1428 
hªdË
->
h_bufãr_üed™s
--;

1438 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
BJ_M‘ad©a
) {

1439 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1440 ià(
	`uÆik–y
(
jh
->
b_Œª§ùiÚ
 !=

1441 
jouº®
->
j_ruÂšg_Œª§ùiÚ
)) {

1442 
	`´štk
(
KERN_ERR
 "JBD3: %s: "

1445 
jouº®
->
j_devÇme
,

1446 (è
bh
->
b_blockÄ
,

1447 
jh
->
b_Œª§ùiÚ
,

1448 
jh
->
b_Œª§ùiÚ
 ? jh->b_Œª§ùiÚ->
t_tid
 : 0,

1449 
jouº®
->
j_ruÂšg_Œª§ùiÚ
,

1450 
jouº®
->
j_ruÂšg_Œª§ùiÚ
 ?

1451 
jouº®
->
j_ruÂšg_Œª§ùiÚ
->
t_tid
 : 0);

1452 
»t
 = -
EINVAL
;

1454 
out_uÆock_bh
;

1457 
	`£t_bufãr_jbddœty
(
bh
);

1465 ià(
jh
->
b_Œª§ùiÚ
 !ğ
Œª§ùiÚ
) {

1466 
	`JBUFFER_TRACE
(
jh
, "already on otherransaction");

1467 ià(
	`uÆik–y
(((
jh
->
b_Œª§ùiÚ
 !=

1468 
jouº®
->
j_comm™tšg_Œª§ùiÚ
)) ||

1469 (
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
Œª§ùiÚ
))) {

1470 
	`´štk
(
KERN_ERR
 "jbd3_journal_dirty_metadata: %s: "

1475 
jouº®
->
j_devÇme
,

1476 (è
bh
->
b_blockÄ
,

1477 
Œª§ùiÚ
,¿n§ùiÚ->
t_tid
,

1478 
jh
->
b_Œª§ùiÚ
,

1479 
jh
->
b_Œª§ùiÚ
 ?

1480 
jh
->
b_Œª§ùiÚ
->
t_tid
 : 0,

1481 
jh
->
b_Ãxt_Œª§ùiÚ
,

1482 
jh
->
b_Ãxt_Œª§ùiÚ
 ?

1483 
jh
->
b_Ãxt_Œª§ùiÚ
->
t_tid
 : 0,

1484 
jh
->
b_jli¡
);

1485 
	`WARN_ON
(1);

1486 
»t
 = -
EINVAL
;

1490 
out_uÆock_bh
;

1494 
	`J_ASSERT_JH
(
jh
, jh->
b_äoz’_d©a
 =ğ
NULL
);

1496 
	`JBUFFER_TRACE
(
jh
, "file‡s BJ_Metadata");

1497 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1498 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_M‘ad©a
);

1499 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1500 
out_uÆock_bh
:

1501 
	`jbd_uÆock_bh_¡©e
(
bh
);

1502 
out
:

1503 
	`JBUFFER_TRACE
(
jh
, "exit");

1504  
»t
;

1505 
	}
}

1524 
	$jbd3_jouº®_fÜg‘
 (
hªdË_t
 *
hªdË
, 
bufãr_h—d
 *
bh
)

1526 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1527 
jouº®_t
 *
jouº®
;

1528 
jouº®_h—d
 *
jh
;

1529 
drİ_»£rve
 = 0;

1530 
”r
 = 0;

1531 
was_modif›d
 = 0;

1533 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1534  -
EROFS
;

1535 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1537 
	`BUFFER_TRACE
(
bh
, "entry");

1539 
	`jbd_lock_bh_¡©e
(
bh
);

1541 ià(!
	`bufãr_jbd
(
bh
))

1542 
nÙ_jbd
;

1543 
jh
 = 
	`bh2jh
(
bh
);

1547 ià(!
	`J_EXPECT_JH
(
jh
, !jh->
b_comm™‹d_d©a
,

1549 
”r
 = -
EIO
;

1550 
nÙ_jbd
;

1554 
was_modif›d
 = 
jh
->
b_modif›d
;

1560 
jh
->
b_modif›d
 = 0;

1562 ià(
jh
->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
) {

1563 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

1568 
	`ş—r_bufãr_dœty
(
bh
);

1569 
	`ş—r_bufãr_jbddœty
(
bh
);

1571 
	`JBUFFER_TRACE
(
jh
, "belongso currentransaction: unfile");

1577 ià(
was_modif›d
)

1578 
drİ_»£rve
 = 1;

1592 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1593 ià(
jh
->
b_ı_Œª§ùiÚ
) {

1594 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1595 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1597 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

1598 ià(!
	`bufãr_jbd
(
bh
)) {

1599 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1600 
nÙ_jbd
;

1603 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1604 } ià(
jh
->
b_Œª§ùiÚ
) {

1605 
	`J_ASSERT_JH
(
jh
, (jh->
b_Œª§ùiÚ
 ==

1606 
jouº®
->
j_comm™tšg_Œª§ùiÚ
));

1609 
	`JBUFFER_TRACE
(
jh
, "belongso olderransaction");

1617 
	`£t_bufãr_ä“d
(
bh
);

1619 ià(!
jh
->
b_Ãxt_Œª§ùiÚ
) {

1620 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1621 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

1622 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1624 
	`J_ASSERT
(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
);

1630 ià(
was_modif›d
)

1631 
drİ_»£rve
 = 1;

1639 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1640 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

1641 
	`JBUFFER_TRACE
(
jh
, "belongso‚oneransaction");

1642 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1643 
nÙ_jbd
;

1650 ià(!
	`bufãr_dœty
(
bh
)) {

1651 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

1652 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1653 
nÙ_jbd
;

1662 
	`ş—r_bufãr_dœty
(
bh
);

1663 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

1664 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1667 
	`jbd_uÆock_bh_¡©e
(
bh
);

1668 
	`__b»l£
(
bh
);

1669 
drİ
:

1670 ià(
drİ_»£rve
) {

1672 
hªdË
->
h_bufãr_üed™s
++;

1674  
”r
;

1676 
nÙ_jbd
:

1677 
	`jbd_uÆock_bh_¡©e
(
bh
);

1678 
	`__bfÜg‘
(
bh
);

1679 
drİ
;

1680 
	}
}

1698 
	$jbd3_jouº®_¡İ
(
hªdË_t
 *
hªdË
)

1700 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

1701 
jouº®_t
 *
jouº®
;

1702 
”r
 = 0, 
wa™_fÜ_comm™
 = 0;

1703 
tid_t
 
tid
;

1704 
pid_t
 
pid
;

1706 ià(!
Œª§ùiÚ
) {

1712 ià(--
hªdË
->
h_»f
 > 0) {

1713 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1714 
hªdË
->
h_»f
);

1715  
”r
;

1717 ià(
hªdË
->
h_rsv_hªdË
)

1718 
	`jbd3_ä“_hªdË
(
hªdË
->
h_rsv_hªdË
);

1719 
ä“_ªd_ex™
;

1722 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

1724 
	`J_ASSERT
(
	`jouº®_cu¼’t_hªdË
(è=ğ
hªdË
);

1726 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

1727 
”r
 = -
EIO
;

1729 
	`J_ASSERT
(
	`©omic_»ad
(&
Œª§ùiÚ
->
t_upd©es
) > 0);

1731 ià(--
hªdË
->
h_»f
 > 0) {

1732 
	`jbd_debug
(4, "h_»à%d -> %d\n", 
hªdË
->
h_»f
 + 1,

1733 
hªdË
->
h_»f
);

1734  
”r
;

1737 
	`jbd_debug
(4, "HªdË %°gošg down\n", 
hªdË
);

1738 
	`Œaû_jbd3_hªdË_¡©s
(
jouº®
->
j_fs_dev
->
bd_dev
,

1739 
Œª§ùiÚ
->
t_tid
,

1740 
hªdË
->
h_ty³
, hªdË->
h_lše_no
,

1741 
jiff›s
 - 
hªdË
->
h_¡¬t_jiff›s
,

1742 
hªdË
->
h_sync
, hªdË->
h_»que¡ed_üed™s
,

1743 (
hªdË
->
h_»que¡ed_üed™s
 -

1744 
hªdË
->
h_bufãr_üed™s
));

1775 
pid
 = 
cu¼’t
->pid;

1776 ià(
hªdË
->
h_sync
 && 
jouº®
->
j_Ï¡_sync_wr™”
 !ğ
pid
 &&

1777 
jouº®
->
j_max_b©ch_time
) {

1778 
u64
 
comm™_time
, 
Œªs_time
;

1780 
jouº®
->
j_Ï¡_sync_wr™”
 = 
pid
;

1782 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

1783 
comm™_time
 = 
jouº®
->
j_av”age_comm™_time
;

1784 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

1786 
Œªs_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(),

1787 
Œª§ùiÚ
->
t_¡¬t_time
));

1789 
comm™_time
 = 
	`max_t
(
u64
, commit_time,

1790 1000*
jouº®
->
j_mš_b©ch_time
);

1791 
comm™_time
 = 
	`mš_t
(
u64
, commit_time,

1792 1000*
jouº®
->
j_max_b©ch_time
);

1794 ià(
Œªs_time
 < 
comm™_time
) {

1795 
ktime_t
 
expœes
 = 
	`ktime_add_ns
(
	`ktime_g‘
(),

1796 
comm™_time
);

1797 
	`£t_cu¼’t_¡©e
(
TASK_UNINTERRUPTIBLE
);

1798 
	`scheduË_h¹imeout
(&
expœes
, 
HRTIMER_MODE_ABS
);

1802 ià(
hªdË
->
h_sync
)

1803 
Œª§ùiÚ
->
t_synchrÚous_comm™
 = 1;

1804 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1805 
	`©omic_sub
(
hªdË
->
h_bufãr_üed™s
,

1806 &
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
);

1814 ià(
hªdË
->
h_sync
 ||

1815 (
	`©omic_»ad
(&
Œª§ùiÚ
->
t_out¡ªdšg_üed™s
) >

1816 
jouº®
->
j_max_Œª§ùiÚ_bufãrs
) ||

1817 
	`time_aá”_eq
(
jiff›s
, 
Œª§ùiÚ
->
t_expœes
)) {

1822 
	`jbd_debug
(2, "transactionoo old,„equesting commit for "

1823 "hªdË %p\n", 
hªdË
);

1825 
	`jbd3_log_¡¬t_comm™
(
jouº®
, 
Œª§ùiÚ
->
t_tid
);

1831 ià(
hªdË
->
h_sync
 && !(
cu¼’t
->
æags
 & 
PF_MEMALLOC
))

1832 
wa™_fÜ_comm™
 = 1;

1841 
tid
 = 
Œª§ùiÚ
->
t_tid
;

1842 ià(
	`©omic_dec_ªd_‹¡
(&
Œª§ùiÚ
->
t_upd©es
)) {

1843 
	`wake_up
(&
jouº®
->
j_wa™_upd©es
);

1844 ià(
jouº®
->
j_b¬r›r_couÁ
)

1845 
	`wake_up
(&
jouº®
->
j_wa™_Œª§ùiÚ_locked
);

1848 
	`rw£m_»Ëa£
(&
jouº®
->
j_Œªs_comm™_m­
, 1, 
_THIS_IP_
);

1850 ià(
wa™_fÜ_comm™
)

1851 
”r
 = 
	`jbd3_log_wa™_comm™
(
jouº®
, 
tid
);

1853 ià(
hªdË
->
h_rsv_hªdË
)

1854 
	`jbd3_jouº®_ä“_»£rved
(
hªdË
->
h_rsv_hªdË
);

1855 
ä“_ªd_ex™
:

1860 
	`mem®loc_nofs_»¡Üe
(
hªdË
->
§ved_®loc_cÚ‹xt
);

1861 
	`jbd3_ä“_hªdË
(
hªdË
);

1862  
”r
;

1863 
	}
}

1881 
šlše
 

1882 
	$__bli¡_add_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1884 ià(!*
li¡
) {

1885 
jh
->
b_Šext
 = jh->
b_»v
 = jh;

1886 *
li¡
 = 
jh
;

1889 
jouº®_h—d
 *
fœ¡
 = *
li¡
, *
Ï¡
 = fœ¡->
b_»v
;

1890 
jh
->
b_»v
 = 
Ï¡
;

1891 
jh
->
b_Šext
 = 
fœ¡
;

1892 
Ï¡
->
b_Šext
 = 
fœ¡
->
b_»v
 = 
jh
;

1894 
	}
}

1905 
šlše
 

1906 
	$__bli¡_d–_bufãr
(
jouº®_h—d
 **
li¡
, jouº®_h—d *
jh
)

1908 ià(*
li¡
 =ğ
jh
) {

1909 *
li¡
 = 
jh
->
b_Šext
;

1910 ià(*
li¡
 =ğ
jh
)

1911 *
li¡
 = 
NULL
;

1913 
jh
->
b_»v
->
b_Šext
 = jh->b_tnext;

1914 
jh
->
b_Šext
->
b_»v
 = jh->b_tprev;

1915 
	}
}

1928 
	$__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jouº®_h—d
 *
jh
)

1930 
jouº®_h—d
 **
li¡
 = 
NULL
;

1931 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

1932 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1934 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

1935 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

1936 ià(
Œª§ùiÚ
)

1937 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

1939 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

1940 ià(
jh
->
b_jli¡
 !ğ
BJ_NÚe
)

1941 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 !ğ
NULL
);

1943 
jh
->
b_jli¡
) {

1944 
BJ_NÚe
:

1946 
BJ_M‘ad©a
:

1947 
Œª§ùiÚ
->
t_Ä_bufãrs
--;

1948 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
->
t_Ä_bufãrs
 >= 0);

1949 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

1951 
BJ_FÜg‘
:

1952 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

1954 
BJ_Shadow
:

1955 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

1957 
BJ_Re£rved
:

1958 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

1962 
	`__bli¡_d–_bufãr
(
li¡
, 
jh
);

1963 
jh
->
b_jli¡
 = 
BJ_NÚe
;

1964 ià(
Œª§ùiÚ
 && 
	`is_jouº®_abÜ‹d
Ñ¿n§ùiÚ->
t_jouº®
))

1965 
	`ş—r_bufãr_jbddœty
(
bh
);

1966 ià(
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

1967 
	`m¬k_bufãr_dœty
(
bh
);

1968 
	}
}

1977 
	$__jbd3_jouº®_unfe_bufãr
(
jouº®_h—d
 *
jh
)

1979 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

1980 
jh
->
b_Œª§ùiÚ
 = 
NULL
;

1981 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

1982 
	}
}

1984 
	$jbd3_jouº®_unfe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

1986 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

1989 
	`g‘_bh
(
bh
);

1990 
	`jbd_lock_bh_¡©e
(
bh
);

1991 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

1992 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

1993 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

1994 
	`jbd_uÆock_bh_¡©e
(
bh
);

1995 
	`__b»l£
(
bh
);

1996 
	}
}

2004 
	$__jouº®_Œy_to_ä“_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
)

2006 
jouº®_h—d
 *
jh
;

2008 
jh
 = 
	`bh2jh
(
bh
);

2010 ià(
	`bufãr_locked
(
bh
è|| 
	`bufãr_dœty
(bh))

2011 
out
;

2013 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 !ğ
NULL
 || jh->
b_Œª§ùiÚ
 != NULL)

2014 
out
;

2016 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2017 ià(
jh
->
b_ı_Œª§ùiÚ
 !ğ
NULL
) {

2019 
	`JBUFFER_TRACE
(
jh
, "remove from checkpoint†ist");

2020 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2022 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2023 
out
:

2025 
	}
}

2065 
	$jbd3_jouº®_Œy_to_ä“_bufãrs
(
jouº®_t
 *
jouº®
,

2066 
·ge
 *·ge, 
gå_t
 
gå_mask
)

2068 
bufãr_h—d
 *
h—d
;

2069 
bufãr_h—d
 *
bh
;

2070 
»t
 = 0;

2072 
	`J_ASSERT
(
	`PageLocked
(
·ge
));

2074 
h—d
 = 
	`·ge_bufãrs
(
·ge
);

2075 
bh
 = 
h—d
;

2077 
jouº®_h—d
 *
jh
;

2084 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2085 ià(!
jh
)

2088 
	`jbd_lock_bh_¡©e
(
bh
);

2089 
	`__jouº®_Œy_to_ä“_bufãr
(
jouº®
, 
bh
);

2090 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2091 
	`jbd_uÆock_bh_¡©e
(
bh
);

2092 ià(
	`bufãr_jbd
(
bh
))

2093 
busy
;

2094 } (
bh
 = bh->
b_this_·ge
è!ğ
h—d
);

2096 
»t
 = 
	`Œy_to_ä“_bufãrs
(
·ge
);

2098 
busy
:

2099  
»t
;

2100 
	}
}

2114 
	$__di¥o£_bufãr
(
jouº®_h—d
 *
jh
, 
Œª§ùiÚ_t
 *
Œª§ùiÚ
)

2116 
may_ä“
 = 1;

2117 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2119 ià(
jh
->
b_ı_Œª§ùiÚ
) {

2120 
	`JBUFFER_TRACE
(
jh
, "on„unning+cpransaction");

2121 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2127 
	`ş—r_bufãr_dœty
(
bh
);

2128 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
BJ_FÜg‘
);

2129 
may_ä“
 = 0;

2131 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2132 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2134  
may_ä“
;

2135 
	}
}

2184 
	$jouº®_unm­_bufãr
(
jouº®_t
 *
jouº®
, 
bufãr_h—d
 *
bh
,

2185 
·¹Ÿl_·ge
)

2187 
Œª§ùiÚ_t
 *
Œª§ùiÚ
;

2188 
jouº®_h—d
 *
jh
;

2189 
may_ä“
 = 1;

2191 
	`BUFFER_TRACE
(
bh
, "entry");

2199 ià(!
	`bufãr_jbd
(
bh
))

2200 
z­_bufãr_uÆocked
;

2203 
	`wr™e_lock
(&
jouº®
->
j_¡©e_lock
);

2204 
	`jbd_lock_bh_¡©e
(
bh
);

2205 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2207 
jh
 = 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2208 ià(!
jh
)

2209 
z­_bufãr_no_jh
;

2234 
Œª§ùiÚ
 = 
jh
->
b_Œª§ùiÚ
;

2235 ià(
Œª§ùiÚ
 =ğ
NULL
) {

2240 ià(!
jh
->
b_ı_Œª§ùiÚ
) {

2241 
	`JBUFFER_TRACE
(
jh
, "not on‡nyransaction: zap");

2242 
z­_bufãr
;

2245 ià(!
	`bufãr_dœty
(
bh
)) {

2247 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2248 
z­_bufãr
;

2255 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
) {

2259 
	`JBUFFER_TRACE
(
jh
, "checkpointed:‡ddo BJ_Forget");

2260 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2261 
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2262 
z­_bufãr
;

2268 ià(
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2269 
	`JBUFFER_TRACE
(
jh
, "giveo committingrans");

2270 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
,

2271 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2272 
z­_bufãr
;

2276 
	`ş—r_bufãr_jbddœty
(
bh
);

2277 
	`__jbd3_jouº®_»move_checkpošt
(
jh
);

2278 
z­_bufãr
;

2281 } ià(
Œª§ùiÚ
 =ğ
jouº®
->
j_comm™tšg_Œª§ùiÚ
) {

2282 
	`JBUFFER_TRACE
(
jh
, "on committingransaction");

2288 ià(
·¹Ÿl_·ge
) {

2289 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2290 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2291 
	`jbd_uÆock_bh_¡©e
(
bh
);

2292 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2293  -
EBUSY
;

2301 
	`£t_bufãr_ä“d
(
bh
);

2302 ià(
jouº®
->
j_ruÂšg_Œª§ùiÚ
 && 
	`bufãr_jbddœty
(
bh
))

2303 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
jouº®
->
j_ruÂšg_Œª§ùiÚ
;

2304 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2305 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2306 
	`jbd_uÆock_bh_¡©e
(
bh
);

2307 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2316 
	`J_ASSERT_JH
(
jh
, 
Œª§ùiÚ
 =ğ
jouº®
->
j_ruÂšg_Œª§ùiÚ
);

2317 
	`JBUFFER_TRACE
(
jh
, "on„unningransaction");

2318 
may_ä“
 = 
	`__di¥o£_bufãr
(
jh
, 
Œª§ùiÚ
);

2321 
z­_bufãr
:

2330 
jh
->
b_modif›d
 = 0;

2331 
	`jbd3_jouº®_put_jouº®_h—d
(
jh
);

2332 
z­_bufãr_no_jh
:

2333 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2334 
	`jbd_uÆock_bh_¡©e
(
bh
);

2335 
	`wr™e_uÆock
(&
jouº®
->
j_¡©e_lock
);

2336 
z­_bufãr_uÆocked
:

2337 
	`ş—r_bufãr_dœty
(
bh
);

2338 
	`J_ASSERT_BH
(
bh
, !
	`bufãr_jbddœty
(bh));

2339 
	`ş—r_bufãr_m­³d
(
bh
);

2340 
	`ş—r_bufãr_»q
(
bh
);

2341 
	`ş—r_bufãr_Ãw
(
bh
);

2342 
	`ş—r_bufãr_d–ay
(
bh
);

2343 
	`ş—r_bufãr_unwr™‹n
(
bh
);

2344 
bh
->
b_bdev
 = 
NULL
;

2345  
may_ä“
;

2346 
	}
}

2360 
	$jbd3_jouº®_šv®id©•age
(
jouº®_t
 *
jouº®
,

2361 
·ge
 *page,

2362 
off£t
,

2363 
Ëngth
)

2365 
bufãr_h—d
 *
h—d
, *
bh
, *
Ãxt
;

2366 
¡İ
 = 
off£t
 + 
Ëngth
;

2367 
cu¼_off
 = 0;

2368 
·¹Ÿl_·ge
 = (
off£t
 || 
Ëngth
 < 
PAGE_SIZE
);

2369 
may_ä“
 = 1;

2370 
»t
 = 0;

2372 ià(!
	`PageLocked
(
·ge
))

2373 
	`BUG
();

2374 ià(!
	`·ge_has_bufãrs
(
·ge
))

2377 
	`BUG_ON
(
¡İ
 > 
PAGE_SIZE
 || stİ < 
Ëngth
);

2383 
h—d
 = 
bh
 = 
	`·ge_bufãrs
(
·ge
);

2385 
Ãxt_off
 = 
cu¼_off
 + 
bh
->
b_size
;

2386 
Ãxt
 = 
bh
->
b_this_·ge
;

2388 ià(
Ãxt_off
 > 
¡İ
)

2391 ià(
off£t
 <ğ
cu¼_off
) {

2393 
	`lock_bufãr
(
bh
);

2394 
»t
 = 
	`jouº®_unm­_bufãr
(
jouº®
, 
bh
, 
·¹Ÿl_·ge
);

2395 
	`uÆock_bufãr
(
bh
);

2396 ià(
»t
 < 0)

2397  
»t
;

2398 
may_ä“
 &ğ
»t
;

2400 
cu¼_off
 = 
Ãxt_off
;

2401 
bh
 = 
Ãxt
;

2403 } 
bh
 !ğ
h—d
);

2405 ià(!
·¹Ÿl_·ge
) {

2406 ià(
may_ä“
 && 
	`Œy_to_ä“_bufãrs
(
·ge
))

2407 
	`J_ASSERT
(!
	`·ge_has_bufãrs
(
·ge
));

2410 
	}
}

2415 
	$__jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2416 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2418 
jouº®_h—d
 **
li¡
 = 
NULL
;

2419 
was_dœty
 = 0;

2420 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2422 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2423 
	`as£¹_¥š_locked
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2425 
	`J_ASSERT_JH
(
jh
, jh->
b_jli¡
 < 
BJ_Ty³s
);

2426 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2427 
jh
->
b_Œª§ùiÚ
 =ğ
NULL
);

2429 ià(
jh
->
b_Œª§ùiÚ
 && jh->
b_jli¡
 =ğ
jli¡
)

2432 ià(
jli¡
 =ğ
BJ_M‘ad©a
 || jli¡ =ğ
BJ_Re£rved
 ||

2433 
jli¡
 =ğ
BJ_Shadow
 || jli¡ =ğ
BJ_FÜg‘
) {

2441 ià(
	`bufãr_dœty
(
bh
))

2442 
	`w¬n_dœty_bufãr
(
bh
);

2443 ià(
	`‹¡_ş—r_bufãr_dœty
(
bh
) ||

2444 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
))

2445 
was_dœty
 = 1;

2448 ià(
jh
->
b_Œª§ùiÚ
)

2449 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2451 
	`jbd3_jouº®_g¿b_jouº®_h—d
(
bh
);

2452 
jh
->
b_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2454 
jli¡
) {

2455 
BJ_NÚe
:

2456 
	`J_ASSERT_JH
(
jh
, !jh->
b_comm™‹d_d©a
);

2457 
	`J_ASSERT_JH
(
jh
, !jh->
b_äoz’_d©a
);

2459 
BJ_M‘ad©a
:

2460 
Œª§ùiÚ
->
t_Ä_bufãrs
++;

2461 
li¡
 = &
Œª§ùiÚ
->
t_bufãrs
;

2463 
BJ_FÜg‘
:

2464 
li¡
 = &
Œª§ùiÚ
->
t_fÜg‘
;

2466 
BJ_Shadow
:

2467 
li¡
 = &
Œª§ùiÚ
->
t_shadow_li¡
;

2469 
BJ_Re£rved
:

2470 
li¡
 = &
Œª§ùiÚ
->
t_»£rved_li¡
;

2474 
	`__bli¡_add_bufãr
(
li¡
, 
jh
);

2475 
jh
->
b_jli¡
 = 
jli¡
;

2477 ià(
was_dœty
)

2478 
	`£t_bufãr_jbddœty
(
bh
);

2479 
	}
}

2481 
	$jbd3_jouº®_fe_bufãr
(
jouº®_h—d
 *
jh
,

2482 
Œª§ùiÚ_t
 *
Œª§ùiÚ
, 
jli¡
)

2484 
	`jbd_lock_bh_¡©e
(
	`jh2bh
(
jh
));

2485 
	`¥š_lock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2486 
	`__jbd3_jouº®_fe_bufãr
(
jh
, 
Œª§ùiÚ
, 
jli¡
);

2487 
	`¥š_uÆock
(&
Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2488 
	`jbd_uÆock_bh_¡©e
(
	`jh2bh
(
jh
));

2489 
	}
}

2502 
	$__jbd3_jouº®_»fe_bufãr
(
jouº®_h—d
 *
jh
)

2504 
was_dœty
, 
jli¡
;

2505 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2507 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_¡©e
(
bh
));

2508 ià(
jh
->
b_Œª§ùiÚ
)

2509 
	`as£¹_¥š_locked
(&
jh
->
b_Œª§ùiÚ
->
t_jouº®
->
j_li¡_lock
);

2512 ià(
jh
->
b_Ãxt_Œª§ùiÚ
 =ğ
NULL
) {

2513 
	`__jbd3_jouº®_unfe_bufãr
(
jh
);

2522 
was_dœty
 = 
	`‹¡_ş—r_bufãr_jbddœty
(
bh
);

2523 
	`__jbd3_jouº®_‹mp_uÆšk_bufãr
(
jh
);

2529 
jh
->
b_Œª§ùiÚ
 = jh->
b_Ãxt_Œª§ùiÚ
;

2530 
jh
->
b_Ãxt_Œª§ùiÚ
 = 
NULL
;

2531 ià(
	`bufãr_ä“d
(
bh
))

2532 
jli¡
 = 
BJ_FÜg‘
;

2533 ià(
jh
->
b_modif›d
)

2534 
jli¡
 = 
BJ_M‘ad©a
;

2536 
jli¡
 = 
BJ_Re£rved
;

2537 
	`__jbd3_jouº®_fe_bufãr
(
jh
, jh->
b_Œª§ùiÚ
, 
jli¡
);

2538 
	`J_ASSERT_JH
(
jh
, jh->
b_Œª§ùiÚ
->
t_¡©e
 =ğ
T_RUNNING
);

2540 ià(
was_dœty
)

2541 
	`£t_bufãr_jbddœty
(
bh
);

2542 
	}
}

2550 
	$jbd3_jouº®_»fe_bufãr
(
jouº®_t
 *
jouº®
, 
jouº®_h—d
 *
jh
)

2552 
bufãr_h—d
 *
bh
 = 
	`jh2bh
(
jh
);

2555 
	`g‘_bh
(
bh
);

2556 
	`jbd_lock_bh_¡©e
(
bh
);

2557 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2558 
	`__jbd3_jouº®_»fe_bufãr
(
jh
);

2559 
	`jbd_uÆock_bh_¡©e
(
bh
);

2560 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2561 
	`__b»l£
(
bh
);

2562 
	}
}

2567 
	$jbd3_jouº®_fe_šode
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
,

2568 
æags
)

2570 
Œª§ùiÚ_t
 *
Œª§ùiÚ
 = 
hªdË
->
h_Œª§ùiÚ
;

2571 
jouº®_t
 *
jouº®
;

2573 ià(
	`is_hªdË_abÜ‹d
(
hªdË
))

2574  -
EROFS
;

2575 
jouº®
 = 
Œª§ùiÚ
->
t_jouº®
;

2577 
	`jbd_debug
(4, "Addšg inod%lu,id:%d\n", 
jšode
->
i_vfs_šode
->
i_šo
,

2578 
Œª§ùiÚ
->
t_tid
);

2593 ià((
jšode
->
i_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2594 
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
) &&

2595 (
jšode
->
i_æags
 & 
æags
) == flags)

2598 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2599 
jšode
->
i_æags
 |ğ
æags
;

2601 ià(
jšode
->
i_Œª§ùiÚ
 =ğ
Œª§ùiÚ
 ||

2602 
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
Œª§ùiÚ
)

2603 
dÚe
;

2610 ià(!
Œª§ùiÚ
->
t_Ãed_d©a_æush
)

2611 
Œª§ùiÚ
->
t_Ãed_d©a_æush
 = 1;

2614 ià(
jšode
->
i_Œª§ùiÚ
) {

2615 
	`J_ASSERT
(
jšode
->
i_Ãxt_Œª§ùiÚ
 =ğ
NULL
);

2616 
	`J_ASSERT
(
jšode
->
i_Œª§ùiÚ
 ==

2617 
jouº®
->
j_comm™tšg_Œª§ùiÚ
);

2618 
jšode
->
i_Ãxt_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2619 
dÚe
;

2622 
	`J_ASSERT
(!
jšode
->
i_Ãxt_Œª§ùiÚ
);

2623 
jšode
->
i_Œª§ùiÚ
 = 
Œª§ùiÚ
;

2624 
	`li¡_add
(&
jšode
->
i_li¡
, &
Œª§ùiÚ
->
t_šode_li¡
);

2625 
dÚe
:

2626 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2629 
	}
}

2631 
	$jbd3_jouº®_šode_add_wr™e
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
)

2633  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
,

2634 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
);

2635 
	}
}

2637 
	$jbd3_jouº®_šode_add_wa™
(
hªdË_t
 *
hªdË
, 
jbd3_šode
 *
jšode
)

2639  
	`jbd3_jouº®_fe_šode
(
hªdË
, 
jšode
, 
JI_WAIT_DATA
);

2640 
	}
}

2662 
	$jbd3_jouº®_begš_Üd”ed_Œunÿ‹
(
jouº®_t
 *
jouº®
,

2663 
jbd3_šode
 *
jšode
,

2664 
loff_t
 
Ãw_size
)

2666 
Œª§ùiÚ_t
 *
šode_Œªs
, *
comm™_Œªs
;

2667 
»t
 = 0;

2670 ià(!
jšode
->
i_Œª§ùiÚ
)

2671 
out
;

2675 
	`»ad_lock
(&
jouº®
->
j_¡©e_lock
);

2676 
comm™_Œªs
 = 
jouº®
->
j_comm™tšg_Œª§ùiÚ
;

2677 
	`»ad_uÆock
(&
jouº®
->
j_¡©e_lock
);

2678 
	`¥š_lock
(&
jouº®
->
j_li¡_lock
);

2679 
šode_Œªs
 = 
jšode
->
i_Œª§ùiÚ
;

2680 
	`¥š_uÆock
(&
jouº®
->
j_li¡_lock
);

2681 ià(
šode_Œªs
 =ğ
comm™_Œªs
) {

2682 
»t
 = 
	`fem­_fd©awr™e_¿nge
(
jšode
->
i_vfs_šode
->
i_m­pšg
,

2683 
Ãw_size
, 
LLONG_MAX
);

2684 ià(
»t
)

2685 
	`jbd3_jouº®_abÜt
(
jouº®
, 
»t
);

2687 
out
:

2688  
»t
;

2689 
	}
}

	@/usr/include/linux/errno.h

1 
	~<asm/”ºo.h
>

	@/usr/include/linux/fs.h

2 #iâdeà
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<lšux/lim™s.h
>

14 
	~<lšux/ioùl.h
>

15 
	~<lšux/ty³s.h
>

28 #undeà
NR_OPEN


29 
	#INR_OPEN_CUR
 1024

	)

30 
	#INR_OPEN_MAX
 4096

	)

32 
	#BLOCK_SIZE_BITS
 10

	)

33 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

35 
	#SEEK_SET
 0

	)

36 
	#SEEK_CUR
 1

	)

37 
	#SEEK_END
 2

	)

38 
	#SEEK_DATA
 3

	)

39 
	#SEEK_HOLE
 4

	)

40 
	#SEEK_MAX
 
SEEK_HOLE


	)

42 
	#RENAME_NOREPLACE
 (1 << 0è

	)

43 
	#RENAME_EXCHANGE
 (1 << 1è

	)

44 
	#RENAME_WHITEOUT
 (1 << 2è

	)

46 
	sfe_şÚe_¿nge
 {

47 
__s64
 
	m¤c_fd
;

48 
__u64
 
	m¤c_off£t
;

49 
__u64
 
	m¤c_Ëngth
;

50 
__u64
 
	mde¡_off£t
;

53 
	sf¡rim_¿nge
 {

54 
__u64
 
	m¡¬t
;

55 
__u64
 
	mËn
;

56 
__u64
 
	mmšËn
;

60 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

61 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

64 
	sfe_dedu³_¿nge_šfo
 {

65 
__s64
 
	mde¡_fd
;

66 
__u64
 
	mde¡_off£t
;

67 
__u64
 
	mby‹s_dedu³d
;

74 
__s32
 
	m¡©us
;

75 
__u32
 
	m»£rved
;

79 
	sfe_dedu³_¿nge
 {

80 
__u64
 
	m¤c_off£t
;

81 
__u64
 
	m¤c_Ëngth
;

82 
__u16
 
	mde¡_couÁ
;

83 
__u16
 
	m»£rved1
;

84 
__u32
 
	m»£rved2
;

85 
fe_dedu³_¿nge_šfo
 
	mšfo
[0];

89 
	sfes_¡©_¡ruù
 {

90 
	mÄ_fes
;

91 
	mÄ_ä“_fes
;

92 
	mmax_fes
;

95 
	sšodes_¡©_t
 {

96 
	mÄ_šodes
;

97 
	mÄ_unu£d
;

98 
	mdummy
[5];

102 
	#NR_FILE
 8192

	)

108 
	#MS_RDONLY
 1

	)

109 
	#MS_NOSUID
 2

	)

110 
	#MS_NODEV
 4

	)

111 
	#MS_NOEXEC
 8

	)

112 
	#MS_SYNCHRONOUS
 16

	)

113 
	#MS_REMOUNT
 32

	)

114 
	#MS_MANDLOCK
 64

	)

115 
	#MS_DIRSYNC
 128

	)

116 
	#MS_NOATIME
 1024

	)

117 
	#MS_NODIRATIME
 2048

	)

118 
	#MS_BIND
 4096

	)

119 
	#MS_MOVE
 8192

	)

120 
	#MS_REC
 16384

	)

121 
	#MS_VERBOSE
 32768

	)

123 
	#MS_SILENT
 32768

	)

124 
	#MS_POSIXACL
 (1<<16è

	)

125 
	#MS_UNBINDABLE
 (1<<17è

	)

126 
	#MS_PRIVATE
 (1<<18è

	)

127 
	#MS_SLAVE
 (1<<19è

	)

128 
	#MS_SHARED
 (1<<20è

	)

129 
	#MS_RELATIME
 (1<<21è

	)

130 
	#MS_KERNMOUNT
 (1<<22è

	)

131 
	#MS_I_VERSION
 (1<<23è

	)

132 
	#MS_STRICTATIME
 (1<<24è

	)

133 
	#MS_LAZYTIME
 (1<<25è

	)

136 
	#MS_SUBMOUNT
 (1<<26)

	)

137 
	#MS_NOREMOTELOCK
 (1<<27)

	)

138 
	#MS_NOSEC
 (1<<28)

	)

139 
	#MS_BORN
 (1<<29)

	)

140 
	#MS_ACTIVE
 (1<<30)

	)

141 
	#MS_NOUSER
 (1<<31)

	)

146 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

147 
MS_LAZYTIME
)

	)

152 
	#MS_MGC_VAL
 0xC0ED0000

	)

153 
	#MS_MGC_MSK
 0xffff0000

	)

158 
	sfsx©Œ
 {

159 
__u32
 
	mfsx_xæags
;

160 
__u32
 
	mfsx_extsize
;

161 
__u32
 
	mfsx_Ãx‹Ás
;

162 
__u32
 
	mfsx_´ojid
;

163 
__u32
 
	mfsx_cowextsize
;

164 
	mfsx_·d
[8];

170 
	#FS_XFLAG_REALTIME
 0x00000001

	)

171 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

172 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

173 
	#FS_XFLAG_APPEND
 0x00000010

	)

174 
	#FS_XFLAG_SYNC
 0x00000020

	)

175 
	#FS_XFLAG_NOATIME
 0x00000040

	)

176 
	#FS_XFLAG_NODUMP
 0x00000080

	)

177 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

178 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

179 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

180 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

181 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

182 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

183 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

184 
	#FS_XFLAG_DAX
 0x00008000

	)

185 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

186 
	#FS_XFLAG_HASATTR
 0x80000000

	)

191 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

192 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

193 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

194 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

195 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

196 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

197 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

198 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

199 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

200 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

201 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

202 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

204 
	#BLKPG
 
	`_IO
(0x12,105)

	)

208 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

209 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

214 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

215 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

216 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

217 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

218 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

219 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

220 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

221 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

222 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

223 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

224 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

225 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

226 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

227 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

228 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

229 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

235 
	#BMAP_IOCTL
 1

	)

236 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

237 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

238 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

239 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

240 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

241 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

242 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fe_şÚe_¿nge
)

	)

243 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fe_dedu³_¿nge
)

	)

245 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

246 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

247 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

248 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

249 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

250 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

251 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

252 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

253 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

254 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©Œ
)

	)

255 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©Œ
)

	)

261 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

263 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

264 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

265 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

266 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

267 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

268 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

271 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

275 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

277 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

279 
	sfsüy±_pŞicy
 {

280 
__u8
 
	mv”siÚ
;

281 
__u8
 
	mcÚ‹Ás_’üy±iÚ_mode
;

282 
__u8
 
	mf’ames_’üy±iÚ_mode
;

283 
__u8
 
	mæags
;

284 
__u8
 
	mma¡”_key_desütÜ
[
FS_KEY_DESCRIPTOR_SIZE
];

287 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fsüy±_pŞicy
)

	)

288 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

289 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fsüy±_pŞicy
)

	)

292 
	#FS_KEY_DESC_PREFIX
 "fsüy±:"

	)

293 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

296 
	#FS_MAX_KEY_SIZE
 64

	)

298 
	sfsüy±_key
 {

299 
__u32
 
	mmode
;

300 
__u8
 
	m¿w
[
FS_MAX_KEY_SIZE
];

301 
__u32
 
	msize
;

324 
	#FS_SECRM_FL
 0x00000001

	)

325 
	#FS_UNRM_FL
 0x00000002

	)

326 
	#FS_COMPR_FL
 0x00000004

	)

327 
	#FS_SYNC_FL
 0x00000008

	)

328 
	#FS_IMMUTABLE_FL
 0x00000010

	)

329 
	#FS_APPEND_FL
 0x00000020

	)

330 
	#FS_NODUMP_FL
 0x00000040

	)

331 
	#FS_NOATIME_FL
 0x00000080

	)

333 
	#FS_DIRTY_FL
 0x00000100

	)

334 
	#FS_COMPRBLK_FL
 0x00000200

	)

335 
	#FS_NOCOMP_FL
 0x00000400

	)

337 
	#FS_ENCRYPT_FL
 0x00000800

	)

338 
	#FS_BTREE_FL
 0x00001000

	)

339 
	#FS_INDEX_FL
 0x00001000

	)

340 
	#FS_IMAGIC_FL
 0x00002000

	)

341 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

342 
	#FS_NOTAIL_FL
 0x00008000

	)

343 
	#FS_DIRSYNC_FL
 0x00010000

	)

344 
	#FS_TOPDIR_FL
 0x00020000

	)

345 
	#FS_HUGE_FILE_FL
 0x00040000

	)

346 
	#FS_EXTENT_FL
 0x00080000

	)

347 
	#FS_EA_INODE_FL
 0x00200000

	)

348 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

349 
	#FS_NOCOW_FL
 0x00800000

	)

350 
	#FS_INLINE_DATA_FL
 0x10000000

	)

351 
	#FS_PROJINHERIT_FL
 0x20000000

	)

352 
	#FS_RESERVED_FL
 0x80000000

	)

354 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

355 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

358 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

359 
	#SYNC_FILE_RANGE_WRITE
 2

	)

360 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

366 
	t__b™wi£
 
	t__k”Ãl_rwf_t
;

369 
	#RWF_HIPRI
 ((
__k”Ãl_rwf_t
)0x00000001)

	)

372 
	#RWF_DSYNC
 ((
__k”Ãl_rwf_t
)0x00000002)

	)

375 
	#RWF_SYNC
 ((
__k”Ãl_rwf_t
)0x00000004)

	)

378 
	#RWF_NOWAIT
 ((
__k”Ãl_rwf_t
)0x00000008)

	)

381 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
)

	)

	@/usr/include/linux/module.h

2 #iâdeà
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/time.h

2 #iâdeà
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<lšux/ty³s.h
>

8 #iâdeà
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime¥ec
 {

11 
__k”Ãl_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimev®
 {

17 
__k”Ãl_time_t
 
	mtv_£c
;

18 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

21 
	stimezÚe
 {

22 
	mtz_mšu‹swe¡
;

23 
	mtz_d¡time
;

31 
	#ITIMER_REAL
 0

	)

32 
	#ITIMER_VIRTUAL
 1

	)

33 
	#ITIMER_PROF
 2

	)

35 
	s™im”¥ec
 {

36 
time¥ec
 
	m™_š‹rv®
;

37 
time¥ec
 
	m™_v®ue
;

40 
	s™im”v®
 {

41 
timev®
 
	m™_š‹rv®
;

42 
timev®
 
	m™_v®ue
;

48 
	#CLOCK_REALTIME
 0

	)

49 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

51 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

52 
	#CLOCK_MONOTONIC_RAW
 4

	)

53 
	#CLOCK_REALTIME_COARSE
 5

	)

54 
	#CLOCK_MONOTONIC_COARSE
 6

	)

55 
	#CLOCK_BOOTTIME
 7

	)

56 
	#CLOCK_REALTIME_ALARM
 8

	)

57 
	#CLOCK_BOOTTIME_ALARM
 9

	)

62 
	#CLOCK_SGI_CYCLE
 10

	)

63 
	#CLOCK_TAI
 11

	)

65 
	#MAX_CLOCKS
 16

	)

66 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

67 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

72 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/ioctl.h

2 #iâdeà
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/ioùl.h
>

	@/usr/include/linux/limits.h

2 #iâdeà
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/types.h

2 #iâdeà
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty³s.h
>

7 #iâdeà
__ASSEMBLY__


9 
	~<lšux/posix_ty³s.h
>

17 #ifdeà
__CHECKER__


18 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

20 
	#__b™wi£__


	)

22 
	#__b™wi£
 
__b™wi£__


	)

24 
__u16
 
	t__b™wi£
 
	t__Ë16
;

25 
__u16
 
	t__b™wi£
 
	t__be16
;

26 
__u32
 
	t__b™wi£
 
	t__Ë32
;

27 
__u32
 
	t__b™wi£
 
	t__be32
;

28 
__u64
 
	t__b™wi£
 
	t__Ë64
;

29 
__u64
 
	t__b™wi£
 
	t__be64
;

31 
__u16
 
	t__b™wi£
 
	t__sum16
;

32 
__u32
 
	t__b™wi£
 
	t__wsum
;

43 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

44 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

45 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/posix_types.h

2 #iâdeà
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<lšux/¡ddef.h
>

22 #undeà
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__k”Ãl_fd_£t
;

30 (*
	t__k”Ãl_sighªdËr_t
)();

33 
	t__k”Ãl_key_t
;

34 
	t__k”Ãl_mqd_t
;

36 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/stddef.h

4 #iâdeà
__®ways_šlše


5 
	#__®ways_šlše
 
__šlše__


	)

	@
1
.
1
/usr/include
16
325
checkpoint.c
commit.c
jbd3.mod.c
journal.c
recovery.c
revoke.c
transaction.c
/usr/include/linux/errno.h
/usr/include/linux/fs.h
/usr/include/linux/module.h
/usr/include/linux/time.h
/usr/include/linux/ioctl.h
/usr/include/linux/limits.h
/usr/include/linux/types.h
/usr/include/linux/posix_types.h
/usr/include/linux/stddef.h
