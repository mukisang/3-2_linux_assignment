cscope 15 $HOME/Desktop/module_test/FS_module/pxt4               0001615761
	@acl.c

8 
	~<löux/quŸa›s.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4.h
"

11 
	~"x©å.h
"

12 
	~"a˛.h
"

17 
posix_a˛
 *

18 
	$pxt4_a˛_‰om_disk
(c⁄° *
vÆue
, 
size_t
 
size
)

20 c⁄° *
íd
 = (*)
vÆue
 + 
size
;

21 
n
, 
cou¡
;

22 
posix_a˛
 *
a˛
;

24 i‡(!
vÆue
)

25  
NULL
;

26 i‡(
size
 < (
pxt4_a˛_hódî
))

27  
	`ERR_PTR
(-
EINVAL
);

28 i‡(((
pxt4_a˛_hódî
 *)
vÆue
)->
a_vîsi⁄
 !=

29 
	`˝u_to_À32
(
PXT4_ACL_VERSION
))

30  
	`ERR_PTR
(-
EINVAL
);

31 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_hódî
);

32 
cou¡
 = 
	`pxt4_a˛_cou¡
(
size
);

33 i‡(
cou¡
 < 0)

34  
	`ERR_PTR
(-
EINVAL
);

35 i‡(
cou¡
 == 0)

36  
NULL
;

37 
a˛
 = 
	`posix_a˛_Æloc
(
cou¡
, 
GFP_NOFS
);

38 i‡(!
a˛
)

39  
	`ERR_PTR
(-
ENOMEM
);

40 
n
 = 0;Ç < 
cou¡
;Ç++) {

41 
pxt4_a˛_íåy
 *
íåy
 =

42 (
pxt4_a˛_íåy
 *)
vÆue
;

43 i‡((*)
vÆue
 + (
pxt4_a˛_íåy_sh‹t
Ë> 
íd
)

44 
Áû
;

45 
a˛
->
a_íåõs
[
n
].
e_èg
 = 
	`À16_to_˝u
(
íåy
->e_tag);

46 
a˛
->
a_íåõs
[
n
].
e_≥rm
 = 
	`À16_to_˝u
(
íåy
->e_perm);

48 
a˛
->
a_íåõs
[
n
].
e_èg
) {

49 
ACL_USER_OBJ
:

50 
ACL_GROUP_OBJ
:

51 
ACL_MASK
:

52 
ACL_OTHER
:

53 
vÆue
 = (*)value +

54 (
pxt4_a˛_íåy_sh‹t
);

57 
ACL_USER
:

58 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

59 i‡((*)
vÆue
 > 
íd
)

60 
Áû
;

61 
a˛
->
a_íåõs
[
n
].
e_uid
 =

62 
	`make_kuid
(&
öô_u£r_ns
,

63 
	`À32_to_˝u
(
íåy
->
e_id
));

65 
ACL_GROUP
:

66 
vÆue
 = (*)vÆuê+ (
pxt4_a˛_íåy
);

67 i‡((*)
vÆue
 > 
íd
)

68 
Áû
;

69 
a˛
->
a_íåõs
[
n
].
e_gid
 =

70 
	`make_kgid
(&
öô_u£r_ns
,

71 
	`À32_to_˝u
(
íåy
->
e_id
));

75 
Áû
;

78 i‡(
vÆue
 !
íd
)

79 
Áû
;

80  
a˛
;

82 
Áû
:

83 
	`posix_a˛_ªÀa£
(
a˛
);

84  
	`ERR_PTR
(-
EINVAL
);

85 
	}
}

91 
	$pxt4_a˛_to_disk
(c⁄° 
posix_a˛
 *
a˛
, 
size_t
 *
size
)

93 
pxt4_a˛_hódî
 *
ext_a˛
;

94 *
e
;

95 
size_t
 
n
;

97 *
size
 = 
	`pxt4_a˛_size
(
a˛
->
a_cou¡
);

98 
ext_a˛
 = 
	`kmÆloc
((
pxt4_a˛_hódî
Ë+ 
a˛
->
a_cou¡
 *

99 (
pxt4_a˛_íåy
), 
GFP_NOFS
);

100 i‡(!
ext_a˛
)

101  
	`ERR_PTR
(-
ENOMEM
);

102 
ext_a˛
->
a_vîsi⁄
 = 
	`˝u_to_À32
(
PXT4_ACL_VERSION
);

103 
e
 = (*)
ext_a˛
 + (
pxt4_a˛_hódî
);

104 
n
 = 0;Ç < 
a˛
->
a_cou¡
;Ç++) {

105 c⁄° 
posix_a˛_íåy
 *
a˛_e
 = &
a˛
->
a_íåõs
[
n
];

106 
pxt4_a˛_íåy
 *
íåy
 = (pxt4_a˛_íåy *)
e
;

107 
íåy
->
e_èg
 = 
	`˝u_to_À16
(
a˛_e
->e_tag);

108 
íåy
->
e_≥rm
 = 
	`˝u_to_À16
(
a˛_e
->e_perm);

109 
a˛_e
->
e_èg
) {

110 
ACL_USER
:

111 
íåy
->
e_id
 = 
	`˝u_to_À32
(

112 
	`‰om_kuid
(&
öô_u£r_ns
, 
a˛_e
->
e_uid
));

113 
e
 +(
pxt4_a˛_íåy
);

115 
ACL_GROUP
:

116 
íåy
->
e_id
 = 
	`˝u_to_À32
(

117 
	`‰om_kgid
(&
öô_u£r_ns
, 
a˛_e
->
e_gid
));

118 
e
 +(
pxt4_a˛_íåy
);

121 
ACL_USER_OBJ
:

122 
ACL_GROUP_OBJ
:

123 
ACL_MASK
:

124 
ACL_OTHER
:

125 
e
 +(
pxt4_a˛_íåy_sh‹t
);

129 
Áû
;

132  (*)
ext_a˛
;

134 
Áû
:

135 
	`k‰ì
(
ext_a˛
);

136  
	`ERR_PTR
(-
EINVAL
);

137 
	}
}

144 
posix_a˛
 *

145 
	$pxt4_gë_a˛
(
öode
 *öode, 
ty≥
)

147 
«me_ödex
;

148 *
vÆue
 = 
NULL
;

149 
posix_a˛
 *
a˛
;

150 
ªtvÆ
;

152 
ty≥
) {

153 
ACL_TYPE_ACCESS
:

154 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

156 
ACL_TYPE_DEFAULT
:

157 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

160 
	`BUG
();

162 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
NULL
, 0);

163 i‡(
ªtvÆ
 > 0) {

164 
vÆue
 = 
	`kmÆloc
(
ªtvÆ
, 
GFP_NOFS
);

165 i‡(!
vÆue
)

166  
	`ERR_PTR
(-
ENOMEM
);

167 
ªtvÆ
 = 
	`pxt4_x©å_gë
(
öode
, 
«me_ödex
, "", 
vÆue
,Ñetval);

169 i‡(
ªtvÆ
 > 0)

170 
a˛
 = 
	`pxt4_a˛_‰om_disk
(
vÆue
, 
ªtvÆ
);

171 i‡(
ªtvÆ
 =-
ENODATA
 ||ÑëvÆ =-
ENOSYS
)

172 
a˛
 = 
NULL
;

174 
a˛
 = 
	`ERR_PTR
(
ªtvÆ
);

175 
	`k‰ì
(
vÆue
);

177  
a˛
;

178 
	}
}

186 
	$__pxt4_£t_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
ty≥
,

187 
posix_a˛
 *
a˛
, 
x©å_Êags
)

189 
«me_ödex
;

190 *
vÆue
 = 
NULL
;

191 
size_t
 
size
 = 0;

192 
îr‹
;

194 
ty≥
) {

195 
ACL_TYPE_ACCESS
:

196 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
;

199 
ACL_TYPE_DEFAULT
:

200 
«me_ödex
 = 
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
;

201 i‡(!
	`S_ISDIR
(
öode
->
i_mode
))

202  
a˛
 ? -
EACCES
 : 0;

206  -
EINVAL
;

208 i‡(
a˛
) {

209 
vÆue
 = 
	`pxt4_a˛_to_disk
(
a˛
, &
size
);

210 i‡(
	`IS_ERR
(
vÆue
))

211  ()
	`PTR_ERR
(
vÆue
);

214 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, "",

215 
vÆue
, 
size
, 
x©å_Êags
);

217 
	`k‰ì
(
vÆue
);

218 i‡(!
îr‹
) {

219 
	`£t_ˇched_a˛
(
öode
, 
ty≥
, 
a˛
);

222  
îr‹
;

223 
	}
}

226 
	$pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
)

228 
h™dÀ_t
 *
h™dÀ
;

229 
îr‹
, 
¸edôs
, 
ªåõs
 = 0;

230 
size_t
 
a˛_size
 = 
a˛
 ? 
	`pxt4_a˛_size
◊˛->
a_cou¡
) : 0;

231 
umode_t
 
mode
 = 
öode
->
i_mode
;

232 
upd©e_mode
 = 0;

234 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

235 i‡(
îr‹
)

236  
îr‹
;

237 
ªåy
:

238 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
a˛_size
, 
Ál£
 ,

239 &
¸edôs
);

240 i‡(
îr‹
)

241  
îr‹
;

243 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

244 i‡(
	`IS_ERR
(
h™dÀ
))

245  
	`PTR_ERR
(
h™dÀ
);

247 i‡((
ty≥
 =
ACL_TYPE_ACCESS
Ë&& 
a˛
) {

248 
îr‹
 = 
	`posix_a˛_upd©e_mode
(
öode
, &
mode
, &
a˛
);

249 i‡(
îr‹
)

250 
out_°›
;

251 i‡(
mode
 !
öode
->
i_mode
)

252 
upd©e_mode
 = 1;

255 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ty≥
, 
a˛
, 0 );

256 i‡(!
îr‹
 && 
upd©e_mode
) {

257 
öode
->
i_mode
 = 
mode
;

258 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

259 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

261 
out_°›
:

262 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

263 i‡(
îr‹
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

264 
ªåy
;

265  
îr‹
;

266 
	}
}

275 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

277 
posix_a˛
 *
deÁu…_a˛
, *
a˛
;

278 
îr‹
;

280 
îr‹
 = 
	`posix_a˛_¸óã
(
dú
, &
öode
->
i_mode
, &
deÁu…_a˛
, &
a˛
);

281 i‡(
îr‹
)

282  
îr‹
;

284 i‡(
deÁu…_a˛
) {

285 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_DEFAULT
,

286 
deÁu…_a˛
, 
XATTR_CREATE
);

287 
	`posix_a˛_ªÀa£
(
deÁu…_a˛
);

289 
öode
->
i_deÁu…_a˛
 = 
NULL
;

291 i‡(
a˛
) {

292 i‡(!
îr‹
)

293 
îr‹
 = 
	`__pxt4_£t_a˛
(
h™dÀ
, 
öode
, 
ACL_TYPE_ACCESS
,

294 
a˛
, 
XATTR_CREATE
);

295 
	`posix_a˛_ªÀa£
(
a˛
);

297 
öode
->
i_a˛
 = 
NULL
;

299  
îr‹
;

300 
	}
}

	@acl.h

8 
	~<löux/posix_a˛_x©å.h
>

10 
	#PXT4_ACL_VERSION
 0x0001

	)

13 
__À16
 
	me_èg
;

14 
__À16
 
	me_≥rm
;

15 
__À32
 
	me_id
;

16 } 
	tpxt4_a˛_íåy
;

19 
__À16
 
	me_èg
;

20 
__À16
 
	me_≥rm
;

21 } 
	tpxt4_a˛_íåy_sh‹t
;

24 
__À32
 
	ma_vîsi⁄
;

25 } 
	tpxt4_a˛_hódî
;

27 
ölöe
 
size_t
 
	$pxt4_a˛_size
(
cou¡
)

29 i‡(
cou¡
 <= 4) {

30  (
pxt4_a˛_hódî
) +

31 
cou¡
 * (
pxt4_a˛_íåy_sh‹t
);

33  (
pxt4_a˛_hódî
) +

34 4 * (
pxt4_a˛_íåy_sh‹t
) +

35 (
cou¡
 - 4Ë* (
pxt4_a˛_íåy
);

37 
	}
}

39 
ölöe
 
	$pxt4_a˛_cou¡
(
size_t
 
size
)

41 
ssize_t
 
s
;

42 
size
 -(
pxt4_a˛_hódî
);

43 
s
 = 
size
 - 4 * (
pxt4_a˛_íåy_sh‹t
);

44 i‡(
s
 < 0) {

45 i‡(
size
 % (
pxt4_a˛_íåy_sh‹t
))

47  
size
 / (
pxt4_a˛_íåy_sh‹t
);

49 i‡(
s
 % (
pxt4_a˛_íåy
))

51  
s
 / (
pxt4_a˛_íåy
) + 4;

53 
	}
}

55 #ifde‡
CONFIG_EXT4_FS_POSIX_ACL


58 
posix_a˛
 *
pxt4_gë_a˛
(
öode
 *öode, 
ty≥
);

59 
pxt4_£t_a˛
(
öode
 *öode, 
posix_a˛
 *
a˛
, 
ty≥
);

60 
pxt4_öô_a˛
(
h™dÀ_t
 *, 
öode
 *, inode *);

63 
	~<löux/sched.h
>

64 
	#pxt4_gë_a˛
 
NULL


	)

65 
	#pxt4_£t_a˛
 
NULL


	)

67 
ölöe
 

68 
	$pxt4_öô_a˛
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
)

71 
	}
}

	@balloc.c

15 
	~<löux/time.h
>

16 
	~<löux/ˇ∑bûôy.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/quŸa›s.h
>

19 
	~<löux/buf„r_hód.h
>

20 
	~"pxt4.h
"

21 
	~"pxt4_jbd3.h
"

22 
	~"mbÆloc.h
"

24 
	~<åa˚/evíts/pxt4.h
>

26 
pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

27 
pxt4_group_t
 
block_group
);

35 
pxt4_group_t
 
	$pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

36 
pxt4_fsblk_t
 
block
)

38 
pxt4_group_t
 
group
;

40 i‡(
	`ã°_›t2
(
sb
, 
STD_GROUP_SIZE
))

41 
group
 = (
block
 -

42 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) >>

43 (
	`PXT4_BLOCK_SIZE_BITS
(
sb
Ë+ 
	`PXT4_CLUSTER_BITS
(sb) + 3);

45 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
group
, 
NULL
);

46  
group
;

47 
	}
}

53 
	$pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
blockƒ
,

54 
pxt4_group_t
 *
blockgΩp
, 
pxt4_gΩblk_t
 *
off£ç
)

56 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

57 
pxt4_gΩblk_t
 
off£t
;

59 
blockƒ
 = blockƒ - 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

60 
off£t
 = 
	`do_div
(
blockƒ
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) >>

61 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

62 i‡(
off£ç
)

63 *
off£ç
 = 
off£t
;

64 i‡(
blockgΩp
)

65 *
blockgΩp
 = 
blockƒ
;

67 
	}
}

73 
ölöe
 
	$pxt4_block_ö_group
(
su≥r_block
 *
sb
,

74 
pxt4_fsblk_t
 
block
,

75 
pxt4_group_t
 
block_group
)

77 
pxt4_group_t
 
a˘uÆ_group
;

79 
a˘uÆ_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
block
);

80  (
a˘uÆ_group
 =
block_group
) ? 1 : 0;

81 
	}
}

86 
	$pxt4_num_ovîhód_˛u°îs
(
su≥r_block
 *
sb
,

87 
pxt4_group_t
 
block_group
,

88 
pxt4_group_desc
 *
gdp
)

90 
num_˛u°îs
;

91 
block_˛u°î
 = -1, 
öode_˛u°î
 = -1, 
ôbl_˛u°î
 = -1, 
i
, 
c
;

92 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

93 
pxt4_fsblk_t
 
ôbl_blk
;

94 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

99 
num_˛u°îs
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

113 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_block_bôm≠
(sb, 
gdp
), 
block_group
)) {

114 
block_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

115 
	`pxt4_block_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

116 i‡(
block_˛u°î
 < 
num_˛u°îs
)

117 
block_˛u°î
 = -1;

118 i‡(
block_˛u°î
 =
num_˛u°îs
) {

119 
num_˛u°îs
++;

120 
block_˛u°î
 = -1;

124 i‡(
	`pxt4_block_ö_group
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
), 
block_group
)) {

125 
öode_˛u°î
 = 
	`PXT4_B2C
(
sbi
,

126 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
Ë- 
°¨t
);

127 i‡(
öode_˛u°î
 < 
num_˛u°îs
)

128 
öode_˛u°î
 = -1;

129 i‡(
öode_˛u°î
 =
num_˛u°îs
) {

130 
num_˛u°îs
++;

131 
öode_˛u°î
 = -1;

135 
ôbl_blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

136 
i
 = 0; i < 
sbi
->
s_ôb_≥r_group
; i++) {

137 i‡(
	`pxt4_block_ö_group
(
sb
, 
ôbl_blk
 + 
i
, 
block_group
)) {

138 
c
 = 
	`PXT4_B2C
(
sbi
, 
ôbl_blk
 + 
i
 - 
°¨t
);

139 i‡((
c
 < 
num_˛u°îs
Ë|| (¯=
öode_˛u°î
) ||

140 (
c
 =
block_˛u°î
Ë|| (¯=
ôbl_˛u°î
))

142 i‡(
c
 =
num_˛u°îs
) {

143 
num_˛u°îs
++;

146 
num_˛u°îs
++;

147 
ôbl_˛u°î
 = 
c
;

151 i‡(
block_˛u°î
 != -1)

152 
num_˛u°îs
++;

153 i‡(
öode_˛u°î
 != -1)

154 
num_˛u°îs
++;

156  
num_˛u°îs
;

157 
	}
}

159 
	$num_˛u°îs_ö_group
(
su≥r_block
 *
sb
,

160 
pxt4_group_t
 
block_group
)

162 
blocks
;

164 i‡(
block_group
 =
	`pxt4_gë_groups_cou¡
(
sb
) - 1) {

171 
blocks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
) -

172 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

174 
blocks
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

175  
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
blocks
);

176 
	}
}

179 
	$pxt4_öô_block_bôm≠
(
su≥r_block
 *
sb
,

180 
buf„r_hód
 *
bh
,

181 
pxt4_group_t
 
block_group
,

182 
pxt4_group_desc
 *
gdp
)

184 
bô
, 
bô_max
;

185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

186 
pxt4_fsblk_t
 
°¨t
, 
tmp
;

188 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_locked
(bh));

192 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
block_group
, 
gdp
)) {

193 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

194 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
 |

195 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

196  -
EFSBADCRC
;

198 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

200 
bô_max
 = 
	`pxt4_num_ba£_mëa_˛u°îs
(
sb
, 
block_group
);

201 i‡((
bô_max
 >> 3Ë>
bh
->
b_size
)

202  -
EFSCORRUPTED
;

204 
bô
 = 0; bô < 
bô_max
; bit++)

205 
	`pxt4_£t_bô
(
bô
, 
bh
->
b_d©a
);

207 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

210 
tmp
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

211 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

212 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

214 
tmp
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

215 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

216 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

218 
tmp
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

219 ; 
tmp
 < 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
) +

220 
sbi
->
s_ôb_≥r_group
; 
tmp
++) {

221 i‡(
	`pxt4_block_ö_group
(
sb
, 
tmp
, 
block_group
))

222 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
tmp
 - 
°¨t
), 
bh
->
b_d©a
);

230 
	`pxt4_m¨k_bôm≠_íd
(
	`num_˛u°îs_ö_group
(
sb
, 
block_group
),

231 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

233 
	}
}

238 
	$pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

239 
pxt4_group_t
 
block_group
,

240 
pxt4_group_desc
 *
gdp
)

242  
	`num_˛u°îs_ö_group
(
sb
, 
block_group
) -

243 
	`pxt4_num_ovîhód_˛u°îs
(
sb
, 
block_group
, 
gdp
);

244 
	}
}

264 
pxt4_group_desc
 * 
	$pxt4_gë_group_desc
(
su≥r_block
 *
sb
,

265 
pxt4_group_t
 
block_group
,

266 
buf„r_hód
 **
bh
)

268 
group_desc
;

269 
off£t
;

270 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

271 
pxt4_group_desc
 *
desc
;

272 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

274 i‡(
block_group
 >
ngroups
) {

275 
	`pxt4_îr‹
(
sb
, "block_group >= groups_count - block_group = %u,"

276 " groups_cou¡ = %u", 
block_group
, 
ngroups
);

278  
NULL
;

281 
group_desc
 = 
block_group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

282 
off£t
 = 
block_group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

283 i‡(!
sbi
->
s_group_desc
[
group_desc
]) {

284 
	`pxt4_îr‹
(
sb
, "Group descriptorÇotÜoaded - "

286 
block_group
, 
group_desc
, 
off£t
);

287  
NULL
;

290 
desc
 = (
pxt4_group_desc
 *)(

291 (
__u8
 *)
sbi
->
s_group_desc
[
group_desc
]->
b_d©a
 +

292 
off£t
 * 
	`PXT4_DESC_SIZE
(
sb
));

293 i‡(
bh
)

294 *
bh
 = 
sbi
->
s_group_desc
[
group_desc
];

295  
desc
;

296 
	}
}

302 
pxt4_fsblk_t
 
	$pxt4_vÆid_block_bôm≠
(
su≥r_block
 *
sb
,

303 
pxt4_group_desc
 *
desc
,

304 
pxt4_group_t
 
block_group
,

305 
buf„r_hód
 *
bh
)

307 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

308 
pxt4_gΩblk_t
 
off£t
;

309 
pxt4_gΩblk_t
 
√xt_zîo_bô
;

310 
pxt4_gΩblk_t
 
max_bô
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

311 
pxt4_fsblk_t
 
blk
;

312 
pxt4_fsblk_t
 
group_fú°_block
;

314 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
)) {

323 
group_fú°_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
);

326 
blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

327 
off£t
 = 
blk
 - 
group_fú°_block
;

328 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

329 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

331  
blk
;

334 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

335 
off£t
 = 
blk
 - 
group_fú°_block
;

336 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

337 !
	`pxt4_ã°_bô
(
	`PXT4_B2C
(
sbi
, 
off£t
), 
bh
->
b_d©a
))

339  
blk
;

342 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
desc
);

343 
off£t
 = 
blk
 - 
group_fú°_block
;

344 i‡(
off£t
 < 0 || 
	`PXT4_B2C
(
sbi
, off£tË>
max_bô
 ||

345 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
Ë>
max_bô
)

346  
blk
;

347 
√xt_zîo_bô
 = 
	`pxt4_föd_√xt_zîo_bô
(
bh
->
b_d©a
,

348 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
),

349 
	`PXT4_B2C
(
sbi
, 
off£t
));

350 i‡(
√xt_zîo_bô
 <

351 
	`PXT4_B2C
(
sbi
, 
off£t
 + sbi->
s_ôb_≥r_group
))

353  
blk
;

355 
	}
}

357 
	$pxt4_vÆid©e_block_bôm≠
(
su≥r_block
 *
sb
,

358 
pxt4_group_desc
 *
desc
,

359 
pxt4_group_t
 
block_group
,

360 
buf„r_hód
 *
bh
)

362 
pxt4_fsblk_t
 
blk
;

363 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

365 i‡(
	`buf„r_vîifõd
(
bh
))

367 i‡(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
))

368  -
EFSCORRUPTED
;

370 
	`pxt4_lock_group
(
sb
, 
block_group
);

371 i‡(
	`buf„r_vîifõd
(
bh
))

372 
vîifõd
;

373 i‡(
	`u∆ikñy
(!
	`pxt4_block_bôm≠_csum_vîify
(
sb
, 
block_group
,

374 
desc
, 
bh
))) {

375 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

376 
	`pxt4_îr‹
(
sb
, "bg %u: bad block bôm≠ checksum", 
block_group
);

377 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

378 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

379  -
EFSBADCRC
;

381 
blk
 = 
	`pxt4_vÆid_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

382 i‡(
	`u∆ikñy
(
blk
 != 0)) {

383 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

384 
	`pxt4_îr‹
(
sb
, "bg %u: block %llu: invalid block bitmap",

385 
block_group
, 
blk
);

386 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

387 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

388  -
EFSCORRUPTED
;

390 
	`£t_buf„r_vîifõd
(
bh
);

391 
vîifõd
:

392 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

394 
	}
}

406 
buf„r_hód
 *

407 
	$pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

409 
pxt4_group_desc
 *
desc
;

410 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

411 
buf„r_hód
 *
bh
;

412 
pxt4_fsblk_t
 
bôm≠_blk
;

413 
îr
;

415 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

416 i‡(!
desc
)

417  
	`ERR_PTR
(-
EFSCORRUPTED
);

418 
bôm≠_blk
 = 
	`pxt4_block_bôm≠
(
sb
, 
desc
);

419 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

420 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

421 
	`pxt4_îr‹
(
sb
, "Invalid block bitmap block %llu in "

422 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

423 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

424 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

425  
	`ERR_PTR
(-
EFSCORRUPTED
);

427 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

428 i‡(
	`u∆ikñy
(!
bh
)) {

429 
	`pxt4_w¨nög
(
sb
, "Cannot get buffer for block bitmap - "

431 
block_group
, 
bôm≠_blk
);

432  
	`ERR_PTR
(-
ENOMEM
);

435 i‡(
	`bôm≠_u±od©e
(
bh
))

436 
vîify
;

438 
	`lock_buf„r
(
bh
);

439 i‡(
	`bôm≠_u±od©e
(
bh
)) {

440 
	`u∆ock_buf„r
(
bh
);

441 
vîify
;

443 
	`pxt4_lock_group
(
sb
, 
block_group
);

444 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

445 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

446 i‡(
block_group
 == 0) {

447 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

448 
	`u∆ock_buf„r
(
bh
);

449 
	`pxt4_îr‹
(
sb
, "Block bitmap for bg 0 marked "

451 
îr
 = -
EFSCORRUPTED
;

452 
out
;

454 
îr
 = 
	`pxt4_öô_block_bôm≠
(
sb
, 
bh
, 
block_group
, 
desc
);

455 
	`£t_bôm≠_u±od©e
(
bh
);

456 
	`£t_buf„r_u±od©e
(
bh
);

457 
	`£t_buf„r_vîifõd
(
bh
);

458 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

459 
	`u∆ock_buf„r
(
bh
);

460 i‡(
îr
) {

461 
	`pxt4_îr‹
(
sb
, "FailedÅo init block bitmap for group "

462 "%u: %d", 
block_group
, 
îr
);

463 
out
;

465 
vîify
;

467 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

468 i‡(
	`buf„r_u±od©e
(
bh
)) {

473 
	`£t_bôm≠_u±od©e
(
bh
);

474 
	`u∆ock_buf„r
(
bh
);

475 
vîify
;

480 
	`£t_buf„r_√w
(
bh
);

481 
	`åa˚_pxt4_ªad_block_bôm≠_lﬂd
(
sb
, 
block_group
);

482 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

483 
	`gë_bh
(
bh
);

484 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

485  
bh
;

486 
vîify
:

487 
îr
 = 
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

488 i‡(
îr
)

489 
out
;

490  
bh
;

491 
out
:

492 
	`put_bh
(
bh
);

493  
	`ERR_PTR
(
îr
);

494 
	}
}

497 
	$pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
,

498 
buf„r_hód
 *
bh
)

500 
pxt4_group_desc
 *
desc
;

502 i‡(!
	`buf„r_√w
(
bh
))

504 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

505 i‡(!
desc
)

506  -
EFSCORRUPTED
;

507 
	`waô_⁄_buf„r
(
bh
);

508 i‡(!
	`buf„r_u±od©e
(
bh
)) {

509 
	`pxt4_îr‹
(
sb
, "CannotÑead block bitmap - "

511 
block_group
, (Ë
bh
->
b_blockƒ
);

512 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

513 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

514  -
EIO
;

516 
	`˛ór_buf„r_√w
(
bh
);

518  
	`pxt4_vÆid©e_block_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

519 
	}
}

521 
buf„r_hód
 *

522 
	$pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

524 
buf„r_hód
 *
bh
;

525 
îr
;

527 
bh
 = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
block_group
);

528 i‡(
	`IS_ERR
(
bh
))

529  
bh
;

530 
îr
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
block_group
, 
bh
);

531 i‡(
îr
) {

532 
	`put_bh
(
bh
);

533  
	`ERR_PTR
(
îr
);

535  
bh
;

536 
	}
}

547 
	$pxt4_has_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

548 
s64
 
n˛u°îs
, 
Êags
)

550 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
, 
rsv
, 
ªsv_˛u°îs
;

551 
≥r˝u_cou¡î
 *
fcc
 = &
sbi
->
s_‰ì˛u°îs_cou¡î
;

552 
≥r˝u_cou¡î
 *
dcc
 = &
sbi
->
s_dúty˛u°îs_cou¡î
;

554 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
fcc
);

555 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_ªad_posôive
(
dcc
);

556 
ªsv_˛u°îs
 = 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
);

562 
rsv
 = (
	`pxt4_r_blocks_cou¡
(
sbi
->
s_es
Ë>> sbi->
s_˛u°î_bôs
) +

563 
ªsv_˛u°îs
;

565 i‡(
‰ì_˛u°îs
 - (
n˛u°îs
 + 
rsv
 + 
dúty_˛u°îs
) <

566 
PXT4_FREECLUSTERS_WATERMARK
) {

567 
‰ì_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
fcc
);

568 
dúty_˛u°îs
 = 
	`≥r˝u_cou¡î_sum_posôive
(
dcc
);

573 i‡(
‰ì_˛u°îs
 >(
rsv
 + 
n˛u°îs
 + 
dúty_˛u°îs
))

577 i‡(
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`cuºít_fsuid
()) ||

578 (!
	`gid_eq
(
sbi
->
s_ªsgid
, 
GLOBAL_ROOT_GID
Ë&& 
	`ö_group_p
(sbi->s_resgid)) ||

579 
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
) ||

580 (
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
)) {

582 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
 +

583 
ªsv_˛u°îs
))

587 i‡(
Êags
 & 
PXT4_MB_USE_RESERVED
) {

588 i‡(
‰ì_˛u°îs
 >(
n˛u°îs
 + 
dúty_˛u°îs
))

593 
	}
}

595 
	$pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

596 
s64
 
n˛u°îs
, 
Êags
)

598 i‡(
	`pxt4_has_‰ì_˛u°îs
(
sbi
, 
n˛u°îs
, 
Êags
)) {

599 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
n˛u°îs
);

602  -
ENOSPC
;

603 
	}
}

615 
	$pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
)

617 i‡(!
	`pxt4_has_‰ì_˛u°îs
(
	`PXT4_SB
(
sb
), 1, 0) ||

618 (*
ªåõs
)++ > 1 ||

619 !
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

622 
	`smp_mb
();

623 i‡(
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 == 0)

626 
	`jbd_debug
(1, "%s:Ñëryög o≥øti⁄á·î ENOSPC\n", 
sb
->
s_id
);

627 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

629 
	}
}

643 
pxt4_fsblk_t
 
	$pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

644 
pxt4_fsblk_t
 
gﬂl
, 
Êags
,

645 *
cou¡
, *
îΩ
)

647 
pxt4_Æloˇti⁄_ªque°
 
¨
;

648 
pxt4_fsblk_t
 
ªt
;

650 
	`mem£t
(&
¨
, 0, (ar));

652 
¨
.
öode
 = inode;

653 
¨
.
gﬂl
 = goal;

654 
¨
.
Àn
 = 
cou¡
 ? *count : 1;

655 
¨
.
Êags
 = flags;

657 
ªt
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, 
îΩ
);

658 i‡(
cou¡
)

659 *
cou¡
 = 
¨
.
Àn
;

664 i‡(!(*
îΩ
Ë&& (
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
)) {

665 
	`dquŸ_Æloc_block_noÁû
(
öode
,

666 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
), 
¨
.
Àn
));

668  
ªt
;

669 
	}
}

677 
pxt4_fsblk_t
 
	$pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *
sb
)

679 
pxt4_fsblk_t
 
desc_cou¡
;

680 
pxt4_group_desc
 *
gdp
;

681 
pxt4_group_t
 
i
;

682 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

683 
pxt4_group_öfo
 *
gΩ
;

684 #ifde‡
PXT4FS_DEBUG


685 
pxt4_su≥r_block
 *
es
;

686 
pxt4_fsblk_t
 
bôm≠_cou¡
;

687 
x
;

688 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

690 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

691 
desc_cou¡
 = 0;

692 
bôm≠_cou¡
 = 0;

693 
gdp
 = 
NULL
;

695 
i
 = 0; i < 
ngroups
; i++) {

696 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

697 i‡(!
gdp
)

699 
gΩ
 = 
NULL
;

700 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

701 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

702 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

703 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

704 
	`bªl£
(
bôm≠_bh
);

705 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
i
);

706 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

707 
bôm≠_bh
 = 
NULL
;

711 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

712 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

713 
	`¥ötk
(
KERN_DEBUG
 "group %u: stored = %d, counted = %u\n",

714 
i
, 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
), 
x
);

715 
bôm≠_cou¡
 +
x
;

717 
	`bªl£
(
bôm≠_bh
);

718 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_clusters: stored = %llu"

720 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
), 
	`pxt4_‰ì_blocks_cou¡
(
es
)),

721 
desc_cou¡
, 
bôm≠_cou¡
);

722  
bôm≠_cou¡
;

724 
desc_cou¡
 = 0;

725 
i
 = 0; i < 
ngroups
; i++) {

726 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

727 i‡(!
gdp
)

729 
gΩ
 = 
NULL
;

730 i‡(
	`PXT4_SB
(
sb
)->
s_group_öfo
)

731 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

732 i‡(!
gΩ
 || !
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(grp))

733 
desc_cou¡
 +
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
);

736  
desc_cou¡
;

738 
	}
}

740 
ölöe
 
	$ã°_roŸ
(
pxt4_group_t
 
a
, 
b
)

743 i‡(
a
 < 
b
)

745 i‡(
a
 =
b
)

747 i‡((
a
 % 
b
) != 0)

749 
a
 =á / 
b
;

751 
	}
}

761 
	$pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

763 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

765 i‡(
group
 == 0)

767 i‡(
	`pxt4_has_„©uª_•¨£_su≥r2
(
sb
)) {

768 i‡(
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[0]) ||

769 
group
 =
	`À32_to_˝u
(
es
->
s_backup_bgs
[1]))

773 i‡((
group
 <1Ë|| !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
))

775 i‡(!(
group
 & 1))

777 i‡(
	`ã°_roŸ
(
group
, 3) || (test_root(group, 5)) ||

778 
	`ã°_roŸ
(
group
, 7))

782 
	}
}

784 
	$pxt4_bg_num_gdb_mëa
(
su≥r_block
 *
sb
,

785 
pxt4_group_t
 
group
)

787 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

788 
pxt4_group_t
 
fú°
 = 
mëagroup
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

789 
pxt4_group_t
 
œ°
 = 
fú°
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1;

791 i‡(
group
 =
fú°
 || grou∞=fú° + 1 || grou∞=
œ°
)

794 
	}
}

796 
	$pxt4_bg_num_gdb_nomëa
(
su≥r_block
 *
sb
,

797 
pxt4_group_t
 
group
)

799 i‡(!
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

802 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
))

803  
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

805  
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
;

806 
	}
}

817 
	$pxt4_bg_num_gdb
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

819 
fú°_mëa_bg
 =

820 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_mëa_bg
);

821 
mëagroup
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

823 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
)

824  
	`pxt4_bg_num_gdb_nomëa
(
sb
, 
group
);

826  
	`pxt4_bg_num_gdb_mëa
(
sb
,
group
);

828 
	}
}

834 
	$pxt4_num_ba£_mëa_˛u°îs
(
su≥r_block
 *
sb
,

835 
pxt4_group_t
 
block_group
)

837 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

838 
num
;

841 
num
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
block_group
);

843 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
) ||

844 
block_group
 < 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
) *

845 
sbi
->
s_desc_≥r_block
) {

846 i‡(
num
) {

847 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

848 
num
 +
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

851 
num
 +
	`pxt4_bg_num_gdb
(
sb
, 
block_group
);

853  
	`PXT4_NUM_B2C
(
sbi
, 
num
);

854 
	}
}

862 
pxt4_fsblk_t
 
	$pxt4_öode_to_gﬂl_block
(
öode
 *inode)

864 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

865 
pxt4_group_t
 
block_group
;

866 
pxt4_gΩblk_t
 
cﬁour
;

867 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
öode
->
i_sb
));

868 
pxt4_fsblk_t
 
bg_°¨t
;

869 
pxt4_fsblk_t
 
œ°_block
;

871 
block_group
 = 
ei
->
i_block_group
;

872 i‡(
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) {

881 
block_group
 &~(
Êex_size
-1);

882 i‡(
	`S_ISREG
(
öode
->
i_mode
))

883 
block_group
++;

885 
bg_°¨t
 = 
	`pxt4_group_fú°_block_no
(
öode
->
i_sb
, 
block_group
);

886 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
) - 1;

892 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

893  
bg_°¨t
;

895 i‡(
bg_°¨t
 + 
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
Ë<
œ°_block
)

896 
cﬁour
 = (
cuºít
->
pid
 % 16) *

897 (
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
) / 16);

899 
cﬁour
 = (
cuºít
->
pid
 % 16Ë* ((
œ°_block
 - 
bg_°¨t
) / 16);

900  
bg_°¨t
 + 
cﬁour
;

901 
	}
}

	@bitmap.c

11 
	~<löux/buf„r_hód.h
>

12 
	~"pxt4.h
"

14 
	$pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
)

16  
numch¨s
 * 
BITS_PER_BYTE
 - 
	`memweight
(
bôm≠
,Çumchars);

17 
	}
}

19 
	$pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

20 
pxt4_group_desc
 *
gdp
,

21 
buf„r_hód
 *
bh
, 
sz
)

23 
__u32
 
hi
;

24 
__u32
 
¥ovided
, 
ˇlcuœãd
;

25 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

27 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

30 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_lo
);

31 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

32 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
) {

33 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_öode_bôm≠_csum_hi
);

34 
¥ovided
 |(
hi
 << 16);

36 
ˇlcuœãd
 &= 0xFFFF;

38  
¥ovided
 =
ˇlcuœãd
;

39 
	}
}

41 
	$pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

42 
pxt4_group_desc
 *
gdp
,

43 
buf„r_hód
 *
bh
, 
sz
)

45 
__u32
 
csum
;

46 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

48 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

51 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

52 
gdp
->
bg_öode_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

53 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_INODE_BITMAP_CSUM_HI_END
)

54 
gdp
->
bg_öode_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

55 
	}
}

57 
	$pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

58 
pxt4_group_desc
 *
gdp
,

59 
buf„r_hód
 *
bh
)

61 
__u32
 
hi
;

62 
__u32
 
¥ovided
, 
ˇlcuœãd
;

63 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

64 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

66 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

69 
¥ovided
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_lo
);

70 
ˇlcuœãd
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

71 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
) {

72 
hi
 = 
	`À16_to_˝u
(
gdp
->
bg_block_bôm≠_csum_hi
);

73 
¥ovided
 |(
hi
 << 16);

75 
ˇlcuœãd
 &= 0xFFFF;

77 i‡(
¥ovided
 =
ˇlcuœãd
)

81 
	}
}

83 
	$pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

84 
pxt4_group_desc
 *
gdp
,

85 
buf„r_hód
 *
bh
)

87 
sz
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8;

88 
__u32
 
csum
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

91 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

94 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)
bh
->
b_d©a
, 
sz
);

95 
gdp
->
bg_block_bôm≠_csum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

96 i‡(
sbi
->
s_desc_size
 >
PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
)

97 
gdp
->
bg_block_bôm≠_csum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

98 
	}
}

	@block_validity.c

12 
	~<löux/time.h
>

13 
	~<löux/fs.h
>

14 
	~<löux/«mei.h
>

15 
	~<löux/quŸa›s.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/∑gem≠.h
>

19 
	~<löux/blkdev.h
>

20 
	~<löux/¶ab.h
>

21 
	~"pxt4.h
"

23 
	spxt4_sy°em_z⁄e
 {

24 
rb_node
 
	mnode
;

25 
pxt4_fsblk_t
 
	m°¨t_blk
;

26 
	mcou¡
;

29 
kmem_ˇche
 *
	gpxt4_sy°em_z⁄e_ˇchï
;

31 
__öô
 
	$pxt4_öô_sy°em_z⁄e
()

33 
pxt4_sy°em_z⁄e_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_sy°em_z⁄e
, 0);

34 i‡(
pxt4_sy°em_z⁄e_ˇchï
 =
NULL
)

35  -
ENOMEM
;

37 
	}
}

39 
	$pxt4_exô_sy°em_z⁄e
()

41 
	`kmem_ˇche_de°roy
(
pxt4_sy°em_z⁄e_ˇchï
);

42 
	}
}

44 
ölöe
 
	$ˇn_mîge
(
pxt4_sy°em_z⁄e
 *
íåy1
,

45 
pxt4_sy°em_z⁄e
 *
íåy2
)

47 i‡((
íåy1
->
°¨t_blk
 +É¡ry1->
cou¡
Ë=
íåy2
->start_blk)

50 
	}
}

57 
	$add_sy°em_z⁄e
(
pxt4_sb_öfo
 *
sbi
,

58 
pxt4_fsblk_t
 
°¨t_blk
,

59 
cou¡
)

61 
pxt4_sy°em_z⁄e
 *
√w_íåy
 = 
NULL
, *
íåy
;

62 
rb_node
 **
n
 = &
sbi
->
sy°em_blks
.rb_node, *
node
;

63 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
 = NULL;

65 *
n
) {

66 
∑ª¡
 = *
n
;

67 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_sy°em_z⁄e
, 
node
);

68 i‡(
°¨t_blk
 < 
íåy
->start_blk)

69 
n
 = &(*n)->
rb_À·
;

70 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

71 
n
 = &(*n)->
rb_right
;

73 i‡(
°¨t_blk
 + 
cou¡
 > (
íåy
->start_blk +

74 
íåy
->
cou¡
))

75 
íåy
->
cou¡
 = (
°¨t_blk
 + count -

76 
íåy
->
°¨t_blk
);

77 
√w_node
 = *
n
;

78 
√w_íåy
 = 
	`rb_íåy
(
√w_node
, 
pxt4_sy°em_z⁄e
,

79 
node
);

84 i‡(!
√w_íåy
) {

85 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_sy°em_z⁄e_ˇchï
,

86 
GFP_KERNEL
);

87 i‡(!
√w_íåy
)

88  -
ENOMEM
;

89 
√w_íåy
->
°¨t_blk
 = start_blk;

90 
√w_íåy
->
cou¡
 = count;

91 
√w_node
 = &
√w_íåy
->
node
;

93 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

94 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
sbi
->
sy°em_blks
);

98 
node
 = 
	`rb_¥ev
(
√w_node
);

99 i‡(
node
) {

100 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

101 i‡(
	`ˇn_mîge
(
íåy
, 
√w_íåy
)) {

102 
√w_íåy
->
°¨t_blk
 = 
íåy
->start_blk;

103 
√w_íåy
->
cou¡
 +
íåy
->count;

104 
	`rb_îa£
(
node
, &
sbi
->
sy°em_blks
);

105 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

110 
node
 = 
	`rb_√xt
(
√w_node
);

111 i‡(
node
) {

112 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

113 i‡(
	`ˇn_mîge
(
√w_íåy
, 
íåy
)) {

114 
√w_íåy
->
cou¡
 +
íåy
->count;

115 
	`rb_îa£
(
node
, &
sbi
->
sy°em_blks
);

116 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

120 
	}
}

122 
	$debug_¥öt_åì
(
pxt4_sb_öfo
 *
sbi
)

124 
rb_node
 *
node
;

125 
pxt4_sy°em_z⁄e
 *
íåy
;

126 
fú°
 = 1;

128 
	`¥ötk
(
KERN_INFO
 "System zones: ");

129 
node
 = 
	`rb_fú°
(&
sbi
->
sy°em_blks
);

130 
node
) {

131 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_sy°em_z⁄e
,Çode);

132 
	`¥ötk
(
KERN_CONT
 "%s%Œu-%Œu", 
fú°
 ? "" : ", ",

133 
íåy
->
°¨t_blk
,É¡ry->°¨t_blk +É¡ry->
cou¡
 - 1);

134 
fú°
 = 0;

135 
node
 = 
	`rb_√xt
(node);

137 
	`¥ötk
(
KERN_CONT
 "\n");

138 
	}
}

140 
	$pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
)

142 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

143 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

144 
pxt4_group_desc
 *
gdp
;

145 
pxt4_group_t
 
i
;

146 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

147 
ªt
;

149 i‡(!
	`ã°_›t
(
sb
, 
BLOCK_VALIDITY
)) {

150 i‡(
sbi
->
sy°em_blks
.
rb_node
)

151 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

154 i‡(
sbi
->
sy°em_blks
.
rb_node
)

157 
i
=0; i < 
ngroups
; i++) {

158 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
i
) &&

159 ((
i
 < 5Ë|| ((ò% 
Êex_size
) == 0)))

160 
	`add_sy°em_z⁄e
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
i
),

161 
	`pxt4_bg_num_gdb
(
sb
, 
i
) + 1);

162 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

163 
ªt
 = 
	`add_sy°em_z⁄e
(
sbi
, 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1);

164 i‡(
ªt
)

165  
ªt
;

166 
ªt
 = 
	`add_sy°em_z⁄e
(
sbi
, 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1);

167 i‡(
ªt
)

168  
ªt
;

169 
ªt
 = 
	`add_sy°em_z⁄e
(
sbi
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

170 
sbi
->
s_ôb_≥r_group
);

171 i‡(
ªt
)

172  
ªt
;

175 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

176 
	`debug_¥öt_åì
(
sbi
);

178 
	}
}

181 
	$pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
)

183 
pxt4_sy°em_z⁄e
 *
íåy
, *
n
;

185 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
íåy
, 
n
,

186 &
	`PXT4_SB
(
sb
)->
sy°em_blks
, 
node
)

187 
	`kmem_ˇche_‰ì
(
pxt4_sy°em_z⁄e_ˇchï
, 
íåy
);

189 
	`PXT4_SB
(
sb
)->
sy°em_blks
 = 
RB_ROOT
;

190 
	}
}

197 
	$pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
, 
pxt4_fsblk_t
 
°¨t_blk
,

198 
cou¡
)

200 
pxt4_sy°em_z⁄e
 *
íåy
;

201 
rb_node
 *
n
 = 
sbi
->
sy°em_blks
.rb_node;

203 i‡((
°¨t_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

204 (
°¨t_blk
 + 
cou¡
 < start_blk) ||

205 (
°¨t_blk
 + 
cou¡
 > 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

206 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

209 
n
) {

210 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_sy°em_z⁄e
, 
node
);

211 i‡(
°¨t_blk
 + 
cou¡
 - 1 < 
íåy
->start_blk)

212 
n
 =Ç->
rb_À·
;

213 i‡(
°¨t_blk
 >(
íåy
->°¨t_blk +É¡ry->
cou¡
))

214 
n
 =Ç->
rb_right
;

216 
sbi
->
s_es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
°¨t_blk
);

221 
	}
}

223 
	$pxt4_check_blockªf
(c⁄° *
fun˘i⁄
, 
löe
,

224 
öode
 *öode, 
__À32
 *
p
, 
max
)

226 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

227 
__À32
 *
bªf
 = 
p
;

228 
blk
;

230 
bªf
 < 
p
+
max
) {

231 
blk
 = 
	`À32_to_˝u
(*
bªf
++);

232 i‡(
blk
 &&

233 
	`u∆ikñy
(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

234 
blk
, 1))) {

235 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
blk
);

236 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 
blk
,

238  -
EFSCORRUPTED
;

242 
	}
}

	@dir.c

25 
	~<löux/fs.h
>

26 
	~<löux/buf„r_hód.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/ivîsi⁄.h
>

29 
	~"pxt4.h
"

30 
	~"x©å.h
"

32 
pxt4_dx_ªaddú
(
fûe
 *, 
dú_c⁄ãxt
 *);

41 
	$is_dx_dú
(
öode
 *inode)

43 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

45 i‡(
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
) &&

46 ((
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
)) ||

47 ((
öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
) == 1) ||

48 
	`pxt4_has_ölöe_d©a
(
öode
)))

52 
	}
}

62 
	$__pxt4_check_dú_íåy
(c⁄° *
fun˘i⁄
, 
löe
,

63 
öode
 *
dú
, 
fûe
 *
fûp
,

64 
pxt4_dú_íåy_2
 *
de
,

65 
buf„r_hód
 *
bh
, *
buf
, 
size
,

66 
off£t
)

68 c⁄° *
îr‹_msg
 = 
NULL
;

69 c⁄° 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

70 
dú
->
i_sb
->
s_blocksize
);

72 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(1)))

73 
îr‹_msg
 = "rec_len is smallerÅhan minimal";

74 i‡(
	`u∆ikñy
(
æí
 % 4 != 0))

75 
îr‹_msg
 = "rec_len % 4 != 0";

76 i‡(
	`u∆ikñy
(
æí
 < 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
)))

77 
îr‹_msg
 = "rec_len isÅoo small forÇame_len";

78 i‡(
	`u∆ikñy
(((*Ë
de
 - 
buf
Ë+ 
æí
 > 
size
))

79 
îr‹_msg
 = "directoryÉntry overrun";

80 i‡(
	`u∆ikñy
(
	`À32_to_˝u
(
de
->
öode
) >

81 
	`À32_to_˝u
(
	`PXT4_SB
(
dú
->
i_sb
)->
s_es
->
s_öodes_cou¡
)))

82 
îr‹_msg
 = "inode out of bounds";

86 i‡(
fûp
)

87 
	`pxt4_îr‹_fûe
(
fûp
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

90 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

91 
æí
, 
de
->
«me_Àn
, 
size
);

93 
	`pxt4_îr‹_öode
(
dú
, 
fun˘i⁄
, 
löe
, 
bh
->
b_blockƒ
,

96 
îr‹_msg
, 
off£t
, 
	`À32_to_˝u
(
de
->
öode
),

97 
æí
, 
de
->
«me_Àn
, 
size
);

100 
	}
}

102 
	$pxt4_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

104 
off£t
;

105 
i
;

106 
pxt4_dú_íåy_2
 *
de
;

107 
îr
;

108 
öode
 *öodê
	`fûe_öode
(
fûe
);

109 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

110 
buf„r_hód
 *
bh
 = 
NULL
;

111 
dú_has_îr‹
 = 0;

112 
fs¸y±_°r
 
f°r
 = 
	`FSTR_INIT
(
NULL
, 0);

114 i‡(
	`IS_ENCRYPTED
(
öode
)) {

115 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
);

116 i‡(
îr
 &&Éº !-
ENOKEY
)

117  
îr
;

120 i‡(
	`is_dx_dú
(
öode
)) {

121 
îr
 = 
	`pxt4_dx_ªaddú
(
fûe
, 
˘x
);

122 i‡(
îr
 !
ERR_BAD_DX_DIR
) {

123  
îr
;

129 
	`pxt4_˛ór_öode_Êag
(
	`fûe_öode
(
fûe
),

130 
PXT4_INODE_INDEX
);

133 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

134 
has_ölöe_d©a
 = 1;

135 
îr
 = 
	`pxt4_ªad_ölöe_dú
(
fûe
, 
˘x
,

136 &
has_ölöe_d©a
);

137 i‡(
has_ölöe_d©a
)

138  
îr
;

141 i‡(
	`IS_ENCRYPTED
(
öode
)) {

142 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
öode
, 
PXT4_NAME_LEN
, &
f°r
);

143 i‡(
îr
 < 0)

144  
îr
;

147 
off£t
 = 
˘x
->
pos
 & (
sb
->
s_blocksize
 - 1);

149 
˘x
->
pos
 < 
öode
->
i_size
) {

150 
pxt4_m≠_blocks
 
m≠
;

152 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

153 
îr
 = -
ERESTARTSYS
;

154 
îrout
;

156 
	`c⁄d_ªsched
();

157 
m≠
.
m_lblk
 = 
˘x
->
pos
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

158 
m≠
.
m_Àn
 = 1;

159 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

160 i‡(
îr
 > 0) {

161 
pgoff_t
 
ödex
 = 
m≠
.
m_pblk
 >>

162 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

163 i‡(!
	`ø_has_ödex
(&
fûe
->
f_ø
, 
ödex
))

164 
	`∑ge_ˇche_sync_ªadahód
(

165 
sb
->
s_bdev
->
bd_öode
->
i_m≠pög
,

166 &
fûe
->
f_ø
, file,

167 
ödex
, 1);

168 
fûe
->
f_ø
.
¥ev_pos
 = (
loff_t
)
ödex
 << 
PAGE_SHIFT
;

169 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
m≠
.
m_lblk
, 0);

170 i‡(
	`IS_ERR
(
bh
)) {

171 
îr
 = 
	`PTR_ERR
(
bh
);

172 
bh
 = 
NULL
;

173 
îrout
;

177 i‡(!
bh
) {

178 i‡(!
dú_has_îr‹
) {

179 
	`PXT4_ERROR_FILE
(
fûe
, 0,

182 (Ë
˘x
->
pos
);

183 
dú_has_îr‹
 = 1;

186 i‡(
˘x
->
pos
 > 
öode
->
i_blocks
 << 9)

188 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

193 i‡(!
	`buf„r_vîifõd
(
bh
) &&

194 !
	`pxt4_dúít_csum_vîify
(
öode
,

195 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
)) {

196 
	`PXT4_ERROR_FILE
(
fûe
, 0, "directory fails checksum "

198 ()
˘x
->
pos
);

199 
˘x
->
pos
 +
sb
->
s_blocksize
 - 
off£t
;

200 
	`bªl£
(
bh
);

201 
bh
 = 
NULL
;

204 
	`£t_buf„r_vîifõd
(
bh
);

210 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

211 
i
 = 0; i < 
sb
->
s_blocksize
 && i < 
off£t
; ) {

212 
de
 = (
pxt4_dú_íåy_2
 *)

213 (
bh
->
b_d©a
 + 
i
);

220 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

221 
sb
->
s_blocksize
Ë< 
	`PXT4_DIR_REC_LEN
(1))

223 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

224 
sb
->
s_blocksize
);

226 
off£t
 = 
i
;

227 
˘x
->
pos
 = (˘x->po†& ~(
sb
->
s_blocksize
 - 1))

228 | 
off£t
;

229 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

232 
˘x
->
pos
 < 
öode
->
i_size


233 && 
off£t
 < 
sb
->
s_blocksize
) {

234 
de
 = (
pxt4_dú_íåy_2
 *Ë(
bh
->
b_d©a
 + 
off£t
);

235 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
bh
,

236 
bh
->
b_d©a
, bh->
b_size
,

237 
off£t
)) {

241 
˘x
->
pos
 = (ctx->pos |

242 (
sb
->
s_blocksize
 - 1)) + 1;

245 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

246 
sb
->
s_blocksize
);

247 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

248 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

249 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
,

250 
de
->
«me_Àn
,

251 
	`À32_to_˝u
(
de
->
öode
),

252 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

253 
d⁄e
;

255 
ßve_Àn
 = 
f°r
.
Àn
;

256 
fs¸y±_°r
 
de_«me
 =

257 
	`FSTR_INIT
(
de
->
«me
,

258 
de
->
«me_Àn
);

261 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
öode
,

262 0, 0, &
de_«me
, &
f°r
);

263 
de_«me
 = 
f°r
;

264 
f°r
.
Àn
 = 
ßve_Àn
;

265 i‡(
îr
)

266 
îrout
;

267 i‡(!
	`dú_emô
(
˘x
,

268 
de_«me
.
«me
, de_«me.
Àn
,

269 
	`À32_to_˝u
(
de
->
öode
),

270 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

271 
d⁄e
;

274 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

275 
sb
->
s_blocksize
);

277 i‡((
˘x
->
pos
 < 
öode
->
i_size
Ë&& !
	`dú_ªœx_sh¨ed
(inode))

278 
d⁄e
;

279 
	`bªl£
(
bh
);

280 
bh
 = 
NULL
;

281 
off£t
 = 0;

283 
d⁄e
:

284 
îr
 = 0;

285 
îrout
:

286 
	`fs¸y±_‚ame_‰ì_buf„r
(&
f°r
);

287 
	`bªl£
(
bh
);

288  
îr
;

289 
	}
}

291 
ölöe
 
	$is_32bô_≠i
()

293 #ifde‡
CONFIG_COMPAT


294  
	`ö_com∑t_sysˇŒ
();

296  (
BITS_PER_LONG
 == 32);

298 
	}
}

309 
ölöe
 
loff_t
 
	$hash2pos
(
fûe
 *
fûp
, 
__u32
 
maj‹
, __u32 
mö‹
)

311 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

312 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

313  
maj‹
 >> 1;

315  ((
__u64
)(
maj‹
 >> 1Ë<< 32Ë| (__u64)
mö‹
;

316 
	}
}

318 
ölöe
 
__u32
 
	$pos2maj_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

320 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

321 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

322  (
pos
 << 1) & 0xffffffff;

324  ((
pos
 >> 32) << 1) & 0xffffffff;

325 
	}
}

327 
ölöe
 
__u32
 
	$pos2mö_hash
(
fûe
 *
fûp
, 
loff_t
 
pos
)

329 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

330 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

333  
pos
 & 0xffffffff;

334 
	}
}

339 
ölöe
 
loff_t
 
	$pxt4_gë_håì_eof
(
fûe
 *
fûp
)

341 i‡((
fûp
->
f_mode
 & 
FMODE_32BITHASH
) ||

342 (!(
fûp
->
f_mode
 & 
FMODE_64BITHASH
Ë&& 
	`is_32bô_≠i
()))

343  
PXT4_HTREE_EOF_32BIT
;

345  
PXT4_HTREE_EOF_64BIT
;

346 
	}
}

360 
loff_t
 
	$pxt4_dú_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

362 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

363 
dx_dú
 = 
	`is_dx_dú
(
öode
);

364 
loff_t
 
ªt
, 
håì_max
 = 
	`pxt4_gë_håì_eof
(
fûe
);

366 i‡(
	`likñy
(
dx_dú
))

367 
ªt
 = 
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

368 
håì_max
, htree_max);

370 
ªt
 = 
	`pxt4_Œ£ek
(
fûe
, 
off£t
, 
whí˚
);

371 
fûe
->
f_vîsi⁄
 = 
	`öode_≥ek_ivîsi⁄
(
öode
) - 1;

372  
ªt
;

373 
	}
}

379 
	s‚ame
 {

380 
__u32
 
	mhash
;

381 
__u32
 
	mmö‹_hash
;

382 
rb_node
 
	mrb_hash
;

383 
‚ame
 *
	m√xt
;

384 
__u32
 
	möode
;

385 
__u8
 
	m«me_Àn
;

386 
__u8
 
	mfûe_ty≥
;

387 
	m«me
[0];

394 
	$‰ì_rb_åì_‚ame
(
rb_roŸ
 *
roŸ
)

396 
‚ame
 *‚ame, *
√xt
;

398 
	`rbåì_po°‹dî_f‹_óch_íåy_ß„
(
‚ame
, 
√xt
, 
roŸ
, 
rb_hash
)

399 
‚ame
) {

400 
‚ame
 *
ﬁd
 = fname;

401 
‚ame
 = f«me->
√xt
;

402 
	`k‰ì
(
ﬁd
);

405 *
roŸ
 = 
RB_ROOT
;

406 
	}
}

409 
dú_¥iv©e_öfo
 *
	$pxt4_håì_¸óã_dú_öfo
(
fûe
 *
fûp
,

410 
loff_t
 
pos
)

412 
dú_¥iv©e_öfo
 *
p
;

414 
p
 = 
	`kzÆloc
((*p), 
GFP_KERNEL
);

415 i‡(!
p
)

416  
NULL
;

417 
p
->
cuº_hash
 = 
	`pos2maj_hash
(
fûp
, 
pos
);

418 
p
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûp
, 
pos
);

419  
p
;

420 
	}
}

422 
	$pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
)

424 
	`‰ì_rb_åì_‚ame
(&
p
->
roŸ
);

425 
	`k‰ì
(
p
);

426 
	}
}

435 
	$pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

436 
__u32
 
mö‹_hash
,

437 
pxt4_dú_íåy_2
 *
dúít
,

438 
fs¸y±_°r
 *
ít_«me
)

440 
rb_node
 **
p
, *
∑ª¡
 = 
NULL
;

441 
‚ame
 *‚ame, *
√w_‚
;

442 
dú_¥iv©e_öfo
 *
öfo
;

443 
Àn
;

445 
öfo
 = 
dú_fûe
->
¥iv©e_d©a
;

446 
p
 = &
öfo
->
roŸ
.
rb_node
;

449 
Àn
 = (
‚ame
Ë+ 
ít_«me
->len + 1;

450 
√w_‚
 = 
	`kzÆloc
(
Àn
, 
GFP_KERNEL
);

451 i‡(!
√w_‚
)

452  -
ENOMEM
;

453 
√w_‚
->
hash
 = hash;

454 
√w_‚
->
mö‹_hash
 = minor_hash;

455 
√w_‚
->
öode
 = 
	`À32_to_˝u
(
dúít
->inode);

456 
√w_‚
->
«me_Àn
 = 
ít_«me
->
Àn
;

457 
√w_‚
->
fûe_ty≥
 = 
dúít
->file_type;

458 
	`mem˝y
(
√w_‚
->
«me
, 
ít_«me
->«me,É¡_«me->
Àn
);

459 
√w_‚
->
«me
[
ít_«me
->
Àn
] = 0;

461 *
p
) {

462 
∑ª¡
 = *
p
;

463 
‚ame
 = 
	`rb_íåy
(
∑ª¡
, ‚ame, 
rb_hash
);

469 i‡((
√w_‚
->
hash
 =
‚ame
->hash) &&

470 (
√w_‚
->
mö‹_hash
 =
‚ame
->minor_hash)) {

471 
√w_‚
->
√xt
 = 
‚ame
->next;

472 
‚ame
->
√xt
 = 
√w_‚
;

476 i‡(
√w_‚
->
hash
 < 
‚ame
->hash)

477 
p
 = &(*p)->
rb_À·
;

478 i‡(
√w_‚
->
hash
 > 
‚ame
->hash)

479 
p
 = &(*p)->
rb_right
;

480 i‡(
√w_‚
->
mö‹_hash
 < 
‚ame
->minor_hash)

481 
p
 = &(*p)->
rb_À·
;

483 
p
 = &(*p)->
rb_right
;

486 
	`rb_lök_node
(&
√w_‚
->
rb_hash
, 
∑ª¡
, 
p
);

487 
	`rb_ö£π_cﬁ‹
(&
√w_‚
->
rb_hash
, &
öfo
->
roŸ
);

489 
	}
}

498 
	$ˇŒ_fûldú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
,

499 
‚ame
 *fname)

501 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

502 
öode
 *öodê
	`fûe_öode
(
fûe
);

503 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

505 i‡(!
‚ame
) {

506 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: comm %s: "

507 "ˇŒed wôhÇuŒ f«me?!?", 
__func__
, 
__LINE__
,

508 
öode
->
i_öo
, 
cuºít
->
comm
);

511 
˘x
->
pos
 = 
	`hash2pos
(
fûe
, 
‚ame
->
hash
, f«me->
mö‹_hash
);

512 
‚ame
) {

513 i‡(!
	`dú_emô
(
˘x
, 
‚ame
->
«me
,

514 
‚ame
->
«me_Àn
,

515 
‚ame
->
öode
,

516 
	`gë_dty≥
(
sb
, 
‚ame
->
fûe_ty≥
))) {

517 
öfo
->
exåa_‚ame
 = 
‚ame
;

520 
‚ame
 = f«me->
√xt
;

523 
	}
}

525 
	$pxt4_dx_ªaddú
(
fûe
 *fûe, 
dú_c⁄ãxt
 *
˘x
)

527 
dú_¥iv©e_öfo
 *
öfo
 = 
fûe
->
¥iv©e_d©a
;

528 
öode
 *öodê
	`fûe_öode
(
fûe
);

529 
‚ame
 *fname;

530 
ªt
;

532 i‡(!
öfo
) {

533 
öfo
 = 
	`pxt4_håì_¸óã_dú_öfo
(
fûe
, 
˘x
->
pos
);

534 i‡(!
öfo
)

535  -
ENOMEM
;

536 
fûe
->
¥iv©e_d©a
 = 
öfo
;

539 i‡(
˘x
->
pos
 =
	`pxt4_gë_håì_eof
(
fûe
))

543 i‡(
öfo
->
œ°_pos
 !
˘x
->
pos
) {

544 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

545 
öfo
->
cuº_node
 = 
NULL
;

546 
öfo
->
exåa_‚ame
 = 
NULL
;

547 
öfo
->
cuº_hash
 = 
	`pos2maj_hash
(
fûe
, 
˘x
->
pos
);

548 
öfo
->
cuº_mö‹_hash
 = 
	`pos2mö_hash
(
fûe
, 
˘x
->
pos
);

555 i‡(
öfo
->
exåa_‚ame
) {

556 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
öfo
->
exåa_‚ame
))

557 
föished
;

558 
öfo
->
exåa_‚ame
 = 
NULL
;

559 
√xt_node
;

560 } i‡(!
öfo
->
cuº_node
)

561 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

569 i‡((!
öfo
->
cuº_node
) ||

570 !
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

571 
öfo
->
cuº_node
 = 
NULL
;

572 
	`‰ì_rb_åì_‚ame
(&
öfo
->
roŸ
);

573 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

574 
ªt
 = 
	`pxt4_håì_fûl_åì
(
fûe
, 
öfo
->
cuº_hash
,

575 
öfo
->
cuº_mö‹_hash
,

576 &
öfo
->
√xt_hash
);

577 i‡(
ªt
 < 0)

578  
ªt
;

579 i‡(
ªt
 == 0) {

580 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

583 
öfo
->
cuº_node
 = 
	`rb_fú°
(&öfo->
roŸ
);

586 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, ‚ame, 
rb_hash
);

587 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

588 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

589 i‡(
	`ˇŒ_fûldú
(
fûe
, 
˘x
, 
‚ame
))

591 
√xt_node
:

592 
öfo
->
cuº_node
 = 
	`rb_√xt
(info->curr_node);

593 i‡(
öfo
->
cuº_node
) {

594 
‚ame
 = 
	`rb_íåy
(
öfo
->
cuº_node
, fname,

595 
rb_hash
);

596 
öfo
->
cuº_hash
 = 
‚ame
->
hash
;

597 
öfo
->
cuº_mö‹_hash
 = 
‚ame
->
mö‹_hash
;

599 i‡(
öfo
->
√xt_hash
 == ~0) {

600 
˘x
->
pos
 = 
	`pxt4_gë_håì_eof
(
fûe
);

603 
öfo
->
cuº_hash
 = info->
√xt_hash
;

604 
öfo
->
cuº_mö‹_hash
 = 0;

607 
föished
:

608 
öfo
->
œ°_pos
 = 
˘x
->
pos
;

610 
	}
}

612 
	$pxt4_dú_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

614 i‡(
	`IS_ENCRYPTED
(
öode
))

615  
	`fs¸y±_gë_í¸y±i⁄_öfo
(
öode
Ë? -
EACCES
 : 0;

617 
	}
}

619 
	$pxt4_ªÀa£_dú
(
öode
 *öode, 
fûe
 *
fûp
)

621 i‡(
fûp
->
¥iv©e_d©a
)

622 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

625 
	}
}

627 
	$pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
, *
buf
,

628 
buf_size
)

630 
pxt4_dú_íåy_2
 *
de
;

631 
æí
;

632 
off£t
 = 0;

633 *
t›
;

635 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

636 
t›
 = 
buf
 + 
buf_size
;

637 (*Ë
de
 < 
t›
) {

638 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

639 
buf
, 
buf_size
, 
off£t
))

640  -
EFSCORRUPTED
;

641 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

642 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

643 
off£t
 +
æí
;

645 i‡((*Ë
de
 > 
t›
)

646  -
EFSCORRUPTED
;

649 
	}
}

651 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_dú_›î©i⁄s
 = {

652 .
Œ£ek
 = 
pxt4_dú_Œ£ek
,

653 .
	gªad
 = 
gíîic_ªad_dú
,

654 .
	gôî©e_sh¨ed
 = 
pxt4_ªaddú
,

655 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

656 #ifde‡
CONFIG_COMPAT


657 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

659 .
	gfsync
 = 
pxt4_sync_fûe
,

660 .
	g›í
 = 
pxt4_dú_›í
,

661 .
	gªÀa£
 = 
pxt4_ªÀa£_dú
,

	@extents.c

20 
	~<löux/fs.h
>

21 
	~<löux/time.h
>

22 
	~<löux/jbd3.h
>

23 
	~<löux/highuid.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/quŸa›s.h
>

26 
	~<löux/°rög.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/uac˚ss.h
>

29 
	~<löux/fõm≠.h
>

30 
	~<löux/backög-dev.h
>

31 
	~"pxt4_jbd3.h
"

32 
	~"pxt4_exã¡s.h
"

33 
	~"x©å.h
"

35 
	~<åa˚/evíts/pxt4.h
>

40 
	#PXT4_EXT_MAY_ZEROOUT
 0x1

	)

42 
	#PXT4_EXT_MARK_UNWRIT1
 0x2

	)

43 
	#PXT4_EXT_MARK_UNWRIT2
 0x4

	)

45 
	#PXT4_EXT_DATA_VALID1
 0x8

	)

46 
	#PXT4_EXT_DATA_VALID2
 0x10

	)

48 
__À32
 
	$pxt4_exã¡_block_csum
(
öode
 *inode,

49 
pxt4_exã¡_hódî
 *
eh
)

51 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

52 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

53 
__u32
 
csum
;

55 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
eh
,

56 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

57  
	`˝u_to_À32
(
csum
);

58 
	}
}

60 
	$pxt4_exã¡_block_csum_vîify
(
öode
 *inode,

61 
pxt4_exã¡_hódî
 *
eh
)

63 
pxt4_exã¡_èû
 *
ë
;

65 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

68 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

69 i‡(
ë
->
ë_checksum
 !
	`pxt4_exã¡_block_csum
(
öode
, 
eh
))

72 
	}
}

74 
	$pxt4_exã¡_block_csum_£t
(
öode
 *inode,

75 
pxt4_exã¡_hódî
 *
eh
)

77 
pxt4_exã¡_èû
 *
ë
;

79 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

82 
ë
 = 
	`föd_pxt4_exã¡_èû
(
eh
);

83 
ë
->
ë_checksum
 = 
	`pxt4_exã¡_block_csum
(
öode
, 
eh
);

84 
	}
}

86 
pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

87 
öode
 *inode,

88 
pxt4_ext_∑th
 **
µ©h
,

89 
pxt4_m≠_blocks
 *
m≠
,

90 
•lô_Êag
,

91 
Êags
);

93 
pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

94 
öode
 *inode,

95 
pxt4_ext_∑th
 **
µ©h
,

96 
pxt4_lblk_t
 
•lô
,

97 
•lô_Êag
,

98 
Êags
);

100 
pxt4_föd_dñayed_exã¡
(
öode
 *inode,

101 
exã¡_°©us
 *
√wes
);

103 
	$pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ_t
 *
h™dÀ
,

104 
öode
 *inode,

105 
√eded
)

107 
îr
;

109 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

111 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
√eded
)

117 
√eded
 += 3;

118 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
 - h™dÀ->
h_buf„r_¸edôs
);

119 i‡(
îr
 <= 0)

120  
îr
;

121 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
, 
√eded
);

122 i‡(
îr
 == 0)

123 
îr
 = -
EAGAIN
;

125  
îr
;

126 
	}
}

133 
	$pxt4_ext_gë_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

134 
pxt4_ext_∑th
 *
∑th
)

136 i‡(
∑th
->
p_bh
) {

138 
	`BUFFER_TRACE
(
∑th
->
p_bh
, "get_write_access");

139  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
∑th
->
p_bh
);

144 
	}
}

152 
	$__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

153 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

155 
îr
;

157 
	`WARN_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

158 i‡(
∑th
->
p_bh
) {

159 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
	`ext_block_hdr
(
∑th
->
p_bh
));

161 
îr
 = 
	`__pxt4_h™dÀ_dúty_mëad©a
(
whîe
, 
löe
, 
h™dÀ
,

162 
öode
, 
∑th
->
p_bh
);

165 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

167  
îr
;

168 
	}
}

170 
pxt4_fsblk_t
 
	$pxt4_ext_föd_gﬂl
(
öode
 *inode,

171 
pxt4_ext_∑th
 *
∑th
,

172 
pxt4_lblk_t
 
block
)

174 i‡(
∑th
) {

175 
dïth
 = 
∑th
->
p_dïth
;

176 
pxt4_exã¡
 *
ex
;

195 
ex
 = 
∑th
[
dïth
].
p_ext
;

196 i‡(
ex
) {

197 
pxt4_fsblk_t
 
ext_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

198 
pxt4_lblk_t
 
ext_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

200 i‡(
block
 > 
ext_block
)

201  
ext_pblk
 + (
block
 - 
ext_block
);

203  
ext_pblk
 - (
ext_block
 - 
block
);

208 i‡(
∑th
[
dïth
].
p_bh
)

209  
∑th
[
dïth
].
p_bh
->
b_blockƒ
;

213  
	`pxt4_öode_to_gﬂl_block
(
öode
);

214 
	}
}

219 
pxt4_fsblk_t


220 
	$pxt4_ext_√w_mëa_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

221 
pxt4_ext_∑th
 *
∑th
,

222 
pxt4_exã¡
 *
ex
, *
îr
, 
Êags
)

224 
pxt4_fsblk_t
 
gﬂl
, 
√wblock
;

226 
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
	`À32_to_˝u
(
ex
->
ì_block
));

227 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

228 
NULL
, 
îr
);

229  
√wblock
;

230 
	}
}

232 
ölöe
 
	$pxt4_ext_•a˚_block
(
öode
 *öode, 
check
)

234 
size
;

236 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

237 / (
pxt4_exã¡
);

238 #ifde‡
AGGRESSIVE_TEST


239 i‡(!
check
 && 
size
 > 6)

240 
size
 = 6;

242  
size
;

243 
	}
}

245 
ölöe
 
	$pxt4_ext_•a˚_block_idx
(
öode
 *öode, 
check
)

247 
size
;

249 
size
 = (
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

250 / (
pxt4_exã¡_idx
);

251 #ifde‡
AGGRESSIVE_TEST


252 i‡(!
check
 && 
size
 > 5)

253 
size
 = 5;

255  
size
;

256 
	}
}

258 
ölöe
 
	$pxt4_ext_•a˚_roŸ
(
öode
 *öode, 
check
)

260 
size
;

262 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

263 
size
 -(
pxt4_exã¡_hódî
);

264 
size
 /(
pxt4_exã¡
);

265 #ifde‡
AGGRESSIVE_TEST


266 i‡(!
check
 && 
size
 > 3)

267 
size
 = 3;

269  
size
;

270 
	}
}

272 
ölöe
 
	$pxt4_ext_•a˚_roŸ_idx
(
öode
 *öode, 
check
)

274 
size
;

276 
size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

277 
size
 -(
pxt4_exã¡_hódî
);

278 
size
 /(
pxt4_exã¡_idx
);

279 #ifde‡
AGGRESSIVE_TEST


280 i‡(!
check
 && 
size
 > 4)

281 
size
 = 4;

283  
size
;

284 
	}
}

286 
ölöe
 

287 
	$pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

288 
pxt4_ext_∑th
 **
µ©h
, 
pxt4_lblk_t
 
lblk
,

289 
noÁû
)

291 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

292 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
∑th
[∑th->
p_dïth
].
p_ext
);

294  
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
, 
lblk
, 
unwrôãn
 ?

295 
PXT4_EXT_MARK_UNWRIT1
|
PXT4_EXT_MARK_UNWRIT2
 : 0,

296 
PXT4_EX_NOCACHE
 | 
PXT4_GET_BLOCKS_PRE_IO
 |

297 (
noÁû
 ? 
PXT4_GET_BLOCKS_METADATA_NOFAIL
:0));

298 
	}
}

305 
	$pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
)

307 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

308 
idxs
;

310 
idxs
 = ((
öode
->
i_sb
->
s_blocksize
 - (
pxt4_exã¡_hódî
))

311 / (
pxt4_exã¡_idx
));

321 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

322 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
+1 =
lblock
) {

323 
num
 = 0;

325 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % 
idxs
) == 0)

326 
num
++;

327 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs)) == 0)

328 
num
++;

329 i‡((
ei
->
i_da_mëad©a_ˇlc_Àn
 % (
idxs
*idxs*idxs)) == 0) {

330 
num
++;

331 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

333 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

334 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
++;

335  
num
;

342 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

343 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
;

344  
	`ext_dïth
(
öode
) + 1;

345 
	}
}

348 
	$pxt4_ext_max_íåõs
(
öode
 *öode, 
dïth
)

350 
max
;

352 i‡(
dïth
 =
	`ext_dïth
(
öode
)) {

353 i‡(
dïth
 == 0)

354 
max
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 1);

356 
max
 = 
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 1);

358 i‡(
dïth
 == 0)

359 
max
 = 
	`pxt4_ext_•a˚_block
(
öode
, 1);

361 
max
 = 
	`pxt4_ext_•a˚_block_idx
(
öode
, 1);

364  
max
;

365 
	}
}

367 
	$pxt4_vÆid_exã¡
(
öode
 *öode, 
pxt4_exã¡
 *
ext
)

369 
pxt4_fsblk_t
 
block
 = 
	`pxt4_ext_pblock
(
ext
);

370 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

371 
pxt4_lblk_t
 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

378 i‡(
lblock
 + 
Àn
 <=Üblock)

380  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 
Àn
);

381 
	}
}

383 
	$pxt4_vÆid_exã¡_idx
(
öode
 *inode,

384 
pxt4_exã¡_idx
 *
ext_idx
)

386 
pxt4_fsblk_t
 
block
 = 
	`pxt4_idx_pblock
(
ext_idx
);

388  
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block
, 1);

389 
	}
}

391 
	$pxt4_vÆid_exã¡_íåõs
(
öode
 *inode,

392 
pxt4_exã¡_hódî
 *
eh
,

393 
dïth
)

395 
íåõs
;

396 i‡(
eh
->
eh_íåõs
 == 0)

399 
íåõs
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
);

401 i‡(
dïth
 == 0) {

403 
pxt4_exã¡
 *
ext
 = 
	`EXT_FIRST_EXTENT
(
eh
);

404 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

405 
pxt4_fsblk_t
 
pblock
 = 0;

406 
pxt4_lblk_t
 
lblock
 = 0;

407 
pxt4_lblk_t
 
¥ev
 = 0;

408 
Àn
 = 0;

409 
íåõs
) {

410 i‡(!
	`pxt4_vÆid_exã¡
(
öode
, 
ext
))

414 
lblock
 = 
	`À32_to_˝u
(
ext
->
ì_block
);

415 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

416 i‡((
lblock
 <
¥ev
) &&Örev) {

417 
pblock
 = 
	`pxt4_ext_pblock
(
ext
);

418 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
pblock
);

421 
ext
++;

422 
íåõs
--;

423 
¥ev
 = 
lblock
 + 
Àn
 - 1;

426 
pxt4_exã¡_idx
 *
ext_idx
 = 
	`EXT_FIRST_INDEX
(
eh
);

427 
íåõs
) {

428 i‡(!
	`pxt4_vÆid_exã¡_idx
(
öode
, 
ext_idx
))

430 
ext_idx
++;

431 
íåõs
--;

435 
	}
}

437 
	$__pxt4_ext_check
(c⁄° *
fun˘i⁄
, 
löe
,

438 
öode
 *öode, 
pxt4_exã¡_hódî
 *
eh
,

439 
dïth
, 
pxt4_fsblk_t
 
pblk
)

441 c⁄° *
îr‹_msg
;

442 
max
 = 0, 
îr
 = -
EFSCORRUPTED
;

444 i‡(
	`u∆ikñy
(
eh
->
eh_magic
 !
PXT4_EXT_MAGIC
)) {

445 
îr‹_msg
 = "invalid magic";

446 
c‹ru±ed
;

448 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_dïth
Ë!
dïth
)) {

449 
îr‹_msg
 = "unexpectedÉh_depth";

450 
c‹ru±ed
;

452 i‡(
	`u∆ikñy
(
eh
->
eh_max
 == 0)) {

453 
îr‹_msg
 = "invalidÉh_max";

454 
c‹ru±ed
;

456 
max
 = 
	`pxt4_ext_max_íåõs
(
öode
, 
dïth
);

457 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_max
Ë> 
max
)) {

458 
îr‹_msg
 = "tooÜargeÉh_max";

459 
c‹ru±ed
;

461 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë>Üe16_to_˝u”h->
eh_max
))) {

462 
îr‹_msg
 = "invalidÉh_entries";

463 
c‹ru±ed
;

465 i‡(!
	`pxt4_vÆid_exã¡_íåõs
(
öode
, 
eh
, 
dïth
)) {

466 
îr‹_msg
 = "invalidÉxtentÉntries";

467 
c‹ru±ed
;

469 i‡(
	`u∆ikñy
(
dïth
 > 32)) {

470 
îr‹_msg
 = "tooÜargeÉh_depth";

471 
c‹ru±ed
;

474 i‡(
	`ext_dïth
(
öode
Ë!
dïth
 &&

475 !
	`pxt4_exã¡_block_csum_vîify
(
öode
, 
eh
)) {

476 
îr‹_msg
 = "extentÅree corrupted";

477 
îr
 = -
EFSBADCRC
;

478 
c‹ru±ed
;

482 
c‹ru±ed
:

483 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

486 (Ë
pblk
, 
îr‹_msg
,

487 
	`À16_to_˝u
(
eh
->
eh_magic
),

488 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
),

489 
max
, 
	`À16_to_˝u
(
eh
->
eh_dïth
), 
dïth
);

490  
îr
;

491 
	}
}

493 
	#pxt4_ext_check
(
öode
, 
eh
, 
dïth
, 
pblk
) \

494 
	`__pxt4_ext_check
(
__func__
, 
__LINE__
, (
öode
), (
eh
), (
dïth
), (
pblk
))

	)

496 
	$pxt4_ext_check_öode
(
öode
 *inode)

498  
	`pxt4_ext_check
(
öode
, 
	`ext_öode_hdr
(öode), 
	`ext_dïth
(inode), 0);

499 
	}
}

501 
buf„r_hód
 *

502 
	$__ªad_exã¡_åì_block
(c⁄° *
fun˘i⁄
, 
löe
,

503 
öode
 *öode, 
pxt4_fsblk_t
 
pblk
, 
dïth
,

504 
Êags
)

506 
buf„r_hód
 *
bh
;

507 
îr
;

509 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
pblk
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

510 i‡(
	`u∆ikñy
(!
bh
))

511  
	`ERR_PTR
(-
ENOMEM
);

513 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

514 
	`åa˚_pxt4_ext_lﬂd_exã¡
(
öode
, 
pblk
, 
_RET_IP_
);

515 
îr
 = 
	`bh_submô_ªad
(
bh
);

516 i‡(
îr
 < 0)

517 
îrout
;

519 i‡(
	`buf„r_vîifõd
(
bh
Ë&& !(
Êags
 & 
PXT4_EX_FORCE_CACHE
))

520  
bh
;

521 
îr
 = 
	`__pxt4_ext_check
(
fun˘i⁄
, 
löe
, 
öode
,

522 
	`ext_block_hdr
(
bh
), 
dïth
, 
pblk
);

523 i‡(
îr
)

524 
îrout
;

525 
	`£t_buf„r_vîifõd
(
bh
);

529 i‡(!(
Êags
 & 
PXT4_EX_NOCACHE
Ë&& 
dïth
 == 0) {

530 
pxt4_exã¡_hódî
 *
eh
 = 
	`ext_block_hdr
(
bh
);

531 
pxt4_exã¡
 *
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

532 
pxt4_lblk_t
 
¥ev
 = 0;

533 
i
;

535 
i
 = 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i > 0; i--, 
ex
++) {

536 
°©us
 = 
EXTENT_STATUS_WRITTEN
;

537 
pxt4_lblk_t
 
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

538 
Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

540 i‡(
¥ev
 && (¥ev !
lblk
))

541 
	`pxt4_es_ˇche_exã¡
(
öode
, 
¥ev
,

542 
lblk
 - 
¥ev
, ~0,

543 
EXTENT_STATUS_HOLE
);

545 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

546 
°©us
 = 
EXTENT_STATUS_UNWRITTEN
;

547 
	`pxt4_es_ˇche_exã¡
(
öode
, 
lblk
, 
Àn
,

548 
	`pxt4_ext_pblock
(
ex
), 
°©us
);

549 
¥ev
 = 
lblk
 + 
Àn
;

552  
bh
;

553 
îrout
:

554 
	`put_bh
(
bh
);

555  
	`ERR_PTR
(
îr
);

557 
	}
}

559 
	#ªad_exã¡_åì_block
(
öode
, 
pblk
, 
dïth
, 
Êags
) \

560 
	`__ªad_exã¡_åì_block
(
__func__
, 
__LINE__
, (
öode
), (
pblk
), \

561 (
dïth
), (
Êags
))

	)

567 
	$pxt4_ext_¥eˇche
(
öode
 *inode)

569 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

570 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

571 
buf„r_hód
 *
bh
;

572 
i
 = 0, 
dïth
, 
ªt
 = 0;

574 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

577 
	`down_ªad
(&
ei
->
i_d©a_£m
);

578 
dïth
 = 
	`ext_dïth
(
öode
);

580 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

581 
GFP_NOFS
);

582 i‡(
∑th
 =
NULL
) {

583 
	`up_ªad
(&
ei
->
i_d©a_£m
);

584  -
ENOMEM
;

588 i‡(
dïth
 == 0)

589 
out
;

590 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

591 
ªt
 = 
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0);

592 i‡(
ªt
)

593 
out
;

594 
∑th
[0].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[0].
p_hdr
);

595 
i
 >= 0) {

600 i‡((
i
 =
dïth
) ||

601 
∑th
[
i
].
p_idx
 > 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
)) {

602 
	`bªl£
(
∑th
[
i
].
p_bh
);

603 
∑th
[
i
].
p_bh
 = 
NULL
;

604 
i
--;

607 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

608 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
++),

609 
dïth
 - 
i
 - 1,

610 
PXT4_EX_FORCE_CACHE
);

611 i‡(
	`IS_ERR
(
bh
)) {

612 
ªt
 = 
	`PTR_ERR
(
bh
);

615 
i
++;

616 
∑th
[
i
].
p_bh
 = 
bh
;

617 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
(
bh
);

618 
∑th
[
i
].
p_idx
 = 
	`EXT_FIRST_INDEX
’©h[i].
p_hdr
);

620 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
);

621 
out
:

622 
	`up_ªad
(&
ei
->
i_d©a_£m
);

623 
	`pxt4_ext_dr›_ªfs
(
∑th
);

624 
	`k‰ì
(
∑th
);

625  
ªt
;

626 
	}
}

628 #ifde‡
EXT_DEBUG


629 
	$pxt4_ext_show_∑th
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

631 
k
, 
l
 = 
∑th
->
p_dïth
;

633 
	`ext_debug
("path:");

634 
k
 = 0; k <
l
; k++, 
∑th
++) {

635 i‡(
∑th
->
p_idx
) {

636 
	`ext_debug
(" %d->%Œu", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

637 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

638 } i‡(
∑th
->
p_ext
) {

639 
	`ext_debug
(" %d:[%d]%d:%llu ",

640 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

641 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

642 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
),

643 
	`pxt4_ext_pblock
(
∑th
->
p_ext
));

645 
	`ext_debug
(" []");

647 
	`ext_debug
("\n");

648 
	}
}

650 
	$pxt4_ext_show_Àaf
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
)

652 
dïth
 = 
	`ext_dïth
(
öode
);

653 
pxt4_exã¡_hódî
 *
eh
;

654 
pxt4_exã¡
 *
ex
;

655 
i
;

657 i‡(!
∑th
)

660 
eh
 = 
∑th
[
dïth
].
p_hdr
;

661 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

663 
	`ext_debug
("Di•œyögÜó‡exã¡†f‹ inodê%lu\n", 
öode
->
i_öo
);

665 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ex
++) {

666 
	`ext_debug
("%d:[%d]%d:%Œu ", 
	`À32_to_˝u
(
ex
->
ì_block
),

667 
	`pxt4_ext_is_unwrôãn
(
ex
),

668 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
), 
	`pxt4_ext_pblock
(ex));

670 
	`ext_debug
("\n");

671 
	}
}

673 
	$pxt4_ext_show_move
(
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
,

674 
pxt4_fsblk_t
 
√wblock
, 
Àvñ
)

676 
dïth
 = 
	`ext_dïth
(
öode
);

677 
pxt4_exã¡
 *
ex
;

679 i‡(
dïth
 !
Àvñ
) {

680 
pxt4_exã¡_idx
 *
idx
;

681 
idx
 = 
∑th
[
Àvñ
].
p_idx
;

682 
idx
 <
	`EXT_MAX_INDEX
(
∑th
[
Àvñ
].
p_hdr
)) {

683 
	`ext_debug
("%d: movê%d:%Œu i¿√w index %Œu\n", 
Àvñ
,

684 
	`À32_to_˝u
(
idx
->
ei_block
),

685 
	`pxt4_idx_pblock
(
idx
),

686 
√wblock
);

687 
idx
++;

693 
ex
 = 
∑th
[
dïth
].
p_ext
;

694 
ex
 <
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

695 
	`ext_debug
("move %d:%llu:[%d]%d inÇewÜeaf %llu\n",

696 
	`À32_to_˝u
(
ex
->
ì_block
),

697 
	`pxt4_ext_pblock
(
ex
),

698 
	`pxt4_ext_is_unwrôãn
(
ex
),

699 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

700 
√wblock
);

701 
ex
++;

703 
	}
}

706 
	#pxt4_ext_show_∑th
(
öode
, 
∑th
)

	)

707 
	#pxt4_ext_show_Àaf
(
öode
, 
∑th
)

	)

708 
	#pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
Àvñ
)

	)

711 
	$pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *
∑th
)

713 
dïth
, 
i
;

715 i‡(!
∑th
)

717 
dïth
 = 
∑th
->
p_dïth
;

718 
i
 = 0; i <
dïth
; i++, 
∑th
++)

719 i‡(
∑th
->
p_bh
) {

720 
	`bªl£
(
∑th
->
p_bh
);

721 
∑th
->
p_bh
 = 
NULL
;

723 
	}
}

731 
	$pxt4_ext_bö£¨ch_idx
(
öode
 *inode,

732 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

734 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

735 
pxt4_exã¡_idx
 *
r
, *
l
, *
m
;

738 
	`ext_debug
("bö£¨ch f‹ %u(idx): ", 
block
);

740 
l
 = 
	`EXT_FIRST_INDEX
(
eh
) + 1;

741 
r
 = 
	`EXT_LAST_INDEX
(
eh
);

742 
l
 <
r
) {

743 
m
 = 
l
 + (
r
 -Ü) / 2;

744 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ei_block
))

745 
r
 = 
m
 - 1;

747 
l
 = 
m
 + 1;

748 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ei_block
),

749 
m
, 
	`À32_to_˝u
(m->
ei_block
),

750 
r
, 
	`À32_to_˝u
‘->
ei_block
));

753 
∑th
->
p_idx
 = 
l
 - 1;

754 
	`ext_debug
(" -> %u->%Œd ", 
	`À32_to_˝u
(
∑th
->
p_idx
->
ei_block
),

755 
	`pxt4_idx_pblock
(
∑th
->
p_idx
));

757 #ifde‡
CHECK_BINSEARCH


759 
pxt4_exã¡_idx
 *
chix
, *
ix
;

760 
k
;

762 
chix
 = 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

763 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ix
++) {

764 i‡(
k
 != 0 &&

765 
	`À32_to_˝u
(
ix
->
ei_block
) <=Üe32_to_cpu(ix[-1].ei_block)) {

766 
	`¥ötk
(
KERN_DEBUG
 "k=%d, ix=0x%p, "

767 "fú°=0x%p\n", 
k
,

768 
ix
, 
	`EXT_FIRST_INDEX
(
eh
));

769 
	`¥ötk
(
KERN_DEBUG
 "%u <= %u\n",

770 
	`À32_to_˝u
(
ix
->
ei_block
),

771 
	`À32_to_˝u
(
ix
[-1].
ei_block
));

773 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ix
->
ei_block
)

774 <
	`À32_to_˝u
(
ix
[-1].
ei_block
));

775 i‡(
block
 < 
	`À32_to_˝u
(
ix
->
ei_block
))

777 
chix
 = 
ix
;

779 
	`BUG_ON
(
chix
 !
∑th
->
p_idx
);

783 
	}
}

791 
	$pxt4_ext_bö£¨ch
(
öode
 *inode,

792 
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
block
)

794 
pxt4_exã¡_hódî
 *
eh
 = 
∑th
->
p_hdr
;

795 
pxt4_exã¡
 *
r
, *
l
, *
m
;

797 i‡(
eh
->
eh_íåõs
 == 0) {

805 
	`ext_debug
("bö£¨ch f‹ %u: ", 
block
);

807 
l
 = 
	`EXT_FIRST_EXTENT
(
eh
) + 1;

808 
r
 = 
	`EXT_LAST_EXTENT
(
eh
);

810 
l
 <
r
) {

811 
m
 = 
l
 + (
r
 -Ü) / 2;

812 i‡(
block
 < 
	`À32_to_˝u
(
m
->
ì_block
))

813 
r
 = 
m
 - 1;

815 
l
 = 
m
 + 1;

816 
	`ext_debug
("%p(%u):%p(%u):%p(%uË", 
l
, 
	`À32_to_˝u
÷->
ì_block
),

817 
m
, 
	`À32_to_˝u
(m->
ì_block
),

818 
r
, 
	`À32_to_˝u
‘->
ì_block
));

821 
∑th
->
p_ext
 = 
l
 - 1;

822 
	`ext_debug
(" -> %d:%llu:[%d]%d ",

823 
	`À32_to_˝u
(
∑th
->
p_ext
->
ì_block
),

824 
	`pxt4_ext_pblock
(
∑th
->
p_ext
),

825 
	`pxt4_ext_is_unwrôãn
(
∑th
->
p_ext
),

826 
	`pxt4_ext_gë_a˘uÆ_Àn
(
∑th
->
p_ext
));

828 #ifde‡
CHECK_BINSEARCH


830 
pxt4_exã¡
 *
chex
, *
ex
;

831 
k
;

833 
chex
 = 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

834 
k
 = 0; k < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); k++, 
ex
++) {

835 
	`BUG_ON
(
k
 && 
	`À32_to_˝u
(
ex
->
ì_block
)

836 <
	`À32_to_˝u
(
ex
[-1].
ì_block
));

837 i‡(
block
 < 
	`À32_to_˝u
(
ex
->
ì_block
))

839 
chex
 = 
ex
;

841 
	`BUG_ON
(
chex
 !
∑th
->
p_ext
);

845 
	}
}

847 
	$pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

849 
pxt4_exã¡_hódî
 *
eh
;

851 
eh
 = 
	`ext_öode_hdr
(
öode
);

852 
eh
->
eh_dïth
 = 0;

853 
eh
->
eh_íåõs
 = 0;

854 
eh
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

855 
eh
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

856 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

858 
	}
}

860 
pxt4_ext_∑th
 *

861 
	$pxt4_föd_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

862 
pxt4_ext_∑th
 **
‹ig_∑th
, 
Êags
)

864 
pxt4_exã¡_hódî
 *
eh
;

865 
buf„r_hód
 *
bh
;

866 
pxt4_ext_∑th
 *
∑th
 = 
‹ig_∑th
 ? *‹ig_∑th : 
NULL
;

867 
dïth
, 
i
, 
µos
 = 0;

868 
ªt
;

870 
eh
 = 
	`ext_öode_hdr
(
öode
);

871 
dïth
 = 
	`ext_dïth
(
öode
);

872 i‡(
dïth
 < 0 || dïth > 
PXT4_MAX_EXTENT_DEPTH
) {

873 
	`PXT4_ERROR_INODE
(
öode
, "inode has invalidÉxtent depth: %d",

874 
dïth
);

875 
ªt
 = -
EFSCORRUPTED
;

876 
îr
;

879 i‡(
∑th
) {

880 
	`pxt4_ext_dr›_ªfs
(
∑th
);

881 i‡(
dïth
 > 
∑th
[0].
p_maxdïth
) {

882 
	`k‰ì
(
∑th
);

883 *
‹ig_∑th
 = 
∑th
 = 
NULL
;

886 i‡(!
∑th
) {

888 
∑th
 = 
	`kˇŒoc
(
dïth
 + 2, (
pxt4_ext_∑th
),

889 
GFP_NOFS
);

890 i‡(
	`u∆ikñy
(!
∑th
))

891  
	`ERR_PTR
(-
ENOMEM
);

892 
∑th
[0].
p_maxdïth
 = 
dïth
 + 1;

894 
∑th
[0].
p_hdr
 = 
eh
;

895 
∑th
[0].
p_bh
 = 
NULL
;

897 
i
 = 
dïth
;

899 
i
) {

900 
	`ext_debug
("depth %d:Çum %d, max %d\n",

901 
µos
, 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

903 
	`pxt4_ext_bö£¨ch_idx
(
öode
, 
∑th
 + 
µos
, 
block
);

904 
∑th
[
µos
].
p_block
 = 
	`pxt4_idx_pblock
’©h[µos].
p_idx
);

905 
∑th
[
µos
].
p_dïth
 = 
i
;

906 
∑th
[
µos
].
p_ext
 = 
NULL
;

908 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
∑th
[
µos
].
p_block
, --
i
,

909 
Êags
);

910 i‡(
	`IS_ERR
(
bh
)) {

911 
ªt
 = 
	`PTR_ERR
(
bh
);

912 
îr
;

915 
eh
 = 
	`ext_block_hdr
(
bh
);

916 
µos
++;

917 
∑th
[
µos
].
p_bh
 = 
bh
;

918 
∑th
[
µos
].
p_hdr
 = 
eh
;

921 
∑th
[
µos
].
p_dïth
 = 
i
;

922 
∑th
[
µos
].
p_ext
 = 
NULL
;

923 
∑th
[
µos
].
p_idx
 = 
NULL
;

926 
	`pxt4_ext_bö£¨ch
(
öode
, 
∑th
 + 
µos
, 
block
);

928 i‡(
∑th
[
µos
].
p_ext
)

929 
∑th
[
µos
].
p_block
 = 
	`pxt4_ext_pblock
’©h[µos].
p_ext
);

931 
	`pxt4_ext_show_∑th
(
öode
, 
∑th
);

933  
∑th
;

935 
îr
:

936 
	`pxt4_ext_dr›_ªfs
(
∑th
);

937 
	`k‰ì
(
∑th
);

938 i‡(
‹ig_∑th
)

939 *
‹ig_∑th
 = 
NULL
;

940  
	`ERR_PTR
(
ªt
);

941 
	}
}

948 
	$pxt4_ext_ö£π_ödex
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

949 
pxt4_ext_∑th
 *
cuΩ
,

950 
logiˇl
, 
pxt4_fsblk_t
 
±r
)

952 
pxt4_exã¡_idx
 *
ix
;

953 
Àn
, 
îr
;

955 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
cuΩ
);

956 i‡(
îr
)

957  
îr
;

959 i‡(
	`u∆ikñy
(
logiˇl
 =
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
))) {

960 
	`PXT4_ERROR_INODE
(
öode
,

962 
logiˇl
, 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
));

963  -
EFSCORRUPTED
;

966 i‡(
	`u∆ikñy
(
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
)

967 >
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
))) {

968 
	`PXT4_ERROR_INODE
(
öode
,

970 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_íåõs
),

971 
	`À16_to_˝u
(
cuΩ
->
p_hdr
->
eh_max
));

972  -
EFSCORRUPTED
;

975 i‡(
logiˇl
 > 
	`À32_to_˝u
(
cuΩ
->
p_idx
->
ei_block
)) {

977 
	`ext_debug
("ö£πÇew index %dá·î: %Œu\n", 
logiˇl
, 
±r
);

978 
ix
 = 
cuΩ
->
p_idx
 + 1;

981 
	`ext_debug
("ö£πÇew index %d bef‹e: %Œu\n", 
logiˇl
, 
±r
);

982 
ix
 = 
cuΩ
->
p_idx
;

985 
Àn
 = 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
Ë- 
ix
 + 1;

986 
	`BUG_ON
(
Àn
 < 0);

987 i‡(
Àn
 > 0) {

988 
	`ext_debug
("insertÇew index %d: "

990 
logiˇl
, 
Àn
, 
ix
, ix + 1);

991 
	`memmove
(
ix
 + 1, ix, 
Àn
 * (
pxt4_exã¡_idx
));

994 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_MAX_INDEX
(
cuΩ
->
p_hdr
))) {

995 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_MAX_INDEX!");

996  -
EFSCORRUPTED
;

999 
ix
->
ei_block
 = 
	`˝u_to_À32
(
logiˇl
);

1000 
	`pxt4_idx_°‹e_pblock
(
ix
, 
±r
);

1001 
	`À16_add_˝u
(&
cuΩ
->
p_hdr
->
eh_íåõs
, 1);

1003 i‡(
	`u∆ikñy
(
ix
 > 
	`EXT_LAST_INDEX
(
cuΩ
->
p_hdr
))) {

1004 
	`PXT4_ERROR_INODE
(
öode
, "ix > EXT_LAST_INDEX!");

1005  -
EFSCORRUPTED
;

1008 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
cuΩ
);

1009 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

1011  
îr
;

1012 
	}
}

1024 
	$pxt4_ext_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1025 
Êags
,

1026 
pxt4_ext_∑th
 *
∑th
,

1027 
pxt4_exã¡
 *
√wext
, 
©
)

1029 
buf„r_hód
 *
bh
 = 
NULL
;

1030 
dïth
 = 
	`ext_dïth
(
öode
);

1031 
pxt4_exã¡_hódî
 *
√h
;

1032 
pxt4_exã¡_idx
 *
fidx
;

1033 
i
 = 
©
, 
k
, 
m
, 
a
;

1034 
pxt4_fsblk_t
 
√wblock
, 
ﬁdblock
;

1035 
__À32
 
b‹dî
;

1036 
pxt4_fsblk_t
 *
ablocks
 = 
NULL
;

1037 
îr
 = 0;

1038 
size_t
 
ext_size
 = 0;

1045 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 > 
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
))) {

1046 
	`PXT4_ERROR_INODE
(
öode
, "p_ext > EXT_MAX_EXTENT!");

1047  -
EFSCORRUPTED
;

1049 i‡(
∑th
[
dïth
].
p_ext
 !
	`EXT_MAX_EXTENT
’©h[dïth].
p_hdr
)) {

1050 
b‹dî
 = 
∑th
[
dïth
].
p_ext
[1].
ì_block
;

1051 
	`ext_debug
("leaf will be split."

1053 
	`À32_to_˝u
(
b‹dî
));

1055 
b‹dî
 = 
√wext
->
ì_block
;

1056 
	`ext_debug
("leaf will beádded."

1058 
	`À32_to_˝u
(
b‹dî
));

1073 
ablocks
 = 
	`kˇŒoc
(
dïth
, (
pxt4_fsblk_t
), 
GFP_NOFS
);

1074 i‡(!
ablocks
)

1075  -
ENOMEM
;

1078 
	`ext_debug
("Æloˇã %d block†f‹ indexes/Àaf\n", 
dïth
 - 
©
);

1079 
a
 = 0;á < 
dïth
 - 
©
;á++) {

1080 
√wblock
 = 
	`pxt4_ext_√w_mëa_block
(
h™dÀ
, 
öode
, 
∑th
,

1081 
√wext
, &
îr
, 
Êags
);

1082 i‡(
√wblock
 == 0)

1083 
˛ónup
;

1084 
ablocks
[
a
] = 
√wblock
;

1088 
√wblock
 = 
ablocks
[--
a
];

1089 i‡(
	`u∆ikñy
(
√wblock
 == 0)) {

1090 
	`PXT4_ERROR_INODE
(
öode
, "newblock == 0!");

1091 
îr
 = -
EFSCORRUPTED
;

1092 
˛ónup
;

1094 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1095 i‡(
	`u∆ikñy
(!
bh
)) {

1096 
îr
 = -
ENOMEM
;

1097 
˛ónup
;

1099 
	`lock_buf„r
(
bh
);

1101 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1102 i‡(
îr
)

1103 
˛ónup
;

1105 
√h
 = 
	`ext_block_hdr
(
bh
);

1106 
√h
->
eh_íåõs
 = 0;

1107 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1108 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1109 
√h
->
eh_dïth
 = 0;

1112 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 !=

1113 
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

1114 
	`PXT4_ERROR_INODE
(
öode
, "eh_entries %d !=Éh_max %d!",

1115 
∑th
[
dïth
].
p_hdr
->
eh_íåõs
,

1116 
∑th
[
dïth
].
p_hdr
->
eh_max
);

1117 
îr
 = -
EFSCORRUPTED
;

1118 
˛ónup
;

1121 
m
 = 
	`EXT_MAX_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë-Ö©h[dïth].
p_ext
++;

1122 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
dïth
);

1123 i‡(
m
) {

1124 
pxt4_exã¡
 *
ex
;

1125 
ex
 = 
	`EXT_FIRST_EXTENT
(
√h
);

1126 
	`memmove
(
ex
, 
∑th
[
dïth
].
p_ext
, (
pxt4_exã¡
Ë* 
m
);

1127 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1131 
ext_size
 = (
pxt4_exã¡_hódî
) +

1132 (
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
);

1133 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1134 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1135 
	`£t_buf„r_u±od©e
(
bh
);

1136 
	`u∆ock_buf„r
(
bh
);

1138 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1139 i‡(
îr
)

1140 
˛ónup
;

1141 
	`bªl£
(
bh
);

1142 
bh
 = 
NULL
;

1145 i‡(
m
) {

1146 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1147 i‡(
îr
)

1148 
˛ónup
;

1149 
	`À16_add_˝u
(&
∑th
[
dïth
].
p_hdr
->
eh_íåõs
, -
m
);

1150 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

1151 i‡(
îr
)

1152 
˛ónup
;

1157 
k
 = 
dïth
 - 
©
 - 1;

1158 i‡(
	`u∆ikñy
(
k
 < 0)) {

1159 
	`PXT4_ERROR_INODE
(
öode
, "k %d < 0!", 
k
);

1160 
îr
 = -
EFSCORRUPTED
;

1161 
˛ónup
;

1163 i‡(
k
)

1164 
	`ext_debug
("¸óã %d i¡îmedüã indi˚s\n", 
k
);

1167 
i
 = 
dïth
 - 1;

1168 
k
--) {

1169 
ﬁdblock
 = 
√wblock
;

1170 
√wblock
 = 
ablocks
[--
a
];

1171 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
√wblock
);

1172 i‡(
	`u∆ikñy
(!
bh
)) {

1173 
îr
 = -
ENOMEM
;

1174 
˛ónup
;

1176 
	`lock_buf„r
(
bh
);

1178 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1179 i‡(
îr
)

1180 
˛ónup
;

1182 
√h
 = 
	`ext_block_hdr
(
bh
);

1183 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1184 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1185 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1186 
√h
->
eh_dïth
 = 
	`˝u_to_À16
(
dïth
 - 
i
);

1187 
fidx
 = 
	`EXT_FIRST_INDEX
(
√h
);

1188 
fidx
->
ei_block
 = 
b‹dî
;

1189 
	`pxt4_idx_°‹e_pblock
(
fidx
, 
ﬁdblock
);

1191 
	`ext_debug
("int.indexát %d (block %llu): %u -> %llu\n",

1192 
i
, 
√wblock
, 
	`À32_to_˝u
(
b‹dî
), 
ﬁdblock
);

1195 i‡(
	`u∆ikñy
(
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
) !=

1196 
	`EXT_LAST_INDEX
(
∑th
[
i
].
p_hdr
))) {

1197 
	`PXT4_ERROR_INODE
(
öode
,

1199 
	`À32_to_˝u
(
∑th
[
i
].
p_ext
->
ì_block
));

1200 
îr
 = -
EFSCORRUPTED
;

1201 
˛ónup
;

1204 
m
 = 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
Ë-Ö©h[i].
p_idx
++;

1205 
	`ext_debug
("cu∏0x%p,Üa° 0x%p\n", 
∑th
[
i
].
p_idx
,

1206 
	`EXT_MAX_INDEX
(
∑th
[
i
].
p_hdr
));

1207 
	`pxt4_ext_show_move
(
öode
, 
∑th
, 
√wblock
, 
i
);

1208 i‡(
m
) {

1209 
	`memmove
(++
fidx
, 
∑th
[
i
].
p_idx
,

1210 (
pxt4_exã¡_idx
Ë* 
m
);

1211 
	`À16_add_˝u
(&
√h
->
eh_íåõs
, 
m
);

1214 
ext_size
 = (
pxt4_exã¡_hódî
) +

1215 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
(
√h
->
eh_íåõs
));

1216 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0,

1217 
öode
->
i_sb
->
s_blocksize
 - 
ext_size
);

1218 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1219 
	`£t_buf„r_u±od©e
(
bh
);

1220 
	`u∆ock_buf„r
(
bh
);

1222 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1223 i‡(
îr
)

1224 
˛ónup
;

1225 
	`bªl£
(
bh
);

1226 
bh
 = 
NULL
;

1229 i‡(
m
) {

1230 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1231 i‡(
îr
)

1232 
˛ónup
;

1233 
	`À16_add_˝u
(&
∑th
[
i
].
p_hdr
->
eh_íåõs
, -
m
);

1234 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
i
);

1235 i‡(
îr
)

1236 
˛ónup
;

1239 
i
--;

1243 
îr
 = 
	`pxt4_ext_ö£π_ödex
(
h™dÀ
, 
öode
, 
∑th
 + 
©
,

1244 
	`À32_to_˝u
(
b‹dî
), 
√wblock
);

1246 
˛ónup
:

1247 i‡(
bh
) {

1248 i‡(
	`buf„r_locked
(
bh
))

1249 
	`u∆ock_buf„r
(
bh
);

1250 
	`bªl£
(
bh
);

1253 i‡(
îr
) {

1255 
i
 = 0; i < 
dïth
; i++) {

1256 i‡(!
ablocks
[
i
])

1258 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ablocks
[
i
], 1,

1259 
PXT4_FREE_BLOCKS_METADATA
);

1262 
	`k‰ì
(
ablocks
);

1264  
îr
;

1265 
	}
}

1275 
	$pxt4_ext_grow_ödïth
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1276 
Êags
)

1278 
pxt4_exã¡_hódî
 *
√h
;

1279 
buf„r_hód
 *
bh
;

1280 
pxt4_fsblk_t
 
√wblock
, 
gﬂl
 = 0;

1281 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

1282 
îr
 = 0;

1283 
size_t
 
ext_size
 = 0;

1286 i‡(
	`ext_dïth
(
öode
))

1287 
gﬂl
 = 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
	`ext_öode_hdr
(
öode
)));

1288 i‡(
gﬂl
 > 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
)) {

1289 
Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

1290 
gﬂl
--;

1292 
gﬂl
 = 
	`pxt4_öode_to_gﬂl_block
(
öode
);

1293 
√wblock
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 
Êags
,

1294 
NULL
, &
îr
);

1295 i‡(
√wblock
 == 0)

1296  
îr
;

1298 
bh
 = 
	`sb_gëblk_gÂ
(
öode
->
i_sb
, 
√wblock
, 
__GFP_MOVABLE
 | 
GFP_NOFS
);

1299 i‡(
	`u∆ikñy
(!
bh
))

1300  -
ENOMEM
;

1301 
	`lock_buf„r
(
bh
);

1303 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

1304 i‡(
îr
) {

1305 
	`u∆ock_buf„r
(
bh
);

1306 
out
;

1309 
ext_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

1311 
	`memmove
(
bh
->
b_d©a
, 
	`PXT4_I
(
öode
)->
i_d©a
, 
ext_size
);

1313 
	`mem£t
(
bh
->
b_d©a
 + 
ext_size
, 0, 
öode
->
i_sb
->
s_blocksize
 -Éxt_size);

1316 
√h
 = 
	`ext_block_hdr
(
bh
);

1319 i‡(
	`ext_dïth
(
öode
))

1320 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block_idx
(
öode
, 0));

1322 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_block
(
öode
, 0));

1323 
√h
->
eh_magic
 = 
PXT4_EXT_MAGIC
;

1324 
	`pxt4_exã¡_block_csum_£t
(
öode
, 
√h
);

1325 
	`£t_buf„r_u±od©e
(
bh
);

1326 
	`u∆ock_buf„r
(
bh
);

1328 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1329 i‡(
îr
)

1330 
out
;

1333 
√h
 = 
	`ext_öode_hdr
(
öode
);

1334 
√h
->
eh_íåõs
 = 
	`˝u_to_À16
(1);

1335 
	`pxt4_idx_°‹e_pblock
(
	`EXT_FIRST_INDEX
(
√h
), 
√wblock
);

1336 i‡(
√h
->
eh_dïth
 == 0) {

1338 
√h
->
eh_max
 = 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ_idx
(
öode
, 0));

1339 
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
 =

1340 
	`EXT_FIRST_EXTENT
(
√h
)->
ì_block
;

1342 
	`ext_debug
("newÑoot:Çum %d(%d),Üblock %d,Ötr %llu\n",

1343 
	`À16_to_˝u
(
√h
->
eh_íåõs
),Üe16_to_˝u“eh->
eh_max
),

1344 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
√h
)->
ei_block
),

1345 
	`pxt4_idx_pblock
(
	`EXT_FIRST_INDEX
(
√h
)));

1347 
	`À16_add_˝u
(&
√h
->
eh_dïth
, 1);

1348 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1349 
out
:

1350 
	`bªl£
(
bh
);

1352  
îr
;

1353 
	}
}

1360 
	$pxt4_ext_¸óã_√w_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1361 
mb_Êags
,

1362 
gb_Êags
,

1363 
pxt4_ext_∑th
 **
µ©h
,

1364 
pxt4_exã¡
 *
√wext
)

1366 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1367 
pxt4_ext_∑th
 *
cuΩ
;

1368 
dïth
, 
i
, 
îr
 = 0;

1370 
ª≥©
:

1371 
i
 = 
dïth
 = 
	`ext_dïth
(
öode
);

1374 
cuΩ
 = 
∑th
 + 
dïth
;

1375 
i
 > 0 && !
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1376 
i
--;

1377 
cuΩ
--;

1382 i‡(
	`EXT_HAS_FREE_INDEX
(
cuΩ
)) {

1385 
îr
 = 
	`pxt4_ext_•lô
(
h™dÀ
, 
öode
, 
mb_Êags
, 
∑th
, 
√wext
, 
i
);

1386 i‡(
îr
)

1387 
out
;

1390 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1391 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1392 
µ©h
, 
gb_Êags
);

1393 i‡(
	`IS_ERR
(
∑th
))

1394 
îr
 = 
	`PTR_ERR
(
∑th
);

1397 
îr
 = 
	`pxt4_ext_grow_ödïth
(
h™dÀ
, 
öode
, 
mb_Êags
);

1398 i‡(
îr
)

1399 
out
;

1402 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
,

1403 (
pxt4_lblk_t
)
	`À32_to_˝u
(
√wext
->
ì_block
),

1404 
µ©h
, 
gb_Êags
);

1405 i‡(
	`IS_ERR
(
∑th
)) {

1406 
îr
 = 
	`PTR_ERR
(
∑th
);

1407 
out
;

1414 
dïth
 = 
	`ext_dïth
(
öode
);

1415 i‡(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
 =∑th[dïth].p_hdr->
eh_max
) {

1417 
ª≥©
;

1421 
out
:

1422  
îr
;

1423 
	}
}

1432 
	$pxt4_ext_£¨ch_À·
(
öode
 *inode,

1433 
pxt4_ext_∑th
 *
∑th
,

1434 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
)

1436 
pxt4_exã¡_idx
 *
ix
;

1437 
pxt4_exã¡
 *
ex
;

1438 
dïth
, 
ì_Àn
;

1440 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1441 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1442  -
EFSCORRUPTED
;

1444 
dïth
 = 
∑th
->
p_dïth
;

1445 *
phys
 = 0;

1447 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1454 
ex
 = 
∑th
[
dïth
].
p_ext
;

1455 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1456 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1457 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1458 
	`PXT4_ERROR_INODE
(
öode
,

1460 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
));

1461  -
EFSCORRUPTED
;

1463 --
dïth
 >= 0) {

1464 
ix
 = 
∑th
[
dïth
].
p_idx
;

1465 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1466 
	`PXT4_ERROR_INODE
(
öode
,

1468 
ix
 !
NULL
 ? 
	`À32_to_˝u
(ix->
ei_block
) : 0,

1469 
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
Ë!
NULL
 ?

1470 
	`À32_to_˝u
(
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
)->
ei_block
) : 0,

1471 
dïth
);

1472  -
EFSCORRUPTED
;

1478 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1479 
	`PXT4_ERROR_INODE
(
öode
,

1481 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1482  -
EFSCORRUPTED
;

1485 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1;

1486 *
phys
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

1488 
	}
}

1497 
	$pxt4_ext_£¨ch_right
(
öode
 *inode,

1498 
pxt4_ext_∑th
 *
∑th
,

1499 
pxt4_lblk_t
 *
logiˇl
, 
pxt4_fsblk_t
 *
phys
,

1500 
pxt4_exã¡
 **
ªt_ex
)

1502 
buf„r_hód
 *
bh
 = 
NULL
;

1503 
pxt4_exã¡_hódî
 *
eh
;

1504 
pxt4_exã¡_idx
 *
ix
;

1505 
pxt4_exã¡
 *
ex
;

1506 
pxt4_fsblk_t
 
block
;

1507 
dïth
;

1508 
ì_Àn
;

1510 i‡(
	`u∆ikñy
(
∑th
 =
NULL
)) {

1511 
	`PXT4_ERROR_INODE
(
öode
, "∑th =NULL *logiˇ»%d!", *
logiˇl
);

1512  -
EFSCORRUPTED
;

1514 
dïth
 = 
∑th
->
p_dïth
;

1515 *
phys
 = 0;

1517 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1524 
ex
 = 
∑th
[
dïth
].
p_ext
;

1525 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

1526 i‡(*
logiˇl
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

1527 i‡(
	`u∆ikñy
(
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
Ë!
ex
)) {

1528 
	`PXT4_ERROR_INODE
(
öode
,

1530 
dïth
);

1531  -
EFSCORRUPTED
;

1533 --
dïth
 >= 0) {

1534 
ix
 = 
∑th
[
dïth
].
p_idx
;

1535 i‡(
	`u∆ikñy
(
ix
 !
	`EXT_FIRST_INDEX
(
∑th
[
dïth
].
p_hdr
))) {

1536 
	`PXT4_ERROR_INODE
(
öode
,

1538 *
logiˇl
);

1539  -
EFSCORRUPTED
;

1542 
found_exã¡
;

1545 i‡(
	`u∆ikñy
(*
logiˇl
 < (
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
))) {

1546 
	`PXT4_ERROR_INODE
(
öode
,

1548 *
logiˇl
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

1549  -
EFSCORRUPTED
;

1552 i‡(
ex
 !
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

1554 
ex
++;

1555 
found_exã¡
;

1559 --
dïth
 >= 0) {

1560 
ix
 = 
∑th
[
dïth
].
p_idx
;

1561 i‡(
ix
 !
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1562 
gŸ_ödex
;

1568 
gŸ_ödex
:

1572 
ix
++;

1573 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1574 ++
dïth
 < 
∑th
->
p_dïth
) {

1576 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
,

1577 
∑th
->
p_dïth
 - 
dïth
, 0);

1578 i‡(
	`IS_ERR
(
bh
))

1579  
	`PTR_ERR
(
bh
);

1580 
eh
 = 
	`ext_block_hdr
(
bh
);

1581 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

1582 
block
 = 
	`pxt4_idx_pblock
(
ix
);

1583 
	`put_bh
(
bh
);

1586 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
, 
block
, 
∑th
->
p_dïth
 - 
dïth
, 0);

1587 i‡(
	`IS_ERR
(
bh
))

1588  
	`PTR_ERR
(
bh
);

1589 
eh
 = 
	`ext_block_hdr
(
bh
);

1590 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

1591 
found_exã¡
:

1592 *
logiˇl
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

1593 *
phys
 = 
	`pxt4_ext_pblock
(
ex
);

1594 *
ªt_ex
 = 
ex
;

1595 i‡(
bh
)

1596 
	`put_bh
(
bh
);

1598 
	}
}

1607 
pxt4_lblk_t


1608 
	$pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
)

1610 
dïth
;

1612 
	`BUG_ON
(
∑th
 =
NULL
);

1613 
dïth
 = 
∑th
->
p_dïth
;

1615 i‡(
dïth
 =0 && 
∑th
->
p_ext
 =
NULL
)

1616  
EXT_MAX_BLOCKS
;

1618 
dïth
 >= 0) {

1619 i‡(
dïth
 =
∑th
->
p_dïth
) {

1621 i‡(
∑th
[
dïth
].
p_ext
 &&

1622 
∑th
[
dïth
].
p_ext
 !=

1623 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

1624  
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
[1].
ì_block
);

1627 i‡(
∑th
[
dïth
].
p_idx
 !=

1628 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1629  
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1631 
dïth
--;

1634  
EXT_MAX_BLOCKS
;

1635 
	}
}

1641 
pxt4_lblk_t
 
	$pxt4_ext_√xt_Àaf_block
(
pxt4_ext_∑th
 *
∑th
)

1643 
dïth
;

1645 
	`BUG_ON
(
∑th
 =
NULL
);

1646 
dïth
 = 
∑th
->
p_dïth
;

1649 i‡(
dïth
 == 0)

1650  
EXT_MAX_BLOCKS
;

1653 
dïth
--;

1655 
dïth
 >= 0) {

1656 i‡(
∑th
[
dïth
].
p_idx
 !=

1657 
	`EXT_LAST_INDEX
(
∑th
[
dïth
].
p_hdr
))

1658  (
pxt4_lblk_t
)

1659 
	`À32_to_˝u
(
∑th
[
dïth
].
p_idx
[1].
ei_block
);

1660 
dïth
--;

1663  
EXT_MAX_BLOCKS
;

1664 
	}
}

1672 
	$pxt4_ext_c‹ª˘_ödexes
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1673 
pxt4_ext_∑th
 *
∑th
)

1675 
pxt4_exã¡_hódî
 *
eh
;

1676 
dïth
 = 
	`ext_dïth
(
öode
);

1677 
pxt4_exã¡
 *
ex
;

1678 
__À32
 
b‹dî
;

1679 
k
, 
îr
 = 0;

1681 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1682 
ex
 = 
∑th
[
dïth
].
p_ext
;

1684 i‡(
	`u∆ikñy
(
ex
 =
NULL
 || 
eh
 == NULL)) {

1685 
	`PXT4_ERROR_INODE
(
öode
,

1686 "ex %∞=NULL o∏eh %∞=NULL", 
ex
, 
eh
);

1687  -
EFSCORRUPTED
;

1690 i‡(
dïth
 == 0) {

1695 i‡(
ex
 !
	`EXT_FIRST_EXTENT
(
eh
)) {

1703 
k
 = 
dïth
 - 1;

1704 
b‹dî
 = 
∑th
[
dïth
].
p_ext
->
ì_block
;

1705 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1706 i‡(
îr
)

1707  
îr
;

1708 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1709 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1710 i‡(
îr
)

1711  
îr
;

1713 
k
--) {

1715 i‡(
∑th
[
k
+1].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[k+1].
p_hdr
))

1717 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1718 i‡(
îr
)

1720 
∑th
[
k
].
p_idx
->
ei_block
 = 
b‹dî
;

1721 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
k
);

1722 i‡(
îr
)

1726  
îr
;

1727 
	}
}

1730 
	$pxt4_ˇn_exã¡s_be_mîged
(
öode
 *öode, 
pxt4_exã¡
 *
ex1
,

1731 
pxt4_exã¡
 *
ex2
)

1733 
ext1_ì_Àn
, 
pxt2_ì_Àn
;

1735 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
Ë!pxt4_ext_is_unwrôãn(
ex2
))

1738 
ext1_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

1739 
pxt2_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

1741 i‡(
	`À32_to_˝u
(
ex1
->
ì_block
Ë+ 
ext1_ì_Àn
 !=

1742 
	`À32_to_˝u
(
ex2
->
ì_block
))

1750 i‡(
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_INIT_MAX_LEN
)

1758 i‡(
	`pxt4_ext_is_unwrôãn
(
ex1
) &&

1759 (
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
) ||

1760 
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) ||

1761 (
ext1_ì_Àn
 + 
pxt2_ì_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)))

1763 #ifde‡
AGGRESSIVE_TEST


1764 i‡(
ext1_ì_Àn
 >= 4)

1768 i‡(
	`pxt4_ext_pblock
(
ex1
Ë+ 
ext1_ì_Àn
 =pxt4_ext_pblock(
ex2
))

1771 
	}
}

1780 
	$pxt4_ext_åy_to_mîge_right
(
öode
 *inode,

1781 
pxt4_ext_∑th
 *
∑th
,

1782 
pxt4_exã¡
 *
ex
)

1784 
pxt4_exã¡_hódî
 *
eh
;

1785 
dïth
, 
Àn
;

1786 
mîge_d⁄e
 = 0, 
unwrôãn
;

1788 
dïth
 = 
	`ext_dïth
(
öode
);

1789 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1790 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1792 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1793 i‡(!
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
,Éx + 1))

1796 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

1797 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

1798 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
 + 1));

1799 i‡(
unwrôãn
)

1800 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

1802 i‡(
ex
 + 1 < 
	`EXT_LAST_EXTENT
(
eh
)) {

1803 
Àn
 = (
	`EXT_LAST_EXTENT
(
eh
Ë- 
ex
 - 1)

1804 * (
pxt4_exã¡
);

1805 
	`memmove
(
ex
 + 1,Éx + 2, 
Àn
);

1807 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

1808 
mîge_d⁄e
 = 1;

1809 
	`WARN_ON
(
eh
->
eh_íåõs
 == 0);

1810 i‡(!
eh
->
eh_íåõs
)

1811 
	`PXT4_ERROR_INODE
(
öode
, "eh->eh_entries = 0!");

1814  
mîge_d⁄e
;

1815 
	}
}

1821 
	$pxt4_ext_åy_to_mîge_up
(
h™dÀ_t
 *
h™dÀ
,

1822 
öode
 *inode,

1823 
pxt4_ext_∑th
 *
∑th
)

1825 
size_t
 
s
;

1826 
max_roŸ
 = 
	`pxt4_ext_•a˚_roŸ
(
öode
, 0);

1827 
pxt4_fsblk_t
 
blk
;

1829 i‡((
∑th
[0].
p_dïth
 != 1) ||

1830 (
	`À16_to_˝u
(
∑th
[0].
p_hdr
->
eh_íåõs
) != 1) ||

1831 (
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
Ë> 
max_roŸ
))

1839 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 2))

1845 
blk
 = 
	`pxt4_idx_pblock
(
∑th
[0].
p_idx
);

1846 
s
 = 
	`À16_to_˝u
(
∑th
[1].
p_hdr
->
eh_íåõs
) *

1847 (
pxt4_exã¡_idx
);

1848 
s
 +(
pxt4_exã¡_hódî
);

1850 
∑th
[1].
p_maxdïth
 =Öath[0].p_maxdepth;

1851 
	`mem˝y
(
∑th
[0].
p_hdr
,Ö©h[1].p_hdr, 
s
);

1852 
∑th
[0].
p_dïth
 = 0;

1853 
∑th
[0].
p_ext
 = 
	`EXT_FIRST_EXTENT
’©h[0].
p_hdr
) +

1854 (
∑th
[1].
p_ext
 - 
	`EXT_FIRST_EXTENT
’©h[1].
p_hdr
));

1855 
∑th
[0].
p_hdr
->
eh_max
 = 
	`˝u_to_À16
(
max_roŸ
);

1857 
	`bªl£
(
∑th
[1].
p_bh
);

1858 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
blk
, 1,

1859 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

1860 
	}
}

1866 
	$pxt4_ext_åy_to_mîge
(
h™dÀ_t
 *
h™dÀ
,

1867 
öode
 *inode,

1868 
pxt4_ext_∑th
 *
∑th
,

1869 
pxt4_exã¡
 *
ex
) {

1870 
pxt4_exã¡_hódî
 *
eh
;

1871 
dïth
;

1872 
mîge_d⁄e
 = 0;

1874 
dïth
 = 
	`ext_dïth
(
öode
);

1875 
	`BUG_ON
(
∑th
[
dïth
].
p_hdr
 =
NULL
);

1876 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1878 i‡(
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))

1879 
mîge_d⁄e
 = 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
 - 1);

1881 i‡(!
mîge_d⁄e
)

1882 (Ë
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
, 
ex
);

1884 
	`pxt4_ext_åy_to_mîge_up
(
h™dÀ
, 
öode
, 
∑th
);

1885 
	}
}

1895 
	$pxt4_ext_check_ovîœp
(
pxt4_sb_öfo
 *
sbi
,

1896 
öode
 *inode,

1897 
pxt4_exã¡
 *
√wext
,

1898 
pxt4_ext_∑th
 *
∑th
)

1900 
pxt4_lblk_t
 
b1
, 
b2
;

1901 
dïth
, 
Àn1
;

1902 
ªt
 = 0;

1904 
b1
 = 
	`À32_to_˝u
(
√wext
->
ì_block
);

1905 
Àn1
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
);

1906 
dïth
 = 
	`ext_dïth
(
öode
);

1907 i‡(!
∑th
[
dïth
].
p_ext
)

1908 
out
;

1909 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
	`À32_to_˝u
(
∑th
[
dïth
].
p_ext
->
ì_block
));

1915 i‡(
b2
 < 
b1
) {

1916 
b2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

1917 i‡(
b2
 =
EXT_MAX_BLOCKS
)

1918 
out
;

1919 
b2
 = 
	`PXT4_LBLK_CMASK
(
sbi
, b2);

1923 i‡(
b1
 + 
Àn1
 < b1) {

1924 
Àn1
 = 
EXT_MAX_BLOCKS
 - 
b1
;

1925 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
Àn1
);

1926 
ªt
 = 1;

1930 i‡(
b1
 + 
Àn1
 > 
b2
) {

1931 
√wext
->
ì_Àn
 = 
	`˝u_to_À16
(
b2
 - 
b1
);

1932 
ªt
 = 1;

1934 
out
:

1935  
ªt
;

1936 
	}
}

1944 
	$pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1945 
pxt4_ext_∑th
 **
µ©h
,

1946 
pxt4_exã¡
 *
√wext
, 
gb_Êags
)

1948 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

1949 
pxt4_exã¡_hódî
 *
eh
;

1950 
pxt4_exã¡
 *
ex
, *
„x
;

1951 
pxt4_exã¡
 *
√¨ex
;

1952 
pxt4_ext_∑th
 *
≈©h
 = 
NULL
;

1953 
dïth
, 
Àn
, 
îr
;

1954 
pxt4_lblk_t
 
√xt
;

1955 
mb_Êags
 = 0, 
unwrôãn
;

1957 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

1958 
mb_Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

1959 i‡(
	`u∆ikñy
(
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) == 0)) {

1960 
	`PXT4_ERROR_INODE
(
öode
, "pxt4_ext_get_actual_len(newext) == 0");

1961  -
EFSCORRUPTED
;

1963 
dïth
 = 
	`ext_dïth
(
öode
);

1964 
ex
 = 
∑th
[
dïth
].
p_ext
;

1965 
eh
 = 
∑th
[
dïth
].
p_hdr
;

1966 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

1967 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

1968  -
EFSCORRUPTED
;

1972 i‡(
ex
 && !(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
)) {

1981 i‡(
ex
 < 
	`EXT_LAST_EXTENT
(
eh
) &&

1982 (
	`À32_to_˝u
(
ex
->
ì_block
) +

1983 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) <

1984 
	`À32_to_˝u
(
√wext
->
ì_block
))) {

1985 
ex
 += 1;

1986 
¥ïíd
;

1987 } i‡((
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
)) &&

1988 (
	`À32_to_˝u
(
√wext
->
ì_block
) +

1989 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
) <

1990 
	`À32_to_˝u
(
ex
->
ì_block
)))

1991 
ex
 -= 1;

1994 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
ex
, 
√wext
)) {

1995 
	`ext_debug
("append [%d]%d blockÅo %u:[%d]%d"

1997 
	`pxt4_ext_is_unwrôãn
(
√wext
),

1998 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

1999 
	`À32_to_˝u
(
ex
->
ì_block
),

2000 
	`pxt4_ext_is_unwrôãn
(
ex
),

2001 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2002 
	`pxt4_ext_pblock
(
ex
));

2003 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2004 
∑th
 + 
dïth
);

2005 i‡(
îr
)

2006  
îr
;

2007 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2008 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2009 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2010 i‡(
unwrôãn
)

2011 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2012 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2013 
√¨ex
 = 
ex
;

2014 
mîge
;

2017 
¥ïíd
:

2019 i‡(
	`pxt4_ˇn_exã¡s_be_mîged
(
öode
, 
√wext
, 
ex
)) {

2020 
	`ext_debug
("prepend %u[%d]%d blockÅo %u:[%d]%d"

2022 
	`À32_to_˝u
(
√wext
->
ì_block
),

2023 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2024 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2025 
	`À32_to_˝u
(
ex
->
ì_block
),

2026 
	`pxt4_ext_is_unwrôãn
(
ex
),

2027 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
),

2028 
	`pxt4_ext_pblock
(
ex
));

2029 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
,

2030 
∑th
 + 
dïth
);

2031 i‡(
îr
)

2032  
îr
;

2034 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

2035 
ex
->
ì_block
 = 
√wext
->ee_block;

2036 
	`pxt4_ext_°‹e_pblock
(
ex
, 
	`pxt4_ext_pblock
(
√wext
));

2037 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ex)

2038 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2039 i‡(
unwrôãn
)

2040 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2041 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2042 
√¨ex
 = 
ex
;

2043 
mîge
;

2047 
dïth
 = 
	`ext_dïth
(
öode
);

2048 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2049 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
))

2050 
has_•a˚
;

2053 
„x
 = 
	`EXT_LAST_EXTENT
(
eh
);

2054 
√xt
 = 
EXT_MAX_BLOCKS
;

2055 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
Ë>Üe32_to_˝u(
„x
->ee_block))

2056 
√xt
 = 
	`pxt4_ext_√xt_Àaf_block
(
∑th
);

2057 i‡(
√xt
 !
EXT_MAX_BLOCKS
) {

2058 
	`ext_debug
("√xàÀa‡block - %u\n", 
√xt
);

2059 
	`BUG_ON
(
≈©h
 !
NULL
);

2060 
≈©h
 = 
	`pxt4_föd_exã¡
(
öode
, 
√xt
, 
NULL
, 0);

2061 i‡(
	`IS_ERR
(
≈©h
))

2062  
	`PTR_ERR
(
≈©h
);

2063 
	`BUG_ON
(
≈©h
->
p_dïth
 !
∑th
->p_depth);

2064 
eh
 = 
≈©h
[
dïth
].
p_hdr
;

2065 i‡(
	`À16_to_˝u
(
eh
->
eh_íåõs
Ë<Üe16_to_˝u”h->
eh_max
)) {

2066 
	`ext_debug
("nextÜeaf isn't full(%d)\n",

2067 
	`À16_to_˝u
(
eh
->
eh_íåõs
));

2068 
∑th
 = 
≈©h
;

2069 
has_•a˚
;

2071 
	`ext_debug
("nextÜeaf hasÇo free space(%d,%d)\n",

2072 
	`À16_to_˝u
(
eh
->
eh_íåõs
),Üe16_to_˝u”h->
eh_max
));

2079 i‡(
gb_Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

2080 
mb_Êags
 |
PXT4_MB_USE_RESERVED
;

2081 
îr
 = 
	`pxt4_ext_¸óã_√w_Àaf
(
h™dÀ
, 
öode
, 
mb_Êags
, 
gb_Êags
,

2082 
µ©h
, 
√wext
);

2083 i‡(
îr
)

2084 
˛ónup
;

2085 
dïth
 = 
	`ext_dïth
(
öode
);

2086 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2088 
has_•a˚
:

2089 
√¨ex
 = 
∑th
[
dïth
].
p_ext
;

2091 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2092 i‡(
îr
)

2093 
˛ónup
;

2095 i‡(!
√¨ex
) {

2097 
	`ext_debug
("firstÉxtent inÅheÜeaf: %u:%llu:[%d]%d\n",

2098 
	`À32_to_˝u
(
√wext
->
ì_block
),

2099 
	`pxt4_ext_pblock
(
√wext
),

2100 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2101 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
));

2102 
√¨ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

2104 i‡(
	`À32_to_˝u
(
√wext
->
ì_block
)

2105 > 
	`À32_to_˝u
(
√¨ex
->
ì_block
)) {

2107 
	`ext_debug
("insert %u:%llu:[%d]%d before: "

2109 
	`À32_to_˝u
(
√wext
->
ì_block
),

2110 
	`pxt4_ext_pblock
(
√wext
),

2111 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2112 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2113 
√¨ex
);

2114 
√¨ex
++;

2117 
	`BUG_ON
(
√wext
->
ì_block
 =
√¨ex
->ee_block);

2118 
	`ext_debug
("insert %u:%llu:[%d]%dáfter: "

2120 
	`À32_to_˝u
(
√wext
->
ì_block
),

2121 
	`pxt4_ext_pblock
(
√wext
),

2122 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2123 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2124 
√¨ex
);

2126 
Àn
 = 
	`EXT_LAST_EXTENT
(
eh
Ë- 
√¨ex
 + 1;

2127 i‡(
Àn
 > 0) {

2128 
	`ext_debug
("insert %u:%llu:[%d]%d: "

2130 
	`À32_to_˝u
(
√wext
->
ì_block
),

2131 
	`pxt4_ext_pblock
(
√wext
),

2132 
	`pxt4_ext_is_unwrôãn
(
√wext
),

2133 
	`pxt4_ext_gë_a˘uÆ_Àn
(
√wext
),

2134 
Àn
, 
√¨ex
,Çearex + 1);

2135 
	`memmove
(
√¨ex
 + 1,Çearex,

2136 
Àn
 * (
pxt4_exã¡
));

2140 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, 1);

2141 
∑th
[
dïth
].
p_ext
 = 
√¨ex
;

2142 
√¨ex
->
ì_block
 = 
√wext
->ee_block;

2143 
	`pxt4_ext_°‹e_pblock
(
√¨ex
, 
	`pxt4_ext_pblock
(
√wext
));

2144 
√¨ex
->
ì_Àn
 = 
√wext
->ee_len;

2146 
mîge
:

2148 i‡(!(
gb_Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

2149 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
√¨ex
);

2153 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2154 i‡(
îr
)

2155 
˛ónup
;

2157 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

2159 
˛ónup
:

2160 
	`pxt4_ext_dr›_ªfs
(
≈©h
);

2161 
	`k‰ì
(
≈©h
);

2162  
îr
;

2163 
	}
}

2165 
	$pxt4_fûl_fõm≠_exã¡s
(
öode
 *inode,

2166 
pxt4_lblk_t
 
block
,Öxt4_lblk_à
num
,

2167 
fõm≠_exã¡_öfo
 *
fõöfo
)

2169 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2170 
pxt4_exã¡
 *
ex
;

2171 
exã¡_°©us
 
es
;

2172 
pxt4_lblk_t
 
√xt
, 
√xt_dñ
, 
°¨t
 = 0, 
íd
 = 0;

2173 
pxt4_lblk_t
 
œ°
 = 
block
 + 
num
;

2174 
exi°s
, 
dïth
 = 0, 
îr
 = 0;

2175 
Êags
 = 0;

2176 
blksize_bôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

2178 
block
 < 
œ°
 && block !
EXT_MAX_BLOCKS
) {

2179 
num
 = 
œ°
 - 
block
;

2181 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2183 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
block
, &path, 0);

2184 i‡(
	`IS_ERR
(
∑th
)) {

2185 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2186 
îr
 = 
	`PTR_ERR
(
∑th
);

2187 
∑th
 = 
NULL
;

2191 
dïth
 = 
	`ext_dïth
(
öode
);

2192 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2193 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2194 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2195 
îr
 = -
EFSCORRUPTED
;

2198 
ex
 = 
∑th
[
dïth
].
p_ext
;

2199 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2201 
Êags
 = 0;

2202 
exi°s
 = 0;

2203 i‡(!
ex
) {

2206 
°¨t
 = 
block
;

2207 
íd
 = 
block
 + 
num
;

2208 } i‡(
	`À32_to_˝u
(
ex
->
ì_block
Ë> 
block
) {

2210 
°¨t
 = 
block
;

2211 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2212 i‡(
block
 + 
num
 < 
íd
)

2213 
íd
 = 
block
 + 
num
;

2214 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2215 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2217 
°¨t
 = 
block
;

2218 
íd
 = 
block
 + 
num
;

2219 i‡(
íd
 >
√xt
)

2220 
íd
 = 
√xt
;

2221 } i‡(
block
 >
	`À32_to_˝u
(
ex
->
ì_block
)) {

2226 
°¨t
 = 
block
;

2227 
íd
 = 
	`À32_to_˝u
(
ex
->
ì_block
)

2228 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2229 i‡(
block
 + 
num
 < 
íd
)

2230 
íd
 = 
block
 + 
num
;

2231 
exi°s
 = 1;

2233 
	`BUG
();

2235 
	`BUG_ON
(
íd
 <
°¨t
);

2237 i‡(!
exi°s
) {

2238 
es
.
es_lblk
 = 
°¨t
;

2239 
es
.
es_Àn
 = 
íd
 - 
°¨t
;

2240 
es
.
es_pblk
 = 0;

2242 
es
.
es_lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2243 
es
.
es_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2244 
es
.
es_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2245 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2246 
Êags
 |
FIEMAP_EXTENT_UNWRITTEN
;

2254 
√xt_dñ
 = 
	`pxt4_föd_dñayed_exã¡
(
öode
, &
es
);

2255 i‡(!
exi°s
 && 
√xt_dñ
) {

2256 
exi°s
 = 1;

2257 
Êags
 |(
FIEMAP_EXTENT_DELALLOC
 |

2258 
FIEMAP_EXTENT_UNKNOWN
);

2260 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2262 i‡(
	`u∆ikñy
(
es
.
es_Àn
 == 0)) {

2263 
	`PXT4_ERROR_INODE
(
öode
, "es.es_len == 0");

2264 
îr
 = -
EFSCORRUPTED
;

2279 i‡(
√xt
 =
√xt_dñ
 &&Çexà=
EXT_MAX_BLOCKS
) {

2280 
Êags
 |
FIEMAP_EXTENT_LAST
;

2281 i‡(
	`u∆ikñy
(
√xt_dñ
 !
EXT_MAX_BLOCKS
 ||

2282 
√xt
 !
EXT_MAX_BLOCKS
)) {

2283 
	`PXT4_ERROR_INODE
(
öode
,

2286 
√xt
, 
√xt_dñ
);

2287 
îr
 = -
EFSCORRUPTED
;

2292 i‡(
exi°s
) {

2293 
îr
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
,

2294 (
__u64
)
es
.
es_lblk
 << 
blksize_bôs
,

2295 (
__u64
)
es
.
es_pblk
 << 
blksize_bôs
,

2296 (
__u64
)
es
.
es_Àn
 << 
blksize_bôs
,

2297 
Êags
);

2298 i‡(
îr
 < 0)

2300 i‡(
îr
 == 1) {

2301 
îr
 = 0;

2306 
block
 = 
es
.
es_lblk
 +És.
es_Àn
;

2309 
	`pxt4_ext_dr›_ªfs
(
∑th
);

2310 
	`k‰ì
(
∑th
);

2311  
îr
;

2312 
	}
}

2327 
pxt4_lblk_t
 
	$pxt4_ext_dëîmöe_hﬁe
(
öode
 *inode,

2328 
pxt4_ext_∑th
 *
∑th
,

2329 
pxt4_lblk_t
 *
lblk
)

2331 
dïth
 = 
	`ext_dïth
(
öode
);

2332 
pxt4_exã¡
 *
ex
;

2333 
pxt4_lblk_t
 
Àn
;

2335 
ex
 = 
∑th
[
dïth
].
p_ext
;

2336 i‡(
ex
 =
NULL
) {

2338 *
lblk
 = 0;

2339 
Àn
 = 
EXT_MAX_BLOCKS
;

2340 } i‡(*
lblk
 < 
	`À32_to_˝u
(
ex
->
ì_block
)) {

2341 
Àn
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë- *
lblk
;

2342 } i‡(*
lblk
 >
	`À32_to_˝u
(
ex
->
ì_block
)

2343 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
)) {

2344 
pxt4_lblk_t
 
√xt
;

2346 *
lblk
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
	`pxt4_ext_gë_a˘uÆ_Àn
(ex);

2347 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

2348 
	`BUG_ON
(
√xt
 =*
lblk
);

2349 
Àn
 = 
√xt
 - *
lblk
;

2351 
	`BUG
();

2353  
Àn
;

2354 
	}
}

2362 
	$pxt4_ext_put_g≠_ö_ˇche
(
öode
 *öode, 
pxt4_lblk_t
 
hﬁe_°¨t
,

2363 
pxt4_lblk_t
 
hﬁe_Àn
)

2365 
exã¡_°©us
 
es
;

2367 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
hﬁe_°¨t
,

2368 
hﬁe_°¨t
 + 
hﬁe_Àn
 - 1, &
es
);

2369 i‡(
es
.
es_Àn
) {

2371 i‡(
es
.
es_lblk
 <
hﬁe_°¨t
)

2373 
hﬁe_Àn
 = 
	`mö
(
es
.
es_lblk
 - 
hﬁe_°¨t
, hole_len);

2375 
	`ext_debug
(" -> %u:%u\n", 
hﬁe_°¨t
, 
hﬁe_Àn
);

2376 
	`pxt4_es_ö£π_exã¡
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
, ~0,

2377 
EXTENT_STATUS_HOLE
);

2378 
	}
}

2384 
	$pxt4_ext_rm_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2385 
pxt4_ext_∑th
 *
∑th
, 
dïth
)

2387 
îr
;

2388 
pxt4_fsblk_t
 
Àaf
;

2391 
dïth
--;

2392 
∑th
 =Ö©h + 
dïth
;

2393 
Àaf
 = 
	`pxt4_idx_pblock
(
∑th
->
p_idx
);

2394 i‡(
	`u∆ikñy
(
∑th
->
p_hdr
->
eh_íåõs
 == 0)) {

2395 
	`PXT4_ERROR_INODE
(
öode
, "path->p_hdr->eh_entries == 0");

2396  -
EFSCORRUPTED
;

2398 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2399 i‡(
îr
)

2400  
îr
;

2402 i‡(
∑th
->
p_idx
 !
	`EXT_LAST_INDEX
’©h->
p_hdr
)) {

2403 
Àn
 = 
	`EXT_LAST_INDEX
(
∑th
->
p_hdr
Ë-Ö©h->
p_idx
;

2404 
Àn
 *(
pxt4_exã¡_idx
);

2405 
	`memmove
(
∑th
->
p_idx
,Ö©h->p_idx + 1, 
Àn
);

2408 
	`À16_add_˝u
(&
∑th
->
p_hdr
->
eh_íåõs
, -1);

2409 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2410 i‡(
îr
)

2411  
îr
;

2412 
	`ext_debug
("ödex i†em±y,Ñemovêô, fªêblock %Œu\n", 
Àaf
);

2413 
	`åa˚_pxt4_ext_rm_idx
(
öode
, 
Àaf
);

2415 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
Àaf
, 1,

2416 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

2418 --
dïth
 >= 0) {

2419 i‡(
∑th
->
p_idx
 !
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2421 
∑th
--;

2422 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

2423 i‡(
îr
)

2425 
∑th
->
p_idx
->
ei_block
 = (path+1)->p_idx->ei_block;

2426 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

2427 i‡(
îr
)

2430  
îr
;

2431 
	}
}

2440 
	$pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *öode, 
ƒblocks
,

2441 
pxt4_ext_∑th
 *
∑th
)

2443 i‡(
∑th
) {

2444 
dïth
 = 
	`ext_dïth
(
öode
);

2445 
ªt
 = 0;

2448 i‡(
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_íåõs
)

2449 < 
	`À16_to_˝u
(
∑th
[
dïth
].
p_hdr
->
eh_max
)) {

2460 
ªt
 = 2 + 
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

2461  
ªt
;

2465  
	`pxt4_chunk_å™s_blocks
(
öode
, 
ƒblocks
);

2466 
	}
}

2477 
	$pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
)

2479 
ödex
;

2480 
dïth
;

2483 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2486 
dïth
 = 
	`ext_dïth
(
öode
);

2488 i‡(
exã¡s
 <= 1)

2489 
ödex
 = 
dïth
 * 2;

2491 
ödex
 = 
dïth
 * 3;

2493  
ödex
;

2494 
	}
}

2496 
ölöe
 
	$gë_deÁu…_‰ì_blocks_Êags
(
öode
 *inode)

2498 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

2499 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

2500  
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
;

2501 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2502  
PXT4_FREE_BLOCKS_FORGET
;

2504 
	}
}

2521 
	$pxt4_ªª£rve_˛u°î
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

2523 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2524 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2526 
	`dquŸ_ª˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

2528 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2529 
ei
->
i_ª£rved_d©a_blocks
++;

2530 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 1);

2531 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

2533 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 1);

2534 
	`pxt4_ªmove_≥ndög
(
öode
, 
lblk
);

2535 
	}
}

2537 
	$pxt4_ªmove_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2538 
pxt4_exã¡
 *
ex
,

2539 
∑πül_˛u°î
 *
∑πül
,

2540 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
to
)

2542 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2543 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2544 
pxt4_fsblk_t
 
œ°_pblk
, 
pblk
;

2545 
pxt4_lblk_t
 
num
;

2546 
Êags
;

2549 i‡(
‰om
 < 
	`À32_to_˝u
(
ex
->
ì_block
) ||

2550 
to
 !
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 1) {

2551 
	`pxt4_îr‹
(
sbi
->
s_sb
,

2553 
‰om
, 
to
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_Àn
);

2557 #ifde‡
EXTENTS_STATS


2558 
	`•ö_lock
(&
sbi
->
s_ext_°©s_lock
);

2559 
sbi
->
s_ext_blocks
 +
ì_Àn
;

2560 
sbi
->
s_ext_exã¡s
++;

2561 i‡(
ì_Àn
 < 
sbi
->
s_ext_mö
)

2562 
sbi
->
s_ext_mö
 = 
ì_Àn
;

2563 i‡(
ì_Àn
 > 
sbi
->
s_ext_max
)

2564 
sbi
->
s_ext_max
 = 
ì_Àn
;

2565 i‡(
	`ext_dïth
(
öode
Ë> 
sbi
->
s_dïth_max
)

2566 
sbi
->
s_dïth_max
 = 
	`ext_dïth
(
öode
);

2567 
	`•ö_u∆ock
(&
sbi
->
s_ext_°©s_lock
);

2570 
	`åa˚_pxt4_ªmove_blocks
(
öode
, 
ex
, 
‰om
, 
to
, 
∑πül
);

2576 
œ°_pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 1;

2578 i‡(
∑πül
->
°©e
 !
öôül
 &&

2579 
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
œ°_pblk
)) {

2580 i‡(
∑πül
->
°©e
 =
to‰ì
) {

2581 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2582 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2583 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2584 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2585 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2586 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2587 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2588 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2590 
∑πül
->
°©e
 = 
öôül
;

2593 
num
 = 
	`À32_to_˝u
(
ex
->
ì_block
Ë+ 
ì_Àn
 - 
‰om
;

2594 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ì_Àn
 - 
num
;

2602 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2605 i‡((
	`PXT4_LBLK_COFF
(
sbi
, 
to
Ë!sbi->
s_˛u°î_øtio
 - 1) &&

2606 (
	`PXT4_LBLK_CMASK
(
sbi
, 
to
Ë>
‰om
) &&

2607 (
∑πül
->
°©e
 !
no‰ì
)) {

2608 i‡(
	`pxt4_is_≥ndög
(
öode
, 
to
))

2609 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2610 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2611 
	`PXT4_PBLK_CMASK
(
sbi
, 
œ°_pblk
),

2612 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2613 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2614 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
to
);

2615 
∑πül
->
°©e
 = 
öôül
;

2616 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2619 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
;

2627 
Êags
 |
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
;

2628 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
pblk
, 
num
, 
Êags
);

2631 i‡(
∑πül
->
°©e
 !
öôül
 &&Ö¨tül->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
))

2632 
∑πül
->
°©e
 = 
öôül
;

2644 i‡(
	`PXT4_LBLK_COFF
(
sbi
, 
‰om
Ë&& 
num
 =
ì_Àn
) {

2645 i‡(
∑πül
->
°©e
 =
öôül
) {

2646 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2647 
∑πül
->
lblk
 = 
‰om
;

2648 
∑πül
->
°©e
 = 
to‰ì
;

2651 
∑πül
->
°©e
 = 
öôül
;

2655 
	}
}

2673 
	$pxt4_ext_rm_Àaf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2674 
pxt4_ext_∑th
 *
∑th
,

2675 
∑πül_˛u°î
 *
∑πül
,

2676 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

2678 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2679 
îr
 = 0, 
c‹ª˘_ödex
 = 0;

2680 
dïth
 = 
	`ext_dïth
(
öode
), 
¸edôs
;

2681 
pxt4_exã¡_hódî
 *
eh
;

2682 
pxt4_lblk_t
 
a
, 
b
;

2683 
num
;

2684 
pxt4_lblk_t
 
ex_ì_block
;

2685 
ex_ì_Àn
;

2686 
unwrôãn
 = 0;

2687 
pxt4_exã¡
 *
ex
;

2688 
pxt4_fsblk_t
 
pblk
;

2691 
	`ext_debug
("åunˇã sö˚ %u i¿Àa‡tÿ%u\n", 
°¨t
, 
íd
);

2692 i‡(!
∑th
[
dïth
].
p_hdr
)

2693 
∑th
[
dïth
].
p_hdr
 = 
	`ext_block_hdr
’©h[dïth].
p_bh
);

2694 
eh
 = 
∑th
[
dïth
].
p_hdr
;

2695 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_hdr
 =
NULL
)) {

2696 
	`PXT4_ERROR_INODE
(
öode
, "∑th[%d].p_hd∏=NULL", 
dïth
);

2697  -
EFSCORRUPTED
;

2700 
ex
 = 
∑th
[
dïth
].
p_ext
;

2701 i‡(!
ex
)

2702 
ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

2704 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2705 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2707 
	`åa˚_pxt4_ext_rm_Àaf
(
öode
, 
°¨t
, 
ex
, 
∑πül
);

2709 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
) &&

2710 
ex_ì_block
 + 
ex_ì_Àn
 > 
°¨t
) {

2712 i‡(
	`pxt4_ext_is_unwrôãn
(
ex
))

2713 
unwrôãn
 = 1;

2715 
unwrôãn
 = 0;

2717 
	`ext_debug
("ªmovêexà%u:[%d]%d\n", 
ex_ì_block
,

2718 
unwrôãn
, 
ex_ì_Àn
);

2719 
∑th
[
dïth
].
p_ext
 = 
ex
;

2721 
a
 = 
ex_ì_block
 > 
°¨t
 ?Éx_ee_block : start;

2722 
b
 = 
ex_ì_block
+
ex_ì_Àn
 - 1 < 
íd
 ?

2723 
ex_ì_block
+
ex_ì_Àn
 - 1 : 
íd
;

2725 
	`ext_debug
(" b‹dî %u:%u\n", 
a
, 
b
);

2728 i‡(
íd
 < 
ex_ì_block
) {

2736 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2737 
pblk
 = 
	`pxt4_ext_pblock
(
ex
);

2738 
∑πül
->
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2739 
∑πül
->
°©e
 = 
no‰ì
;

2741 
ex
--;

2742 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2743 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2745 } i‡(
b
 !
ex_ì_block
 + 
ex_ì_Àn
 - 1) {

2746 
	`PXT4_ERROR_INODE
(
öode
,

2749 
°¨t
, 
íd
, 
ex_ì_block
,

2750 
ex_ì_block
 + 
ex_ì_Àn
 - 1);

2751 
îr
 = -
EFSCORRUPTED
;

2752 
out
;

2753 } i‡(
a
 !
ex_ì_block
) {

2755 
num
 = 
a
 - 
ex_ì_block
;

2758 
num
 = 0;

2766 
¸edôs
 = 7 + 2*(
ex_ì_Àn
/
	`PXT4_BLOCKS_PER_GROUP
(
öode
->
i_sb
));

2767 i‡(
ex
 =
	`EXT_FIRST_EXTENT
(
eh
)) {

2768 
c‹ª˘_ödex
 = 1;

2769 
¸edôs
 +(
	`ext_dïth
(
öode
)) + 1;

2771 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

2773 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

2774 i‡(
îr
)

2775 
out
;

2777 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2778 i‡(
îr
)

2779 
out
;

2781 
îr
 = 
	`pxt4_ªmove_blocks
(
h™dÀ
, 
öode
, 
ex
, 
∑πül
, 
a
, 
b
);

2782 i‡(
îr
)

2783 
out
;

2785 i‡(
num
 == 0)

2787 
	`pxt4_ext_°‹e_pblock
(
ex
, 0);

2789 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
num
);

2794 i‡(
unwrôãn
 && 
num
)

2795 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

2800 i‡(
num
 == 0) {

2801 i‡(
íd
 !
EXT_MAX_BLOCKS
 - 1) {

2807 
	`memmove
(
ex
,Éx+1, (
	`EXT_LAST_EXTENT
(
eh
) -Éx) *

2808 (
pxt4_exã¡
));

2811 
	`mem£t
(
	`EXT_LAST_EXTENT
(
eh
), 0,

2812 (
pxt4_exã¡
));

2814 
	`À16_add_˝u
(&
eh
->
eh_íåõs
, -1);

2817 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

2818 i‡(
îr
)

2819 
out
;

2821 
	`ext_debug
("√wÉxã¡: %u:%u:%Œu\n", 
ex_ì_block
, 
num
,

2822 
	`pxt4_ext_pblock
(
ex
));

2823 
ex
--;

2824 
ex_ì_block
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

2825 
ex_ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

2828 i‡(
c‹ª˘_ödex
 && 
eh
->
eh_íåõs
)

2829 
îr
 = 
	`pxt4_ext_c‹ª˘_ödexes
(
h™dÀ
, 
öode
, 
∑th
);

2838 i‡(
∑πül
->
°©e
 =
to‰ì
 && 
ex
 >
	`EXT_FIRST_EXTENT
(
eh
)) {

2839 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
ex_ì_Àn
 - 1;

2840 i‡(
∑πül
->
p˛u
 !
	`PXT4_B2C
(
sbi
, 
pblk
)) {

2841 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

2843 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
->
lblk
))

2844 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

2845 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

2846 
	`PXT4_C2B
(
sbi
, 
∑πül
->
p˛u
),

2847 
sbi
->
s_˛u°î_øtio
, 
Êags
);

2848 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

2849 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
->
lblk
);

2851 
∑πül
->
°©e
 = 
öôül
;

2856 i‡(
îr
 =0 && 
eh
->
eh_íåõs
 =0 && 
∑th
[
dïth
].
p_bh
 !
NULL
)

2857 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
dïth
);

2859 
out
:

2860  
îr
;

2861 
	}
}

2868 
	$pxt4_ext_m‹e_to_rm
(
pxt4_ext_∑th
 *
∑th
)

2870 
	`BUG_ON
(
∑th
->
p_idx
 =
NULL
);

2872 i‡(
∑th
->
p_idx
 < 
	`EXT_FIRST_INDEX
’©h->
p_hdr
))

2879 i‡(
	`À16_to_˝u
(
∑th
->
p_hdr
->
eh_íåõs
Ë=∑th->
p_block
)

2882 
	}
}

2884 
	$pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

2885 
pxt4_lblk_t
 
íd
)

2887 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2888 
dïth
 = 
	`ext_dïth
(
öode
);

2889 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

2890 
∑πül_˛u°î
 
∑πül
;

2891 
h™dÀ_t
 *
h™dÀ
;

2892 
i
 = 0, 
îr
 = 0;

2894 
∑πül
.
p˛u
 = 0;

2895 
∑πül
.
lblk
 = 0;

2896 
∑πül
.
°©e
 = 
öôül
;

2898 
	`ext_debug
("åunˇã sö˚ %uÅÿ%u\n", 
°¨t
, 
íd
);

2901 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
dïth
 + 1);

2902 i‡(
	`IS_ERR
(
h™dÀ
))

2903  
	`PTR_ERR
(
h™dÀ
);

2905 
agaö
:

2906 
	`åa˚_pxt4_ext_ªmove_•a˚
(
öode
, 
°¨t
, 
íd
, 
dïth
);

2915 i‡(
íd
 < 
EXT_MAX_BLOCKS
 - 1) {

2916 
pxt4_exã¡
 *
ex
;

2917 
pxt4_lblk_t
 
ì_block
, 
ex_íd
, 
lblk
;

2918 
pxt4_fsblk_t
 
pblk
;

2921 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
íd
, 
NULL
, 
PXT4_EX_NOCACHE
);

2922 i‡(
	`IS_ERR
(
∑th
)) {

2923 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2924  
	`PTR_ERR
(
∑th
);

2926 
dïth
 = 
	`ext_dïth
(
öode
);

2928 
ex
 = 
∑th
[
dïth
].
p_ext
;

2929 i‡(!
ex
) {

2930 i‡(
dïth
) {

2931 
	`PXT4_ERROR_INODE
(
öode
,

2933 
dïth
);

2934 
îr
 = -
EFSCORRUPTED
;

2936 
out
;

2939 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

2940 
ex_íd
 = 
ì_block
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
) - 1;

2948 i‡(
íd
 >
ì_block
 &&Énd < 
ex_íd
) {

2955 i‡(
sbi
->
s_˛u°î_øtio
 > 1) {

2956 
pblk
 = 
	`pxt4_ext_pblock
(
ex
Ë+ 
íd
 - 
ì_block
 + 2;

2957 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2958 
∑πül
.
°©e
 = 
no‰ì
;

2967 
îr
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

2968 
íd
 + 1, 1);

2969 i‡(
îr
 < 0)

2970 
out
;

2972 } i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
íd
 >
ex_íd
 &&

2973 
∑πül
.
°©e
 =
öôül
) {

2984 
lblk
 = 
ex_íd
 + 1;

2985 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
lblk
, &
pblk
,

2986 &
ex
);

2987 i‡(
îr
)

2988 
out
;

2989 i‡(
pblk
) {

2990 
∑πül
.
p˛u
 = 
	`PXT4_B2C
(
sbi
, 
pblk
);

2991 
∑πül
.
°©e
 = 
no‰ì
;

2999 
dïth
 = 
	`ext_dïth
(
öode
);

3000 i‡(
∑th
) {

3001 
k
 = 
i
 = 
dïth
;

3002 --
k
 > 0)

3003 
∑th
[
k
].
p_block
 =

3004 
	`À16_to_˝u
(
∑th
[
k
].
p_hdr
->
eh_íåõs
)+1;

3006 
∑th
 = 
	`kˇŒoc
(
dïth
 + 1, (
pxt4_ext_∑th
),

3007 
GFP_NOFS
);

3008 i‡(
∑th
 =
NULL
) {

3009 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3010  -
ENOMEM
;

3012 
∑th
[0].
p_maxdïth
 =Ö©h[0].
p_dïth
 = 
dïth
;

3013 
∑th
[0].
p_hdr
 = 
	`ext_öode_hdr
(
öode
);

3014 
i
 = 0;

3016 i‡(
	`pxt4_ext_check
(
öode
, 
∑th
[0].
p_hdr
, 
dïth
, 0)) {

3017 
îr
 = -
EFSCORRUPTED
;

3018 
out
;

3021 
îr
 = 0;

3023 
i
 >0 && 
îr
 == 0) {

3024 i‡(
i
 =
dïth
) {

3026 
îr
 = 
	`pxt4_ext_rm_Àaf
(
h™dÀ
, 
öode
, 
∑th
,

3027 &
∑πül
, 
°¨t
, 
íd
);

3029 
	`bªl£
(
∑th
[
i
].
p_bh
);

3030 
∑th
[
i
].
p_bh
 = 
NULL
;

3031 
i
--;

3036 i‡(!
∑th
[
i
].
p_hdr
) {

3037 
	`ext_debug
("initialize header\n");

3038 
∑th
[
i
].
p_hdr
 = 
	`ext_block_hdr
’©h[i].
p_bh
);

3041 i‡(!
∑th
[
i
].
p_idx
) {

3043 
∑th
[
i
].
p_idx
 = 
	`EXT_LAST_INDEX
’©h[i].
p_hdr
);

3044 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
)+1;

3045 
	`ext_debug
("init indexÖtr: hdr 0x%p,Çum %d\n",

3046 
∑th
[
i
].
p_hdr
,

3047 
	`À16_to_˝u
(
∑th
[
i
].
p_hdr
->
eh_íåõs
));

3050 
∑th
[
i
].
p_idx
--;

3053 
	`ext_debug
("level %d - index, first 0x%p, cur 0x%p\n",

3054 
i
, 
	`EXT_FIRST_INDEX
(
∑th
[i].
p_hdr
),

3055 
∑th
[
i
].
p_idx
);

3056 i‡(
	`pxt4_ext_m‹e_to_rm
(
∑th
 + 
i
)) {

3057 
buf„r_hód
 *
bh
;

3059 
	`ext_debug
("moveÅoÜevel %d (block %llu)\n",

3060 
i
 + 1, 
	`pxt4_idx_pblock
(
∑th
[i].
p_idx
));

3061 
	`mem£t
(
∑th
 + 
i
 + 1, 0, (*path));

3062 
bh
 = 
	`ªad_exã¡_åì_block
(
öode
,

3063 
	`pxt4_idx_pblock
(
∑th
[
i
].
p_idx
), 
dïth
 - i - 1,

3064 
PXT4_EX_NOCACHE
);

3065 i‡(
	`IS_ERR
(
bh
)) {

3067 
îr
 = 
	`PTR_ERR
(
bh
);

3072 
	`c⁄d_ªsched
();

3073 i‡(
	`WARN_ON
(
i
 + 1 > 
dïth
)) {

3074 
îr
 = -
EFSCORRUPTED
;

3077 
∑th
[
i
 + 1].
p_bh
 = 
bh
;

3081 
∑th
[
i
].
p_block
 = 
	`À16_to_˝u
’©h[i].
p_hdr
->
eh_íåõs
);

3082 
i
++;

3085 i‡(
∑th
[
i
].
p_hdr
->
eh_íåõs
 == 0 && i > 0) {

3089 
îr
 = 
	`pxt4_ext_rm_idx
(
h™dÀ
, 
öode
, 
∑th
, 
i
);

3092 
	`bªl£
(
∑th
[
i
].
p_bh
);

3093 
∑th
[
i
].
p_bh
 = 
NULL
;

3094 
i
--;

3095 
	`ext_debug
("ªtu∫ÅÿÀvñ %d\n", 
i
);

3099 
	`åa˚_pxt4_ext_ªmove_•a˚_d⁄e
(
öode
, 
°¨t
, 
íd
, 
dïth
, &
∑πül
,

3100 
∑th
->
p_hdr
->
eh_íåõs
);

3106 i‡(
∑πül
.
°©e
 =
to‰ì
 && 
îr
 == 0) {

3107 
Êags
 = 
	`gë_deÁu…_‰ì_blocks_Êags
(
öode
);

3109 i‡(
	`pxt4_is_≥ndög
(
öode
, 
∑πül
.
lblk
))

3110 
Êags
 |
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
;

3111 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

3112 
	`PXT4_C2B
(
sbi
, 
∑πül
.
p˛u
),

3113 
sbi
->
s_˛u°î_øtio
, 
Êags
);

3114 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)

3115 
	`pxt4_ªª£rve_˛u°î
(
öode
, 
∑πül
.
lblk
);

3116 
∑πül
.
°©e
 = 
öôül
;

3120 i‡(
∑th
->
p_hdr
->
eh_íåõs
 == 0) {

3125 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

3126 i‡(
îr
 == 0) {

3127 
	`ext_öode_hdr
(
öode
)->
eh_dïth
 = 0;

3128 
	`ext_öode_hdr
(
öode
)->
eh_max
 =

3129 
	`˝u_to_À16
(
	`pxt4_ext_•a˚_roŸ
(
öode
, 0));

3130 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
);

3133 
out
:

3134 
	`pxt4_ext_dr›_ªfs
(
∑th
);

3135 
	`k‰ì
(
∑th
);

3136 
∑th
 = 
NULL
;

3137 i‡(
îr
 =-
EAGAIN
)

3138 
agaö
;

3139 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3141  
îr
;

3142 
	}
}

3147 
	$pxt4_ext_öô
(
su≥r_block
 *
sb
)

3153 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

3154 #i‡
	`deföed
(
AGGRESSIVE_TEST
Ë|| deföed(
CHECK_BINSEARCH
Ë|| deföed(
EXTENTS_STATS
)

3155 
	`¥ötk
(
KERN_INFO
 "PXT4-fs: fileÉxtentsÉnabled"

3156 #ifde‡
AGGRESSIVE_TEST


3159 #ifde‡
CHECK_BINSEARCH


3162 #ifde‡
EXTENTS_STATS


3167 #ifde‡
EXTENTS_STATS


3168 
	`•ö_lock_öô
(&
	`PXT4_SB
(
sb
)->
s_ext_°©s_lock
);

3169 
	`PXT4_SB
(
sb
)->
s_ext_mö
 = 1 << 30;

3170 
	`PXT4_SB
(
sb
)->
s_ext_max
 = 0;

3173 
	}
}

3178 
	$pxt4_ext_ªÀa£
(
su≥r_block
 *
sb
)

3180 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3183 #ifde‡
EXTENTS_STATS


3184 i‡(
	`PXT4_SB
(
sb
)->
s_ext_blocks
 && PXT4_SB(sb)->
s_ext_exã¡s
) {

3185 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3186 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %lu blocks in %luÉxtents (%luáve)\n",

3187 
sbi
->
s_ext_blocks
, sbi->
s_ext_exã¡s
,

3188 
sbi
->
s_ext_blocks
 / sbi->
s_ext_exã¡s
);

3189 
	`¥ötk
(
KERN_ERR
 "PXT4-fs:Éxtents: %lu min, %lu max, max depth %lu\n",

3190 
sbi
->
s_ext_mö
, sbi->
s_ext_max
, sbi->
s_dïth_max
);

3193 
	}
}

3195 
	$pxt4_zîoout_es
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3197 
pxt4_lblk_t
 
ì_block
;

3198 
pxt4_fsblk_t
 
ì_pblock
;

3199 
ì_Àn
;

3201 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3202 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3203 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3205 i‡(
ì_Àn
 == 0)

3208  
	`pxt4_es_ö£π_exã¡
(
öode
, 
ì_block
, 
ì_Àn
, 
ì_pblock
,

3209 
EXTENT_STATUS_WRITTEN
);

3210 
	}
}

3213 
	$pxt4_ext_zîoout
(
öode
 *öode, 
pxt4_exã¡
 *
ex
)

3215 
pxt4_fsblk_t
 
ì_pblock
;

3216 
ì_Àn
;

3218 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3219 
ì_pblock
 = 
	`pxt4_ext_pblock
(
ex
);

3220  
	`pxt4_issue_zîoout
(
öode
, 
	`À32_to_˝u
(
ex
->
ì_block
), 
ì_pblock
,

3221 
ì_Àn
);

3222 
	}
}

3245 
	$pxt4_•lô_exã¡_©
(
h™dÀ_t
 *
h™dÀ
,

3246 
öode
 *inode,

3247 
pxt4_ext_∑th
 **
µ©h
,

3248 
pxt4_lblk_t
 
•lô
,

3249 
•lô_Êag
,

3250 
Êags
)

3252 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3253 
pxt4_fsblk_t
 
√wblock
;

3254 
pxt4_lblk_t
 
ì_block
;

3255 
pxt4_exã¡
 *
ex
, 
√wex
, 
‹ig_ex
, 
zîo_ex
;

3256 
pxt4_exã¡
 *
ex2
 = 
NULL
;

3257 
ì_Àn
, 
dïth
;

3258 
îr
 = 0;

3260 
	`BUG_ON
((
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
)) ==

3261 (
PXT4_EXT_DATA_VALID1
 | 
PXT4_EXT_DATA_VALID2
));

3263 
	`ext_debug
("pxt4_split_extents_at: inode %lu,Üogical"

3264 "block %Œu\n", 
öode
->
i_öo
, ()
•lô
);

3266 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3268 
dïth
 = 
	`ext_dïth
(
öode
);

3269 
ex
 = 
∑th
[
dïth
].
p_ext
;

3270 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3271 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3272 
√wblock
 = 
•lô
 - 
ì_block
 + 
	`pxt4_ext_pblock
(
ex
);

3274 
	`BUG_ON
(
•lô
 < 
ì_block
 || s∂ô >”e_block + 
ì_Àn
));

3275 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
) &&

3276 
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3277 
PXT4_EXT_MARK_UNWRIT1
 |

3278 
PXT4_EXT_MARK_UNWRIT2
));

3280 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3281 i‡(
îr
)

3282 
out
;

3284 i‡(
•lô
 =
ì_block
) {

3290 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3291 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3293 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3295 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
))

3296 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3298 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3299 
out
;

3303 
	`mem˝y
(&
‹ig_ex
, 
ex
, (orig_ex));

3304 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(
•lô
 - 
ì_block
);

3305 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT1
)

3306 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3312 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3313 i‡(
îr
)

3314 
fix_exã¡_Àn
;

3316 
ex2
 = &
√wex
;

3317 
ex2
->
ì_block
 = 
	`˝u_to_À32
(
•lô
);

3318 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- (
•lô
 - 
ì_block
));

3319 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
√wblock
);

3320 i‡(
•lô_Êag
 & 
PXT4_EXT_MARK_UNWRIT2
)

3321 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

3323 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
√wex
, 
Êags
);

3324 i‡(
îr
 =-
ENOSPC
 && (
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)) {

3325 i‡(
•lô_Êag
 & (
PXT4_EXT_DATA_VALID1
|
PXT4_EXT_DATA_VALID2
)) {

3326 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID1
) {

3327 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex2
);

3328 
zîo_ex
.
ì_block
 = 
ex2
->ee_block;

3329 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3330 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
));

3331 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3332 
	`pxt4_ext_pblock
(
ex2
));

3334 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, 
ex
);

3335 
zîo_ex
.
ì_block
 = 
ex
->ee_block;

3336 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3337 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
));

3338 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3339 
	`pxt4_ext_pblock
(
ex
));

3342 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
‹ig_ex
);

3343 
zîo_ex
.
ì_block
 = 
‹ig_ex
.ee_block;

3344 
zîo_ex
.
ì_Àn
 = 
	`˝u_to_À16
(

3345 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
‹ig_ex
));

3346 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex
,

3347 
	`pxt4_ext_pblock
(&
‹ig_ex
));

3350 i‡(
îr
)

3351 
fix_exã¡_Àn
;

3353 
ex
->
ì_Àn
 = 
	`˝u_to_À16
(ee_len);

3354 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3355 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3356 i‡(
îr
)

3357 
fix_exã¡_Àn
;

3360 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex
);

3362 
out
;

3363 } i‡(
îr
)

3364 
fix_exã¡_Àn
;

3366 
out
:

3367 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3368  
îr
;

3370 
fix_exã¡_Àn
:

3371 
ex
->
ì_Àn
 = 
‹ig_ex
.ee_len;

3372 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3373  
îr
;

3374 
	}
}

3387 
	$pxt4_•lô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

3388 
öode
 *inode,

3389 
pxt4_ext_∑th
 **
µ©h
,

3390 
pxt4_m≠_blocks
 *
m≠
,

3391 
•lô_Êag
,

3392 
Êags
)

3394 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3395 
pxt4_lblk_t
 
ì_block
;

3396 
pxt4_exã¡
 *
ex
;

3397 
ì_Àn
, 
dïth
;

3398 
îr
 = 0;

3399 
unwrôãn
;

3400 
•lô_Êag1
, 
Êags1
;

3401 
Æloˇãd
 = 
m≠
->
m_Àn
;

3403 
dïth
 = 
	`ext_dïth
(
öode
);

3404 
ex
 = 
∑th
[
dïth
].
p_ext
;

3405 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3406 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3407 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3409 i‡(
m≠
->
m_lblk
 + m≠->
m_Àn
 < 
ì_block
 + 
ì_Àn
) {

3410 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_MAY_ZEROOUT
;

3411 
Êags1
 = 
Êags
 | 
PXT4_GET_BLOCKS_PRE_IO
;

3412 i‡(
unwrôãn
)

3413 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
 |

3414 
PXT4_EXT_MARK_UNWRIT2
;

3415 i‡(
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
)

3416 
•lô_Êag1
 |
PXT4_EXT_DATA_VALID1
;

3417 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3418 
m≠
->
m_lblk
 + m≠->
m_Àn
, 
•lô_Êag1
, 
Êags1
);

3419 i‡(
îr
)

3420 
out
;

3422 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3428 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3429 i‡(
	`IS_ERR
(
∑th
))

3430  
	`PTR_ERR
(
∑th
);

3431 
dïth
 = 
	`ext_dïth
(
öode
);

3432 
ex
 = 
∑th
[
dïth
].
p_ext
;

3433 i‡(!
ex
) {

3434 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3435 (Ë
m≠
->
m_lblk
);

3436  -
EFSCORRUPTED
;

3438 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

3439 
•lô_Êag1
 = 0;

3441 i‡(
m≠
->
m_lblk
 >
ì_block
) {

3442 
•lô_Êag1
 = 
•lô_Êag
 & 
PXT4_EXT_DATA_VALID2
;

3443 i‡(
unwrôãn
) {

3444 
•lô_Êag1
 |
PXT4_EXT_MARK_UNWRIT1
;

3445 
•lô_Êag1
 |
•lô_Êag
 & (
PXT4_EXT_MAY_ZEROOUT
 |

3446 
PXT4_EXT_MARK_UNWRIT2
);

3448 
îr
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, 
µ©h
,

3449 
m≠
->
m_lblk
, 
•lô_Êag1
, 
Êags
);

3450 i‡(
îr
)

3451 
out
;

3454 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3455 
out
:

3456  
îr
 ?Éº : 
Æloˇãd
;

3457 
	}
}

3479 
	$pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ_t
 *
h™dÀ
,

3480 
öode
 *inode,

3481 
pxt4_m≠_blocks
 *
m≠
,

3482 
pxt4_ext_∑th
 **
µ©h
,

3483 
Êags
)

3485 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3486 
pxt4_sb_öfo
 *
sbi
;

3487 
pxt4_exã¡_hódî
 *
eh
;

3488 
pxt4_m≠_blocks
 
•lô_m≠
;

3489 
pxt4_exã¡
 
zîo_ex1
, 
zîo_ex2
;

3490 
pxt4_exã¡
 *
ex
, *
abut_ex
;

3491 
pxt4_lblk_t
 
ì_block
, 
eof_block
;

3492 
ì_Àn
, 
dïth
, 
m≠_Àn
 = 
m≠
->
m_Àn
;

3493 
Æloˇãd
 = 0, 
max_zîoout
 = 0;

3494 
îr
 = 0;

3495 
•lô_Êag
 = 
PXT4_EXT_DATA_VALID2
;

3497 
	`ext_debug
("pxt4_ext_convert_to_initialized: inode %lu,Üogical"

3498 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3499 ()
m≠
->
m_lblk
, 
m≠_Àn
);

3501 
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3502 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3503 
öode
->
i_sb
->
s_blocksize_bôs
;

3504 i‡(
eof_block
 < 
m≠
->
m_lblk
 + 
m≠_Àn
)

3505 
eof_block
 = 
m≠
->
m_lblk
 + 
m≠_Àn
;

3507 
dïth
 = 
	`ext_dïth
(
öode
);

3508 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3509 
ex
 = 
∑th
[
dïth
].
p_ext
;

3510 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3511 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3512 
zîo_ex1
.
ì_Àn
 = 0;

3513 
zîo_ex2
.
ì_Àn
 = 0;

3515 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_íãr
(
öode
, 
m≠
, 
ex
);

3518 
	`BUG_ON
(!
	`pxt4_ext_is_unwrôãn
(
ex
));

3519 
	`BUG_ON
(!
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
));

3536 i‡((
m≠
->
m_lblk
 =
ì_block
) &&

3538 (
m≠_Àn
 < 
ì_Àn
) &&

3539 (
ex
 > 
	`EXT_FIRST_EXTENT
(
eh
))) {

3540 
pxt4_lblk_t
 
¥ev_lblk
;

3541 
pxt4_fsblk_t
 
¥ev_pblk
, 
ì_pblk
;

3542 
¥ev_Àn
;

3544 
abut_ex
 = 
ex
 - 1;

3545 
¥ev_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3546 
¥ev_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3547 
¥ev_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3548 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3559 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3560 ((
¥ev_lblk
 + 
¥ev_Àn
Ë=
ì_block
) &&

3561 ((
¥ev_pblk
 + 
¥ev_Àn
Ë=
ì_pblk
) &&

3562 (
¥ev_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3563 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3564 i‡(
îr
)

3565 
out
;

3567 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3568 
m≠
, 
ex
, 
abut_ex
);

3571 
ex
->
ì_block
 = 
	`˝u_to_À32
”e_block + 
m≠_Àn
);

3572 
	`pxt4_ext_°‹e_pblock
(
ex
, 
ì_pblk
 + 
m≠_Àn
);

3573 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3574 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3577 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
¥ev_Àn
 + 
m≠_Àn
);

3580 
Æloˇãd
 = 
m≠_Àn
;

3582 } i‡(((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=(
ì_block
 + 
ì_Àn
)) &&

3583 (
m≠_Àn
 < 
ì_Àn
) &&

3584 
ex
 < 
	`EXT_LAST_EXTENT
(
eh
)) {

3586 
pxt4_lblk_t
 
√xt_lblk
;

3587 
pxt4_fsblk_t
 
√xt_pblk
, 
ì_pblk
;

3588 
√xt_Àn
;

3590 
abut_ex
 = 
ex
 + 1;

3591 
√xt_lblk
 = 
	`À32_to_˝u
(
abut_ex
->
ì_block
);

3592 
√xt_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
abut_ex
);

3593 
√xt_pblk
 = 
	`pxt4_ext_pblock
(
abut_ex
);

3594 
ì_pblk
 = 
	`pxt4_ext_pblock
(
ex
);

3605 i‡((!
	`pxt4_ext_is_unwrôãn
(
abut_ex
)) &&

3606 ((
m≠
->
m_lblk
 + 
m≠_Àn
Ë=
√xt_lblk
) &&

3607 ((
ì_pblk
 + 
ì_Àn
Ë=
√xt_pblk
) &&

3608 (
√xt_Àn
 < (
EXT_INIT_MAX_LEN
 - 
m≠_Àn
))) {

3609 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3610 i‡(
îr
)

3611 
out
;

3613 
	`åa˚_pxt4_ext_c⁄vît_to_öôülized_Á°∑th
(
öode
,

3614 
m≠
, 
ex
, 
abut_ex
);

3617 
abut_ex
->
ì_block
 = 
	`˝u_to_À32
(
√xt_lblk
 - 
m≠_Àn
);

3618 
	`pxt4_ext_°‹e_pblock
(
abut_ex
, 
√xt_pblk
 - 
m≠_Àn
);

3619 
ex
->
ì_Àn
 = 
	`˝u_to_À16
”e_À¿- 
m≠_Àn
);

3620 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3623 
abut_ex
->
ì_Àn
 = 
	`˝u_to_À16
(
√xt_Àn
 + 
m≠_Àn
);

3626 
Æloˇãd
 = 
m≠_Àn
;

3629 i‡(
Æloˇãd
) {

3631 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3634 
∑th
[
dïth
].
p_ext
 = 
abut_ex
;

3635 
out
;

3637 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

3639 
	`WARN_ON
(
m≠
->
m_lblk
 < 
ì_block
);

3644 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ? 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3646 i‡(
PXT4_EXT_MAY_ZEROOUT
 & 
•lô_Êag
)

3647 
max_zîoout
 = 
sbi
->
s_exã¡_max_zîoout_kb
 >>

3648 (
öode
->
i_sb
->
s_blocksize_bôs
 - 10);

3650 i‡(
	`IS_ENCRYPTED
(
öode
))

3651 
max_zîoout
 = 0;

3664 
•lô_m≠
.
m_lblk
 = 
m≠
->m_lblk;

3665 
•lô_m≠
.
m_Àn
 = 
m≠
->m_len;

3667 i‡(
max_zîoout
 && (
Æloˇãd
 > 
•lô_m≠
.
m_Àn
)) {

3668 i‡(
Æloˇãd
 <
max_zîoout
) {

3670 
zîo_ex1
.
ì_block
 =

3671 
	`˝u_to_À32
(
•lô_m≠
.
m_lblk
 +

3672 
•lô_m≠
.
m_Àn
);

3673 
zîo_ex1
.
ì_Àn
 =

3674 
	`˝u_to_À16
(
Æloˇãd
 - 
•lô_m≠
.
m_Àn
);

3675 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex1
,

3676 
	`pxt4_ext_pblock
(
ex
Ë+ 
•lô_m≠
.
m_lblk
 +

3677 
•lô_m≠
.
m_Àn
 - 
ì_block
);

3678 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex1
);

3679 i‡(
îr
)

3680 
out
;

3681 
•lô_m≠
.
m_Àn
 = 
Æloˇãd
;

3683 i‡(
•lô_m≠
.
m_lblk
 - 
ì_block
 + s∂ô_m≠.
m_Àn
 <

3684 
max_zîoout
) {

3686 i‡(
•lô_m≠
.
m_lblk
 !
ì_block
) {

3687 
zîo_ex2
.
ì_block
 = 
ex
->ee_block;

3688 
zîo_ex2
.
ì_Àn
 = 
	`˝u_to_À16
(
•lô_m≠
.
m_lblk
 -

3689 
ì_block
);

3690 
	`pxt4_ext_°‹e_pblock
(&
zîo_ex2
,

3691 
	`pxt4_ext_pblock
(
ex
));

3692 
îr
 = 
	`pxt4_ext_zîoout
(
öode
, &
zîo_ex2
);

3693 i‡(
îr
)

3694 
out
;

3697 
•lô_m≠
.
m_Àn
 +•lô_m≠.
m_lblk
 - 
ì_block
;

3698 
•lô_m≠
.
m_lblk
 = 
ì_block
;

3699 
Æloˇãd
 = 
m≠
->
m_Àn
;

3703 
îr
 = 
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, &
•lô_m≠
, 
•lô_Êag
,

3704 
Êags
);

3705 i‡(
îr
 > 0)

3706 
îr
 = 0;

3707 
out
:

3709 i‡(!
îr
) {

3710 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex1
);

3711 i‡(!
îr
)

3712 
îr
 = 
	`pxt4_zîoout_es
(
öode
, &
zîo_ex2
);

3714  
îr
 ?Éº : 
Æloˇãd
;

3715 
	}
}

3741 
	$pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ_t
 *
h™dÀ
,

3742 
öode
 *inode,

3743 
pxt4_m≠_blocks
 *
m≠
,

3744 
pxt4_ext_∑th
 **
µ©h
,

3745 
Êags
)

3747 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3748 
pxt4_lblk_t
 
eof_block
;

3749 
pxt4_lblk_t
 
ì_block
;

3750 
pxt4_exã¡
 *
ex
;

3751 
ì_Àn
;

3752 
•lô_Êag
 = 0, 
dïth
;

3754 
	`ext_debug
("%s: inode %lu,Üogical block %llu, max_blocks %u\n",

3755 
__func__
, 
öode
->
i_öo
,

3756 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3758 
eof_block
 = (
öode
->
i_size
 + inode->
i_sb
->
s_blocksize
 - 1) >>

3759 
öode
->
i_sb
->
s_blocksize_bôs
;

3760 i‡(
eof_block
 < 
m≠
->
m_lblk
 + m≠->
m_Àn
)

3761 
eof_block
 = 
m≠
->
m_lblk
 + m≠->
m_Àn
;

3766 
dïth
 = 
	`ext_dïth
(
öode
);

3767 
ex
 = 
∑th
[
dïth
].
p_ext
;

3768 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3769 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3772 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
) {

3773 
•lô_Êag
 |
PXT4_EXT_DATA_VALID1
;

3775 } i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

3776 
•lô_Êag
 |
ì_block
 + 
ì_Àn
 <
eof_block
 ?

3777 
PXT4_EXT_MAY_ZEROOUT
 : 0;

3778 
•lô_Êag
 |(
PXT4_EXT_MARK_UNWRIT2
 | 
PXT4_EXT_DATA_VALID2
);

3780 
Êags
 |
PXT4_GET_BLOCKS_PRE_IO
;

3781  
	`pxt4_•lô_exã¡
(
h™dÀ
, 
öode
, 
µ©h
, 
m≠
, 
•lô_Êag
, 
Êags
);

3782 
	}
}

3784 
	$pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ_t
 *
h™dÀ
,

3785 
öode
 *inode,

3786 
pxt4_m≠_blocks
 *
m≠
,

3787 
pxt4_ext_∑th
 **
µ©h
)

3789 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3790 
pxt4_exã¡
 *
ex
;

3791 
pxt4_lblk_t
 
ì_block
;

3792 
ì_Àn
;

3793 
dïth
;

3794 
îr
 = 0;

3796 
dïth
 = 
	`ext_dïth
(
öode
);

3797 
ex
 = 
∑th
[
dïth
].
p_ext
;

3798 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3799 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3801 
	`ext_debug
("pxt4_convert_unwritten_extents_endio: inode %lu,Üogical"

3802 "block %Œu, max_block†%u\n", 
öode
->
i_öo
,

3803 ()
ì_block
, 
ì_Àn
);

3811 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3812 #ifde‡
PXT4_DEBUG


3813 
	`pxt4_w¨nög
("Inode (%ld) finished:ÉxtentÜogical block %llu,"

3815 
öode
->
i_öo
, ()
ì_block
, 
ì_Àn
,

3816 ()
m≠
->
m_lblk
, m≠->
m_Àn
);

3818 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3819 
PXT4_GET_BLOCKS_CONVERT
);

3820 i‡(
îr
 < 0)

3821  
îr
;

3822 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3823 i‡(
	`IS_ERR
(
∑th
))

3824  
	`PTR_ERR
(
∑th
);

3825 
dïth
 = 
	`ext_dïth
(
öode
);

3826 
ex
 = 
∑th
[
dïth
].
p_ext
;

3829 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3830 i‡(
îr
)

3831 
out
;

3833 
	`pxt4_ext_m¨k_öôülized
(
ex
);

3838 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3841 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3842 
out
:

3843 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3844  
îr
;

3845 
	}
}

3850 
	$check_eofblocks_Ê
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3851 
pxt4_lblk_t
 
lblk
,

3852 
pxt4_ext_∑th
 *
∑th
,

3853 
Àn
)

3855 
i
, 
dïth
;

3856 
pxt4_exã¡_hódî
 *
eh
;

3857 
pxt4_exã¡
 *
œ°_ex
;

3859 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
))

3862 
dïth
 = 
	`ext_dïth
(
öode
);

3863 
eh
 = 
∑th
[
dïth
].
p_hdr
;

3870 i‡(
	`u∆ikñy
(!
eh
->
eh_íåõs
))

3871 
out
;

3872 
œ°_ex
 = 
	`EXT_LAST_EXTENT
(
eh
);

3882 i‡(
lblk
 + 
Àn
 < 
	`À32_to_˝u
(
œ°_ex
->
ì_block
) +

3883 
	`pxt4_ext_gë_a˘uÆ_Àn
(
œ°_ex
))

3892 
i
 = 
dïth
-1; i >= 0; i--)

3893 i‡(
∑th
[
i
].
p_idx
 !
	`EXT_LAST_INDEX
’©h[i].
p_hdr
))

3895 
out
:

3896 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

3897  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3898 
	}
}

3901 
	$c⁄vît_öôülized_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3902 
pxt4_m≠_blocks
 *
m≠
,

3903 
pxt4_ext_∑th
 **
µ©h
,

3904 
Æloˇãd
)

3906 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3907 
pxt4_exã¡
 *
ex
;

3908 
pxt4_lblk_t
 
ì_block
;

3909 
ì_Àn
;

3910 
dïth
;

3911 
îr
 = 0;

3917 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
)

3918 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
 / 2;

3920 
dïth
 = 
	`ext_dïth
(
öode
);

3921 
ex
 = 
∑th
[
dïth
].
p_ext
;

3922 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

3923 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

3925 
	`ext_debug
("%s: inode %lu,Üogical"

3926 "block %Œu, max_block†%u\n", 
__func__
, 
öode
->
i_öo
,

3927 ()
ì_block
, 
ì_Àn
);

3929 i‡(
ì_block
 !
m≠
->
m_lblk
 || 
ì_Àn
 > m≠->
m_Àn
) {

3930 
îr
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

3931 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
);

3932 i‡(
îr
 < 0)

3933  
îr
;

3934 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
µ©h
, 0);

3935 i‡(
	`IS_ERR
(
∑th
))

3936  
	`PTR_ERR
(
∑th
);

3937 
dïth
 = 
	`ext_dïth
(
öode
);

3938 
ex
 = 
∑th
[
dïth
].
p_ext
;

3939 i‡(!
ex
) {

3940 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

3941 (Ë
m≠
->
m_lblk
);

3942  -
EFSCORRUPTED
;

3946 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

3947 i‡(
îr
)

3948  
îr
;

3950 
	`pxt4_ext_m¨k_unwrôãn
(
ex
);

3955 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode
, 
∑th
, 
ex
);

3958 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 +Ö©h->
p_dïth
);

3959 i‡(
îr
)

3960  
îr
;

3961 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3963 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

3964 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
, m≠->
m_Àn
);

3965 i‡(
îr
)

3966  
îr
;

3967 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

3968 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

3969 
Æloˇãd
 = 
m≠
->
m_Àn
;

3970 
m≠
->
m_Àn
 = 
Æloˇãd
;

3971  
Æloˇãd
;

3972 
	}
}

3975 
	$pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3976 
pxt4_m≠_blocks
 *
m≠
,

3977 
pxt4_ext_∑th
 **
µ©h
, 
Êags
,

3978 
Æloˇãd
, 
pxt4_fsblk_t
 
√wblock
)

3980 
pxt4_ext_∑th
 *
∑th
 = *
µ©h
;

3981 
ªt
 = 0;

3982 
îr
 = 0;

3984 
	`ext_debug
("pxt4_ext_handle_unwritten_extents: inode %lu,Üogical "

3986 
öode
->
i_öo
, ()
m≠
->
m_lblk
, m≠->
m_Àn
,

3987 
Êags
, 
Æloˇãd
);

3988 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

3994 
Êags
 |
PXT4_GET_BLOCKS_METADATA_NOFAIL
;

3996 
	`åa˚_pxt4_ext_h™dÀ_unwrôãn_exã¡s
(
öode
, 
m≠
, 
Êags
,

3997 
Æloˇãd
, 
√wblock
);

4000 i‡(
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) {

4001 
ªt
 = 
	`pxt4_•lô_c⁄vît_exã¡s
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
,

4002 
Êags
 | 
PXT4_GET_BLOCKS_CONVERT
);

4003 i‡(
ªt
 <= 0)

4004 
out
;

4005 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4006 
out
;

4009 i‡(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT
) {

4010 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) {

4011 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4012 
Æloˇãd
 = 
m≠
->
m_Àn
;

4013 
îr
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
, 
√wblock
,

4014 
Æloˇãd
);

4015 i‡(
îr
 < 0)

4016 
out2
;

4018 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s_ídio
(
h™dÀ
, 
öode
, 
m≠
,

4019 
µ©h
);

4020 i‡(
ªt
 >= 0) {

4021 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4022 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4023 
∑th
, 
m≠
->
m_Àn
);

4025 
îr
 = 
ªt
;

4026 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4027 
m≠
->
m_pblk
 = 
√wblock
;

4028 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4029 
Æloˇãd
 = 
m≠
->
m_Àn
;

4030 
m≠
->
m_Àn
 = 
Æloˇãd
;

4031 
out2
;

4038 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) {

4039 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4040 
m≠_out
;

4044 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4052 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4053 
out1
;

4057 
ªt
 = 
	`pxt4_ext_c⁄vît_to_öôülized
(
h™dÀ
, 
öode
, 
m≠
, 
µ©h
, 
Êags
);

4058 i‡(
ªt
 >= 0)

4059 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4060 
out
:

4061 i‡(
ªt
 <= 0) {

4062 
îr
 = 
ªt
;

4063 
out2
;

4065 
Æloˇãd
 = 
ªt
;

4066 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4067 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4068 
Æloˇãd
 = 
m≠
->
m_Àn
;

4069 
m≠
->
m_Àn
 = 
Æloˇãd
;

4071 
m≠_out
:

4072 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4073 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0) {

4074 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
, 
∑th
,

4075 
m≠
->
m_Àn
);

4076 i‡(
îr
 < 0)

4077 
out2
;

4079 
out1
:

4080 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4081 
Æloˇãd
 = 
m≠
->
m_Àn
;

4082 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4083 
m≠
->
m_pblk
 = 
√wblock
;

4084 
m≠
->
m_Àn
 = 
Æloˇãd
;

4085 
out2
:

4086  
îr
 ?Éº : 
Æloˇãd
;

4087 
	}
}

4130 
	$gë_im∂õd_˛u°î_Æloc
(
su≥r_block
 *
sb
,

4131 
pxt4_m≠_blocks
 *
m≠
,

4132 
pxt4_exã¡
 *
ex
,

4133 
pxt4_ext_∑th
 *
∑th
)

4135 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4136 
pxt4_lblk_t
 
c_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4137 
pxt4_lblk_t
 
ex_˛u°î_°¨t
, 
ex_˛u°î_íd
;

4138 
pxt4_lblk_t
 
º_˛u°î_°¨t
;

4139 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4140 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4141 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4144 
ex_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
);

4145 
ex_˛u°î_íd
 = 
	`PXT4_B2C
(
sbi
, 
ì_block
 + 
ì_Àn
 - 1);

4148 
º_˛u°î_°¨t
 = 
	`PXT4_B2C
(
sbi
, 
m≠
->
m_lblk
);

4150 i‡((
º_˛u°î_°¨t
 =
ex_˛u°î_íd
) ||

4151 (
º_˛u°î_°¨t
 =
ex_˛u°î_°¨t
)) {

4152 i‡(
º_˛u°î_°¨t
 =
ex_˛u°î_íd
)

4153 
ì_°¨t
 +
ì_Àn
 - 1;

4154 
m≠
->
m_pblk
 = 
	`PXT4_PBLK_CMASK
(
sbi
, 
ì_°¨t
Ë+ 
c_off£t
;

4155 
m≠
->
m_Àn
 = 
	`mö
(map->m_len,

4156 (Ë
sbi
->
s_˛u°î_øtio
 - 
c_off£t
);

4166 i‡(
m≠
->
m_lblk
 < 
ì_block
)

4167 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
ì_block
 - m≠->
m_lblk
);

4178 i‡(
m≠
->
m_lblk
 > 
ì_block
) {

4179 
pxt4_lblk_t
 
√xt
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

4180 
m≠
->
m_Àn
 = 
	`mö
(m≠->m_Àn, 
√xt
 - m≠->
m_lblk
);

4183 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 1);

4187 
	`åa˚_pxt4_gë_im∂õd_˛u°î_Æloc_exô
(
sb
, 
m≠
, 0);

4189 
	}
}

4210 
	$pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4211 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

4213 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

4214 
pxt4_exã¡
 
√wex
, *
ex
, *
ex2
;

4215 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4216 
pxt4_fsblk_t
 
√wblock
 = 0;

4217 
‰ì_⁄_îr
 = 0, 
îr
 = 0, 
dïth
, 
ªt
;

4218 
Æloˇãd
 = 0, 
off£t
 = 0;

4219 
Æloˇãd_˛u°îs
 = 0;

4220 
pxt4_Æloˇti⁄_ªque°
 
¨
;

4221 
pxt4_lblk_t
 
˛u°î_off£t
;

4222 
boﬁ
 
m≠_‰om_˛u°î
 = 
Ál£
;

4224 
	`ext_debug
("blocks %u/%uÑequested for inode %lu\n",

4225 
m≠
->
m_lblk
, m≠->
m_Àn
, 
öode
->
i_öo
);

4226 
	`åa˚_pxt4_ext_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

4229 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
m≠
->
m_lblk
, 
NULL
, 0);

4230 i‡(
	`IS_ERR
(
∑th
)) {

4231 
îr
 = 
	`PTR_ERR
(
∑th
);

4232 
∑th
 = 
NULL
;

4233 
out2
;

4236 
dïth
 = 
	`ext_dïth
(
öode
);

4243 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

4244 
	`PXT4_ERROR_INODE
(
öode
, "badÉxtentáddress "

4246 (Ë
m≠
->
m_lblk
, 
dïth
,

4247 
∑th
[
dïth
].
p_block
);

4248 
îr
 = -
EFSCORRUPTED
;

4249 
out2
;

4252 
ex
 = 
∑th
[
dïth
].
p_ext
;

4253 i‡(
ex
) {

4254 
pxt4_lblk_t
 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

4255 
pxt4_fsblk_t
 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

4256 
ì_Àn
;

4263 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

4265 
	`åa˚_pxt4_ext_show_exã¡
(
öode
, 
ì_block
, 
ì_°¨t
, 
ì_Àn
);

4268 i‡(
	`ö_ønge
(
m≠
->
m_lblk
, 
ì_block
, 
ì_Àn
)) {

4269 
√wblock
 = 
m≠
->
m_lblk
 - 
ì_block
 + 
ì_°¨t
;

4271 
Æloˇãd
 = 
ì_Àn
 - (
m≠
->
m_lblk
 - 
ì_block
);

4272 
	`ext_debug
("%u fô i¡ÿ%u:%d -> %Œu\n", 
m≠
->
m_lblk
,

4273 
ì_block
, 
ì_Àn
, 
√wblock
);

4279 i‡((!
	`pxt4_ext_is_unwrôãn
(
ex
)) &&

4280 (
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
)) {

4281 
Æloˇãd
 = 
	`c⁄vît_öôülized_exã¡
(

4282 
h™dÀ
, 
öode
, 
m≠
, &
∑th
,

4283 
Æloˇãd
);

4284 
out2
;

4285 } i‡(!
	`pxt4_ext_is_unwrôãn
(
ex
))

4286 
out
;

4288 
ªt
 = 
	`pxt4_ext_h™dÀ_unwrôãn_exã¡s
(

4289 
h™dÀ
, 
öode
, 
m≠
, &
∑th
, 
Êags
,

4290 
Æloˇãd
, 
√wblock
);

4291 i‡(
ªt
 < 0)

4292 
îr
 = 
ªt
;

4294 
Æloˇãd
 = 
ªt
;

4295 
out2
;

4303 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

4304 
pxt4_lblk_t
 
hﬁe_°¨t
, 
hﬁe_Àn
;

4306 
hﬁe_°¨t
 = 
m≠
->
m_lblk
;

4307 
hﬁe_Àn
 = 
	`pxt4_ext_dëîmöe_hﬁe
(
öode
, 
∑th
, &
hﬁe_°¨t
);

4312 
	`pxt4_ext_put_g≠_ö_ˇche
(
öode
, 
hﬁe_°¨t
, 
hﬁe_Àn
);

4315 i‡(
hﬁe_°¨t
 !
m≠
->
m_lblk
)

4316 
hﬁe_Àn
 -
m≠
->
m_lblk
 - 
hﬁe_°¨t
;

4317 
m≠
->
m_pblk
 = 0;

4318 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
hﬁe_Àn
);

4320 
out2
;

4326 
√wex
.
ì_block
 = 
	`˝u_to_À32
(
m≠
->
m_lblk
);

4327 
˛u°î_off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4333 i‡(
˛u°î_off£t
 && 
ex
 &&

4334 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex
, 
∑th
)) {

4335 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4336 
√wblock
 = 
m≠
->
m_pblk
;

4337 
m≠_‰om_˛u°î
 = 
åue
;

4338 
gŸ_Æloˇãd_blocks
;

4342 
¨
.
Œe·
 = 
m≠
->
m_lblk
;

4343 
îr
 = 
	`pxt4_ext_£¨ch_À·
(
öode
, 
∑th
, &
¨
.
Œe·
, &¨.
∂e·
);

4344 i‡(
îr
)

4345 
out2
;

4346 
¨
.
Ãight
 = 
m≠
->
m_lblk
;

4347 
ex2
 = 
NULL
;

4348 
îr
 = 
	`pxt4_ext_£¨ch_right
(
öode
, 
∑th
, &
¨
.
Ãight
, &¨.
¥ight
, &
ex2
);

4349 i‡(
îr
)

4350 
out2
;

4354 i‡((
sbi
->
s_˛u°î_øtio
 > 1Ë&& 
ex2
 &&

4355 
	`gë_im∂õd_˛u°î_Æloc
(
öode
->
i_sb
, 
m≠
, 
ex2
, 
∑th
)) {

4356 
¨
.
Àn
 = 
Æloˇãd
 = 
m≠
->
m_Àn
;

4357 
√wblock
 = 
m≠
->
m_pblk
;

4358 
m≠_‰om_˛u°î
 = 
åue
;

4359 
gŸ_Æloˇãd_blocks
;

4368 i‡(
m≠
->
m_Àn
 > 
EXT_INIT_MAX_LEN
 &&

4369 !(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4370 
m≠
->
m_Àn
 = 
EXT_INIT_MAX_LEN
;

4371 i‡(
m≠
->
m_Àn
 > 
EXT_UNWRITTEN_MAX_LEN
 &&

4372 (
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
))

4373 
m≠
->
m_Àn
 = 
EXT_UNWRITTEN_MAX_LEN
;

4376 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
m≠
->
m_Àn
);

4377 
îr
 = 
	`pxt4_ext_check_ovîœp
(
sbi
, 
öode
, &
√wex
, 
∑th
);

4378 i‡(
îr
)

4379 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4381 
Æloˇãd
 = 
m≠
->
m_Àn
;

4384 
¨
.
öode
 = inode;

4385 
¨
.
gﬂl
 = 
	`pxt4_ext_föd_gﬂl
(
öode
, 
∑th
, 
m≠
->
m_lblk
);

4386 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

4395 
off£t
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
m≠
->
m_lblk
);

4396 
¨
.
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
off£t
+
Æloˇãd
);

4397 
¨
.
gﬂl
 -
off£t
;

4398 
¨
.
logiˇl
 -
off£t
;

4399 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4400 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

4403 
¨
.
Êags
 = 0;

4404 i‡(
Êags
 & 
PXT4_GET_BLOCKS_NO_NORMALIZE
)

4405 
¨
.
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4406 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

4407 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

4408 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

4409 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

4410 
√wblock
 = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, &
¨
, &
îr
);

4411 i‡(!
√wblock
)

4412 
out2
;

4413 
	`ext_debug
("allocateÇew block: goal %llu, found %llu/%u\n",

4414 
¨
.
gﬂl
, 
√wblock
, 
Æloˇãd
);

4415 
‰ì_⁄_îr
 = 1;

4416 
Æloˇãd_˛u°îs
 = 
¨
.
Àn
;

4417 
¨
.
Àn
 = 
	`PXT4_C2B
(
sbi
,ár.ÀnË- 
off£t
;

4418 i‡(
¨
.
Àn
 > 
Æloˇãd
)

4419 
¨
.
Àn
 = 
Æloˇãd
;

4421 
gŸ_Æloˇãd_blocks
:

4423 
	`pxt4_ext_°‹e_pblock
(&
√wex
, 
√wblock
 + 
off£t
);

4424 
√wex
.
ì_Àn
 = 
	`˝u_to_À16
(
¨
.
Àn
);

4426 i‡(
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
){

4427 
	`pxt4_ext_m¨k_unwrôãn
(&
√wex
);

4428 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

4431 
îr
 = 0;

4432 i‡((
Êags
 & 
PXT4_GET_BLOCKS_KEEP_SIZE
) == 0)

4433 
îr
 = 
	`check_eofblocks_Ê
(
h™dÀ
, 
öode
, 
m≠
->
m_lblk
,

4434 
∑th
, 
¨
.
Àn
);

4435 i‡(!
îr
)

4436 
îr
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
,

4437 &
√wex
, 
Êags
);

4439 i‡(
îr
 && 
‰ì_⁄_îr
) {

4440 
fb_Êags
 = 
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
 ?

4441 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 : 0;

4445 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4446 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
√wblock
,

4447 
	`PXT4_C2B
(
sbi
, 
Æloˇãd_˛u°îs
), 
fb_Êags
);

4448 
out2
;

4452 
√wblock
 = 
	`pxt4_ext_pblock
(&
√wex
);

4453 
Æloˇãd
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(&
√wex
);

4454 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4455 
Æloˇãd
 = 
m≠
->
m_Àn
;

4456 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

4464 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
Ë&& !
m≠_‰om_˛u°î
) {

4465 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) {

4470 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
Æloˇãd_˛u°îs
,

4473 
pxt4_lblk_t
 
lblk
, 
Àn
;

4474 
n
;

4487 
lblk
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
m≠
->
m_lblk
);

4488 
Àn
 = 
Æloˇãd_˛u°îs
 << 
sbi
->
s_˛u°î_bôs
;

4489 
n
 = 
	`pxt4_es_dñayed_˛u
(
öode
, 
lblk
, 
Àn
);

4490 i‡(
n
 > 0)

4491 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, (Ë
n
, 0);

4499 i‡((
Êags
 & 
PXT4_GET_BLOCKS_UNWRIT_EXT
) == 0)

4500 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4502 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 0);

4503 
out
:

4504 i‡(
Æloˇãd
 > 
m≠
->
m_Àn
)

4505 
Æloˇãd
 = 
m≠
->
m_Àn
;

4506 
	`pxt4_ext_show_Àaf
(
öode
, 
∑th
);

4507 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

4508 
m≠
->
m_pblk
 = 
√wblock
;

4509 
m≠
->
m_Àn
 = 
Æloˇãd
;

4510 
out2
:

4511 
	`pxt4_ext_dr›_ªfs
(
∑th
);

4512 
	`k‰ì
(
∑th
);

4514 
	`åa˚_pxt4_ext_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
,

4515 
îr
 ?Éº : 
Æloˇãd
);

4516  
îr
 ?Éº : 
Æloˇãd
;

4517 
	}
}

4519 
	$pxt4_ext_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

4521 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4522 
pxt4_lblk_t
 
œ°_block
;

4523 
îr
 = 0;

4532 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

4533 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4534 i‡(
îr
)

4535  
îr
;

4537 
œ°_block
 = (
öode
->
i_size
 + 
sb
->
s_blocksize
 - 1)

4538 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4539 
ªåy
:

4540 
îr
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
,

4541 
EXT_MAX_BLOCKS
 - 
œ°_block
);

4542 i‡(
îr
 =-
ENOMEM
) {

4543 
	`c⁄d_ªsched
();

4544 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

4545 
ªåy
;

4547 i‡(
îr
)

4548  
îr
;

4549  
	`pxt4_ext_ªmove_•a˚
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 - 1);

4550 
	}
}

4552 
	$pxt4_Æloc_fûe_blocks
(
fûe
 *fûe, 
pxt4_lblk_t
 
off£t
,

4553 
pxt4_lblk_t
 
Àn
, 
loff_t
 
√w_size
,

4554 
Êags
)

4556 
öode
 *öodê
	`fûe_öode
(
fûe
);

4557 
h™dÀ_t
 *
h™dÀ
;

4558 
ªt
 = 0;

4559 
ªt2
 = 0;

4560 
ªåõs
 = 0;

4561 
dïth
 = 0;

4562 
pxt4_m≠_blocks
 
m≠
;

4563 
¸edôs
;

4564 
loff_t
 
ïos
;

4566 
	`BUG_ON
(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
));

4567 
m≠
.
m_lblk
 = 
off£t
;

4568 
m≠
.
m_Àn
 = 
Àn
;

4574 i‡(
Àn
 <
EXT_UNWRITTEN_MAX_LEN
)

4575 
Êags
 |
PXT4_GET_BLOCKS_NO_NORMALIZE
;

4580 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4581 
dïth
 = 
	`ext_dïth
(
öode
);

4583 
ªåy
:

4584 
ªt
 >0 && 
Àn
) {

4588 i‡(
dïth
 !
	`ext_dïth
(
öode
)) {

4589 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
Àn
);

4590 
dïth
 = 
	`ext_dïth
(
öode
);

4593 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4594 
¸edôs
);

4595 i‡(
	`IS_ERR
(
h™dÀ
)) {

4596 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4599 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
Êags
);

4600 i‡(
ªt
 <= 0) {

4601 
	`pxt4_debug
("inode #%lu: block %u:Üen %u: "

4603 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4604 
m≠
.
m_Àn
, 
ªt
);

4605 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4606 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4609 
m≠
.
m_lblk
 +
ªt
;

4610 
m≠
.
m_Àn
 = 
Àn
 =Üí - 
ªt
;

4611 
ïos
 = (
loff_t
)
m≠
.
m_lblk
 << 
öode
->
i_blkbôs
;

4612 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

4613 i‡(
√w_size
) {

4614 i‡(
ïos
 > 
√w_size
)

4615 
ïos
 = 
√w_size
;

4616 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
ïos
) & 0x1)

4617 
öode
->
i_mtime
 = inode->
i_˘ime
;

4619 i‡(
ïos
 > 
öode
->
i_size
)

4620 
	`pxt4_£t_öode_Êag
(
öode
,

4621 
PXT4_INODE_EOFBLOCKS
);

4623 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4624 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4625 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4626 i‡(
ªt2
)

4629 i‡(
ªt
 =-
ENOSPC
 &&

4630 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
)) {

4631 
ªt
 = 0;

4632 
ªåy
;

4635  
ªt
 > 0 ? 
ªt2
 :Ñet;

4636 
	}
}

4638 
	$pxt4_zîo_ønge
(
fûe
 *fûe, 
loff_t
 
off£t
,

4639 
loff_t
 
Àn
, 
mode
)

4641 
öode
 *öodê
	`fûe_öode
(
fûe
);

4642 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

4643 
max_blocks
;

4644 
loff_t
 
√w_size
 = 0;

4645 
ªt
 = 0;

4646 
Êags
;

4647 
¸edôs
;

4648 
∑πül_begö
, 
∑πül_íd
;

4649 
loff_t
 
°¨t
, 
íd
;

4650 
pxt4_lblk_t
 
lblk
;

4651 
blkbôs
 = 
öode
->
i_blkbôs
;

4653 
	`åa˚_pxt4_zîo_ønge
(
öode
, 
off£t
, 
Àn
, 
mode
);

4655 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4656  -
EINVAL
;

4659 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4660 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

4661 i‡(
ªt
)

4662  
ªt
;

4671 
°¨t
 = 
	`round_up
(
off£t
, 1 << 
blkbôs
);

4672 
íd
 = 
	`round_down
((
off£t
 + 
Àn
), 1 << 
blkbôs
);

4674 i‡(
°¨t
 < 
off£t
 || 
íd
 > off£à+ 
Àn
)

4675  -
EINVAL
;

4676 
∑πül_begö
 = 
off£t
 & ((1 << 
blkbôs
) - 1);

4677 
∑πül_íd
 = (
off£t
 + 
Àn
Ë& ((1 << 
blkbôs
) - 1);

4679 
lblk
 = 
°¨t
 >> 
blkbôs
;

4680 
max_blocks
 = (
íd
 >> 
blkbôs
);

4681 i‡(
max_blocks
 < 
lblk
)

4682 
max_blocks
 = 0;

4684 
max_blocks
 -
lblk
;

4686 
	`öode_lock
(
öode
);

4691 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4692 
ªt
 = -
EOPNOTSUPP
;

4693 
out_muãx
;

4696 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4697 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4698 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4699 
√w_size
 = 
off£t
 + 
Àn
;

4700 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4701 i‡(
ªt
)

4702 
out_muãx
;

4705 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4706 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4707 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4710 
	`öode_dio_waô
(
öode
);

4713 i‡(
∑πül_begö
 || 
∑πül_íd
) {

4714 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
,

4715 
	`round_down
(
off£t
, 1 << 
blkbôs
) >> blkbits,

4716 (
	`round_up
((
off£t
 + 
Àn
), 1 << 
blkbôs
) -

4717 
	`round_down
(
off£t
, 1 << 
blkbôs
)) >> blkbits,

4718 
√w_size
, 
Êags
);

4719 i‡(
ªt
)

4720 
out_muãx
;

4725 i‡(
max_blocks
 > 0) {

4726 
Êags
 |(
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 |

4727 
PXT4_EX_NOCACHE
);

4733 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4735 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4736 i‡(
ªt
) {

4737 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4738 
out_muãx
;

4741 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àn
);

4742 i‡(
ªt
) {

4743 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4744 
out_muãx
;

4747 
	`åunˇã_∑geˇche_ønge
(
öode
, 
°¨t
, 
íd
 - 1);

4748 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4750 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
,

4751 
Êags
);

4752 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4753 i‡(
ªt
)

4754 
out_muãx
;

4756 i‡(!
∑πül_begö
 && !
∑πül_íd
)

4757 
out_muãx
;

4763 
¸edôs
 = (2 * 
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 2)) + 1;

4764 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4765 
¸edôs
 += 2;

4766 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

4767 i‡(
	`IS_ERR
(
h™dÀ
)) {

4768 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4769 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

4770 
out_muãx
;

4773 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4774 i‡(
√w_size
) {

4775 
	`pxt4_upd©e_öode_size
(
öode
, 
√w_size
);

4781 i‡((
off£t
 + 
Àn
Ë> 
	`i_size_ªad
(
öode
))

4782 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4784 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4787 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
, 
Àn
);

4788 i‡(
ªt
 >= 0)

4789 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4791 i‡(
fûe
->
f_Êags
 & 
O_SYNC
)

4792 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4794 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4795 
out_muãx
:

4796 
	`öode_u∆ock
(
öode
);

4797  
ªt
;

4798 
	}
}

4807 
	$pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,Üoff_à
Àn
)

4809 
öode
 *öodê
	`fûe_öode
(
fûe
);

4810 
loff_t
 
√w_size
 = 0;

4811 
max_blocks
;

4812 
ªt
 = 0;

4813 
Êags
;

4814 
pxt4_lblk_t
 
lblk
;

4815 
blkbôs
 = 
öode
->
i_blkbôs
;

4827 i‡(
	`IS_ENCRYPTED
(
öode
) &&

4828 (
mode
 & (
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_INSERT_RANGE
 |

4829 
FALLOC_FL_ZERO_RANGE
)))

4830  -
EOPNOTSUPP
;

4833 i‡(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
 |

4834 
FALLOC_FL_COLLAPSE_RANGE
 | 
FALLOC_FL_ZERO_RANGE
 |

4835 
FALLOC_FL_INSERT_RANGE
))

4836  -
EOPNOTSUPP
;

4838 i‡(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

4839  
	`pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àn
);

4841 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

4842 i‡(
ªt
)

4843  
ªt
;

4845 i‡(
mode
 & 
FALLOC_FL_COLLAPSE_RANGE
)

4846  
	`pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

4848 i‡(
mode
 & 
FALLOC_FL_INSERT_RANGE
)

4849  
	`pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

4851 i‡(
mode
 & 
FALLOC_FL_ZERO_RANGE
)

4852  
	`pxt4_zîo_ønge
(
fûe
, 
off£t
, 
Àn
, 
mode
);

4854 
	`åa˚_pxt4_ÁŒoˇã_íãr
(
öode
, 
off£t
, 
Àn
, 
mode
);

4855 
lblk
 = 
off£t
 >> 
blkbôs
;

4857 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4858 
Êags
 = 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
;

4859 i‡(
mode
 & 
FALLOC_FL_KEEP_SIZE
)

4860 
Êags
 |
PXT4_GET_BLOCKS_KEEP_SIZE
;

4862 
	`öode_lock
(
öode
);

4867 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

4868 
ªt
 = -
EOPNOTSUPP
;

4869 
out
;

4872 i‡(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

4873 (
off£t
 + 
Àn
 > 
	`i_size_ªad
(
öode
) ||

4874 
off£t
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_disksize
)) {

4875 
√w_size
 = 
off£t
 + 
Àn
;

4876 
ªt
 = 
	`öode_√wsize_ok
(
öode
, 
√w_size
);

4877 i‡(
ªt
)

4878 
out
;

4882 
	`öode_dio_waô
(
öode
);

4884 
ªt
 = 
	`pxt4_Æloc_fûe_blocks
(
fûe
, 
lblk
, 
max_blocks
, 
√w_size
, 
Êags
);

4885 i‡(
ªt
)

4886 
out
;

4888 i‡(
fûe
->
f_Êags
 & 
O_SYNC
 && 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

4889 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

4890 
	`PXT4_I
(
öode
)->
i_sync_tid
);

4892 
out
:

4893 
	`öode_u∆ock
(
öode
);

4894 
	`åa˚_pxt4_ÁŒoˇã_exô
(
öode
, 
off£t
, 
max_blocks
, 
ªt
);

4895  
ªt
;

4896 
	}
}

4908 
	$pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4909 
loff_t
 
off£t
, 
ssize_t
 
Àn
)

4911 
max_blocks
;

4912 
ªt
 = 0;

4913 
ªt2
 = 0;

4914 
pxt4_m≠_blocks
 
m≠
;

4915 
¸edôs
, 
blkbôs
 = 
öode
->
i_blkbôs
;

4917 
m≠
.
m_lblk
 = 
off£t
 >> 
blkbôs
;

4918 
max_blocks
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
off£t
, 
blkbôs
);

4925 i‡(
h™dÀ
) {

4926 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_ª£rved
(handle,

4927 
PXT4_HT_EXT_CONVERT
);

4928 i‡(
	`IS_ERR
(
h™dÀ
))

4929  
	`PTR_ERR
(
h™dÀ
);

4930 
¸edôs
 = 0;

4935 
¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
max_blocks
);

4937 
ªt
 >0 &&Ñë < 
max_blocks
) {

4938 
m≠
.
m_lblk
 +
ªt
;

4939 
m≠
.
m_Àn
 = (
max_blocks
 -
ªt
);

4940 i‡(
¸edôs
) {

4941 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

4942 
¸edôs
);

4943 i‡(
	`IS_ERR
(
h™dÀ
)) {

4944 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4948 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

4949 
PXT4_GET_BLOCKS_IO_CONVERT_EXT
);

4950 i‡(
ªt
 <= 0)

4951 
	`pxt4_w¨nög
(
öode
->
i_sb
,

4954 
öode
->
i_öo
, 
m≠
.
m_lblk
,

4955 
m≠
.
m_Àn
, 
ªt
);

4956 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4957 i‡(
¸edôs
)

4958 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4959 i‡(
ªt
 <0 || 
ªt2
)

4962 i‡(!
¸edôs
)

4963 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4964  
ªt
 > 0 ? 
ªt2
 :Ñet;

4965 
	}
}

4976 
	$pxt4_föd_dñayed_exã¡
(
öode
 *inode,

4977 
exã¡_°©us
 *
√wes
)

4979 
exã¡_°©us
 
es
;

4980 
pxt4_lblk_t
 
block
, 
√xt_dñ
;

4982 i‡(
√wes
->
es_pblk
 == 0) {

4983 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

4984 
√wes
->
es_lblk
,

4985 
√wes
->
es_lblk
 +Çewes->
es_Àn
 - 1,

4986 &
es
);

4992 i‡(
es
.
es_Àn
 == 0)

4996 i‡(
es
.
es_lblk
 > 
√wes
->es_lblk) {

4998 
√wes
->
es_Àn
 = 
	`mö
(
es
.
es_lblk
 -Çewes->es_lblk,

4999 
√wes
->
es_Àn
);

5003 
√wes
->
es_Àn
 = 
es
.
es_lblk
 +És.es_len -Çewes->es_lblk;

5006 
block
 = 
√wes
->
es_lblk
 +Çewes->
es_Àn
;

5007 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
block
,

5008 
EXT_MAX_BLOCKS
, &
es
);

5009 i‡(
es
.
es_Àn
 == 0)

5010 
√xt_dñ
 = 
EXT_MAX_BLOCKS
;

5012 
√xt_dñ
 = 
es
.
es_lblk
;

5014  
√xt_dñ
;

5015 
	}
}

5017 
	#PXT4_FIEMAP_FLAGS
 (
FIEMAP_FLAG_SYNC
|
FIEMAP_FLAG_XATTR
)

	)

5019 
	$pxt4_x©å_fõm≠
(
öode
 *inode,

5020 
fõm≠_exã¡_öfo
 *
fõöfo
)

5022 
__u64
 
physiˇl
 = 0;

5023 
__u64
 
Àngth
;

5024 
__u32
 
Êags
 = 
FIEMAP_EXTENT_LAST
;

5025 
blockbôs
 = 
öode
->
i_sb
->
s_blocksize_bôs
;

5026 
îr‹
 = 0;

5029 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

5030 
pxt4_ûoc
 
ûoc
;

5031 
off£t
;

5033 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

5034 i‡(
îr‹
)

5035  
îr‹
;

5036 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
blockbôs
;

5037 
off£t
 = 
PXT4_GOOD_OLD_INODE_SIZE
 +

5038 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

5039 
physiˇl
 +
off£t
;

5040 
Àngth
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 - 
off£t
;

5041 
Êags
 |
FIEMAP_EXTENT_DATA_INLINE
;

5042 
	`bªl£
(
ûoc
.
bh
);

5044 
physiˇl
 = (
__u64
)
	`PXT4_I
(
öode
)->
i_fûe_a˛
 << 
blockbôs
;

5045 
Àngth
 = 
öode
->
i_sb
->
s_blocksize
;

5048 i‡(
physiˇl
)

5049 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 0, 
physiˇl
,

5050 
Àngth
, 
Êags
);

5051  (
îr‹
 < 0 ?Érror : 0);

5052 
	}
}

5054 
	$pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

5055 
__u64
 
°¨t
, __u64 
Àn
)

5057 
pxt4_lblk_t
 
°¨t_blk
;

5058 
îr‹
 = 0;

5060 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

5061 
has_ölöe
 = 1;

5063 
îr‹
 = 
	`pxt4_ölöe_d©a_fõm≠
(
öode
, 
fõöfo
, &
has_ölöe
,

5064 
°¨t
, 
Àn
);

5066 i‡(
has_ölöe
)

5067  
îr‹
;

5070 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_CACHE
) {

5071 
îr‹
 = 
	`pxt4_ext_¥eˇche
(
öode
);

5072 i‡(
îr‹
)

5073  
îr‹
;

5077 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5078  
	`gíîic_block_fõm≠
(
öode
, 
fõöfo
, 
°¨t
, 
Àn
,

5079 
pxt4_gë_block
);

5081 i‡(
	`fõm≠_check_Êags
(
fõöfo
, 
PXT4_FIEMAP_FLAGS
))

5082  -
EBADR
;

5084 i‡(
fõöfo
->
fi_Êags
 & 
FIEMAP_FLAG_XATTR
) {

5085 
îr‹
 = 
	`pxt4_x©å_fõm≠
(
öode
, 
fõöfo
);

5087 
pxt4_lblk_t
 
Àn_blks
;

5088 
__u64
 
œ°_blk
;

5090 
°¨t_blk
 = 
°¨t
 >> 
öode
->
i_sb
->
s_blocksize_bôs
;

5091 
œ°_blk
 = (
°¨t
 + 
Àn
 - 1Ë>> 
öode
->
i_sb
->
s_blocksize_bôs
;

5092 i‡(
œ°_blk
 >
EXT_MAX_BLOCKS
)

5093 
œ°_blk
 = 
EXT_MAX_BLOCKS
-1;

5094 
Àn_blks
 = ((
pxt4_lblk_t
Ë
œ°_blk
Ë- 
°¨t_blk
 + 1;

5100 
îr‹
 = 
	`pxt4_fûl_fõm≠_exã¡s
(
öode
, 
°¨t_blk
,

5101 
Àn_blks
, 
fõöfo
);

5103  
îr‹
;

5104 
	}
}

5113 
	$pxt4_ac˚ss_∑th
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5114 
pxt4_ext_∑th
 *
∑th
)

5116 
¸edôs
, 
îr
;

5118 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

5127 i‡(
h™dÀ
->
h_buf„r_¸edôs
 < 7) {

5128 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5129 
îr
 = 
	`pxt4_ext_åunˇã_exãnd_ª°¨t
(
h™dÀ
, 
öode
, 
¸edôs
);

5131 i‡(
îr
 &&Éº !-
EAGAIN
)

5132  
îr
;

5135 
îr
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode
, 
∑th
);

5136  
îr
;

5137 
	}
}

5146 
	$pxt4_ext_shi·_∑th_exã¡s
(
pxt4_ext_∑th
 *
∑th
, 
pxt4_lblk_t
 
shi·
,

5147 
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5148 
SHIFT_DIRECTION
 
SHIFT
)

5150 
dïth
, 
îr
 = 0;

5151 
pxt4_exã¡
 *
ex_°¨t
, *
ex_œ°
;

5152 
boﬁ
 
upd©e
 = 0;

5153 
dïth
 = 
∑th
->
p_dïth
;

5155 
dïth
 >= 0) {

5156 i‡(
dïth
 =
∑th
->
p_dïth
) {

5157 
ex_°¨t
 = 
∑th
[
dïth
].
p_ext
;

5158 i‡(!
ex_°¨t
)

5159  -
EFSCORRUPTED
;

5161 
ex_œ°
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5163 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5164 i‡(
îr
)

5165 
out
;

5167 i‡(
ex_°¨t
 =
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5168 
upd©e
 = 1;

5170 
ex_°¨t
 <
ex_œ°
) {

5171 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5172 
	`À32_add_˝u
(&
ex_°¨t
->
ì_block
,

5173 -
shi·
);

5175 i‡((
ex_°¨t
 >

5176 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
))

5178 
	`pxt4_ext_åy_to_mîge_right
(
öode
,

5179 
∑th
, 
ex_°¨t
 - 1))

5180 
ex_œ°
--;

5182 
ex_°¨t
++;

5184 
	`À32_add_˝u
(&
ex_œ°
->
ì_block
, 
shi·
);

5185 
	`pxt4_ext_åy_to_mîge_right
(
öode
, 
∑th
,

5186 
ex_œ°
);

5187 
ex_œ°
--;

5190 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5191 i‡(
îr
)

5192 
out
;

5194 i‡(--
dïth
 < 0 || !
upd©e
)

5199 
îr
 = 
	`pxt4_ac˚ss_∑th
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5200 i‡(
îr
)

5201 
out
;

5203 i‡(
SHIFT
 =
SHIFT_LEFT
)

5204 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, -
shi·
);

5206 
	`À32_add_˝u
(&
∑th
[
dïth
].
p_idx
->
ei_block
, 
shi·
);

5207 
îr
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
 + 
dïth
);

5208 i‡(
îr
)

5209 
out
;

5212 i‡(
∑th
[
dïth
].
p_idx
 !
	`EXT_FIRST_INDEX
’©h[dïth].
p_hdr
))

5215 
dïth
--;

5218 
out
:

5219  
îr
;

5220 
	}
}

5230 
	$pxt4_ext_shi·_exã¡s
(
öode
 *öode, 
h™dÀ_t
 *
h™dÀ
,

5231 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
shi·
,

5232 
SHIFT_DIRECTION
 
SHIFT
)

5234 
pxt4_ext_∑th
 *
∑th
;

5235 
ªt
 = 0, 
dïth
;

5236 
pxt4_exã¡
 *
exã¡
;

5237 
pxt4_lblk_t
 
°›
, *
ôî©‹
, 
ex_°¨t
, 
ex_íd
;

5240 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
EXT_MAX_BLOCKS
 - 1, 
NULL
,

5241 
PXT4_EX_NOCACHE
);

5242 i‡(
	`IS_ERR
(
∑th
))

5243  
	`PTR_ERR
(
∑th
);

5245 
dïth
 = 
∑th
->
p_dïth
;

5246 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5247 i‡(!
exã¡
)

5248 
out
;

5250 
°›
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5257 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5258 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
°¨t
 - 1, &path,

5259 
PXT4_EX_NOCACHE
);

5260 i‡(
	`IS_ERR
(
∑th
))

5261  
	`PTR_ERR
(
∑th
);

5262 
dïth
 = 
∑th
->
p_dïth
;

5263 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5264 i‡(
exã¡
) {

5265 
ex_°¨t
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5266 
ex_íd
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5267 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5269 
ex_°¨t
 = 0;

5270 
ex_íd
 = 0;

5273 i‡((
°¨t
 =
ex_°¨t
 && 
shi·
 >Éx_start) ||

5274 (
shi·
 > 
°¨t
 - 
ex_íd
)) {

5275 
ªt
 = -
EINVAL
;

5276 
out
;

5279 i‡(
shi·
 > 
EXT_MAX_BLOCKS
 -

5280 (
°›
 + 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
))) {

5281 
ªt
 = -
EINVAL
;

5282 
out
;

5291 i‡(
SHIFT
 =
SHIFT_LEFT
)

5292 
ôî©‹
 = &
°¨t
;

5294 
ôî©‹
 = &
°›
;

5301 
ôî©‹
 && 
°¨t
 <
°›
) {

5302 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, *
ôî©‹
, &path,

5303 
PXT4_EX_NOCACHE
);

5304 i‡(
	`IS_ERR
(
∑th
))

5305  
	`PTR_ERR
(
∑th
);

5306 
dïth
 = 
∑th
->
p_dïth
;

5307 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5308 i‡(!
exã¡
) {

5309 
	`PXT4_ERROR_INODE
(
öode
, "unexpected holeát %lu",

5310 (Ë*
ôî©‹
);

5311  -
EFSCORRUPTED
;

5313 i‡(
SHIFT
 =
SHIFT_LEFT
 && *
ôî©‹
 >

5314 
	`À32_to_˝u
(
exã¡
->
ì_block
)) {

5316 i‡(
exã¡
 < 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
)) {

5317 
∑th
[
dïth
].
p_ext
++;

5319 *
ôî©‹
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5324 i‡(
SHIFT
 =
SHIFT_LEFT
) {

5325 
exã¡
 = 
	`EXT_LAST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5326 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) +

5327 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5329 
exã¡
 = 
	`EXT_FIRST_EXTENT
(
∑th
[
dïth
].
p_hdr
);

5330 i‡(
	`À32_to_˝u
(
exã¡
->
ì_block
) > 0)

5331 *
ôî©‹
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
) - 1;

5334 
ôî©‹
 = 
NULL
;

5336 
	`À32_to_˝u
(
exã¡
->
ì_block
Ë< 
°¨t
)

5337 
exã¡
++;

5338 
∑th
[
dïth
].
p_ext
 = 
exã¡
;

5340 
ªt
 = 
	`pxt4_ext_shi·_∑th_exã¡s
(
∑th
, 
shi·
, 
öode
,

5341 
h™dÀ
, 
SHIFT
);

5342 i‡(
ªt
)

5345 
out
:

5346 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5347 
	`k‰ì
(
∑th
);

5348  
ªt
;

5349 
	}
}

5356 
	$pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5358 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5359 
pxt4_lblk_t
 
punch_°¨t
, 
punch_°›
;

5360 
h™dÀ_t
 *
h™dÀ
;

5361 
¸edôs
;

5362 
loff_t
 
√w_size
, 
ioff£t
;

5363 
ªt
;

5370 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5371  -
EOPNOTSUPP
;

5374 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5375 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5376  -
EINVAL
;

5378 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5379  -
EINVAL
;

5381 
	`åa˚_pxt4_cﬁœp£_ønge
(
öode
, 
off£t
, 
Àn
);

5383 
punch_°¨t
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5384 
punch_°›
 = (
off£t
 + 
Àn
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5387 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5388 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5389 i‡(
ªt
)

5390  
ªt
;

5393 
	`öode_lock
(
öode
);

5398 i‡(
off£t
 + 
Àn
 >
	`i_size_ªad
(
öode
)) {

5399 
ªt
 = -
EINVAL
;

5400 
out_muãx
;

5404 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5405 
ªt
 = -
EOPNOTSUPP
;

5406 
out_muãx
;

5410 
	`öode_dio_waô
(
öode
);

5416 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5418 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5419 i‡(
ªt
)

5420 
out_mm≠
;

5426 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5431 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
, 
off£t
);

5432 i‡(
ªt
)

5433 
out_mm≠
;

5439 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
off£t
 + 
Àn
,

5440 
LLONG_MAX
);

5441 i‡(
ªt
)

5442 
out_mm≠
;

5443 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5445 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5446 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5447 i‡(
	`IS_ERR
(
h™dÀ
)) {

5448 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5449 
out_mm≠
;

5452 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5453 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5455 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
punch_°¨t
,

5456 
EXT_MAX_BLOCKS
 - 
punch_°¨t
);

5457 i‡(
ªt
) {

5458 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5459 
out_°›
;

5462 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
punch_°¨t
, 
punch_°›
 - 1);

5463 i‡(
ªt
) {

5464 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5465 
out_°›
;

5467 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5469 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
, 
punch_°›
,

5470 
punch_°›
 - 
punch_°¨t
, 
SHIFT_LEFT
);

5471 i‡(
ªt
) {

5472 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5473 
out_°›
;

5476 
√w_size
 = 
	`i_size_ªad
(
öode
Ë- 
Àn
;

5477 
	`i_size_wrôe
(
öode
, 
√w_size
);

5478 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√w_size
;

5480 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5481 i‡(
	`IS_SYNC
(
öode
))

5482 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5483 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5484 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5485 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5487 
out_°›
:

5488 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5489 
out_mm≠
:

5490 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5491 
out_muãx
:

5492 
	`öode_u∆ock
(
öode
);

5493  
ªt
;

5494 
	}
}

5504 
	$pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
)

5506 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5507 
h™dÀ_t
 *
h™dÀ
;

5508 
pxt4_ext_∑th
 *
∑th
;

5509 
pxt4_exã¡
 *
exã¡
;

5510 
pxt4_lblk_t
 
off£t_lblk
, 
Àn_lblk
, 
ì_°¨t_lblk
 = 0;

5511 
¸edôs
, 
ì_Àn
;

5512 
ªt
 = 0, 
dïth
, 
•lô_Êag
 = 0;

5513 
loff_t
 
ioff£t
;

5520 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5521  -
EOPNOTSUPP
;

5524 i‡(
off£t
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1) ||

5525 
Àn
 & (
	`PXT4_CLUSTER_SIZE
(
sb
) - 1))

5526  -
EINVAL
;

5528 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5529  -
EOPNOTSUPP
;

5531 
	`åa˚_pxt4_ö£π_ønge
(
öode
, 
off£t
, 
Àn
);

5533 
off£t_lblk
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5534 
Àn_lblk
 = 
Àn
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5537 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

5538 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

5539 i‡(
ªt
)

5540  
ªt
;

5543 
	`öode_lock
(
öode
);

5545 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

5546 
ªt
 = -
EOPNOTSUPP
;

5547 
out_muãx
;

5551 i‡(
öode
->
i_size
 + 
Àn
 > inode->
i_sb
->
s_maxbyãs
) {

5552 
ªt
 = -
EFBIG
;

5553 
out_muãx
;

5557 i‡(
off£t
 >
	`i_size_ªad
(
öode
)) {

5558 
ªt
 = -
EINVAL
;

5559 
out_muãx
;

5563 
	`öode_dio_waô
(
öode
);

5569 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5571 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

5572 i‡(
ªt
)

5573 
out_mm≠
;

5579 
ioff£t
 = 
	`round_down
(
off£t
, 
PAGE_SIZE
);

5581 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
öode
->
i_m≠pög
, 
ioff£t
,

5582 
LLONG_MAX
);

5583 i‡(
ªt
)

5584 
out_mm≠
;

5585 
	`åunˇã_∑geˇche
(
öode
, 
ioff£t
);

5587 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

5588 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

5589 i‡(
	`IS_ERR
(
h™dÀ
)) {

5590 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

5591 
out_mm≠
;

5595 
öode
->
i_size
 +
Àn
;

5596 
	`PXT4_I
(
öode
)->
i_disksize
 +
Àn
;

5597 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5598 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5599 i‡(
ªt
)

5600 
out_°›
;

5602 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5603 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

5605 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
off£t_lblk
, 
NULL
, 0);

5606 i‡(
	`IS_ERR
(
∑th
)) {

5607 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5608 
out_°›
;

5611 
dïth
 = 
	`ext_dïth
(
öode
);

5612 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5613 i‡(
exã¡
) {

5614 
ì_°¨t_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5615 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
);

5621 i‡((
off£t_lblk
 > 
ì_°¨t_lblk
) &&

5622 (
off£t_lblk
 < (
ì_°¨t_lblk
 + 
ì_Àn
))) {

5623 i‡(
	`pxt4_ext_is_unwrôãn
(
exã¡
))

5624 
•lô_Êag
 = 
PXT4_EXT_MARK_UNWRIT1
 |

5625 
PXT4_EXT_MARK_UNWRIT2
;

5626 
ªt
 = 
	`pxt4_•lô_exã¡_©
(
h™dÀ
, 
öode
, &
∑th
,

5627 
off£t_lblk
, 
•lô_Êag
,

5628 
PXT4_EX_NOCACHE
 |

5629 
PXT4_GET_BLOCKS_PRE_IO
 |

5630 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5633 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5634 
	`k‰ì
(
∑th
);

5635 i‡(
ªt
 < 0) {

5636 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5637 
out_°›
;

5640 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5641 
	`k‰ì
(
∑th
);

5644 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
off£t_lblk
,

5645 
EXT_MAX_BLOCKS
 - 
off£t_lblk
);

5646 i‡(
ªt
) {

5647 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5648 
out_°›
;

5655 
ªt
 = 
	`pxt4_ext_shi·_exã¡s
(
öode
, 
h™dÀ
,

5656 
ì_°¨t_lblk
 > 
off£t_lblk
 ?Ée_start_lblk : offset_lblk,

5657 
Àn_lblk
, 
SHIFT_RIGHT
);

5659 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5660 i‡(
	`IS_SYNC
(
öode
))

5661 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5662 i‡(
ªt
 >= 0)

5663 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

5665 
out_°›
:

5666 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5667 
out_mm≠
:

5668 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5669 
out_muãx
:

5670 
	`öode_u∆ock
(
öode
);

5671  
ªt
;

5672 
	}
}

5695 
	$pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

5696 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,Öxt4_lblk_à
lblk2
,

5697 
pxt4_lblk_t
 
cou¡
, 
unwrôãn
, *
îp
)

5699 
pxt4_ext_∑th
 *
∑th1
 = 
NULL
;

5700 
pxt4_ext_∑th
 *
∑th2
 = 
NULL
;

5701 
ª∂a˚d_cou¡
 = 0;

5703 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode1
)->
i_d©a_£m
));

5704 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode2
)->
i_d©a_£m
));

5705 
	`BUG_ON
(!
	`öode_is_locked
(
öode1
));

5706 
	`BUG_ON
(!
	`öode_is_locked
(
öode2
));

5708 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode1
, 
lblk1
, 
cou¡
);

5709 i‡(
	`u∆ikñy
(*
îp
))

5711 *
îp
 = 
	`pxt4_es_ªmove_exã¡
(
öode2
, 
lblk2
, 
cou¡
);

5712 i‡(
	`u∆ikñy
(*
îp
))

5715 
cou¡
) {

5716 
pxt4_exã¡
 *
ex1
, *
ex2
, 
tmp_ex
;

5717 
pxt4_lblk_t
 
e1_blk
, 
e2_blk
;

5718 
e1_Àn
, 
e2_Àn
, 
Àn
;

5719 
•lô
 = 0;

5721 
∑th1
 = 
	`pxt4_föd_exã¡
(
öode1
, 
lblk1
, 
NULL
, 
PXT4_EX_NOCACHE
);

5722 i‡(
	`IS_ERR
(
∑th1
)) {

5723 *
îp
 = 
	`PTR_ERR
(
∑th1
);

5724 
∑th1
 = 
NULL
;

5725 
föish
:

5726 
cou¡
 = 0;

5727 
ª≥©
;

5729 
∑th2
 = 
	`pxt4_föd_exã¡
(
öode2
, 
lblk2
, 
NULL
, 
PXT4_EX_NOCACHE
);

5730 i‡(
	`IS_ERR
(
∑th2
)) {

5731 *
îp
 = 
	`PTR_ERR
(
∑th2
);

5732 
∑th2
 = 
NULL
;

5733 
föish
;

5735 
ex1
 = 
∑th1
[∑th1->
p_dïth
].
p_ext
;

5736 
ex2
 = 
∑th2
[∑th2->
p_dïth
].
p_ext
;

5738 i‡(
	`u∆ikñy
(!
ex2
 || !
ex1
))

5739 
föish
;

5741 
e1_blk
 = 
	`À32_to_˝u
(
ex1
->
ì_block
);

5742 
e2_blk
 = 
	`À32_to_˝u
(
ex2
->
ì_block
);

5743 
e1_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex1
);

5744 
e2_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex2
);

5747 i‡(!
	`ö_ønge
(
lblk1
, 
e1_blk
, 
e1_Àn
) ||

5748 !
	`ö_ønge
(
lblk2
, 
e2_blk
, 
e2_Àn
)) {

5749 
pxt4_lblk_t
 
√xt1
, 
≈xt2
;

5752 
√xt1
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th1
);

5753 
≈xt2
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th2
);

5755 i‡(
e1_blk
 > 
lblk1
)

5756 
√xt1
 = 
e1_blk
;

5757 i‡(
e2_blk
 > 
lblk2
)

5758 
≈xt2
 = 
e2_blk
;

5760 i‡(
√xt1
 =
EXT_MAX_BLOCKS
 || 
≈xt2
 == EXT_MAX_BLOCKS)

5761 
föish
;

5763 
Àn
 = 
√xt1
 - 
lblk1
;

5764 i‡(
Àn
 < 
≈xt2
 - 
lblk2
)

5765 
Àn
 = 
≈xt2
 - 
lblk2
;

5766 i‡(
Àn
 > 
cou¡
)

5767 
Àn
 = 
cou¡
;

5768 
lblk1
 +
Àn
;

5769 
lblk2
 +
Àn
;

5770 
cou¡
 -
Àn
;

5771 
ª≥©
;

5775 i‡(
e1_blk
 < 
lblk1
) {

5776 
•lô
 = 1;

5777 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5778 &
∑th1
, 
lblk1
, 0);

5779 i‡(
	`u∆ikñy
(*
îp
))

5780 
föish
;

5782 i‡(
e2_blk
 < 
lblk2
) {

5783 
•lô
 = 1;

5784 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5785 &
∑th2
, 
lblk2
, 0);

5786 i‡(
	`u∆ikñy
(*
îp
))

5787 
föish
;

5791 i‡(
•lô
)

5792 
ª≥©
;

5795 
Àn
 = 
cou¡
;

5796 i‡(
Àn
 > 
e1_blk
 + 
e1_Àn
 - 
lblk1
)

5797 
Àn
 = 
e1_blk
 + 
e1_Àn
 - 
lblk1
;

5798 i‡(
Àn
 > 
e2_blk
 + 
e2_Àn
 - 
lblk2
)

5799 
Àn
 = 
e2_blk
 + 
e2_Àn
 - 
lblk2
;

5801 i‡(
Àn
 !
e1_Àn
) {

5802 
•lô
 = 1;

5803 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode1
,

5804 &
∑th1
, 
lblk1
 + 
Àn
, 0);

5805 i‡(
	`u∆ikñy
(*
îp
))

5806 
föish
;

5808 i‡(
Àn
 !
e2_Àn
) {

5809 
•lô
 = 1;

5810 *
îp
 = 
	`pxt4_f‹˚_•lô_exã¡_©
(
h™dÀ
, 
öode2
,

5811 &
∑th2
, 
lblk2
 + 
Àn
, 0);

5812 i‡(*
îp
)

5813 
föish
;

5817 i‡(
•lô
)

5818 
ª≥©
;

5820 
	`BUG_ON
(
e2_Àn
 !
e1_Àn
);

5821 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode1
, 
∑th1
 +Ö©h1->
p_dïth
);

5822 i‡(
	`u∆ikñy
(*
îp
))

5823 
föish
;

5824 *
îp
 = 
	`pxt4_ext_gë_ac˚ss
(
h™dÀ
, 
öode2
, 
∑th2
 +Ö©h2->
p_dïth
);

5825 i‡(
	`u∆ikñy
(*
îp
))

5826 
föish
;

5829 
tmp_ex
 = *
ex1
;

5830 
	`pxt4_ext_°‹e_pblock
(
ex1
, 
	`pxt4_ext_pblock
(
ex2
));

5831 
	`pxt4_ext_°‹e_pblock
(
ex2
, 
	`pxt4_ext_pblock
(&
tmp_ex
));

5832 
ex1
->
ì_Àn
 = 
	`˝u_to_À16
(
e2_Àn
);

5833 
ex2
->
ì_Àn
 = 
	`˝u_to_À16
(
e1_Àn
);

5834 i‡(
unwrôãn
)

5835 
	`pxt4_ext_m¨k_unwrôãn
(
ex2
);

5836 i‡(
	`pxt4_ext_is_unwrôãn
(&
tmp_ex
))

5837 
	`pxt4_ext_m¨k_unwrôãn
(
ex1
);

5839 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode2
, 
∑th2
, 
ex2
);

5840 
	`pxt4_ext_åy_to_mîge
(
h™dÀ
, 
öode1
, 
∑th1
, 
ex1
);

5841 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode2
, 
∑th2
 +

5842 
∑th2
->
p_dïth
);

5843 i‡(
	`u∆ikñy
(*
îp
))

5844 
föish
;

5845 *
îp
 = 
	`pxt4_ext_dúty
(
h™dÀ
, 
öode1
, 
∑th1
 +

5846 
∑th1
->
p_dïth
);

5853 i‡(
	`u∆ikñy
(*
îp
))

5854 
föish
;

5855 
lblk1
 +
Àn
;

5856 
lblk2
 +
Àn
;

5857 
ª∂a˚d_cou¡
 +
Àn
;

5858 
cou¡
 -
Àn
;

5860 
ª≥©
:

5861 
	`pxt4_ext_dr›_ªfs
(
∑th1
);

5862 
	`k‰ì
(
∑th1
);

5863 
	`pxt4_ext_dr›_ªfs
(
∑th2
);

5864 
	`k‰ì
(
∑th2
);

5865 
∑th1
 = 
∑th2
 = 
NULL
;

5867  
ª∂a˚d_cou¡
;

5868 
	}
}

5882 
	$pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
)

5884 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5885 
pxt4_ext_∑th
 *
∑th
;

5886 
dïth
, 
m≠≥d
 = 0, 
îr
 = 0;

5887 
pxt4_exã¡
 *
exã¡
;

5888 
pxt4_lblk_t
 
fú°_lblk
, 
fú°_l˛u
, 
œ°_l˛u
;

5891 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
	`PXT4_C2B
(
sbi
, 
l˛u
), 
NULL
, 0);

5892 i‡(
	`IS_ERR
(
∑th
)) {

5893 
îr
 = 
	`PTR_ERR
(
∑th
);

5894 
∑th
 = 
NULL
;

5895 
out
;

5898 
dïth
 = 
	`ext_dïth
(
öode
);

5905 i‡(
	`u∆ikñy
(
∑th
[
dïth
].
p_ext
 =
NULL
 && depth != 0)) {

5906 
	`PXT4_ERROR_INODE
(
öode
,

5908 (Ë
	`PXT4_C2B
(
sbi
, 
l˛u
),

5909 
dïth
, 
∑th
[dïth].
p_block
);

5910 
îr
 = -
EFSCORRUPTED
;

5911 
out
;

5914 
exã¡
 = 
∑th
[
dïth
].
p_ext
;

5917 i‡(
exã¡
 =
NULL
)

5918 
out
;

5920 
fú°_lblk
 = 
	`À32_to_˝u
(
exã¡
->
ì_block
);

5921 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

5929 i‡(
l˛u
 >
fú°_l˛u
) {

5930 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
 +

5931 
	`pxt4_ext_gë_a˘uÆ_Àn
(
exã¡
) - 1);

5932 i‡(
l˛u
 <
œ°_l˛u
) {

5933 
m≠≥d
 = 1;

5935 
fú°_lblk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

5936 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
fú°_lblk
);

5937 i‡(
l˛u
 =
fú°_l˛u
)

5938 
m≠≥d
 = 1;

5942 
out
:

5943 
	`pxt4_ext_dr›_ªfs
(
∑th
);

5944 
	`k‰ì
(
∑th
);

5946  
îr
 ?Éº : 
m≠≥d
;

5947 
	}
}

	@extents_status.c

13 
	~<löux/li°_s‹t.h
>

14 
	~<löux/¥oc_fs.h
>

15 
	~<löux/£q_fûe.h
>

16 
	~"pxt4.h
"

18 
	~<åa˚/evíts/pxt4.h
>

144 
kmem_ˇche
 *
	gpxt4_es_ˇchï
;

145 
kmem_ˇche
 *
	gpxt4_≥ndög_ˇchï
;

147 
__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
);

148 
__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

149 
pxt4_lblk_t
 
íd
);

150 
es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
);

151 
__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

152 
pxt4_öode_öfo
 *
locked_ei
);

153 
__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

154 
pxt4_lblk_t
 
Àn
);

156 
__öô
 
	$pxt4_öô_es
()

158 
pxt4_es_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_extent_status",

159 (
exã¡_°©us
),

160 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

161 i‡(
pxt4_es_ˇchï
 =
NULL
)

162  -
ENOMEM
;

164 
	}
}

166 
	$pxt4_exô_es
()

168 
	`kmem_ˇche_de°roy
(
pxt4_es_ˇchï
);

169 
	}
}

171 
	$pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
)

173 
åì
->
roŸ
 = 
RB_ROOT
;

174 
åì
->
ˇche_es
 = 
NULL
;

175 
	}
}

177 #ifde‡
ES_DEBUG__


178 
	$pxt4_es_¥öt_åì
(
öode
 *inode)

180 
pxt4_es_åì
 *
åì
;

181 
rb_node
 *
node
;

183 
	`¥ötk
(
KERN_DEBUG
 "°©u†exã¡†f‹ inodê%lu:", 
öode
->
i_öo
);

184 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

185 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

186 
node
) {

187 
exã¡_°©us
 *
es
;

188 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

189 
	`¥ötk
(
KERN_DEBUG
 " [%u/%u) %llu %x",

190 
es
->
es_lblk
,És->
es_Àn
,

191 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

192 
node
 = 
	`rb_√xt
(node);

194 
	`¥ötk
(
KERN_DEBUG
 "\n");

195 
	}
}

197 
	#pxt4_es_¥öt_åì
(
öode
)

	)

200 
ölöe
 
pxt4_lblk_t
 
	$pxt4_es_íd
(
exã¡_°©us
 *
es
)

202 
	`BUG_ON
(
es
->
es_lblk
 +És->
es_Àn
 <És->es_lblk);

203  
es
->
es_lblk
 +És->
es_Àn
 - 1;

204 
	}
}

210 
exã¡_°©us
 *
	$__es_åì_£¨ch
(
rb_roŸ
 *
roŸ
,

211 
pxt4_lblk_t
 
lblk
)

213 
rb_node
 *
node
 = 
roŸ
->rb_node;

214 
exã¡_°©us
 *
es
 = 
NULL
;

216 
node
) {

217 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

218 i‡(
lblk
 < 
es
->
es_lblk
)

219 
node
 =Çode->
rb_À·
;

220 i‡(
lblk
 > 
	`pxt4_es_íd
(
es
))

221 
node
 =Çode->
rb_right
;

223  
es
;

226 i‡(
es
 && 
lblk
 <És->
es_lblk
)

227  
es
;

229 i‡(
es
 && 
lblk
 > 
	`pxt4_es_íd
(es)) {

230 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

231  
node
 ? 
	`rb_íåy
“ode, 
exã¡_°©us
, 
rb_node
) :

232 
NULL
;

235  
NULL
;

236 
	}
}

256 
	$__es_föd_exã¡_ønge
(
öode
 *inode,

257 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

258 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

259 
exã¡_°©us
 *
es
)

261 
pxt4_es_åì
 *
åì
 = 
NULL
;

262 
exã¡_°©us
 *
es1
 = 
NULL
;

263 
rb_node
 *
node
;

265 
	`WARN_ON
(
es
 =
NULL
);

266 
	`WARN_ON
(
íd
 < 
lblk
);

268 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

271 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

272 i‡(
åì
->
ˇche_es
) {

273 
es1
 = 
åì
->
ˇche_es
;

274 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

275 
	`es_debug
("%u cached by [%u/%u) %llu %x\n",

276 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
,

277 
	`pxt4_es_pblock
(
es1
), 
	`pxt4_es_°©us
(es1));

278 
out
;

282 
es1
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

284 
out
:

285 i‡(
es1
 && !
	`m©chög_‚
(es1)) {

286 (
node
 = 
	`rb_√xt
(&
es1
->
rb_node
)Ë!
NULL
) {

287 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

288 i‡(
es1
->
es_lblk
 > 
íd
) {

289 
es1
 = 
NULL
;

292 i‡(
	`m©chög_‚
(
es1
))

297 i‡(
es1
 && 
	`m©chög_‚
(es1)) {

298 
åì
->
ˇche_es
 = 
es1
;

299 
es
->
es_lblk
 = 
es1
->es_lblk;

300 
es
->
es_Àn
 = 
es1
->es_len;

301 
es
->
es_pblk
 = 
es1
->es_pblk;

304 
	}
}

309 
	$pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

310 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

311 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

312 
exã¡_°©us
 *
es
)

314 
	`åa˚_pxt4_es_föd_exã¡_ønge_íãr
(
öode
, 
lblk
);

316 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

317 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
, 
es
);

318 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

320 
	`åa˚_pxt4_es_föd_exã¡_ønge_exô
(
öode
, 
es
);

321 
	}
}

338 
boﬁ
 
	$__es_sˇn_ønge
(
öode
 *inode,

339 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

340 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

342 
exã¡_°©us
 
es
;

344 
	`__es_föd_exã¡_ønge
(
öode
, 
m©chög_‚
, 
°¨t
, 
íd
, &
es
);

345 i‡(
es
.
es_Àn
 == 0)

346  
Ál£
;

347 i‡(
es
.
es_lblk
 <
°¨t
 &&

348 
°¨t
 < 
es
.
es_lblk
 +És.
es_Àn
)

349  
åue
;

350 i‡(
°¨t
 <
es
.
es_lblk
 &&És.es_lblk <
íd
)

351  
åue
;

353  
Ál£
;

354 
	}
}

358 
boﬁ
 
	$pxt4_es_sˇn_ønge
(
öode
 *inode,

359 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

360 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
)

362 
boﬁ
 
ªt
;

364 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

365 
ªt
 = 
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk
, 
íd
);

366 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

368  
ªt
;

369 
	}
}

385 
boﬁ
 
	$__es_sˇn_˛u
(
öode
 *inode,

386 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

387 
pxt4_lblk_t
 
lblk
)

389 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

390 
pxt4_lblk_t
 
lblk_°¨t
, 
lblk_íd
;

392 
lblk_°¨t
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

393 
lblk_íd
 = 
lblk_°¨t
 + 
sbi
->
s_˛u°î_øtio
 - 1;

395  
	`__es_sˇn_ønge
(
öode
, 
m©chög_‚
, 
lblk_°¨t
, 
lblk_íd
);

396 
	}
}

401 
boﬁ
 
	$pxt4_es_sˇn_˛u
(
öode
 *inode,

402 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

403 
pxt4_lblk_t
 
lblk
)

405 
boﬁ
 
ªt
;

407 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

408 
ªt
 = 
	`__es_sˇn_˛u
(
öode
, 
m©chög_‚
, 
lblk
);

409 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

411  
ªt
;

412 
	}
}

414 
	$pxt4_es_li°_add
(
öode
 *inode)

416 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

417 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

419 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
))

422 
	`•ö_lock
(&
sbi
->
s_es_lock
);

423 i‡(
	`li°_em±y
(&
ei
->
i_es_li°
)) {

424 
	`li°_add_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

425 
sbi
->
s_es_ƒ_öode
++;

427 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

428 
	}
}

430 
	$pxt4_es_li°_dñ
(
öode
 *inode)

432 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

433 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

435 
	`•ö_lock
(&
sbi
->
s_es_lock
);

436 i‡(!
	`li°_em±y
(&
ei
->
i_es_li°
)) {

437 
	`li°_dñ_öô
(&
ei
->
i_es_li°
);

438 
sbi
->
s_es_ƒ_öode
--;

439 
	`WARN_ON_ONCE
(
sbi
->
s_es_ƒ_öode
 < 0);

441 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

442 
	}
}

444 
exã¡_°©us
 *

445 
	$pxt4_es_Æloc_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
Àn
,

446 
pxt4_fsblk_t
 
pblk
)

448 
exã¡_°©us
 *
es
;

449 
es
 = 
	`kmem_ˇche_Æloc
(
pxt4_es_ˇchï
, 
GFP_ATOMIC
);

450 i‡(
es
 =
NULL
)

451  
NULL
;

452 
es
->
es_lblk
 = 
lblk
;

453 
es
->
es_Àn
 = 
Àn
;

454 
es
->
es_pblk
 = 
pblk
;

459 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

460 i‡(!
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
++)

461 
	`pxt4_es_li°_add
(
öode
);

462 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->

463 
s_es_°©s
.
es_°©s_shk_˙t
);

466 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
++;

467 
	`≥r˝u_cou¡î_öc
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

469  
es
;

470 
	}
}

472 
	$pxt4_es_‰ì_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
es
)

474 
	`PXT4_I
(
öode
)->
i_es_Æl_ƒ
--;

475 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
.
es_°©s_Æl_˙t
);

478 i‡(!
	`pxt4_es_is_dñayed
(
es
)) {

479 
	`BUG_ON
(
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
 == 0);

480 i‡(!--
	`PXT4_I
(
öode
)->
i_es_shk_ƒ
)

481 
	`pxt4_es_li°_dñ
(
öode
);

482 
	`≥r˝u_cou¡î_dec
(&
	`PXT4_SB
(
öode
->
i_sb
)->

483 
s_es_°©s
.
es_°©s_shk_˙t
);

486 
	`kmem_ˇche_‰ì
(
pxt4_es_ˇchï
, 
es
);

487 
	}
}

496 
	$pxt4_es_ˇn_be_mîged
(
exã¡_°©us
 *
es1
,

497 
exã¡_°©us
 *
es2
)

499 i‡(
	`pxt4_es_ty≥
(
es1
Ë!pxt4_es_ty≥(
es2
))

502 i‡(((
__u64
Ë
es1
->
es_Àn
Ë+ 
es2
->es_À¿> 
EXT_MAX_BLOCKS
) {

503 
	`¥_w¨n
("ESássertion failed when mergingÉxtents. "

506 
es1
->
es_Àn
, 
es2
->es_Àn, 
EXT_MAX_BLOCKS
);

507 
	`WARN_ON
(1);

511 i‡(((
__u64
Ë
es1
->
es_lblk
Ë+És1->
es_Àn
 !
es2
->es_lblk)

514 i‡((
	`pxt4_es_is_wrôãn
(
es1
Ë|| 
	`pxt4_es_is_unwrôãn
(es1)) &&

515 (
	`pxt4_es_pblock
(
es1
Ë+És1->
es_Àn
 =pxt4_es_pblock(
es2
)))

518 i‡(
	`pxt4_es_is_hﬁe
(
es1
))

522 i‡(
	`pxt4_es_is_dñayed
(
es1
Ë&& !
	`pxt4_es_is_unwrôãn
(es1))

526 
	}
}

528 
exã¡_°©us
 *

529 
	$pxt4_es_åy_to_mîge_À·
(
öode
 *öode, 
exã¡_°©us
 *
es
)

531 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

532 
exã¡_°©us
 *
es1
;

533 
rb_node
 *
node
;

535 
node
 = 
	`rb_¥ev
(&
es
->
rb_node
);

536 i‡(!
node
)

537  
es
;

539 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

540 i‡(
	`pxt4_es_ˇn_be_mîged
(
es1
, 
es
)) {

541 
es1
->
es_Àn
 +
es
->es_len;

542 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
))

543 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

544 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

545 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

546 
es
 = 
es1
;

549  
es
;

550 
	}
}

552 
exã¡_°©us
 *

553 
	$pxt4_es_åy_to_mîge_right
(
öode
 *öode, 
exã¡_°©us
 *
es
)

555 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

556 
exã¡_°©us
 *
es1
;

557 
rb_node
 *
node
;

559 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

560 i‡(!
node
)

561  
es
;

563 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

564 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
es1
)) {

565 
es
->
es_Àn
 +
es1
->es_len;

566 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es1
))

567 
	`pxt4_es_£t_ª„ªn˚d
(
es
);

568 
	`rb_îa£
(
node
, &
åì
->
roŸ
);

569 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es1
);

572  
es
;

573 
	}
}

575 #ifde‡
ES_AGGRESSIVE_TEST


576 
	~"pxt4_exã¡s.h
"

578 
	$pxt4_es_ö£π_exã¡_ext_check
(
öode
 *inode,

579 
exã¡_°©us
 *
es
)

581 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

582 
pxt4_exã¡
 *
ex
;

583 
pxt4_lblk_t
 
ì_block
;

584 
pxt4_fsblk_t
 
ì_°¨t
;

585 
ì_Àn
;

586 
dïth
, 
ì_°©us
, 
es_°©us
;

588 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
es
->
es_lblk
, 
NULL
, 
PXT4_EX_NOCACHE
);

589 i‡(
	`IS_ERR
(
∑th
))

592 
dïth
 = 
	`ext_dïth
(
öode
);

593 
ex
 = 
∑th
[
dïth
].
p_ext
;

595 i‡(
ex
) {

597 
ì_block
 = 
	`À32_to_˝u
(
ex
->ee_block);

598 
ì_°¨t
 = 
	`pxt4_ext_pblock
(
ex
);

599 
ì_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

601 
ì_°©us
 = 
	`pxt4_ext_is_unwrôãn
(
ex
) ? 1 : 0;

602 
es_°©us
 = 
	`pxt4_es_is_unwrôãn
(
es
) ? 1 : 0;

608 i‡(!
	`pxt4_es_is_wrôãn
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es)) {

609 i‡(
	`ö_ønge
(
es
->
es_lblk
, 
ì_block
, 
ì_Àn
)) {

610 
	`¥_w¨n
("ES insertássertion failed for "

615 
öode
->
i_öo
, 
ì_block
, 
ì_Àn
,

616 
ì_°¨t
, 
ì_°©us
 ? 'u' : 'w',

617 
es
->
es_lblk
,És->
es_Àn
,

618 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

620 
out
;

627 i‡(
es
->
es_lblk
 < 
ì_block
 ||

628 
	`pxt4_es_pblock
(
es
Ë!
ì_°¨t
 +És->
es_lblk
 - 
ì_block
) {

629 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

631 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

632 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

633 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

634 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

635 
out
;

638 i‡(
ì_°©us
 ^ 
es_°©us
) {

639 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

641 "es_°©u†[%d/%d/%Œu/%c]\n", 
öode
->
i_öo
,

642 
ì_block
, 
ì_Àn
, 
ì_°¨t
,

643 
ì_°©us
 ? 'u' : 'w', 
es
->
es_lblk
,És->
es_Àn
,

644 
	`pxt4_es_pblock
(
es
), 
es_°©us
 ? 'u' : 'w');

651 i‡(!
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_hﬁe
(es)) {

652 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

655 "[%d/%d/%Œu/%x]\n", 
öode
->
i_öo
,

656 
es
->
es_lblk
,És->es_lblk,És->
es_Àn
,

657 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

660 
out
:

661 
	`pxt4_ext_dr›_ªfs
(
∑th
);

662 
	`k‰ì
(
∑th
);

663 
	}
}

665 
	$pxt4_es_ö£π_exã¡_öd_check
(
öode
 *inode,

666 
exã¡_°©us
 *
es
)

668 
pxt4_m≠_blocks
 
m≠
;

669 
ªtvÆ
;

678 
m≠
.
m_lblk
 = 
es
->
es_lblk
;

679 
m≠
.
m_Àn
 = 
es
->
es_Àn
;

681 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

682 i‡(
ªtvÆ
 > 0) {

683 i‡(
	`pxt4_es_is_dñayed
(
es
Ë|| 
	`pxt4_es_is_hﬁe
(es)) {

688 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

691 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

692 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

694 } i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

695 i‡(
ªtvÆ
 !
es
->
es_Àn
) {

696 
	`¥_w¨n
("ES insertássertion failed for "

698 
öode
->
i_öo
, 
ªtvÆ
, 
es
->
es_Àn
);

701 i‡(
m≠
.
m_pblk
 !
	`pxt4_es_pblock
(
es
)) {

702 
	`¥_w¨n
("ES insertássertion failed for "

705 
öode
->
i_öo
, 
m≠
.
m_pblk
,

706 
	`pxt4_es_pblock
(
es
));

714 
	`BUG_ON
(1);

716 } i‡(
ªtvÆ
 == 0) {

717 i‡(
	`pxt4_es_is_wrôãn
(
es
)) {

718 
	`¥_w¨n
("ES insertássertion failed for inode: %lu "

721 
öode
->
i_öo
, 
es
->
es_lblk
,És->
es_Àn
,

722 
	`pxt4_es_pblock
(
es
), 
	`pxt4_es_°©us
(es));

726 
	}
}

728 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

729 
exã¡_°©us
 *
es
)

735 
	`BUG_ON
(!
	`rw£m_is_locked
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

736 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

737 
	`pxt4_es_ö£π_exã¡_ext_check
(
öode
, 
es
);

739 
	`pxt4_es_ö£π_exã¡_öd_check
(
öode
, 
es
);

740 
	}
}

742 
ölöe
 
	$pxt4_es_ö£π_exã¡_check
(
öode
 *inode,

743 
exã¡_°©us
 *
es
)

745 
	}
}

748 
	$__es_ö£π_exã¡
(
öode
 *öode, 
exã¡_°©us
 *
√wes
)

750 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

751 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

752 
rb_node
 *
∑ª¡
 = 
NULL
;

753 
exã¡_°©us
 *
es
;

755 *
p
) {

756 
∑ª¡
 = *
p
;

757 
es
 = 
	`rb_íåy
(
∑ª¡
, 
exã¡_°©us
, 
rb_node
);

759 i‡(
√wes
->
es_lblk
 < 
es
->es_lblk) {

760 i‡(
	`pxt4_es_ˇn_be_mîged
(
√wes
, 
es
)) {

765 
es
->
es_lblk
 = 
√wes
->es_lblk;

766 
es
->
es_Àn
 +
√wes
->es_len;

767 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

768 
	`pxt4_es_is_unwrôãn
(
es
))

769 
	`pxt4_es_°‹e_pblock
(
es
,

770 
√wes
->
es_pblk
);

771 
es
 = 
	`pxt4_es_åy_to_mîge_À·
(
öode
,És);

772 
out
;

774 
p
 = &(*p)->
rb_À·
;

775 } i‡(
√wes
->
es_lblk
 > 
	`pxt4_es_íd
(
es
)) {

776 i‡(
	`pxt4_es_ˇn_be_mîged
(
es
, 
√wes
)) {

777 
es
->
es_Àn
 +
√wes
->es_len;

778 
es
 = 
	`pxt4_es_åy_to_mîge_right
(
öode
,És);

779 
out
;

781 
p
 = &(*p)->
rb_right
;

783 
	`BUG_ON
(1);

784  -
EINVAL
;

788 
es
 = 
	`pxt4_es_Æloc_exã¡
(
öode
, 
√wes
->
es_lblk
,Çewes->
es_Àn
,

789 
√wes
->
es_pblk
);

790 i‡(!
es
)

791  -
ENOMEM
;

792 
	`rb_lök_node
(&
es
->
rb_node
, 
∑ª¡
, 
p
);

793 
	`rb_ö£π_cﬁ‹
(&
es
->
rb_node
, &
åì
->
roŸ
);

795 
out
:

796 
åì
->
ˇche_es
 = 
es
;

798 
	}
}

806 
	$pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

807 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

808 
°©us
)

810 
exã¡_°©us
 
√wes
;

811 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

812 
îr
 = 0;

813 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

815 
	`es_debug
("add [%u/%u) %llu %xÅoÉxtent statusÅree of inode %lu\n",

816 
lblk
, 
Àn
, 
pblk
, 
°©us
, 
öode
->
i_öo
);

818 i‡(!
Àn
)

821 
	`BUG_ON
(
íd
 < 
lblk
);

823 i‡((
°©us
 & 
EXTENT_STATUS_DELAYED
) &&

824 (
°©us
 & 
EXTENT_STATUS_WRITTEN
)) {

825 
	`pxt4_w¨nög
(
öode
->
i_sb
, "InsertingÉxtent [%u/%u]ás "

827 " cau£ d©®loss.", 
lblk
, 
Àn
);

828 
	`WARN_ON
(1);

831 
√wes
.
es_lblk
 = 
lblk
;

832 
√wes
.
es_Àn
 = 
Àn
;

833 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

834 
	`åa˚_pxt4_es_ö£π_exã¡
(
öode
, &
√wes
);

836 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

838 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
);

840 i‡(
îr
 != 0)

841 
îr‹
;

842 
ªåy
:

843 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

844 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

845 128, 
	`PXT4_I
(
öode
)))

846 
ªåy
;

847 i‡(
îr
 =-
ENOMEM
 && !
	`pxt4_es_is_dñayed
(&
√wes
))

848 
îr
 = 0;

850 i‡(
sbi
->
s_˛u°î_øtio
 > 1 && 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

851 (
°©us
 & 
EXTENT_STATUS_WRITTEN
 ||

852 
°©us
 & 
EXTENT_STATUS_UNWRITTEN
))

853 
	`__ªvi£_≥ndög
(
öode
, 
lblk
, 
Àn
);

855 
îr‹
:

856 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

858 
	`pxt4_es_¥öt_åì
(
öode
);

860  
îr
;

861 
	}
}

868 
	$pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

869 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

870 
°©us
)

872 
exã¡_°©us
 *
es
;

873 
exã¡_°©us
 
√wes
;

874 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

876 
√wes
.
es_lblk
 = 
lblk
;

877 
√wes
.
es_Àn
 = 
Àn
;

878 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
pblk
, 
°©us
);

879 
	`åa˚_pxt4_es_ˇche_exã¡
(
öode
, &
√wes
);

881 i‡(!
Àn
)

884 
	`BUG_ON
(
íd
 < 
lblk
);

886 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

888 
es
 = 
	`__es_åì_£¨ch
(&
	`PXT4_I
(
öode
)->
i_es_åì
.
roŸ
, 
lblk
);

889 i‡(!
es
 ||És->
es_lblk
 > 
íd
)

890 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

891 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

892 
	}
}

901 
	$pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

902 
exã¡_°©us
 *
es
)

904 
pxt4_es_åì
 *
åì
;

905 
pxt4_es_°©s
 *
°©s
;

906 
exã¡_°©us
 *
es1
 = 
NULL
;

907 
rb_node
 *
node
;

908 
found
 = 0;

910 
	`åa˚_pxt4_es_lookup_exã¡_íãr
(
öode
, 
lblk
);

911 
	`es_debug
("looku∞exã¡ i¿block %u\n", 
lblk
);

913 
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

914 
	`ªad_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

917 
es
->
es_lblk
 =És->
es_Àn
 =És->
es_pblk
 = 0;

918 i‡(
åì
->
ˇche_es
) {

919 
es1
 = 
åì
->
ˇche_es
;

920 i‡(
	`ö_ønge
(
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
)) {

921 
	`es_debug
("%u cached by [%u/%u)\n",

922 
lblk
, 
es1
->
es_lblk
,És1->
es_Àn
);

923 
found
 = 1;

924 
out
;

928 
node
 = 
åì
->
roŸ
.
rb_node
;

929 
node
) {

930 
es1
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

931 i‡(
lblk
 < 
es1
->
es_lblk
)

932 
node
 =Çode->
rb_À·
;

933 i‡(
lblk
 > 
	`pxt4_es_íd
(
es1
))

934 
node
 =Çode->
rb_right
;

936 
found
 = 1;

941 
out
:

942 
°©s
 = &
	`PXT4_SB
(
öode
->
i_sb
)->
s_es_°©s
;

943 i‡(
found
) {

944 
	`BUG_ON
(!
es1
);

945 
es
->
es_lblk
 = 
es1
->es_lblk;

946 
es
->
es_Àn
 = 
es1
->es_len;

947 
es
->
es_pblk
 = 
es1
->es_pblk;

948 i‡(!
	`pxt4_es_is_ª„ªn˚d
(
es1
))

949 
	`pxt4_es_£t_ª„ªn˚d
(
es1
);

950 
°©s
->
es_°©s_ˇche_hôs
++;

952 
°©s
->
es_°©s_ˇche_mis£s
++;

955 
	`ªad_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

957 
	`åa˚_pxt4_es_lookup_exã¡_exô
(
öode
, 
es
, 
found
);

958  
found
;

959 
	}
}

961 
	$__es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

962 
pxt4_lblk_t
 
íd
)

964 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

965 
rb_node
 *
node
;

966 
exã¡_°©us
 *
es
;

967 
exã¡_°©us
 
‹ig_es
;

968 
pxt4_lblk_t
 
Àn1
, 
Àn2
;

969 
pxt4_fsblk_t
 
block
;

970 
îr
;

972 
ªåy
:

973 
îr
 = 0;

974 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
lblk
);

975 i‡(!
es
)

976 
out
;

977 i‡(
es
->
es_lblk
 > 
íd
)

978 
out
;

981 
åì
->
ˇche_es
 = 
NULL
;

983 
‹ig_es
.
es_lblk
 = 
es
->es_lblk;

984 
‹ig_es
.
es_Àn
 = 
es
->es_len;

985 
‹ig_es
.
es_pblk
 = 
es
->es_pblk;

987 
Àn1
 = 
lblk
 > 
es
->
es_lblk
 ?Üblk -És->es_lblk : 0;

988 
Àn2
 = 
	`pxt4_es_íd
(
es
Ë> 
íd
 ?Öxt4_es_end(es) -Énd : 0;

989 i‡(
Àn1
 > 0)

990 
es
->
es_Àn
 = 
Àn1
;

991 i‡(
Àn2
 > 0) {

992 i‡(
Àn1
 > 0) {

993 
exã¡_°©us
 
√wes
;

995 
√wes
.
es_lblk
 = 
íd
 + 1;

996 
√wes
.
es_Àn
 = 
Àn2
;

997 
block
 = 0x7FDEADBEEFULL;

998 i‡(
	`pxt4_es_is_wrôãn
(&
‹ig_es
) ||

999 
	`pxt4_es_is_unwrôãn
(&
‹ig_es
))

1000 
block
 = 
	`pxt4_es_pblock
(&
‹ig_es
) +

1001 
‹ig_es
.
es_Àn
 - 
Àn2
;

1002 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, 
block
,

1003 
	`pxt4_es_°©us
(&
‹ig_es
));

1004 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1005 i‡(
îr
) {

1006 
es
->
es_lblk
 = 
‹ig_es
.es_lblk;

1007 
es
->
es_Àn
 = 
‹ig_es
.es_len;

1008 i‡((
îr
 =-
ENOMEM
) &&

1009 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1010 128, 
	`PXT4_I
(
öode
)))

1011 
ªåy
;

1012 
out
;

1015 
es
->
es_lblk
 = 
íd
 + 1;

1016 
es
->
es_Àn
 = 
Àn2
;

1017 i‡(
	`pxt4_es_is_wrôãn
(
es
) ||

1018 
	`pxt4_es_is_unwrôãn
(
es
)) {

1019 
block
 = 
‹ig_es
.
es_pblk
 + orig_es.
es_Àn
 - 
Àn2
;

1020 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1023 
out
;

1026 i‡(
Àn1
 > 0) {

1027 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1028 i‡(
node
)

1029 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1031 
es
 = 
NULL
;

1034 
es
 && 
	`pxt4_es_íd
”sË<
íd
) {

1035 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1036 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1037 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1038 i‡(!
node
) {

1039 
es
 = 
NULL
;

1042 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1045 i‡(
es
 &&És->
es_lblk
 < 
íd
 + 1) {

1046 
pxt4_lblk_t
 
‹ig_Àn
 = 
es
->
es_Àn
;

1048 
Àn1
 = 
	`pxt4_es_íd
(
es
Ë- 
íd
;

1049 
es
->
es_lblk
 = 
íd
 + 1;

1050 
es
->
es_Àn
 = 
Àn1
;

1051 i‡(
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es)) {

1052 
block
 = 
es
->
es_pblk
 + 
‹ig_Àn
 - 
Àn1
;

1053 
	`pxt4_es_°‹e_pblock
(
es
, 
block
);

1057 
out
:

1058  
îr
;

1059 
	}
}

1066 
	$pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1067 
pxt4_lblk_t
 
Àn
)

1069 
pxt4_lblk_t
 
íd
;

1070 
îr
 = 0;

1072 
	`åa˚_pxt4_es_ªmove_exã¡
(
öode
, 
lblk
, 
Àn
);

1073 
	`es_debug
("remove [%u/%u) fromÉxtent statusÅree of inode %lu\n",

1074 
lblk
, 
Àn
, 
öode
->
i_öo
);

1076 i‡(!
Àn
)

1077  
îr
;

1079 
íd
 = 
lblk
 + 
Àn
 - 1;

1080 
	`BUG_ON
(
íd
 < 
lblk
);

1087 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1088 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
, 
íd
);

1089 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1090 
	`pxt4_es_¥öt_åì
(
öode
);

1091  
îr
;

1092 
	}
}

1094 
	$__es_shrök
(
pxt4_sb_öfo
 *
sbi
, 
ƒ_to_sˇn
,

1095 
pxt4_öode_öfo
 *
locked_ei
)

1097 
pxt4_öode_öfo
 *
ei
;

1098 
pxt4_es_°©s
 *
es_°©s
;

1099 
ktime_t
 
°¨t_time
;

1100 
u64
 
sˇn_time
;

1101 
ƒ_to_wÆk
;

1102 
ƒ_shrunk
 = 0;

1103 
ªåõd
 = 0, 
ƒ_skù≥d
 = 0;

1105 
es_°©s
 = &
sbi
->
s_es_°©s
;

1106 
°¨t_time
 = 
	`ktime_gë
();

1108 
ªåy
:

1109 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1110 
ƒ_to_wÆk
 = 
sbi
->
s_es_ƒ_öode
;

1111 
ƒ_to_wÆk
-- > 0) {

1112 i‡(
	`li°_em±y
(&
sbi
->
s_es_li°
)) {

1113 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1114 
out
;

1116 
ei
 = 
	`li°_fú°_íåy
(&
sbi
->
s_es_li°
, 
pxt4_öode_öfo
,

1117 
i_es_li°
);

1119 
	`li°_move_èû
(&
ei
->
i_es_li°
, &
sbi
->
s_es_li°
);

1125 i‡(!
ªåõd
 && 
	`pxt4_ã°_öode_°©e
(&
ei
->
vfs_öode
,

1126 
PXT4_STATE_EXT_PRECACHED
)) {

1127 
ƒ_skù≥d
++;

1131 i‡(
ei
 =
locked_ei
 || !
	`wrôe_åylock
(&ei->
i_es_lock
)) {

1132 
ƒ_skù≥d
++;

1139 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1141 
ƒ_shrunk
 +
	`es_ª˛aim_exã¡s
(
ei
, &
ƒ_to_sˇn
);

1142 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1144 i‡(
ƒ_to_sˇn
 <= 0)

1145 
out
;

1146 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1148 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1154 i‡((
ƒ_shrunk
 =0Ë&& 
ƒ_skù≥d
 && !
ªåõd
) {

1155 
ªåõd
++;

1156 
ªåy
;

1159 i‡(
locked_ei
 && 
ƒ_shrunk
 == 0)

1160 
ƒ_shrunk
 = 
	`es_ª˛aim_exã¡s
(
locked_ei
, &
ƒ_to_sˇn
);

1162 
out
:

1163 
sˇn_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1164 i‡(
	`likñy
(
es_°©s
->
es_°©s_sˇn_time
))

1165 
es_°©s
->
es_°©s_sˇn_time
 = (
sˇn_time
 +

1166 
es_°©s
->
es_°©s_sˇn_time
*3) / 4;

1168 
es_°©s
->
es_°©s_sˇn_time
 = 
sˇn_time
;

1169 i‡(
sˇn_time
 > 
es_°©s
->
es_°©s_max_sˇn_time
)

1170 
es_°©s
->
es_°©s_max_sˇn_time
 = 
sˇn_time
;

1171 i‡(
	`likñy
(
es_°©s
->
es_°©s_shrunk
))

1172 
es_°©s
->
es_°©s_shrunk
 = (
ƒ_shrunk
 +

1173 
es_°©s
->
es_°©s_shrunk
*3) / 4;

1175 
es_°©s
->
es_°©s_shrunk
 = 
ƒ_shrunk
;

1177 
	`åa˚_pxt4_es_shrök
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
sˇn_time
,

1178 
ƒ_skù≥d
, 
ªåõd
);

1179  
ƒ_shrunk
;

1180 
	}
}

1182 
	$pxt4_es_cou¡
(
shrökî
 *
shrök
,

1183 
shrök_c⁄åﬁ
 *
sc
)

1185 
ƒ
;

1186 
pxt4_sb_öfo
 *
sbi
;

1188 
sbi
 = 
	`c⁄èöî_of
(
shrök
, 
pxt4_sb_öfo
, 
s_es_shrökî
);

1189 
ƒ
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1190 
	`åa˚_pxt4_es_shrök_cou¡
(
sbi
->
s_sb
, 
sc
->
ƒ_to_sˇn
, 
ƒ
);

1191  
ƒ
;

1192 
	}
}

1194 
	$pxt4_es_sˇn
(
shrökî
 *
shrök
,

1195 
shrök_c⁄åﬁ
 *
sc
)

1197 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
shrök
,

1198 
pxt4_sb_öfo
, 
s_es_shrökî
);

1199 
ƒ_to_sˇn
 = 
sc
->nr_to_scan;

1200 
ªt
, 
ƒ_shrunk
;

1202 
ªt
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1203 
	`åa˚_pxt4_es_shrök_sˇn_íãr
(
sbi
->
s_sb
, 
ƒ_to_sˇn
, 
ªt
);

1205 i‡(!
ƒ_to_sˇn
)

1206  
ªt
;

1208 
ƒ_shrunk
 = 
	`__es_shrök
(
sbi
, 
ƒ_to_sˇn
, 
NULL
);

1210 
	`åa˚_pxt4_es_shrök_sˇn_exô
(
sbi
->
s_sb
, 
ƒ_shrunk
, 
ªt
);

1211  
ƒ_shrunk
;

1212 
	}
}

1214 
	$pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
)

1216 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
((
su≥r_block
 *Ë
£q
->
¥iv©e
);

1217 
pxt4_es_°©s
 *
es_°©s
 = &
sbi
->
s_es_°©s
;

1218 
pxt4_öode_öfo
 *
ei
, *
max
 = 
NULL
;

1219 
öode_˙t
 = 0;

1221 i‡(
v
 !
SEQ_START_TOKEN
)

1225 
	`•ö_lock
(&
sbi
->
s_es_lock
);

1226 
	`li°_f‹_óch_íåy
(
ei
, &
sbi
->
s_es_li°
, 
i_es_li°
) {

1227 
öode_˙t
++;

1228 i‡(
max
 && max->
i_es_Æl_ƒ
 < 
ei
->i_es_all_nr)

1229 
max
 = 
ei
;

1230 i‡(!
max
)

1231 
max
 = 
ei
;

1233 
	`•ö_u∆ock
(&
sbi
->
s_es_lock
);

1235 
	`£q_¥ötf
(
£q
, "stats:\n %lld objects\n %lldÑeclaimable objects\n",

1236 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_Æl_˙t
),

1237 
	`≥r˝u_cou¡î_sum_posôive
(&
es_°©s
->
es_°©s_shk_˙t
));

1238 
	`£q_¥ötf
(
£q
, " %lu/%lu cache hits/misses\n",

1239 
es_°©s
->
es_°©s_ˇche_hôs
,

1240 
es_°©s
->
es_°©s_ˇche_mis£s
);

1241 i‡(
öode_˙t
)

1242 
	`£q_¥ötf
(
£q
, " %d inode†⁄Üi°\n", 
öode_˙t
);

1244 
	`£q_¥ötf
(
£q
, "average:\n %llu us scanÅime\n",

1245 
	`div_u64
(
es_°©s
->
es_°©s_sˇn_time
, 1000));

1246 
	`£q_¥ötf
(
£q
, " %lu shrunk obje˘s\n", 
es_°©s
->
es_°©s_shrunk
);

1247 i‡(
öode_˙t
)

1248 
	`£q_¥ötf
(
£q
,

1251 
max
->
vfs_öode
.
i_öo
, max->
i_es_Æl_ƒ
, max->
i_es_shk_ƒ
,

1252 
	`div_u64
(
es_°©s
->
es_°©s_max_sˇn_time
, 1000));

1255 
	}
}

1257 
	$pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1259 
îr
;

1262 
	`BUILD_BUG_ON
(
ES_SHIFT
 < 48);

1263 
	`INIT_LIST_HEAD
(&
sbi
->
s_es_li°
);

1264 
sbi
->
s_es_ƒ_öode
 = 0;

1265 
	`•ö_lock_öô
(&
sbi
->
s_es_lock
);

1266 
sbi
->
s_es_°©s
.
es_°©s_shrunk
 = 0;

1267 
sbi
->
s_es_°©s
.
es_°©s_ˇche_hôs
 = 0;

1268 
sbi
->
s_es_°©s
.
es_°©s_ˇche_mis£s
 = 0;

1269 
sbi
->
s_es_°©s
.
es_°©s_sˇn_time
 = 0;

1270 
sbi
->
s_es_°©s
.
es_°©s_max_sˇn_time
 = 0;

1271 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
, 0, 
GFP_KERNEL
);

1272 i‡(
îr
)

1273  
îr
;

1274 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
, 0, 
GFP_KERNEL
);

1275 i‡(
îr
)

1276 
îr1
;

1278 
sbi
->
s_es_shrökî
.
sˇn_obje˘s
 = 
pxt4_es_sˇn
;

1279 
sbi
->
s_es_shrökî
.
cou¡_obje˘s
 = 
pxt4_es_cou¡
;

1280 
sbi
->
s_es_shrökî
.
£eks
 = 
DEFAULT_SEEKS
;

1281 
îr
 = 
	`ªgi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1282 i‡(
îr
)

1283 
îr2
;

1287 
îr2
:

1288 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1289 
îr1
:

1290 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1291  
îr
;

1292 
	}
}

1294 
	$pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
)

1296 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_Æl_˙t
);

1297 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_es_°©s
.
es_°©s_shk_˙t
);

1298 
	`uƒegi°î_shrökî
(&
sbi
->
s_es_shrökî
);

1299 
	}
}

1309 
	$es_do_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, 
pxt4_lblk_t
 
íd
,

1310 *
ƒ_to_sˇn
, *
ƒ_shrunk
)

1312 
öode
 *öodê&
ei
->
vfs_öode
;

1313 
pxt4_es_åì
 *
åì
 = &
ei
->
i_es_åì
;

1314 
exã¡_°©us
 *
es
;

1315 
rb_node
 *
node
;

1317 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
ei
->
i_es_shrök_lblk
);

1318 i‡(!
es
)

1319 
out_wøp
;

1320 
node
 = &
es
->
rb_node
;

1321 *
ƒ_to_sˇn
 > 0) {

1322 i‡(
es
->
es_lblk
 > 
íd
) {

1323 
ei
->
i_es_shrök_lblk
 = 
íd
 + 1;

1327 (*
ƒ_to_sˇn
)--;

1328 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1333 i‡(
	`pxt4_es_is_dñayed
(
es
))

1334 
√xt
;

1335 i‡(
	`pxt4_es_is_ª„ªn˚d
(
es
)) {

1336 
	`pxt4_es_˛ór_ª„ªn˚d
(
es
);

1337 
√xt
;

1340 
	`rb_îa£
(&
es
->
rb_node
, &
åì
->
roŸ
);

1341 
	`pxt4_es_‰ì_exã¡
(
öode
, 
es
);

1342 (*
ƒ_shrunk
)++;

1343 
√xt
:

1344 i‡(!
node
)

1345 
out_wøp
;

1346 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1348 
ei
->
i_es_shrök_lblk
 = 
es
->
es_lblk
;

1350 
out_wøp
:

1351 
ei
->
i_es_shrök_lblk
 = 0;

1353 
	}
}

1355 
	$es_ª˛aim_exã¡s
(
pxt4_öode_öfo
 *
ei
, *
ƒ_to_sˇn
)

1357 
öode
 *öodê&
ei
->
vfs_öode
;

1358 
ƒ_shrunk
 = 0;

1359 
pxt4_lblk_t
 
°¨t
 = 
ei
->
i_es_shrök_lblk
;

1360 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1361 
DEFAULT_RATELIMIT_BURST
);

1363 i‡(
ei
->
i_es_shk_ƒ
 == 0)

1366 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_PRECACHED
) &&

1367 
	`__øãlimô
(&
_rs
))

1368 
	`pxt4_w¨nög
(
öode
->
i_sb
, "forced shrink ofÖrecachedÉxtents");

1370 i‡(!
	`es_do_ª˛aim_exã¡s
(
ei
, 
EXT_MAX_BLOCKS
, 
ƒ_to_sˇn
, &
ƒ_shrunk
) &&

1371 
°¨t
 != 0)

1372 
	`es_do_ª˛aim_exã¡s
(
ei
, 
°¨t
 - 1, 
ƒ_to_sˇn
, &
ƒ_shrunk
);

1374 
ei
->
i_es_åì
.
ˇche_es
 = 
NULL
;

1375  
ƒ_shrunk
;

1376 
	}
}

1378 #ifde‡
ES_DEBUG__


1379 
	$pxt4_¥öt_≥ndög_åì
(
öode
 *inode)

1381 
pxt4_≥ndög_åì
 *
åì
;

1382 
rb_node
 *
node
;

1383 
≥ndög_ª£rv©i⁄
 *
¥
;

1385 
	`¥ötk
(
KERN_DEBUG
 "≥ndögÑe£rv©i⁄†f‹ inodê%lu:", 
öode
->
i_öo
);

1386 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1387 
node
 = 
	`rb_fú°
(&
åì
->
roŸ
);

1388 
node
) {

1389 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1390 
	`¥ötk
(
KERN_DEBUG
 " %u", 
¥
->
l˛u
);

1391 
node
 = 
	`rb_√xt
(node);

1393 
	`¥ötk
(
KERN_DEBUG
 "\n");

1394 
	}
}

1396 
	#pxt4_¥öt_≥ndög_åì
(
öode
)

	)

1399 
__öô
 
	$pxt4_öô_≥ndög
()

1401 
pxt4_≥ndög_ˇchï
 = 
	`kmem_ˇche_¸óã
("pxt4_pending_reservation",

1402 (
≥ndög_ª£rv©i⁄
),

1403 0, (
SLAB_RECLAIM_ACCOUNT
), 
NULL
);

1404 i‡(
pxt4_≥ndög_ˇchï
 =
NULL
)

1405  -
ENOMEM
;

1407 
	}
}

1409 
	$pxt4_exô_≥ndög
()

1411 
	`kmem_ˇche_de°roy
(
pxt4_≥ndög_ˇchï
);

1412 
	}
}

1414 
	$pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
)

1416 
åì
->
roŸ
 = 
RB_ROOT
;

1417 
	}
}

1428 
≥ndög_ª£rv©i⁄
 *
	$__gë_≥ndög
(
öode
 *inode,

1429 
pxt4_lblk_t
 
l˛u
)

1431 
pxt4_≥ndög_åì
 *
åì
;

1432 
rb_node
 *
node
;

1433 
≥ndög_ª£rv©i⁄
 *
¥
 = 
NULL
;

1435 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1436 
node
 = (&
åì
->
roŸ
)->
rb_node
;

1438 
node
) {

1439 
¥
 = 
	`rb_íåy
(
node
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1440 i‡(
l˛u
 < 
¥
->lclu)

1441 
node
 =Çode->
rb_À·
;

1442 i‡(
l˛u
 > 
¥
->lclu)

1443 
node
 =Çode->
rb_right
;

1444 i‡(
l˛u
 =
¥
->lclu)

1445  
¥
;

1447  
NULL
;

1448 
	}
}

1460 
	$__ö£π_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1462 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1463 
pxt4_≥ndög_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1464 
rb_node
 **
p
 = &
åì
->
roŸ
.rb_node;

1465 
rb_node
 *
∑ª¡
 = 
NULL
;

1466 
≥ndög_ª£rv©i⁄
 *
¥
;

1467 
pxt4_lblk_t
 
l˛u
;

1468 
ªt
 = 0;

1470 
l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
);

1472 *
p
) {

1473 
∑ª¡
 = *
p
;

1474 
¥
 = 
	`rb_íåy
(
∑ª¡
, 
≥ndög_ª£rv©i⁄
, 
rb_node
);

1476 i‡(
l˛u
 < 
¥
->lclu) {

1477 
p
 = &(*p)->
rb_À·
;

1478 } i‡(
l˛u
 > 
¥
->lclu) {

1479 
p
 = &(*p)->
rb_right
;

1482 
out
;

1486 
¥
 = 
	`kmem_ˇche_Æloc
(
pxt4_≥ndög_ˇchï
, 
GFP_ATOMIC
);

1487 i‡(
¥
 =
NULL
) {

1488 
ªt
 = -
ENOMEM
;

1489 
out
;

1491 
¥
->
l˛u
 =Üclu;

1493 
	`rb_lök_node
(&
¥
->
rb_node
, 
∑ª¡
, 
p
);

1494 
	`rb_ö£π_cﬁ‹
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1496 
out
:

1497  
ªt
;

1498 
	}
}

1509 
	$__ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1511 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1512 
≥ndög_ª£rv©i⁄
 *
¥
;

1513 
pxt4_≥ndög_åì
 *
åì
;

1515 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
));

1516 i‡(
¥
 !
NULL
) {

1517 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1518 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1519 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1521 
	}
}

1532 
	$pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1534 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1536 
	`wrôe_lock
(&
ei
->
i_es_lock
);

1537 
	`__ªmove_≥ndög
(
öode
, 
lblk
);

1538 
	`wrôe_u∆ock
(&
ei
->
i_es_lock
);

1539 
	}
}

1551 
boﬁ
 
	$pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1553 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1554 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1555 
boﬁ
 
ªt
;

1557 
	`ªad_lock
(&
ei
->
i_es_lock
);

1558 
ªt
 = (
boﬁ
)(
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
lblk
)Ë!
NULL
);

1559 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1561  
ªt
;

1562 
	}
}

1576 
	$pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1577 
boﬁ
 
Æloˇãd
)

1579 
exã¡_°©us
 
√wes
;

1580 
îr
 = 0;

1582 
	`es_debug
("add [%u/1) delayedÅoÉxtent statusÅree of inode %lu\n",

1583 
lblk
, 
öode
->
i_öo
);

1585 
√wes
.
es_lblk
 = 
lblk
;

1586 
√wes
.
es_Àn
 = 1;

1587 
	`pxt4_es_°‹e_pblock_°©us
(&
√wes
, ~0, 
EXTENT_STATUS_DELAYED
);

1588 
	`åa˚_pxt4_es_ö£π_dñayed_block
(
öode
, &
√wes
, 
Æloˇãd
);

1590 
	`pxt4_es_ö£π_exã¡_check
(
öode
, &
√wes
);

1592 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1594 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
lblk
,Üblk);

1595 i‡(
îr
 != 0)

1596 
îr‹
;

1597 
ªåy
:

1598 
îr
 = 
	`__es_ö£π_exã¡
(
öode
, &
√wes
);

1599 i‡(
îr
 =-
ENOMEM
 && 
	`__es_shrök
(
	`PXT4_SB
(
öode
->
i_sb
),

1600 128, 
	`PXT4_I
(
öode
)))

1601 
ªåy
;

1602 i‡(
îr
 != 0)

1603 
îr‹
;

1605 i‡(
Æloˇãd
)

1606 
	`__ö£π_≥ndög
(
öode
, 
lblk
);

1608 
îr‹
:

1609 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1611 
	`pxt4_es_¥öt_åì
(
öode
);

1612 
	`pxt4_¥öt_≥ndög_åì
(
öode
);

1614  
îr
;

1615 
	}
}

1630 
	$__es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

1631 
pxt4_lblk_t
 
íd
)

1633 
pxt4_es_åì
 *
åì
 = &
	`PXT4_I
(
öode
)->
i_es_åì
;

1634 
exã¡_°©us
 *
es
;

1635 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1636 
rb_node
 *
node
;

1637 
pxt4_lblk_t
 
fú°_l˛u
, 
œ°_l˛u
;

1638 
œ°_cou¡ed_l˛u
;

1639 
n
 = 0;

1642 
œ°_cou¡ed_l˛u
 = ~0ULL;

1644 
es
 = 
	`__es_åì_£¨ch
(&
åì
->
roŸ
, 
°¨t
);

1646 
es
 && (es->
es_lblk
 <
íd
)) {

1647 i‡(
	`pxt4_es_is_dñ⁄ly
(
es
)) {

1648 i‡(
es
->
es_lblk
 <
°¨t
)

1649 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
°¨t
);

1651 
fú°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
es
->
es_lblk
);

1653 i‡(
	`pxt4_es_íd
(
es
Ë>
íd
)

1654 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
íd
);

1656 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_es_íd
(
es
));

1658 i‡(
fú°_l˛u
 =
œ°_cou¡ed_l˛u
)

1659 
n
 +
œ°_l˛u
 - 
fú°_l˛u
;

1661 
n
 +
œ°_l˛u
 - 
fú°_l˛u
 + 1;

1662 
œ°_cou¡ed_l˛u
 = 
œ°_l˛u
;

1664 
node
 = 
	`rb_√xt
(&
es
->
rb_node
);

1665 i‡(!
node
)

1667 
es
 = 
	`rb_íåy
(
node
, 
exã¡_°©us
, 
rb_node
);

1670  
n
;

1671 
	}
}

1683 
	$pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1684 
pxt4_lblk_t
 
Àn
)

1686 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1687 
pxt4_lblk_t
 
íd
;

1688 
n
;

1690 i‡(
Àn
 == 0)

1693 
íd
 = 
lblk
 + 
Àn
 - 1;

1694 
	`WARN_ON
(
íd
 < 
lblk
);

1696 
	`ªad_lock
(&
ei
->
i_es_lock
);

1698 
n
 = 
	`__es_dñayed_˛u
(
öode
, 
lblk
, 
íd
);

1700 
	`ªad_u∆ock
(&
ei
->
i_es_lock
);

1702  
n
;

1703 
	}
}

1720 
	$__ªvi£_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1721 
pxt4_lblk_t
 
Àn
)

1723 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1724 
pxt4_lblk_t
 
íd
 = 
lblk
 + 
Àn
 - 1;

1725 
pxt4_lblk_t
 
fú°
, 
œ°
;

1726 
boﬁ
 
f_dñ
 = 
Ál£
, 
l_dñ
 = false;

1728 i‡(
Àn
 == 0)

1744 i‡(
	`PXT4_B2C
(
sbi
, 
lblk
Ë=PXT4_B2C(sbi, 
íd
)) {

1745 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

1746 i‡(
fú°
 !
lblk
)

1747 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

1748 
fú°
, 
lblk
 - 1);

1749 i‡(
f_dñ
) {

1750 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

1752 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
) +

1753 
sbi
->
s_˛u°î_øtio
 - 1;

1754 i‡(
œ°
 !
íd
)

1755 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
,

1756 &
pxt4_es_is_dñ⁄ly
,

1757 
íd
 + 1, 
œ°
);

1758 i‡(
l_dñ
)

1759 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

1761 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

1764 
fú°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
lblk
);

1765 i‡(
fú°
 !
lblk
)

1766 
f_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

1767 
fú°
, 
lblk
 - 1);

1768 i‡(
f_dñ
)

1769 
	`__ö£π_≥ndög
(
öode
, 
fú°
);

1771 
	`__ªmove_≥ndög
(
öode
, 
fú°
);

1773 
œ°
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
íd
Ë+ sbi->
s_˛u°î_øtio
 - 1;

1774 i‡(
œ°
 !
íd
)

1775 
l_dñ
 = 
	`__es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñ⁄ly
,

1776 
íd
 + 1, 
œ°
);

1777 i‡(
l_dñ
)

1778 
	`__ö£π_≥ndög
(
öode
, 
œ°
);

1780 
	`__ªmove_≥ndög
(
öode
, 
œ°
);

1782 
	}
}

1794 
	$pxt4_es_ªmove_blks
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

1795 
pxt4_lblk_t
 
Àn
)

1797 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1798 
˛u_size
, 
ª£rved
 = 0;

1799 
pxt4_lblk_t
 
œ°_l˛u
, 
fú°
, 
Àngth
, 
ªmaödî
, 
œ°
;

1800 
boﬁ
 
dñ⁄ly
;

1801 
îr
 = 0;

1802 
≥ndög_ª£rv©i⁄
 *
¥
;

1803 
pxt4_≥ndög_åì
 *
åì
;

1811 
˛u_size
 = 
sbi
->
s_˛u°î_øtio
;

1812 
œ°_l˛u
 = 
	`PXT4_B2C
(
sbi
, 
lblk
 + 
Àn
 - 1);

1814 
	`wrôe_lock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1816 
fú°
 = 
lblk
, 
ªmaödî
 = 
Àn
;

1817 
ªmaödî
 > 0;

1818 
fú°
 +
Àngth
, 
ªmaödî
 -=Üength) {

1820 i‡(
	`PXT4_B2C
(
sbi
, 
fú°
Ë=
œ°_l˛u
)

1821 
Àngth
 = 
ªmaödî
;

1823 
Àngth
 = 
˛u_size
 - 
	`PXT4_LBLK_COFF
(
sbi
, 
fú°
);

1832 
dñ⁄ly
 = 
	`__es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
fú°
);

1838 
œ°
 = 
fú°
 + 
Àngth
 - 1;

1839 
îr
 = 
	`__es_ªmove_exã¡
(
öode
, 
fú°
, 
œ°
);

1840 i‡(
îr
)

1841 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1843 
__func__
, 
îr
);

1846 i‡(
sbi
->
s_˛u°î_øtio
 =1 && 
dñ⁄ly
) {

1847 
ª£rved
++;

1856 i‡(
dñ⁄ly
 &&

1857 !
	`__es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
fú°
)) {

1858 
¥
 = 
	`__gë_≥ndög
(
öode
, 
	`PXT4_B2C
(
sbi
, 
fú°
));

1859 i‡(
¥
 !
NULL
) {

1860 
åì
 = &
	`PXT4_I
(
öode
)->
i_≥ndög_åì
;

1861 
	`rb_îa£
(&
¥
->
rb_node
, &
åì
->
roŸ
);

1862 
	`kmem_ˇche_‰ì
(
pxt4_≥ndög_ˇchï
, 
¥
);

1864 
ª£rved
++;

1869 
	`wrôe_u∆ock
(&
	`PXT4_I
(
öode
)->
i_es_lock
);

1871 
	`pxt4_da_ªÀa£_•a˚
(
öode
, 
ª£rved
);

1872 
	}
}

	@extents_status.h

12 #i‚de‡
_PXT4_EXTENTS_STATUS_H


13 
	#_PXT4_EXTENTS_STATUS_H


	)

18 #ifde‡
ES_DEBUG__


19 
	#es_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

21 
	#es_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

28 
	#ES_AGGRESSIVE_TEST__


	)

34 
	mES_WRITTEN_B
,

35 
	mES_UNWRITTEN_B
,

36 
	mES_DELAYED_B
,

37 
	mES_HOLE_B
,

38 
	mES_REFERENCED_B
,

39 
	mES_FLAGS


42 
	#ES_SHIFT
 ((
pxt4_fsblk_t
)*8 - 
ES_FLAGS
)

	)

43 
	#ES_MASK
 (~((
pxt4_fsblk_t
)0Ë<< 
ES_SHIFT
)

	)

45 
	#EXTENT_STATUS_WRITTEN
 (1 << 
ES_WRITTEN_B
)

	)

46 
	#EXTENT_STATUS_UNWRITTEN
 (1 << 
ES_UNWRITTEN_B
)

	)

47 
	#EXTENT_STATUS_DELAYED
 (1 << 
ES_DELAYED_B
)

	)

48 
	#EXTENT_STATUS_HOLE
 (1 << 
ES_HOLE_B
)

	)

49 
	#EXTENT_STATUS_REFERENCED
 (1 << 
ES_REFERENCED_B
)

	)

51 
	#ES_TYPE_MASK
 ((
pxt4_fsblk_t
)(
EXTENT_STATUS_WRITTEN
 | \

52 
EXTENT_STATUS_UNWRITTEN
 | \

53 
EXTENT_STATUS_DELAYED
 | \

54 
EXTENT_STATUS_HOLE
Ë<< 
ES_SHIFT
)

	)

56 
	gpxt4_sb_öfo
;

57 
	gpxt4_exã¡
;

59 
	sexã¡_°©us
 {

60 
rb_node
 
	mrb_node
;

61 
pxt4_lblk_t
 
	mes_lblk
;

62 
pxt4_lblk_t
 
	mes_Àn
;

63 
pxt4_fsblk_t
 
	mes_pblk
;

66 
	spxt4_es_åì
 {

67 
rb_roŸ
 
	mroŸ
;

68 
exã¡_°©us
 *
	mˇche_es
;

71 
	spxt4_es_°©s
 {

72 
	mes_°©s_shrunk
;

73 
	mes_°©s_ˇche_hôs
;

74 
	mes_°©s_ˇche_mis£s
;

75 
u64
 
	mes_°©s_sˇn_time
;

76 
u64
 
	mes_°©s_max_sˇn_time
;

77 
≥r˝u_cou¡î
 
	mes_°©s_Æl_˙t
;

78 
≥r˝u_cou¡î
 
	mes_°©s_shk_˙t
;

117 
	s≥ndög_ª£rv©i⁄
 {

118 
rb_node
 
	mrb_node
;

119 
pxt4_lblk_t
 
	ml˛u
;

122 
	spxt4_≥ndög_åì
 {

123 
rb_roŸ
 
	mroŸ
;

126 
__öô
 
pxt4_öô_es
();

127 
pxt4_exô_es
();

128 
pxt4_es_öô_åì
(
pxt4_es_åì
 *
åì
);

130 
pxt4_es_ö£π_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

131 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

132 
°©us
);

133 
pxt4_es_ˇche_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

134 
pxt4_lblk_t
 
Àn
, 
pxt4_fsblk_t
 
pblk
,

135 
°©us
);

136 
pxt4_es_ªmove_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

137 
pxt4_lblk_t
 
Àn
);

138 
pxt4_es_föd_exã¡_ønge
(
öode
 *inode,

139 (*
m©ch_‚
)(
exã¡_°©us
 *
es
),

140 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
,

141 
exã¡_°©us
 *
es
);

142 
	`pxt4_es_lookup_exã¡
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

143 
exã¡_°©us
 *
es
);

144 
boﬁ
 
	`pxt4_es_sˇn_ønge
(
öode
 *inode,

145 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

146 
pxt4_lblk_t
 
lblk
,Öxt4_lblk_à
íd
);

147 
boﬁ
 
	`pxt4_es_sˇn_˛u
(
öode
 *inode,

148 (*
m©chög_‚
)(
exã¡_°©us
 *
es
),

149 
pxt4_lblk_t
 
lblk
);

151 
ölöe
 
	$pxt4_es_°©us
(
exã¡_°©us
 *
es
)

153  
es
->
es_pblk
 >> 
ES_SHIFT
;

154 
	}
}

156 
ölöe
 
	$pxt4_es_ty≥
(
exã¡_°©us
 *
es
)

158  (
es
->
es_pblk
 & 
ES_TYPE_MASK
Ë>> 
ES_SHIFT
;

159 
	}
}

161 
ölöe
 
	$pxt4_es_is_wrôãn
(
exã¡_°©us
 *
es
)

163  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_WRITTEN
) != 0;

164 
	}
}

166 
ölöe
 
	$pxt4_es_is_unwrôãn
(
exã¡_°©us
 *
es
)

168  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_UNWRITTEN
) != 0;

169 
	}
}

171 
ölöe
 
	$pxt4_es_is_dñayed
(
exã¡_°©us
 *
es
)

173  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_DELAYED
) != 0;

174 
	}
}

176 
ölöe
 
	$pxt4_es_is_hﬁe
(
exã¡_°©us
 *
es
)

178  (
	`pxt4_es_ty≥
(
es
Ë& 
EXTENT_STATUS_HOLE
) != 0;

179 
	}
}

181 
ölöe
 
	$pxt4_es_is_m≠≥d
(
exã¡_°©us
 *
es
)

183  (
	`pxt4_es_is_wrôãn
(
es
Ë|| 
	`pxt4_es_is_unwrôãn
(es));

184 
	}
}

186 
ölöe
 
	$pxt4_es_is_dñ⁄ly
(
exã¡_°©us
 *
es
)

188  (
	`pxt4_es_is_dñayed
(
es
Ë&& !
	`pxt4_es_is_unwrôãn
(es));

189 
	}
}

191 
ölöe
 
	$pxt4_es_£t_ª„ªn˚d
(
exã¡_°©us
 *
es
)

193 
es
->
es_pblk
 |((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
;

194 
	}
}

196 
ölöe
 
	$pxt4_es_˛ór_ª„ªn˚d
(
exã¡_°©us
 *
es
)

198 
es
->
es_pblk
 &~(((
pxt4_fsblk_t
)
EXTENT_STATUS_REFERENCED
Ë<< 
ES_SHIFT
);

199 
	}
}

201 
ölöe
 
	$pxt4_es_is_ª„ªn˚d
(
exã¡_°©us
 *
es
)

203  (
	`pxt4_es_°©us
(
es
Ë& 
EXTENT_STATUS_REFERENCED
) != 0;

204 
	}
}

206 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_es_pblock
(
exã¡_°©us
 *
es
)

208  
es
->
es_pblk
 & ~
ES_MASK
;

209 
	}
}

211 
ölöe
 
	$pxt4_es_°‹e_pblock
(
exã¡_°©us
 *
es
,

212 
pxt4_fsblk_t
 
pb
)

214 
pxt4_fsblk_t
 
block
;

216 
block
 = (
pb
 & ~
ES_MASK
Ë| (
es
->
es_pblk
 & ES_MASK);

217 
es
->
es_pblk
 = 
block
;

218 
	}
}

220 
ölöe
 
	$pxt4_es_°‹e_°©us
(
exã¡_°©us
 *
es
,

221 
°©us
)

223 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

224 (
es
->
es_pblk
 & ~
ES_MASK
);

225 
	}
}

227 
ölöe
 
	$pxt4_es_°‹e_pblock_°©us
(
exã¡_°©us
 *
es
,

228 
pxt4_fsblk_t
 
pb
,

229 
°©us
)

231 
es
->
es_pblk
 = (((
pxt4_fsblk_t
)
°©us
 << 
ES_SHIFT
Ë& 
ES_MASK
) |

232 (
pb
 & ~
ES_MASK
);

233 
	}
}

235 
pxt4_es_ªgi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

236 
pxt4_es_uƒegi°î_shrökî
(
pxt4_sb_öfo
 *
sbi
);

238 
pxt4_£q_es_shrökî_öfo_show
(
£q_fûe
 *
£q
, *
v
);

240 
__öô
 
pxt4_öô_≥ndög
();

241 
pxt4_exô_≥ndög
();

242 
pxt4_öô_≥ndög_åì
(
pxt4_≥ndög_åì
 *
åì
);

243 
pxt4_ªmove_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

244 
boﬁ
 
pxt4_is_≥ndög
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
);

245 
pxt4_es_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

246 
boﬁ
 
Æloˇãd
);

247 
pxt4_es_dñayed_˛u
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

248 
pxt4_lblk_t
 
Àn
);

249 
pxt4_es_ªmove_blks
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

250 
pxt4_lblk_t
 
Àn
);

	@file.c

22 
	~<löux/time.h
>

23 
	~<löux/fs.h
>

24 
	~<löux/iom≠.h
>

25 
	~<löux/mou¡.h
>

26 
	~<löux/∑th.h
>

27 
	~<löux/dax.h
>

28 
	~<löux/quŸa›s.h
>

29 
	~<löux/∑gevec.h
>

30 
	~<löux/uio.h
>

31 
	~<löux/mm™.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

34 
	~"x©å.h
"

35 
	~"a˛.h
"

37 #ifde‡
CONFIG_FS_DAX


38 
ssize_t
 
	$pxt4_dax_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

40 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

41 
ssize_t
 
ªt
;

43 i‡(!
	`öode_åylock_sh¨ed
(
öode
)) {

44 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

45  -
EAGAIN
;

46 
	`öode_lock_sh¨ed
(
öode
);

52 i‡(!
	`IS_DAX
(
öode
)) {

53 
	`öode_u∆ock_sh¨ed
(
öode
);

55  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

57 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
to
, &
pxt4_iom≠_›s
);

58 
	`öode_u∆ock_sh¨ed
(
öode
);

60 
	`fûe_ac˚s£d
(
iocb
->
ki_fûp
);

61  
ªt
;

62 
	}
}

65 
ssize_t
 
	$pxt4_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
to
)

67 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
	`fûe_öode
(
iocb
->
ki_fûp
)->
i_sb
))))

68  -
EIO
;

70 i‡(!
	`iov_ôî_cou¡
(
to
))

73 #ifde‡
CONFIG_FS_DAX


74 i‡(
	`IS_DAX
(
	`fûe_öode
(
iocb
->
ki_fûp
)))

75  
	`pxt4_dax_ªad_ôî
(
iocb
, 
to
);

77  
	`gíîic_fûe_ªad_ôî
(
iocb
, 
to
);

78 
	}
}

85 
	$pxt4_ªÀa£_fûe
(
öode
 *öode, 
fûe
 *
fûp
)

87 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
)) {

88 
	`pxt4_Æloc_da_blocks
(
öode
);

89 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

92 i‡((
fûp
->
f_mode
 & 
FMODE_WRITE
) &&

93 (
	`©omic_ªad
(&
öode
->
i_wrôecou¡
) == 1) &&

94 !
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

96 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

97 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

98 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

100 i‡(
	`is_dx
(
öode
Ë&& 
fûp
->
¥iv©e_d©a
)

101 
	`pxt4_håì_‰ì_dú_öfo
(
fûp
->
¥iv©e_d©a
);

104 
	}
}

106 
	$pxt4_unwrôãn_waô
(
öode
 *inode)

108 
waô_queue_hód_t
 *
wq
 = 
	`pxt4_i€nd_wq
(
öode
);

110 
	`waô_evít
(*
wq
, (
	`©omic_ªad
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
) == 0));

111 
	}
}

123 
	$pxt4_u«lig√d_aio
(
öode
 *öode, 
iov_ôî
 *
‰om
, 
loff_t
 
pos
)

125 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

126 
blockmask
 = 
sb
->
s_blocksize
 - 1;

128 i‡(
pos
 >
	`ALIGN
(
	`i_size_ªad
(
öode
), 
sb
->
s_blocksize
))

131 i‡((
pos
 | 
	`iov_ôî_Æignmít
(
‰om
)Ë& 
blockmask
)

135 
	}
}

138 
boﬁ
 
	$pxt4_ovîwrôe_io
(
öode
 *öode, 
loff_t
 
pos
,Üoff_à
Àn
)

140 
pxt4_m≠_blocks
 
m≠
;

141 
blkbôs
 = 
öode
->
i_blkbôs
;

142 
îr
, 
blkÀn
;

144 i‡(
pos
 + 
Àn
 > 
	`i_size_ªad
(
öode
))

145  
Ál£
;

147 
m≠
.
m_lblk
 = 
pos
 >> 
blkbôs
;

148 
m≠
.
m_Àn
 = 
	`PXT4_MAX_BLOCKS
(
Àn
, 
pos
, 
blkbôs
);

149 
blkÀn
 = 
m≠
.
m_Àn
;

151 
îr
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

157  
îr
 =
blkÀn
 && (
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
);

158 
	}
}

160 
ssize_t
 
	$pxt4_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

162 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

163 
ssize_t
 
ªt
;

165 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

166 i‡(
ªt
 <= 0)

167  
ªt
;

172 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

173 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

175 i‡(
iocb
->
ki_pos
 >
sbi
->
s_bôm≠_maxbyãs
)

176  -
EFBIG
;

177 
	`iov_ôî_åunˇã
(
‰om
, 
sbi
->
s_bôm≠_maxbyãs
 - 
iocb
->
ki_pos
);

179  
	`iov_ôî_cou¡
(
‰om
);

180 
	}
}

182 #ifde‡
CONFIG_FS_DAX


183 
ssize_t


184 
	$pxt4_dax_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

186 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

187 
ssize_t
 
ªt
;

189 i‡(!
	`öode_åylock
(
öode
)) {

190 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

191  -
EAGAIN
;

192 
	`öode_lock
(
öode
);

194 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

195 i‡(
ªt
 <= 0)

196 
out
;

197 
ªt
 = 
	`fûe_ªmove_¥ivs
(
iocb
->
ki_fûp
);

198 i‡(
ªt
)

199 
out
;

200 
ªt
 = 
	`fûe_upd©e_time
(
iocb
->
ki_fûp
);

201 i‡(
ªt
)

202 
out
;

204 
ªt
 = 
	`dax_iom≠_rw
(
iocb
, 
‰om
, &
pxt4_iom≠_›s
);

205 
out
:

206 
	`öode_u∆ock
(
öode
);

207 i‡(
ªt
 > 0)

208 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

209  
ªt
;

210 
	}
}

213 
ssize_t


214 
	$pxt4_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

216 
öode
 *öodê
	`fûe_öode
(
iocb
->
ki_fûp
);

217 
o_dúe˘
 = 
iocb
->
ki_Êags
 & 
IOCB_DIRECT
;

218 
u«lig√d_aio
 = 0;

219 
ovîwrôe
 = 0;

220 
ssize_t
 
ªt
;

222 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

223  -
EIO
;

225 #ifde‡
CONFIG_FS_DAX


226 i‡(
	`IS_DAX
(
öode
))

227  
	`pxt4_dax_wrôe_ôî
(
iocb
, 
‰om
);

229 i‡(!
o_dúe˘
 && (
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
))

230  -
EOPNOTSUPP
;

232 i‡(!
	`öode_åylock
(
öode
)) {

233 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

234  -
EAGAIN
;

235 
	`öode_lock
(
öode
);

238 
ªt
 = 
	`pxt4_wrôe_checks
(
iocb
, 
‰om
);

239 i‡(
ªt
 <= 0)

240 
out
;

247 i‡(
o_dúe˘
 && 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) &&

248 !
	`is_sync_kiocb
(
iocb
) &&

249 
	`pxt4_u«lig√d_aio
(
öode
, 
‰om
, 
iocb
->
ki_pos
)) {

250 
u«lig√d_aio
 = 1;

251 
	`pxt4_unwrôãn_waô
(
öode
);

254 
iocb
->
¥iv©e
 = &
ovîwrôe
;

256 i‡(
o_dúe˘
 && !
u«lig√d_aio
) {

257 i‡(
	`pxt4_ovîwrôe_io
(
öode
, 
iocb
->
ki_pos
, 
	`iov_ôî_cou¡
(
‰om
))) {

258 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

259 
ovîwrôe
 = 1;

260 } i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

261 
ªt
 = -
EAGAIN
;

262 
out
;

266 
ªt
 = 
	`__gíîic_fûe_wrôe_ôî
(
iocb
, 
‰om
);

272 i‡(
ªt
 =-
EIOCBQUEUED
 && 
u«lig√d_aio
)

273 
	`pxt4_unwrôãn_waô
(
öode
);

274 
	`öode_u∆ock
(
öode
);

276 i‡(
ªt
 > 0)

277 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

279  
ªt
;

281 
out
:

282 
	`öode_u∆ock
(
öode
);

283  
ªt
;

284 
	}
}

286 #ifde‡
CONFIG_FS_DAX


287 
vm_Áu…_t
 
	$pxt4_dax_huge_Áu…
(
vm_Áu…
 *
vmf
,

288 
∑ge_íåy_size
 
≥_size
)

290 
îr‹
 = 0;

291 
vm_Áu…_t
 
ªsu…
;

292 
ªåõs
 = 0;

293 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

294 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

295 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

308 
boﬁ
 
wrôe
 = (
vmf
->
Êags
 & 
FAULT_FLAG_WRITE
) &&

309 (
vmf
->
vma
->
vm_Êags
 & 
VM_SHARED
);

310 
p‚_t
 
p‚
;

312 i‡(
wrôe
) {

313 
	`sb_°¨t_∑geÁu…
(
sb
);

314 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

315 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

316 
ªåy
:

317 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_WRITE_PAGE
,

318 
	`PXT4_DATA_TRANS_BLOCKS
(
sb
));

319 i‡(
	`IS_ERR
(
h™dÀ
)) {

320 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

321 
	`sb_íd_∑geÁu…
(
sb
);

322  
VM_FAULT_SIGBUS
;

325 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

327 
ªsu…
 = 
	`dax_iom≠_Áu…
(
vmf
, 
≥_size
, &
p‚
, &
îr‹
, &
pxt4_iom≠_›s
);

328 i‡(
wrôe
) {

329 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

331 i‡((
ªsu…
 & 
VM_FAULT_ERROR
Ë&& 
îr‹
 =-
ENOSPC
 &&

332 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

333 
ªåy
;

335 i‡(
ªsu…
 & 
VM_FAULT_NEEDDSYNC
)

336 
ªsu…
 = 
	`dax_föish_sync_Áu…
(
vmf
, 
≥_size
, 
p‚
);

337 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

338 
	`sb_íd_∑geÁu…
(
sb
);

340 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

343  
ªsu…
;

344 
	}
}

346 
vm_Áu…_t
 
	$pxt4_dax_Áu…
(
vm_Áu…
 *
vmf
)

348  
	`pxt4_dax_huge_Áu…
(
vmf
, 
PE_SIZE_PTE
);

349 
	}
}

351 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_dax_vm_›s
 = {

352 .
Áu…
 = 
pxt4_dax_Áu…
,

353 .
	ghuge_Áu…
 = 
pxt4_dax_huge_Áu…
,

354 .
	g∑ge_mkwrôe
 = 
pxt4_dax_Áu…
,

355 .
	gp‚_mkwrôe
 = 
pxt4_dax_Áu…
,

358 
	#pxt4_dax_vm_›s
 
pxt4_fûe_vm_›s


	)

361 c⁄° 
vm_›î©i⁄s_°ru˘
 
	gpxt4_fûe_vm_›s
 = {

362 .
Áu…
 = 
pxt4_fûem≠_Áu…
,

363 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

364 .
	g∑ge_mkwrôe
 = 
pxt4_∑ge_mkwrôe
,

367 
	$pxt4_fûe_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

369 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

371 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

372  -
EIO
;

378 i‡(!
	`IS_DAX
(
	`fûe_öode
(
fûe
)Ë&& (
vma
->
vm_Êags
 & 
VM_SYNC
))

379  -
EOPNOTSUPP
;

381 
	`fûe_ac˚s£d
(
fûe
);

382 i‡(
	`IS_DAX
(
	`fûe_öode
(
fûe
))) {

383 
vma
->
vm_›s
 = &
pxt4_dax_vm_›s
;

384 
vma
->
vm_Êags
 |
VM_HUGEPAGE
;

386 
vma
->
vm_›s
 = &
pxt4_fûe_vm_›s
;

389 
	}
}

391 
	$pxt4_ßm∂e_œ°_mou¡ed
(
su≥r_block
 *
sb
,

392 
vfsmou¡
 *
m¡
)

394 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

395 
∑th
Öath;

396 
buf
[64], *
˝
;

397 
h™dÀ_t
 *
h™dÀ
;

398 
îr
;

400 i‡(
	`likñy
(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_MNTDIR_SAMPLED
))

403 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`sb_°¨t_ötwrôe_åylock
(sb))

406 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_MNTDIR_SAMPLED
;

413 
	`mem£t
(
buf
, 0, (buf));

414 
∑th
.
m¡
 = mnt;

415 
∑th
.
díåy
 = 
m¡
->
m¡_roŸ
;

416 
˝
 = 
	`d_∑th
(&
∑th
, 
buf
, (buf));

417 
îr
 = 0;

418 i‡(
	`IS_ERR
(
˝
))

419 
out
;

421 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

422 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

423 i‡(
	`IS_ERR
(
h™dÀ
))

424 
out
;

425 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

426 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

427 i‡(
îr
)

428 
out_jou∫Æ
;

429 
	`°æ˝y
(
sbi
->
s_es
->
s_œ°_mou¡ed
, 
˝
,

430 (
sbi
->
s_es
->
s_œ°_mou¡ed
));

431 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

432 
out_jou∫Æ
:

433 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

434 
out
:

435 
	`sb_íd_ötwrôe
(
sb
);

436  
îr
;

437 
	}
}

439 
	$pxt4_fûe_›í
(
öode
 * inode, 
fûe
 * 
fûp
)

441 
ªt
;

443 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

444  -
EIO
;

446 
ªt
 = 
	`pxt4_ßm∂e_œ°_mou¡ed
(
öode
->
i_sb
, 
fûp
->
f_∑th
.
m¡
);

447 i‡(
ªt
)

448  
ªt
;

450 
ªt
 = 
	`fs¸y±_fûe_›í
(
öode
, 
fûp
);

451 i‡(
ªt
)

452  
ªt
;

458 i‡(
fûp
->
f_mode
 & 
FMODE_WRITE
) {

459 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

460 i‡(
ªt
 < 0)

461  
ªt
;

464 
fûp
->
f_mode
 |
FMODE_NOWAIT
;

465  
	`dquŸ_fûe_›í
(
öode
, 
fûp
);

466 
	}
}

473 
loff_t
 
	$pxt4_Œ£ek
(
fûe
 *fûe, 
loff_t
 
off£t
, 
whí˚
)

475 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

476 
loff_t
 
maxbyãs
;

478 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

479 
maxbyãs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
;

481 
maxbyãs
 = 
öode
->
i_sb
->
s_maxbyãs
;

483 
whí˚
) {

485  
	`gíîic_fûe_Œ£ek_size
(
fûe
, 
off£t
, 
whí˚
,

486 
maxbyãs
, 
	`i_size_ªad
(
öode
));

487 
SEEK_HOLE
:

488 
	`öode_lock_sh¨ed
(
öode
);

489 
off£t
 = 
	`iom≠_£ek_hﬁe
(
öode
, off£t, &
pxt4_iom≠_›s
);

490 
	`öode_u∆ock_sh¨ed
(
öode
);

492 
SEEK_DATA
:

493 
	`öode_lock_sh¨ed
(
öode
);

494 
off£t
 = 
	`iom≠_£ek_d©a
(
öode
, off£t, &
pxt4_iom≠_›s
);

495 
	`öode_u∆ock_sh¨ed
(
öode
);

499 i‡(
off£t
 < 0)

500  
off£t
;

501  
	`vfs_£ços
(
fûe
, 
off£t
, 
maxbyãs
);

502 
	}
}

504 c⁄° 
fûe_›î©i⁄s
 
	gpxt4_fûe_›î©i⁄s
 = {

505 .
Œ£ek
 = 
pxt4_Œ£ek
,

506 .
	gªad_ôî
 = 
pxt4_fûe_ªad_ôî
,

507 .
	gwrôe_ôî
 = 
pxt4_fûe_wrôe_ôî
,

508 .
	gu∆ocked_io˘l
 = 
pxt4_io˘l
,

509 #ifde‡
CONFIG_COMPAT


510 .
	gcom∑t_io˘l
 = 
pxt4_com∑t_io˘l
,

512 .
	gmm≠
 = 
pxt4_fûe_mm≠
,

513 .
	gmm≠_suµ‹ãd_Êags
 = 
MAP_SYNC
,

514 .
	g›í
 = 
pxt4_fûe_›í
,

515 .
	gªÀa£
 = 
pxt4_ªÀa£_fûe
,

516 .
	gfsync
 = 
pxt4_sync_fûe
,

517 .
	ggë_unm≠≥d_¨ó
 = 
thp_gë_unm≠≥d_¨ó
,

518 .
	g•li˚_ªad
 = 
gíîic_fûe_•li˚_ªad
,

519 .
	g•li˚_wrôe
 = 
ôî_fûe_•li˚_wrôe
,

520 .
	gÁŒoˇã
 = 
pxt4_ÁŒoˇã
,

523 c⁄° 
öode_›î©i⁄s
 
	gpxt4_fûe_öode_›î©i⁄s
 = {

524 .
£èâr
 = 
pxt4_£èâr
,

525 .
	ggë©å
 = 
pxt4_fûe_gë©å
,

526 .
	gli°x©å
 = 
pxt4_li°x©å
,

527 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

528 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

529 .
	gfõm≠
 = 
pxt4_fõm≠
,

	@filemap.c

12 
	~<löux/exp‹t.h
>

13 
	~<löux/compûî.h
>

14 
	~<löux/dax.h
>

15 
	~<löux/fs.h
>

16 
	~<löux/sched/sig«l.h
>

17 
	~<löux/uac˚ss.h
>

18 
	~<löux/ˇ∑bûôy.h
>

19 
	~<löux/kî√l_°©.h
>

20 
	~<löux/gÂ.h
>

21 
	~<löux/mm.h
>

22 
	~<löux/sw≠.h
>

23 
	~<löux/mm™.h
>

24 
	~<löux/∑gem≠.h
>

25 
	~<löux/fûe.h
>

26 
	~<löux/uio.h
>

27 
	~<löux/hash.h
>

28 
	~<löux/wrôeback.h
>

29 
	~<löux/backög-dev.h
>

30 
	~<löux/∑gevec.h
>

31 
	~<löux/blkdev.h
>

32 
	~<löux/£curôy.h
>

33 
	~<löux/˝u£t.h
>

34 
	~<löux/hugëlb.h
>

35 
	~<löux/memc⁄åﬁ.h
>

36 
	~<löux/˛ónˇche.h
>

37 
	~<löux/shmem_fs.h
>

38 
	~<löux/rm≠.h
>

39 
	~<löux/dñayac˘.h
>

40 
	~<löux/psi.h
>

41 
	~"öã∫Æ.h
"

43 
	#CREATE_TRACE_POINTS


	)

44 
	~<åa˚/evíts/fûem≠.h
>

49 
	~<löux/buf„r_hód.h
>

51 
	~<asm/mm™.h
>

118 
	$∑ge_ˇche_dñëe
(
addªss_•a˚
 *
m≠pög
,

119 
∑ge
 *∑ge, *
shadow
)

121 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
∑ge
->
ödex
);

122 
ƒ
 = 1;

124 
	`m≠pög_£t_upd©e
(&
xas
, 
m≠pög
);

127 i‡(!
	`PageHuge
(
∑ge
)) {

128 
	`xas_£t_‹dî
(&
xas
, 
∑ge
->
ödex
, 
	`compound_‹dî
(page));

129 
ƒ
 = 1U << 
	`compound_‹dî
(
∑ge
);

132 
	`VM_BUG_ON_PAGE
(!
	`PageLocked
(
∑ge
),Öage);

133 
	`VM_BUG_ON_PAGE
(
	`PageTaû
(
∑ge
),Öage);

134 
	`VM_BUG_ON_PAGE
(
ƒ
 !1 && 
shadow
, 
∑ge
);

136 
	`xas_°‹e
(&
xas
, 
shadow
);

137 
	`xas_öô_m¨ks
(&
xas
);

139 
∑ge
->
m≠pög
 = 
NULL
;

142 i‡(
shadow
) {

143 
m≠pög
->
ƒex˚±i⁄Æ
 +
ƒ
;

150 
	`smp_wmb
();

152 
m≠pög
->
ƒ∑ges
 -
ƒ
;

153 
	}
}

155 
	$u«ccou¡_∑ge_ˇche_∑ge
(
addªss_•a˚
 *
m≠pög
,

156 
∑ge
 *page)

158 
ƒ
;

165 i‡(
	`PageU±od©e
(
∑ge
Ë&& 
	`PageM≠≥dToDisk
(page))

166 
	`˛ónˇche_put_∑ge
(
∑ge
);

168 
	`˛ónˇche_övÆid©e_∑ge
(
m≠pög
, 
∑ge
);

170 
	`VM_BUG_ON_PAGE
(
	`PageTaû
(
∑ge
),Öage);

171 
	`VM_BUG_ON_PAGE
(
	`∑ge_m≠≥d
(
∑ge
),Öage);

172 i‡(!
	`IS_ENABLED
(
CONFIG_DEBUG_VM
Ë&& 
	`u∆ikñy
(
	`∑ge_m≠≥d
(
∑ge
))) {

173 
m≠cou¡
;

175 
	`¥_Æît
("BUG: BadÖage cache inÖrocess %sÖfn:%05lx\n",

176 
cuºít
->
comm
, 
	`∑ge_to_p‚
(
∑ge
));

177 
	`dump_∑ge
(
∑ge
, "still mapped when deleted");

178 
	`dump_°ack
();

179 
	`add_èöt
(
TAINT_BAD_PAGE
, 
LOCKDEP_NOW_UNRELIABLE
);

181 
m≠cou¡
 = 
	`∑ge_m≠cou¡
(
∑ge
);

182 i‡(
	`m≠pög_exôög
(
m≠pög
) &&

183 
	`∑ge_cou¡
(
∑ge
Ë>
m≠cou¡
 + 2) {

190 
	`∑ge_m≠cou¡_ª£t
(
∑ge
);

191 
	`∑ge_ªf_sub
(
∑ge
, 
m≠cou¡
);

196 i‡(
	`PageHuge
(
∑ge
))

199 
ƒ
 = 
	`h∑ge_ƒ_∑ges
(
∑ge
);

201 
	`__mod_node_∑ge_°©e
(
	`∑ge_pgd©
(
∑ge
), 
NR_FILE_PAGES
, -
ƒ
);

202 i‡(
	`PageSw≠Backed
(
∑ge
)) {

203 
	`__mod_node_∑ge_°©e
(
	`∑ge_pgd©
(
∑ge
), 
NR_SHMEM
, -
ƒ
);

204 i‡(
	`PageTønsHuge
(
∑ge
))

205 
	`__dec_node_∑ge_°©e
(
∑ge
, 
NR_SHMEM_THPS
);

207 
	`VM_BUG_ON_PAGE
(
	`PageTønsHuge
(
∑ge
),Öage);

220 i‡(
	`WARN_ON_ONCE
(
	`PageDúty
(
∑ge
)))

221 
	`accou¡_∑ge_˛ó√d
(
∑ge
, 
m≠pög
, 
	`öode_to_wb
(m≠pög->
ho°
));

222 
	}
}

229 
	$__dñëe_‰om_∑ge_ˇche
(
∑ge
 *∑ge, *
shadow
)

231 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

233 
	`åa˚_mm_fûem≠_dñëe_‰om_∑ge_ˇche
(
∑ge
);

235 
	`u«ccou¡_∑ge_ˇche_∑ge
(
m≠pög
, 
∑ge
);

236 
	`∑ge_ˇche_dñëe
(
m≠pög
, 
∑ge
, 
shadow
);

237 
	}
}

239 
	$∑ge_ˇche_‰ì_∑ge
(
addªss_•a˚
 *
m≠pög
,

240 
∑ge
 *page)

242 (*
‰ì∑ge
)(
∑ge
 *);

244 
‰ì∑ge
 = 
m≠pög
->
a_›s
->freepage;

245 i‡(
‰ì∑ge
)

246 
	`‰ì∑ge
(
∑ge
);

248 i‡(
	`PageTønsHuge
(
∑ge
Ë&& !
	`PageHuge
(page)) {

249 
	`∑ge_ªf_sub
(
∑ge
, 
HPAGE_PMD_NR
);

250 
	`VM_BUG_ON_PAGE
(
	`∑ge_cou¡
(
∑ge
) <= 0,Öage);

252 
	`put_∑ge
(
∑ge
);

254 
	}
}

264 
	$dñëe_‰om_∑ge_ˇche
(
∑ge
 *page)

266 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

267 
Êags
;

269 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

270 
	`xa_lock_úqßve
(&
m≠pög
->
i_∑ges
, 
Êags
);

271 
	`__dñëe_‰om_∑ge_ˇche
(
∑ge
, 
NULL
);

272 
	`xa_u∆ock_úqª°‹e
(&
m≠pög
->
i_∑ges
, 
Êags
);

274 
	`∑ge_ˇche_‰ì_∑ge
(
m≠pög
, 
∑ge
);

275 
	}
}

292 
	$∑ge_ˇche_dñëe_b©ch
(
addªss_•a˚
 *
m≠pög
,

293 
∑gevec
 *
pvec
)

295 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
pvec
->
∑ges
[0]->
ödex
);

296 
tŸÆ_∑ges
 = 0;

297 
i
 = 0, 
èû_∑ges
 = 0;

298 
∑ge
 *page;

300 
	`m≠pög_£t_upd©e
(&
xas
, 
m≠pög
);

301 
	`xas_f‹_óch
(&
xas
, 
∑ge
, 
ULONG_MAX
) {

302 i‡(
i
 >
	`∑gevec_cou¡
(
pvec
Ë&& !
èû_∑ges
)

304 i‡(
	`xa_is_vÆue
(
∑ge
))

306 i‡(!
èû_∑ges
) {

312 i‡(
∑ge
 !
pvec
->
∑ges
[
i
]) {

313 
	`VM_BUG_ON_PAGE
(
∑ge
->
ödex
 >

314 
pvec
->
∑ges
[
i
]->
ödex
, 
∑ge
);

317 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
));

318 i‡(
	`PageTønsHuge
(
∑ge
Ë&& !
	`PageHuge
(page))

319 
èû_∑ges
 = 
HPAGE_PMD_NR
 - 1;

320 
∑ge
->
m≠pög
 = 
NULL
;

325 
i
++;

327 
	`VM_BUG_ON_PAGE
(
∑ge
->
ödex
 + 
HPAGE_PMD_NR
 - 
èû_∑ges


328 !
pvec
->
∑ges
[
i
]->
ödex
, 
∑ge
);

329 
èû_∑ges
--;

331 
	`xas_°‹e
(&
xas
, 
NULL
);

332 
tŸÆ_∑ges
++;

334 
m≠pög
->
ƒ∑ges
 -
tŸÆ_∑ges
;

335 
	}
}

337 
	$dñëe_‰om_∑ge_ˇche_b©ch
(
addªss_•a˚
 *
m≠pög
,

338 
∑gevec
 *
pvec
)

340 
i
;

341 
Êags
;

343 i‡(!
	`∑gevec_cou¡
(
pvec
))

346 
	`xa_lock_úqßve
(&
m≠pög
->
i_∑ges
, 
Êags
);

347 
i
 = 0; i < 
	`∑gevec_cou¡
(
pvec
); i++) {

348 
	`åa˚_mm_fûem≠_dñëe_‰om_∑ge_ˇche
(
pvec
->
∑ges
[
i
]);

350 
	`u«ccou¡_∑ge_ˇche_∑ge
(
m≠pög
, 
pvec
->
∑ges
[
i
]);

352 
	`∑ge_ˇche_dñëe_b©ch
(
m≠pög
, 
pvec
);

353 
	`xa_u∆ock_úqª°‹e
(&
m≠pög
->
i_∑ges
, 
Êags
);

355 
i
 = 0; i < 
	`∑gevec_cou¡
(
pvec
); i++)

356 
	`∑ge_ˇche_‰ì_∑ge
(
m≠pög
, 
pvec
->
∑ges
[
i
]);

357 
	}
}

359 
	$fûem≠_check_îr‹s
(
addªss_•a˚
 *
m≠pög
)

361 
ªt
 = 0;

363 i‡(
	`ã°_bô
(
AS_ENOSPC
, &
m≠pög
->
Êags
) &&

364 
	`ã°_™d_˛ór_bô
(
AS_ENOSPC
, &
m≠pög
->
Êags
))

365 
ªt
 = -
ENOSPC
;

366 i‡(
	`ã°_bô
(
AS_EIO
, &
m≠pög
->
Êags
) &&

367 
	`ã°_™d_˛ór_bô
(
AS_EIO
, &
m≠pög
->
Êags
))

368 
ªt
 = -
EIO
;

369  
ªt
;

370 
	}
}

373 
	$fûem≠_check_™d_kìp_îr‹s
(
addªss_•a˚
 *
m≠pög
)

376 i‡(
	`ã°_bô
(
AS_EIO
, &
m≠pög
->
Êags
))

377  -
EIO
;

378 i‡(
	`ã°_bô
(
AS_ENOSPC
, &
m≠pög
->
Êags
))

379  -
ENOSPC
;

381 
	}
}

400 
	$__fûem≠_fd©awrôe_ønge
(
addªss_•a˚
 *
m≠pög
, 
loff_t
 
°¨t
,

401 
loff_t
 
íd
, 
sync_mode
)

403 
ªt
;

404 
wrôeback_c⁄åﬁ
 
wbc
 = {

405 .
sync_mode
 = sync_mode,

406 .
ƒ_to_wrôe
 = 
LONG_MAX
,

407 .
ønge_°¨t
 = 
°¨t
,

408 .
ønge_íd
 = 
íd
,

411 i‡(!
	`m≠pög_ˇp_wrôeback_dúty
(
m≠pög
))

414 
	`wbc_©èch_fd©awrôe_öode
(&
wbc
, 
m≠pög
->
ho°
);

415 
ªt
 = 
	`do_wrôïages
(
m≠pög
, &
wbc
);

416 
	`wbc_dëach_öode
(&
wbc
);

417  
ªt
;

418 
	}
}

420 
ölöe
 
	$__fûem≠_fd©awrôe
(
addªss_•a˚
 *
m≠pög
,

421 
sync_mode
)

423  
	`__fûem≠_fd©awrôe_ønge
(
m≠pög
, 0, 
LLONG_MAX
, 
sync_mode
);

424 
	}
}

426 
	$fûem≠_fd©awrôe
(
addªss_•a˚
 *
m≠pög
)

428  
	`__fûem≠_fd©awrôe
(
m≠pög
, 
WB_SYNC_ALL
);

429 
	}
}

432 
	$fûem≠_fd©awrôe_ønge
(
addªss_•a˚
 *
m≠pög
, 
loff_t
 
°¨t
,

433 
loff_t
 
íd
)

435  
	`__fûem≠_fd©awrôe_ønge
(
m≠pög
, 
°¨t
, 
íd
, 
WB_SYNC_ALL
);

436 
	}
}

448 
	$fûem≠_Êush
(
addªss_•a˚
 *
m≠pög
)

450  
	`__fûem≠_fd©awrôe
(
m≠pög
, 
WB_SYNC_NONE
);

451 
	}
}

466 
boﬁ
 
	$fûem≠_ønge_has_∑ge
(
addªss_•a˚
 *
m≠pög
,

467 
loff_t
 
°¨t_byã
,Üoff_à
íd_byã
)

469 
∑ge
 *page;

470 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t_byã
 >> 
PAGE_SHIFT
);

471 
pgoff_t
 
max
 = 
íd_byã
 >> 
PAGE_SHIFT
;

473 i‡(
íd_byã
 < 
°¨t_byã
)

474  
Ál£
;

476 
	`rcu_ªad_lock
();

478 
∑ge
 = 
	`xas_föd
(&
xas
, 
max
);

479 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

482 i‡(
	`xa_is_vÆue
(
∑ge
))

491 
	`rcu_ªad_u∆ock
();

493  
∑ge
 !
NULL
;

494 
	}
}

497 
	$__fûem≠_fd©awaô_ønge
(
addªss_•a˚
 *
m≠pög
,

498 
loff_t
 
°¨t_byã
,Üoff_à
íd_byã
)

500 
pgoff_t
 
ödex
 = 
°¨t_byã
 >> 
PAGE_SHIFT
;

501 
pgoff_t
 
íd
 = 
íd_byã
 >> 
PAGE_SHIFT
;

502 
∑gevec
 
pvec
;

503 
ƒ_∑ges
;

505 i‡(
íd_byã
 < 
°¨t_byã
)

508 
	`∑gevec_öô
(&
pvec
);

509 
ödex
 <
íd
) {

510 
i
;

512 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
,

513 
íd
, 
PAGECACHE_TAG_WRITEBACK
);

514 i‡(!
ƒ_∑ges
)

517 
i
 = 0; i < 
ƒ_∑ges
; i++) {

518 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

520 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

521 
	`CÀ¨PageEº‹
(
∑ge
);

523 
	`∑gevec_ªÀa£
(&
pvec
);

524 
	`c⁄d_ªsched
();

526 
	}
}

544 
	$fûem≠_fd©awaô_ønge
(
addªss_•a˚
 *
m≠pög
, 
loff_t
 
°¨t_byã
,

545 
loff_t
 
íd_byã
)

547 
	`__fûem≠_fd©awaô_ønge
(
m≠pög
, 
°¨t_byã
, 
íd_byã
);

548  
	`fûem≠_check_îr‹s
(
m≠pög
);

549 
	}
}

568 
	$fûe_fd©awaô_ønge
(
fûe
 *fûe, 
loff_t
 
°¨t_byã
,Üoff_à
íd_byã
)

570 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

572 
	`__fûem≠_fd©awaô_ønge
(
m≠pög
, 
°¨t_byã
, 
íd_byã
);

573  
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

574 
	}
}

591 
	$fûem≠_fd©awaô_kìp_îr‹s
(
addªss_•a˚
 *
m≠pög
)

593 
	`__fûem≠_fd©awaô_ønge
(
m≠pög
, 0, 
LLONG_MAX
);

594  
	`fûem≠_check_™d_kìp_îr‹s
(
m≠pög
);

595 
	}
}

598 
boﬁ
 
	$m≠pög_√eds_wrôeback
(
addªss_•a˚
 *
m≠pög
)

600  (!
	`dax_m≠pög
(
m≠pög
Ë&& m≠pög->
ƒ∑ges
) ||

601 (
	`dax_m≠pög
(
m≠pög
Ë&& m≠pög->
ƒex˚±i⁄Æ
);

602 
	}
}

604 
	$fûem≠_wrôe_™d_waô
(
addªss_•a˚
 *
m≠pög
)

606 
îr
 = 0;

608 i‡(
	`m≠pög_√eds_wrôeback
(
m≠pög
)) {

609 
îr
 = 
	`fûem≠_fd©awrôe
(
m≠pög
);

616 i‡(
îr
 !-
EIO
) {

617 
îr2
 = 
	`fûem≠_fd©awaô
(
m≠pög
);

618 i‡(!
îr
)

619 
îr
 = 
îr2
;

622 
	`fûem≠_check_îr‹s
(
m≠pög
);

625 
îr
 = 
	`fûem≠_check_îr‹s
(
m≠pög
);

627  
îr
;

628 
	}
}

644 
	$fûem≠_wrôe_™d_waô_ønge
(
addªss_•a˚
 *
m≠pög
,

645 
loff_t
 
l°¨t
,Üoff_à
Ànd
)

647 
îr
 = 0;

649 i‡(
	`m≠pög_√eds_wrôeback
(
m≠pög
)) {

650 
îr
 = 
	`__fûem≠_fd©awrôe_ønge
(
m≠pög
, 
l°¨t
, 
Ànd
,

651 
WB_SYNC_ALL
);

653 i‡(
îr
 !-
EIO
) {

654 
îr2
 = 
	`fûem≠_fd©awaô_ønge
(
m≠pög
,

655 
l°¨t
, 
Ànd
);

656 i‡(!
îr
)

657 
îr
 = 
îr2
;

660 
	`fûem≠_check_îr‹s
(
m≠pög
);

663 
îr
 = 
	`fûem≠_check_îr‹s
(
m≠pög
);

665  
îr
;

666 
	}
}

669 
	$__fûem≠_£t_wb_îr
(
addªss_•a˚
 *
m≠pög
, 
îr
)

671 
îr£q_t
 
e£q
 = 
	`îr£q_£t
(&
m≠pög
->
wb_îr
, 
îr
);

673 
	`åa˚_fûem≠_£t_wb_îr
(
m≠pög
, 
e£q
);

674 
	}
}

701 
	$fûe_check_™d_adv™˚_wb_îr
(
fûe
 *file)

703 
îr
 = 0;

704 
îr£q_t
 
ﬁd
 = 
	`READ_ONCE
(
fûe
->
f_wb_îr
);

705 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

708 i‡(
	`îr£q_check
(&
m≠pög
->
wb_îr
, 
ﬁd
)) {

710 
	`•ö_lock
(&
fûe
->
f_lock
);

711 
ﬁd
 = 
fûe
->
f_wb_îr
;

712 
îr
 = 
	`îr£q_check_™d_adv™˚
(&
m≠pög
->
wb_îr
,

713 &
fûe
->
f_wb_îr
);

714 
	`åa˚_fûe_check_™d_adv™˚_wb_îr
(
fûe
, 
ﬁd
);

715 
	`•ö_u∆ock
(&
fûe
->
f_lock
);

723 
	`˛ór_bô
(
AS_EIO
, &
m≠pög
->
Êags
);

724 
	`˛ór_bô
(
AS_ENOSPC
, &
m≠pög
->
Êags
);

725  
îr
;

726 
	}
}

745 
	$fûe_wrôe_™d_waô_ønge
(
fûe
 *fûe, 
loff_t
 
l°¨t
,Üoff_à
Ànd
)

747 
îr
 = 0, 
îr2
;

748 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

750 i‡(
	`m≠pög_√eds_wrôeback
(
m≠pög
)) {

751 
îr
 = 
	`__fûem≠_fd©awrôe_ønge
(
m≠pög
, 
l°¨t
, 
Ànd
,

752 
WB_SYNC_ALL
);

754 i‡(
îr
 !-
EIO
)

755 
	`__fûem≠_fd©awaô_ønge
(
m≠pög
, 
l°¨t
, 
Ànd
);

757 
îr2
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

758 i‡(!
îr
)

759 
îr
 = 
îr2
;

760  
îr
;

761 
	}
}

780 
	$ª∂a˚_∑ge_ˇche_∑ge
(
∑ge
 *
ﬁd
, ∑gê*
√w
, 
gÂ_t
 
gÂ_mask
)

782 
addªss_•a˚
 *
m≠pög
 = 
ﬁd
->mapping;

783 (*
‰ì∑ge
)(
∑ge
 *Ë
m≠pög
->
a_›s
->freepage;

784 
pgoff_t
 
off£t
 = 
ﬁd
->
ödex
;

785 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
off£t
);

786 
Êags
;

788 
	`VM_BUG_ON_PAGE
(!
	`PageLocked
(
ﬁd
), old);

789 
	`VM_BUG_ON_PAGE
(!
	`PageLocked
(
√w
),Çew);

790 
	`VM_BUG_ON_PAGE
(
√w
->
m≠pög
,Çew);

792 
	`gë_∑ge
(
√w
);

793 
√w
->
m≠pög
 = mapping;

794 
√w
->
ödex
 = 
off£t
;

796 
	`xas_lock_úqßve
(&
xas
, 
Êags
);

797 
	`xas_°‹e
(&
xas
, 
√w
);

799 
ﬁd
->
m≠pög
 = 
NULL
;

801 i‡(!
	`PageHuge
(
ﬁd
))

802 
	`__dec_node_∑ge_°©e
(
√w
, 
NR_FILE_PAGES
);

803 i‡(!
	`PageHuge
(
√w
))

804 
	`__öc_node_∑ge_°©e
(
√w
, 
NR_FILE_PAGES
);

805 i‡(
	`PageSw≠Backed
(
ﬁd
))

806 
	`__dec_node_∑ge_°©e
(
√w
, 
NR_SHMEM
);

807 i‡(
	`PageSw≠Backed
(
√w
))

808 
	`__öc_node_∑ge_°©e
(
√w
, 
NR_SHMEM
);

809 
	`xas_u∆ock_úqª°‹e
(&
xas
, 
Êags
);

810 
	`mem_cgroup_migøã
(
ﬁd
, 
√w
);

811 i‡(
‰ì∑ge
)

812 
	`‰ì∑ge
(
ﬁd
);

813 
	`put_∑ge
(
ﬁd
);

816 
	}
}

819 
	$__add_to_∑ge_ˇche_locked
(
∑ge
 *page,

820 
addªss_•a˚
 *
m≠pög
,

821 
pgoff_t
 
off£t
, 
gÂ_t
 
gÂ_mask
,

822 **
shadowp
)

824 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
off£t
);

825 
huge
 = 
	`PageHuge
(
∑ge
);

826 
mem_cgroup
 *
memcg
;

827 
îr‹
;

828 *
ﬁd
;

830 
	`VM_BUG_ON_PAGE
(!
	`PageLocked
(
∑ge
),Öage);

831 
	`VM_BUG_ON_PAGE
(
	`PageSw≠Backed
(
∑ge
),Öage);

832 
	`m≠pög_£t_upd©e
(&
xas
, 
m≠pög
);

834 i‡(!
huge
) {

835 
îr‹
 = 
	`mem_cgroup_åy_ch¨ge
(
∑ge
, 
cuºít
->
mm
,

836 
gÂ_mask
, &
memcg
, 
Ál£
);

837 i‡(
îr‹
)

838  
îr‹
;

841 
	`gë_∑ge
(
∑ge
);

842 
∑ge
->
m≠pög
 = mapping;

843 
∑ge
->
ödex
 = 
off£t
;

846 
	`xas_lock_úq
(&
xas
);

847 
ﬁd
 = 
	`xas_lﬂd
(&
xas
);

848 i‡(
ﬁd
 && !
	`xa_is_vÆue
(old))

849 
	`xas_£t_îr
(&
xas
, -
EEXIST
);

850 
	`xas_°‹e
(&
xas
, 
∑ge
);

851 i‡(
	`xas_îr‹
(&
xas
))

852 
u∆ock
;

854 i‡(
	`xa_is_vÆue
(
ﬁd
)) {

855 
m≠pög
->
ƒex˚±i⁄Æ
--;

856 i‡(
shadowp
)

857 *
shadowp
 = 
ﬁd
;

859 
m≠pög
->
ƒ∑ges
++;

862 i‡(!
huge
)

863 
	`__öc_node_∑ge_°©e
(
∑ge
, 
NR_FILE_PAGES
);

864 
u∆ock
:

865 
	`xas_u∆ock_úq
(&
xas
);

866 } 
	`xas_nomem
(&
xas
, 
gÂ_mask
 & 
GFP_RECLAIM_MASK
));

868 i‡(
	`xas_îr‹
(&
xas
))

869 
îr‹
;

871 i‡(!
huge
)

872 
	`mem_cgroup_commô_ch¨ge
(
∑ge
, 
memcg
, 
Ál£
, false);

873 
	`åa˚_mm_fûem≠_add_to_∑ge_ˇche
(
∑ge
);

875 
îr‹
:

876 
∑ge
->
m≠pög
 = 
NULL
;

878 i‡(!
huge
)

879 
	`mem_cgroup_ˇn˚l_ch¨ge
(
∑ge
, 
memcg
, 
Ál£
);

880 
	`put_∑ge
(
∑ge
);

881  
	`xas_îr‹
(&
xas
);

882 
	}
}

896 
	$add_to_∑ge_ˇche_locked
(
∑ge
 *∑ge, 
addªss_•a˚
 *
m≠pög
,

897 
pgoff_t
 
off£t
, 
gÂ_t
 
gÂ_mask
)

899  
	`__add_to_∑ge_ˇche_locked
(
∑ge
, 
m≠pög
, 
off£t
,

900 
gÂ_mask
, 
NULL
);

901 
	}
}

904 
	$add_to_∑ge_ˇche_Ãu
(
∑ge
 *∑ge, 
addªss_•a˚
 *
m≠pög
,

905 
pgoff_t
 
off£t
, 
gÂ_t
 
gÂ_mask
)

907 *
shadow
 = 
NULL
;

908 
ªt
;

910 
	`__SëPageLocked
(
∑ge
);

911 
ªt
 = 
	`__add_to_∑ge_ˇche_locked
(
∑ge
, 
m≠pög
, 
off£t
,

912 
gÂ_mask
, &
shadow
);

913 i‡(
	`u∆ikñy
(
ªt
))

914 
	`__CÀ¨PageLocked
(
∑ge
);

924 
	`WARN_ON_ONCE
(
	`PageA˘ive
(
∑ge
));

925 i‡(!(
gÂ_mask
 & 
__GFP_WRITE
Ë&& 
shadow
)

926 
	`w‹kög£t_ªÁu…
(
∑ge
, 
shadow
);

927 
	`Ãu_ˇche_add
(
∑ge
);

929  
ªt
;

930 
	}
}

933 #ifde‡
CONFIG_NUMA


934 
∑ge
 *
	$__∑ge_ˇche_Æloc
(
gÂ_t
 
gÂ
)

936 
n
;

937 
∑ge
 *page;

939 i‡(
	`˝u£t_do_∑ge_mem_•ªad
()) {

940 
˝u£t_mems_cookõ
;

942 
˝u£t_mems_cookõ
 = 
	`ªad_mems_Ælowed_begö
();

943 
n
 = 
	`˝u£t_mem_•ªad_node
();

944 
∑ge
 = 
	`__Æloc_∑ges_node
(
n
, 
gÂ
, 0);

945 } !
∑ge
 && 
	`ªad_mems_Ælowed_ªåy
(
˝u£t_mems_cookõ
));

947  
∑ge
;

949  
	`Æloc_∑ges
(
gÂ
, 0);

950 
	}
}

964 
	#PAGE_WAIT_TABLE_BITS
 8

	)

965 
	#PAGE_WAIT_TABLE_SIZE
 (1 << 
PAGE_WAIT_TABLE_BITS
)

	)

966 
waô_queue_hód_t
 
	g∑ge_waô_èbÀ
[
PAGE_WAIT_TABLE_SIZE
] 
	g__ˇchñöe_Æig√d
;

968 
waô_queue_hód_t
 *
	$∑ge_waôqueue
(
∑ge
 *page)

970  &
∑ge_waô_èbÀ
[
	`hash_±r
(
∑ge
, 
PAGE_WAIT_TABLE_BITS
)];

971 
	}
}

973 
__öô
 
	$∑geˇche_öô
()

975 
i
;

977 
i
 = 0; i < 
PAGE_WAIT_TABLE_SIZE
; i++)

978 
	`öô_waôqueue_hód
(&
∑ge_waô_èbÀ
[
i
]);

980 
	`∑ge_wrôeback_öô
();

981 
	}
}

984 
	swaô_∑ge_key
 {

985 
∑ge
 *
	m∑ge
;

986 
	mbô_ƒ
;

987 
	m∑ge_m©ch
;

990 
	swaô_∑ge_queue
 {

991 
∑ge
 *
	m∑ge
;

992 
	mbô_ƒ
;

993 
waô_queue_íåy_t
 
	mwaô
;

996 
	$wake_∑ge_fun˘i⁄
(
waô_queue_íåy_t
 *
waô
, 
mode
, 
sync
, *
¨g
)

998 
waô_∑ge_key
 *
key
 = 
¨g
;

999 
waô_∑ge_queue
 *
waô_∑ge


1000 
	`c⁄èöî_of
(
waô
, 
waô_∑ge_queue
, wait);

1002 i‡(
waô_∑ge
->
∑ge
 !
key
->page)

1004 
key
->
∑ge_m©ch
 = 1;

1006 i‡(
waô_∑ge
->
bô_ƒ
 !
key
->bit_nr)

1017 i‡(
	`ã°_bô
(
key
->
bô_ƒ
, &key->
∑ge
->
Êags
))

1020  
	`aut‹emove_wake_fun˘i⁄
(
waô
, 
mode
, 
sync
, 
key
);

1021 
	}
}

1023 
	$wake_up_∑ge_bô
(
∑ge
 *∑ge, 
bô_ƒ
)

1025 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1026 
waô_∑ge_key
 
key
;

1027 
Êags
;

1028 
waô_queue_íåy_t
 
bookm¨k
;

1030 
key
.
∑ge
 =Öage;

1031 
key
.
bô_ƒ
 = bit_nr;

1032 
key
.
∑ge_m©ch
 = 0;

1034 
bookm¨k
.
Êags
 = 0;

1035 
bookm¨k
.
¥iv©e
 = 
NULL
;

1036 
bookm¨k
.
func
 = 
NULL
;

1037 
	`INIT_LIST_HEAD
(&
bookm¨k
.
íåy
);

1039 
	`•ö_lock_úqßve
(&
q
->
lock
, 
Êags
);

1040 
	`__wake_up_locked_key_bookm¨k
(
q
, 
TASK_NORMAL
, &
key
, &
bookm¨k
);

1042 
bookm¨k
.
Êags
 & 
WQ_FLAG_BOOKMARK
) {

1049 
	`•ö_u∆ock_úqª°‹e
(&
q
->
lock
, 
Êags
);

1050 
	`˝u_ªœx
();

1051 
	`•ö_lock_úqßve
(&
q
->
lock
, 
Êags
);

1052 
	`__wake_up_locked_key_bookm¨k
(
q
, 
TASK_NORMAL
, &
key
, &
bookm¨k
);

1064 i‡(!
	`waôqueue_a˘ive
(
q
Ë|| !
key
.
∑ge_m©ch
) {

1065 
	`CÀ¨PageWaôîs
(
∑ge
);

1074 
	`•ö_u∆ock_úqª°‹e
(&
q
->
lock
, 
Êags
);

1075 
	}
}

1077 
	$wake_up_∑ge
(
∑ge
 *∑ge, 
bô
)

1079 i‡(!
	`PageWaôîs
(
∑ge
))

1081 
	`wake_up_∑ge_bô
(
∑ge
, 
bô
);

1082 
	}
}

1087 
	ebehavi‹
 {

1088 
	mEXCLUSIVE
,

1091 
	mSHARED
,

1094 
	mDROP
,

1099 
ölöe
 
	$waô_⁄_∑ge_bô_comm⁄
(
waô_queue_hód_t
 *
q
,

1100 
∑ge
 *∑ge, 
bô_ƒ
, 
°©e
, 
behavi‹
 behavior)

1102 
waô_∑ge_queue
 
waô_∑ge
;

1103 
waô_queue_íåy_t
 *
waô
 = &
waô_∑ge
.wait;

1104 
boﬁ
 
bô_is_£t
;

1105 
boﬁ
 
thøshög
 = 
Ál£
;

1106 
boﬁ
 
dñayac˘
 = 
Ál£
;

1107 
pÊags
;

1108 
ªt
 = 0;

1110 i‡(
bô_ƒ
 =
PG_locked
 &&

1111 !
	`PageU±od©e
(
∑ge
Ë&& 
	`PageW‹kög£t
(page)) {

1112 i‡(!
	`PageSw≠Backed
(
∑ge
)) {

1113 
	`dñayac˘_thøshög_°¨t
();

1114 
dñayac˘
 = 
åue
;

1116 
	`psi_mem°Æl_íãr
(&
pÊags
);

1117 
thøshög
 = 
åue
;

1120 
	`öô_waô
(
waô
);

1121 
waô
->
Êags
 = 
behavi‹
 =
EXCLUSIVE
 ? 
WQ_FLAG_EXCLUSIVE
 : 0;

1122 
waô
->
func
 = 
wake_∑ge_fun˘i⁄
;

1123 
waô_∑ge
.
∑ge
 =Öage;

1124 
waô_∑ge
.
bô_ƒ
 = bit_nr;

1127 
	`•ö_lock_úq
(&
q
->
lock
);

1129 i‡(
	`likñy
(
	`li°_em±y
(&
waô
->
íåy
))) {

1130 
	`__add_waô_queue_íåy_èû
(
q
, 
waô
);

1131 
	`SëPageWaôîs
(
∑ge
);

1134 
	`£t_cuºít_°©e
(
°©e
);

1136 
	`•ö_u∆ock_úq
(&
q
->
lock
);

1138 
bô_is_£t
 = 
	`ã°_bô
(
bô_ƒ
, &
∑ge
->
Êags
);

1139 i‡(
behavi‹
 =
DROP
)

1140 
	`put_∑ge
(
∑ge
);

1142 i‡(
	`likñy
(
bô_is_£t
))

1143 
	`io_scheduÀ
();

1145 i‡(
behavi‹
 =
EXCLUSIVE
) {

1146 i‡(!
	`ã°_™d_£t_bô_lock
(
bô_ƒ
, &
∑ge
->
Êags
))

1148 } i‡(
behavi‹
 =
SHARED
) {

1149 i‡(!
	`ã°_bô
(
bô_ƒ
, &
∑ge
->
Êags
))

1153 i‡(
	`sig«l_≥ndög_°©e
(
°©e
, 
cuºít
)) {

1154 
ªt
 = -
EINTR
;

1158 i‡(
behavi‹
 =
DROP
) {

1170 
	`föish_waô
(
q
, 
waô
);

1172 i‡(
thøshög
) {

1173 i‡(
dñayac˘
)

1174 
	`dñayac˘_thøshög_íd
();

1175 
	`psi_mem°Æl_Àave
(&
pÊags
);

1186  
ªt
;

1187 
	}
}

1189 
	$waô_⁄_∑ge_bô
(
∑ge
 *∑ge, 
bô_ƒ
)

1191 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1192 
	`waô_⁄_∑ge_bô_comm⁄
(
q
, 
∑ge
, 
bô_ƒ
, 
TASK_UNINTERRUPTIBLE
, 
SHARED
);

1193 
	}
}

1196 
	$waô_⁄_∑ge_bô_kûœbÀ
(
∑ge
 *∑ge, 
bô_ƒ
)

1198 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1199  
	`waô_⁄_∑ge_bô_comm⁄
(
q
, 
∑ge
, 
bô_ƒ
, 
TASK_KILLABLE
, 
SHARED
);

1200 
	}
}

1213 
	$put_™d_waô_⁄_∑ge_locked
(
∑ge
 *page)

1215 
waô_queue_hód_t
 *
q
;

1217 
∑ge
 = 
	`compound_hód
(page);

1218 
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1219 
	`waô_⁄_∑ge_bô_comm⁄
(
q
, 
∑ge
, 
PG_locked
, 
TASK_UNINTERRUPTIBLE
, 
DROP
);

1220 
	}
}

1229 
	$add_∑ge_waô_queue
(
∑ge
 *∑ge, 
waô_queue_íåy_t
 *
waôî
)

1231 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1232 
Êags
;

1234 
	`•ö_lock_úqßve
(&
q
->
lock
, 
Êags
);

1235 
	`__add_waô_queue_íåy_èû
(
q
, 
waôî
);

1236 
	`SëPageWaôîs
(
∑ge
);

1237 
	`•ö_u∆ock_úqª°‹e
(&
q
->
lock
, 
Êags
);

1238 
	}
}

1241 #i‚de‡
˛ór_bô_u∆ock_is_√g©ive_byã


1255 
ölöe
 
boﬁ
 
	$˛ór_bô_u∆ock_is_√g©ive_byã
(
ƒ
, vﬁ©ûê*
mem
)

1257 
	`˛ór_bô_u∆ock
(
ƒ
, 
mem
);

1259  
	`ã°_bô
(
PG_waôîs
, 
mem
);

1260 
	}
}

1279 
	$u∆ock_∑ge
(
∑ge
 *page)

1281 
	`BUILD_BUG_ON
(
PG_waôîs
 != 7);

1282 
∑ge
 = 
	`compound_hód
(page);

1283 
	`VM_BUG_ON_PAGE
(!
	`PageLocked
(
∑ge
),Öage);

1284 i‡(
	`˛ór_bô_u∆ock_is_√g©ive_byã
(
PG_locked
, &
∑ge
->
Êags
))

1285 
	`wake_up_∑ge_bô
(
∑ge
, 
PG_locked
);

1286 
	}
}

1293 
	$íd_∑ge_wrôeback
(
∑ge
 *page)

1302 i‡(
	`PageRe˛aim
(
∑ge
)) {

1303 
	`CÀ¨PageRe˛aim
(
∑ge
);

1304 
	`rŸ©e_ª˛aimabÀ_∑ge
(
∑ge
);

1307 i‡(!
	`ã°_˛ór_∑ge_wrôeback
(
∑ge
))

1308 
	`BUG
();

1310 
	`smp_mb__a·î_©omic
();

1311 
	`wake_up_∑ge
(
∑ge
, 
PG_wrôeback
);

1312 
	}
}

1319 
	$∑ge_ídio
(
∑ge
 *∑ge, 
boﬁ
 
is_wrôe
, 
îr
)

1321 i‡(!
is_wrôe
) {

1322 i‡(!
îr
) {

1323 
	`SëPageU±od©e
(
∑ge
);

1325 
	`CÀ¨PageU±od©e
(
∑ge
);

1326 
	`SëPageEº‹
(
∑ge
);

1328 
	`u∆ock_∑ge
(
∑ge
);

1330 i‡(
îr
) {

1331 
addªss_•a˚
 *
m≠pög
;

1333 
	`SëPageEº‹
(
∑ge
);

1334 
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

1335 i‡(
m≠pög
)

1336 
	`m≠pög_£t_îr‹
(
m≠pög
, 
îr
);

1338 
	`íd_∑ge_wrôeback
(
∑ge
);

1340 
	}
}

1347 
	$__lock_∑ge
(
∑ge
 *
__∑ge
)

1349 
∑ge
 *∑gê
	`compound_hód
(
__∑ge
);

1350 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1351 
	`waô_⁄_∑ge_bô_comm⁄
(
q
, 
∑ge
, 
PG_locked
, 
TASK_UNINTERRUPTIBLE
,

1352 
EXCLUSIVE
);

1353 
	}
}

1356 
	$__lock_∑ge_kûœbÀ
(
∑ge
 *
__∑ge
)

1358 
∑ge
 *∑gê
	`compound_hód
(
__∑ge
);

1359 
waô_queue_hód_t
 *
q
 = 
	`∑ge_waôqueue
(
∑ge
);

1360  
	`waô_⁄_∑ge_bô_comm⁄
(
q
, 
∑ge
, 
PG_locked
, 
TASK_KILLABLE
,

1361 
EXCLUSIVE
);

1362 
	}
}

1376 
	$__lock_∑ge_‹_ªåy
(
∑ge
 *∑ge, 
mm_°ru˘
 *
mm
,

1377 
Êags
)

1379 i‡(
Êags
 & 
FAULT_FLAG_ALLOW_RETRY
) {

1384 i‡(
Êags
 & 
FAULT_FLAG_RETRY_NOWAIT
)

1387 
	`up_ªad
(&
mm
->
mm≠_£m
);

1388 i‡(
Êags
 & 
FAULT_FLAG_KILLABLE
)

1389 
	`waô_⁄_∑ge_locked_kûœbÀ
(
∑ge
);

1391 
	`waô_⁄_∑ge_locked
(
∑ge
);

1394 i‡(
Êags
 & 
FAULT_FLAG_KILLABLE
) {

1395 
ªt
;

1397 
ªt
 = 
	`__lock_∑ge_kûœbÀ
(
∑ge
);

1398 i‡(
ªt
) {

1399 
	`up_ªad
(&
mm
->
mm≠_£m
);

1403 
	`__lock_∑ge
(
∑ge
);

1406 
	}
}

1427 
pgoff_t
 
	$∑ge_ˇche_√xt_miss
(
addªss_•a˚
 *
m≠pög
,

1428 
pgoff_t
 
ödex
, 
max_sˇn
)

1430 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
ödex
);

1432 
max_sˇn
--) {

1433 *
íåy
 = 
	`xas_√xt
(&
xas
);

1434 i‡(!
íåy
 || 
	`xa_is_vÆue
(entry))

1436 i‡(
xas
.
xa_ödex
 == 0)

1440  
xas
.
xa_ödex
;

1441 
	}
}

1463 
pgoff_t
 
	$∑ge_ˇche_¥ev_miss
(
addªss_•a˚
 *
m≠pög
,

1464 
pgoff_t
 
ödex
, 
max_sˇn
)

1466 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
ödex
);

1468 
max_sˇn
--) {

1469 *
íåy
 = 
	`xas_¥ev
(&
xas
);

1470 i‡(!
íåy
 || 
	`xa_is_vÆue
(entry))

1472 i‡(
xas
.
xa_ödex
 =
ULONG_MAX
)

1476  
xas
.
xa_ödex
;

1477 
	}
}

1495 
∑ge
 *
	$föd_gë_íåy
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
off£t
)

1497 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
off£t
);

1498 
∑ge
 *
hód
, *page;

1499 
	`¥ötk
("find_get_entry_Call \n");

1500 
	`rcu_ªad_lock
();

1501 
ª≥©
:

1503 
	`¥ötk
("intoÑepeat\n");

1504 
	`xas_ª£t
(&
xas
);

1505 
∑ge
 = 
	`xas_lﬂd
(&
xas
);

1506 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

1507 
ª≥©
;

1512 i‡(!
∑ge
 || 
	`xa_is_vÆue
(page))

1513 
out
;

1515 
hód
 = 
	`compound_hód
(
∑ge
);

1516 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

1517 
ª≥©
;

1520 i‡(
	`compound_hód
(
∑ge
Ë!
hód
) {

1521 
	`put_∑ge
(
hód
);

1522 
ª≥©
;

1530 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
))) {

1531 
	`put_∑ge
(
hód
);

1532 
ª≥©
;

1534 
out
:

1535 
	`rcu_ªad_u∆ock
();

1537  
∑ge
;

1538 
	}
}

1557 
∑ge
 *
	$föd_lock_íåy
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
off£t
)

1559 
∑ge
 *page;

1561 
ª≥©
:

1562 
∑ge
 = 
	`föd_gë_íåy
(
m≠pög
, 
off£t
);

1563 i‡(
∑ge
 && !
	`xa_is_vÆue
(page)) {

1564 
	`lock_∑ge
(
∑ge
);

1566 i‡(
	`u∆ikñy
(
	`∑ge_m≠pög
(
∑ge
Ë!
m≠pög
)) {

1567 
	`u∆ock_∑ge
(
∑ge
);

1568 
	`put_∑ge
(
∑ge
);

1569 
ª≥©
;

1571 
	`VM_BUG_ON_PAGE
(
	`∑ge_to_pgoff
(
∑ge
Ë!
off£t
,Öage);

1573  
∑ge
;

1574 
	}
}

1607 
∑ge
 *
	$∑geˇche_gë_∑ge
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
off£t
,

1608 
fgp_Êags
, 
gÂ_t
 
gÂ_mask
)

1610 
∑ge
 *page;

1612 
	`¥ötk
("pagecache_get_page calling\n");

1613 
ª≥©
:

1614 
∑ge
 = 
	`föd_gë_íåy
(
m≠pög
, 
off£t
);

1615 i‡(
	`xa_is_vÆue
(
∑ge
))

1616 
∑ge
 = 
NULL
;

1617 i‡(!
∑ge
)

1618 
no_∑ge
;

1620 i‡(
fgp_Êags
 & 
FGP_LOCK
) {

1621 i‡(
fgp_Êags
 & 
FGP_NOWAIT
) {

1622 i‡(!
	`åylock_∑ge
(
∑ge
)) {

1623 
	`put_∑ge
(
∑ge
);

1624  
NULL
;

1627 
	`lock_∑ge
(
∑ge
);

1631 i‡(
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

1632 
	`u∆ock_∑ge
(
∑ge
);

1633 
	`put_∑ge
(
∑ge
);

1634 
ª≥©
;

1636 
	`VM_BUG_ON_PAGE
(
∑ge
->
ödex
 !
off£t
,Öage);

1639 i‡(
fgp_Êags
 & 
FGP_ACCESSED
)

1640 
	`m¨k_∑ge_ac˚s£d
(
∑ge
);

1642 
no_∑ge
:

1643 i‡(!
∑ge
 && (
fgp_Êags
 & 
FGP_CREAT
)) {

1644 
îr
;

1645 i‡((
fgp_Êags
 & 
FGP_WRITE
Ë&& 
	`m≠pög_ˇp_accou¡_dúty
(
m≠pög
))

1646 
gÂ_mask
 |
__GFP_WRITE
;

1647 i‡(
fgp_Êags
 & 
FGP_NOFS
)

1648 
gÂ_mask
 &~
__GFP_FS
;

1650 
∑ge
 = 
	`__∑ge_ˇche_Æloc
(
gÂ_mask
);

1651 i‡(!
∑ge
)

1652  
NULL
;

1654 i‡(
	`WARN_ON_ONCE
(!(
fgp_Êags
 & (
FGP_LOCK
 | 
FGP_FOR_MMAP
))))

1655 
fgp_Êags
 |
FGP_LOCK
;

1658 i‡(
fgp_Êags
 & 
FGP_ACCESSED
)

1659 
	`__SëPageRe„ªn˚d
(
∑ge
);

1661 
îr
 = 
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
, 
off£t
, 
gÂ_mask
);

1662 i‡(
	`u∆ikñy
(
îr
)) {

1663 
	`put_∑ge
(
∑ge
);

1664 
∑ge
 = 
NULL
;

1665 i‡(
îr
 =-
EEXIST
)

1666 
ª≥©
;

1673 i‡(
∑ge
 && (
fgp_Êags
 & 
FGP_FOR_MMAP
))

1674 
	`u∆ock_∑ge
(
∑ge
);

1677  
∑ge
;

1678 
	}
}

1703 
	$föd_gë_íåõs
(
addªss_•a˚
 *
m≠pög
,

1704 
pgoff_t
 
°¨t
, 
ƒ_íåõs
,

1705 
∑ge
 **
íåõs
, 
pgoff_t
 *
ödi˚s
)

1707 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t
);

1708 
∑ge
 *page;

1709 
ªt
 = 0;

1711 i‡(!
ƒ_íåõs
)

1714 
	`rcu_ªad_lock
();

1715 
	`xas_f‹_óch
(&
xas
, 
∑ge
, 
ULONG_MAX
) {

1716 
∑ge
 *
hód
;

1717 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

1724 i‡(
	`xa_is_vÆue
(
∑ge
))

1725 
exp‹t
;

1727 
hód
 = 
	`compound_hód
(
∑ge
);

1728 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

1729 
ªåy
;

1732 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

1733 
put_∑ge
;

1736 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

1737 
put_∑ge
;

1739 
exp‹t
:

1740 
ödi˚s
[
ªt
] = 
xas
.
xa_ödex
;

1741 
íåõs
[
ªt
] = 
∑ge
;

1742 i‡(++
ªt
 =
ƒ_íåõs
)

1745 
put_∑ge
:

1746 
	`put_∑ge
(
hód
);

1747 
ªåy
:

1748 
	`xas_ª£t
(&
xas
);

1750 
	`rcu_ªad_u∆ock
();

1751  
ªt
;

1752 
	}
}

1775 
	$föd_gë_∑ges_ønge
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 *
°¨t
,

1776 
pgoff_t
 
íd
, 
ƒ_∑ges
,

1777 
∑ge
 **
∑ges
)

1779 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, *
°¨t
);

1780 
∑ge
 *page;

1781 
ªt
 = 0;

1783 i‡(
	`u∆ikñy
(!
ƒ_∑ges
))

1786 
	`rcu_ªad_lock
();

1787 
	`xas_f‹_óch
(&
xas
, 
∑ge
, 
íd
) {

1788 
∑ge
 *
hód
;

1789 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

1792 i‡(
	`xa_is_vÆue
(
∑ge
))

1795 
hód
 = 
	`compound_hód
(
∑ge
);

1796 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

1797 
ªåy
;

1800 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

1801 
put_∑ge
;

1804 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

1805 
put_∑ge
;

1807 
∑ges
[
ªt
] = 
∑ge
;

1808 i‡(++
ªt
 =
ƒ_∑ges
) {

1809 *
°¨t
 = 
xas
.
xa_ödex
 + 1;

1810 
out
;

1813 
put_∑ge
:

1814 
	`put_∑ge
(
hód
);

1815 
ªåy
:

1816 
	`xas_ª£t
(&
xas
);

1825 i‡(
íd
 =(
pgoff_t
)-1)

1826 *
°¨t
 = (
pgoff_t
)-1;

1828 *
°¨t
 = 
íd
 + 1;

1829 
out
:

1830 
	`rcu_ªad_u∆ock
();

1832  
ªt
;

1833 
	}
}

1847 
	$föd_gë_∑ges_c⁄tig
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
ödex
,

1848 
ƒ_∑ges
, 
∑ge
 **
∑ges
)

1850 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
ödex
);

1851 
∑ge
 *page;

1852 
ªt
 = 0;

1854 i‡(
	`u∆ikñy
(!
ƒ_∑ges
))

1857 
	`rcu_ªad_lock
();

1858 
∑ge
 = 
	`xas_lﬂd
(&
xas
);Öage;Öagê
	`xas_√xt
(&xas)) {

1859 
∑ge
 *
hód
;

1860 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

1866 i‡(
	`xa_is_vÆue
(
∑ge
))

1869 
hód
 = 
	`compound_hód
(
∑ge
);

1870 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

1871 
ªåy
;

1874 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

1875 
put_∑ge
;

1878 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

1879 
put_∑ge
;

1881 
∑ges
[
ªt
] = 
∑ge
;

1882 i‡(++
ªt
 =
ƒ_∑ges
)

1885 
put_∑ge
:

1886 
	`put_∑ge
(
hód
);

1887 
ªåy
:

1888 
	`xas_ª£t
(&
xas
);

1890 
	`rcu_ªad_u∆ock
();

1891  
ªt
;

1892 
	}
}

1909 
	$föd_gë_∑ges_ønge_èg
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 *
ödex
,

1910 
pgoff_t
 
íd
, 
xa_m¨k_t
 
èg
, 
ƒ_∑ges
,

1911 
∑ge
 **
∑ges
)

1913 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, *
ödex
);

1914 
∑ge
 *page;

1915 
ªt
 = 0;

1917 i‡(
	`u∆ikñy
(!
ƒ_∑ges
))

1920 
	`rcu_ªad_lock
();

1921 
	`xas_f‹_óch_m¨ked
(&
xas
, 
∑ge
, 
íd
, 
èg
) {

1922 
∑ge
 *
hód
;

1923 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

1930 i‡(
	`xa_is_vÆue
(
∑ge
))

1933 
hód
 = 
	`compound_hód
(
∑ge
);

1934 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

1935 
ªåy
;

1938 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

1939 
put_∑ge
;

1942 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

1943 
put_∑ge
;

1945 
∑ges
[
ªt
] = 
∑ge
;

1946 i‡(++
ªt
 =
ƒ_∑ges
) {

1947 *
ödex
 = 
xas
.
xa_ödex
 + 1;

1948 
out
;

1951 
put_∑ge
:

1952 
	`put_∑ge
(
hód
);

1953 
ªåy
:

1954 
	`xas_ª£t
(&
xas
);

1963 i‡(
íd
 =(
pgoff_t
)-1)

1964 *
ödex
 = (
pgoff_t
)-1;

1966 *
ödex
 = 
íd
 + 1;

1967 
out
:

1968 
	`rcu_ªad_u∆ock
();

1970  
ªt
;

1971 
	}
}

1988 
	$föd_gë_íåõs_èg
(
addªss_•a˚
 *
m≠pög
, 
pgoff_t
 
°¨t
,

1989 
xa_m¨k_t
 
èg
, 
ƒ_íåõs
,

1990 
∑ge
 **
íåõs
, 
pgoff_t
 *
ödi˚s
)

1992 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t
);

1993 
∑ge
 *page;

1994 
ªt
 = 0;

1996 i‡(!
ƒ_íåõs
)

1999 
	`rcu_ªad_lock
();

2000 
	`xas_f‹_óch_m¨ked
(&
xas
, 
∑ge
, 
ULONG_MAX
, 
èg
) {

2001 
∑ge
 *
hód
;

2002 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

2009 i‡(
	`xa_is_vÆue
(
∑ge
))

2010 
exp‹t
;

2012 
hód
 = 
	`compound_hód
(
∑ge
);

2013 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

2014 
ªåy
;

2017 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

2018 
put_∑ge
;

2021 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

2022 
put_∑ge
;

2024 
exp‹t
:

2025 
ödi˚s
[
ªt
] = 
xas
.
xa_ödex
;

2026 
íåõs
[
ªt
] = 
∑ge
;

2027 i‡(++
ªt
 =
ƒ_íåõs
)

2030 
put_∑ge
:

2031 
	`put_∑ge
(
hód
);

2032 
ªåy
:

2033 
	`xas_ª£t
(&
xas
);

2035 
	`rcu_ªad_u∆ock
();

2036  
ªt
;

2037 
	}
}

2055 
	$shrök_ªadahód_size_eio
(
fûe
 *
fûp
,

2056 
fûe_ø_°©e
 *
ø
)

2058 
ø
->
ø_∑ges
 /= 4;

2059 
	}
}

2077 
ssize_t
 
	$gíîic_fûe_buf„ªd_ªad
(
kiocb
 *
iocb
,

2078 
iov_ôî
 *
ôî
, 
ssize_t
 
wrôãn
)

2080 
fûe
 *
fûp
 = 
iocb
->
ki_fûp
;

2081 
addªss_•a˚
 *
m≠pög
 = 
fûp
->
f_m≠pög
;

2082 
öode
 *öodê
m≠pög
->
ho°
;

2083 
fûe_ø_°©e
 *
ø
 = &
fûp
->
f_ø
;

2084 
loff_t
 *
µos
 = &
iocb
->
ki_pos
;

2085 
pgoff_t
 
ödex
;

2086 
pgoff_t
 
œ°_ödex
;

2087 
pgoff_t
 
¥ev_ödex
;

2088 
off£t
;

2089 
¥ev_off£t
;

2090 
îr‹
 = 0;

2092 i‡(
	`u∆ikñy
(*
µos
 >
öode
->
i_sb
->
s_maxbyãs
))

2094 
	`iov_ôî_åunˇã
(
ôî
, 
öode
->
i_sb
->
s_maxbyãs
);

2096 
ödex
 = *
µos
 >> 
PAGE_SHIFT
;

2097 
¥ev_ödex
 = 
ø
->
¥ev_pos
 >> 
PAGE_SHIFT
;

2098 
¥ev_off£t
 = 
ø
->
¥ev_pos
 & (
PAGE_SIZE
-1);

2099 
œ°_ödex
 = (*
µos
 + 
ôî
->
cou¡
 + 
PAGE_SIZE
-1Ë>> 
PAGE_SHIFT
;

2100 
off£t
 = *
µos
 & ~
PAGE_MASK
;

2103 
∑ge
 *page;

2104 
pgoff_t
 
íd_ödex
;

2105 
loff_t
 
isize
;

2106 
ƒ
, 
ªt
;

2108 
	`c⁄d_ªsched
();

2109 
föd_∑ge
:

2110 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

2111 
îr‹
 = -
EINTR
;

2112 
out
;

2115 
∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
ödex
);

2116 i‡(!
∑ge
) {

2117 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
)

2118 
would_block
;

2119 
	`∑ge_ˇche_sync_ªadahód
(
m≠pög
,

2120 
ø
, 
fûp
,

2121 
ödex
, 
œ°_ödex
 - index);

2122 
∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
ödex
);

2123 i‡(
	`u∆ikñy
(
∑ge
 =
NULL
))

2124 
no_ˇched_∑ge
;

2126 i‡(
	`PageRódahód
(
∑ge
)) {

2127 
	`∑ge_ˇche_async_ªadahód
(
m≠pög
,

2128 
ø
, 
fûp
, 
∑ge
,

2129 
ödex
, 
œ°_ödex
 - index);

2131 i‡(!
	`PageU±od©e
(
∑ge
)) {

2132 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

2133 
	`put_∑ge
(
∑ge
);

2134 
would_block
;

2142 
îr‹
 = 
	`waô_⁄_∑ge_locked_kûœbÀ
(
∑ge
);

2143 i‡(
	`u∆ikñy
(
îr‹
))

2144 
ªad∑ge_îr‹
;

2145 i‡(
	`PageU±od©e
(
∑ge
))

2146 
∑ge_ok
;

2148 i‡(
öode
->
i_blkbôs
 =
PAGE_SHIFT
 ||

2149 !
m≠pög
->
a_›s
->
is_∑πüŒy_u±od©e
)

2150 
∑ge_nŸ_up_to_d©e
;

2152 i‡(
	`u∆ikñy
(
	`iov_ôî_is_pùe
(
ôî
)))

2153 
∑ge_nŸ_up_to_d©e
;

2154 i‡(!
	`åylock_∑ge
(
∑ge
))

2155 
∑ge_nŸ_up_to_d©e
;

2157 i‡(!
∑ge
->
m≠pög
)

2158 
∑ge_nŸ_up_to_d©e_locked
;

2159 i‡(!
m≠pög
->
a_›s
->
	`is_∑πüŒy_u±od©e
(
∑ge
,

2160 
off£t
, 
ôî
->
cou¡
))

2161 
∑ge_nŸ_up_to_d©e_locked
;

2162 
	`u∆ock_∑ge
(
∑ge
);

2164 
∑ge_ok
:

2174 
isize
 = 
	`i_size_ªad
(
öode
);

2175 
íd_ödex
 = (
isize
 - 1Ë>> 
PAGE_SHIFT
;

2176 i‡(
	`u∆ikñy
(!
isize
 || 
ödex
 > 
íd_ödex
)) {

2177 
	`put_∑ge
(
∑ge
);

2178 
out
;

2182 
ƒ
 = 
PAGE_SIZE
;

2183 i‡(
ödex
 =
íd_ödex
) {

2184 
ƒ
 = ((
isize
 - 1Ë& ~
PAGE_MASK
) + 1;

2185 i‡(
ƒ
 <
off£t
) {

2186 
	`put_∑ge
(
∑ge
);

2187 
out
;

2190 
ƒ
 =Ç∏- 
off£t
;

2196 i‡(
	`m≠pög_wrôably_m≠≥d
(
m≠pög
))

2197 
	`Êush_dˇche_∑ge
(
∑ge
);

2203 i‡(
¥ev_ödex
 !
ödex
 || 
off£t
 !
¥ev_off£t
)

2204 
	`m¨k_∑ge_ac˚s£d
(
∑ge
);

2205 
¥ev_ödex
 = 
ödex
;

2212 
ªt
 = 
	`c›y_∑ge_to_ôî
(
∑ge
, 
off£t
, 
ƒ
, 
ôî
);

2213 
off£t
 +
ªt
;

2214 
ödex
 +
off£t
 >> 
PAGE_SHIFT
;

2215 
off£t
 &~
PAGE_MASK
;

2216 
¥ev_off£t
 = 
off£t
;

2218 
	`put_∑ge
(
∑ge
);

2219 
wrôãn
 +
ªt
;

2220 i‡(!
	`iov_ôî_cou¡
(
ôî
))

2221 
out
;

2222 i‡(
ªt
 < 
ƒ
) {

2223 
îr‹
 = -
EFAULT
;

2224 
out
;

2228 
∑ge_nŸ_up_to_d©e
:

2230 
îr‹
 = 
	`lock_∑ge_kûœbÀ
(
∑ge
);

2231 i‡(
	`u∆ikñy
(
îr‹
))

2232 
ªad∑ge_îr‹
;

2234 
∑ge_nŸ_up_to_d©e_locked
:

2236 i‡(!
∑ge
->
m≠pög
) {

2237 
	`u∆ock_∑ge
(
∑ge
);

2238 
	`put_∑ge
(
∑ge
);

2243 i‡(
	`PageU±od©e
(
∑ge
)) {

2244 
	`u∆ock_∑ge
(
∑ge
);

2245 
∑ge_ok
;

2248 
ªad∑ge
:

2254 
	`CÀ¨PageEº‹
(
∑ge
);

2256 
îr‹
 = 
m≠pög
->
a_›s
->
	`ªad∑ge
(
fûp
, 
∑ge
);

2258 i‡(
	`u∆ikñy
(
îr‹
)) {

2259 i‡(
îr‹
 =
AOP_TRUNCATED_PAGE
) {

2260 
	`put_∑ge
(
∑ge
);

2261 
îr‹
 = 0;

2262 
föd_∑ge
;

2264 
ªad∑ge_îr‹
;

2267 i‡(!
	`PageU±od©e
(
∑ge
)) {

2268 
îr‹
 = 
	`lock_∑ge_kûœbÀ
(
∑ge
);

2269 i‡(
	`u∆ikñy
(
îr‹
))

2270 
ªad∑ge_îr‹
;

2271 i‡(!
	`PageU±od©e
(
∑ge
)) {

2272 i‡(
∑ge
->
m≠pög
 =
NULL
) {

2276 
	`u∆ock_∑ge
(
∑ge
);

2277 
	`put_∑ge
(
∑ge
);

2278 
föd_∑ge
;

2280 
	`u∆ock_∑ge
(
∑ge
);

2281 
	`shrök_ªadahód_size_eio
(
fûp
, 
ø
);

2282 
îr‹
 = -
EIO
;

2283 
ªad∑ge_îr‹
;

2285 
	`u∆ock_∑ge
(
∑ge
);

2288 
∑ge_ok
;

2290 
ªad∑ge_îr‹
:

2292 
	`put_∑ge
(
∑ge
);

2293 
out
;

2295 
no_ˇched_∑ge
:

2300 
∑ge
 = 
	`∑ge_ˇche_Æloc
(
m≠pög
);

2301 i‡(!
∑ge
) {

2302 
îr‹
 = -
ENOMEM
;

2303 
out
;

2305 
îr‹
 = 
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
, 
ödex
,

2306 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, 
GFP_KERNEL
));

2307 i‡(
îr‹
) {

2308 
	`put_∑ge
(
∑ge
);

2309 i‡(
îr‹
 =-
EEXIST
) {

2310 
îr‹
 = 0;

2311 
föd_∑ge
;

2313 
out
;

2315 
ªad∑ge
;

2318 
would_block
:

2319 
îr‹
 = -
EAGAIN
;

2320 
out
:

2321 
ø
->
¥ev_pos
 = 
¥ev_ödex
;

2322 
ø
->
¥ev_pos
 <<
PAGE_SHIFT
;

2323 
ø
->
¥ev_pos
 |
¥ev_off£t
;

2325 *
µos
 = ((
loff_t
)
ödex
 << 
PAGE_SHIFT
Ë+ 
off£t
;

2326 
	`fûe_ac˚s£d
(
fûp
);

2327  
wrôãn
 ? wrôã¿: 
îr‹
;

2328 
	}
}

2341 
ssize_t


2342 
	$gíîic_fûe_ªad_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

2344 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

2345 
ssize_t
 
ªtvÆ
 = 0;

2347 i‡(!
cou¡
)

2348 
out
;

2350 i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
) {

2351 
fûe
 *fûê
iocb
->
ki_fûp
;

2352 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2353 
öode
 *öodê
m≠pög
->
ho°
;

2354 
loff_t
 
size
;

2356 
size
 = 
	`i_size_ªad
(
öode
);

2357 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

2358 i‡(
	`fûem≠_ønge_has_∑ge
(
m≠pög
, 
iocb
->
ki_pos
,

2359 
iocb
->
ki_pos
 + 
cou¡
 - 1))

2360  -
EAGAIN
;

2362 
ªtvÆ
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
,

2363 
iocb
->
ki_pos
,

2364 
iocb
->
ki_pos
 + 
cou¡
 - 1);

2365 i‡(
ªtvÆ
 < 0)

2366 
out
;

2369 
	`fûe_ac˚s£d
(
fûe
);

2371 
ªtvÆ
 = 
m≠pög
->
a_›s
->
	`dúe˘_IO
(
iocb
, 
ôî
);

2372 i‡(
ªtvÆ
 >= 0) {

2373 
iocb
->
ki_pos
 +
ªtvÆ
;

2374 
cou¡
 -
ªtvÆ
;

2376 
	`iov_ôî_ªvît
(
ôî
, 
cou¡
 - 
	`iov_ôî_cou¡
(iter));

2387 i‡(
ªtvÆ
 < 0 || !
cou¡
 || 
iocb
->
ki_pos
 >
size
 ||

2388 
	`IS_DAX
(
öode
))

2389 
out
;

2392 
ªtvÆ
 = 
	`gíîic_fûe_buf„ªd_ªad
(
iocb
, 
ôî
,Ñetval);

2393 
out
:

2394  
ªtvÆ
;

2395 
	}
}

2398 #ifde‡
CONFIG_MMU


2399 
	#MMAP_LOTSAMISS
 (100)

	)

2400 
fûe
 *
	$maybe_u∆ock_mm≠_f‹_io
(
vm_Áu…
 *
vmf
,

2401 
fûe
 *
Âö
)

2403 
Êags
 = 
vmf
->flags;

2405 i‡(
Âö
)

2406  
Âö
;

2413 i‡((
Êags
 & (
FAULT_FLAG_ALLOW_RETRY
 | 
FAULT_FLAG_RETRY_NOWAIT
)) ==

2414 
FAULT_FLAG_ALLOW_RETRY
) {

2415 
Âö
 = 
	`gë_fûe
(
vmf
->
vma
->
vm_fûe
);

2416 
	`up_ªad
(&
vmf
->
vma
->
vm_mm
->
mm≠_£m
);

2418  
Âö
;

2419 
	}
}

2432 
	$lock_∑ge_maybe_dr›_mm≠
(
vm_Áu…
 *
vmf
, 
∑ge
 *page,

2433 
fûe
 **
Âö
)

2435 i‡(
	`åylock_∑ge
(
∑ge
))

2443 i‡(
vmf
->
Êags
 & 
FAULT_FLAG_RETRY_NOWAIT
)

2446 *
Âö
 = 
	`maybe_u∆ock_mm≠_f‹_io
(
vmf
, *fpin);

2447 i‡(
vmf
->
Êags
 & 
FAULT_FLAG_KILLABLE
) {

2448 i‡(
	`__lock_∑ge_kûœbÀ
(
∑ge
)) {

2455 i‡(*
Âö
 =
NULL
)

2456 
	`up_ªad
(&
vmf
->
vma
->
vm_mm
->
mm≠_£m
);

2460 
	`__lock_∑ge
(
∑ge
);

2462 
	}
}

2472 
fûe
 *
	$do_sync_mm≠_ªadahód
(
vm_Áu…
 *
vmf
)

2474 
fûe
 *fûê
vmf
->
vma
->
vm_fûe
;

2475 
fûe_ø_°©e
 *
ø
 = &
fûe
->
f_ø
;

2476 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2477 
fûe
 *
Âö
 = 
NULL
;

2478 
pgoff_t
 
off£t
 = 
vmf
->
pgoff
;

2481 i‡(
vmf
->
vma
->
vm_Êags
 & 
VM_RAND_READ
)

2482  
Âö
;

2483 i‡(!
ø
->
ø_∑ges
)

2484  
Âö
;

2486 i‡(
vmf
->
vma
->
vm_Êags
 & 
VM_SEQ_READ
) {

2487 
Âö
 = 
	`maybe_u∆ock_mm≠_f‹_io
(
vmf
, fpin);

2488 
	`∑ge_ˇche_sync_ªadahód
(
m≠pög
, 
ø
, 
fûe
, 
off£t
,

2489 
ø
->
ø_∑ges
);

2490  
Âö
;

2494 i‡(
ø
->
mm≠_miss
 < 
MMAP_LOTSAMISS
 * 10)

2495 
ø
->
mm≠_miss
++;

2501 i‡(
ø
->
mm≠_miss
 > 
MMAP_LOTSAMISS
)

2502  
Âö
;

2507 
Âö
 = 
	`maybe_u∆ock_mm≠_f‹_io
(
vmf
, fpin);

2508 
ø
->
°¨t
 = 
	`max_t
(, 0, 
off£t
 -Ña->
ø_∑ges
 / 2);

2509 
ø
->
size
 =Ña->
ø_∑ges
;

2510 
ø
->
async_size
 =Ña->
ø_∑ges
 / 4;

2511 
	`ø_submô
(
ø
, 
m≠pög
, 
fûe
);

2512  
Âö
;

2513 
	}
}

2520 
fûe
 *
	$do_async_mm≠_ªadahód
(
vm_Áu…
 *
vmf
,

2521 
∑ge
 *page)

2523 
fûe
 *fûê
vmf
->
vma
->
vm_fûe
;

2524 
fûe_ø_°©e
 *
ø
 = &
fûe
->
f_ø
;

2525 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2526 
fûe
 *
Âö
 = 
NULL
;

2527 
pgoff_t
 
off£t
 = 
vmf
->
pgoff
;

2530 i‡(
vmf
->
vma
->
vm_Êags
 & 
VM_RAND_READ
)

2531  
Âö
;

2532 i‡(
ø
->
mm≠_miss
 > 0)

2533 
ø
->
mm≠_miss
--;

2534 i‡(
	`PageRódahód
(
∑ge
)) {

2535 
Âö
 = 
	`maybe_u∆ock_mm≠_f‹_io
(
vmf
, fpin);

2536 
	`∑ge_ˇche_async_ªadahód
(
m≠pög
, 
ø
, 
fûe
,

2537 
∑ge
, 
off£t
, 
ø
->
ø_∑ges
);

2539  
Âö
;

2540 
	}
}

2567 
vm_Áu…_t
 
	$fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

2569 
îr‹
;

2570 
fûe
 *fûê
vmf
->
vma
->
vm_fûe
;

2571 
fûe
 *
Âö
 = 
NULL
;

2572 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2573 
fûe_ø_°©e
 *
ø
 = &
fûe
->
f_ø
;

2574 
öode
 *öodê
m≠pög
->
ho°
;

2575 
pgoff_t
 
off£t
 = 
vmf
->
pgoff
;

2576 
pgoff_t
 
max_off
;

2577 
∑ge
 *page;

2578 
vm_Áu…_t
 
ªt
 = 0;

2580 
max_off
 = 
	`DIV_ROUND_UP
(
	`i_size_ªad
(
öode
), 
PAGE_SIZE
);

2581 i‡(
	`u∆ikñy
(
off£t
 >
max_off
))

2582  
VM_FAULT_SIGBUS
;

2587 
∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
off£t
);

2588 i‡(
	`likñy
(
∑ge
Ë&& !(
vmf
->
Êags
 & 
FAULT_FLAG_TRIED
)) {

2593 
Âö
 = 
	`do_async_mm≠_ªadahód
(
vmf
, 
∑ge
);

2594 } i‡(!
∑ge
) {

2596 
	`cou¡_vm_evít
(
PGMAJFAULT
);

2597 
	`cou¡_memcg_evít_mm
(
vmf
->
vma
->
vm_mm
, 
PGMAJFAULT
);

2598 
ªt
 = 
VM_FAULT_MAJOR
;

2599 
Âö
 = 
	`do_sync_mm≠_ªadahód
(
vmf
);

2600 
ªåy_föd
:

2601 
∑ge
 = 
	`∑geˇche_gë_∑ge
(
m≠pög
, 
off£t
,

2602 
FGP_CREAT
|
FGP_FOR_MMAP
,

2603 
vmf
->
gÂ_mask
);

2604 i‡(!
∑ge
) {

2605 i‡(
Âö
)

2606 
out_ªåy
;

2607  
	`vmf_îr‹
(-
ENOMEM
);

2611 i‡(!
	`lock_∑ge_maybe_dr›_mm≠
(
vmf
, 
∑ge
, &
Âö
))

2612 
out_ªåy
;

2615 i‡(
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2616 
	`u∆ock_∑ge
(
∑ge
);

2617 
	`put_∑ge
(
∑ge
);

2618 
ªåy_föd
;

2620 
	`VM_BUG_ON_PAGE
(
∑ge
->
ödex
 !
off£t
,Öage);

2626 i‡(
	`u∆ikñy
(!
	`PageU±od©e
(
∑ge
)))

2627 
∑ge_nŸ_u±od©e
;

2634 i‡(
Âö
) {

2635 
	`u∆ock_∑ge
(
∑ge
);

2636 
out_ªåy
;

2643 
max_off
 = 
	`DIV_ROUND_UP
(
	`i_size_ªad
(
öode
), 
PAGE_SIZE
);

2644 i‡(
	`u∆ikñy
(
off£t
 >
max_off
)) {

2645 
	`u∆ock_∑ge
(
∑ge
);

2646 
	`put_∑ge
(
∑ge
);

2647  
VM_FAULT_SIGBUS
;

2650 
vmf
->
∑ge
 =Öage;

2651  
ªt
 | 
VM_FAULT_LOCKED
;

2653 
∑ge_nŸ_u±od©e
:

2660 
	`CÀ¨PageEº‹
(
∑ge
);

2661 
Âö
 = 
	`maybe_u∆ock_mm≠_f‹_io
(
vmf
, fpin);

2662 
îr‹
 = 
m≠pög
->
a_›s
->
	`ªad∑ge
(
fûe
, 
∑ge
);

2663 i‡(!
îr‹
) {

2664 
	`waô_⁄_∑ge_locked
(
∑ge
);

2665 i‡(!
	`PageU±od©e
(
∑ge
))

2666 
îr‹
 = -
EIO
;

2668 i‡(
Âö
)

2669 
out_ªåy
;

2670 
	`put_∑ge
(
∑ge
);

2672 i‡(!
îr‹
 ||Éº‹ =
AOP_TRUNCATED_PAGE
)

2673 
ªåy_föd
;

2676 
	`shrök_ªadahód_size_eio
(
fûe
, 
ø
);

2677  
VM_FAULT_SIGBUS
;

2679 
out_ªåy
:

2685 i‡(
∑ge
)

2686 
	`put_∑ge
(
∑ge
);

2687 i‡(
Âö
)

2688 
	`Âut
(
Âö
);

2689  
ªt
 | 
VM_FAULT_RETRY
;

2690 
	}
}

2693 
	$fûem≠_m≠_∑ges
(
vm_Áu…
 *
vmf
,

2694 
pgoff_t
 
°¨t_pgoff
,Ögoff_à
íd_pgoff
)

2696 
fûe
 *fûê
vmf
->
vma
->
vm_fûe
;

2697 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2698 
pgoff_t
 
œ°_pgoff
 = 
°¨t_pgoff
;

2699 
max_idx
;

2700 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t_pgoff
);

2701 
∑ge
 *
hód
, *page;

2703 
	`rcu_ªad_lock
();

2704 
	`xas_f‹_óch
(&
xas
, 
∑ge
, 
íd_pgoff
) {

2705 i‡(
	`xas_ªåy
(&
xas
, 
∑ge
))

2707 i‡(
	`xa_is_vÆue
(
∑ge
))

2708 
√xt
;

2710 
hód
 = 
	`compound_hód
(
∑ge
);

2716 i‡(
	`PageLocked
(
hód
))

2717 
√xt
;

2718 i‡(!
	`∑ge_ˇche_gë_•ecuœtive
(
hód
))

2719 
√xt
;

2722 i‡(
	`compound_hód
(
∑ge
Ë!
hód
)

2723 
skù
;

2726 i‡(
	`u∆ikñy
(
∑ge
 !
	`xas_ªlﬂd
(&
xas
)))

2727 
skù
;

2729 i‡(!
	`PageU±od©e
(
∑ge
) ||

2730 
	`PageRódahód
(
∑ge
) ||

2731 
	`PageHWPois⁄
(
∑ge
))

2732 
skù
;

2733 i‡(!
	`åylock_∑ge
(
∑ge
))

2734 
skù
;

2736 i‡(
∑ge
->
m≠pög
 !m≠pög || !
	`PageU±od©e
(page))

2737 
u∆ock
;

2739 
max_idx
 = 
	`DIV_ROUND_UP
(
	`i_size_ªad
(
m≠pög
->
ho°
), 
PAGE_SIZE
);

2740 i‡(
∑ge
->
ödex
 >
max_idx
)

2741 
u∆ock
;

2743 i‡(
fûe
->
f_ø
.
mm≠_miss
 > 0)

2744 
fûe
->
f_ø
.
mm≠_miss
--;

2746 
vmf
->
addªss
 +(
xas
.
xa_ödex
 - 
œ°_pgoff
Ë<< 
PAGE_SHIFT
;

2747 i‡(
vmf
->
±e
)

2748 
vmf
->
±e
 +
xas
.
xa_ödex
 - 
œ°_pgoff
;

2749 
œ°_pgoff
 = 
xas
.
xa_ödex
;

2750 i‡(
	`Æloc_£t_±e
(
vmf
, 
NULL
, 
∑ge
))

2751 
u∆ock
;

2752 
	`u∆ock_∑ge
(
∑ge
);

2753 
√xt
;

2754 
u∆ock
:

2755 
	`u∆ock_∑ge
(
∑ge
);

2756 
skù
:

2757 
	`put_∑ge
(
∑ge
);

2758 
√xt
:

2760 i‡(
	`pmd_å™s_huge
(*
vmf
->
pmd
))

2763 
	`rcu_ªad_u∆ock
();

2764 
	}
}

2767 
vm_Áu…_t
 
	$fûem≠_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

2769 
∑ge
 *∑gê
vmf
->page;

2770 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

2771 
vm_Áu…_t
 
ªt
 = 
VM_FAULT_LOCKED
;

2773 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

2774 
	`fûe_upd©e_time
(
vmf
->
vma
->
vm_fûe
);

2775 
	`lock_∑ge
(
∑ge
);

2776 i‡(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
) {

2777 
	`u∆ock_∑ge
(
∑ge
);

2778 
ªt
 = 
VM_FAULT_NOPAGE
;

2779 
out
;

2786 
	`£t_∑ge_dúty
(
∑ge
);

2787 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

2788 
out
:

2789 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

2790  
ªt
;

2791 
	}
}

2793 c⁄° 
vm_›î©i⁄s_°ru˘
 
	ggíîic_fûe_vm_›s
 = {

2794 .
Áu…
 = 
fûem≠_Áu…
,

2795 .
	gm≠_∑ges
 = 
fûem≠_m≠_∑ges
,

2796 .
	g∑ge_mkwrôe
 = 
fûem≠_∑ge_mkwrôe
,

2801 
	$gíîic_fûe_mm≠
(
fûe
 * fûe, 
vm_¨ó_°ru˘
 * 
vma
)

2803 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

2805 i‡(!
m≠pög
->
a_›s
->
ªad∑ge
)

2806  -
ENOEXEC
;

2807 
	`fûe_ac˚s£d
(
fûe
);

2808 
vma
->
vm_›s
 = &
gíîic_fûe_vm_›s
;

2810 
	}
}

2815 
	$gíîic_fûe_ªad⁄ly_mm≠
(
fûe
 *fûe, 
vm_¨ó_°ru˘
 *
vma
)

2817 i‡((
vma
->
vm_Êags
 & 
VM_SHARED
Ë&& (vma->vm_Êag†& 
VM_MAYWRITE
))

2818  -
EINVAL
;

2819  
	`gíîic_fûe_mm≠
(
fûe
, 
vma
);

2820 
	}
}

2822 
vm_Áu…_t
 
	$fûem≠_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

2824  
VM_FAULT_SIGBUS
;

2825 
	}
}

2826 
	$gíîic_fûe_mm≠
(
fûe
 * fûe, 
vm_¨ó_°ru˘
 * 
vma
)

2828  -
ENOSYS
;

2829 
	}
}

2830 
	$gíîic_fûe_ªad⁄ly_mm≠
(
fûe
 * fûe, 
vm_¨ó_°ru˘
 * 
vma
)

2832  -
ENOSYS
;

2833 
	}
}

2840 
∑ge
 *
	$waô_⁄_∑ge_ªad
(
∑ge
 *page)

2842 i‡(!
	`IS_ERR
(
∑ge
)) {

2843 
	`waô_⁄_∑ge_locked
(
∑ge
);

2844 i‡(!
	`PageU±od©e
(
∑ge
)) {

2845 
	`put_∑ge
(
∑ge
);

2846 
∑ge
 = 
	`ERR_PTR
(-
EIO
);

2849  
∑ge
;

2850 
	}
}

2852 
∑ge
 *
	$do_ªad_ˇche_∑ge
(
addªss_•a˚
 *
m≠pög
,

2853 
pgoff_t
 
ödex
,

2854 (*
fûÀr
)(*, 
∑ge
 *),

2855 *
d©a
,

2856 
gÂ_t
 
gÂ
)

2858 
∑ge
 *page;

2859 
îr
;

2860 
ª≥©
:

2861 
∑ge
 = 
	`föd_gë_∑ge
(
m≠pög
, 
ödex
);

2862 i‡(!
∑ge
) {

2863 
∑ge
 = 
	`__∑ge_ˇche_Æloc
(
gÂ
);

2864 i‡(!
∑ge
)

2865  
	`ERR_PTR
(-
ENOMEM
);

2866 
îr
 = 
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
, 
ödex
, 
gÂ
);

2867 i‡(
	`u∆ikñy
(
îr
)) {

2868 
	`put_∑ge
(
∑ge
);

2869 i‡(
îr
 =-
EEXIST
)

2870 
ª≥©
;

2872  
	`ERR_PTR
(
îr
);

2875 
fûÀr
:

2876 
îr
 = 
	`fûÀr
(
d©a
, 
∑ge
);

2877 i‡(
îr
 < 0) {

2878 
	`put_∑ge
(
∑ge
);

2879  
	`ERR_PTR
(
îr
);

2882 
∑ge
 = 
	`waô_⁄_∑ge_ªad
(page);

2883 i‡(
	`IS_ERR
(
∑ge
))

2884  
∑ge
;

2885 
out
;

2887 i‡(
	`PageU±od©e
(
∑ge
))

2888 
out
;

2921 
	`waô_⁄_∑ge_locked
(
∑ge
);

2922 i‡(
	`PageU±od©e
(
∑ge
))

2923 
out
;

2926 
	`lock_∑ge
(
∑ge
);

2929 i‡(!
∑ge
->
m≠pög
) {

2930 
	`u∆ock_∑ge
(
∑ge
);

2931 
	`put_∑ge
(
∑ge
);

2932 
ª≥©
;

2936 i‡(
	`PageU±od©e
(
∑ge
)) {

2937 
	`u∆ock_∑ge
(
∑ge
);

2938 
out
;

2940 
fûÀr
;

2942 
out
:

2943 
	`m¨k_∑ge_ac˚s£d
(
∑ge
);

2944  
∑ge
;

2945 
	}
}

2961 
∑ge
 *
	$ªad_ˇche_∑ge
(
addªss_•a˚
 *
m≠pög
,

2962 
pgoff_t
 
ödex
,

2963 (*
fûÀr
)(*, 
∑ge
 *),

2964 *
d©a
)

2966  
	`do_ªad_ˇche_∑ge
(
m≠pög
, 
ödex
, 
fûÀr
, 
d©a
, 
	`m≠pög_gÂ_mask
(mapping));

2967 
	}
}

2983 
∑ge
 *
	$ªad_ˇche_∑ge_gÂ
(
addªss_•a˚
 *
m≠pög
,

2984 
pgoff_t
 
ödex
,

2985 
gÂ_t
 
gÂ
)

2987 
fûÀr_t
 *
fûÀr
 = (fûÀr_à*)
m≠pög
->
a_›s
->
ªad∑ge
;

2989  
	`do_ªad_ˇche_∑ge
(
m≠pög
, 
ödex
, 
fûÀr
, 
NULL
, 
gÂ
);

2990 
	}
}

2998 
	$gíîic_ac˚ss_check_limôs
(
fûe
 *fûe, 
loff_t
 
pos
,

2999 
loff_t
 *
cou¡
)

3001 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3002 
loff_t
 
max_size
 = 
öode
->
i_sb
->
s_maxbyãs
;

3004 i‡(!(
fûe
->
f_Êags
 & 
O_LARGEFILE
))

3005 
max_size
 = 
MAX_NON_LFS
;

3007 i‡(
	`u∆ikñy
(
pos
 >
max_size
))

3008  -
EFBIG
;

3009 *
cou¡
 = 
	`mö
(*cou¡, 
max_size
 - 
pos
);

3011 
	}
}

3013 
	$gíîic_wrôe_check_limôs
(
fûe
 *fûe, 
loff_t
 
pos
,

3014 
loff_t
 *
cou¡
)

3016 
loff_t
 
limô
 = 
	`æimô
(
RLIMIT_FSIZE
);

3018 i‡(
limô
 !
RLIM_INFINITY
) {

3019 i‡(
pos
 >
limô
) {

3020 
	`£nd_sig
(
SIGXFSZ
, 
cuºít
, 0);

3021  -
EFBIG
;

3023 *
cou¡
 = 
	`mö
(*cou¡, 
limô
 - 
pos
);

3026  
	`gíîic_ac˚ss_check_limôs
(
fûe
, 
pos
, 
cou¡
);

3027 
	}
}

3036 
ölöe
 
ssize_t
 
	$gíîic_wrôe_checks
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

3038 
fûe
 *fûê
iocb
->
ki_fûp
;

3039 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3040 
loff_t
 
cou¡
;

3041 
ªt
;

3043 i‡(!
	`iov_ôî_cou¡
(
‰om
))

3047 i‡(
iocb
->
ki_Êags
 & 
IOCB_APPEND
)

3048 
iocb
->
ki_pos
 = 
	`i_size_ªad
(
öode
);

3050 i‡((
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
Ë&& !(iocb->ki_Êag†& 
IOCB_DIRECT
))

3051  -
EINVAL
;

3053 
cou¡
 = 
	`iov_ôî_cou¡
(
‰om
);

3054 
ªt
 = 
	`gíîic_wrôe_check_limôs
(
fûe
, 
iocb
->
ki_pos
, &
cou¡
);

3055 i‡(
ªt
)

3056  
ªt
;

3058 
	`iov_ôî_åunˇã
(
‰om
, 
cou¡
);

3059  
	`iov_ôî_cou¡
(
‰om
);

3060 
	}
}

3070 
	$gíîic_ªm≠_checks
(
fûe
 *
fûe_ö
, 
loff_t
 
pos_ö
,

3071 
fûe
 *
fûe_out
, 
loff_t
 
pos_out
,

3072 
loff_t
 *
ªq_cou¡
, 
ªm≠_Êags
)

3074 
öode
 *
öode_ö
 = 
fûe_ö
->
f_m≠pög
->
ho°
;

3075 
öode
 *
öode_out
 = 
fûe_out
->
f_m≠pög
->
ho°
;

3076 
uöt64_t
 
cou¡
 = *
ªq_cou¡
;

3077 
uöt64_t
 
bcou¡
;

3078 
loff_t
 
size_ö
, 
size_out
;

3079 
loff_t
 
bs
 = 
öode_out
->
i_sb
->
s_blocksize
;

3080 
ªt
;

3083 i‡(!
	`IS_ALIGNED
(
pos_ö
, 
bs
Ë|| !IS_ALIGNED(
pos_out
, bs))

3084  -
EINVAL
;

3087 i‡(
pos_ö
 + 
cou¡
 <Öos_ö || 
pos_out
 + count <Öos_out)

3088  -
EINVAL
;

3090 
size_ö
 = 
	`i_size_ªad
(
öode_ö
);

3091 
size_out
 = 
	`i_size_ªad
(
öode_out
);

3094 i‡((
ªm≠_Êags
 & 
REMAP_FILE_DEDUP
) &&

3095 (
pos_ö
 >
size_ö
 ||Öos_ö + 
cou¡
 > size_in ||

3096 
pos_out
 >
size_out
 ||Öos_ouà+ 
cou¡
 > size_out))

3097  -
EINVAL
;

3100 i‡(
pos_ö
 >
size_ö
)

3101  -
EINVAL
;

3102 
cou¡
 = 
	`mö
(cou¡, 
size_ö
 - (
uöt64_t
)
pos_ö
);

3104 
ªt
 = 
	`gíîic_ac˚ss_check_limôs
(
fûe_ö
, 
pos_ö
, &
cou¡
);

3105 i‡(
ªt
)

3106  
ªt
;

3108 
ªt
 = 
	`gíîic_wrôe_check_limôs
(
fûe_out
, 
pos_out
, &
cou¡
);

3109 i‡(
ªt
)

3110  
ªt
;

3119 i‡(
pos_ö
 + 
cou¡
 =
size_ö
) {

3120 
bcou¡
 = 
	`ALIGN
(
size_ö
, 
bs
Ë- 
pos_ö
;

3122 i‡(!
	`IS_ALIGNED
(
cou¡
, 
bs
))

3123 
cou¡
 = 
	`ALIGN_DOWN
(cou¡, 
bs
);

3124 
bcou¡
 = 
cou¡
;

3128 i‡(
öode_ö
 =
öode_out
 &&

3129 
pos_out
 + 
bcou¡
 > 
pos_ö
 &&

3130 
pos_out
 < 
pos_ö
 + 
bcou¡
)

3131  -
EINVAL
;

3137 i‡(*
ªq_cou¡
 !
cou¡
 && !(
ªm≠_Êags
 & 
REMAP_FILE_CAN_SHORTEN
))

3138  -
EINVAL
;

3140 *
ªq_cou¡
 = 
cou¡
;

3142 
	}
}

3144 
	$∑geˇche_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3145 
loff_t
 
pos
, 
Àn
, 
Êags
,

3146 
∑ge
 **
∑gï
, **
fsd©a
)

3148 c⁄° 
addªss_•a˚_›î©i⁄s
 *
a›s
 = 
m≠pög
->
a_›s
;

3150  
a›s
->
	`wrôe_begö
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
Êags
,

3151 
∑gï
, 
fsd©a
);

3152 
	}
}

3155 
	$∑geˇche_wrôe_íd
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3156 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3157 
∑ge
 *∑ge, *
fsd©a
)

3159 c⁄° 
addªss_•a˚_›î©i⁄s
 *
a›s
 = 
m≠pög
->
a_›s
;

3161  
a›s
->
	`wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3162 
	}
}

3165 
ssize_t


3166 
	$gíîic_fûe_dúe˘_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

3168 
fûe
 *fûê
iocb
->
ki_fûp
;

3169 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

3170 
öode
 *öodê
m≠pög
->
ho°
;

3171 
loff_t
 
pos
 = 
iocb
->
ki_pos
;

3172 
ssize_t
 
wrôãn
;

3173 
size_t
 
wrôe_Àn
;

3174 
pgoff_t
 
íd
;

3176 
wrôe_Àn
 = 
	`iov_ôî_cou¡
(
‰om
);

3177 
íd
 = (
pos
 + 
wrôe_Àn
 - 1Ë>> 
PAGE_SHIFT
;

3179 i‡(
iocb
->
ki_Êags
 & 
IOCB_NOWAIT
) {

3181 i‡(
	`fûem≠_ønge_has_∑ge
(
öode
->
i_m≠pög
, 
pos
,

3182 
pos
 + 
wrôe_Àn
 - 1))

3183  -
EAGAIN
;

3185 
wrôãn
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
pos
,

3186 
pos
 + 
wrôe_Àn
 - 1);

3187 i‡(
wrôãn
)

3188 
out
;

3197 
wrôãn
 = 
	`övÆid©e_öode_∑ges2_ønge
(
m≠pög
,

3198 
pos
 >> 
PAGE_SHIFT
, 
íd
);

3203 i‡(
wrôãn
) {

3204 i‡(
wrôãn
 =-
EBUSY
)

3206 
out
;

3209 
wrôãn
 = 
m≠pög
->
a_›s
->
	`dúe˘_IO
(
iocb
, 
‰om
);

3224 i‡(
m≠pög
->
ƒ∑ges
)

3225 
	`övÆid©e_öode_∑ges2_ønge
(
m≠pög
,

3226 
pos
 >> 
PAGE_SHIFT
, 
íd
);

3228 i‡(
wrôãn
 > 0) {

3229 
pos
 +
wrôãn
;

3230 
wrôe_Àn
 -
wrôãn
;

3231 i‡(
pos
 > 
	`i_size_ªad
(
öode
Ë&& !
	`S_ISBLK
(öode->
i_mode
)) {

3232 
	`i_size_wrôe
(
öode
, 
pos
);

3233 
	`m¨k_öode_dúty
(
öode
);

3235 
iocb
->
ki_pos
 = 
pos
;

3237 
	`iov_ôî_ªvît
(
‰om
, 
wrôe_Àn
 - 
	`iov_ôî_cou¡
(from));

3238 
out
:

3239  
wrôãn
;

3240 
	}
}

3247 
∑ge
 *
	$gøb_ˇche_∑ge_wrôe_begö
(
addªss_•a˚
 *
m≠pög
,

3248 
pgoff_t
 
ödex
, 
Êags
)

3250 
∑ge
 *page;

3251 
fgp_Êags
 = 
FGP_LOCK
|
FGP_WRITE
|
FGP_CREAT
;

3253 i‡(
Êags
 & 
AOP_FLAG_NOFS
)

3254 
fgp_Êags
 |
FGP_NOFS
;

3256 
∑ge
 = 
	`∑geˇche_gë_∑ge
(
m≠pög
, 
ödex
, 
fgp_Êags
,

3257 
	`m≠pög_gÂ_mask
(
m≠pög
));

3258 i‡(
∑ge
)

3259 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

3261  
∑ge
;

3262 
	}
}

3265 
ssize_t
 
	$gíîic_≥rf‹m_wrôe
(
fûe
 *file,

3266 
iov_ôî
 *
i
, 
loff_t
 
pos
)

3268 
addªss_•a˚
 *
m≠pög
 = 
fûe
->
f_m≠pög
;

3269 c⁄° 
addªss_•a˚_›î©i⁄s
 *
a_›s
 = 
m≠pög
->a_ops;

3270 
°©us
 = 0;

3271 
ssize_t
 
wrôãn
 = 0;

3272 
Êags
 = 0;

3275 
∑ge
 *page;

3276 
off£t
;

3277 
byãs
;

3278 
size_t
 
c›õd
;

3279 *
fsd©a
;

3281 
off£t
 = (
pos
 & (
PAGE_SIZE
 - 1));

3282 
byãs
 = 
	`mö_t
(, 
PAGE_SIZE
 - 
off£t
,

3283 
	`iov_ôî_cou¡
(
i
));

3285 
agaö
:

3296 i‡(
	`u∆ikñy
(
	`iov_ôî_Áu…_ö_ªadabÀ
(
i
, 
byãs
))) {

3297 
°©us
 = -
EFAULT
;

3301 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

3302 
°©us
 = -
EINTR
;

3306 
°©us
 = 
a_›s
->
	`wrôe_begö
(
fûe
, 
m≠pög
, 
pos
, 
byãs
, 
Êags
,

3307 &
∑ge
, &
fsd©a
);

3308 i‡(
	`u∆ikñy
(
°©us
 < 0))

3311 i‡(
	`m≠pög_wrôably_m≠≥d
(
m≠pög
))

3312 
	`Êush_dˇche_∑ge
(
∑ge
);

3314 
c›õd
 = 
	`iov_ôî_c›y_‰om_u£r_©omic
(
∑ge
, 
i
, 
off£t
, 
byãs
);

3315 
	`Êush_dˇche_∑ge
(
∑ge
);

3317 
°©us
 = 
a_›s
->
	`wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
byãs
, 
c›õd
,

3318 
∑ge
, 
fsd©a
);

3319 i‡(
	`u∆ikñy
(
°©us
 < 0))

3321 
c›õd
 = 
°©us
;

3323 
	`c⁄d_ªsched
();

3325 
	`iov_ôî_adv™˚
(
i
, 
c›õd
);

3326 i‡(
	`u∆ikñy
(
c›õd
 == 0)) {

3335 
byãs
 = 
	`mö_t
(, 
PAGE_SIZE
 - 
off£t
,

3336 
	`iov_ôî_sögÀ_£g_cou¡
(
i
));

3337 
agaö
;

3339 
pos
 +
c›õd
;

3340 
wrôãn
 +
c›õd
;

3342 
	`bÆ™˚_dúty_∑ges_øãlimôed
(
m≠pög
);

3343 } 
	`iov_ôî_cou¡
(
i
));

3345  
wrôãn
 ? wrôã¿: 
°©us
;

3346 
	}
}

3370 
ssize_t
 
	$__gíîic_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

3372 
fûe
 *fûê
iocb
->
ki_fûp
;

3373 
addªss_•a˚
 * 
m≠pög
 = 
fûe
->
f_m≠pög
;

3374 
öode
 *öodê
m≠pög
->
ho°
;

3375 
ssize_t
 
wrôãn
 = 0;

3376 
ssize_t
 
îr
;

3377 
ssize_t
 
°©us
;

3380 
cuºít
->
backög_dev_öfo
 = 
	`öode_to_bdi
(
öode
);

3381 
îr
 = 
	`fûe_ªmove_¥ivs
(
fûe
);

3382 i‡(
îr
)

3383 
out
;

3385 
îr
 = 
	`fûe_upd©e_time
(
fûe
);

3386 i‡(
îr
)

3387 
out
;

3389 i‡(
iocb
->
ki_Êags
 & 
IOCB_DIRECT
) {

3390 
loff_t
 
pos
, 
ídbyã
;

3392 
wrôãn
 = 
	`gíîic_fûe_dúe˘_wrôe
(
iocb
, 
‰om
);

3400 i‡(
wrôãn
 < 0 || !
	`iov_ôî_cou¡
(
‰om
Ë|| 
	`IS_DAX
(
öode
))

3401 
out
;

3403 
°©us
 = 
	`gíîic_≥rf‹m_wrôe
(
fûe
, 
‰om
, 
pos
 = 
iocb
->
ki_pos
);

3411 i‡(
	`u∆ikñy
(
°©us
 < 0)) {

3412 
îr
 = 
°©us
;

3413 
out
;

3420 
ídbyã
 = 
pos
 + 
°©us
 - 1;

3421 
îr
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
pos
, 
ídbyã
);

3422 i‡(
îr
 == 0) {

3423 
iocb
->
ki_pos
 = 
ídbyã
 + 1;

3424 
wrôãn
 +
°©us
;

3425 
	`övÆid©e_m≠pög_∑ges
(
m≠pög
,

3426 
pos
 >> 
PAGE_SHIFT
,

3427 
ídbyã
 >> 
PAGE_SHIFT
);

3435 
wrôãn
 = 
	`gíîic_≥rf‹m_wrôe
(
fûe
, 
‰om
, 
iocb
->
ki_pos
);

3436 i‡(
	`likñy
(
wrôãn
 > 0))

3437 
iocb
->
ki_pos
 +
wrôãn
;

3439 
out
:

3440 
cuºít
->
backög_dev_öfo
 = 
NULL
;

3441  
wrôãn
 ? wrôã¿: 
îr
;

3442 
	}
}

3458 
ssize_t
 
	$gíîic_fûe_wrôe_ôî
(
kiocb
 *
iocb
, 
iov_ôî
 *
‰om
)

3460 
fûe
 *fûê
iocb
->
ki_fûp
;

3461 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3462 
ssize_t
 
ªt
;

3464 
	`öode_lock
(
öode
);

3465 
ªt
 = 
	`gíîic_wrôe_checks
(
iocb
, 
‰om
);

3466 i‡(
ªt
 > 0)

3467 
ªt
 = 
	`__gíîic_fûe_wrôe_ôî
(
iocb
, 
‰om
);

3468 
	`öode_u∆ock
(
öode
);

3470 i‡(
ªt
 > 0)

3471 
ªt
 = 
	`gíîic_wrôe_sync
(
iocb
,Ñet);

3472  
ªt
;

3473 
	}
}

3493 
	$åy_to_ªÀa£_∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
gÂ_mask
)

3495 
addªss_•a˚
 * c⁄° 
m≠pög
 = 
∑ge
->mapping;

3497 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

3498 i‡(
	`PageWrôeback
(
∑ge
))

3501 i‡(
m≠pög
 && m≠pög->
a_›s
->
ªÀa£∑ge
)

3502  
m≠pög
->
a_›s
->
	`ªÀa£∑ge
(
∑ge
, 
gÂ_mask
);

3503  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3504 
	}
}

	@fsmap.c

7 
	~"pxt4.h
"

8 
	~<löux/fsm≠.h
>

9 
	~"fsm≠.h
"

10 
	~"mbÆloc.h
"

11 
	~<löux/s‹t.h
>

12 
	~<löux/li°_s‹t.h
>

13 
	~<åa˚/evíts/pxt4.h
>

16 
	$pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

17 
pxt4_fsm≠
 *
§c
)

19 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

20 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

21 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»<< 
sb
->
s_blocksize_bôs
;

22 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

23 
de°
->
fmr_off£t
 = 0;

24 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth << 
sb
->
s_blocksize_bôs
;

25 
de°
->
fmr_ª£rved
[0] = 0;

26 
de°
->
fmr_ª£rved
[1] = 0;

27 
de°
->
fmr_ª£rved
[2] = 0;

28 
	}
}

31 
	$pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

32 
fsm≠
 *
§c
)

34 
de°
->
fmr_devi˚
 = 
§c
->fmr_device;

35 
de°
->
fmr_Êags
 = 
§c
->fmr_flags;

36 
de°
->
fmr_physiˇl
 = 
§c
->fmr_physiˇ»>> 
sb
->
s_blocksize_bôs
;

37 
de°
->
fmr_ow√r
 = 
§c
->fmr_owner;

38 
de°
->
fmr_Àngth
 = 
§c
->fmr_Àngth >> 
sb
->
s_blocksize_bôs
;

39 
	}
}

42 
	spxt4_gëfsm≠_öfo
 {

43 
pxt4_fsm≠_hód
 *
	mgfi_hód
;

44 
pxt4_fsm≠_f‹m©_t
 
	mgfi_f‹m©ãr
;

45 *
	mgfi_f‹m©_¨g
;

46 
pxt4_fsblk_t
 
	mgfi_√xt_fsblk
;

47 
u32
 
	mgfi_dev
;

48 
pxt4_group_t
 
	mgfi_agno
;

49 
pxt4_fsm≠
 
	mgfi_low
;

50 
pxt4_fsm≠
 
	mgfi_high
;

51 
pxt4_fsm≠
 
	mgfi_œ°‰ì
;

52 
li°_hód
 
	mgfi_mëa_li°
;

53 
boﬁ
 
	mgfi_œ°
;

57 
	spxt4_gëfsm≠_dev
 {

58 (*
	mgfd_‚
)(
su≥r_block
 *
	msb
,

59 
pxt4_fsm≠
 *
	mkeys
,

60 
pxt4_gëfsm≠_öfo
 *
	möfo
);

61 
u32
 
	mgfd_dev
;

65 
	$pxt4_gëfsm≠_dev_com∑ª
(c⁄° *
p1
, c⁄° *
p2
)

67 c⁄° 
pxt4_gëfsm≠_dev
 *
d1
 = 
p1
;

68 c⁄° 
pxt4_gëfsm≠_dev
 *
d2
 = 
p2
;

70  
d1
->
gfd_dev
 - 
d2
->gfd_dev;

71 
	}
}

74 
boﬁ
 
	$pxt4_gëfsm≠_ªc_bef‹e_low_key
(
pxt4_gëfsm≠_öfo
 *
öfo
,

75 
pxt4_fsm≠
 *
ªc
)

77  
ªc
->
fmr_physiˇl
 < 
öfo
->
gfi_low
.fmr_physical;

78 
	}
}

84 
	$pxt4_gëfsm≠_hñ≥r
(
su≥r_block
 *
sb
,

85 
pxt4_gëfsm≠_öfo
 *
öfo
,

86 
pxt4_fsm≠
 *
ªc
)

88 
pxt4_fsm≠
 
fmr
;

89 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

90 
pxt4_fsblk_t
 
ªc_fsblk
 = 
ªc
->
fmr_physiˇl
;

91 
pxt4_group_t
 
agno
;

92 
pxt4_gΩblk_t
 
˙o
;

93 
îr‹
;

95 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

96  -
EINTR
;

102 i‡(
	`pxt4_gëfsm≠_ªc_bef‹e_low_key
(
öfo
, 
ªc
)) {

103 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

104 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

105 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

106  
PXT4_QUERY_RANGE_CONTINUE
;

110 i‡(
öfo
->
gfi_hód
->
fmh_cou¡
 == 0) {

111 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
)

112 
öfo
->
gfi_hód
->
fmh_íåõs
++;

114 i‡(
öfo
->
gfi_œ°
)

115  
PXT4_QUERY_RANGE_CONTINUE
;

117 
öfo
->
gfi_hód
->
fmh_íåõs
++;

119 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

120 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

121 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

122  
PXT4_QUERY_RANGE_CONTINUE
;

130 i‡(
ªc_fsblk
 > 
öfo
->
gfi_√xt_fsblk
) {

131 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

132  
PXT4_QUERY_RANGE_ABORT
;

134 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
öfo
->
gfi_√xt_fsblk
,

135 &
agno
, &
˙o
);

136 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
,

137 
	`PXT4_C2B
(
sbi
, 
˙o
),

138 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
,

139 
PXT4_FMR_OWN_UNKNOWN
);

141 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

142 
fmr
.
fmr_physiˇl
 = 
öfo
->
gfi_√xt_fsblk
;

143 
fmr
.
fmr_ow√r
 = 
PXT4_FMR_OWN_UNKNOWN
;

144 
fmr
.
fmr_Àngth
 = 
ªc_fsblk
 - 
öfo
->
gfi_√xt_fsblk
;

145 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

146 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

147 i‡(
îr‹
)

148  
îr‹
;

149 
öfo
->
gfi_hód
->
fmh_íåõs
++;

152 i‡(
öfo
->
gfi_œ°
)

153 
out
;

156 i‡(
öfo
->
gfi_hód
->
fmh_íåõs
 >öfo->gfi_hód->
fmh_cou¡
)

157  
PXT4_QUERY_RANGE_ABORT
;

159 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
ªc_fsblk
, &
agno
, &
˙o
);

160 
	`åa˚_pxt4_fsm≠_m≠pög
(
sb
, 
öfo
->
gfi_dev
, 
agno
, 
	`PXT4_C2B
(
sbi
, 
˙o
),

161 
ªc
->
fmr_Àngth
,Ñec->
fmr_ow√r
);

163 
fmr
.
fmr_devi˚
 = 
öfo
->
gfi_dev
;

164 
fmr
.
fmr_physiˇl
 = 
ªc_fsblk
;

165 
fmr
.
fmr_ow√r
 = 
ªc
->fmr_owner;

166 
fmr
.
fmr_Êags
 = 
FMR_OF_SPECIAL_OWNER
;

167 
fmr
.
fmr_Àngth
 = 
ªc
->fmr_length;

168 
îr‹
 = 
öfo
->
	`gfi_f‹m©ãr
(&
fmr
, info->
gfi_f‹m©_¨g
);

169 i‡(
îr‹
)

170  
îr‹
;

171 
öfo
->
gfi_hód
->
fmh_íåõs
++;

173 
out
:

174 
ªc_fsblk
 +
ªc
->
fmr_Àngth
;

175 i‡(
öfo
->
gfi_√xt_fsblk
 < 
ªc_fsblk
)

176 
öfo
->
gfi_√xt_fsblk
 = 
ªc_fsblk
;

177  
PXT4_QUERY_RANGE_CONTINUE
;

178 
	}
}

180 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_fsm≠_√xt_pblk
(
pxt4_fsm≠
 *
fmr
)

182  
fmr
->
fmr_physiˇl
 + fmr->
fmr_Àngth
;

183 
	}
}

186 
	$pxt4_gëfsm≠_d©adev_hñ≥r
(
su≥r_block
 *
sb
,

187 
pxt4_group_t
 
agno
, 
pxt4_gΩblk_t
 
°¨t
,

188 
pxt4_gΩblk_t
 
Àn
, *
¥iv
)

190 
pxt4_fsm≠
 
úec
;

191 
pxt4_gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

192 
pxt4_fsm≠
 *
p
;

193 
pxt4_fsm≠
 *
tmp
;

194 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

195 
pxt4_fsblk_t
 
fsb
;

196 
pxt4_fsblk_t
 
f¶í
;

197 
îr‹
;

199 
fsb
 = (
	`PXT4_C2B
(
sbi
, 
°¨t
Ë+ 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
));

200 
f¶í
 = 
	`PXT4_C2B
(
sbi
, 
Àn
);

203 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

205 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
öfo
->
gfi_œ°‰ì
Ë=
fsb
) {

206 
öfo
->
gfi_œ°‰ì
.
fmr_Àngth
 +
f¶í
;

214 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

215 i‡(
îr‹
)

216  
îr‹
;

217 
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
 = 0;

221 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, &
öfo
->
gfi_mëa_li°
, 
fmr_li°
) {

222 i‡(
p
->
fmr_physiˇl
 +Ö->
fmr_Àngth
 <
öfo
->
gfi_√xt_fsblk
) {

223 
	`li°_dñ
(&
p
->
fmr_li°
);

224 
	`k‰ì
(
p
);

225 } i‡(
p
->
fmr_physiˇl
 < 
fsb
) {

226 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, 
p
);

227 i‡(
îr‹
)

228  
îr‹
;

230 
	`li°_dñ
(&
p
->
fmr_li°
);

231 
	`k‰ì
(
p
);

235 
úec
.
fmr_devi˚
 = 0;

236 
úec
.
fmr_physiˇl
 = 
fsb
;

237 
úec
.
fmr_Àngth
 = 
f¶í
;

238 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_FREE
;

239 
úec
.
fmr_Êags
 = 0;

242 i‡(
	`pxt4_fsm≠_√xt_pblk
(&
úec
) ==

243 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
 + 1)) {

244 
öfo
->
gfi_œ°‰ì
 = 
úec
;

249  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

250 
	}
}

253 
	$pxt4_gëfsm≠_logdev
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
keys
,

254 
pxt4_gëfsm≠_öfo
 *
öfo
)

256 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

257 
pxt4_fsm≠
 
úec
;

260 
öfo
->
gfi_low
 = 
keys
[0];

261 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

263 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

265 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, 0,

266 
öfo
->
gfi_low
.
fmr_physiˇl
,

267 
öfo
->
gfi_low
.
fmr_Àngth
,

268 
öfo
->
gfi_low
.
fmr_ow√r
);

270 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, 0,

271 
öfo
->
gfi_high
.
fmr_physiˇl
,

272 
öfo
->
gfi_high
.
fmr_Àngth
,

273 
öfo
->
gfi_high
.
fmr_ow√r
);

275 i‡(
keys
[0].
fmr_physiˇl
 > 0)

279 
úec
.
fmr_physiˇl
 = 
jou∫Æ
->
j_blk_off£t
;

280 
úec
.
fmr_Àngth
 = 
jou∫Æ
->
j_maxÀn
;

281 
úec
.
fmr_ow√r
 = 
PXT4_FMR_OWN_LOG
;

282 
úec
.
fmr_Êags
 = 0;

284  
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &
úec
);

285 
	}
}

288 
ölöe
 
	$pxt4_gëfsm≠_fûl
(
li°_hód
 *
mëa_li°
,

289 
pxt4_fsblk_t
 
fsb
,Öxt4_fsblk_à
Àn
,

290 
uöt64_t
 
ow√r
)

292 
pxt4_fsm≠
 *
fsm
;

294 
fsm
 = 
	`kmÆloc
((*fsm), 
GFP_NOFS
);

295 i‡(!
fsm
)

296  -
ENOMEM
;

297 
fsm
->
fmr_devi˚
 = 0;

298 
fsm
->
fmr_Êags
 = 0;

299 
fsm
->
fmr_physiˇl
 = 
fsb
;

300 
fsm
->
fmr_ow√r
 = 
ow√r
;

301 
fsm
->
fmr_Àngth
 = 
Àn
;

302 
	`li°_add_èû
(&
fsm
->
fmr_li°
, 
mëa_li°
);

305 
	}
}

311 
	$pxt4_gëfsm≠_föd_sb
(
su≥r_block
 *
sb
,

312 
pxt4_group_t
 
agno
,

313 
li°_hód
 *
mëa_li°
)

315 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

316 
pxt4_fsblk_t
 
fsb
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
agno
);

317 
pxt4_fsblk_t
 
Àn
;

318 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

319 
mëagroup
 = 
agno
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

320 
îr‹
;

323 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
agno
)) {

324 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 1, 
PXT4_FMR_OWN_FS
);

325 i‡(
îr‹
)

326  
îr‹
;

327 
fsb
++;

331 
Àn
 = 
	`pxt4_bg_num_gdb
(
sb
, 
agno
);

332 i‡(!
Àn
)

334 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

335 
PXT4_FMR_OWN_GDT
);

336 i‡(
îr‹
)

337  
îr‹
;

338 
fsb
 +
Àn
;

341 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
mëagroup
 < 
fú°_mëa_bg
) {

342 
Àn
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
);

343 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
, 
fsb
, 
Àn
,

344 
PXT4_FMR_OWN_RESV_GDT
);

345 i‡(
îr‹
)

346  
îr‹
;

350 
	}
}

353 
	$pxt4_gëfsm≠_com∑ª
(*
¥iv
,

354 
li°_hód
 *
a
,

355 
li°_hód
 *
b
)

357 
pxt4_fsm≠
 *
Á
;

358 
pxt4_fsm≠
 *
fb
;

360 
Á
 = 
	`c⁄èöî_of
(
a
, 
pxt4_fsm≠
, 
fmr_li°
);

361 
fb
 = 
	`c⁄èöî_of
(
b
, 
pxt4_fsm≠
, 
fmr_li°
);

362 i‡(
Á
->
fmr_physiˇl
 < 
fb
->fmr_physical)

364 i‡(
Á
->
fmr_physiˇl
 > 
fb
->fmr_physical)

367 
	}
}

370 
	$pxt4_gëfsm≠_mîge_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

372 
pxt4_fsm≠
 *
p
;

373 
pxt4_fsm≠
 *
¥ev
 = 
NULL
;

374 
pxt4_fsm≠
 *
tmp
;

376 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

377 i‡(!
¥ev
) {

378 
¥ev
 = 
p
;

382 i‡(
¥ev
->
fmr_ow√r
 =
p
->fmr_owner &&

383 
¥ev
->
fmr_physiˇl
 +Öªv->
fmr_Àngth
 =
p
->fmr_physical) {

384 
¥ev
->
fmr_Àngth
 +
p
->fmr_length;

385 
	`li°_dñ
(&
p
->
fmr_li°
);

386 
	`k‰ì
(
p
);

388 
¥ev
 = 
p
;

390 
	}
}

393 
	$pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
li°_hód
 *
mëa_li°
)

395 
pxt4_fsm≠
 *
p
;

396 
pxt4_fsm≠
 *
tmp
;

398 
	`li°_f‹_óch_íåy_ß„
(
p
, 
tmp
, 
mëa_li°
, 
fmr_li°
) {

399 
	`li°_dñ
(&
p
->
fmr_li°
);

400 
	`k‰ì
(
p
);

402 
	}
}

405 
	$pxt4_gëfsm≠_föd_fixed_mëad©a
(
su≥r_block
 *
sb
,

406 
li°_hód
 *
mëa_li°
)

408 
pxt4_group_desc
 *
gdp
;

409 
pxt4_group_t
 
agno
;

410 
îr‹
;

412 
	`INIT_LIST_HEAD
(
mëa_li°
);

415 
agno
 = 0;ágnÿ< 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;ágno++) {

416 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
agno
, 
NULL
);

417 i‡(!
gdp
) {

418 
îr‹
 = -
EFSCORRUPTED
;

419 
îr
;

423 
îr‹
 = 
	`pxt4_gëfsm≠_föd_sb
(
sb
, 
agno
, 
mëa_li°
);

424 i‡(
îr‹
)

425 
îr
;

428 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

429 
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 1,

430 
PXT4_FMR_OWN_BLKBM
);

431 i‡(
îr‹
)

432 
îr
;

435 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

436 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 1,

437 
PXT4_FMR_OWN_INOBM
);

438 i‡(
îr‹
)

439 
îr
;

442 
îr‹
 = 
	`pxt4_gëfsm≠_fûl
(
mëa_li°
,

443 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

444 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
,

445 
PXT4_FMR_OWN_INODES
);

446 i‡(
îr‹
)

447 
îr
;

451 
	`li°_s‹t
(
NULL
, 
mëa_li°
, 
pxt4_gëfsm≠_com∑ª
);

454 
	`pxt4_gëfsm≠_mîge_fixed_mëad©a
(
mëa_li°
);

457 
îr
:

458 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(
mëa_li°
);

459  
îr‹
;

460 
	}
}

463 
	$pxt4_gëfsm≠_d©adev
(
su≥r_block
 *
sb
,

464 
pxt4_fsm≠
 *
keys
,

465 
pxt4_gëfsm≠_öfo
 *
öfo
)

467 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

468 
pxt4_fsblk_t
 
°¨t_fsb
;

469 
pxt4_fsblk_t
 
íd_fsb
;

470 
pxt4_fsblk_t
 
bofs
;

471 
pxt4_fsblk_t
 
eofs
;

472 
pxt4_group_t
 
°¨t_ag
;

473 
pxt4_group_t
 
íd_ag
;

474 
pxt4_gΩblk_t
 
fú°_˛u°î
;

475 
pxt4_gΩblk_t
 
œ°_˛u°î
;

476 
îr‹
 = 0;

478 
bofs
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

479 
eofs
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
);

480 i‡(
keys
[0].
fmr_physiˇl
 >
eofs
)

482 i‡(
keys
[0].
fmr_physiˇl
 < 
bofs
)

483 
keys
[0].
fmr_physiˇl
 = 
bofs
;

484 i‡(
keys
[1].
fmr_physiˇl
 >
eofs
)

485 
keys
[1].
fmr_physiˇl
 = 
eofs
 - 1;

486 
°¨t_fsb
 = 
keys
[0].
fmr_physiˇl
;

487 
íd_fsb
 = 
keys
[1].
fmr_physiˇl
;

490 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t_fsb
, &
°¨t_ag
, &
fú°_˛u°î
);

491 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
íd_fsb
, &
íd_ag
, &
œ°_˛u°î
);

498 
öfo
->
gfi_low
 = 
keys
[0];

499 
öfo
->
gfi_low
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
);

500 
öfo
->
gfi_low
.
fmr_Àngth
 = 0;

502 
	`mem£t
(&
öfo
->
gfi_high
, 0xFF, (info->gfi_high));

505 
îr‹
 = 
	`pxt4_gëfsm≠_föd_fixed_mëad©a
(
sb
, &
öfo
->
gfi_mëa_li°
);

506 i‡(
îr‹
)

507 
îr
;

510 
öfo
->
gfi_agno
 = 
°¨t_ag
;

511 
öfo
->
gfi_agno
 <
íd_ag
;

512 
öfo
->
gfi_agno
++) {

517 i‡(
öfo
->
gfi_agno
 =
íd_ag
) {

518 
öfo
->
gfi_high
 = 
keys
[1];

519 
öfo
->
gfi_high
.
fmr_physiˇl
 = 
	`PXT4_C2B
(
sbi
,

520 
œ°_˛u°î
);

521 
öfo
->
gfi_high
.
fmr_Àngth
 = 0;

524 
	`åa˚_pxt4_fsm≠_low_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

525 
öfo
->
gfi_low
.
fmr_physiˇl
,

526 
öfo
->
gfi_low
.
fmr_Àngth
,

527 
öfo
->
gfi_low
.
fmr_ow√r
);

529 
	`åa˚_pxt4_fsm≠_high_key
(
sb
, 
öfo
->
gfi_dev
, info->
gfi_agno
,

530 
öfo
->
gfi_high
.
fmr_physiˇl
,

531 
öfo
->
gfi_high
.
fmr_Àngth
,

532 
öfo
->
gfi_high
.
fmr_ow√r
);

534 
îr‹
 = 
	`pxt4_mbÆloc_quîy_ønge
(
sb
, 
öfo
->
gfi_agno
,

535 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_low
.
fmr_physiˇl
),

536 
	`PXT4_B2C
(
sbi
, 
öfo
->
gfi_high
.
fmr_physiˇl
),

537 
pxt4_gëfsm≠_d©adev_hñ≥r
, 
öfo
);

538 i‡(
îr‹
)

539 
îr
;

545 i‡(
öfo
->
gfi_agno
 =
°¨t_ag
)

546 
	`mem£t
(&
öfo
->
gfi_low
, 0, (info->gfi_low));

550 i‡(
öfo
->
gfi_œ°‰ì
.
fmr_ow√r
) {

551 
îr‹
 = 
	`pxt4_gëfsm≠_hñ≥r
(
sb
, 
öfo
, &öfo->
gfi_œ°‰ì
);

552 i‡(
îr‹
)

553 
îr
;

557 
öfo
->
gfi_œ°
 = 
åue
;

558 
îr‹
 = 
	`pxt4_gëfsm≠_d©adev_hñ≥r
(
sb
, 
íd_ag
, 
œ°_˛u°î
, 0, 
öfo
);

559 i‡(
îr‹
)

560 
îr
;

562 
îr
:

563 
	`pxt4_gëfsm≠_‰ì_fixed_mëad©a
(&
öfo
->
gfi_mëa_li°
);

564  
îr‹
;

565 
	}
}

568 
boﬁ
 
	$pxt4_gëfsm≠_is_vÆid_devi˚
(
su≥r_block
 *
sb
,

569 
pxt4_fsm≠
 *
fm
)

571 i‡(
fm
->
fmr_devi˚
 =0 || fm->fmr_devi˚ =
UINT_MAX
 ||

572 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
))

573  
åue
;

574 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 &&

575 
fm
->
fmr_devi˚
 =
	`√w_ícode_dev
(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
))

576  
åue
;

577  
Ál£
;

578 
	}
}

581 
boﬁ
 
	$pxt4_gëfsm≠_check_keys
(
pxt4_fsm≠
 *
low_key
,

582 
pxt4_fsm≠
 *
high_key
)

584 i‡(
low_key
->
fmr_devi˚
 > 
high_key
->fmr_device)

585  
Ál£
;

586 i‡(
low_key
->
fmr_devi˚
 < 
high_key
->fmr_device)

587  
åue
;

589 i‡(
low_key
->
fmr_physiˇl
 > 
high_key
->fmr_physical)

590  
Ál£
;

591 i‡(
low_key
->
fmr_physiˇl
 < 
high_key
->fmr_physical)

592  
åue
;

594 i‡(
low_key
->
fmr_ow√r
 > 
high_key
->fmr_owner)

595  
Ál£
;

596 i‡(
low_key
->
fmr_ow√r
 < 
high_key
->fmr_owner)

597  
åue
;

599  
Ál£
;

600 
	}
}

602 
	#PXT4_GETFSMAP_DEVS
 2

	)

624 
	$pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

625 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
)

627 
pxt4_fsm≠
 
dkeys
[2];

628 
pxt4_gëfsm≠_dev
 
h™dÀrs
[
PXT4_GETFSMAP_DEVS
];

629 
pxt4_gëfsm≠_öfo
 
öfo
 = {0};

630 
i
;

631 
îr‹
 = 0;

633 i‡(
hód
->
fmh_iÊags
 & ~
FMH_IF_VALID
)

634  -
EINVAL
;

635 i‡(!
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[0]) ||

636 !
	`pxt4_gëfsm≠_is_vÆid_devi˚
(
sb
, &
hód
->
fmh_keys
[1]))

637  -
EINVAL
;

639 
hód
->
fmh_íåõs
 = 0;

642 
	`mem£t
(
h™dÀrs
, 0, (handlers));

643 
h™dÀrs
[0].
gfd_dev
 = 
	`√w_ícode_dev
(
sb
->
s_bdev
->
bd_dev
);

644 
h™dÀrs
[0].
gfd_‚
 = 
pxt4_gëfsm≠_d©adev
;

645 i‡(
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
) {

646 
h™dÀrs
[1].
gfd_dev
 = 
	`√w_ícode_dev
(

647 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
->
bd_dev
);

648 
h™dÀrs
[1].
gfd_‚
 = 
pxt4_gëfsm≠_logdev
;

651 
	`s‹t
(
h™dÀrs
, 
PXT4_GETFSMAP_DEVS
, (
pxt4_gëfsm≠_dev
),

652 
pxt4_gëfsm≠_dev_com∑ª
, 
NULL
);

665 
dkeys
[0] = 
hód
->
fmh_keys
[0];

666 
dkeys
[0].
fmr_physiˇl
 +dkeys[0].
fmr_Àngth
;

667 
dkeys
[0].
fmr_ow√r
 = 0;

668 
dkeys
[0].
fmr_Àngth
 = 0;

669 
	`mem£t
(&
dkeys
[1], 0xFF, (
pxt4_fsm≠
));

671 i‡(!
	`pxt4_gëfsm≠_check_keys
(
dkeys
, &
hód
->
fmh_keys
[1]))

672  -
EINVAL
;

674 
öfo
.
gfi_√xt_fsblk
 = 
hód
->
fmh_keys
[0].
fmr_physiˇl
 +

675 
hód
->
fmh_keys
[0].
fmr_Àngth
;

676 
öfo
.
gfi_f‹m©ãr
 = 
f‹m©ãr
;

677 
öfo
.
gfi_f‹m©_¨g
 = 
¨g
;

678 
öfo
.
gfi_hód
 = 
hód
;

681 
i
 = 0; i < 
PXT4_GETFSMAP_DEVS
; i++) {

683 i‡(!
h™dÀrs
[
i
].
gfd_‚
)

685 i‡(
hód
->
fmh_keys
[0].
fmr_devi˚
 > 
h™dÀrs
[
i
].
gfd_dev
)

687 i‡(
hód
->
fmh_keys
[1].
fmr_devi˚
 < 
h™dÀrs
[
i
].
gfd_dev
)

697 i‡(
h™dÀrs
[
i
].
gfd_dev
 =
hód
->
fmh_keys
[1].
fmr_devi˚
)

698 
dkeys
[1] = 
hód
->
fmh_keys
[1];

699 i‡(
h™dÀrs
[
i
].
gfd_dev
 > 
hód
->
fmh_keys
[0].
fmr_devi˚
)

700 
	`mem£t
(&
dkeys
[0], 0, (
pxt4_fsm≠
));

702 
öfo
.
gfi_dev
 = 
h™dÀrs
[
i
].
gfd_dev
;

703 
öfo
.
gfi_œ°
 = 
Ál£
;

704 
öfo
.
gfi_agno
 = -1;

705 
îr‹
 = 
h™dÀrs
[
i
].
	`gfd_‚
(
sb
, 
dkeys
, &
öfo
);

706 i‡(
îr‹
)

708 
öfo
.
gfi_√xt_fsblk
 = 0;

711 
hód
->
fmh_oÊags
 = 
FMH_OF_DEV_T
;

712  
îr‹
;

713 
	}
}

	@fsmap.h

7 #i‚de‡
__PXT4_FSMAP_H__


8 
	#__PXT4_FSMAP_H__


	)

10 
	gfsm≠
;

13 
	spxt4_fsm≠
 {

14 
li°_hód
 
	mfmr_li°
;

15 
dev_t
 
	mfmr_devi˚
;

16 
uöt32_t
 
	mfmr_Êags
;

17 
uöt64_t
 
	mfmr_physiˇl
;

18 
uöt64_t
 
	mfmr_ow√r
;

19 
uöt64_t
 
	mfmr_Àngth
;

22 
	spxt4_fsm≠_hód
 {

23 
uöt32_t
 
	mfmh_iÊags
;

24 
uöt32_t
 
	mfmh_oÊags
;

25 
	mfmh_cou¡
;

26 
	mfmh_íåõs
;

28 
pxt4_fsm≠
 
	mfmh_keys
[2];

31 
pxt4_fsm≠_‰om_öã∫Æ
(
su≥r_block
 *
sb
, 
fsm≠
 *
de°
,

32 
pxt4_fsm≠
 *
§c
);

33 
pxt4_fsm≠_to_öã∫Æ
(
su≥r_block
 *
sb
, 
pxt4_fsm≠
 *
de°
,

34 
fsm≠
 *
§c
);

37 (*
	tpxt4_fsm≠_f‹m©_t
)(
	tpxt4_fsm≠
 *, *);

39 
	`pxt4_gëfsm≠
(
su≥r_block
 *
sb
, 
pxt4_fsm≠_hód
 *
hód
,

40 
pxt4_fsm≠_f‹m©_t
 
f‹m©ãr
, *
¨g
);

42 
	#PXT4_QUERY_RANGE_ABORT
 1

	)

43 
	#PXT4_QUERY_RANGE_CONTINUE
 0

	)

46 
	#PXT4_FMR_OWN_FREE
 
FMR_OWN_FREE


	)

47 
	#PXT4_FMR_OWN_UNKNOWN
 
FMR_OWN_UNKNOWN


	)

48 
	#PXT4_FMR_OWN_FS
 
	`FMR_OWNER
('X', 1Ë

	)

49 
	#PXT4_FMR_OWN_LOG
 
	`FMR_OWNER
('X', 2Ë

	)

50 
	#PXT4_FMR_OWN_INODES
 
	`FMR_OWNER
('X', 5Ë

	)

51 
	#PXT4_FMR_OWN_GDT
 
	`FMR_OWNER
('f', 1Ë

	)

52 
	#PXT4_FMR_OWN_RESV_GDT
 
	`FMR_OWNER
('f', 2Ë

	)

53 
	#PXT4_FMR_OWN_BLKBM
 
	`FMR_OWNER
('f', 3Ë

	)

54 
	#PXT4_FMR_OWN_INOBM
 
	`FMR_OWNER
('f', 4Ë

	)

	@fsync.c

26 
	~<löux/time.h
>

27 
	~<löux/fs.h
>

28 
	~<löux/sched.h
>

29 
	~<löux/wrôeback.h
>

30 
	~<löux/blkdev.h
>

32 
	~"pxt4.h
"

33 
	~"pxt4_jbd3.h
"

35 
	~<åa˚/evíts/pxt4.h
>

45 
	$pxt4_sync_∑ª¡
(
öode
 *inode)

47 
díåy
 *díåy = 
NULL
;

48 
öode
 *
√xt
;

49 
ªt
 = 0;

51 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
))

53 
öode
 = 
	`igøb
(inode);

54 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
)) {

55 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

56 
díåy
 = 
	`d_föd_™y_Æüs
(
öode
);

57 i‡(!
díåy
)

59 
√xt
 = 
	`igøb
(
	`d_öode
(
díåy
->
d_∑ª¡
));

60 
	`dput
(
díåy
);

61 i‡(!
√xt
)

63 
	`ùut
(
öode
);

64 
öode
 = 
√xt
;

72 
ªt
 = 
	`sync_m≠pög_buf„rs
(
öode
->
i_m≠pög
);

73 i‡(
ªt
)

75 
ªt
 = 
	`sync_öode_mëad©a
(
öode
, 1);

76 i‡(
ªt
)

79 
	`ùut
(
öode
);

80  
ªt
;

81 
	}
}

95 
	$pxt4_sync_fûe
(
fûe
 *fûe, 
loff_t
 
°¨t
,Üoff_à
íd
, 
d©async
)

97 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

98 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

99 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

100 
ªt
 = 0, 
îr
;

101 
tid_t
 
commô_tid
;

102 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

104 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

105  -
EIO
;

107 
	`J_ASSERT
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
);

109 
	`åa˚_pxt4_sync_fûe_íãr
(
fûe
, 
d©async
);

111 i‡(
	`sb_rd⁄ly
(
öode
->
i_sb
)) {

113 
	`smp_rmb
();

114 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

115 
ªt
 = -
EROFS
;

116 
out
;

119 i‡(!
jou∫Æ
) {

120 
ªt
 = 
	`__gíîic_fûe_fsync
(
fûe
, 
°¨t
, 
íd
, 
d©async
);

121 i‡(!
ªt
)

122 
ªt
 = 
	`pxt4_sync_∑ª¡
(
öode
);

123 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
BARRIER
))

124 
issue_Êush
;

125 
out
;

128 
ªt
 = 
	`fûe_wrôe_™d_waô_ønge
(
fûe
, 
°¨t
, 
íd
);

129 i‡(
ªt
)

130  
ªt
;

145 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

146 
ªt
 = 
	`pxt4_f‹˚_commô
(
öode
->
i_sb
);

147 
out
;

150 
commô_tid
 = 
d©async
 ? 
ei
->
i_d©async_tid
 :Éi->
i_sync_tid
;

151 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

152 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ
, 
commô_tid
))

153 
√eds_b¨rõr
 = 
åue
;

154 
ªt
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

155 i‡(
√eds_b¨rõr
) {

156 
issue_Êush
:

157 
îr
 = 
	`blkdev_issue_Êush
(
öode
->
i_sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

158 i‡(!
ªt
)

159 
ªt
 = 
îr
;

161 
out
:

162 
îr
 = 
	`fûe_check_™d_adv™˚_wb_îr
(
fûe
);

163 i‡(
ªt
 == 0)

164 
ªt
 = 
îr
;

165 
	`åa˚_pxt4_sync_fûe_exô
(
öode
, 
ªt
);

166  
ªt
;

167 
	}
}

	@hash.c

8 
	~<löux/fs.h
>

9 
	~<löux/compûî.h
>

10 
	~<löux/bô›s.h
>

11 
	~"pxt4.h
"

13 
	#DELTA
 0x9E3779B9

	)

15 
	$TEA_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[])

17 
__u32
 
sum
 = 0;

18 
__u32
 
b0
 = 
buf
[0], 
b1
 = buf[1];

19 
__u32
 
a
 = 
ö
[0], 
b
 = in[1], 
c
 = in[2], 
d
 = in[3];

20 
n
 = 16;

23 
sum
 +
DELTA
;

24 
b0
 +((
b1
 << 4)+
a
Ë^ (b1+
sum
Ë^ ((b1 >> 5)+
b
);

25 
b1
 +((
b0
 << 4)+
c
Ë^ (b0+
sum
Ë^ ((b0 >> 5)+
d
);

26 } --
n
);

28 
buf
[0] +
b0
;

29 
buf
[1] +
b1
;

30 
	}
}

33 
	#F
(
x
, 
y
, 
z
Ë((zË^ ((xË& ((yË^ (z))))

	)

34 
	#G
(
x
, 
y
, 
z
Ë(((xË& (y)Ë+ (((xË^ (y)Ë& (z)))

	)

35 
	#H
(
x
, 
y
, 
z
Ë((xË^ (yË^ (z))

	)

43 
	#ROUND
(
f
, 
a
, 
b
, 
c
, 
d
, 
x
, 
s
) \

44 (
a
 +
	`f
(
b
, 
c
, 
d
Ë+ 
x
,á = 
	`rﬁ32
◊, 
s
))

	)

45 
	#K1
 0

	)

46 
	#K2
 013240474631UL

	)

47 
	#K3
 015666365641UL

	)

52 
__u32
 
	$hÆf_md4_å™sf‹m
(
__u32
 
buf
[4], __u32 c⁄° 
ö
[8])

54 
__u32
 
a
 = 
buf
[0], 
b
 = buf[1], 
c
 = buf[2], 
d
 = buf[3];

57 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K1
, 3);

58 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[1] + 
K1
, 7);

59 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K1
, 11);

60 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[3] + 
K1
, 19);

61 
	`ROUND
(
F
, 
a
, 
b
, 
c
, 
d
, 
ö
[4] + 
K1
, 3);

62 
	`ROUND
(
F
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K1
, 7);

63 
	`ROUND
(
F
, 
c
, 
d
, 
a
, 
b
, 
ö
[6] + 
K1
, 11);

64 
	`ROUND
(
F
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K1
, 19);

67 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K2
, 3);

68 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[3] + 
K2
, 5);

69 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[5] + 
K2
, 9);

70 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[7] + 
K2
, 13);

71 
	`ROUND
(
G
, 
a
, 
b
, 
c
, 
d
, 
ö
[0] + 
K2
, 3);

72 
	`ROUND
(
G
, 
d
, 
a
, 
b
, 
c
, 
ö
[2] + 
K2
, 5);

73 
	`ROUND
(
G
, 
c
, 
d
, 
a
, 
b
, 
ö
[4] + 
K2
, 9);

74 
	`ROUND
(
G
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K2
, 13);

77 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[3] + 
K3
, 3);

78 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[7] + 
K3
, 9);

79 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[2] + 
K3
, 11);

80 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[6] + 
K3
, 15);

81 
	`ROUND
(
H
, 
a
, 
b
, 
c
, 
d
, 
ö
[1] + 
K3
, 3);

82 
	`ROUND
(
H
, 
d
, 
a
, 
b
, 
c
, 
ö
[5] + 
K3
, 9);

83 
	`ROUND
(
H
, 
c
, 
d
, 
a
, 
b
, 
ö
[0] + 
K3
, 11);

84 
	`ROUND
(
H
, 
b
, 
c
, 
d
, 
a
, 
ö
[4] + 
K3
, 15);

86 
buf
[0] +
a
;

87 
buf
[1] +
b
;

88 
buf
[2] +
c
;

89 
buf
[3] +
d
;

91  
buf
[1];

92 
	}
}

93 #unde‡
ROUND


94 #unde‡
K1


95 #unde‡
K2


96 #unde‡
K3


97 #unde‡
F


98 #unde‡
G


99 #unde‡
H


102 
__u32
 
	$dx_hack_hash_unsig√d
(c⁄° *
«me
, 
Àn
)

104 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

105 c⁄° *
u˝
 = (c⁄° *Ë
«me
;

107 
Àn
--) {

108 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
u˝
++) * 7152373));

110 i‡(
hash
 & 0x80000000)

111 
hash
 -= 0x7fffffff;

112 
hash1
 = 
hash0
;

113 
hash0
 = 
hash
;

115  
hash0
 << 1;

116 
	}
}

118 
__u32
 
	$dx_hack_hash_sig√d
(c⁄° *
«me
, 
Àn
)

120 
__u32
 
hash
, 
hash0
 = 0x12a3„2d, 
hash1
 = 0x37abe8f9;

121 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
«me
;

123 
Àn
--) {

124 
hash
 = 
hash1
 + (
hash0
 ^ (((Ë*
s˝
++) * 7152373));

126 i‡(
hash
 & 0x80000000)

127 
hash
 -= 0x7fffffff;

128 
hash1
 = 
hash0
;

129 
hash0
 = 
hash
;

131  
hash0
 << 1;

132 
	}
}

134 
	$°r2hashbuf_sig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

136 
__u32
 
∑d
, 
vÆ
;

137 
i
;

138 c⁄° sig√d *
s˝
 = (c⁄° sig√d *Ë
msg
;

140 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

141 
∑d
 |=Öad << 16;

143 
vÆ
 = 
∑d
;

144 i‡(
Àn
 > 
num
*4)

145 
Àn
 = 
num
 * 4;

146 
i
 = 0; i < 
Àn
; i++) {

147 
vÆ
 = ((Ë
s˝
[
i
]) + (val << 8);

148 i‡((
i
 % 4) == 3) {

149 *
buf
++ = 
vÆ
;

150 
vÆ
 = 
∑d
;

151 
num
--;

154 i‡(--
num
 >= 0)

155 *
buf
++ = 
vÆ
;

156 --
num
 >= 0)

157 *
buf
++ = 
∑d
;

158 
	}
}

160 
	$°r2hashbuf_unsig√d
(c⁄° *
msg
, 
Àn
, 
__u32
 *
buf
, 
num
)

162 
__u32
 
∑d
, 
vÆ
;

163 
i
;

164 c⁄° *
u˝
 = (c⁄° *Ë
msg
;

166 
∑d
 = (
__u32
)
Àn
 | ((__u32)len << 8);

167 
∑d
 |=Öad << 16;

169 
vÆ
 = 
∑d
;

170 i‡(
Àn
 > 
num
*4)

171 
Àn
 = 
num
 * 4;

172 
i
 = 0; i < 
Àn
; i++) {

173 
vÆ
 = ((Ë
u˝
[
i
]) + (val << 8);

174 i‡((
i
 % 4) == 3) {

175 *
buf
++ = 
vÆ
;

176 
vÆ
 = 
∑d
;

177 
num
--;

180 i‡(--
num
 >= 0)

181 *
buf
++ = 
vÆ
;

182 --
num
 >= 0)

183 *
buf
++ = 
∑d
;

184 
	}
}

199 
	$pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
, 
dx_hash_öfo
 *
höfo
)

201 
__u32
 
hash
;

202 
__u32
 
mö‹_hash
 = 0;

203 c⁄° *
p
;

204 
i
;

205 
__u32
 
ö
[8], 
buf
[4];

206 (*
°r2hashbuf
)(c⁄° *, , 
__u32
 *, ) =

207 
°r2hashbuf_sig√d
;

210 
buf
[0] = 0x67452301;

211 
buf
[1] = 0xefcdab89;

212 
buf
[2] = 0x98badcfe;

213 
buf
[3] = 0x10325476;

216 i‡(
höfo
->
£ed
) {

217 
i
 = 0; i < 4; i++) {

218 i‡(
höfo
->
£ed
[
i
]) {

219 
	`mem˝y
(
buf
, 
höfo
->
£ed
, (buf));

225 
höfo
->
hash_vîsi⁄
) {

226 
DX_HASH_LEGACY_UNSIGNED
:

227 
hash
 = 
	`dx_hack_hash_unsig√d
(
«me
, 
Àn
);

229 
DX_HASH_LEGACY
:

230 
hash
 = 
	`dx_hack_hash_sig√d
(
«me
, 
Àn
);

232 
DX_HASH_HALF_MD4_UNSIGNED
:

233 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

235 
DX_HASH_HALF_MD4
:

236 
p
 = 
«me
;

237 
Àn
 > 0) {

238 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 8);

239 
	`hÆf_md4_å™sf‹m
(
buf
, 
ö
);

240 
Àn
 -= 32;

241 
p
 += 32;

243 
mö‹_hash
 = 
buf
[2];

244 
hash
 = 
buf
[1];

246 
DX_HASH_TEA_UNSIGNED
:

247 
°r2hashbuf
 = 
°r2hashbuf_unsig√d
;

249 
DX_HASH_TEA
:

250 
p
 = 
«me
;

251 
Àn
 > 0) {

252 (*
°r2hashbuf
)(
p
, 
Àn
, 
ö
, 4);

253 
	`TEA_å™sf‹m
(
buf
, 
ö
);

254 
Àn
 -= 16;

255 
p
 += 16;

257 
hash
 = 
buf
[0];

258 
mö‹_hash
 = 
buf
[1];

261 
höfo
->
hash
 = 0;

264 
hash
 = hash & ~1;

265 i‡(
hash
 =(
PXT4_HTREE_EOF_32BIT
 << 1))

266 
hash
 = (
PXT4_HTREE_EOF_32BIT
 - 1) << 1;

267 
höfo
->
hash
 = hash;

268 
höfo
->
mö‹_hash
 = minor_hash;

270 
	}
}

	@ialloc.c

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/°©.h
>

19 
	~<löux/°rög.h
>

20 
	~<löux/quŸa›s.h
>

21 
	~<löux/buf„r_hód.h
>

22 
	~<löux/øndom.h
>

23 
	~<löux/bô›s.h
>

24 
	~<löux/blkdev.h
>

25 
	~<löux/¸ed.h
>

27 
	~<asm/byã‹dî.h
>

29 
	~"pxt4.h
"

30 
	~"pxt4_jbd3.h
"

31 
	~"x©å.h
"

32 
	~"a˛.h
"

34 
	~<åa˚/evíts/pxt4.h
>

55 
	$pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
)

57 
i
;

59 i‡(
°¨t_bô
 >
íd_bô
)

62 
	`pxt4_debug
("m¨kÉnd bô†+%dÅhrough +%d u£d\n", 
°¨t_bô
, 
íd_bô
);

63 
i
 = 
°¨t_bô
; i < ((start_bit + 7) & ~7UL); i++)

64 
	`pxt4_£t_bô
(
i
, 
bôm≠
);

65 i‡(
i
 < 
íd_bô
)

66 
	`mem£t
(
bôm≠
 + (
i
 >> 3), 0xff, (
íd_bô
 - i) >> 3);

67 
	}
}

69 
	$pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
)

71 i‡(
u±od©e
) {

72 
	`£t_buf„r_u±od©e
(
bh
);

73 
	`£t_bôm≠_u±od©e
(
bh
);

75 
	`u∆ock_buf„r
(
bh
);

76 
	`put_bh
(
bh
);

77 
	}
}

79 
	$pxt4_vÆid©e_öode_bôm≠
(
su≥r_block
 *
sb
,

80 
pxt4_group_desc
 *
desc
,

81 
pxt4_group_t
 
block_group
,

82 
buf„r_hód
 *
bh
)

84 
pxt4_fsblk_t
 
blk
;

85 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

87 i‡(
	`buf„r_vîifõd
(
bh
))

89 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

90  -
EFSCORRUPTED
;

92 
	`pxt4_lock_group
(
sb
, 
block_group
);

93 i‡(
	`buf„r_vîifõd
(
bh
))

94 
vîifõd
;

95 
blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

96 i‡(!
	`pxt4_öode_bôm≠_csum_vîify
(
sb
, 
block_group
, 
desc
, 
bh
,

97 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8)) {

98 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

99 
	`pxt4_îr‹
(
sb
, "Corrupt inode bitmap - block_group = %u, "

100 "öode_bôm≠ = %Œu", 
block_group
, 
blk
);

101 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

102 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

103  -
EFSBADCRC
;

105 
	`£t_buf„r_vîifõd
(
bh
);

106 
vîifõd
:

107 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

109 
	}
}

117 
buf„r_hód
 *

118 
	$pxt4_ªad_öode_bôm≠
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
block_group
)

120 
pxt4_group_desc
 *
desc
;

121 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

122 
buf„r_hód
 *
bh
 = 
NULL
;

123 
pxt4_fsblk_t
 
bôm≠_blk
;

124 
îr
;

126 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, 
NULL
);

127 i‡(!
desc
)

128  
	`ERR_PTR
(-
EFSCORRUPTED
);

130 
bôm≠_blk
 = 
	`pxt4_öode_bôm≠
(
sb
, 
desc
);

131 i‡((
bôm≠_blk
 <
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
)) ||

132 (
bôm≠_blk
 >
	`pxt4_blocks_cou¡
(
sbi
->
s_es
))) {

133 
	`pxt4_îr‹
(
sb
, "Invalid inode bitmap blk %llu in "

134 "block_grou∞%u", 
bôm≠_blk
, 
block_group
);

135 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

136 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

137  
	`ERR_PTR
(-
EFSCORRUPTED
);

139 
bh
 = 
	`sb_gëblk
(
sb
, 
bôm≠_blk
);

140 i‡(
	`u∆ikñy
(!
bh
)) {

141 
	`pxt4_w¨nög
(
sb
, "CannotÑead inode bitmap - "

143 
block_group
, 
bôm≠_blk
);

144  
	`ERR_PTR
(-
ENOMEM
);

146 i‡(
	`bôm≠_u±od©e
(
bh
))

147 
vîify
;

149 
	`lock_buf„r
(
bh
);

150 i‡(
	`bôm≠_u±od©e
(
bh
)) {

151 
	`u∆ock_buf„r
(
bh
);

152 
vîify
;

155 
	`pxt4_lock_group
(
sb
, 
block_group
);

156 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

157 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
))) {

158 i‡(
block_group
 == 0) {

159 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

160 
	`u∆ock_buf„r
(
bh
);

161 
	`pxt4_îr‹
(
sb
, "Inode bitmap for bg 0 marked "

163 
îr
 = -
EFSCORRUPTED
;

164 
out
;

166 
	`mem£t
(
bh
->
b_d©a
, 0, (
	`PXT4_INODES_PER_GROUP
(
sb
) + 7) / 8);

167 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

168 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

169 
	`£t_bôm≠_u±od©e
(
bh
);

170 
	`£t_buf„r_u±od©e
(
bh
);

171 
	`£t_buf„r_vîifõd
(
bh
);

172 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

173 
	`u∆ock_buf„r
(
bh
);

174  
bh
;

176 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

178 i‡(
	`buf„r_u±od©e
(
bh
)) {

183 
	`£t_bôm≠_u±od©e
(
bh
);

184 
	`u∆ock_buf„r
(
bh
);

185 
vîify
;

190 
	`åa˚_pxt4_lﬂd_öode_bôm≠
(
sb
, 
block_group
);

191 
bh
->
b_íd_io
 = 
pxt4_íd_bôm≠_ªad
;

192 
	`gë_bh
(
bh
);

193 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

194 
	`waô_⁄_buf„r
(
bh
);

195 i‡(!
	`buf„r_u±od©e
(
bh
)) {

196 
	`put_bh
(
bh
);

197 
	`pxt4_îr‹
(
sb
, "CannotÑead inode bitmap - "

199 
block_group
, 
bôm≠_blk
);

200 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

201 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

202  
	`ERR_PTR
(-
EIO
);

205 
vîify
:

206 
îr
 = 
	`pxt4_vÆid©e_öode_bôm≠
(
sb
, 
desc
, 
block_group
, 
bh
);

207 i‡(
îr
)

208 
out
;

209  
bh
;

210 
out
:

211 
	`put_bh
(
bh
);

212  
	`ERR_PTR
(
îr
);

213 
	}
}

231 
	$pxt4_‰ì_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

233 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

234 
is_dúe˘‹y
;

235 
öo
;

236 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

237 
buf„r_hód
 *
bh2
;

238 
pxt4_group_t
 
block_group
;

239 
bô
;

240 
pxt4_group_desc
 *
gdp
;

241 
pxt4_su≥r_block
 *
es
;

242 
pxt4_sb_öfo
 *
sbi
;

243 
Áèl
 = 0, 
îr
, 
cou¡
, 
˛óªd
;

244 
pxt4_group_öfo
 *
gΩ
;

246 i‡(!
sb
) {

247 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d: inode on "

248 "n⁄exi°íàdevi˚\n", 
__func__
, 
__LINE__
);

251 i‡(
	`©omic_ªad
(&
öode
->
i_cou¡
) > 1) {

252 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu: count=%d",

253 
__func__
, 
__LINE__
, 
öode
->
i_öo
,

254 
	`©omic_ªad
(&
öode
->
i_cou¡
));

257 i‡(
öode
->
i_∆ök
) {

258 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%s:%d: inode #%lu:Çlink=%d\n",

259 
__func__
, 
__LINE__
, 
öode
->
i_öo
, inode->
i_∆ök
);

262 
sbi
 = 
	`PXT4_SB
(
sb
);

264 
öo
 = 
öode
->
i_öo
;

265 
	`pxt4_debug
("‰ìög inodê%lu\n", 
öo
);

266 
	`åa˚_pxt4_‰ì_öode
(
öode
);

272 
	`dquŸ_öôülize
(
öode
);

273 
	`dquŸ_‰ì_öode
(
öode
);

274 
	`dquŸ_dr›
(
öode
);

276 
is_dúe˘‹y
 = 
	`S_ISDIR
(
öode
->
i_mode
);

279 
	`pxt4_˛ór_öode
(
öode
);

281 
es
 = 
sbi
->
s_es
;

282 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

283 
	`pxt4_îr‹
(
sb
, "ª£rved o∏n⁄exi°íàöodê%lu", 
öo
);

284 
îr‹_ªtu∫
;

286 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

287 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

288 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

290 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
);

291 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

292 
Áèl
 = 
	`PTR_ERR
(
bôm≠_bh
);

293 
bôm≠_bh
 = 
NULL
;

294 
îr‹_ªtu∫
;

296 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))) {

297 
Áèl
 = -
EFSCORRUPTED
;

298 
îr‹_ªtu∫
;

301 
	`BUFFER_TRACE
(
bôm≠_bh
, "get_write_access");

302 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

303 i‡(
Áèl
)

304 
îr‹_ªtu∫
;

306 
Áèl
 = -
ESRCH
;

307 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
bh2
);

308 i‡(
gdp
) {

309 
	`BUFFER_TRACE
(
bh2
, "get_write_access");

310 
Áèl
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh2
);

312 
	`pxt4_lock_group
(
sb
, 
block_group
);

313 
˛óªd
 = 
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
bôm≠_bh
->
b_d©a
);

314 i‡(
Áèl
 || !
˛óªd
) {

315 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

316 
out
;

319 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) + 1;

320 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
cou¡
);

321 i‡(
is_dúe˘‹y
) {

322 
cou¡
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
) - 1;

323 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
cou¡
);

324 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_dús_cou¡î
);

326 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
,

327 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

328 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

329 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

331 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_‰ìöodes_cou¡î
);

332 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

333 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

335 
	`©omic_öc
(&
sbi
->
s_Êex_groups
[
f
].
‰ì_öodes
);

336 i‡(
is_dúe˘‹y
)

337 
	`©omic_dec
(&
sbi
->
s_Êex_groups
[
f
].
u£d_dús
);

339 
	`BUFFER_TRACE
(
bh2
, "callÖxt4_handle_dirty_metadata");

340 
Áèl
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh2
);

341 
out
:

342 i‡(
˛óªd
) {

343 
	`BUFFER_TRACE
(
bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

344 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

345 i‡(!
Áèl
)

346 
Áèl
 = 
îr
;

348 
	`pxt4_îr‹
(
sb
, "bôáÃódy cÀ¨ed f‹ inodê%lu", 
öo
);

349 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
block_group
,

350 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

353 
îr‹_ªtu∫
:

354 
	`bªl£
(
bôm≠_bh
);

355 
	`pxt4_°d_îr‹
(
sb
, 
Áèl
);

356 
	}
}

358 
	s‹lov_°©s
 {

359 
__u64
 
	m‰ì_˛u°îs
;

360 
__u32
 
	m‰ì_öodes
;

361 
__u32
 
	mu£d_dús
;

369 
	$gë_‹lov_°©s
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
g
,

370 
Êex_size
, 
‹lov_°©s
 *
°©s
)

372 
pxt4_group_desc
 *
desc
;

373 
Êex_groups
 *
Êex_group
 = 
	`PXT4_SB
(
sb
)->
s_Êex_groups
;

375 i‡(
Êex_size
 > 1) {

376 
°©s
->
‰ì_öodes
 = 
	`©omic_ªad
(&
Êex_group
[
g
].free_inodes);

377 
°©s
->
‰ì_˛u°îs
 = 
	`©omic64_ªad
(&
Êex_group
[
g
].free_clusters);

378 
°©s
->
u£d_dús
 = 
	`©omic_ªad
(&
Êex_group
[
g
].used_dirs);

382 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

383 i‡(
desc
) {

384 
°©s
->
‰ì_öodes
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

385 
°©s
->
‰ì_˛u°îs
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

386 
°©s
->
u£d_dús
 = 
	`pxt4_u£d_dús_cou¡
(
sb
, 
desc
);

388 
°©s
->
‰ì_öodes
 = 0;

389 
°©s
->
‰ì_˛u°îs
 = 0;

390 
°©s
->
u£d_dús
 = 0;

392 
	}
}

415 
	$föd_group_‹lov
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

416 
pxt4_group_t
 *
group
, 
umode_t
 
mode
,

417 c⁄° 
q°r
 *qstr)

419 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

420 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

421 
pxt4_group_t
 
ªÆ_ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

422 
öodes_≥r_group
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

423 
‰ìi
, 
ave‰ìi
, 
gΩ_‰ì
;

424 
pxt4_fsblk_t
 
‰ìb
, 
ave‰ìc
;

425 
ndús
;

426 
max_dús
, 
mö_öodes
;

427 
pxt4_gΩblk_t
 
mö_˛u°îs
;

428 
pxt4_group_t
 
i
, 
gΩ
, 
g
, 
ngroups
;

429 
pxt4_group_desc
 *
desc
;

430 
‹lov_°©s
 
°©s
;

431 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
sbi
);

432 
dx_hash_öfo
 
höfo
;

434 
ngroups
 = 
ªÆ_ngroups
;

435 i‡(
Êex_size
 > 1) {

436 
ngroups
 = (
ªÆ_ngroups
 + 
Êex_size
 - 1) >>

437 
sbi
->
s_log_groups_≥r_Êex
;

438 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

441 
‰ìi
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

442 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

443 
‰ìb
 = 
	`PXT4_C2B
(
sbi
,

444 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

445 
ave‰ìc
 = 
‰ìb
;

446 
	`do_div
(
ave‰ìc
, 
ngroups
);

447 
ndús
 = 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dús_cou¡î
);

449 i‡(
	`S_ISDIR
(
mode
) &&

450 ((
∑ª¡
 =
	`d_öode
(
sb
->
s_roŸ
)) ||

451 (
	`pxt4_ã°_öode_Êag
(
∑ª¡
, 
PXT4_INODE_TOPDIR
)))) {

452 
be°_ndú
 = 
öodes_≥r_group
;

453 
ªt
 = -1;

455 i‡(
q°r
) {

456 
höfo
.
hash_vîsi⁄
 = 
DX_HASH_HALF_MD4
;

457 
höfo
.
£ed
 = 
sbi
->
s_hash_£ed
;

458 
	`pxt4fs_dúhash
(
q°r
->
«me
, q°r->
Àn
, &
höfo
);

459 
gΩ
 = 
höfo
.
hash
;

461 
gΩ
 = 
	`¥™dom_u32
();

462 
∑ª¡_group
 = ()
gΩ
 % 
ngroups
;

463 
i
 = 0; i < 
ngroups
; i++) {

464 
g
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

465 
	`gë_‹lov_°©s
(
sb
, 
g
, 
Êex_size
, &
°©s
);

466 i‡(!
°©s
.
‰ì_öodes
)

468 i‡(
°©s
.
u£d_dús
 >
be°_ndú
)

470 i‡(
°©s
.
‰ì_öodes
 < 
ave‰ìi
)

472 i‡(
°©s
.
‰ì_˛u°îs
 < 
ave‰ìc
)

474 
gΩ
 = 
g
;

475 
ªt
 = 0;

476 
be°_ndú
 = 
°©s
.
u£d_dús
;

478 i‡(
ªt
)

479 
ÁŒback
;

480 
found_Êex_bg
:

481 i‡(
Êex_size
 == 1) {

482 *
group
 = 
gΩ
;

493 
gΩ
 *
Êex_size
;

494 
i
 = 0; i < 
Êex_size
; i++) {

495 i‡(
gΩ
+
i
 >
ªÆ_ngroups
)

497 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
+
i
, 
NULL
);

498 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

499 *
group
 = 
gΩ
+
i
;

503 
ÁŒback
;

506 
max_dús
 = 
ndús
 / 
ngroups
 + 
öodes_≥r_group
 / 16;

507 
mö_öodes
 = 
ave‰ìi
 - 
öodes_≥r_group
*
Êex_size
 / 4;

508 i‡(
mö_öodes
 < 1)

509 
mö_öodes
 = 1;

510 
mö_˛u°îs
 = 
ave‰ìc
 - 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)*
Êex_size
 / 4;

516 i‡(
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

517 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

518 i‡(
Êex_size
 > 1)

519 
∑ª¡_group
 >>
sbi
->
s_log_groups_≥r_Êex
;

522 
i
 = 0; i < 
ngroups
; i++) {

523 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

524 
	`gë_‹lov_°©s
(
sb
, 
gΩ
, 
Êex_size
, &
°©s
);

525 i‡(
°©s
.
u£d_dús
 >
max_dús
)

527 i‡(
°©s
.
‰ì_öodes
 < 
mö_öodes
)

529 i‡(
°©s
.
‰ì_˛u°îs
 < 
mö_˛u°îs
)

531 
found_Êex_bg
;

534 
ÁŒback
:

535 
ngroups
 = 
ªÆ_ngroups
;

536 
ave‰ìi
 = 
‰ìi
 / 
ngroups
;

537 
ÁŒback_ªåy
:

538 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

539 
i
 = 0; i < 
ngroups
; i++) {

540 
gΩ
 = (
∑ª¡_group
 + 
i
Ë% 
ngroups
;

541 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
gΩ
, 
NULL
);

542 i‡(
desc
) {

543 
gΩ_‰ì
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
desc
);

544 i‡(
gΩ_‰ì
 && gΩ_‰ì >
ave‰ìi
) {

545 *
group
 = 
gΩ
;

551 i‡(
ave‰ìi
) {

556 
ave‰ìi
 = 0;

557 
ÁŒback_ªåy
;

561 
	}
}

563 
	$föd_group_Ÿhî
(
su≥r_block
 *
sb
, 
öode
 *
∑ª¡
,

564 
pxt4_group_t
 *
group
, 
umode_t
 
mode
)

566 
pxt4_group_t
 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_block_group
;

567 
pxt4_group_t
 
i
, 
œ°
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

568 
pxt4_group_desc
 *
desc
;

569 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
sb
));

578 i‡(
Êex_size
 > 1) {

579 
ªåy
 = 0;

581 
åy_agaö
:

582 
∑ª¡_group
 &~(
Êex_size
-1);

583 
œ°
 = 
∑ª¡_group
 + 
Êex_size
;

584 i‡(
œ°
 > 
ngroups
)

585 
œ°
 = 
ngroups
;

586 
i
 = 
∑ª¡_group
; i < 
œ°
; i++) {

587 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

588 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc)) {

589 *
group
 = 
i
;

593 i‡(!
ªåy
 && 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
 != ~0) {

594 
ªåy
 = 1;

595 
∑ª¡_group
 = 
	`PXT4_I
(
∑ª¡
)->
i_œ°_Æloc_group
;

596 
åy_agaö
;

603 *
group
 = 
∑ª¡_group
 + 
Êex_size
;

604 i‡(*
group
 > 
ngroups
)

605 *
group
 = 0;

606  
	`föd_group_‹lov
(
sb
, 
∑ª¡
, 
group
, 
mode
, 
NULL
);

612 *
group
 = 
∑ª¡_group
;

613 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

614 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

615 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

627 *
group
 = (*grou∞+ 
∑ª¡
->
i_öo
Ë% 
ngroups
;

633 
i
 = 1; i < 
ngroups
; i <<= 1) {

634 *
group
 +
i
;

635 i‡(*
group
 >
ngroups
)

636 *
group
 -
ngroups
;

637 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

638 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc) &&

639 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
))

647 *
group
 = 
∑ª¡_group
;

648 
i
 = 0; i < 
ngroups
; i++) {

649 i‡(++*
group
 >
ngroups
)

650 *
group
 = 0;

651 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, *
group
, 
NULL
);

652 i‡(
desc
 && 
	`pxt4_‰ì_öodes_cou¡
(
sb
, desc))

657 
	}
}

665 
	#RECENTCY_MIN
 5

	)

666 
	#RECENTCY_DIRTY
 300

	)

668 
	$ª˚¡ly_dñëed
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
öo
)

670 
pxt4_group_desc
 *
gdp
;

671 
pxt4_öode
 *
øw_öode
;

672 
buf„r_hód
 *
bh
;

673 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

674 
off£t
, 
ªt
 = 0;

675 
ª˚¡cy
 = 
RECENTCY_MIN
;

676 
u32
 
dtime
, 
now
;

678 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

679 i‡(
	`u∆ikñy
(!
gdp
))

682 
bh
 = 
	`sb_föd_gë_block
(
sb
, 
	`pxt4_öode_èbÀ
(sb, 
gdp
) +

683 (
öo
 / 
öodes_≥r_block
));

684 i‡(!
bh
 || !
	`buf„r_u±od©e
(bh))

689 
out
;

691 
off£t
 = (
öo
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

692 
øw_öode
 = (
pxt4_öode
 *Ë(
bh
->
b_d©a
 + 
off£t
);

698 
dtime
 = 
	`À32_to_˝u
(
øw_öode
->
i_dtime
);

699 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

700 i‡(
	`buf„r_dúty
(
bh
))

701 
ª˚¡cy
 +
RECENTCY_DIRTY
;

703 i‡(
dtime
 && 
	`time_bef‹e32
(dtime, 
now
) &&

704 
	`time_bef‹e32
(
now
, 
dtime
 + 
ª˚¡cy
))

705 
ªt
 = 1;

706 
out
:

707 
	`bªl£
(
bh
);

708  
ªt
;

709 
	}
}

711 
	$föd_öode_bô
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

712 
buf„r_hód
 *
bôm≠
, *
öo
)

714 
√xt
:

715 *
öo
 = 
	`pxt4_föd_√xt_zîo_bô
((*)

716 
bôm≠
->
b_d©a
,

717 
	`PXT4_INODES_PER_GROUP
(
sb
), *
öo
);

718 i‡(*
öo
 >
	`PXT4_INODES_PER_GROUP
(
sb
))

721 i‡((
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 =
NULL
) &&

722 
	`ª˚¡ly_dñëed
(
sb
, 
group
, *
öo
)) {

723 *
öo
 = *ino + 1;

724 i‡(*
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

725 
√xt
;

730 
	}
}

742 
öode
 *
	$__pxt4_√w_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

743 
umode_t
 
mode
, c⁄° 
q°r
 *qstr,

744 
__u32
 
gﬂl
, 
uid_t
 *
ow√r
, __u32 
i_Êags
,

745 
h™dÀ_ty≥
, 
löe_no
,

746 
nblocks
)

748 
su≥r_block
 *
sb
;

749 
buf„r_hód
 *
öode_bôm≠_bh
 = 
NULL
;

750 
buf„r_hód
 *
group_desc_bh
;

751 
pxt4_group_t
 
ngroups
, 
group
 = 0;

752 
öo
 = 0;

753 
öode
 *inode;

754 
pxt4_group_desc
 *
gdp
 = 
NULL
;

755 
pxt4_öode_öfo
 *
ei
;

756 
pxt4_sb_öfo
 *
sbi
;

757 
ªt2
, 
îr
;

758 
öode
 *
ªt
;

759 
pxt4_group_t
 
i
;

760 
pxt4_group_t
 
Êex_group
;

761 
pxt4_group_öfo
 *
gΩ
;

762 
í¸y±
 = 0;

765 i‡(!
dú
 || !dú->
i_∆ök
)

766  
	`ERR_PTR
(-
EPERM
);

768 
sb
 = 
dú
->
i_sb
;

769 
sbi
 = 
	`PXT4_SB
(
sb
);

771 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

772  
	`ERR_PTR
(-
EIO
);

774 i‡((
	`IS_ENCRYPTED
(
dú
Ë|| 
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
)) &&

775 (
	`S_ISREG
(
mode
Ë|| 
	`S_ISDIR
(modeË|| 
	`S_ISLNK
(mode)) &&

776 !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

777 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

778 i‡(
îr
)

779  
	`ERR_PTR
(
îr
);

780 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
))

781  
	`ERR_PTR
(-
ENOKEY
);

782 
í¸y±
 = 1;

785 i‡(!
h™dÀ
 && 
sbi
->
s_jou∫Æ
 && !(
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

786 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


787 
posix_a˛
 *
p
 = 
	`gë_a˛
(
dú
, 
ACL_TYPE_DEFAULT
);

789 i‡(
	`IS_ERR
(
p
))

790  
	`ERR_CAST
(
p
);

791 i‡(
p
) {

792 
a˛_size
 = 
p
->
a_cou¡
 * (
pxt4_a˛_íåy
);

794 
nblocks
 +(
	`S_ISDIR
(
mode
) ? 2 : 1) *

795 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

796 
NULL
 , 
a˛_size
,

797 
åue
 );

798 
	`posix_a˛_ªÀa£
(
p
);

802 #ifde‡
CONFIG_SECURITY


804 
num_£curôy_x©ås
 = 1;

806 #ifde‡
CONFIG_INTEGRITY


807 
num_£curôy_x©ås
++;

814 
nblocks
 +
num_£curôy_x©ås
 *

815 
	`__pxt4_x©å_£t_¸edôs
(
sb
, 
NULL
 ,

816 
NULL
 , 1024,

817 
åue
 );

820 i‡(
í¸y±
)

821 
nblocks
 +
	`__pxt4_x©å_£t_¸edôs
(
sb
,

822 
NULL
 , NULL ,

823 
FSCRYPT_SET_CONTEXT_MAX_SIZE
,

824 
åue
 );

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
	`åa˚_pxt4_ªque°_öode
(
dú
, 
mode
);

829 
öode
 = 
	`√w_öode
(
sb
);

830 i‡(!
öode
)

831  
	`ERR_PTR
(-
ENOMEM
);

832 
ei
 = 
	`PXT4_I
(
öode
);

839 i‡(
ow√r
) {

840 
öode
->
i_mode
 = 
mode
;

841 
	`i_uid_wrôe
(
öode
, 
ow√r
[0]);

842 
	`i_gid_wrôe
(
öode
, 
ow√r
[1]);

843 } i‡(
	`ã°_›t
(
sb
, 
GRPID
)) {

844 
öode
->
i_mode
 = 
mode
;

845 
öode
->
i_uid
 = 
	`cuºít_fsuid
();

846 
öode
->
i_gid
 = 
dú
->i_gid;

848 
	`öode_öô_ow√r
(
öode
, 
dú
, 
mode
);

850 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

851 
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
))

852 
ei
->
i_¥ojid
 = 
	`PXT4_I
(
dú
)->i_projid;

854 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, 
PXT4_DEF_PROJID
);

856 
îr
 = 
	`dquŸ_öôülize
(
öode
);

857 i‡(
îr
)

858 
out
;

860 i‡(!
gﬂl
)

861 
gﬂl
 = 
sbi
->
s_öode_gﬂl
;

863 i‡(
gﬂl
 && gﬂ»<
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
)) {

864 
group
 = (
gﬂl
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

865 
öo
 = (
gﬂl
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

866 
ªt2
 = 0;

867 
gŸ_group
;

870 i‡(
	`S_ISDIR
(
mode
))

871 
ªt2
 = 
	`föd_group_‹lov
(
sb
, 
dú
, &
group
, 
mode
, 
q°r
);

873 
ªt2
 = 
	`föd_group_Ÿhî
(
sb
, 
dú
, &
group
, 
mode
);

875 
gŸ_group
:

876 
	`PXT4_I
(
dú
)->
i_œ°_Æloc_group
 = 
group
;

877 
îr
 = -
ENOSPC
;

878 i‡(
ªt2
 == -1)

879 
out
;

886 
i
 = 0; i < 
ngroups
; i++, 
öo
 = 0) {

887 
îr
 = -
EIO
;

889 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

890 i‡(!
gdp
)

891 
out
;

896 i‡(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
) == 0)

897 
√xt_group
;

899 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

901 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
))

902 
√xt_group
;

904 
	`bªl£
(
öode_bôm≠_bh
);

905 
öode_bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
group
);

907 i‡(
	`PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) ||

908 
	`IS_ERR
(
öode_bôm≠_bh
)) {

909 
öode_bôm≠_bh
 = 
NULL
;

910 
√xt_group
;

913 
ª≥©_ö_this_group
:

914 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

915 i‡(!
ªt2
)

916 
√xt_group
;

918 i‡(
group
 =0 && (
öo
 + 1Ë< 
	`PXT4_FIRST_INO
(
sb
)) {

919 
	`pxt4_îr‹
(
sb
, "reserved inode found cleared - "

920 "öode=%lu", 
öo
 + 1);

921 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

922 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

923 
√xt_group
;

926 i‡(!
h™dÀ
) {

927 
	`BUG_ON
(
nblocks
 <= 0);

928 
h™dÀ
 = 
	`__pxt4_jou∫Æ_°¨t_sb
(
dú
->
i_sb
, 
löe_no
,

929 
h™dÀ_ty≥
, 
nblocks
,

931 i‡(
	`IS_ERR
(
h™dÀ
)) {

932 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

933 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

934 
out
;

937 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "get_write_access");

938 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
öode_bôm≠_bh
);

939 i‡(
îr
) {

940 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

941 
out
;

943 
	`pxt4_lock_group
(
sb
, 
group
);

944 
ªt2
 = 
	`pxt4_ã°_™d_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

945 i‡(
ªt2
) {

949 
ªt2
 = 
	`föd_öode_bô
(
sb
, 
group
, 
öode_bôm≠_bh
, &
öo
);

950 i‡(
ªt2
) {

951 
	`pxt4_£t_bô
(
öo
, 
öode_bôm≠_bh
->
b_d©a
);

952 
ªt2
 = 0;

954 
ªt2
 = 1;

957 
	`pxt4_u∆ock_group
(
sb
, 
group
);

958 
öo
++;

959 i‡(!
ªt2
)

960 
gŸ
;

962 i‡(
öo
 < 
	`PXT4_INODES_PER_GROUP
(
sb
))

963 
ª≥©_ö_this_group
;

964 
√xt_group
:

965 i‡(++
group
 =
ngroups
)

966 
group
 = 0;

968 
îr
 = -
ENOSPC
;

969 
out
;

971 
gŸ
:

972 
	`BUFFER_TRACE
(
öode_bôm≠_bh
, "callÖxt4_handle_dirty_metadata");

973 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
öode_bôm≠_bh
);

974 i‡(
îr
) {

975 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

976 
out
;

979 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

980 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
group_desc_bh
);

981 i‡(
îr
) {

982 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

983 
out
;

987 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

988 
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
)) {

989 
buf„r_hód
 *
block_bôm≠_bh
;

991 
block_bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

992 i‡(
	`IS_ERR
(
block_bôm≠_bh
)) {

993 
îr
 = 
	`PTR_ERR
(
block_bôm≠_bh
);

994 
out
;

996 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "get block bitmapáccess");

997 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
block_bôm≠_bh
);

998 i‡(
îr
) {

999 
	`bªl£
(
block_bôm≠_bh
);

1000 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1001 
out
;

1004 
	`BUFFER_TRACE
(
block_bôm≠_bh
, "dirty block bitmap");

1005 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
block_bôm≠_bh
);

1008 
	`pxt4_lock_group
(
sb
, 
group
);

1009 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

1010 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

1011 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

1012 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1013 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
gdp
));

1014 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
,

1015 
block_bôm≠_bh
);

1016 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1018 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1019 
	`bªl£
(
block_bôm≠_bh
);

1021 i‡(
îr
) {

1022 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1023 
out
;

1028 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1029 
‰ì
;

1030 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1032 
	`down_ªad
(&
gΩ
->
Æloc_£m
);

1033 
	`pxt4_lock_group
(
sb
, 
group
);

1034 
‰ì
 = 
	`PXT4_INODES_PER_GROUP
(
sb
) -

1035 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

1036 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)) {

1037 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_INODE_UNINIT
);

1038 
‰ì
 = 0;

1045 i‡(
öo
 > 
‰ì
)

1046 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1047 (
	`PXT4_INODES_PER_GROUP
(
sb
Ë- 
öo
));

1048 
	`up_ªad
(&
gΩ
->
Æloc_£m
);

1050 
	`pxt4_lock_group
(
sb
, 
group
);

1053 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`pxt4_‰ì_öodes_cou¡
(sb, gdp) - 1);

1054 i‡(
	`S_ISDIR
(
mode
)) {

1055 
	`pxt4_u£d_dús_£t
(
sb
, 
gdp
, 
	`pxt4_u£d_dús_cou¡
(sb, gdp) + 1);

1056 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1057 
pxt4_group_t
 
f
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1059 
	`©omic_öc
(&
sbi
->
s_Êex_groups
[
f
].
u£d_dús
);

1062 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1063 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
öode_bôm≠_bh
,

1064 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1065 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1067 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1069 
	`BUFFER_TRACE
(
group_desc_bh
, "callÖxt4_handle_dirty_metadata");

1070 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
group_desc_bh
);

1071 i‡(
îr
) {

1072 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1073 
out
;

1076 
	`≥r˝u_cou¡î_dec
(&
sbi
->
s_‰ìöodes_cou¡î
);

1077 i‡(
	`S_ISDIR
(
mode
))

1078 
	`≥r˝u_cou¡î_öc
(&
sbi
->
s_dús_cou¡î
);

1080 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

1081 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group
);

1082 
	`©omic_dec
(&
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

1085 
öode
->
i_öo
 = 
öo
 + 
group
 * 
	`PXT4_INODES_PER_GROUP
(
sb
);

1087 
öode
->
i_blocks
 = 0;

1088 
öode
->
i_mtime
 = inode->
i_©ime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1089 
ei
->
i_¸time
 = 
öode
->
i_mtime
;

1091 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

1092 
ei
->
i_dú_°¨t_lookup
 = 0;

1093 
ei
->
i_disksize
 = 0;

1096 
ei
->
i_Êags
 =

1097 
	`pxt4_mask_Êags
(
mode
, 
	`PXT4_I
(
dú
)->
i_Êags
 & 
PXT4_FL_INHERITED
);

1098 
ei
->
i_Êags
 |= i_flags;

1099 
ei
->
i_fûe_a˛
 = 0;

1100 
ei
->
i_dtime
 = 0;

1101 
ei
->
i_block_group
 = 
group
;

1102 
ei
->
i_œ°_Æloc_group
 = ~0;

1104 
	`pxt4_£t_öode_Êags
(
öode
);

1105 i‡(
	`IS_DIRSYNC
(
öode
))

1106 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1107 i‡(
	`ö£π_öode_locked
(
öode
) < 0) {

1112 
îr
 = -
EIO
;

1113 
	`pxt4_îr‹
(
sb
, "failedÅo insert inode %lu: doublyállocated?",

1114 
öode
->
i_öo
);

1115 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

1116 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
);

1117 
out
;

1119 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

1122 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

1123 
__u32
 
csum
;

1124 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

1125 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

1126 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

1127 (
öum
));

1128 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

1129 (
gí
));

1132 
	`pxt4_˛ór_°©e_Êags
(
ei
);

1133 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

1135 
ei
->
i_exåa_isize
 = 
sbi
->
s_w™t_exåa_isize
;

1136 
ei
->
i_ölöe_off
 = 0;

1137 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
))

1138 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1139 
ªt
 = 
öode
;

1140 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

1141 i‡(
îr
)

1142 
Áû_dr›
;

1149 i‡(
í¸y±
) {

1150 
îr
 = 
	`fs¸y±_öhîô_c⁄ãxt
(
dú
, 
öode
, 
h™dÀ
, 
åue
);

1151 i‡(
îr
)

1152 
Áû_‰ì_dr›
;

1155 i‡(!(
ei
->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

1156 
îr
 = 
	`pxt4_öô_a˛
(
h™dÀ
, 
öode
, 
dú
);

1157 i‡(
îr
)

1158 
Áû_‰ì_dr›
;

1160 
îr
 = 
	`pxt4_öô_£curôy
(
h™dÀ
, 
öode
, 
dú
, 
q°r
);

1161 i‡(
îr
)

1162 
Áû_‰ì_dr›
;

1165 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

1167 i‡(
	`S_ISDIR
(
mode
Ë|| 
	`S_ISREG
(modeË|| 
	`S_ISLNK
(mode)) {

1168 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

1169 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

1173 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

1174 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1175 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1178 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1179 i‡(
îr
) {

1180 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1181 
Áû_‰ì_dr›
;

1184 
	`pxt4_debug
("Æloˇtög inodê%lu\n", 
öode
->
i_öo
);

1185 
	`åa˚_pxt4_Æloˇã_öode
(
öode
, 
dú
, 
mode
);

1186 
	`bªl£
(
öode_bôm≠_bh
);

1187  
ªt
;

1189 
Áû_‰ì_dr›
:

1190 
	`dquŸ_‰ì_öode
(
öode
);

1191 
Áû_dr›
:

1192 
	`˛ór_∆ök
(
öode
);

1193 
	`u∆ock_√w_öode
(
öode
);

1194 
out
:

1195 
	`dquŸ_dr›
(
öode
);

1196 
öode
->
i_Êags
 |
S_NOQUOTA
;

1197 
	`ùut
(
öode
);

1198 
	`bªl£
(
öode_bôm≠_bh
);

1199  
	`ERR_PTR
(
îr
);

1200 
	}
}

1203 
öode
 *
	$pxt4_‹ph™_gë
(
su≥r_block
 *
sb
, 
öo
)

1205 
max_öo
 = 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
);

1206 
pxt4_group_t
 
block_group
;

1207 
bô
;

1208 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1209 
öode
 *öodê
NULL
;

1210 
îr
 = -
EFSCORRUPTED
;

1212 i‡(
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë|| inÿ> 
max_öo
)

1213 
bad_‹ph™
;

1215 
block_group
 = (
öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

1216 
bô
 = (
öo
 - 1Ë% 
	`PXT4_INODES_PER_GROUP
(
sb
);

1217 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
block_group
);

1218 i‡(
	`IS_ERR
(
bôm≠_bh
))

1219  
	`ERR_CAST
(
bôm≠_bh
);

1225 i‡(!
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
))

1226 
bad_‹ph™
;

1228 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1229 i‡(
	`IS_ERR
(
öode
)) {

1230 
îr
 = 
	`PTR_ERR
(
öode
);

1231 
	`pxt4_îr‹
(
sb
, "couldn'tÑead orphan inode %lu (err %d)",

1232 
öo
, 
îr
);

1233  
öode
;

1242 i‡((
öode
->
i_∆ök
 && !
	`pxt4_ˇn_åunˇã
(inode)) ||

1243 
	`is_bad_öode
(
öode
))

1244 
bad_‹ph™
;

1246 i‡(
	`NEXT_ORPHAN
(
öode
Ë> 
max_öo
)

1247 
bad_‹ph™
;

1248 
	`bªl£
(
bôm≠_bh
);

1249  
öode
;

1251 
bad_‹ph™
:

1252 
	`pxt4_îr‹
(
sb
, "bad oΩh™ inodê%lu", 
öo
);

1253 i‡(
bôm≠_bh
)

1254 
	`¥ötk
(
KERN_ERR
 "pxt4_test_bit(bit=%d, block=%llu) = %d\n",

1255 
bô
, ()
bôm≠_bh
->
b_blockƒ
,

1256 
	`pxt4_ã°_bô
(
bô
, 
bôm≠_bh
->
b_d©a
));

1257 i‡(
öode
) {

1258 
	`¥ötk
(
KERN_ERR
 "is_bad_inode(inode)=%d\n",

1259 
	`is_bad_öode
(
öode
));

1260 
	`¥ötk
(
KERN_ERR
 "NEXT_ORPHAN(inode)=%u\n",

1261 
	`NEXT_ORPHAN
(
öode
));

1262 
	`¥ötk
(
KERN_ERR
 "max_öo=%lu\n", 
max_öo
);

1263 
	`¥ötk
(
KERN_ERR
 "i_∆ök=%u\n", 
öode
->
i_∆ök
);

1265 i‡(
öode
->
i_∆ök
 == 0)

1266 
öode
->
i_blocks
 = 0;

1267 
	`ùut
(
öode
);

1269 
	`bªl£
(
bôm≠_bh
);

1270  
	`ERR_PTR
(
îr
);

1271 
	}
}

1273 
	$pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *
sb
)

1275 
desc_cou¡
;

1276 
pxt4_group_desc
 *
gdp
;

1277 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1278 #ifde‡
PXT4FS_DEBUG


1279 
pxt4_su≥r_block
 *
es
;

1280 
bôm≠_cou¡
, 
x
;

1281 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

1283 
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1284 
desc_cou¡
 = 0;

1285 
bôm≠_cou¡
 = 0;

1286 
gdp
 = 
NULL
;

1287 
i
 = 0; i < 
ngroups
; i++) {

1288 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1289 i‡(!
gdp
)

1291 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1292 
	`bªl£
(
bôm≠_bh
);

1293 
bôm≠_bh
 = 
	`pxt4_ªad_öode_bôm≠
(
sb
, 
i
);

1294 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

1295 
bôm≠_bh
 = 
NULL
;

1299 
x
 = 
	`pxt4_cou¡_‰ì
(
bôm≠_bh
->
b_d©a
,

1300 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1301 
	`¥ötk
(
KERN_DEBUG
 "group %lu: stored = %d, counted = %lu\n",

1302 (Ë
i
, 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
), 
x
);

1303 
bôm≠_cou¡
 +
x
;

1305 
	`bªl£
(
bôm≠_bh
);

1306 
	`¥ötk
(
KERN_DEBUG
 "pxt4_count_free_inodes: "

1308 
	`À32_to_˝u
(
es
->
s_‰ì_öodes_cou¡
), 
desc_cou¡
, 
bôm≠_cou¡
);

1309  
desc_cou¡
;

1311 
desc_cou¡
 = 0;

1312 
i
 = 0; i < 
ngroups
; i++) {

1313 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1314 i‡(!
gdp
)

1316 
desc_cou¡
 +
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

1317 
	`c⁄d_ªsched
();

1319  
desc_cou¡
;

1321 
	}
}

1324 
	$pxt4_cou¡_dús
(
su≥r_block
 * 
sb
)

1326 
cou¡
 = 0;

1327 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

1329 
i
 = 0; i < 
ngroups
; i++) {

1330 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

1331 i‡(!
gdp
)

1333 
cou¡
 +
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
);

1335  
cou¡
;

1336 
	}
}

1346 
	$pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1347 
b¨rõr
)

1349 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_group_desc
 *
gdp
 = 
NULL
;

1352 
buf„r_hód
 *
group_desc_bh
;

1353 
h™dÀ_t
 *
h™dÀ
;

1354 
pxt4_fsblk_t
 
blk
;

1355 
num
, 
ªt
 = 0, 
u£d_blks
 = 0;

1358 i‡(
	`sb_rd⁄ly
(
sb
)) {

1359 
ªt
 = 1;

1360 
out
;

1363 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, &
group_desc_bh
);

1364 i‡(!
gdp
)

1365 
out
;

1371 i‡(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
))

1372 
out
;

1374 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1375 i‡(
	`IS_ERR
(
h™dÀ
)) {

1376 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

1377 
out
;

1380 
	`down_wrôe
(&
gΩ
->
Æloc_£m
);

1386 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_UNINIT
)))

1387 
u£d_blks
 = 
	`DIV_ROUND_UP
((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1388 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)),

1389 
sbi
->
s_öodes_≥r_block
);

1391 i‡((
u£d_blks
 < 0Ë|| (u£d_blk†> 
sbi
->
s_ôb_≥r_group
) ||

1392 ((
group
 =0Ë&& ((
	`PXT4_INODES_PER_GROUP
(
sb
) -

1393 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
)) <

1394 
	`PXT4_FIRST_INO
(
sb
)))) {

1395 
	`pxt4_îr‹
(
sb
, "Something is wrong with group %u: "

1398 
group
, 
u£d_blks
,

1399 
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
));

1400 
ªt
 = 1;

1401 
îr_out
;

1404 
blk
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ 
u£d_blks
;

1405 
num
 = 
sbi
->
s_ôb_≥r_group
 - 
u£d_blks
;

1407 
	`BUFFER_TRACE
(
group_desc_bh
, "get_write_access");

1408 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1409 
group_desc_bh
);

1410 i‡(
ªt
)

1411 
îr_out
;

1418 i‡(
	`u∆ikñy
(
num
 == 0))

1419 
skù_zîoout
;

1421 
	`pxt4_debug
("goingÅo zero out inodeÅable in group %d\n",

1422 
group
);

1423 
ªt
 = 
	`sb_issue_zîoout
(
sb
, 
blk
, 
num
, 
GFP_NOFS
);

1424 i‡(
ªt
 < 0)

1425 
îr_out
;

1426 i‡(
b¨rõr
)

1427 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_NOFS
, 
NULL
);

1429 
skù_zîoout
:

1430 
	`pxt4_lock_group
(
sb
, 
group
);

1431 
gdp
->
bg_Êags
 |
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
);

1432 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1433 
	`pxt4_u∆ock_group
(
sb
, 
group
);

1435 
	`BUFFER_TRACE
(
group_desc_bh
,

1437 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1438 
group_desc_bh
);

1440 
îr_out
:

1441 
	`up_wrôe
(&
gΩ
->
Æloc_£m
);

1442 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1443 
out
:

1444  
ªt
;

1445 
	}
}

	@indirect.c

24 
	~"pxt4_jbd3.h
"

25 
	~"åunˇã.h
"

26 
	~<löux/dax.h
>

27 
	~<löux/uio.h
>

29 
	~<åa˚/evíts/pxt4.h
>

32 
__À32
 *
	mp
;

33 
__À32
 
	mkey
;

34 
buf„r_hód
 *
	mbh
;

35 } 
	tIndúe˘
;

37 
ölöe
 
	$add_chaö
(
Indúe˘
 *
p
, 
buf„r_hód
 *
bh
, 
__À32
 *
v
)

39 
p
->
key
 = *’->∞
v
);

40 
p
->
bh
 = bh;

41 
	}
}

74 
	$pxt4_block_to_∑th
(
öode
 *inode,

75 
pxt4_lblk_t
 
i_block
,

76 
pxt4_lblk_t
 
off£ts
[4], *
bound¨y
)

78 
±rs
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

79 
±rs_bôs
 = 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
);

80 c⁄° 
dúe˘_blocks
 = 
PXT4_NDIR_BLOCKS
,

81 
ödúe˘_blocks
 = 
±rs
,

82 
doubÀ_blocks
 = (1 << (
±rs_bôs
 * 2));

83 
n
 = 0;

84 
föÆ
 = 0;

86 i‡(
i_block
 < 
dúe˘_blocks
) {

87 
off£ts
[
n
++] = 
i_block
;

88 
föÆ
 = 
dúe˘_blocks
;

89 } i‡((
i_block
 -
dúe˘_blocks
Ë< 
ödúe˘_blocks
) {

90 
off£ts
[
n
++] = 
PXT4_IND_BLOCK
;

91 
off£ts
[
n
++] = 
i_block
;

92 
föÆ
 = 
±rs
;

93 } i‡((
i_block
 -
ödúe˘_blocks
Ë< 
doubÀ_blocks
) {

94 
off£ts
[
n
++] = 
PXT4_DIND_BLOCK
;

95 
off£ts
[
n
++] = 
i_block
 >> 
±rs_bôs
;

96 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

97 
föÆ
 = 
±rs
;

98 } i‡(((
i_block
 -
doubÀ_blocks
Ë>> (
±rs_bôs
 * 2)Ë< 
±rs
) {

99 
off£ts
[
n
++] = 
PXT4_TIND_BLOCK
;

100 
off£ts
[
n
++] = 
i_block
 >> (
±rs_bôs
 * 2);

101 
off£ts
[
n
++] = (
i_block
 >> 
±rs_bôs
Ë& (
±rs
 - 1);

102 
off£ts
[
n
++] = 
i_block
 & (
±rs
 - 1);

103 
föÆ
 = 
±rs
;

105 
	`pxt4_w¨nög
(
öode
->
i_sb
, "block %lu > max in inode %lu",

106 
i_block
 + 
dúe˘_blocks
 +

107 
ödúe˘_blocks
 + 
doubÀ_blocks
, 
öode
->
i_öo
);

109 i‡(
bound¨y
)

110 *
bound¨y
 = 
föÆ
 - 1 - (
i_block
 & (
±rs
 - 1));

111  
n
;

112 
	}
}

144 
Indúe˘
 *
	$pxt4_gë_bønch
(
öode
 *öode, 
dïth
,

145 
pxt4_lblk_t
 *
off£ts
,

146 
Indúe˘
 
chaö
[4], *
îr
)

148 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

149 
Indúe˘
 *
p
 = 
chaö
;

150 
buf„r_hód
 *
bh
;

151 
ªt
 = -
EIO
;

153 *
îr
 = 0;

155 
	`add_chaö
(
chaö
, 
NULL
, 
	`PXT4_I
(
öode
)->
i_d©a
 + *
off£ts
);

156 i‡(!
p
->
key
)

157 
no_block
;

158 --
dïth
) {

159 
bh
 = 
	`sb_gëblk
(
sb
, 
	`À32_to_˝u
(
p
->
key
));

160 i‡(
	`u∆ikñy
(!
bh
)) {

161 
ªt
 = -
ENOMEM
;

162 
Áûuª
;

165 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

166 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

167 
	`put_bh
(
bh
);

168 
Áûuª
;

171 i‡(
	`pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
)) {

172 
	`put_bh
(
bh
);

173 
Áûuª
;

177 
	`add_chaö
(++
p
, 
bh
, (
__À32
 *)bh->
b_d©a
 + *++
off£ts
);

179 i‡(!
p
->
key
)

180 
no_block
;

182  
NULL
;

184 
Áûuª
:

185 *
îr
 = 
ªt
;

186 
no_block
:

187  
p
;

188 
	}
}

210 
pxt4_fsblk_t
 
	$pxt4_föd_√¨
(
öode
 *öode, 
Indúe˘
 *
öd
)

212 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

213 
__À32
 *
°¨t
 = 
öd
->
bh
 ? (__À32 *Ëöd->bh->
b_d©a
 : 
ei
->
i_d©a
;

214 
__À32
 *
p
;

217 
p
 = 
öd
->∞- 1;Ö >
°¨t
;Ö--) {

218 i‡(*
p
)

219  
	`À32_to_˝u
(*
p
);

223 i‡(
öd
->
bh
)

224  
öd
->
bh
->
b_blockƒ
;

230  
	`pxt4_öode_to_gﬂl_block
(
öode
);

231 
	}
}

244 
pxt4_fsblk_t
 
	$pxt4_föd_gﬂl
(
öode
 *öode, 
pxt4_lblk_t
 
block
,

245 
Indúe˘
 *
∑πül
)

247 
pxt4_fsblk_t
 
gﬂl
;

253 
gﬂl
 = 
	`pxt4_föd_√¨
(
öode
, 
∑πül
);

254 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

255  
gﬂl
;

256 
	}
}

270 
	$pxt4_blks_to_Æloˇã
(
Indúe˘
 *
bønch
, 
k
, 
blks
,

271 
blocks_to_bound¨y
)

273 
cou¡
 = 0;

279 i‡(
k
 > 0) {

281 i‡(
blks
 < 
blocks_to_bound¨y
 + 1)

282 
cou¡
 +
blks
;

284 
cou¡
 +
blocks_to_bound¨y
 + 1;

285  
cou¡
;

288 
cou¡
++;

289 
cou¡
 < 
blks
 && cou¡ <
blocks_to_bound¨y
 &&

290 
	`À32_to_˝u
(*(
bønch
[0].
p
 + 
cou¡
)) == 0) {

291 
cou¡
++;

293  
cou¡
;

294 
	}
}

323 
	$pxt4_Æloc_bønch
(
h™dÀ_t
 *
h™dÀ
,

324 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

325 
ödúe˘_blks
, 
pxt4_lblk_t
 *
off£ts
,

326 
Indúe˘
 *
bønch
)

328 
buf„r_hód
 * 
bh
;

329 
pxt4_fsblk_t
 
b
, 
√w_blocks
[4];

330 
__À32
 *
p
;

331 
i
, 
j
, 
îr
, 
Àn
 = 1;

333 
i
 = 0; i <
ödúe˘_blks
; i++) {

334 i‡(
i
 =
ödúe˘_blks
) {

335 
√w_blocks
[
i
] = 
	`pxt4_mb_√w_blocks
(
h™dÀ
, 
¨
, &
îr
);

337 
¨
->
gﬂl
 = 
√w_blocks
[
i
] = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
,

338 
¨
->
öode
,ár->
gﬂl
,

339 
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
,

340 
NULL
, &
îr
);

341 i‡(
îr
) {

342 
i
--;

343 
Áûed
;

345 
bønch
[
i
].
key
 = 
	`˝u_to_À32
(
√w_blocks
[i]);

346 i‡(
i
 == 0)

349 
bh
 = 
bønch
[
i
].bh = 
	`sb_gëblk
(
¨
->
öode
->
i_sb
, 
√w_blocks
[i-1]);

350 i‡(
	`u∆ikñy
(!
bh
)) {

351 
îr
 = -
ENOMEM
;

352 
Áûed
;

354 
	`lock_buf„r
(
bh
);

355 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

356 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

357 i‡(
îr
) {

358 
	`u∆ock_buf„r
(
bh
);

359 
Áûed
;

362 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

363 
p
 = 
bønch
[
i
].∞(
__À32
 *Ë
bh
->
b_d©a
 + 
off£ts
[i];

364 
b
 = 
√w_blocks
[
i
];

366 i‡(
i
 =
ödúe˘_blks
)

367 
Àn
 = 
¨
->len;

368 
j
 = 0; j < 
Àn
; j++)

369 *
p
++ = 
	`˝u_to_À32
(
b
++);

371 
	`BUFFER_TRACE
(
bh
, "marking uptodate");

372 
	`£t_buf„r_u±od©e
(
bh
);

373 
	`u∆ock_buf„r
(
bh
);

375 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

376 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
bh
);

377 i‡(
îr
)

378 
Áûed
;

381 
Áûed
:

382 ; 
i
 >= 0; i--) {

389 i‡(
i
 > 0 && i !
ödúe˘_blks
 && 
bønch
[i].
bh
)

390 
	`pxt4_f‹gë
(
h™dÀ
, 1, 
¨
->
öode
, 
bønch
[
i
].
bh
,

391 
bønch
[
i
].
bh
->
b_blockƒ
);

392 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
√w_blocks
[
i
],

393 (
i
 =
ödúe˘_blks
Ë? 
¨
->
Àn
 : 1, 0);

395  
îr
;

396 
	}
}

413 
	$pxt4_•li˚_bønch
(
h™dÀ_t
 *
h™dÀ
,

414 
pxt4_Æloˇti⁄_ªque°
 *
¨
,

415 
Indúe˘
 *
whîe
, 
num
)

417 
i
;

418 
îr
 = 0;

419 
pxt4_fsblk_t
 
cuºít_block
;

426 i‡(
whîe
->
bh
) {

427 
	`BUFFER_TRACE
(
whîe
->
bh
, "get_write_access");

428 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
whîe
->
bh
);

429 i‡(
îr
)

430 
îr_out
;

434 *
whîe
->
p
 = whîe->
key
;

440 i‡(
num
 =0 && 
¨
->
Àn
 > 1) {

441 
cuºít_block
 = 
	`À32_to_˝u
(
whîe
->
key
) + 1;

442 
i
 = 1; i < 
¨
->
Àn
; i++)

443 *(
whîe
->
p
 + 
i
Ë
	`˝u_to_À32
(
cuºít_block
++);

448 i‡(
whîe
->
bh
) {

457 
	`jbd_debug
(5, "splicing indirect only\n");

458 
	`BUFFER_TRACE
(
whîe
->
bh
, "callÖxt4_handle_dirty_metadata");

459 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
¨
->
öode
, 
whîe
->
bh
);

460 i‡(
îr
)

461 
îr_out
;

466 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
¨
->
öode
);

467 
	`jbd_debug
(5, "splicing direct\n");

469  
îr
;

471 
îr_out
:

472 
i
 = 1; i <
num
; i++) {

478 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
whîe
[
i
].
bh
, 0, 1,

479 
PXT4_FREE_BLOCKS_FORGET
);

481 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
¨
->
öode
, 
NULL
, 
	`À32_to_˝u
(
whîe
[
num
].
key
),

482 
¨
->
Àn
, 0);

484  
îr
;

485 
	}
}

515 
	$pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

516 
pxt4_m≠_blocks
 *
m≠
,

517 
Êags
)

519 
pxt4_Æloˇti⁄_ªque°
 
¨
;

520 
îr
 = -
EIO
;

521 
pxt4_lblk_t
 
off£ts
[4];

522 
Indúe˘
 
chaö
[4];

523 
Indúe˘
 *
∑πül
;

524 
ödúe˘_blks
;

525 
blocks_to_bound¨y
 = 0;

526 
dïth
;

527 
cou¡
 = 0;

528 
pxt4_fsblk_t
 
fú°_block
 = 0;

530 
	`åa˚_pxt4_öd_m≠_blocks_íãr
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
, 
Êags
);

531 
	`J_ASSERT
(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)));

532 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || (
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0);

533 
dïth
 = 
	`pxt4_block_to_∑th
(
öode
, 
m≠
->
m_lblk
, 
off£ts
,

534 &
blocks_to_bound¨y
);

536 i‡(
dïth
 == 0)

537 
out
;

539 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
dïth
, 
off£ts
, 
chaö
, &
îr
);

542 i‡(!
∑πül
) {

543 
fú°_block
 = 
	`À32_to_˝u
(
chaö
[
dïth
 - 1].
key
);

544 
cou¡
++;

546 
cou¡
 < 
m≠
->
m_Àn
 && cou¡ <
blocks_to_bound¨y
) {

547 
pxt4_fsblk_t
 
blk
;

549 
blk
 = 
	`À32_to_˝u
(*(
chaö
[
dïth
-1].
p
 + 
cou¡
));

551 i‡(
blk
 =
fú°_block
 + 
cou¡
)

552 
cou¡
++;

556 
gŸ_ô
;

560 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0) {

561 
ïb
 = 
öode
->
i_sb
->
s_blocksize
 / (
u32
);

562 
i
;

570 
cou¡
 = 0;

571 
i
 = 
∑πül
 - 
chaö
 + 1; i < 
dïth
; i++)

572 
cou¡
 = cou¡ * 
ïb
 + (ïb - 
off£ts
[
i
] - 1);

573 
cou¡
++;

575 
m≠
->
m_pblk
 = 0;

576 
m≠
->
m_Àn
 = 
	`mö_t
(, m≠->m_Àn, 
cou¡
);

577 
˛ónup
;

581 i‡(
îr
 =-
EIO
)

582 
˛ónup
;

587 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
)) {

588 
	`PXT4_ERROR_INODE
(
öode
, "Can'tállocate blocks for "

590  -
EFSCORRUPTED
;

594 
	`mem£t
(&
¨
, 0, (ar));

595 
¨
.
öode
 = inode;

596 
¨
.
logiˇl
 = 
m≠
->
m_lblk
;

597 i‡(
	`S_ISREG
(
öode
->
i_mode
))

598 
¨
.
Êags
 = 
PXT4_MB_HINT_DATA
;

599 i‡(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
)

600 
¨
.
Êags
 |
PXT4_MB_DELALLOC_RESERVED
;

601 i‡(
Êags
 & 
PXT4_GET_BLOCKS_METADATA_NOFAIL
)

602 
¨
.
Êags
 |
PXT4_MB_USE_RESERVED
;

604 
¨
.
gﬂl
 = 
	`pxt4_föd_gﬂl
(
öode
, 
m≠
->
m_lblk
, 
∑πül
);

607 
ödúe˘_blks
 = (
chaö
 + 
dïth
Ë- 
∑πül
 - 1;

613 
¨
.
Àn
 = 
	`pxt4_blks_to_Æloˇã
(
∑πül
, 
ödúe˘_blks
,

614 
m≠
->
m_Àn
, 
blocks_to_bound¨y
);

619 
îr
 = 
	`pxt4_Æloc_bønch
(
h™dÀ
, &
¨
, 
ödúe˘_blks
,

620 
off£ts
 + (
∑πül
 - 
chaö
),Öartial);

629 i‡(!
îr
)

630 
îr
 = 
	`pxt4_•li˚_bønch
(
h™dÀ
, &
¨
, 
∑πül
, 
ödúe˘_blks
);

631 i‡(
îr
)

632 
˛ónup
;

634 
m≠
->
m_Êags
 |
PXT4_MAP_NEW
;

636 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

637 
cou¡
 = 
¨
.
Àn
;

638 
gŸ_ô
:

639 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

640 
m≠
->
m_pblk
 = 
	`À32_to_˝u
(
chaö
[
dïth
-1].
key
);

641 
m≠
->
m_Àn
 = 
cou¡
;

642 i‡(
cou¡
 > 
blocks_to_bound¨y
)

643 
m≠
->
m_Êags
 |
PXT4_MAP_BOUNDARY
;

644 
îr
 = 
cou¡
;

646 
∑πül
 = 
chaö
 + 
dïth
 - 1;

647 
˛ónup
:

648 
∑πül
 > 
chaö
) {

649 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

650 
	`bªl£
(
∑πül
->
bh
);

651 
∑πül
--;

653 
out
:

654 
	`åa˚_pxt4_öd_m≠_blocks_exô
(
öode
, 
Êags
, 
m≠
, 
îr
);

655  
îr
;

656 
	}
}

662 
	$pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
)

664 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

665 
£˘‹_t
 
död_mask
 = ~((£˘‹_t)
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
) - 1);

666 
blk_bôs
;

668 i‡(
lblock
 < 
PXT4_NDIR_BLOCKS
)

671 
lblock
 -
PXT4_NDIR_BLOCKS
;

673 i‡(
ei
->
i_da_mëad©a_ˇlc_Àn
 &&

674 (
lblock
 & 
död_mask
Ë=
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
) {

675 
ei
->
i_da_mëad©a_ˇlc_Àn
++;

678 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 
lblock
 & 
död_mask
;

679 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 1;

680 
blk_bôs
 = 
	`‹dî_ba£_2
(
lblock
);

681  (
blk_bôs
 / 
	`PXT4_ADDR_PER_BLOCK_BITS
(
öode
->
i_sb
)) + 1;

682 
	}
}

688 
	$pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

695  
	`DIV_ROUND_UP
(
ƒblocks
, 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
)) + 4;

696 
	}
}

710 
	$åy_to_exãnd_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

712 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

714 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

716 i‡(!
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
	`pxt4_blocks_f‹_åunˇã
(
öode
)))

719 
	}
}

726 
ölöe
 
	$Æl_zî€s
(
__À32
 *
p
, __À32 *
q
)

728 
p
 < 
q
)

729 i‡(*
p
++)

732 
	}
}

769 
Indúe˘
 *
	$pxt4_föd_sh¨ed
(
öode
 *öode, 
dïth
,

770 
pxt4_lblk_t
 
off£ts
[4], 
Indúe˘
 
chaö
[4],

771 
__À32
 *
t›
)

773 
Indúe˘
 *
∑πül
, *
p
;

774 
k
, 
îr
;

776 *
t›
 = 0;

778 
k
 = 
dïth
; k > 1 && !
off£ts
[k-1]; k--)

780 
∑πül
 = 
	`pxt4_gë_bønch
(
öode
, 
k
, 
off£ts
, 
chaö
, &
îr
);

782 i‡(!
∑πül
)

783 
∑πül
 = 
chaö
 + 
k
-1;

788 i‡(!
∑πül
->
key
 && *∑πül->
p
)

790 
no_t›
;

791 
p
 = 
∑πül
; (∞> 
chaö
Ë&& 
	`Æl_zî€s
((
__À32
 *Ëp->
bh
->
b_d©a
,Ö->p);Ö--)

799 i‡(
p
 =
chaö
 + 
k
 - 1 &&Ö > chain) {

800 
p
->p--;

802 *
t›
 = *
p
->p;

805 *
p
->p = 0;

810 
∑πül
 > 
p
) {

811 
	`bªl£
(
∑πül
->
bh
);

812 
∑πül
--;

814 
no_t›
:

815  
∑πül
;

816 
	}
}

829 
	$pxt4_˛ór_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

830 
buf„r_hód
 *
bh
,

831 
pxt4_fsblk_t
 
block_to_‰ì
,

832 
cou¡
, 
__À32
 *
fú°
,

833 
__À32
 *
œ°
)

835 
__À32
 *
p
;

836 
Êags
 = 
PXT4_FREE_BLOCKS_VALIDATED
;

837 
îr
;

839 i‡(
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode) ||

840 
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EA_INODE
))

841 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
 | 
PXT4_FREE_BLOCKS_METADATA
;

842 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

843 
Êags
 |
PXT4_FREE_BLOCKS_FORGET
;

845 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
block_to_‰ì
,

846 
cou¡
)) {

847 
	`PXT4_ERROR_INODE
(
öode
, "attemptÅo clear invalid "

849 (Ë
block_to_‰ì
, 
cou¡
);

853 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

854 i‡(
bh
) {

855 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

856 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

857 i‡(
	`u∆ikñy
(
îr
))

858 
out_îr
;

860 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

861 i‡(
	`u∆ikñy
(
îr
))

862 
out_îr
;

863 
îr
 = 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

864 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

865 i‡(
	`u∆ikñy
(
îr
))

866 
out_îr
;

867 i‡(
bh
) {

868 
	`BUFFER_TRACE
(
bh
, "retaking writeáccess");

869 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

870 i‡(
	`u∆ikñy
(
îr
))

871 
out_îr
;

875 
p
 = 
fú°
;Ö < 
œ°
;Ö++)

876 *
p
 = 0;

878 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block_to_‰ì
, 
cou¡
, 
Êags
);

880 
out_îr
:

881 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

882  
îr
;

883 
	}
}

904 
	$pxt4_‰ì_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

905 
buf„r_hód
 *
this_bh
,

906 
__À32
 *
fú°
, __À32 *
œ°
)

908 
pxt4_fsblk_t
 
block_to_‰ì
 = 0;

909 
cou¡
 = 0;

910 
__À32
 *
block_to_‰ì_p
 = 
NULL
;

913 
pxt4_fsblk_t
 
ƒ
;

914 
__À32
 *
p
;

916 
îr
 = 0;

918 i‡(
this_bh
) {

919 
	`BUFFER_TRACE
(
this_bh
, "get_write_access");

920 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
this_bh
);

923 i‡(
îr
)

927 
p
 = 
fú°
;Ö < 
œ°
;Ö++) {

928 
ƒ
 = 
	`À32_to_˝u
(*
p
);

929 i‡(
ƒ
) {

931 i‡(
cou¡
 == 0) {

932 
block_to_‰ì
 = 
ƒ
;

933 
block_to_‰ì_p
 = 
p
;

934 
cou¡
 = 1;

935 } i‡(
ƒ
 =
block_to_‰ì
 + 
cou¡
) {

936 
cou¡
++;

938 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
,

939 
block_to_‰ì
, 
cou¡
,

940 
block_to_‰ì_p
, 
p
);

941 i‡(
îr
)

943 
block_to_‰ì
 = 
ƒ
;

944 
block_to_‰ì_p
 = 
p
;

945 
cou¡
 = 1;

950 i‡(!
îr
 && 
cou¡
 > 0)

951 
îr
 = 
	`pxt4_˛ór_blocks
(
h™dÀ
, 
öode
, 
this_bh
, 
block_to_‰ì
,

952 
cou¡
, 
block_to_‰ì_p
, 
p
);

953 i‡(
îr
 < 0)

957 i‡(
this_bh
) {

958 
	`BUFFER_TRACE
(
this_bh
, "callÖxt4_handle_dirty_metadata");

966 i‡((
	`PXT4_JOURNAL
(
öode
Ë=
NULL
Ë|| 
	`bh2jh
(
this_bh
))

967 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
this_bh
);

969 
	`PXT4_ERROR_INODE
(
öode
,

972 (Ë
this_bh
->
b_blockƒ
);

974 
	}
}

989 
	$pxt4_‰ì_bønches
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

990 
buf„r_hód
 *
∑ª¡_bh
,

991 
__À32
 *
fú°
, __À32 *
œ°
, 
dïth
)

993 
pxt4_fsblk_t
 
ƒ
;

994 
__À32
 *
p
;

996 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

999 i‡(
dïth
--) {

1000 
buf„r_hód
 *
bh
;

1001 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1002 
p
 = 
œ°
;

1003 --
p
 >
fú°
) {

1004 
ƒ
 = 
	`À32_to_˝u
(*
p
);

1005 i‡(!
ƒ
)

1008 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
),

1009 
ƒ
, 1)) {

1010 
	`PXT4_ERROR_INODE
(
öode
,

1013 (Ë
ƒ
, 
dïth
);

1018 
bh
 = 
	`sb_bªad
(
öode
->
i_sb
, 
ƒ
);

1024 i‡(!
bh
) {

1025 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ƒ
,

1031 
	`BUFFER_TRACE
(
bh
, "free child branches");

1032 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
bh
,

1033 (
__À32
 *Ë
bh
->
b_d©a
,

1034 (
__À32
 *Ë
bh
->
b_d©a
 + 
addr_≥r_block
,

1035 
dïth
);

1036 
	`bªl£
(
bh
);

1054 i‡(
	`pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ
))

1056 i‡(
	`åy_to_exãnd_å™ß˘i⁄
(
h™dÀ
, 
öode
)) {

1057 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1058 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ
, 
öode
,

1059 
	`pxt4_blocks_f‹_åunˇã
(
öode
));

1073 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1074 
PXT4_FREE_BLOCKS_METADATA
|

1075 
PXT4_FREE_BLOCKS_FORGET
);

1077 i‡(
∑ª¡_bh
) {

1082 
	`BUFFER_TRACE
(
∑ª¡_bh
, "get_write_access");

1083 i‡(!
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

1084 
∑ª¡_bh
)){

1085 *
p
 = 0;

1086 
	`BUFFER_TRACE
(
∑ª¡_bh
,

1088 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1089 
öode
,

1090 
∑ª¡_bh
);

1096 
	`BUFFER_TRACE
(
∑ª¡_bh
, "free data blocks");

1097 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
∑ª¡_bh
, 
fú°
, 
œ°
);

1099 
	}
}

1101 
	$pxt4_öd_åunˇã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1103 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1104 
__À32
 *
i_d©a
 = 
ei
->i_data;

1105 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1106 
pxt4_lblk_t
 
off£ts
[4];

1107 
Indúe˘
 
chaö
[4];

1108 
Indúe˘
 *
∑πül
;

1109 
__À32
 
ƒ
 = 0;

1110 
n
 = 0;

1111 
pxt4_lblk_t
 
œ°_block
, 
max_block
;

1112 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1114 
œ°_block
 = (
öode
->
i_size
 + 
blocksize
-1)

1115 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1116 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1117 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1119 i‡(
œ°_block
 !
max_block
) {

1120 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
œ°_block
, 
off£ts
, 
NULL
);

1121 i‡(
n
 == 0)

1125 
	`pxt4_es_ªmove_exã¡
(
öode
, 
œ°_block
, 
EXT_MAX_BLOCKS
 -Üast_block);

1134 
ei
->
i_disksize
 = 
öode
->
i_size
;

1136 i‡(
œ°_block
 =
max_block
) {

1142 } i‡(
n
 == 1) {

1143 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
+
off£ts
[0],

1144 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1145 
do_ödúe˘s
;

1148 
∑πül
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1150 i‡(
ƒ
) {

1151 i‡(
∑πül
 =
chaö
) {

1153 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1154 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1155 *
∑πül
->
p
 = 0;

1162 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1163 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1164 
∑πül
->
p
,

1165 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1169 
∑πül
 > 
chaö
) {

1170 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,Ö¨tül->
p
 + 1,

1171 (
__À32
*)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1172 (
chaö
+
n
-1Ë- 
∑πül
);

1173 
	`BUFFER_TRACE
(
∑πül
->
bh
, "call brelse");

1174 
	`bªl£
(
∑πül
->
bh
);

1175 
∑πül
--;

1177 
do_ödúe˘s
:

1179 
off£ts
[0]) {

1181 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1182 i‡(
ƒ
) {

1183 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1184 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1187 
PXT4_IND_BLOCK
:

1188 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1189 i‡(
ƒ
) {

1190 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1191 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1194 
PXT4_DIND_BLOCK
:

1195 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1196 i‡(
ƒ
) {

1197 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1198 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1201 
PXT4_TIND_BLOCK
:

1204 
	}
}

1216 
	$pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1217 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
)

1219 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1220 
__À32
 *
i_d©a
 = 
ei
->i_data;

1221 
addr_≥r_block
 = 
	`PXT4_ADDR_PER_BLOCK
(
öode
->
i_sb
);

1222 
pxt4_lblk_t
 
off£ts
[4], 
off£ts2
[4];

1223 
Indúe˘
 
chaö
[4], 
chaö2
[4];

1224 
Indúe˘
 *
∑πül
, *
∑πül2
;

1225 
Indúe˘
 *
p
 = 
NULL
, *
p2
 = NULL;

1226 
pxt4_lblk_t
 
max_block
;

1227 
__À32
 
ƒ
 = 0, 
ƒ2
 = 0;

1228 
n
 = 0, 
n2
 = 0;

1229 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1231 
max_block
 = (
	`PXT4_SB
(
öode
->
i_sb
)->
s_bôm≠_maxbyãs
 + 
blocksize
-1)

1232 >> 
	`PXT4_BLOCK_SIZE_BITS
(
öode
->
i_sb
);

1233 i‡(
íd
 >
max_block
)

1234 
íd
 = 
max_block
;

1235 i‡((
°¨t
 >
íd
Ë|| (°¨à> 
max_block
))

1238 
n
 = 
	`pxt4_block_to_∑th
(
öode
, 
°¨t
, 
off£ts
, 
NULL
);

1239 
n2
 = 
	`pxt4_block_to_∑th
(
öode
, 
íd
, 
off£ts2
, 
NULL
);

1241 
	`BUG_ON
(
n
 > 
n2
);

1243 i‡((
n
 =1Ë&& (¿=
n2
)) {

1245 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1246 
i_d©a
 + 
off£ts2
[0]);

1248 } i‡(
n2
 > 
n
) {

1256 i‡(
n
 == 1) {

1261 
	`pxt4_‰ì_d©a
(
h™dÀ
, 
öode
, 
NULL
, 
i_d©a
 + 
off£ts
[0],

1262 
i_d©a
 + 
PXT4_NDIR_BLOCKS
);

1263 
íd_ønge
;

1267 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1268 i‡(
ƒ
) {

1269 i‡(
∑πül
 =
chaö
) {

1271 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1272 &
ƒ
, &ƒ+1, (
chaö
+
n
-1Ë- 
∑πül
);

1273 *
∑πül
->
p
 = 0;

1276 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1277 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1278 
∑πül
->
p
,

1279 
∑πül
->
p
+1, (
chaö
+
n
-1) -Öartial);

1287 
∑πül
 > 
chaö
) {

1288 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1289 
∑πül
->
p
 + 1,

1290 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1291 (
chaö
+
n
-1Ë- 
∑πül
);

1292 
∑πül
--;

1295 
íd_ønge
:

1296 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1297 i‡(
ƒ2
) {

1298 i‡(
∑πül2
 =
chaö2
) {

1305 
do_ödúe˘s
;

1314 
∑πül2
->
p
++;

1321 
∑πül2
 > 
chaö2
) {

1322 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1323 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1324 
∑πül2
->
p
,

1325 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1326 
∑πül2
--;

1328 
do_ödúe˘s
;

1332 
∑πül
 = 
p
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n
, 
off£ts
, 
chaö
, &
ƒ
);

1333 
∑πül2
 = 
p2
 = 
	`pxt4_föd_sh¨ed
(
öode
, 
n2
, 
off£ts2
, 
chaö2
, &
ƒ2
);

1336 i‡(
ƒ
) {

1337 
Àvñ
 = 
	`mö
(
∑πül
 - 
chaö
, 
∑πül2
 - 
chaö2
);

1338 
i
;

1339 
subåì
 = 1;

1341 
i
 = 0; i <
Àvñ
; i++) {

1342 i‡(
off£ts
[
i
] !
off£ts2
[i]) {

1343 
subåì
 = 0;

1348 i‡(!
subåì
) {

1349 i‡(
∑πül
 =
chaö
) {

1351 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
,

1352 &
ƒ
, &nr+1,

1353 (
chaö
+
n
-1Ë- 
∑πül
);

1354 *
∑πül
->
p
 = 0;

1357 
	`BUFFER_TRACE
(
∑πül
->
bh
, "get_write_access");

1358 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1359 
∑πül
->
p
,

1360 
∑πül
->
p
+1,

1361 (
chaö
+
n
-1Ë- 
∑πül
);

1366 i‡(!
ƒ2
) {

1373 
∑πül2
->
p
++;

1376 
∑πül
 > 
chaö
 || 
∑πül2
 > 
chaö2
) {

1377 
dïth
 = (
chaö
+
n
-1Ë- 
∑πül
;

1378 
dïth2
 = (
chaö2
+
n2
-1Ë- 
∑πül2
;

1380 i‡(
∑πül
 > 
chaö
 && 
∑πül2
 > 
chaö2
 &&

1381 
∑πül
->
bh
->
b_blockƒ
 =
∑πül2
->bh->b_blocknr) {

1386 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1387 
∑πül
->
p
 + 1,

1388 
∑πül2
->
p
,

1389 (
chaö
+
n
-1Ë- 
∑πül
);

1390 
˛ónup
;

1400 i‡(
∑πül
 > 
chaö
 && 
dïth
 <
dïth2
) {

1401 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül
->
bh
,

1402 
∑πül
->
p
 + 1,

1403 (
__À32
 *)
∑πül
->
bh
->
b_d©a
+
addr_≥r_block
,

1404 (
chaö
+
n
-1Ë- 
∑πül
);

1405 
∑πül
--;

1407 i‡(
∑πül2
 > 
chaö2
 && 
dïth2
 <
dïth
) {

1408 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
∑πül2
->
bh
,

1409 (
__À32
 *)
∑πül2
->
bh
->
b_d©a
,

1410 
∑πül2
->
p
,

1411 (
chaö2
+
n2
-1Ë- 
∑πül2
);

1412 
∑πül2
--;

1416 
˛ónup
:

1417 
p
 &&Ö > 
chaö
) {

1418 
	`BUFFER_TRACE
(
p
->
bh
, "call brelse");

1419 
	`bªl£
(
p
->
bh
);

1420 
p
--;

1422 
p2
 &&Ö2 > 
chaö2
) {

1423 
	`BUFFER_TRACE
(
p2
->
bh
, "call brelse");

1424 
	`bªl£
(
p2
->
bh
);

1425 
p2
--;

1429 
do_ödúe˘s
:

1431 
off£ts
[0]) {

1433 i‡(++
n
 >
n2
)

1435 
ƒ
 = 
i_d©a
[
PXT4_IND_BLOCK
];

1436 i‡(
ƒ
) {

1437 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 1);

1438 
i_d©a
[
PXT4_IND_BLOCK
] = 0;

1441 
PXT4_IND_BLOCK
:

1442 i‡(++
n
 >
n2
)

1444 
ƒ
 = 
i_d©a
[
PXT4_DIND_BLOCK
];

1445 i‡(
ƒ
) {

1446 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 2);

1447 
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1450 
PXT4_DIND_BLOCK
:

1451 i‡(++
n
 >
n2
)

1453 
ƒ
 = 
i_d©a
[
PXT4_TIND_BLOCK
];

1454 i‡(
ƒ
) {

1455 
	`pxt4_‰ì_bønches
(
h™dÀ
, 
öode
, 
NULL
, &
ƒ
, &nr+1, 3);

1456 
i_d©a
[
PXT4_TIND_BLOCK
] = 0;

1459 
PXT4_TIND_BLOCK
:

1462 
˛ónup
;

1463 
	}
}

	@inline.c

7 
	~<löux/iom≠.h
>

8 
	~<löux/fõm≠.h
>

9 
	~<löux/ivîsi⁄.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

14 
	~"åunˇã.h
"

16 
	#PXT4_XATTR_SYSTEM_DATA
 "d©a"

	)

17 
	#PXT4_MIN_INLINE_DATA_SIZE
 (((
__À32
Ë* 
PXT4_N_BLOCKS
))

	)

18 
	#PXT4_INLINE_DOTDOT_OFFSET
 2

	)

19 
	#PXT4_INLINE_DOTDOT_SIZE
 4

	)

21 
	$pxt4_gë_ölöe_size
(
öode
 *inode)

23 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
)

24  
	`PXT4_I
(
öode
)->
i_ölöe_size
;

27 
	}
}

29 
	$gë_max_ölöe_x©å_vÆue_size
(
öode
 *inode,

30 
pxt4_ûoc
 *
ûoc
)

32 
pxt4_x©å_ibody_hódî
 *
hódî
;

33 
pxt4_x©å_íåy
 *
íåy
;

34 
pxt4_öode
 *
øw_öode
;

35 
‰ì
, 
mö_offs
;

37 
mö_offs
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
 -

38 
PXT4_GOOD_OLD_INODE_SIZE
 -

39 
	`PXT4_I
(
öode
)->
i_exåa_isize
 -

40 (
pxt4_x©å_ibody_hódî
);

47 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

48  
	`PXT4_XATTR_SIZE
(
mö_offs
 -

49 
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
)) -

50 
PXT4_XATTR_ROUND
 - (
__u32
));

52 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

53 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

54 
íåy
 = 
	`IFIRST
(
hódî
);

57 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

58 i‡(!
íåy
->
e_vÆue_öum
 &&É¡ry->
e_vÆue_size
) {

59 
size_t
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

60 i‡(
offs
 < 
mö_offs
)

61 
mö_offs
 = 
offs
;

64 
‰ì
 = 
mö_offs
 -

65 ((*)
íåy
 - (*)
	`IFIRST
(
hódî
)Ë- (
__u32
);

67 i‡(
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

68 
íåy
 = (
pxt4_x©å_íåy
 *)

69 ((*)
øw_öode
 + 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

71 
‰ì
 +
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

72 
out
;

75 
‰ì
 -
	`PXT4_XATTR_LEN
(
	`°æí
(
PXT4_XATTR_SYSTEM_DATA
));

77 i‡(
‰ì
 > 
PXT4_XATTR_ROUND
)

78 
‰ì
 = 
	`PXT4_XATTR_SIZE
(‰ì - 
PXT4_XATTR_ROUND
);

80 
‰ì
 = 0;

82 
out
:

83  
‰ì
;

84 
	}
}

91 
	$pxt4_gë_max_ölöe_size
(
öode
 *inode)

93 
îr‹
, 
max_ölöe_size
;

94 
pxt4_ûoc
 
ûoc
;

96 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

99 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

100 i‡(
îr‹
) {

101 
	`pxt4_îr‹_öode
(
öode
, 
__func__
, 
__LINE__
, 0,

103 
öode
->
i_öo
);

107 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

108 
max_ölöe_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
öode
, &
ûoc
);

109 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

111 
	`bªl£
(
ûoc
.
bh
);

113 i‡(!
max_ölöe_size
)

116  
max_ölöe_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

117 
	}
}

124 
	$pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode)

126 
pxt4_x©å_ibody_föd
 
is
 = {

127 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

129 
pxt4_x©å_öfo
 
i
 = {

130 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

131 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

133 
îr‹
;

135 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

138 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

139 i‡(
îr‹
)

140  
îr‹
;

142 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

143 i‡(
îr‹
)

144 
out
;

146 i‡(!
is
.
s
.
nŸ_found
) {

147 i‡(
is
.
s
.
hîe
->
e_vÆue_öum
) {

148 
	`PXT4_ERROR_INODE
(
öode
, "inline data xattrÑefers "

150 
îr‹
 = -
EFSCORRUPTED
;

151 
out
;

153 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

154 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

155 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

156 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

157 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

159 
out
:

160 
	`bªl£
(
is
.
ûoc
.
bh
);

161  
îr‹
;

162 
	}
}

164 
	$pxt4_ªad_ölöe_d©a
(
öode
 *öode, *
buf„r
,

165 
Àn
,

166 
pxt4_ûoc
 *
ûoc
)

168 
pxt4_x©å_íåy
 *
íåy
;

169 
pxt4_x©å_ibody_hódî
 *
hódî
;

170 
˝_Àn
 = 0;

171 
pxt4_öode
 *
øw_öode
;

173 i‡(!
Àn
)

176 
	`BUG_ON
(
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

178 
˝_Àn
 = 
Àn
 < 
PXT4_MIN_INLINE_DATA_SIZE
 ?

179 
Àn
 : 
PXT4_MIN_INLINE_DATA_SIZE
;

181 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

182 
	`mem˝y
(
buf„r
, (*)(
øw_öode
->
i_block
), 
˝_Àn
);

184 
Àn
 -
˝_Àn
;

185 
buf„r
 +
˝_Àn
;

187 i‡(!
Àn
)

188 
out
;

190 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

191 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

192 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

193 
Àn
 = 
	`mö_t
(,Üen,

194 ()
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

196 
	`mem˝y
(
buf„r
,

197 (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
), 
Àn
);

198 
˝_Àn
 +
Àn
;

200 
out
:

201  
˝_Àn
;

202 
	}
}

210 
	$pxt4_wrôe_ölöe_d©a
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
,

211 *
buf„r
, 
loff_t
 
pos
, 
Àn
)

213 
pxt4_x©å_íåy
 *
íåy
;

214 
pxt4_x©å_ibody_hódî
 *
hódî
;

215 
pxt4_öode
 *
øw_öode
;

216 
˝_Àn
 = 0;

218 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

221 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

222 
	`BUG_ON
(
pos
 + 
Àn
 > 
	`PXT4_I
(
öode
)->
i_ölöe_size
);

224 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

225 
buf„r
 +
pos
;

227 i‡(
pos
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

228 
˝_Àn
 = 
pos
 + 
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

229 
PXT4_MIN_INLINE_DATA_SIZE
 - 
pos
 : 
Àn
;

230 
	`mem˝y
((*)
øw_öode
->
i_block
 + 
pos
, 
buf„r
, 
˝_Àn
);

232 
Àn
 -
˝_Àn
;

233 
buf„r
 +
˝_Àn
;

234 
pos
 +
˝_Àn
;

237 i‡(!
Àn
)

240 
pos
 -
PXT4_MIN_INLINE_DATA_SIZE
;

241 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

242 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
øw_öode
 +

243 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

245 
	`mem˝y
((*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
Ë+ 
pos
,

246 
buf„r
, 
Àn
);

247 
	}
}

249 
	$pxt4_¸óã_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
Àn
)

252 
îr‹
;

253 *
vÆue
 = 
NULL
;

254 
pxt4_x©å_ibody_föd
 
is
 = {

255 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

257 
pxt4_x©å_öfo
 
i
 = {

258 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

259 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

262 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

263 i‡(
îr‹
)

264  
îr‹
;

266 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

267 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

268 i‡(
îr‹
)

269 
out
;

271 i‡(
Àn
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

272 
vÆue
 = 
PXT4_ZERO_XATTR_VALUE
;

273 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

275 
vÆue
 = "";

276 
Àn
 = 0;

280 
i
.
vÆue
 = value;

281 
i
.
vÆue_Àn
 = 
Àn
;

283 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

284 i‡(
îr‹
)

285 
out
;

287 
	`BUG_ON
(!
is
.
s
.
nŸ_found
);

289 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

290 i‡(
îr‹
) {

291 i‡(
îr‹
 =-
ENOSPC
)

292 
	`pxt4_˛ór_öode_°©e
(
öode
,

293 
PXT4_STATE_MAY_INLINE_DATA
);

294 
out
;

297 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

298 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

300 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

301 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

302 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
Àn
 + 
PXT4_MIN_INLINE_DATA_SIZE
;

303 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

304 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

305 
	`gë_bh
(
is
.
ûoc
.
bh
);

306 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

308 
out
:

309 
	`bªl£
(
is
.
ûoc
.
bh
);

310  
îr‹
;

311 
	}
}

313 
	$pxt4_upd©e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

314 
Àn
)

316 
îr‹
;

317 *
vÆue
 = 
NULL
;

318 
pxt4_x©å_ibody_föd
 
is
 = {

319 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

321 
pxt4_x©å_öfo
 
i
 = {

322 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

323 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

327 i‡(
Àn
 <
	`PXT4_I
(
öode
)->
i_ölöe_size
)

330 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

331 i‡(
îr‹
)

332  
îr‹
;

334 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

335 i‡(
îr‹
)

336 
out
;

338 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

340 
Àn
 -
PXT4_MIN_INLINE_DATA_SIZE
;

341 
vÆue
 = 
	`kzÆloc
(
Àn
, 
GFP_NOFS
);

342 i‡(!
vÆue
) {

343 
îr‹
 = -
ENOMEM
;

344 
out
;

347 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
, i.
«me
,

348 
vÆue
, 
Àn
);

349 i‡(
îr‹
 =-
ENODATA
)

350 
out
;

352 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

353 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

354 i‡(
îr‹
)

355 
out
;

358 
i
.
vÆue
 = value;

359 
i
.
vÆue_Àn
 = 
Àn
;

361 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

362 i‡(
îr‹
)

363 
out
;

365 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = (
u16
)((*)
is
.
s
.
hîe
 -

366 (*)
	`pxt4_øw_öode
(&
is
.
ûoc
));

367 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 +

368 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

369 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

370 
	`gë_bh
(
is
.
ûoc
.
bh
);

371 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

373 
out
:

374 
	`k‰ì
(
vÆue
);

375 
	`bªl£
(
is
.
ûoc
.
bh
);

376  
îr‹
;

377 
	}
}

379 
	$pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

380 
Àn
)

382 
ªt
, 
size
, 
no_ex∑nd
;

383 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

385 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
))

386  -
ENOSPC
;

388 
size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

389 i‡(
size
 < 
Àn
)

390  -
ENOSPC
;

392 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

394 i‡(
ei
->
i_ölöe_off
)

395 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

397 
ªt
 = 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
Àn
);

399 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

400  
ªt
;

401 
	}
}

403 
	$pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

404 
öode
 *inode)

406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

407 
pxt4_x©å_ibody_föd
 
is
 = {

408 .
s
 = { .
nŸ_found
 = 0, },

410 
pxt4_x©å_öfo
 
i
 = {

411 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

412 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

413 .
vÆue
 = 
NULL
,

414 .
vÆue_Àn
 = 0,

416 
îr‹
;

418 i‡(!
ei
->
i_ölöe_off
)

421 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
);

422 i‡(
îr‹
)

423  
îr‹
;

425 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

426 i‡(
îr‹
)

427 
out
;

429 
	`BUFFER_TRACE
(
is
.
ûoc
.
bh
, "get_write_access");

430 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
is
.
ûoc
.
bh
);

431 i‡(
îr‹
)

432 
out
;

434 
îr‹
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

435 i‡(
îr‹
)

436 
out
;

438 
	`mem£t
((*)
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
,

439 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

440 
	`mem£t
(
ei
->
i_d©a
, 0, 
PXT4_MIN_INLINE_DATA_SIZE
);

442 i‡(
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
)) {

443 i‡(
	`S_ISDIR
(
öode
->
i_mode
) ||

444 
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) {

445 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

446 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode
);

449 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
);

451 
	`gë_bh
(
is
.
ûoc
.
bh
);

452 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

454 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

455 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 0;

456 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

457 
out
:

458 
	`bªl£
(
is
.
ûoc
.
bh
);

459 i‡(
îr‹
 =-
ENODATA
)

460 
îr‹
 = 0;

461  
îr‹
;

462 
	}
}

464 
	$pxt4_ªad_ölöe_∑ge
(
öode
 *öode, 
∑ge
 *page)

466 *
kaddr
;

467 
ªt
 = 0;

468 
size_t
 
Àn
;

469 
pxt4_ûoc
 
ûoc
;

471 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

472 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

473 
	`BUG_ON
(
∑ge
->
ödex
);

475 i‡(!
	`PXT4_I
(
öode
)->
i_ölöe_off
) {

476 
	`pxt4_w¨nög
(
öode
->
i_sb
, "inode %lu doesn't have inline data.",

477 
öode
->
i_öo
);

478 
out
;

481 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

482 i‡(
ªt
)

483 
out
;

485 
Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
), 
	`i_size_ªad
(inode));

486 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

487 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
kaddr
, 
Àn
, &
ûoc
);

488 
	`Êush_dˇche_∑ge
(
∑ge
);

489 
	`kunm≠_©omic
(
kaddr
);

490 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

491 
	`SëPageU±od©e
(
∑ge
);

492 
	`bªl£
(
ûoc
.
bh
);

494 
out
:

495  
ªt
;

496 
	}
}

498 
	$pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page)

500 
ªt
 = 0;

502 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

503 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

504 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

505  -
EAGAIN
;

512 i‡(!
∑ge
->
ödex
)

513 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

514 i‡(!
	`PageU±od©e
(
∑ge
)) {

515 
	`zîo_u£r_£gmít
(
∑ge
, 0, 
PAGE_SIZE
);

516 
	`SëPageU±od©e
(
∑ge
);

519 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

521 
	`u∆ock_∑ge
(
∑ge
);

522  
ªt
 >= 0 ? 0 :Ñet;

523 
	}
}

525 
	$pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

526 
öode
 *inode,

527 
Êags
)

529 
ªt
, 
√eded_blocks
, 
no_ex∑nd
;

530 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

531 
ªåõs
 = 0, 
£m_hñd
 = 0;

532 
∑ge
 *∑gê
NULL
;

533 
‰om
, 
to
;

534 
pxt4_ûoc
 
ûoc
;

536 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

541 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

545 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

547 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

548 i‡(
ªt
)

549  
ªt
;

551 
ªåy
:

552 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

553 i‡(
	`IS_ERR
(
h™dÀ
)) {

554 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

555 
h™dÀ
 = 
NULL
;

556 
out
;

561 
Êags
 |
AOP_FLAG_NOFS
;

563 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

564 i‡(!
∑ge
) {

565 
ªt
 = -
ENOMEM
;

566 
out
;

569 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

570 
£m_hñd
 = 1;

572 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

573 
ªt
 = 0;

574 
out
;

577 
‰om
 = 0;

578 
to
 = 
	`pxt4_gë_ölöe_size
(
öode
);

579 i‡(!
	`PageU±od©e
(
∑ge
)) {

580 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

581 i‡(
ªt
 < 0)

582 
out
;

585 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

586 i‡(
ªt
)

587 
out
;

589 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

590 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
,

591 
pxt4_gë_block_unwrôãn
);

593 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
‰om
, 
to
, 
pxt4_gë_block
);

595 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

596 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

597 
‰om
, 
to
, 
NULL
,

598 
do_jou∫Æ_gë_wrôe_ac˚ss
);

601 i‡(
ªt
) {

602 
	`u∆ock_∑ge
(
∑ge
);

603 
	`put_∑ge
(
∑ge
);

604 
∑ge
 = 
NULL
;

605 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

606 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

607 
£m_hñd
 = 0;

608 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

609 
h™dÀ
 = 
NULL
;

610 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

617 i‡(
öode
->
i_∆ök
)

618 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

621 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

622 
ªåy
;

624 i‡(
∑ge
)

625 
	`block_commô_wrôe
(
∑ge
, 
‰om
, 
to
);

626 
out
:

627 i‡(
∑ge
) {

628 
	`u∆ock_∑ge
(
∑ge
);

629 
	`put_∑ge
(
∑ge
);

631 i‡(
£m_hñd
)

632 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

633 i‡(
h™dÀ
)

634 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

635 
	`bªl£
(
ûoc
.
bh
);

636  
ªt
;

637 
	}
}

645 
	$pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

646 
öode
 *inode,

647 
loff_t
 
pos
, 
Àn
,

648 
Êags
,

649 
∑ge
 **
∑gï
)

651 
ªt
;

652 
h™dÀ_t
 *
h™dÀ
;

653 
∑ge
 *page;

654 
pxt4_ûoc
 
ûoc
;

656 i‡(
pos
 + 
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
))

657 
c⁄vît
;

659 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

660 i‡(
ªt
)

661  
ªt
;

667 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

668 i‡(
	`IS_ERR
(
h™dÀ
)) {

669 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

670 
h™dÀ
 = 
NULL
;

671 
out
;

674 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

675 i‡(
ªt
 &&Ñë !-
ENOSPC
)

676 
out
;

679 i‡(
ªt
 =-
ENOSPC
) {

680 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

681 
	`bªl£
(
ûoc
.
bh
);

682 
c⁄vît
;

685 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

686 i‡(
ªt
)

687 
out
;

689 
Êags
 |
AOP_FLAG_NOFS
;

691 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

692 i‡(!
∑ge
) {

693 
ªt
 = -
ENOMEM
;

694 
out
;

697 *
∑gï
 = 
∑ge
;

698 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

699 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

700 
ªt
 = 0;

701 
	`u∆ock_∑ge
(
∑ge
);

702 
	`put_∑ge
(
∑ge
);

703 
out_up_ªad
;

706 i‡(!
	`PageU±od©e
(
∑ge
)) {

707 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

708 i‡(
ªt
 < 0) {

709 
	`u∆ock_∑ge
(
∑ge
);

710 
	`put_∑ge
(
∑ge
);

711 
out_up_ªad
;

715 
ªt
 = 1;

716 
h™dÀ
 = 
NULL
;

717 
out_up_ªad
:

718 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

719 
out
:

720 i‡(
h™dÀ
 && (
ªt
 != 1))

721 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

722 
	`bªl£
(
ûoc
.
bh
);

723  
ªt
;

724 
c⁄vît
:

725  
	`pxt4_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

726 
öode
, 
Êags
);

727 
	}
}

729 
	$pxt4_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
,

730 
c›õd
, 
∑ge
 *page)

732 
ªt
, 
no_ex∑nd
;

733 *
kaddr
;

734 
pxt4_ûoc
 
ûoc
;

736 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
)) {

737 i‡(!
	`PageU±od©e
(
∑ge
)) {

738 
c›õd
 = 0;

739 
out
;

743 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

744 i‡(
ªt
) {

745 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

746 
c›õd
 = 0;

747 
out
;

750 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

751 
	`BUG_ON
(!
	`pxt4_has_ölöe_d©a
(
öode
));

753 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

754 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 
pos
, 
Àn
);

755 
	`kunm≠_©omic
(
kaddr
);

756 
	`SëPageU±od©e
(
∑ge
);

758 
	`CÀ¨PageDúty
(
∑ge
);

760 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

761 
	`bªl£
(
ûoc
.
bh
);

762 
	`m¨k_öode_dúty
(
öode
);

763 
out
:

764  
c›õd
;

765 
	}
}

767 
buf„r_hód
 *

768 
	$pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

769 
Àn
,

770 
∑ge
 *page)

772 
ªt
, 
no_ex∑nd
;

773 *
kaddr
;

774 
pxt4_ûoc
 
ûoc
;

776 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

777 i‡(
ªt
) {

778 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

779  
NULL
;

782 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

783 
kaddr
 = 
	`km≠_©omic
(
∑ge
);

784 
	`pxt4_wrôe_ölöe_d©a
(
öode
, &
ûoc
, 
kaddr
, 0, 
Àn
);

785 
	`kunm≠_©omic
(
kaddr
);

786 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

788  
ûoc
.
bh
;

789 
	}
}

800 
	$pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
addªss_•a˚
 *
m≠pög
,

801 
öode
 *inode,

802 
Êags
,

803 **
fsd©a
)

805 
ªt
 = 0, 
ölöe_size
;

806 
∑ge
 *page;

808 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

809 i‡(!
∑ge
)

810  -
ENOMEM
;

812 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

813 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

814 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

815 
out
;

818 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

820 i‡(!
	`PageU±od©e
(
∑ge
)) {

821 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

822 i‡(
ªt
 < 0)

823 
out
;

826 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 0, 
ölöe_size
,

827 
pxt4_da_gë_block_¥ï
);

828 i‡(
ªt
) {

829 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

830 
	`u∆ock_∑ge
(
∑ge
);

831 
	`put_∑ge
(
∑ge
);

832 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

833  
ªt
;

836 
	`SëPageDúty
(
∑ge
);

837 
	`SëPageU±od©e
(
∑ge
);

838 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

839 *
fsd©a
 = (*)
CONVERT_INLINE_DATA
;

841 
out
:

842 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

843 i‡(
∑ge
) {

844 
	`u∆ock_∑ge
(
∑ge
);

845 
	`put_∑ge
(
∑ge
);

847  
ªt
;

848 
	}
}

858 
	$pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

859 
öode
 *inode,

860 
loff_t
 
pos
, 
Àn
,

861 
Êags
,

862 
∑ge
 **
∑gï
,

863 **
fsd©a
)

865 
ªt
, 
ölöe_size
;

866 
h™dÀ_t
 *
h™dÀ
;

867 
∑ge
 *page;

868 
pxt4_ûoc
 
ûoc
;

869 
ªåõs
 = 0;

871 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

872 i‡(
ªt
)

873  
ªt
;

875 
ªåy_jou∫Æ
:

876 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

877 i‡(
	`IS_ERR
(
h™dÀ
)) {

878 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

879 
out
;

882 
ölöe_size
 = 
	`pxt4_gë_max_ölöe_size
(
öode
);

884 
ªt
 = -
ENOSPC
;

885 i‡(
ölöe_size
 >
pos
 + 
Àn
) {

886 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
pos
 + 
Àn
);

887 i‡(
ªt
 &&Ñë !-
ENOSPC
)

888 
out_jou∫Æ
;

895 
Êags
 |
AOP_FLAG_NOFS
;

897 i‡(
ªt
 =-
ENOSPC
) {

898 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

899 
ªt
 = 
	`pxt4_da_c⁄vît_ölöe_d©a_to_exã¡
(
m≠pög
,

900 
öode
,

901 
Êags
,

902 
fsd©a
);

903 i‡(
ªt
 =-
ENOSPC
 &&

904 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

905 
ªåy_jou∫Æ
;

906 
out
;

909 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 0, 
Êags
);

910 i‡(!
∑ge
) {

911 
ªt
 = -
ENOMEM
;

912 
out_jou∫Æ
;

915 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

916 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

917 
ªt
 = 0;

918 
out_ªÀa£_∑ge
;

921 i‡(!
	`PageU±od©e
(
∑ge
)) {

922 
ªt
 = 
	`pxt4_ªad_ölöe_∑ge
(
öode
, 
∑ge
);

923 i‡(
ªt
 < 0)

924 
out_ªÀa£_∑ge
;

926 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

927 i‡(
ªt
)

928 
out_ªÀa£_∑ge
;

930 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

931 *
∑gï
 = 
∑ge
;

932 
	`bªl£
(
ûoc
.
bh
);

934 
out_ªÀa£_∑ge
:

935 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

936 
	`u∆ock_∑ge
(
∑ge
);

937 
	`put_∑ge
(
∑ge
);

938 
out_jou∫Æ
:

939 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

940 
out
:

941 
	`bªl£
(
ûoc
.
bh
);

942  
ªt
;

943 
	}
}

945 
	$pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

946 
Àn
, 
c›õd
,

947 
∑ge
 *page)

949 
ªt
;

951 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
, 
∑ge
);

952 i‡(
ªt
 < 0) {

953 
	`u∆ock_∑ge
(
∑ge
);

954 
	`put_∑ge
(
∑ge
);

955  
ªt
;

957 
c›õd
 = 
ªt
;

966 i‡(
pos
+
c›õd
 > 
öode
->
i_size
)

967 
	`i_size_wrôe
(
öode
, 
pos
+
c›õd
);

968 
	`u∆ock_∑ge
(
∑ge
);

969 
	`put_∑ge
(
∑ge
);

977 
	`m¨k_öode_dúty
(
öode
);

979  
c›õd
;

980 
	}
}

982 #ifde‡
INLINE_DIR_DEBUG


983 
	$pxt4_show_ölöe_dú
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

984 *
ölöe_°¨t
, 
ölöe_size
)

986 
off£t
;

987 
de_Àn
;

988 
pxt4_dú_íåy_2
 *
de
 = 
ölöe_°¨t
;

989 *
dlimô
 = 
ölöe_°¨t
 + 
ölöe_size
;

991 
	`åa˚_¥ötk
("öodê%lu\n", 
dú
->
i_öo
);

992 
off£t
 = 0;

993 (*)
de
 < 
dlimô
) {

994 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

995 
	`åa˚_¥ötk
("de: off %uÑlen %uÇame %.*sÇlen %u ino %u\n",

996 
off£t
, 
de_Àn
, 
de
->
«me_Àn
, de->
«me
,

997 
de
->
«me_Àn
, 
	`À32_to_˝u
(de->
öode
));

998 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

999 
ölöe_°¨t
, 
ölöe_size
, 
off£t
))

1000 
	`BUG
();

1002 
off£t
 +
de_Àn
;

1003 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1005 
	}
}

1007 
	#pxt4_show_ölöe_dú
(
dú
, 
bh
, 
ölöe_°¨t
, 
ölöe_size
)

	)

1015 
	$pxt4_add_dúít_to_ölöe
(
h™dÀ_t
 *
h™dÀ
,

1016 
pxt4_fûíame
 *
‚ame
,

1017 
öode
 *
dú
,

1018 
öode
 *inode,

1019 
pxt4_ûoc
 *
ûoc
,

1020 *
ölöe_°¨t
, 
ölöe_size
)

1022 
îr
;

1023 
pxt4_dú_íåy_2
 *
de
;

1025 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
ûoc
->
bh
, 
ölöe_°¨t
,

1026 
ölöe_size
, 
‚ame
, &
de
);

1027 i‡(
îr
)

1028  
îr
;

1030 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

1031 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

1032 i‡(
îr
)

1033  
îr
;

1034 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
ölöe_size
, 
‚ame
);

1036 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
->
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1049 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1050 
	`pxt4_upd©e_dx_Êag
(
dú
);

1051 
	`öode_öc_ivîsi⁄
(
dú
);

1053 
	}
}

1055 *
	$pxt4_gë_ölöe_x©å_pos
(
öode
 *inode,

1056 
pxt4_ûoc
 *
ûoc
)

1058 
pxt4_x©å_íåy
 *
íåy
;

1059 
pxt4_x©å_ibody_hódî
 *
hódî
;

1061 
	`BUG_ON
(!
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1063 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(
ûoc
));

1064 
íåy
 = (
pxt4_x©å_íåy
 *)((*)
	`pxt4_øw_öode
(
ûoc
) +

1065 
	`PXT4_I
(
öode
)->
i_ölöe_off
);

1067  (*)
	`IFIRST
(
hódî
Ë+ 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

1068 
	}
}

1071 
	$pxt4_upd©e_föÆ_de
(*
de_buf
, 
ﬁd_size
, 
√w_size
)

1073 
pxt4_dú_íåy_2
 *
de
, *
¥ev_de
;

1074 *
limô
;

1075 
de_Àn
;

1077 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1078 i‡(
ﬁd_size
) {

1079 
limô
 = 
de_buf
 + 
ﬁd_size
;

1081 
¥ev_de
 = 
de
;

1082 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ﬁd_size
);

1083 
de_buf
 +
de_Àn
;

1084 
de
 = (
pxt4_dú_íåy_2
 *)
de_buf
;

1085 } 
de_buf
 < 
limô
);

1087 
¥ev_de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
de_Àn
 + 
√w_size
 -

1088 
ﬁd_size
, 
√w_size
);

1091 
de
->
öode
 = 0;

1092 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
√w_size
,Çew_size);

1094 
	}
}

1096 
	$pxt4_upd©e_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1097 
pxt4_ûoc
 *
ûoc
)

1099 
ªt
;

1100 
ﬁd_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
;

1101 
√w_size
 = 
	`gë_max_ölöe_x©å_vÆue_size
(
dú
, 
ûoc
);

1103 i‡(
√w_size
 - 
ﬁd_size
 <
	`PXT4_DIR_REC_LEN
(1))

1104  -
ENOSPC
;

1106 
ªt
 = 
	`pxt4_upd©e_ölöe_d©a
(
h™dÀ
, 
dú
,

1107 
√w_size
 + 
PXT4_MIN_INLINE_DATA_SIZE
);

1108 i‡(
ªt
)

1109  
ªt
;

1111 
	`pxt4_upd©e_föÆ_de
(
	`pxt4_gë_ölöe_x©å_pos
(
dú
, 
ûoc
), 
ﬁd_size
,

1112 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1113 
PXT4_MIN_INLINE_DATA_SIZE
);

1114 
dú
->
i_size
 = 
	`PXT4_I
(dú)->
i_disksize
 = PXT4_I(dú)->
i_ölöe_size
;

1116 
	}
}

1118 
	$pxt4_ª°‹e_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1119 
pxt4_ûoc
 *
ûoc
,

1120 *
buf
, 
ölöe_size
)

1122 
	`pxt4_¸óã_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1123 
	`pxt4_wrôe_ölöe_d©a
(
öode
, 
ûoc
, 
buf
, 0, 
ölöe_size
);

1124 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

1125 
	}
}

1127 
	$pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

1128 
öode
 *inode,

1129 
buf„r_hód
 *
dú_block
,

1130 *
buf
,

1131 
ölöe_size
)

1133 
îr
, 
csum_size
 = 0, 
hódî_size
 = 0;

1134 
pxt4_dú_íåy_2
 *
de
;

1135 
pxt4_dú_íåy_èû
 *
t
;

1136 *
èrgë
 = 
dú_block
->
b_d©a
;

1142 
de
 = (
pxt4_dú_íåy_2
 *)
èrgë
;

1143 
de
 = 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, de,

1144 
öode
->
i_sb
->
s_blocksize
, 
csum_size
,

1145 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
buf
)->
öode
), 1);

1146 
hódî_size
 = (*)
de
 - 
èrgë
;

1148 
	`mem˝y
((*)
de
, 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1149 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1151 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1152 
csum_size
 = (
pxt4_dú_íåy_èû
);

1154 
öode
->
i_size
 = inode->
i_sb
->
s_blocksize
;

1155 
	`i_size_wrôe
(
öode
, inode->
i_sb
->
s_blocksize
);

1156 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_sb
->
s_blocksize
;

1157 
	`pxt4_upd©e_föÆ_de
(
dú_block
->
b_d©a
,

1158 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
 + 
hódî_size
,

1159 
öode
->
i_sb
->
s_blocksize
 - 
csum_size
);

1161 i‡(
csum_size
) {

1162 
t
 = 
	`PXT4_DIRENT_TAIL
(
dú_block
->
b_d©a
,

1163 
öode
->
i_sb
->
s_blocksize
);

1164 
	`öôülize_dúít_èû
(
t
, 
öode
->
i_sb
->
s_blocksize
);

1166 
	`£t_buf„r_u±od©e
(
dú_block
);

1167 
îr
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
öode
, 
dú_block
);

1168 i‡(
îr
)

1169  
îr
;

1170 
	`£t_buf„r_vîifõd
(
dú_block
);

1171  
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1172 
	}
}

1174 
	$pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ_t
 *
h™dÀ
,

1175 
öode
 *inode,

1176 
pxt4_ûoc
 *
ûoc
)

1178 
îr‹
;

1179 *
buf
 = 
NULL
;

1180 
buf„r_hód
 *
d©a_bh
 = 
NULL
;

1181 
pxt4_m≠_blocks
 
m≠
;

1182 
ölöe_size
;

1184 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1185 
buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1186 i‡(!
buf
) {

1187 
îr‹
 = -
ENOMEM
;

1188 
out
;

1191 
îr‹
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
buf
, 
ölöe_size
, 
ûoc
);

1192 i‡(
îr‹
 < 0)

1193 
out
;

1199 i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

1200 
îr‹
 = 
	`pxt4_check_Æl_de
(
öode
, 
ûoc
->
bh
,

1201 
buf
 + 
PXT4_INLINE_DOTDOT_SIZE
,

1202 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
);

1203 i‡(
îr‹
)

1204 
out
;

1207 
îr‹
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1208 i‡(
îr‹
)

1209 
out
;

1211 
m≠
.
m_lblk
 = 0;

1212 
m≠
.
m_Àn
 = 1;

1213 
m≠
.
m_Êags
 = 0;

1214 
îr‹
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
PXT4_GET_BLOCKS_CREATE
);

1215 i‡(
îr‹
 < 0)

1216 
out_ª°‹e
;

1217 i‡(!(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
)) {

1218 
îr‹
 = -
EIO
;

1219 
out_ª°‹e
;

1222 
d©a_bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

1223 i‡(!
d©a_bh
) {

1224 
îr‹
 = -
ENOMEM
;

1225 
out_ª°‹e
;

1228 
	`lock_buf„r
(
d©a_bh
);

1229 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
d©a_bh
);

1230 i‡(
îr‹
) {

1231 
	`u∆ock_buf„r
(
d©a_bh
);

1232 
îr‹
 = -
EIO
;

1233 
out_ª°‹e
;

1235 
	`mem£t
(
d©a_bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

1237 i‡(!
	`S_ISDIR
(
öode
->
i_mode
)) {

1238 
	`mem˝y
(
d©a_bh
->
b_d©a
, 
buf
, 
ölöe_size
);

1239 
	`£t_buf„r_u±od©e
(
d©a_bh
);

1240 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1241 
öode
, 
d©a_bh
);

1243 
îr‹
 = 
	`pxt4_föish_c⁄vît_ölöe_dú
(
h™dÀ
, 
öode
, 
d©a_bh
,

1244 
buf
, 
ölöe_size
);

1247 
	`u∆ock_buf„r
(
d©a_bh
);

1248 
out_ª°‹e
:

1249 i‡(
îr‹
)

1250 
	`pxt4_ª°‹e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ûoc
, 
buf
, 
ölöe_size
);

1252 
out
:

1253 
	`bªl£
(
d©a_bh
);

1254 
	`k‰ì
(
buf
);

1255  
îr‹
;

1256 
	}
}

1263 
	$pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1264 
öode
 *
dú
, inode *inode)

1266 
ªt
, 
ölöe_size
, 
no_ex∑nd
;

1267 *
ölöe_°¨t
;

1268 
pxt4_ûoc
 
ûoc
;

1270 
ªt
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1271 i‡(
ªt
)

1272  
ªt
;

1274 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1275 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
))

1276 
out
;

1278 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1279 
PXT4_INLINE_DOTDOT_SIZE
;

1280 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1282 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, &
ûoc
,

1283 
ölöe_°¨t
, 
ölöe_size
);

1284 i‡(
ªt
 !-
ENOSPC
)

1285 
out
;

1288 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1289 
PXT4_MIN_INLINE_DATA_SIZE
;

1290 i‡(!
ölöe_size
) {

1292 
ªt
 = 
	`pxt4_upd©e_ölöe_dú
(
h™dÀ
, 
dú
, &
ûoc
);

1293 i‡(
ªt
 &&Ñë !-
ENOSPC
)

1294 
out
;

1296 
ölöe_size
 = 
	`PXT4_I
(
dú
)->
i_ölöe_size
 -

1297 
PXT4_MIN_INLINE_DATA_SIZE
;

1300 i‡(
ölöe_size
) {

1301 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1303 
ªt
 = 
	`pxt4_add_dúít_to_ölöe
(
h™dÀ
, 
‚ame
, 
dú
,

1304 
öode
, &
ûoc
, 
ölöe_°¨t
,

1305 
ölöe_size
);

1307 i‡(
ªt
 !-
ENOSPC
)

1308 
out
;

1316 
ªt
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
dú
, &
ûoc
);

1318 
out
:

1319 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1320 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1321 
	`bªl£
(
ûoc
.
bh
);

1322  
ªt
;

1323 
	}
}

1330 
	$håì_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

1331 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1332 
dx_hash_öfo
 *
höfo
,

1333 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

1334 *
has_ölöe_d©a
)

1336 
îr
 = 0, 
cou¡
 = 0;

1337 
∑ª¡_öo
;

1338 
pos
;

1339 
pxt4_dú_íåy_2
 *
de
;

1340 
öode
 *öodê
	`fûe_öode
(
dú_fûe
);

1341 
ªt
, 
ölöe_size
 = 0;

1342 
pxt4_ûoc
 
ûoc
;

1343 *
dú_buf
 = 
NULL
;

1344 
pxt4_dú_íåy_2
 
Áke
;

1345 
fs¸y±_°r
 
tmp_°r
;

1347 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1348 i‡(
ªt
)

1349  
ªt
;

1351 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1352 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1353 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1354 *
has_ölöe_d©a
 = 0;

1355 
out
;

1358 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1359 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1360 i‡(!
dú_buf
) {

1361 
ªt
 = -
ENOMEM
;

1362 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1363 
out
;

1366 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1367 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1368 i‡(
ªt
 < 0)

1369 
out
;

1371 
pos
 = 0;

1372 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1373 
pos
 < 
ölöe_size
) {

1379 i‡(
pos
 == 0) {

1380 
Áke
.
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1381 
Áke
.
«me_Àn
 = 1;

1382 
	`°r˝y
(
Áke
.
«me
, ".");

1383 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1384 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1385 
ölöe_size
);

1386 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1387 
de
 = &
Áke
;

1388 
pos
 = 
PXT4_INLINE_DOTDOT_OFFSET
;

1389 } i‡(
pos
 =
PXT4_INLINE_DOTDOT_OFFSET
) {

1390 
Áke
.
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

1391 
Áke
.
«me_Àn
 = 2;

1392 
	`°r˝y
(
Áke
.
«me
, "..");

1393 
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1394 
	`PXT4_DIR_REC_LEN
(
Áke
.
«me_Àn
),

1395 
ölöe_size
);

1396 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, &
Áke
, 
S_IFDIR
);

1397 
de
 = &
Áke
;

1398 
pos
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1400 
de
 = (
pxt4_dú_íåy_2
 *)(
dú_buf
 + 
pos
);

1401 
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1402 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
dú_fûe
, 
de
,

1403 
ûoc
.
bh
, 
dú_buf
,

1404 
ölöe_size
, 
pos
)) {

1405 
ªt
 = 
cou¡
;

1406 
out
;

1410 
	`pxt4fs_dúhash
(
de
->
«me
, de->
«me_Àn
, 
höfo
);

1411 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1412 ((
höfo
->
hash
 =
°¨t_hash
) &&

1413 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1415 i‡(
de
->
öode
 == 0)

1417 
tmp_°r
.
«me
 = 
de
->name;

1418 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1419 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 
höfo
->
hash
,

1420 
höfo
->
mö‹_hash
, 
de
, &
tmp_°r
);

1421 i‡(
îr
) {

1422 
cou¡
 = 
îr
;

1423 
out
;

1425 
cou¡
++;

1427 
ªt
 = 
cou¡
;

1428 
out
:

1429 
	`k‰ì
(
dú_buf
);

1430 
	`bªl£
(
ûoc
.
bh
);

1431  
ªt
;

1432 
	}
}

1442 
	$pxt4_ªad_ölöe_dú
(
fûe
 *file,

1443 
dú_c⁄ãxt
 *
˘x
,

1444 *
has_ölöe_d©a
)

1446 
off£t
, 
∑ª¡_öo
;

1447 
i
;

1448 
pxt4_dú_íåy_2
 *
de
;

1449 
su≥r_block
 *
sb
;

1450 
öode
 *öodê
	`fûe_öode
(
fûe
);

1451 
ªt
, 
ölöe_size
 = 0;

1452 
pxt4_ûoc
 
ûoc
;

1453 *
dú_buf
 = 
NULL
;

1454 
dŸdŸ_off£t
, 
dŸdŸ_size
, 
exåa_off£t
, 
exåa_size
;

1456 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1457 i‡(
ªt
)

1458  
ªt
;

1460 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1461 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1462 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1463 *
has_ölöe_d©a
 = 0;

1464 
out
;

1467 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1468 
dú_buf
 = 
	`kmÆloc
(
ölöe_size
, 
GFP_NOFS
);

1469 i‡(!
dú_buf
) {

1470 
ªt
 = -
ENOMEM
;

1471 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1472 
out
;

1475 
ªt
 = 
	`pxt4_ªad_ölöe_d©a
(
öode
, 
dú_buf
, 
ölöe_size
, &
ûoc
);

1476 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1477 i‡(
ªt
 < 0)

1478 
out
;

1480 
ªt
 = 0;

1481 
sb
 = 
öode
->
i_sb
;

1482 
∑ª¡_öo
 = 
	`À32_to_˝u
(((
pxt4_dú_íåy_2
 *)
dú_buf
)->
öode
);

1483 
off£t
 = 
˘x
->
pos
;

1492 
dŸdŸ_off£t
 = 
	`PXT4_DIR_REC_LEN
(1);

1493 
dŸdŸ_size
 = 
dŸdŸ_off£t
 + 
	`PXT4_DIR_REC_LEN
(2);

1494 
exåa_off£t
 = 
dŸdŸ_size
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1495 
exåa_size
 = 
exåa_off£t
 + 
ölöe_size
;

1503 i‡(!
	`öode_eq_ivîsi⁄
(
öode
, 
fûe
->
f_vîsi⁄
)) {

1504 
i
 = 0; i < 
exåa_size
 && i < 
off£t
;) {

1509 i‡(!
i
) {

1510 
i
 = 
dŸdŸ_off£t
;

1512 } i‡(
i
 =
dŸdŸ_off£t
) {

1513 
i
 = 
dŸdŸ_size
;

1519 
de
 = (
pxt4_dú_íåy_2
 *)

1520 (
dú_buf
 + 
i
 - 
exåa_off£t
);

1527 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
)

1528 < 
	`PXT4_DIR_REC_LEN
(1))

1530 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1531 
exåa_size
);

1533 
off£t
 = 
i
;

1534 
˘x
->
pos
 = 
off£t
;

1535 
fûe
->
f_vîsi⁄
 = 
	`öode_quîy_ivîsi⁄
(
öode
);

1538 
˘x
->
pos
 < 
exåa_size
) {

1539 i‡(
˘x
->
pos
 == 0) {

1540 i‡(!
	`dú_emô
(
˘x
, ".", 1, 
öode
->
i_öo
, 
DT_DIR
))

1541 
out
;

1542 
˘x
->
pos
 = 
dŸdŸ_off£t
;

1546 i‡(
˘x
->
pos
 =
dŸdŸ_off£t
) {

1547 i‡(!
	`dú_emô
(
˘x
, "..", 2, 
∑ª¡_öo
, 
DT_DIR
))

1548 
out
;

1549 
˘x
->
pos
 = 
dŸdŸ_size
;

1553 
de
 = (
pxt4_dú_íåy_2
 *)

1554 (
dú_buf
 + 
˘x
->
pos
 - 
exåa_off£t
);

1555 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
fûe
, 
de
, 
ûoc
.
bh
, 
dú_buf
,

1556 
exåa_size
, 
˘x
->
pos
))

1557 
out
;

1558 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1559 i‡(!
	`dú_emô
(
˘x
, 
de
->
«me
, de->
«me_Àn
,

1560 
	`À32_to_˝u
(
de
->
öode
),

1561 
	`gë_dty≥
(
sb
, 
de
->
fûe_ty≥
)))

1562 
out
;

1564 
˘x
->
pos
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
exåa_size
);

1566 
out
:

1567 
	`k‰ì
(
dú_buf
);

1568 
	`bªl£
(
ûoc
.
bh
);

1569  
ªt
;

1570 
	}
}

1572 
buf„r_hód
 *
	$pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

1573 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

1574 *
ªtvÆ
)

1576 
pxt4_ûoc
 
ûoc
;

1578 *
ªtvÆ
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1579 i‡(*
ªtvÆ
)

1580  
NULL
;

1582 *
∑ª¡_de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1584  
ûoc
.
bh
;

1585 
	}
}

1592 
	$pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1593 
öode
 *inode)

1595 
ªt
, 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1596 
pxt4_ûoc
 
ûoc
;

1597 
pxt4_dú_íåy_2
 *
de
;

1599 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1600 i‡(
ªt
)

1601  
ªt
;

1603 
ªt
 = 
	`pxt4_¥ï¨e_ölöe_d©a
(
h™dÀ
, 
öode
, 
ölöe_size
);

1604 i‡(
ªt
)

1605 
out
;

1611 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1612 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡
->
i_öo
);

1613 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
PXT4_INLINE_DOTDOT_SIZE
);

1614 
de
->
öode
 = 0;

1615 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

1616 
ölöe_size
 - 
PXT4_INLINE_DOTDOT_SIZE
,

1617 
ölöe_size
);

1618 
	`£t_∆ök
(
öode
, 2);

1619 
öode
->
i_size
 = 
	`PXT4_I
(öode)->
i_disksize
 = 
ölöe_size
;

1620 
out
:

1621 
	`bªl£
(
ûoc
.
bh
);

1622  
ªt
;

1623 
	}
}

1625 
buf„r_hód
 *
	$pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

1626 
pxt4_fûíame
 *
‚ame
,

1627 
pxt4_dú_íåy_2
 **
ªs_dú
,

1628 *
has_ölöe_d©a
)

1630 
ªt
;

1631 
pxt4_ûoc
 
ûoc
;

1632 *
ölöe_°¨t
;

1633 
ölöe_size
;

1635 i‡(
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
))

1636  
NULL
;

1638 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1639 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1640 *
has_ölöe_d©a
 = 0;

1641 
out
;

1644 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1645 
PXT4_INLINE_DOTDOT_SIZE
;

1646 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 - 
PXT4_INLINE_DOTDOT_SIZE
;

1647 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1648 
dú
, 
‚ame
, 0, 
ªs_dú
);

1649 i‡(
ªt
 == 1)

1650 
out_föd
;

1651 i‡(
ªt
 < 0)

1652 
out
;

1654 i‡(
	`pxt4_gë_ölöe_size
(
dú
Ë=
PXT4_MIN_INLINE_DATA_SIZE
)

1655 
out
;

1657 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1658 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
Ë- 
PXT4_MIN_INLINE_DATA_SIZE
;

1660 
ªt
 = 
	`pxt4_£¨ch_dú
(
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
,

1661 
dú
, 
‚ame
, 0, 
ªs_dú
);

1662 i‡(
ªt
 == 1)

1663 
out_föd
;

1665 
out
:

1666 
	`bªl£
(
ûoc
.
bh
);

1667 
ûoc
.
bh
 = 
NULL
;

1668 
out_föd
:

1669 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1670  
ûoc
.
bh
;

1671 
	}
}

1673 
	$pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

1674 
öode
 *
dú
,

1675 
pxt4_dú_íåy_2
 *
de_dñ
,

1676 
buf„r_hód
 *
bh
,

1677 *
has_ölöe_d©a
)

1679 
îr
, 
ölöe_size
, 
no_ex∑nd
;

1680 
pxt4_ûoc
 
ûoc
;

1681 *
ölöe_°¨t
;

1683 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1684 i‡(
îr
)

1685  
îr
;

1687 
	`pxt4_wrôe_lock_x©å
(
dú
, &
no_ex∑nd
);

1688 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1689 *
has_ölöe_d©a
 = 0;

1690 
out
;

1693 i‡((*)
de_dñ
 - ((*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
) <

1694 
PXT4_MIN_INLINE_DATA_SIZE
) {

1695 
ölöe_°¨t
 = (*)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
 +

1696 
PXT4_INLINE_DOTDOT_SIZE
;

1697 
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
 -

1698 
PXT4_INLINE_DOTDOT_SIZE
;

1700 
ölöe_°¨t
 = 
	`pxt4_gë_ölöe_x©å_pos
(
dú
, &
ûoc
);

1701 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
dú
) -

1702 
PXT4_MIN_INLINE_DATA_SIZE
;

1705 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1706 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1707 i‡(
îr
)

1708 
out
;

1710 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

1711 
ölöe_°¨t
, 
ölöe_size
, 0);

1712 i‡(
îr
)

1713 
out
;

1715 
	`pxt4_show_ölöe_dú
(
dú
, 
ûoc
.
bh
, 
ölöe_°¨t
, 
ölöe_size
);

1716 
out
:

1717 
	`pxt4_wrôe_u∆ock_x©å
(
dú
, &
no_ex∑nd
);

1718 i‡(
	`likñy
(
îr
 == 0))

1719 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1720 
	`bªl£
(
ûoc
.
bh
);

1721 i‡(
îr
 !-
ENOENT
)

1722 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1723  
îr
;

1724 
	}
}

1729 
ölöe
 
pxt4_dú_íåy_2
 *

1730 
	$pxt4_gë_ölöe_íåy
(
öode
 *inode,

1731 
pxt4_ûoc
 *
ûoc
,

1732 
off£t
,

1733 **
ölöe_°¨t
,

1734 *
ölöe_size
)

1736 *
ölöe_pos
;

1738 
	`BUG_ON
(
off£t
 > 
	`pxt4_gë_ölöe_size
(
öode
));

1740 i‡(
off£t
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1741 
ölöe_pos
 = (*)
	`pxt4_øw_öode
(
ûoc
)->
i_block
;

1742 *
ölöe_size
 = 
PXT4_MIN_INLINE_DATA_SIZE
;

1744 
ölöe_pos
 = 
	`pxt4_gë_ölöe_x©å_pos
(
öode
, 
ûoc
);

1745 
off£t
 -
PXT4_MIN_INLINE_DATA_SIZE
;

1746 *
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
) -

1747 
PXT4_MIN_INLINE_DATA_SIZE
;

1750 i‡(
ölöe_°¨t
)

1751 *
ölöe_°¨t
 = 
ölöe_pos
;

1752  (
pxt4_dú_íåy_2
 *)(
ölöe_pos
 + 
off£t
);

1753 
	}
}

1755 
boﬁ
 
	$em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
)

1757 
îr
, 
ölöe_size
;

1758 
pxt4_ûoc
 
ûoc
;

1759 
size_t
 
ölöe_Àn
;

1760 *
ölöe_pos
;

1761 
off£t
;

1762 
pxt4_dú_íåy_2
 *
de
;

1763 
boﬁ
 
ªt
 = 
åue
;

1765 
îr
 = 
	`pxt4_gë_öode_loc
(
dú
, &
ûoc
);

1766 i‡(
îr
) {

1767 
	`PXT4_ERROR_INODE
(
dú
, "error %d getting inode %lu block",

1768 
îr
, 
dú
->
i_öo
);

1769  
åue
;

1772 
	`down_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1773 i‡(!
	`pxt4_has_ölöe_d©a
(
dú
)) {

1774 *
has_ölöe_d©a
 = 0;

1775 
out
;

1778 
de
 = (
pxt4_dú_íåy_2
 *)
	`pxt4_øw_öode
(&
ûoc
)->
i_block
;

1779 i‡(!
	`À32_to_˝u
(
de
->
öode
)) {

1780 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1782 
dú
->
i_öo
);

1783 
ªt
 = 
åue
;

1784 
out
;

1787 
ölöe_Àn
 = 
	`pxt4_gë_ölöe_size
(
dú
);

1788 
off£t
 = 
PXT4_INLINE_DOTDOT_SIZE
;

1789 
off£t
 < 
ölöe_Àn
) {

1790 
de
 = 
	`pxt4_gë_ölöe_íåy
(
dú
, &
ûoc
, 
off£t
,

1791 &
ölöe_pos
, &
ölöe_size
);

1792 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
,

1793 
ûoc
.
bh
, 
ölöe_pos
,

1794 
ölöe_size
, 
off£t
)) {

1795 
	`pxt4_w¨nög
(
dú
->
i_sb
,

1799 
dú
->
i_öo
, 
	`À32_to_˝u
(
de
->
öode
),

1800 
	`À16_to_˝u
(
de
->
ªc_Àn
), de->
«me_Àn
,

1801 
ölöe_size
);

1802 
ªt
 = 
åue
;

1803 
out
;

1805 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

1806 
ªt
 = 
Ál£
;

1807 
out
;

1809 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
ölöe_size
);

1812 
out
:

1813 
	`up_ªad
(&
	`PXT4_I
(
dú
)->
x©å_£m
);

1814 
	`bªl£
(
ûoc
.
bh
);

1815  
ªt
;

1816 
	}
}

1818 
	$pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

1820 
ªt
, 
no_ex∑nd
;

1822 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1823 
ªt
 = 
	`pxt4_de°roy_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
);

1824 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1826  
ªt
;

1827 
	}
}

1829 
	$pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap)

1831 
__u64
 
addr
;

1832 
îr‹
 = -
EAGAIN
;

1833 
pxt4_ûoc
 
ûoc
;

1835 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1836 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

1837 
out
;

1839 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1840 i‡(
îr‹
)

1841 
out
;

1843 
addr
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1844 
addr
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1845 
addr
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1847 
	`bªl£
(
ûoc
.
bh
);

1849 
iom≠
->
addr
 =áddr;

1850 
iom≠
->
off£t
 = 0;

1851 
iom≠
->
Àngth
 = 
	`mö_t
(
loff_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1852 
	`i_size_ªad
(
öode
));

1853 
iom≠
->
ty≥
 = 
IOMAP_INLINE
;

1854 
iom≠
->
Êags
 = 0;

1856 
out
:

1857 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1858  
îr‹
;

1859 
	}
}

1861 
	$pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

1862 
fõm≠_exã¡_öfo
 *
fõöfo
,

1863 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
)

1865 
__u64
 
physiˇl
 = 0;

1866 
__u64
 
ölöe_Àn
;

1867 
__u32
 
Êags
 = 
FIEMAP_EXTENT_DATA_INLINE
 | 
FIEMAP_EXTENT_NOT_ALIGNED
 |

1868 
FIEMAP_EXTENT_LAST
;

1869 
îr‹
 = 0;

1870 
pxt4_ûoc
 
ûoc
;

1872 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1873 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1874 *
has_ölöe
 = 0;

1875 
out
;

1877 
ölöe_Àn
 = 
	`mö_t
(
size_t
, 
	`pxt4_gë_ölöe_size
(
öode
),

1878 
	`i_size_ªad
(
öode
));

1879 i‡(
°¨t
 >
ölöe_Àn
)

1880 
out
;

1881 i‡(
°¨t
 + 
Àn
 < 
ölöe_Àn
)

1882 
ölöe_Àn
 = 
°¨t
 + 
Àn
;

1883 
ölöe_Àn
 -
°¨t
;

1885 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

1886 i‡(
îr‹
)

1887 
out
;

1889 
physiˇl
 = (
__u64
)
ûoc
.
bh
->
b_blockƒ
 << 
öode
->
i_sb
->
s_blocksize_bôs
;

1890 
physiˇl
 +(*)
	`pxt4_øw_öode
(&
ûoc
Ë- iloc.
bh
->
b_d©a
;

1891 
physiˇl
 +
	`off£tof
(
pxt4_öode
, 
i_block
);

1893 
	`bªl£
(
ûoc
.
bh
);

1894 
out
:

1895 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

1896 i‡(
physiˇl
)

1897 
îr‹
 = 
	`fõm≠_fûl_√xt_exã¡
(
fõöfo
, 
°¨t
, 
physiˇl
,

1898 
ölöe_Àn
, 
Êags
);

1899  (
îr‹
 < 0 ?Érror : 0);

1900 
	}
}

1902 
	$pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
)

1904 
h™dÀ_t
 *
h™dÀ
;

1905 
ölöe_size
, 
vÆue_Àn
, 
√eded_blocks
, 
no_ex∑nd
, 
îr
 = 0;

1906 
size_t
 
i_size
;

1907 *
vÆue
 = 
NULL
;

1908 
pxt4_x©å_ibody_föd
 
is
 = {

1909 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

1911 
pxt4_x©å_öfo
 
i
 = {

1912 .
«me_ödex
 = 
PXT4_XATTR_INDEX_SYSTEM
,

1913 .
«me
 = 
PXT4_XATTR_SYSTEM_DATA
,

1917 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

1918 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 
√eded_blocks
);

1919 i‡(
	`IS_ERR
(
h™dÀ
))

1920  
	`PTR_ERR
(
h™dÀ
);

1922 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

1923 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

1924 *
has_ölöe
 = 0;

1925 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1929 i‡((
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
)) != 0)

1930 
out
;

1932 i‡((
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
.
ûoc
)) != 0)

1933 
out
;

1935 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1936 
i_size
 = 
öode
->i_size;

1937 
ölöe_size
 = 
	`pxt4_gë_ölöe_size
(
öode
);

1938 
	`PXT4_I
(
öode
)->
i_disksize
 = 
i_size
;

1940 i‡(
i_size
 < 
ölöe_size
) {

1942 i‡(
ölöe_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
) {

1943 i‡((
îr
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
)) != 0)

1944 
out_îr‹
;

1946 
	`BUG_ON
(
is
.
s
.
nŸ_found
);

1948 
vÆue_Àn
 = 
	`À32_to_˝u
(
is
.
s
.
hîe
->
e_vÆue_size
);

1949 
vÆue
 = 
	`kmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1950 i‡(!
vÆue
) {

1951 
îr
 = -
ENOMEM
;

1952 
out_îr‹
;

1955 
îr
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
i
.
«me_ödex
,

1956 
i
.
«me
, 
vÆue
, 
vÆue_Àn
);

1957 i‡(
îr
 <= 0)

1958 
out_îr‹
;

1960 
i
.
vÆue
 = value;

1961 
i
.
vÆue_Àn
 = 
i_size
 > 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1962 
i_size
 - 
PXT4_MIN_INLINE_DATA_SIZE
 : 0;

1963 
îr
 = 
	`pxt4_x©å_ibody_ölöe_£t
(
h™dÀ
, 
öode
,

1964 &
i
, &
is
);

1965 i‡(
îr
)

1966 
out_îr‹
;

1970 i‡(
i_size
 < 
PXT4_MIN_INLINE_DATA_SIZE
) {

1971 *
p
 = (*Ë
	`pxt4_øw_öode
(&
is
.
ûoc
)->
i_block
;

1972 
	`mem£t
(
p
 + 
i_size
, 0,

1973 
PXT4_MIN_INLINE_DATA_SIZE
 - 
i_size
);

1976 
	`PXT4_I
(
öode
)->
i_ölöe_size
 = 
i_size
 <

1977 
PXT4_MIN_INLINE_DATA_SIZE
 ?

1978 
PXT4_MIN_INLINE_DATA_SIZE
 : 
i_size
;

1981 
out_îr‹
:

1982 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1983 
out
:

1984 
	`bªl£
(
is
.
ûoc
.
bh
);

1985 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

1986 
	`k‰ì
(
vÆue
);

1987 i‡(
öode
->
i_∆ök
)

1988 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

1990 i‡(
îr
 == 0) {

1991 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

1992 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1993 i‡(
	`IS_SYNC
(
öode
))

1994 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1996 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1997  
îr
;

1998 
	}
}

2000 
	$pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode)

2002 
îr‹
, 
√eded_blocks
, 
no_ex∑nd
;

2003 
h™dÀ_t
 *
h™dÀ
;

2004 
pxt4_ûoc
 
ûoc
;

2006 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

2007 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
);

2011 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

2013 
ûoc
.
bh
 = 
NULL
;

2014 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2015 i‡(
îr‹
)

2016  
îr‹
;

2018 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

2019 i‡(
	`IS_ERR
(
h™dÀ
)) {

2020 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2021 
out_‰ì
;

2024 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2025 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

2026 
îr‹
 = 
	`pxt4_c⁄vît_ölöe_d©a_nﬁock
(
h™dÀ
, 
öode
, &
ûoc
);

2027 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2028 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2029 
out_‰ì
:

2030 
	`bªl£
(
ûoc
.
bh
);

2031  
îr‹
;

2032 
	}
}

	@inode.c

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/highuid.h
>

25 
	~<löux/∑gem≠.h
>

26 
	~<löux/dax.h
>

27 
	~<löux/quŸa›s.h
>

28 
	~<löux/°rög.h
>

29 
	~<löux/buf„r_hód.h
>

30 
	~<löux/wrôeback.h
>

31 
	~<löux/∑gevec.h
>

32 
	~<löux/m∑ge.h
>

33 
	~<löux/«mei.h
>

34 
	~<löux/uio.h
>

35 
	~<löux/bio.h
>

36 
	~<löux/w‹kqueue.h
>

37 
	~<löux/kî√l.h
>

38 
	~<löux/¥ötk.h
>

39 
	~<löux/¶ab.h
>

40 
	~<löux/bô›s.h
>

41 
	~<löux/iom≠.h
>

42 
	~<löux/ivîsi⁄.h
>

44 
	~"pxt4_jbd3.h
"

45 
	~"x©å.h
"

46 
	~"a˛.h
"

47 
	~"åunˇã.h
"

49 
	~<åa˚/evíts/pxt4.h
>

51 
	#MPAGE_DA_EXTENT_TAIL
 0x01

	)

53 
__u32
 
	$pxt4_öode_csum
(
öode
 *öode, 
pxt4_öode
 *
øw
,

54 
pxt4_öode_öfo
 *
ei
)

56 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

57 
__u32
 
csum
;

58 
__u16
 
dummy_csum
 = 0;

59 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_lo
);

60 
csum_size
 = (
dummy_csum
);

62 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
øw
, 
off£t
);

63 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, 
csum_size
);

64 
off£t
 +
csum_size
;

65 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

66 
PXT4_GOOD_OLD_INODE_SIZE
 - 
off£t
);

68 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

69 
off£t
 = 
	`off£tof
(
pxt4_öode
, 
i_checksum_hi
);

70 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 +

71 
PXT4_GOOD_OLD_INODE_SIZE
,

72 
off£t
 - 
PXT4_GOOD_OLD_INODE_SIZE
);

73 i‡(
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
)) {

74 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
,

75 
csum_size
);

76 
off£t
 +
csum_size
;

78 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
øw
 + 
off£t
,

79 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

82  
csum
;

83 
	}
}

85 
	$pxt4_öode_csum_vîify
(
öode
 *öode, 
pxt4_öode
 *
øw
,

86 
pxt4_öode_öfo
 *
ei
)

88 
__u32
 
¥ovided
, 
ˇlcuœãd
;

90 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

91 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

92 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

95 
¥ovided
 = 
	`À16_to_˝u
(
øw
->
i_checksum_lo
);

96 
ˇlcuœãd
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

97 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

98 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

99 
¥ovided
 |((
__u32
)
	`À16_to_˝u
(
øw
->
i_checksum_hi
)) << 16;

101 
ˇlcuœãd
 &= 0xFFFF;

103  
¥ovided
 =
ˇlcuœãd
;

104 
	}
}

106 
	$pxt4_öode_csum_£t
(
öode
 *öode, 
pxt4_öode
 *
øw
,

107 
pxt4_öode_öfo
 *
ei
)

109 
__u32
 
csum
;

111 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
->
s_¸ót‹_os
 !=

112 
	`˝u_to_À32
(
PXT4_OS_LINUX
) ||

113 !
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

116 
csum
 = 
	`pxt4_öode_csum
(
öode
, 
øw
, 
ei
);

117 
øw
->
i_checksum_lo
 = 
	`˝u_to_À16
(
csum
 & 0xFFFF);

118 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

119 
	`PXT4_FITS_IN_INODE
(
øw
, 
ei
, 
i_checksum_hi
))

120 
øw
->
i_checksum_hi
 = 
	`˝u_to_À16
(
csum
 >> 16);

121 
	}
}

123 
ölöe
 
	$pxt4_begö_‹dîed_åunˇã
(
öode
 *inode,

124 
loff_t
 
√w_size
)

126 
	`åa˚_pxt4_begö_‹dîed_åunˇã
(
öode
, 
√w_size
);

133 i‡(!
	`PXT4_I
(
öode
)->
jöode
)

135  
	`jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
	`PXT4_JOURNAL
(
öode
),

136 
	`PXT4_I
(
öode
)->
jöode
,

137 
√w_size
);

138 
	}
}

140 
pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

141 
Àngth
);

142 
__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *∑ge, 
Àn
);

143 
pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

144 
pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

145 
≥xã¡s
);

151 
	$pxt4_öode_is_Á°_symlök
(
öode
 *inode)

153 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

154 
ó_blocks
 = 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 ?

155 
	`PXT4_CLUSTER_SIZE
(
öode
->
i_sb
) >> 9 : 0;

157 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

160  (
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 - 
ó_blocks
 == 0);

162  
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_size
 &&

163 (
öode
->
i_size
 < 
PXT4_N_BLOCKS
 * 4);

164 
	}
}

171 
	$pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

172 
nblocks
)

174 
ªt
;

182 
	`BUG_ON
(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
);

183 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

184 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

185 
ªt
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

186 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

187 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

189  
ªt
;

190 
	}
}

195 
	$pxt4_evi˘_öode
(
öode
 *inode)

197 
h™dÀ_t
 *
h™dÀ
;

198 
îr
;

199 
exåa_¸edôs
 = 3;

200 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

202 
	`åa˚_pxt4_evi˘_öode
(
öode
);

204 i‡(
öode
->
i_∆ök
) {

223 i‡(
öode
->
i_öo
 !
PXT4_JOURNAL_INO
 &&

224 
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

225 (
	`S_ISLNK
(
öode
->
i_mode
Ë|| 
	`S_ISREG
(inode->i_mode)) &&

226 
öode
->
i_d©a
.
ƒ∑ges
) {

227 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

228 
tid_t
 
commô_tid
 = 
	`PXT4_I
(
öode
)->
i_d©async_tid
;

230 
	`jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ
, 
commô_tid
);

231 
	`fûem≠_wrôe_™d_waô
(&
öode
->
i_d©a
);

233 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

235 
no_dñëe
;

238 i‡(
	`is_bad_öode
(
öode
))

239 
no_dñëe
;

240 
	`dquŸ_öôülize
(
öode
);

242 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

243 
	`pxt4_begö_‹dîed_åunˇã
(
öode
, 0);

244 
	`åunˇã_öode_∑ges_föÆ
(&
öode
->
i_d©a
);

250 
	`sb_°¨t_ötwrôe
(
öode
->
i_sb
);

252 i‡(!
	`IS_NOQUOTA
(
öode
))

253 
exåa_¸edôs
 +
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
);

255 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
,

256 
	`pxt4_blocks_f‹_åunˇã
(
öode
)+
exåa_¸edôs
);

257 i‡(
	`IS_ERR
(
h™dÀ
)) {

258 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
	`PTR_ERR
(
h™dÀ
));

264 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

265 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

266 
no_dñëe
;

269 i‡(
	`IS_SYNC
(
öode
))

270 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

279 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
))

280 
	`mem£t
(
	`PXT4_I
(
öode
)->
i_d©a
, 0, (PXT4_I(inode)->i_data));

281 
öode
->
i_size
 = 0;

282 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

283 i‡(
îr
) {

284 
	`pxt4_w¨nög
(
öode
->
i_sb
,

285 "couldn'àm¨k inodêdúty (î∏%d)", 
îr
);

286 
°›_h™dÀ
;

288 i‡(
öode
->
i_blocks
) {

289 
îr
 = 
	`pxt4_åunˇã
(
öode
);

290 i‡(
îr
) {

291 
	`pxt4_îr‹
(
öode
->
i_sb
,

293 
öode
->
i_öo
, 
îr
);

294 
°›_h™dÀ
;

299 
îr
 = 
	`pxt4_x©å_dñëe_öode
(
h™dÀ
, 
öode
, &
ó_öode_¨øy
,

300 
exåa_¸edôs
);

301 i‡(
îr
) {

302 
	`pxt4_w¨nög
(
öode
->
i_sb
, "x©å dñëê”º %d)", 
îr
);

303 
°›_h™dÀ
:

304 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

305 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

306 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

307 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

308 
no_dñëe
;

319 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

320 
	`PXT4_I
(
öode
)->
i_dtime
 = (
__u32
)
	`ktime_gë_ªÆ_£c⁄ds
();

329 i‡(
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
))

331 
	`pxt4_˛ór_öode
(
öode
);

333 
	`pxt4_‰ì_öode
(
h™dÀ
, 
öode
);

334 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

335 
	`sb_íd_ötwrôe
(
öode
->
i_sb
);

336 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

338 
no_dñëe
:

339 
	`pxt4_˛ór_öode
(
öode
);

340 
	}
}

342 #ifde‡
CONFIG_QUOTA


343 
qsize_t
 *
	$pxt4_gë_ª£rved_•a˚
(
öode
 *inode)

345  &
	`PXT4_I
(
öode
)->
i_ª£rved_quŸa
;

346 
	}
}

353 
	$pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

354 
u£d
, 
quŸa_˛aim
)

356 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

357 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

359 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

360 
	`åa˚_pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
u£d
, 
quŸa_˛aim
);

361 i‡(
	`u∆ikñy
(
u£d
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

362 
	`pxt4_w¨nög
(
öode
->
i_sb
, "%s: ino %lu, used %d "

364 
__func__
, 
öode
->
i_öo
, 
u£d
,

365 
ei
->
i_ª£rved_d©a_blocks
);

366 
	`WARN_ON
(1);

367 
u£d
 = 
ei
->
i_ª£rved_d©a_blocks
;

371 
ei
->
i_ª£rved_d©a_blocks
 -
u£d
;

372 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
u£d
);

374 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

377 i‡(
quŸa_˛aim
)

378 
	`dquŸ_˛aim_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

385 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
u£d
));

393 i‡((
ei
->
i_ª£rved_d©a_blocks
 == 0) &&

394 !
	`öode_is_›í_f‹_wrôe
(
öode
))

395 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

396 
	}
}

398 
	$__check_block_vÆidôy
(
öode
 *öode, c⁄° *
func
,

399 
löe
,

400 
pxt4_m≠_blocks
 *
m≠
)

402 i‡(!
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
öode
->
i_sb
), 
m≠
->
m_pblk
,

403 
m≠
->
m_Àn
)) {

404 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
m≠
->
m_pblk
,

406 "÷ígth %d)", (Ë
m≠
->
m_lblk
,

407 
m≠
->
m_pblk
, m≠->
m_Àn
);

408  -
EFSCORRUPTED
;

411 
	}
}

413 
	$pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
, 
pxt4_fsblk_t
 
pblk
,

414 
pxt4_lblk_t
 
Àn
)

416 
ªt
;

418 i‡(
	`IS_ENCRYPTED
(
öode
))

419  
	`fs¸y±_zîoout_ønge
(
öode
, 
lblk
, 
pblk
, 
Àn
);

421 
ªt
 = 
	`sb_issue_zîoout
(
öode
->
i_sb
, 
pblk
, 
Àn
, 
GFP_NOFS
);

422 i‡(
ªt
 > 0)

423 
ªt
 = 0;

425  
ªt
;

426 
	}
}

428 
	#check_block_vÆidôy
(
öode
, 
m≠
) \

429 
	`__check_block_vÆidôy
((
öode
), 
__func__
, 
__LINE__
, (
m≠
))

	)

431 #ifde‡
ES_AGGRESSIVE_TEST


432 
	$pxt4_m≠_blocks_es_ªcheck
(
h™dÀ_t
 *
h™dÀ
,

433 
öode
 *inode,

434 
pxt4_m≠_blocks
 *
es_m≠
,

435 
pxt4_m≠_blocks
 *
m≠
,

436 
Êags
)

438 
ªtvÆ
;

440 
m≠
->
m_Êags
 = 0;

448 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

449 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

450 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

451 
PXT4_GET_BLOCKS_KEEP_SIZE
);

453 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

454 
PXT4_GET_BLOCKS_KEEP_SIZE
);

456 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

462 i‡(
es_m≠
->
m_lblk
 !
m≠
->m_lblk ||

463 
es_m≠
->
m_Êags
 !
m≠
->m_flags ||

464 
es_m≠
->
m_pblk
 !
m≠
->m_pblk) {

465 
	`¥ötk
("ES cacheássertion failed for inode: %lu "

468 
öode
->
i_öo
, 
es_m≠
->
m_lblk
,És_m≠->
m_Àn
,

469 
es_m≠
->
m_pblk
,És_m≠->
m_Êags
, 
m≠
->
m_lblk
,

470 
m≠
->
m_Àn
, m≠->
m_pblk
, m≠->
m_Êags
,

471 
ªtvÆ
, 
Êags
);

473 
	}
}

498 
	$pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

499 
pxt4_m≠_blocks
 *
m≠
, 
Êags
)

501 
exã¡_°©us
 
es
;

502 
ªtvÆ
;

503 
ªt
 = 0;

504 #ifde‡
ES_AGGRESSIVE_TEST


505 
pxt4_m≠_blocks
 
‹ig_m≠
;

507 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

510 
m≠
->
m_Êags
 = 0;

511 
	`ext_debug
("pxt4_map_blocks(): inode %lu, flag %d, max_blocks %u,"

512 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
Êags
, 
m≠
->
m_Àn
,

513 (Ë
m≠
->
m_lblk
);

518 i‡(
	`u∆ikñy
(
m≠
->
m_Àn
 > 
INT_MAX
))

519 
m≠
->
m_Àn
 = 
INT_MAX
;

522 i‡(
	`u∆ikñy
(
m≠
->
m_lblk
 >
EXT_MAX_BLOCKS
))

523  -
EFSCORRUPTED
;

526 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, &
es
)) {

527 i‡(
	`pxt4_es_is_wrôãn
(&
es
Ë|| 
	`pxt4_es_is_unwrôãn
(&es)) {

528 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
) +

529 
m≠
->
m_lblk
 - 
es
.
es_lblk
;

530 
m≠
->
m_Êags
 |
	`pxt4_es_is_wrôãn
(&
es
) ?

531 
PXT4_MAP_MAPPED
 : 
PXT4_MAP_UNWRITTEN
;

532 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

533 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

534 
ªtvÆ
 = 
m≠
->
m_Àn
;

535 
m≠
->
m_Àn
 = 
ªtvÆ
;

536 } i‡(
	`pxt4_es_is_dñayed
(&
es
Ë|| 
	`pxt4_es_is_hﬁe
(&es)) {

537 
m≠
->
m_pblk
 = 0;

538 
ªtvÆ
 = 
es
.
es_Àn
 - (
m≠
->
m_lblk
 -És.
es_lblk
);

539 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

540 
ªtvÆ
 = 
m≠
->
m_Àn
;

541 
m≠
->
m_Àn
 = 
ªtvÆ
;

542 
ªtvÆ
 = 0;

544 
	`BUG_ON
(1);

546 #ifde‡
ES_AGGRESSIVE_TEST


547 
	`pxt4_m≠_blocks_es_ªcheck
(
h™dÀ
, 
öode
, 
m≠
,

548 &
‹ig_m≠
, 
Êags
);

550 
found
;

557 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

558 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

559 
	`¥ötk
("current inode flag : EXTENT\n");

560 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

561 
PXT4_GET_BLOCKS_KEEP_SIZE
);

563 
	`¥ötk
("current inode flag : INDIRECT\n");

564 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
 &

565 
PXT4_GET_BLOCKS_KEEP_SIZE
);

567 i‡(
ªtvÆ
 > 0) {

568 
°©us
;

570 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

571 
	`pxt4_w¨nög
(
öode
->
i_sb
,

574 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

575 
	`WARN_ON
(1);

578 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

579 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

580 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

581 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

582 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

583 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

584 
°©us
 |
EXTENT_STATUS_DELAYED
;

585 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
,

586 
m≠
->
m_Àn
, m≠->
m_pblk
, 
°©us
);

587 i‡(
ªt
 < 0)

588 
ªtvÆ
 = 
ªt
;

590 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

592 
found
:

593 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

594 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

595 i‡(
ªt
 != 0)

596  
ªt
;

600 i‡((
Êags
 & 
PXT4_GET_BLOCKS_CREATE
) == 0)

601  
ªtvÆ
;

610 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
)

616 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
))

617  
ªtvÆ
;

623 
m≠
->
m_Êags
 &~
PXT4_MAP_FLAGS
;

631 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

637 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)) {

638 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

640 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
Êags
);

642 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

648 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

657 i‡((
ªtvÆ
 > 0) &&

658 (
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
))

659 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
, 
ªtvÆ
, 1);

662 i‡(
ªtvÆ
 > 0) {

663 
°©us
;

665 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

666 
	`pxt4_w¨nög
(
öode
->
i_sb
,

669 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

670 
	`WARN_ON
(1);

680 i‡(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
 &&

681 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
 &&

682 
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
) {

683 
ªt
 = 
	`pxt4_issue_zîoout
(
öode
, 
m≠
->
m_lblk
,

684 
m≠
->
m_pblk
, m≠->
m_Àn
);

685 i‡(
ªt
) {

686 
ªtvÆ
 = 
ªt
;

687 
out_£m
;

695 i‡((
Êags
 & 
PXT4_GET_BLOCKS_PRE_IO
) &&

696 
	`pxt4_es_lookup_exã¡
(
öode
, 
m≠
->
m_lblk
, &
es
)) {

697 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

698 
out_£m
;

700 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

701 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

702 i‡(!(
Êags
 & 
PXT4_GET_BLOCKS_DELALLOC_RESERVE
) &&

703 !(
°©us
 & 
EXTENT_STATUS_WRITTEN
) &&

704 
	`pxt4_es_sˇn_ønge
(
öode
, &
pxt4_es_is_dñayed
, 
m≠
->
m_lblk
,

705 
m≠
->
m_lblk
 + m≠->
m_Àn
 - 1))

706 
°©us
 |
EXTENT_STATUS_DELAYED
;

707 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

708 
m≠
->
m_pblk
, 
°©us
);

709 i‡(
ªt
 < 0) {

710 
ªtvÆ
 = 
ªt
;

711 
out_£m
;

715 
out_£m
:

716 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

717 i‡(
ªtvÆ
 > 0 && 
m≠
->
m_Êags
 & 
PXT4_MAP_MAPPED
) {

718 
ªt
 = 
	`check_block_vÆidôy
(
öode
, 
m≠
);

719 i‡(
ªt
 != 0)

720  
ªt
;

727 i‡(
m≠
->
m_Êags
 & 
PXT4_MAP_NEW
 &&

728 !(
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) &&

729 !(
Êags
 & 
PXT4_GET_BLOCKS_ZERO
) &&

730 !
	`pxt4_is_quŸa_fûe
(
öode
) &&

731 
	`pxt4_should_‹dî_d©a
(
öode
)) {

732 i‡(
Êags
 & 
PXT4_GET_BLOCKS_IO_SUBMIT
)

733 
ªt
 = 
	`pxt4_jbd3_öode_add_waô
(
h™dÀ
, 
öode
);

735 
ªt
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
);

736 i‡(
ªt
)

737  
ªt
;

740  
ªtvÆ
;

741 
	}
}

747 
	$pxt4_upd©e_bh_°©e
(
buf„r_hód
 *
bh
, 
Êags
)

749 
ﬁd_°©e
;

750 
√w_°©e
;

752 
Êags
 &
PXT4_MAP_FLAGS
;

755 i‡(!
bh
->
b_∑ge
) {

756 
bh
->
b_°©e
 = (bh->b_°©ê& ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

765 
ﬁd_°©e
 = 
	`READ_ONCE
(
bh
->
b_°©e
);

766 
√w_°©e
 = (
ﬁd_°©e
 & ~
PXT4_MAP_FLAGS
Ë| 
Êags
;

767 } 
	`u∆ikñy
(

768 
	`cmpxchg
(&
bh
->
b_°©e
, 
ﬁd_°©e
, 
√w_°©e
) != old_state));

769 
	}
}

771 
	$_pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

772 
buf„r_hód
 *
bh
, 
Êags
)

774 
pxt4_m≠_blocks
 
m≠
;

775 
ªt
 = 0;

777 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

778  -
ERANGE
;

780 
m≠
.
m_lblk
 = 
iblock
;

781 
m≠
.
m_Àn
 = 
bh
->
b_size
 >> 
öode
->
i_blkbôs
;

783 
ªt
 = 
	`pxt4_m≠_blocks
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
(), 
öode
, &
m≠
,

784 
Êags
);

785 i‡(
ªt
 > 0) {

786 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

787 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

788 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

789 
ªt
 = 0;

790 } i‡(
ªt
 == 0) {

792 
bh
->
b_size
 = 
öode
->
i_sb
->
s_blocksize
 * 
m≠
.
m_Àn
;

794  
ªt
;

795 
	}
}

797 
	$pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

798 
buf„r_hód
 *
bh
, 
¸óã
)

800  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
,

801 
¸óã
 ? 
PXT4_GET_BLOCKS_CREATE
 : 0);

802 
	}
}

809 
	$pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

810 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

812 
	`pxt4_debug
("pxt4_get_block_unwritten: inode %lu, create flag %d\n",

813 
öode
->
i_öo
, 
¸óã
);

814  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
,

815 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

816 
	}
}

819 
	#DIO_MAX_BLOCKS
 4096

	)

826 
	$pxt4_gë_block_å™s
(
öode
 *öode, 
£˘‹_t
 
iblock
,

827 
buf„r_hód
 *
bh_ªsu…
, 
Êags
)

829 
dio_¸edôs
;

830 
h™dÀ_t
 *
h™dÀ
;

831 
ªåõs
 = 0;

832 
ªt
;

835 i‡(
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
 > 
DIO_MAX_BLOCKS
)

836 
bh_ªsu…
->
b_size
 = 
DIO_MAX_BLOCKS
 << 
öode
->
i_blkbôs
;

837 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
,

838 
bh_ªsu…
->
b_size
 >> 
öode
->
i_blkbôs
);

839 
ªåy
:

840 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
, 
dio_¸edôs
);

841 i‡(
	`IS_ERR
(
h™dÀ
))

842  
	`PTR_ERR
(
h™dÀ
);

844 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 
Êags
);

845 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

847 i‡(
ªt
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

848 
ªåy
;

849  
ªt
;

850 
	}
}

853 
	$pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

854 
buf„r_hód
 *
bh
, 
¸óã
)

857 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

859 i‡(!
¸óã
)

860  
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

861  
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh
, 
PXT4_GET_BLOCKS_CREATE
);

862 
	}
}

869 
	$pxt4_dio_gë_block_unwrôãn_async
(
öode
 *inode,

870 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

872 
ªt
;

875 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

877 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

878 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

887 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
)) {

888 i‡(!
bh_ªsu…
->
b_¥iv©e
) {

889 
pxt4_io_íd_t
 *
io_íd
;

891 
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

892 i‡(!
io_íd
)

893  -
ENOMEM
;

894 
bh_ªsu…
->
b_¥iv©e
 = 
io_íd
;

895 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
io_íd
);

897 
	`£t_buf„r_de„r_com∂ëi⁄
(
bh_ªsu…
);

900  
ªt
;

901 
	}
}

908 
	$pxt4_dio_gë_block_unwrôãn_sync
(
öode
 *inode,

909 
£˘‹_t
 
iblock
, 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

911 
ªt
;

914 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

916 
ªt
 = 
	`pxt4_gë_block_å™s
(
öode
, 
iblock
, 
bh_ªsu…
,

917 
PXT4_GET_BLOCKS_IO_CREATE_EXT
);

924 i‡(!
ªt
 && 
	`buf„r_unwrôãn
(
bh_ªsu…
))

925 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

927  
ªt
;

928 
	}
}

930 
	$pxt4_dio_gë_block_ovîwrôe
(
öode
 *öode, 
£˘‹_t
 
iblock
,

931 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
)

933 
ªt
;

935 
	`pxt4_debug
("pxt4_dio_get_block_overwrite: inode %lu, create flag %d\n",

936 
öode
->
i_öo
, 
¸óã
);

938 
	`WARN_ON_ONCE
(
	`pxt4_jou∫Æ_cuºít_h™dÀ
());

940 
ªt
 = 
	`_pxt4_gë_block
(
öode
, 
iblock
, 
bh_ªsu…
, 0);

945 
	`WARN_ON_ONCE
(!
	`buf„r_m≠≥d
(
bh_ªsu…
Ë|| 
	`buf„r_unwrôãn
(bh_result));

947  
ªt
;

948 
	}
}

954 
buf„r_hód
 *
	$pxt4_gëblk
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

955 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

957 
pxt4_m≠_blocks
 
m≠
;

958 
buf„r_hód
 *
bh
;

959 
¸óã
 = 
m≠_Êags
 & 
PXT4_GET_BLOCKS_CREATE
;

960 
îr
;

962 
	`J_ASSERT
(
h™dÀ
 !
NULL
 || 
¸óã
 == 0);

964 
m≠
.
m_lblk
 = 
block
;

965 
m≠
.
m_Àn
 = 1;

966 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
, 
m≠_Êags
);

968 i‡(
îr
 == 0)

969  
¸óã
 ? 
	`ERR_PTR
(-
ENOSPC
Ë: 
NULL
;

970 i‡(
îr
 < 0)

971  
	`ERR_PTR
(
îr
);

973 
bh
 = 
	`sb_gëblk
(
öode
->
i_sb
, 
m≠
.
m_pblk
);

974 i‡(
	`u∆ikñy
(!
bh
))

975  
	`ERR_PTR
(-
ENOMEM
);

976 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
) {

977 
	`J_ASSERT
(
¸óã
 != 0);

978 
	`J_ASSERT
(
h™dÀ
 !
NULL
);

987 
	`lock_buf„r
(
bh
);

988 
	`BUFFER_TRACE
(
bh
, "call get_create_access");

989 
îr
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

990 i‡(
	`u∆ikñy
(
îr
)) {

991 
	`u∆ock_buf„r
(
bh
);

992 
îrout
;

994 i‡(!
	`buf„r_u±od©e
(
bh
)) {

995 
	`mem£t
(
bh
->
b_d©a
, 0, 
öode
->
i_sb
->
s_blocksize
);

996 
	`£t_buf„r_u±od©e
(
bh
);

998 
	`u∆ock_buf„r
(
bh
);

999 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

1000 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1001 i‡(
	`u∆ikñy
(
îr
))

1002 
îrout
;

1004 
	`BUFFER_TRACE
(
bh
, "notáÇew buffer");

1005  
bh
;

1006 
îrout
:

1007 
	`bªl£
(
bh
);

1008  
	`ERR_PTR
(
îr
);

1009 
	}
}

1011 
buf„r_hód
 *
	$pxt4_bªad
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1012 
pxt4_lblk_t
 
block
, 
m≠_Êags
)

1014 
buf„r_hód
 *
bh
;

1016 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
öode
, 
block
, 
m≠_Êags
);

1017 i‡(
	`IS_ERR
(
bh
))

1018  
bh
;

1019 i‡(!
bh
 || 
	`buf„r_u±od©e
(bh))

1020  
bh
;

1021 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
bh
);

1022 
	`waô_⁄_buf„r
(
bh
);

1023 i‡(
	`buf„r_u±od©e
(
bh
))

1024  
bh
;

1025 
	`put_bh
(
bh
);

1026  
	`ERR_PTR
(-
EIO
);

1027 
	}
}

1030 
	$pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

1031 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
)

1033 
i
, 
îr
;

1035 
i
 = 0; i < 
bh_cou¡
; i++) {

1036 
bhs
[
i
] = 
	`pxt4_gëblk
(
NULL
, 
öode
, 
block
 + i, 0 );

1037 i‡(
	`IS_ERR
(
bhs
[
i
])) {

1038 
îr
 = 
	`PTR_ERR
(
bhs
[
i
]);

1039 
bh_cou¡
 = 
i
;

1040 
out_bªl£
;

1044 
i
 = 0; i < 
bh_cou¡
; i++)

1046 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i]))

1047 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1,

1048 &
bhs
[
i
]);

1050 i‡(!
waô
)

1053 
i
 = 0; i < 
bh_cou¡
; i++)

1054 i‡(
bhs
[
i
])

1055 
	`waô_⁄_buf„r
(
bhs
[
i
]);

1057 
i
 = 0; i < 
bh_cou¡
; i++) {

1058 i‡(
bhs
[
i
] && !
	`buf„r_u±od©e
(bhs[i])) {

1059 
îr
 = -
EIO
;

1060 
out_bªl£
;

1065 
out_bªl£
:

1066 
i
 = 0; i < 
bh_cou¡
; i++) {

1067 
	`bªl£
(
bhs
[
i
]);

1068 
bhs
[
i
] = 
NULL
;

1070  
îr
;

1071 
	}
}

1073 
	$pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1074 
buf„r_hód
 *
hód
,

1075 
‰om
,

1076 
to
,

1077 *
∑πül
,

1078 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

1079 
buf„r_hód
 *
bh
))

1081 
buf„r_hód
 *
bh
;

1082 
block_°¨t
, 
block_íd
;

1083 
blocksize
 = 
hód
->
b_size
;

1084 
îr
, 
ªt
 = 0;

1085 
buf„r_hód
 *
√xt
;

1087 
bh
 = 
hód
, 
block_°¨t
 = 0;

1088 
ªt
 =0 && (
bh
 !
hód
 || !
block_°¨t
);

1089 
block_°¨t
 = 
block_íd
, 
bh
 = 
√xt
) {

1090 
√xt
 = 
bh
->
b_this_∑ge
;

1091 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1092 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1093 i‡(
∑πül
 && !
	`buf„r_u±od©e
(
bh
))

1094 *
∑πül
 = 1;

1097 
îr
 = (*
‚
)(
h™dÀ
, 
bh
);

1098 i‡(!
ªt
)

1099 
ªt
 = 
îr
;

1101  
ªt
;

1102 
	}
}

1128 
	$do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

1129 
buf„r_hód
 *
bh
)

1131 
dúty
 = 
	`buf„r_dúty
(
bh
);

1132 
ªt
;

1134 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1144 i‡(
dúty
)

1145 
	`˛ór_buf„r_dúty
(
bh
);

1146 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

1147 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1148 i‡(!
ªt
 && 
dúty
)

1149 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1150  
ªt
;

1151 
	}
}

1153 #ifde‡
CONFIG_FS_ENCRYPTION


1154 
	$pxt4_block_wrôe_begö
(
∑ge
 *∑ge, 
loff_t
 
pos
, 
Àn
,

1155 
gë_block_t
 *
gë_block
)

1157 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1158 
to
 = 
‰om
 + 
Àn
;

1159 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1160 
block_°¨t
, 
block_íd
;

1161 
£˘‹_t
 
block
;

1162 
îr
 = 0;

1163 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

1164 
bbôs
;

1165 
buf„r_hód
 *
bh
, *
hód
, *
waô
[2], **
waô_bh
 = wait;

1166 
boﬁ
 
de¸y±
 = 
Ál£
;

1168 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1169 
	`BUG_ON
(
‰om
 > 
PAGE_SIZE
);

1170 
	`BUG_ON
(
to
 > 
PAGE_SIZE
);

1171 
	`BUG_ON
(
‰om
 > 
to
);

1173 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1174 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

1175 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1176 
bbôs
 = 
	`ûog2
(
blocksize
);

1177 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
bbôs
);

1179 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

1180 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

1181 
block_íd
 = 
block_°¨t
 + 
blocksize
;

1182 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

1183 i‡(
	`PageU±od©e
(
∑ge
)) {

1184 i‡(!
	`buf„r_u±od©e
(
bh
))

1185 
	`£t_buf„r_u±od©e
(
bh
);

1189 i‡(
	`buf„r_√w
(
bh
))

1190 
	`˛ór_buf„r_√w
(
bh
);

1191 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

1192 
	`WARN_ON
(
bh
->
b_size
 !
blocksize
);

1193 
îr
 = 
	`gë_block
(
öode
, 
block
, 
bh
, 1);

1194 i‡(
îr
)

1196 i‡(
	`buf„r_√w
(
bh
)) {

1197 i‡(
	`PageU±od©e
(
∑ge
)) {

1198 
	`˛ór_buf„r_√w
(
bh
);

1199 
	`£t_buf„r_u±od©e
(
bh
);

1200 
	`m¨k_buf„r_dúty
(
bh
);

1203 i‡(
block_íd
 > 
to
 || 
block_°¨t
 < 
‰om
)

1204 
	`zîo_u£r_£gmíts
(
∑ge
, 
to
, 
block_íd
,

1205 
block_°¨t
, 
‰om
);

1209 i‡(
	`PageU±od©e
(
∑ge
)) {

1210 i‡(!
	`buf„r_u±od©e
(
bh
))

1211 
	`£t_buf„r_u±od©e
(
bh
);

1214 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_dñay
(bh) &&

1215 !
	`buf„r_unwrôãn
(
bh
) &&

1216 (
block_°¨t
 < 
‰om
 || 
block_íd
 > 
to
)) {

1217 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1218 *
waô_bh
++ = 
bh
;

1219 
de¸y±
 = 
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
);

1225 
waô_bh
 > 
waô
) {

1226 
	`waô_⁄_buf„r
(*--
waô_bh
);

1227 i‡(!
	`buf„r_u±od©e
(*
waô_bh
))

1228 
îr
 = -
EIO
;

1230 i‡(
	`u∆ikñy
(
îr
))

1231 
	`∑ge_zîo_√w_buf„rs
(
∑ge
, 
‰om
, 
to
);

1232 i‡(
de¸y±
)

1233 
îr
 = 
	`fs¸y±_de¸y±_∑ge
(
∑ge
->
m≠pög
->
ho°
,Öage,

1234 
PAGE_SIZE
, 0, 
∑ge
->
ödex
);

1235  
îr
;

1236 
	}
}

1239 
	$pxt4_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

1240 
loff_t
 
pos
, 
Àn
, 
Êags
,

1241 
∑ge
 **
∑gï
, **
fsd©a
)

1243 
öode
 *öodê
m≠pög
->
ho°
;

1244 
ªt
, 
√eded_blocks
;

1245 
h™dÀ_t
 *
h™dÀ
;

1246 
ªåõs
 = 0;

1247 
∑ge
 *page;

1248 
pgoff_t
 
ödex
;

1249 
‰om
, 
to
;

1251 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

1252  -
EIO
;

1254 
	`åa˚_pxt4_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

1259 
√eded_blocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

1260 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

1261 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1262 
to
 = 
‰om
 + 
Àn
;

1264 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

1265 
ªt
 = 
	`pxt4_åy_to_wrôe_ölöe_d©a
(
m≠pög
, 
öode
, 
pos
, 
Àn
,

1266 
Êags
, 
∑gï
);

1267 i‡(
ªt
 < 0)

1268  
ªt
;

1269 i‡(
ªt
 == 1)

1280 
ªåy_gøb
:

1281 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

1282 i‡(!
∑ge
)

1283  -
ENOMEM
;

1284 
	`u∆ock_∑ge
(
∑ge
);

1286 
ªåy_jou∫Æ
:

1287 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
);

1288 i‡(
	`IS_ERR
(
h™dÀ
)) {

1289 
	`put_∑ge
(
∑ge
);

1290  
	`PTR_ERR
(
h™dÀ
);

1293 
	`lock_∑ge
(
∑ge
);

1294 i‡(
∑ge
->
m≠pög
 != mapping) {

1296 
	`u∆ock_∑ge
(
∑ge
);

1297 
	`put_∑ge
(
∑ge
);

1298 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1299 
ªåy_gøb
;

1302 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

1304 #ifde‡
CONFIG_FS_ENCRYPTION


1305 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1306 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1307 
pxt4_gë_block_unwrôãn
);

1309 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1310 
pxt4_gë_block
);

1312 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

1313 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

1314 
pxt4_gë_block_unwrôãn
);

1316 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_gë_block
);

1318 i‡(!
ªt
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

1319 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
),

1320 
‰om
, 
to
, 
NULL
,

1321 
do_jou∫Æ_gë_wrôe_ac˚ss
);

1324 i‡(
ªt
) {

1325 
	`u∆ock_∑ge
(
∑ge
);

1334 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && 
	`pxt4_ˇn_åunˇã
(inode))

1335 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1337 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1338 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
) {

1339 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1346 i‡(
öode
->
i_∆ök
)

1347 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1350 i‡(
ªt
 =-
ENOSPC
 &&

1351 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1352 
ªåy_jou∫Æ
;

1353 
	`put_∑ge
(
∑ge
);

1354  
ªt
;

1356 *
∑gï
 = 
∑ge
;

1357  
ªt
;

1358 
	}
}

1361 
	$wrôe_íd_‚
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1363 
ªt
;

1364 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_‰ìd
(bh))

1366 
	`£t_buf„r_u±od©e
(
bh
);

1367 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1368 
	`˛ór_buf„r_mëa
(
bh
);

1369 
	`˛ór_buf„r_¥io
(
bh
);

1370  
ªt
;

1371 
	}
}

1380 
	$pxt4_wrôe_íd
(
fûe
 *file,

1381 
addªss_•a˚
 *
m≠pög
,

1382 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1383 
∑ge
 *∑ge, *
fsd©a
)

1385 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1386 
öode
 *öodê
m≠pög
->
ho°
;

1387 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1388 
ªt
 = 0, 
ªt2
;

1389 
i_size_ch™ged
 = 0;

1390 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1392 
	`åa˚_pxt4_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1393 i‡(
ölöe_d©a
) {

1394 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1395 
c›õd
, 
∑ge
);

1396 i‡(
ªt
 < 0) {

1397 
	`u∆ock_∑ge
(
∑ge
);

1398 
	`put_∑ge
(
∑ge
);

1399 
îrout
;

1401 
c›õd
 = 
ªt
;

1403 
c›õd
 = 
	`block_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

1404 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

1409 
i_size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1410 
	`u∆ock_∑ge
(
∑ge
);

1411 
	`put_∑ge
(
∑ge
);

1413 i‡(
ﬁd_size
 < 
pos
)

1414 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1421 i‡(
i_size_ch™ged
 || 
ölöe_d©a
)

1422 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1424 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && 
	`pxt4_ˇn_åunˇã
(inode))

1429 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1430 
îrout
:

1431 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1432 i‡(!
ªt
)

1433 
ªt
 = 
ªt2
;

1435 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
) {

1436 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1442 i‡(
öode
->
i_∆ök
)

1443 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1446  
ªt
 ?Ñë : 
c›õd
;

1447 
	}
}

1454 
	$pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

1455 
∑ge
 *page,

1456 
‰om
, 
to
)

1458 
block_°¨t
 = 0, 
block_íd
;

1459 
buf„r_hód
 *
hód
, *
bh
;

1461 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1463 
block_íd
 = 
block_°¨t
 + 
bh
->
b_size
;

1464 i‡(
	`buf„r_√w
(
bh
)) {

1465 i‡(
block_íd
 > 
‰om
 && 
block_°¨t
 < 
to
) {

1466 i‡(!
	`PageU±od©e
(
∑ge
)) {

1467 
°¨t
, 
size
;

1469 
°¨t
 = 
	`max
(
‰om
, 
block_°¨t
);

1470 
size
 = 
	`mö
(
to
, 
block_íd
Ë- 
°¨t
;

1472 
	`zîo_u£r
(
∑ge
, 
°¨t
, 
size
);

1473 
	`wrôe_íd_‚
(
h™dÀ
, 
bh
);

1475 
	`˛ór_buf„r_√w
(
bh
);

1478 
block_°¨t
 = 
block_íd
;

1479 
bh
 = bh->
b_this_∑ge
;

1480 } 
bh
 !
hód
);

1481 
	}
}

1483 
	$pxt4_jou∫ÆÀd_wrôe_íd
(
fûe
 *file,

1484 
addªss_•a˚
 *
m≠pög
,

1485 
loff_t
 
pos
, 
Àn
, 
c›õd
,

1486 
∑ge
 *∑ge, *
fsd©a
)

1488 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

1489 
öode
 *öodê
m≠pög
->
ho°
;

1490 
loff_t
 
ﬁd_size
 = 
öode
->
i_size
;

1491 
ªt
 = 0, 
ªt2
;

1492 
∑πül
 = 0;

1493 
‰om
, 
to
;

1494 
size_ch™ged
 = 0;

1495 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

1497 
	`åa˚_pxt4_jou∫ÆÀd_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

1498 
‰om
 = 
pos
 & (
PAGE_SIZE
 - 1);

1499 
to
 = 
‰om
 + 
Àn
;

1501 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

1503 i‡(
ölöe_d©a
) {

1504 
ªt
 = 
	`pxt4_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
,

1505 
c›õd
, 
∑ge
);

1506 i‡(
ªt
 < 0) {

1507 
	`u∆ock_∑ge
(
∑ge
);

1508 
	`put_∑ge
(
∑ge
);

1509 
îrout
;

1511 
c›õd
 = 
ªt
;

1512 } i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
Ë&& !
	`PageU±od©e
(
∑ge
)) {

1513 
c›õd
 = 0;

1514 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
, 
‰om
, 
to
);

1516 i‡(
	`u∆ikñy
(
c›õd
 < 
Àn
))

1517 
	`pxt4_jou∫ÆÀd_zîo_√w_buf„rs
(
h™dÀ
, 
∑ge
,

1518 
‰om
 + 
c›õd
, 
to
);

1519 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 
‰om
,

1520 
‰om
 + 
c›õd
, &
∑πül
,

1521 
wrôe_íd_‚
);

1522 i‡(!
∑πül
)

1523 
	`SëPageU±od©e
(
∑ge
);

1525 
size_ch™ged
 = 
	`pxt4_upd©e_öode_size
(
öode
, 
pos
 + 
c›õd
);

1526 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

1527 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

1528 
	`u∆ock_∑ge
(
∑ge
);

1529 
	`put_∑ge
(
∑ge
);

1531 i‡(
ﬁd_size
 < 
pos
)

1532 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁd_size
, 
pos
);

1534 i‡(
size_ch™ged
 || 
ölöe_d©a
) {

1535 
ªt2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1536 i‡(!
ªt
)

1537 
ªt
 = 
ªt2
;

1540 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
 && 
	`pxt4_ˇn_åunˇã
(inode))

1545 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

1547 
îrout
:

1548 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1549 i‡(!
ªt
)

1550 
ªt
 = 
ªt2
;

1551 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
) {

1552 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

1558 i‡(
öode
->
i_∆ök
)

1559 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

1562  
ªt
 ?Ñë : 
c›õd
;

1563 
	}
}

1568 
	$pxt4_da_ª£rve_•a˚
(
öode
 *inode)

1570 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1571 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1572 
ªt
;

1579 
ªt
 = 
	`dquŸ_ª£rve_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1580 i‡(
ªt
)

1581  
ªt
;

1583 
	`•ö_lock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1584 i‡(
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 1, 0)) {

1585 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1586 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 1));

1587  -
ENOSPC
;

1589 
ei
->
i_ª£rved_d©a_blocks
++;

1590 
	`åa˚_pxt4_da_ª£rve_•a˚
(
öode
);

1591 
	`•ö_u∆ock
(&
ei
->
i_block_ª£rv©i⁄_lock
);

1594 
	}
}

1596 
	$pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
)

1598 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1599 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1601 i‡(!
to_‰ì
)

1604 
	`•ö_lock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1606 
	`åa˚_pxt4_da_ªÀa£_•a˚
(
öode
, 
to_‰ì
);

1607 i‡(
	`u∆ikñy
(
to_‰ì
 > 
ei
->
i_ª£rved_d©a_blocks
)) {

1614 
	`pxt4_w¨nög
(
öode
->
i_sb
, "pxt4_da_release_space: "

1616 "d©®blocks", 
öode
->
i_öo
, 
to_‰ì
,

1617 
ei
->
i_ª£rved_d©a_blocks
);

1618 
	`WARN_ON
(1);

1619 
to_‰ì
 = 
ei
->
i_ª£rved_d©a_blocks
;

1621 
ei
->
i_ª£rved_d©a_blocks
 -
to_‰ì
;

1624 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 
to_‰ì
);

1626 
	`•ö_u∆ock
(&
	`PXT4_I
(
öode
)->
i_block_ª£rv©i⁄_lock
);

1628 
	`dquŸ_ªÀa£_ª£rv©i⁄_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
to_‰ì
));

1629 
	}
}

1631 
	$pxt4_da_∑ge_ªÀa£_ª£rv©i⁄
(
∑ge
 *page,

1632 
off£t
,

1633 
Àngth
)

1635 
c⁄tiguous_blks
 = 0;

1636 
buf„r_hód
 *
hód
, *
bh
;

1637 
cuº_off
 = 0;

1638 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

1639 
°›
 = 
off£t
 + 
Àngth
;

1640 
pxt4_fsblk_t
 
lblk
;

1642 
	`BUG_ON
(
°›
 > 
PAGE_SIZE
 || st› < 
Àngth
);

1644 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

1645 
bh
 = 
hód
;

1647 
√xt_off
 = 
cuº_off
 + 
bh
->
b_size
;

1649 i‡(
√xt_off
 > 
°›
)

1652 i‡((
off£t
 <
cuº_off
Ë&& (
	`buf„r_dñay
(
bh
))) {

1653 
c⁄tiguous_blks
++;

1654 
	`˛ór_buf„r_dñay
(
bh
);

1655 } i‡(
c⁄tiguous_blks
) {

1656 
lblk
 = 
∑ge
->
ödex
 <<

1657 (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1658 
lblk
 +(
cuº_off
 >> 
öode
->
i_blkbôs
) -

1659 
c⁄tiguous_blks
;

1660 
	`pxt4_es_ªmove_blks
(
öode
, 
lblk
, 
c⁄tiguous_blks
);

1661 
c⁄tiguous_blks
 = 0;

1663 
cuº_off
 = 
√xt_off
;

1664 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

1666 i‡(
c⁄tiguous_blks
) {

1667 
lblk
 = 
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1668 
lblk
 +(
cuº_off
 >> 
öode
->
i_blkbôs
Ë- 
c⁄tiguous_blks
;

1669 
	`pxt4_es_ªmove_blks
(
öode
, 
lblk
, 
c⁄tiguous_blks
);

1672 
	}
}

1678 
	sm∑ge_da_d©a
 {

1679 
öode
 *
	möode
;

1680 
wrôeback_c⁄åﬁ
 *
	mwbc
;

1682 
pgoff_t
 
	mfú°_∑ge
;

1683 
pgoff_t
 
	m√xt_∑ge
;

1684 
pgoff_t
 
	mœ°_∑ge
;

1690 
pxt4_m≠_blocks
 
	mm≠
;

1691 
pxt4_io_submô
 
	mio_submô
;

1692 
	mdo_m≠
:1;

1695 
	$m∑ge_ªÀa£_unu£d_∑ges
(
m∑ge_da_d©a
 *
mpd
,

1696 
boﬁ
 
övÆid©e
)

1698 
ƒ_∑ges
, 
i
;

1699 
pgoff_t
 
ödex
, 
íd
;

1700 
∑gevec
 
pvec
;

1701 
öode
 *öodê
mpd
->inode;

1702 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

1705 i‡(
mpd
->
fú°_∑ge
 >mpd->
√xt_∑ge
)

1708 
ödex
 = 
mpd
->
fú°_∑ge
;

1709 
íd
 = 
mpd
->
√xt_∑ge
 - 1;

1710 i‡(
övÆid©e
) {

1711 
pxt4_lblk_t
 
°¨t
, 
œ°
;

1712 
°¨t
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1713 
œ°
 = 
íd
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

1714 
	`pxt4_es_ªmove_exã¡
(
öode
, 
°¨t
, 
œ°
 - start + 1);

1717 
	`∑gevec_öô
(&
pvec
);

1718 
ödex
 <
íd
) {

1719 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
);

1720 i‡(
ƒ_∑ges
 == 0)

1722 
i
 = 0; i < 
ƒ_∑ges
; i++) {

1723 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

1725 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

1726 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

1727 i‡(
övÆid©e
) {

1728 i‡(
	`∑ge_m≠≥d
(
∑ge
))

1729 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

1730 
	`block_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

1731 
	`CÀ¨PageU±od©e
(
∑ge
);

1733 
	`u∆ock_∑ge
(
∑ge
);

1735 
	`∑gevec_ªÀa£
(&
pvec
);

1737 
	}
}

1739 
	$pxt4_¥öt_‰ì_blocks
(
öode
 *inode)

1741 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1742 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1743 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1745 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Total free blocks count %lld",

1746 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

1747 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
)));

1748 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Free/Dirty block details");

1749 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "free_blocks=%lld",

1750 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1751 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_‰ì˛u°îs_cou¡î
)));

1752 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "dirty_blocks=%lld",

1753 (Ë
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

1754 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

1755 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "BlockÑeservation details");

1756 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "i_reserved_data_blocks=%u",

1757 
ei
->
i_ª£rved_d©a_blocks
);

1759 
	}
}

1761 
	$pxt4_bh_dñay_‹_unwrôãn
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1763  (
	`buf„r_dñay
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)Ë&& 
	`buf„r_dúty
(bh);

1764 
	}
}

1777 
	$pxt4_ö£π_dñayed_block
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
)

1779 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

1780 
ªt
;

1781 
boﬁ
 
Æloˇãd
 = 
Ál£
;

1794 i‡(
sbi
->
s_˛u°î_øtio
 == 1) {

1795 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1796 i‡(
ªt
 != 0)

1797 
îrout
;

1799 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
, &
pxt4_es_is_dñ⁄ly
, 
lblk
)) {

1800 i‡(!
	`pxt4_es_sˇn_˛u
(
öode
,

1801 &
pxt4_es_is_m≠≥d
, 
lblk
)) {

1802 
ªt
 = 
	`pxt4_˛u_m≠≥d
(
öode
,

1803 
	`PXT4_B2C
(
sbi
, 
lblk
));

1804 i‡(
ªt
 < 0)

1805 
îrout
;

1806 i‡(
ªt
 == 0) {

1807 
ªt
 = 
	`pxt4_da_ª£rve_•a˚
(
öode
);

1808 i‡(
ªt
 != 0)

1809 
îrout
;

1811 
Æloˇãd
 = 
åue
;

1814 
Æloˇãd
 = 
åue
;

1819 
ªt
 = 
	`pxt4_es_ö£π_dñayed_block
(
öode
, 
lblk
, 
Æloˇãd
);

1821 
îrout
:

1822  
ªt
;

1823 
	}
}

1831 
	$pxt4_da_m≠_blocks
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1832 
pxt4_m≠_blocks
 *
m≠
,

1833 
buf„r_hód
 *
bh
)

1835 
exã¡_°©us
 
es
;

1836 
ªtvÆ
;

1837 
£˘‹_t
 
övÆid_block
 = ~((sector_t) 0xffff);

1838 #ifde‡
ES_AGGRESSIVE_TEST


1839 
pxt4_m≠_blocks
 
‹ig_m≠
;

1841 
	`mem˝y
(&
‹ig_m≠
, 
m≠
, (*map));

1844 i‡(
övÆid_block
 < 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
))

1845 
övÆid_block
 = ~0;

1847 
m≠
->
m_Êags
 = 0;

1848 
	`ext_debug
("pxt4_da_map_blocks(): inode %lu, max_blocks %u,"

1849 "logiˇ»block %lu\n", 
öode
->
i_öo
, 
m≠
->
m_Àn
,

1850 (Ë
m≠
->
m_lblk
);

1853 i‡(
	`pxt4_es_lookup_exã¡
(
öode
, 
iblock
, &
es
)) {

1854 i‡(
	`pxt4_es_is_hﬁe
(&
es
)) {

1855 
ªtvÆ
 = 0;

1856 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1857 
add_dñayed
;

1864 i‡(
	`pxt4_es_is_dñayed
(&
es
Ë&& !
	`pxt4_es_is_unwrôãn
(&es)) {

1865 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1866 
	`£t_buf„r_√w
(
bh
);

1867 
	`£t_buf„r_dñay
(
bh
);

1871 
m≠
->
m_pblk
 = 
	`pxt4_es_pblock
(&
es
Ë+ 
iblock
 -És.
es_lblk
;

1872 
ªtvÆ
 = 
es
.
es_Àn
 - (
iblock
 -És.
es_lblk
);

1873 i‡(
ªtvÆ
 > 
m≠
->
m_Àn
)

1874 
ªtvÆ
 = 
m≠
->
m_Àn
;

1875 
m≠
->
m_Àn
 = 
ªtvÆ
;

1876 i‡(
	`pxt4_es_is_wrôãn
(&
es
))

1877 
m≠
->
m_Êags
 |
PXT4_MAP_MAPPED
;

1878 i‡(
	`pxt4_es_is_unwrôãn
(&
es
))

1879 
m≠
->
m_Êags
 |
PXT4_MAP_UNWRITTEN
;

1881 
	`BUG_ON
(1);

1883 #ifde‡
ES_AGGRESSIVE_TEST


1884 
	`pxt4_m≠_blocks_es_ªcheck
(
NULL
, 
öode
, 
m≠
, &
‹ig_m≠
, 0);

1886  
ªtvÆ
;

1893 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

1894 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

1895 
ªtvÆ
 = 0;

1896 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

1897 
ªtvÆ
 = 
	`pxt4_ext_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1899 
ªtvÆ
 = 
	`pxt4_öd_m≠_blocks
(
NULL
, 
öode
, 
m≠
, 0);

1901 
add_dñayed
:

1902 i‡(
ªtvÆ
 == 0) {

1903 
ªt
;

1910 
ªt
 = 
	`pxt4_ö£π_dñayed_block
(
öode
, 
m≠
->
m_lblk
);

1911 i‡(
ªt
 != 0) {

1912 
ªtvÆ
 = 
ªt
;

1913 
out_u∆ock
;

1916 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
övÆid_block
);

1917 
	`£t_buf„r_√w
(
bh
);

1918 
	`£t_buf„r_dñay
(
bh
);

1919 } i‡(
ªtvÆ
 > 0) {

1920 
ªt
;

1921 
°©us
;

1923 i‡(
	`u∆ikñy
(
ªtvÆ
 !
m≠
->
m_Àn
)) {

1924 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1927 
öode
->
i_öo
, 
ªtvÆ
, 
m≠
->
m_Àn
);

1928 
	`WARN_ON
(1);

1931 
°©us
 = 
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
 ?

1932 
EXTENT_STATUS_UNWRITTEN
 : 
EXTENT_STATUS_WRITTEN
;

1933 
ªt
 = 
	`pxt4_es_ö£π_exã¡
(
öode
, 
m≠
->
m_lblk
, m≠->
m_Àn
,

1934 
m≠
->
m_pblk
, 
°©us
);

1935 i‡(
ªt
 != 0)

1936 
ªtvÆ
 = 
ªt
;

1939 
out_u∆ock
:

1940 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

1942  
ªtvÆ
;

1943 
	}
}

1957 
	$pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

1958 
buf„r_hód
 *
bh
, 
¸óã
)

1960 
pxt4_m≠_blocks
 
m≠
;

1961 
ªt
 = 0;

1963 
	`BUG_ON
(
¸óã
 == 0);

1964 
	`BUG_ON
(
bh
->
b_size
 !
öode
->
i_sb
->
s_blocksize
);

1966 
m≠
.
m_lblk
 = 
iblock
;

1967 
m≠
.
m_Àn
 = 1;

1974 
ªt
 = 
	`pxt4_da_m≠_blocks
(
öode
, 
iblock
, &
m≠
, 
bh
);

1975 i‡(
ªt
 <= 0)

1976  
ªt
;

1978 
	`m≠_bh
(
bh
, 
öode
->
i_sb
, 
m≠
.
m_pblk
);

1979 
	`pxt4_upd©e_bh_°©e
(
bh
, 
m≠
.
m_Êags
);

1981 i‡(
	`buf„r_unwrôãn
(
bh
)) {

1988 
	`£t_buf„r_√w
(
bh
);

1989 
	`£t_buf„r_m≠≥d
(
bh
);

1992 
	}
}

1994 
	$bgë_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1996 
	`gë_bh
(
bh
);

1998 
	}
}

2000 
	$bput_⁄e
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

2002 
	`put_bh
(
bh
);

2004 
	}
}

2006 
	$__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
 *page,

2007 
Àn
)

2009 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

2010 
öode
 *öodê
m≠pög
->
ho°
;

2011 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2012 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2013 
ªt
 = 0, 
îr
 = 0;

2014 
ölöe_d©a
 = 
	`pxt4_has_ölöe_d©a
(
öode
);

2015 
buf„r_hód
 *
öode_bh
 = 
NULL
;

2017 
	`CÀ¨PageChecked
(
∑ge
);

2019 i‡(
ölöe_d©a
) {

2020 
	`BUG_ON
(
∑ge
->
ödex
 != 0);

2021 
	`BUG_ON
(
Àn
 > 
	`pxt4_gë_max_ölöe_size
(
öode
));

2022 
öode_bh
 = 
	`pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
, 
Àn
, 
∑ge
);

2023 i‡(
öode_bh
 =
NULL
)

2024 
out
;

2026 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2027 i‡(!
∑ge_bufs
) {

2028 
	`BUG
();

2029 
out
;

2031 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
,

2032 
NULL
, 
bgë_⁄e
);

2039 
	`gë_∑ge
(
∑ge
);

2040 
	`u∆ock_∑ge
(
∑ge
);

2042 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

2043 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

2044 i‡(
	`IS_ERR
(
h™dÀ
)) {

2045 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2046 
	`put_∑ge
(
∑ge
);

2047 
out_no_∑gñock
;

2049 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

2051 
	`lock_∑ge
(
∑ge
);

2052 
	`put_∑ge
(
∑ge
);

2053 i‡(
∑ge
->
m≠pög
 != mapping) {

2055 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2056 
ªt
 = 0;

2057 
out
;

2060 i‡(
ölöe_d©a
) {

2061 
ªt
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2063 
ªt
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2064 
do_jou∫Æ_gë_wrôe_ac˚ss
);

2066 
îr
 = 
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
∑ge_bufs
, 0, 
Àn
, 
NULL
,

2067 
wrôe_íd_‚
);

2069 i‡(
ªt
 == 0)

2070 
ªt
 = 
îr
;

2071 
	`PXT4_I
(
öode
)->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

2072 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2073 i‡(!
ªt
)

2074 
ªt
 = 
îr
;

2076 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
))

2077 
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
,

2078 
NULL
, 
bput_⁄e
);

2079 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

2080 
out
:

2081 
	`u∆ock_∑ge
(
∑ge
);

2082 
out_no_∑gñock
:

2083 
	`bªl£
(
öode_bh
);

2084  
ªt
;

2085 
	}
}

2128 
	$pxt4_wrôïage
(
∑ge
 *page,

2129 
wrôeback_c⁄åﬁ
 *
wbc
)

2131 
ªt
 = 0;

2132 
loff_t
 
size
;

2133 
Àn
;

2134 
buf„r_hód
 *
∑ge_bufs
 = 
NULL
;

2135 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

2136 
pxt4_io_submô
 
io_submô
;

2137 
boﬁ
 
kìp_towrôe
 = 
Ál£
;

2139 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

2140 
	`pxt4_övÆid©ïage
(
∑ge
, 0, 
PAGE_SIZE
);

2141 
	`u∆ock_∑ge
(
∑ge
);

2142  -
EIO
;

2145 
	`åa˚_pxt4_wrôïage
(
∑ge
);

2146 
size
 = 
	`i_size_ªad
(
öode
);

2147 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

2148 
Àn
 = 
size
 & ~
PAGE_MASK
;

2150 
Àn
 = 
PAGE_SIZE
;

2152 
∑ge_bufs
 = 
	`∑ge_buf„rs
(
∑ge
);

2170 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
∑ge_bufs
, 0, 
Àn
, NULL,

2171 
pxt4_bh_dñay_‹_unwrôãn
)) {

2172 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2173 i‡((
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

2174 (
öode
->
i_sb
->
s_blocksize
 =
PAGE_SIZE
)) {

2180 
	`WARN_ON_ONCE
((
cuºít
->
Êags
 & (
PF_MEMALLOC
|
PF_KSWAPD
))

2181 =
PF_MEMALLOC
);

2182 
	`u∆ock_∑ge
(
∑ge
);

2185 
kìp_towrôe
 = 
åue
;

2188 i‡(
	`PageChecked
(
∑ge
Ë&& 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

2193  
	`__pxt4_jou∫ÆÀd_wrôïage
(
∑ge
, 
Àn
);

2195 
	`pxt4_io_submô_öô
(&
io_submô
, 
wbc
);

2196 
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_NOFS
);

2197 i‡(!
io_submô
.
io_íd
) {

2198 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

2199 
	`u∆ock_∑ge
(
∑ge
);

2200  -
ENOMEM
;

2202 
ªt
 = 
	`pxt4_bio_wrôe_∑ge
(&
io_submô
, 
∑ge
, 
Àn
, 
wbc
, 
kìp_towrôe
);

2203 
	`pxt4_io_submô
(&
io_submô
);

2205 
	`pxt4_put_io_íd_de„r
(
io_submô
.
io_íd
);

2206  
ªt
;

2207 
	}
}

2209 
	$m∑ge_submô_∑ge
(
m∑ge_da_d©a
 *
mpd
, 
∑ge
 *page)

2211 
Àn
;

2212 
loff_t
 
size
;

2213 
îr
;

2215 
	`BUG_ON
(
∑ge
->
ödex
 !
mpd
->
fú°_∑ge
);

2216 
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
);

2230 
size
 = 
	`i_size_ªad
(
mpd
->
öode
);

2231 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

2232 
Àn
 = 
size
 & ~
PAGE_MASK
;

2234 
Àn
 = 
PAGE_SIZE
;

2235 
îr
 = 
	`pxt4_bio_wrôe_∑ge
(&
mpd
->
io_submô
, 
∑ge
, 
Àn
, mpd->
wbc
, 
Ál£
);

2236 i‡(!
îr
)

2237 
mpd
->
wbc
->
ƒ_to_wrôe
--;

2238 
mpd
->
fú°_∑ge
++;

2240  
îr
;

2241 
	}
}

2243 
	#BH_FLAGS
 ((1 << 
BH_Unwrôãn
Ë| (1 << 
BH_Dñay
))

	)

2250 
	#MAX_WRITEPAGES_EXTENT_LEN
 2048

	)

2266 
boﬁ
 
	$m∑ge_add_bh_to_exã¡
(
m∑ge_da_d©a
 *
mpd
, 
pxt4_lblk_t
 
lblk
,

2267 
buf„r_hód
 *
bh
)

2269 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2272 i‡(!
	`buf„r_dúty
(
bh
Ë|| !
	`buf„r_m≠≥d
(bh) ||

2273 (!
	`buf„r_dñay
(
bh
Ë&& !
	`buf„r_unwrôãn
(bh))) {

2275 i‡(
m≠
->
m_Àn
 == 0)

2276  
åue
;

2277  
Ál£
;

2281 i‡(
m≠
->
m_Àn
 == 0) {

2283 i‡(!
mpd
->
do_m≠
)

2284  
Ál£
;

2285 
m≠
->
m_lblk
 = 
lblk
;

2286 
m≠
->
m_Àn
 = 1;

2287 
m≠
->
m_Êags
 = 
bh
->
b_°©e
 & 
BH_FLAGS
;

2288  
åue
;

2292 i‡(
m≠
->
m_Àn
 >
MAX_WRITEPAGES_EXTENT_LEN
)

2293  
Ál£
;

2296 i‡(
lblk
 =
m≠
->
m_lblk
 + m≠->
m_Àn
 &&

2297 (
bh
->
b_°©e
 & 
BH_FLAGS
Ë=
m≠
->
m_Êags
) {

2298 
m≠
->
m_Àn
++;

2299  
åue
;

2301  
Ál£
;

2302 
	}
}

2320 
	$m∑ge_¥o˚ss_∑ge_bufs
(
m∑ge_da_d©a
 *
mpd
,

2321 
buf„r_hód
 *
hód
,

2322 
buf„r_hód
 *
bh
,

2323 
pxt4_lblk_t
 
lblk
)

2325 
öode
 *öodê
mpd
->inode;

2326 
îr
;

2327 
pxt4_lblk_t
 
blocks
 = (
	`i_size_ªad
(
öode
Ë+ 
	`i_blocksize
(inode) - 1)

2328 >> 
öode
->
i_blkbôs
;

2331 
	`BUG_ON
(
	`buf„r_locked
(
bh
));

2333 i‡(
lblk
 >
blocks
 || !
	`m∑ge_add_bh_to_exã¡
(
mpd
,Üblk, 
bh
)) {

2335 i‡(
mpd
->
m≠
.
m_Àn
)

2338 i‡(!
mpd
->
do_m≠
)

2343 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2345 i‡(
mpd
->
m≠
.
m_Àn
 == 0) {

2346 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
hód
->
b_∑ge
);

2347 i‡(
îr
 < 0)

2348  
îr
;

2350  
lblk
 < 
blocks
;

2351 
	}
}

2367 
	$m∑ge_m≠_™d_submô_buf„rs
(
m∑ge_da_d©a
 *
mpd
)

2369 
∑gevec
 
pvec
;

2370 
ƒ_∑ges
, 
i
;

2371 
öode
 *öodê
mpd
->inode;

2372 
buf„r_hód
 *
hód
, *
bh
;

2373 
bµ_bôs
 = 
PAGE_SHIFT
 - 
öode
->
i_blkbôs
;

2374 
pgoff_t
 
°¨t
, 
íd
;

2375 
pxt4_lblk_t
 
lblk
;

2376 
£˘‹_t
 
pblock
;

2377 
îr
;

2379 
°¨t
 = 
mpd
->
m≠
.
m_lblk
 >> 
bµ_bôs
;

2380 
íd
 = (
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
 - 1Ë>> 
bµ_bôs
;

2381 
lblk
 = 
°¨t
 << 
bµ_bôs
;

2382 
pblock
 = 
mpd
->
m≠
.
m_pblk
;

2384 
	`∑gevec_öô
(&
pvec
);

2385 
°¨t
 <
íd
) {

2386 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge
(&
pvec
, 
öode
->
i_m≠pög
,

2387 &
°¨t
, 
íd
);

2388 i‡(
ƒ_∑ges
 == 0)

2390 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2391 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2393 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2395 i‡(
lblk
 < 
mpd
->
m≠
.
m_lblk
)

2397 i‡(
lblk
 >
mpd
->
m≠
.
m_lblk
 + mpd->m≠.
m_Àn
) {

2402 
mpd
->
m≠
.
m_Àn
 = 0;

2403 
mpd
->
m≠
.
m_Êags
 = 0;

2411 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
,

2412 
bh
, 
lblk
);

2413 
	`∑gevec_ªÀa£
(&
pvec
);

2414 i‡(
îr
 > 0)

2415 
îr
 = 0;

2416  
îr
;

2418 i‡(
	`buf„r_dñay
(
bh
)) {

2419 
	`˛ór_buf„r_dñay
(
bh
);

2420 
bh
->
b_blockƒ
 = 
pblock
++;

2422 
	`˛ór_buf„r_unwrôãn
(
bh
);

2423 } 
lblk
++, (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2430 
mpd
->
io_submô
.
io_íd
->
size
 +
PAGE_SIZE
;

2432 
îr
 = 
	`m∑ge_submô_∑ge
(
mpd
, 
∑ge
);

2433 i‡(
îr
 < 0) {

2434 
	`∑gevec_ªÀa£
(&
pvec
);

2435  
îr
;

2438 
	`∑gevec_ªÀa£
(&
pvec
);

2441 
mpd
->
m≠
.
m_Àn
 = 0;

2442 
mpd
->
m≠
.
m_Êags
 = 0;

2444 
	}
}

2446 
	$m∑ge_m≠_⁄e_exã¡
(
h™dÀ_t
 *
h™dÀ
, 
m∑ge_da_d©a
 *
mpd
)

2448 
öode
 *öodê
mpd
->inode;

2449 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2450 
gë_blocks_Êags
;

2451 
îr
, 
di‹ód_nﬁock
;

2453 
	`åa˚_pxt4_da_wrôe_∑ges_exã¡
(
öode
, 
m≠
);

2469 
gë_blocks_Êags
 = 
PXT4_GET_BLOCKS_CREATE
 |

2470 
PXT4_GET_BLOCKS_METADATA_NOFAIL
 |

2471 
PXT4_GET_BLOCKS_IO_SUBMIT
;

2472 
di‹ód_nﬁock
 = 
	`pxt4_should_di‹ód_nﬁock
(
öode
);

2473 i‡(
di‹ód_nﬁock
)

2474 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_IO_CREATE_EXT
;

2475 i‡(
m≠
->
m_Êags
 & (1 << 
BH_Dñay
))

2476 
gë_blocks_Êags
 |
PXT4_GET_BLOCKS_DELALLOC_RESERVE
;

2478 
îr
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, 
m≠
, 
gë_blocks_Êags
);

2479 i‡(
îr
 < 0)

2480  
îr
;

2481 i‡(
di‹ód_nﬁock
 && (
m≠
->
m_Êags
 & 
PXT4_MAP_UNWRITTEN
)) {

2482 i‡(!
mpd
->
io_submô
.
io_íd
->
h™dÀ
 &&

2483 
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2484 
mpd
->
io_submô
.
io_íd
->
h™dÀ
 = h™dÀ->
h_rsv_h™dÀ
;

2485 
h™dÀ
->
h_rsv_h™dÀ
 = 
NULL
;

2487 
	`pxt4_£t_io_unwrôãn_Êag
(
öode
, 
mpd
->
io_submô
.
io_íd
);

2490 
	`BUG_ON
(
m≠
->
m_Àn
 == 0);

2492 
	}
}

2514 
	$m∑ge_m≠_™d_submô_exã¡
(
h™dÀ_t
 *
h™dÀ
,

2515 
m∑ge_da_d©a
 *
mpd
,

2516 
boﬁ
 *
give_up_⁄_wrôe
)

2518 
öode
 *öodê
mpd
->inode;

2519 
pxt4_m≠_blocks
 *
m≠
 = &
mpd
->map;

2520 
îr
;

2521 
loff_t
 
disksize
;

2522 
¥ogªss
 = 0;

2524 
mpd
->
io_submô
.
io_íd
->
off£t
 =

2525 ((
loff_t
)
m≠
->
m_lblk
Ë<< 
öode
->
i_blkbôs
;

2527 
îr
 = 
	`m∑ge_m≠_⁄e_exã¡
(
h™dÀ
, 
mpd
);

2528 i‡(
îr
 < 0) {

2529 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2531 i‡(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
)) ||

2532 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

2533 
övÆid©e_dúty_∑ges
;

2539 i‡((
îr
 =-
ENOMEM
) ||

2540 (
îr
 =-
ENOSPC
 && 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
))) {

2541 i‡(
¥ogªss
)

2542 
upd©e_disksize
;

2543  
îr
;

2545 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2549 
öode
->
i_öo
,

2550 ()
m≠
->
m_lblk
,

2551 ()
m≠
->
m_Àn
, -
îr
);

2552 
	`pxt4_msg
(
sb
, 
KERN_CRIT
,

2555 i‡(
îr
 =-
ENOSPC
)

2556 
	`pxt4_¥öt_‰ì_blocks
(
öode
);

2557 
övÆid©e_dúty_∑ges
:

2558 *
give_up_⁄_wrôe
 = 
åue
;

2559  
îr
;

2561 
¥ogªss
 = 1;

2566 
îr
 = 
	`m∑ge_m≠_™d_submô_buf„rs
(
mpd
);

2567 i‡(
îr
 < 0)

2568 
upd©e_disksize
;

2569 } 
m≠
->
m_Àn
);

2571 
upd©e_disksize
:

2576 
disksize
 = ((
loff_t
)
mpd
->
fú°_∑ge
Ë<< 
PAGE_SHIFT
;

2577 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

2578 
îr2
;

2579 
loff_t
 
i_size
;

2581 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2582 
i_size
 = 
	`i_size_ªad
(
öode
);

2583 i‡(
disksize
 > 
i_size
)

2584 
disksize
 = 
i_size
;

2585 i‡(
disksize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2586 
	`PXT4_I
(
öode
)->
i_disksize
 = 
disksize
;

2587 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2588 
îr2
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2589 i‡(
îr2
)

2590 
	`pxt4_îr‹
(
öode
->
i_sb
,

2592 
öode
->
i_öo
);

2593 i‡(!
îr
)

2594 
îr
 = 
îr2
;

2596  
îr
;

2597 
	}
}

2606 
	$pxt4_da_wrôïages_å™s_blocks
(
öode
 *inode)

2608 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

2610  
	`pxt4_mëa_å™s_blocks
(
öode
,

2611 
MAX_WRITEPAGES_EXTENT_LEN
 + 
bµ
 - 1, bpp);

2612 
	}
}

2632 
	$m∑ge_¥ï¨e_exã¡_to_m≠
(
m∑ge_da_d©a
 *
mpd
)

2634 
addªss_•a˚
 *
m≠pög
 = 
mpd
->
öode
->
i_m≠pög
;

2635 
∑gevec
 
pvec
;

2636 
ƒ_∑ges
;

2637 
À·
 = 
mpd
->
wbc
->
ƒ_to_wrôe
;

2638 
pgoff_t
 
ödex
 = 
mpd
->
fú°_∑ge
;

2639 
pgoff_t
 
íd
 = 
mpd
->
œ°_∑ge
;

2640 
xa_m¨k_t
 
èg
;

2641 
i
, 
îr
 = 0;

2642 
blkbôs
 = 
mpd
->
öode
->
i_blkbôs
;

2643 
pxt4_lblk_t
 
lblk
;

2644 
buf„r_hód
 *
hód
;

2646 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || mpd->wbc->
ègged_wrôïages
)

2647 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2649 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2651 
	`∑gevec_öô
(&
pvec
);

2652 
mpd
->
m≠
.
m_Àn
 = 0;

2653 
mpd
->
√xt_∑ge
 = 
ödex
;

2654 
ödex
 <
íd
) {

2655 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2656 
èg
);

2657 i‡(
ƒ_∑ges
 == 0)

2658 
out
;

2660 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2661 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2671 i‡(
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
 && 
À·
 <= 0)

2672 
out
;

2675 i‡(
mpd
->
m≠
.
m_Àn
 > 0 && mpd->
√xt_∑ge
 !
∑ge
->
ödex
)

2676 
out
;

2678 
	`lock_∑ge
(
∑ge
);

2686 i‡(!
	`PageDúty
(
∑ge
) ||

2687 (
	`PageWrôeback
(
∑ge
) &&

2688 (
mpd
->
wbc
->
sync_mode
 =
WB_SYNC_NONE
)) ||

2689 
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2690 
	`u∆ock_∑ge
(
∑ge
);

2694 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2695 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2697 i‡(
mpd
->
m≠
.
m_Àn
 == 0)

2698 
mpd
->
fú°_∑ge
 = 
∑ge
->
ödex
;

2699 
mpd
->
√xt_∑ge
 = 
∑ge
->
ödex
 + 1;

2701 
lblk
 = ((
pxt4_lblk_t
)
∑ge
->
ödex
) <<

2702 (
PAGE_SHIFT
 - 
blkbôs
);

2703 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2704 
îr
 = 
	`m∑ge_¥o˚ss_∑ge_bufs
(
mpd
, 
hód
, hód, 
lblk
);

2705 i‡(
îr
 <= 0)

2706 
out
;

2707 
îr
 = 0;

2708 
À·
--;

2710 
	`∑gevec_ªÀa£
(&
pvec
);

2711 
	`c⁄d_ªsched
();

2714 
out
:

2715 
	`∑gevec_ªÀa£
(&
pvec
);

2716  
îr
;

2717 
	}
}

2719 
	$pxt4_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2720 
wrôeback_c⁄åﬁ
 *
wbc
)

2722 
pgoff_t
 
wrôeback_ödex
 = 0;

2723 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2724 
ønge_whﬁe
 = 0;

2725 
cy˛ed
 = 1;

2726 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2727 
m∑ge_da_d©a
 
mpd
;

2728 
öode
 *öodê
m≠pög
->
ho°
;

2729 
√eded_blocks
, 
rsv_blocks
 = 0, 
ªt
 = 0;

2730 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2731 
boﬁ
 
d⁄e
;

2732 
blk_∂ug
 
∂ug
;

2733 
boﬁ
 
give_up_⁄_wrôe
 = 
Ál£
;

2735 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2736  -
EIO
;

2738 
	`≥r˝u_down_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2739 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2746 i‡(!
m≠pög
->
ƒ∑ges
 || !
	`m≠pög_ègged
(m≠pög, 
PAGECACHE_TAG_DIRTY
))

2747 
out_wrôïages
;

2749 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

2750 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2751 
out_wrôïages
;

2764 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
)) ||

2765 
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)) {

2766 
ªt
 = -
EROFS
;

2767 
out_wrôïages
;

2770 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
)) {

2775 
rsv_blocks
 = 1 + 
	`pxt4_chunk_å™s_blocks
(
öode
,

2776 
PAGE_SIZE
 >> 
öode
->
i_blkbôs
);

2784 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2786 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

2787 i‡(
	`IS_ERR
(
h™dÀ
)) {

2788 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2789 
out_wrôïages
;

2791 
	`BUG_ON
(
	`pxt4_ã°_öode_°©e
(
öode
,

2792 
PXT4_STATE_MAY_INLINE_DATA
));

2793 
	`pxt4_de°roy_ölöe_d©a
(
h™dÀ
, 
öode
);

2794 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2797 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2798 
ønge_whﬁe
 = 1;

2800 i‡(
wbc
->
ønge_cy˛ic
) {

2801 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2802 i‡(
wrôeback_ödex
)

2803 
cy˛ed
 = 0;

2804 
mpd
.
fú°_∑ge
 = 
wrôeback_ödex
;

2805 
mpd
.
œ°_∑ge
 = -1;

2807 
mpd
.
fú°_∑ge
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2808 
mpd
.
œ°_∑ge
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2811 
mpd
.
öode
 = inode;

2812 
mpd
.
wbc
 = wbc;

2813 
	`pxt4_io_submô_öô
(&
mpd
.
io_submô
, 
wbc
);

2814 
ªåy
:

2815 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2816 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
mpd
.
fú°_∑ge
, mpd.
œ°_∑ge
);

2817 
d⁄e
 = 
Ál£
;

2818 
	`blk_°¨t_∂ug
(&
∂ug
);

2826 
mpd
.
do_m≠
 = 0;

2827 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2828 i‡(!
mpd
.
io_submô
.
io_íd
) {

2829 
ªt
 = -
ENOMEM
;

2830 
u≈lug
;

2832 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2834 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
Ál£
);

2836 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2837 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2838 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2839 i‡(
ªt
 < 0)

2840 
u≈lug
;

2842 !
d⁄e
 && 
mpd
.
fú°_∑ge
 <mpd.
œ°_∑ge
) {

2844 
mpd
.
io_submô
.
io_íd
 = 
	`pxt4_öô_io_íd
(
öode
, 
GFP_KERNEL
);

2845 i‡(!
mpd
.
io_submô
.
io_íd
) {

2846 
ªt
 = -
ENOMEM
;

2857 
	`BUG_ON
(
	`pxt4_should_jou∫Æ_d©a
(
öode
));

2858 
√eded_blocks
 = 
	`pxt4_da_wrôïages_å™s_blocks
(
öode
);

2861 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
,

2862 
PXT4_HT_WRITE_PAGE
, 
√eded_blocks
, 
rsv_blocks
);

2863 i‡(
	`IS_ERR
(
h™dÀ
)) {

2864 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

2865 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_CRIT
, "%s: jbd3_start: "

2866 "%ldÖages, inÿ%lu;Éº %d", 
__func__
,

2867 
wbc
->
ƒ_to_wrôe
, 
öode
->
i_öo
, 
ªt
);

2869 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2870 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2873 
mpd
.
do_m≠
 = 1;

2875 
	`åa˚_pxt4_da_wrôe_∑ges
(
öode
, 
mpd
.
fú°_∑ge
, mpd.
wbc
);

2876 
ªt
 = 
	`m∑ge_¥ï¨e_exã¡_to_m≠
(&
mpd
);

2877 i‡(!
ªt
) {

2878 i‡(
mpd
.
m≠
.
m_Àn
)

2879 
ªt
 = 
	`m∑ge_m≠_™d_submô_exã¡
(
h™dÀ
, &
mpd
,

2880 &
give_up_⁄_wrôe
);

2888 
d⁄e
 = 
åue
;

2901 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë|| h™dÀ->
h_sync
 == 0) {

2902 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2903 
h™dÀ
 = 
NULL
;

2904 
mpd
.
do_m≠
 = 0;

2907 
	`m∑ge_ªÀa£_unu£d_∑ges
(&
mpd
, 
give_up_⁄_wrôe
);

2909 
	`pxt4_io_submô
(&
mpd
.
io_submô
);

2918 i‡(
h™dÀ
) {

2919 
	`pxt4_put_io_íd_de„r
(
mpd
.
io_submô
.
io_íd
);

2920 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2922 
	`pxt4_put_io_íd
(
mpd
.
io_submô
.
io_íd
);

2923 
mpd
.
io_submô
.
io_íd
 = 
NULL
;

2925 i‡(
ªt
 =-
ENOSPC
 && 
sbi
->
s_jou∫Æ
) {

2931 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
sbi
->
s_jou∫Æ
);

2932 
ªt
 = 0;

2936 i‡(
ªt
)

2939 
u≈lug
:

2940 
	`blk_föish_∂ug
(&
∂ug
);

2941 i‡(!
ªt
 && !
cy˛ed
 && 
wbc
->
ƒ_to_wrôe
 > 0) {

2942 
cy˛ed
 = 1;

2943 
mpd
.
œ°_∑ge
 = 
wrôeback_ödex
 - 1;

2944 
mpd
.
fú°_∑ge
 = 0;

2945 
ªåy
;

2949 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2954 
m≠pög
->
wrôeback_ödex
 = 
mpd
.
fú°_∑ge
;

2956 
out_wrôïages
:

2957 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2958 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2959 
	`≥r˝u_up_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2960  
ªt
;

2961 
	}
}

2963 
	$pxt4_dax_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2964 
wrôeback_c⁄åﬁ
 *
wbc
)

2966 
ªt
;

2967 
ƒ_to_wrôe
 = 
wbc
->nr_to_write;

2968 
öode
 *öodê
m≠pög
->
ho°
;

2969 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
m≠pög
->
ho°
->
i_sb
);

2971 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

2972  -
EIO
;

2974 
	`≥r˝u_down_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2975 
	`åa˚_pxt4_wrôïages
(
öode
, 
wbc
);

2977 
ªt
 = 
	`dax_wrôeback_m≠pög_ønge
(
m≠pög
, 
öode
->
i_sb
->
s_bdev
, 
wbc
);

2978 
	`åa˚_pxt4_wrôïages_ªsu…
(
öode
, 
wbc
, 
ªt
,

2979 
ƒ_to_wrôe
 - 
wbc
->nr_to_write);

2980 
	`≥r˝u_up_ªad
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

2981  
ªt
;

2982 
	}
}

2984 
	$pxt4_n⁄da_swôch
(
su≥r_block
 *
sb
)

2986 
s64
 
‰ì_˛u°îs
, 
dúty_˛u°îs
;

2987 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2997 
‰ì_˛u°îs
 =

2998 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

2999 
dúty_˛u°îs
 =

3000 
	`≥r˝u_cou¡î_ªad_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

3004 i‡(
dúty_˛u°îs
 && (
‰ì_˛u°îs
 < 2 * dirty_clusters))

3005 
	`åy_to_wrôeback_öodes_sb
(
sb
, 
WB_REASON_FS_FREE_SPACE
);

3007 i‡(2 * 
‰ì_˛u°îs
 < 3 * 
dúty_˛u°îs
 ||

3008 
‰ì_˛u°îs
 < (
dúty_˛u°îs
 + 
PXT4_FREECLUSTERS_WATERMARK
)) {

3016 
	}
}

3019 
	$pxt4_da_wrôe_¸edôs
(
öode
 *öode, 
loff_t
 
pos
, 
Àn
)

3021 i‡(
	`likñy
(
	`pxt4_has_„©uª_œrge_fûe
(
öode
->
i_sb
)))

3024 i‡(
pos
 + 
Àn
 <= 0x7fffffffULL)

3029 
	}
}

3031 
	$pxt4_da_wrôe_begö
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3032 
loff_t
 
pos
, 
Àn
, 
Êags
,

3033 
∑ge
 **
∑gï
, **
fsd©a
)

3035 
ªt
, 
ªåõs
 = 0;

3036 
∑ge
 *page;

3037 
pgoff_t
 
ödex
;

3038 
öode
 *öodê
m≠pög
->
ho°
;

3039 
h™dÀ_t
 *
h™dÀ
;

3041 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

3042  -
EIO
;

3044 
ödex
 = 
pos
 >> 
PAGE_SHIFT
;

3046 i‡(
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
) ||

3047 
	`S_ISLNK
(
öode
->
i_mode
)) {

3048 *
fsd©a
 = (*)
FALL_BACK_TO_NONDELALLOC
;

3049  
	`pxt4_wrôe_begö
(
fûe
, 
m≠pög
, 
pos
,

3050 
Àn
, 
Êags
, 
∑gï
, 
fsd©a
);

3052 *
fsd©a
 = (*)0;

3053 
	`åa˚_pxt4_da_wrôe_begö
(
öode
, 
pos
, 
Àn
, 
Êags
);

3055 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

3056 
ªt
 = 
	`pxt4_da_wrôe_ölöe_d©a_begö
(
m≠pög
, 
öode
,

3057 
pos
, 
Àn
, 
Êags
,

3058 
∑gï
, 
fsd©a
);

3059 i‡(
ªt
 < 0)

3060  
ªt
;

3061 i‡(
ªt
 == 1)

3072 
ªåy_gøb
:

3073 
∑ge
 = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
, 
ödex
, 
Êags
);

3074 i‡(!
∑ge
)

3075  -
ENOMEM
;

3076 
	`u∆ock_∑ge
(
∑ge
);

3084 
ªåy_jou∫Æ
:

3085 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

3086 
	`pxt4_da_wrôe_¸edôs
(
öode
, 
pos
, 
Àn
));

3087 i‡(
	`IS_ERR
(
h™dÀ
)) {

3088 
	`put_∑ge
(
∑ge
);

3089  
	`PTR_ERR
(
h™dÀ
);

3092 
	`lock_∑ge
(
∑ge
);

3093 i‡(
∑ge
->
m≠pög
 != mapping) {

3095 
	`u∆ock_∑ge
(
∑ge
);

3096 
	`put_∑ge
(
∑ge
);

3097 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3098 
ªåy_gøb
;

3101 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

3103 #ifde‡
CONFIG_FS_ENCRYPTION


3104 
ªt
 = 
	`pxt4_block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
,

3105 
pxt4_da_gë_block_¥ï
);

3107 
ªt
 = 
	`__block_wrôe_begö
(
∑ge
, 
pos
, 
Àn
, 
pxt4_da_gë_block_¥ï
);

3109 i‡(
ªt
 < 0) {

3110 
	`u∆ock_∑ge
(
∑ge
);

3111 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3117 i‡(
pos
 + 
Àn
 > 
öode
->
i_size
)

3118 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3120 i‡(
ªt
 =-
ENOSPC
 &&

3121 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3122 
ªåy_jou∫Æ
;

3124 
	`put_∑ge
(
∑ge
);

3125  
ªt
;

3128 *
∑gï
 = 
∑ge
;

3129  
ªt
;

3130 
	}
}

3136 
	$pxt4_da_should_upd©e_i_disksize
(
∑ge
 *page,

3137 
off£t
)

3139 
buf„r_hód
 *
bh
;

3140 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3141 
idx
;

3142 
i
;

3144 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

3145 
idx
 = 
off£t
 >> 
öode
->
i_blkbôs
;

3147 
i
 = 0; i < 
idx
; i++)

3148 
bh
 = bh->
b_this_∑ge
;

3150 i‡(!
	`buf„r_m≠≥d
(
bh
Ë|| (
	`buf„r_dñay
(bh)Ë|| 
	`buf„r_unwrôãn
(bh))

3153 
	}
}

3155 
	$pxt4_da_wrôe_íd
(
fûe
 *file,

3156 
addªss_•a˚
 *
m≠pög
,

3157 
loff_t
 
pos
, 
Àn
, 
c›õd
,

3158 
∑ge
 *∑ge, *
fsd©a
)

3160 
öode
 *öodê
m≠pög
->
ho°
;

3161 
ªt
 = 0, 
ªt2
;

3162 
h™dÀ_t
 *
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3163 
loff_t
 
√w_i_size
;

3164 
°¨t
, 
íd
;

3165 
wrôe_mode
 = ()()
fsd©a
;

3167 i‡(
wrôe_mode
 =
FALL_BACK_TO_NONDELALLOC
)

3168  
	`pxt4_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
,

3169 
Àn
, 
c›õd
, 
∑ge
, 
fsd©a
);

3171 
	`åa˚_pxt4_da_wrôe_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
);

3172 
°¨t
 = 
pos
 & (
PAGE_SIZE
 - 1);

3173 
íd
 = 
°¨t
 + 
c›õd
 - 1;

3180 
√w_i_size
 = 
pos
 + 
c›õd
;

3181 i‡(
c›õd
 && 
√w_i_size
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

3182 i‡(
	`pxt4_has_ölöe_d©a
(
öode
) ||

3183 
	`pxt4_da_should_upd©e_i_disksize
(
∑ge
, 
íd
)) {

3184 
	`pxt4_upd©e_i_disksize
(
öode
, 
√w_i_size
);

3189 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3193 i‡(
wrôe_mode
 !
CONVERT_INLINE_DATA
 &&

3194 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
) &&

3195 
	`pxt4_has_ölöe_d©a
(
öode
))

3196 
ªt2
 = 
	`pxt4_da_wrôe_ölöe_d©a_íd
(
öode
, 
pos
, 
Àn
, 
c›õd
,

3197 
∑ge
);

3199 
ªt2
 = 
	`gíîic_wrôe_íd
(
fûe
, 
m≠pög
, 
pos
, 
Àn
, 
c›õd
,

3200 
∑ge
, 
fsd©a
);

3202 
c›õd
 = 
ªt2
;

3203 i‡(
ªt2
 < 0)

3204 
ªt
 = 
ªt2
;

3205 
ªt2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3206 i‡(!
ªt
)

3207 
ªt
 = 
ªt2
;

3209  
ªt
 ?Ñë : 
c›õd
;

3210 
	}
}

3212 
	$pxt4_da_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3213 
Àngth
)

3218 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

3219 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

3220 
out
;

3222 
	`pxt4_da_∑ge_ªÀa£_ª£rv©i⁄
(
∑ge
, 
off£t
, 
Àngth
);

3224 
out
:

3225 
	`pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3228 
	}
}

3233 
	$pxt4_Æloc_da_blocks
(
öode
 *inode)

3235 
	`åa˚_pxt4_Æloc_da_blocks
(
öode
);

3237 i‡(!
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
)

3271  
	`fûem≠_Êush
(
öode
->
i_m≠pög
);

3272 
	}
}

3288 
£˘‹_t
 
	$pxt4_bm≠
(
addªss_•a˚
 *
m≠pög
, 
£˘‹_t
 
block
)

3290 
öode
 *öodê
m≠pög
->
ho°
;

3291 
jou∫Æ_t
 *
jou∫Æ
;

3292 
îr
;

3297 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3300 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
) &&

3301 
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
)) {

3307 
	`fûem≠_wrôe_™d_waô
(
m≠pög
);

3310 i‡(
	`PXT4_JOURNAL
(
öode
) &&

3311 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
)) {

3330 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

3331 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

3332 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

3333 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

3334 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

3336 i‡(
îr
)

3340  
	`gíîic_block_bm≠
(
m≠pög
, 
block
, 
pxt4_gë_block
);

3341 
	}
}

3343 
	$pxt4_ªad∑ge
(
fûe
 *fûe, 
∑ge
 *page)

3345 
ªt
 = -
EAGAIN
;

3346 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

3348 
	`åa˚_pxt4_ªad∑ge
(
∑ge
);

3350 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3351 
ªt
 = 
	`pxt4_ªad∑ge_ölöe
(
öode
, 
∑ge
);

3353 i‡(
ªt
 =-
EAGAIN
)

3354  
	`pxt4_m∑ge_ªad∑ges
(
∑ge
->
m≠pög
, 
NULL
,Öage, 1,

3355 
Ál£
);

3357  
ªt
;

3358 
	}
}

3361 
	$pxt4_ªad∑ges
(
fûe
 *fûe, 
addªss_•a˚
 *
m≠pög
,

3362 
li°_hód
 *
∑ges
, 
ƒ_∑ges
)

3364 
öode
 *öodê
m≠pög
->
ho°
;

3367 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3370  
	`pxt4_m∑ge_ªad∑ges
(
m≠pög
, 
∑ges
, 
NULL
, 
ƒ_∑ges
, 
åue
);

3371 
	}
}

3373 
	$pxt4_övÆid©ïage
(
∑ge
 *∑ge, 
off£t
,

3374 
Àngth
)

3376 
	`åa˚_pxt4_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3379 
	`WARN_ON
(
	`∑ge_has_buf„rs
(
∑ge
Ë&& 
	`buf„r_jbd
(
	`∑ge_buf„rs
(page)));

3381 
	`block_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3382 
	}
}

3384 
	$__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3385 
off£t
,

3386 
Àngth
)

3388 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3390 
	`åa˚_pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
);

3395 i‡(
off£t
 =0 && 
Àngth
 =
PAGE_SIZE
)

3396 
	`CÀ¨PageChecked
(
∑ge
);

3398  
	`jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ
, 
∑ge
, 
off£t
, 
Àngth
);

3399 
	}
}

3402 
	$pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
 *page,

3403 
off£t
,

3404 
Àngth
)

3406 
	`WARN_ON
(
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
, 
Àngth
) < 0);

3407 
	}
}

3409 
	$pxt4_ªÀa£∑ge
(
∑ge
 *∑ge, 
gÂ_t
 
waô
)

3411 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_JOURNAL
(
∑ge
->
m≠pög
->
ho°
);

3413 
	`åa˚_pxt4_ªÀa£∑ge
(
∑ge
);

3416 i‡(
	`PageChecked
(
∑ge
))

3418 i‡(
jou∫Æ
)

3419  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
, 
waô
);

3421  
	`åy_to_‰ì_buf„rs
(
∑ge
);

3422 
	}
}

3424 
boﬁ
 
	$pxt4_öode_d©async_dúty
(
öode
 *inode)

3426 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

3428 i‡(
jou∫Æ
)

3429  !
	`jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ
,

3430 
	`PXT4_I
(
öode
)->
i_d©async_tid
);

3432 i‡(!
	`li°_em±y
(&
öode
->
i_m≠pög
->
¥iv©e_li°
))

3433  
åue
;

3434  
öode
->
i_°©e
 & 
I_DIRTY_DATASYNC
;

3435 
	}
}

3437 
	$pxt4_iom≠_begö
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3438 
Êags
, 
iom≠
 *iomap)

3440 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

3441 
blkbôs
 = 
öode
->
i_blkbôs
;

3442 
fú°_block
, 
œ°_block
;

3443 
pxt4_m≠_blocks
 
m≠
;

3444 
boﬁ
 
dñÆloc
 = 
Ál£
;

3445 
ªt
;

3447 i‡((
off£t
 >> 
blkbôs
Ë> 
PXT4_MAX_LOGICAL_BLOCK
)

3448  -
EINVAL
;

3449 
fú°_block
 = 
off£t
 >> 
blkbôs
;

3450 
œ°_block
 = 
	`mö_t
(
loff_t
, (
off£t
 + 
Àngth
 - 1Ë>> 
blkbôs
,

3451 
PXT4_MAX_LOGICAL_BLOCK
);

3453 i‡(
Êags
 & 
IOMAP_REPORT
) {

3454 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

3455 
ªt
 = 
	`pxt4_ölöe_d©a_iom≠
(
öode
, 
iom≠
);

3456 i‡(
ªt
 !-
EAGAIN
) {

3457 i‡(
ªt
 =0 && 
off£t
 >
iom≠
->
Àngth
)

3458 
ªt
 = -
ENOENT
;

3459  
ªt
;

3463 i‡(
	`WARN_ON_ONCE
(
	`pxt4_has_ölöe_d©a
(
öode
)))

3464  -
ERANGE
;

3467 
m≠
.
m_lblk
 = 
fú°_block
;

3468 
m≠
.
m_Àn
 = 
œ°_block
 - 
fú°_block
 + 1;

3470 i‡(
Êags
 & 
IOMAP_REPORT
) {

3471 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3472 i‡(
ªt
 < 0)

3473  
ªt
;

3475 i‡(
ªt
 == 0) {

3476 
pxt4_lblk_t
 
íd
 = 
m≠
.
m_lblk
 + m≠.
m_Àn
 - 1;

3477 
exã¡_°©us
 
es
;

3479 
	`pxt4_es_föd_exã¡_ønge
(
öode
, &
pxt4_es_is_dñayed
,

3480 
m≠
.
m_lblk
, 
íd
, &
es
);

3482 i‡(!
es
.
es_Àn
 ||És.
es_lblk
 > 
íd
) {

3484 } i‡(
es
.
es_lblk
 > 
m≠
.
m_lblk
) {

3486 
m≠
.
m_Àn
 = 
es
.
es_lblk
 - m≠.
m_lblk
;

3488 
pxt4_lblk_t
 
offs
 = 0;

3490 i‡(
es
.
es_lblk
 < 
m≠
.
m_lblk
)

3491 
offs
 = 
m≠
.
m_lblk
 - 
es
.
es_lblk
;

3492 
m≠
.
m_lblk
 = 
es
.
es_lblk
 + 
offs
;

3493 
m≠
.
m_Àn
 = 
es
.
es_Àn
 - 
offs
;

3494 
dñÆloc
 = 
åue
;

3497 } i‡(
Êags
 & 
IOMAP_WRITE
) {

3498 
dio_¸edôs
;

3499 
h™dÀ_t
 *
h™dÀ
;

3500 
ªåõs
 = 0;

3503 i‡(
m≠
.
m_Àn
 > 
DIO_MAX_BLOCKS
)

3504 
m≠
.
m_Àn
 = 
DIO_MAX_BLOCKS
;

3505 
dio_¸edôs
 = 
	`pxt4_chunk_å™s_blocks
(
öode
, 
m≠
.
m_Àn
);

3506 
ªåy
:

3513 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MAP_BLOCKS
,

3514 
dio_¸edôs
);

3515 i‡(
	`IS_ERR
(
h™dÀ
))

3516  
	`PTR_ERR
(
h™dÀ
);

3518 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
öode
, &
m≠
,

3519 
PXT4_GET_BLOCKS_CREATE_ZERO
);

3520 i‡(
ªt
 < 0) {

3521 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3522 i‡(
ªt
 =-
ENOSPC
 &&

3523 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

3524 
ªåy
;

3525  
ªt
;

3537 i‡(!(
Êags
 & 
IOMAP_FAULT
Ë&& 
fú°_block
 + 
m≠
.
m_Àn
 >

3538 (
	`i_size_ªad
(
öode
Ë+ (1 << 
blkbôs
) - 1) >> blkbits) {

3539 
îr
;

3541 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3542 i‡(
îr
 < 0) {

3543 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3544  
îr
;

3547 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3549 
ªt
 = 
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0);

3550 i‡(
ªt
 < 0)

3551  
ªt
;

3554 
iom≠
->
Êags
 = 0;

3555 i‡(
	`pxt4_öode_d©async_dúty
(
öode
))

3556 
iom≠
->
Êags
 |
IOMAP_F_DIRTY
;

3557 
iom≠
->
bdev
 = 
öode
->
i_sb
->
s_bdev
;

3558 
iom≠
->
dax_dev
 = 
sbi
->
s_daxdev
;

3559 
iom≠
->
off£t
 = (
u64
)
fú°_block
 << 
blkbôs
;

3560 
iom≠
->
Àngth
 = (
u64
)
m≠
.
m_Àn
 << 
blkbôs
;

3562 i‡(
ªt
 == 0) {

3563 
iom≠
->
ty≥
 = 
dñÆloc
 ? 
IOMAP_DELALLOC
 : 
IOMAP_HOLE
;

3564 
iom≠
->
addr
 = 
IOMAP_NULL_ADDR
;

3566 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) {

3567 
iom≠
->
ty≥
 = 
IOMAP_MAPPED
;

3568 } i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_UNWRITTEN
) {

3569 
iom≠
->
ty≥
 = 
IOMAP_UNWRITTEN
;

3571 
	`WARN_ON_ONCE
(1);

3572  -
EIO
;

3574 
iom≠
->
addr
 = (
u64
)
m≠
.
m_pblk
 << 
blkbôs
;

3577 i‡(
m≠
.
m_Êags
 & 
PXT4_MAP_NEW
)

3578 
iom≠
->
Êags
 |
IOMAP_F_NEW
;

3581 
	}
}

3583 
	$pxt4_iom≠_íd
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
,

3584 
ssize_t
 
wrôãn
, 
Êags
, 
iom≠
 *iomap)

3586 
ªt
 = 0;

3587 
h™dÀ_t
 *
h™dÀ
;

3588 
blkbôs
 = 
öode
->
i_blkbôs
;

3589 
boﬁ
 
åunˇã
 = 
Ál£
;

3591 i‡(!(
Êags
 & 
IOMAP_WRITE
Ë|| (Êag†& 
IOMAP_FAULT
))

3594 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3595 i‡(
	`IS_ERR
(
h™dÀ
)) {

3596 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3597 
‹ph™_dñ
;

3599 i‡(
	`pxt4_upd©e_öode_size
(
öode
, 
off£t
 + 
wrôãn
))

3600 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3604 i‡(
iom≠
->
off£t
 + iom≠->
Àngth
 >

3605 
	`ALIGN
(
öode
->
i_size
, 1 << 
blkbôs
)) {

3606 
pxt4_lblk_t
 
wrôãn_blk
, 
íd_blk
;

3608 
wrôãn_blk
 = (
off£t
 + 
wrôãn
Ë>> 
blkbôs
;

3609 
íd_blk
 = (
off£t
 + 
Àngth
Ë>> 
blkbôs
;

3610 i‡(
wrôãn_blk
 < 
íd_blk
 && 
	`pxt4_ˇn_åunˇã
(
öode
))

3611 
åunˇã
 = 
åue
;

3617 i‡(!
åunˇã
 && 
öode
->
i_∆ök
 &&

3618 !
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

3619 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3620 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3621 i‡(
åunˇã
) {

3622 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3623 
‹ph™_dñ
:

3629 i‡(
öode
->
i_∆ök
)

3630 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3632  
ªt
;

3633 
	}
}

3635 c⁄° 
iom≠_›s
 
	gpxt4_iom≠_›s
 = {

3636 .
iom≠_begö
 = 
pxt4_iom≠_begö
,

3637 .
	giom≠_íd
 = 
pxt4_iom≠_íd
,

3640 
	$pxt4_íd_io_dio
(
kiocb
 *
iocb
, 
loff_t
 
off£t
,

3641 
ssize_t
 
size
, *
¥iv©e
)

3643 
pxt4_io_íd_t
 *
io_íd
 = 
¥iv©e
;

3646 i‡(!
io_íd
)

3649 
	`ext_debug
("pxt4_end_io_dio(): io_end 0x%p "

3651 
io_íd
, io_íd->
öode
->
i_öo
, 
iocb
, 
off£t
, 
size
);

3657 i‡(
size
 <= 0) {

3658 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

3659 
size
 = 0;

3661 
io_íd
->
off£t
 = offset;

3662 
io_íd
->
size
 = size;

3663 
	`pxt4_put_io_íd
(
io_íd
);

3666 
	}
}

3689 
ssize_t
 
	$pxt4_dúe˘_IO_wrôe
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3691 
fûe
 *fûê
iocb
->
ki_fûp
;

3692 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3693 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3694 
ssize_t
 
ªt
;

3695 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3696 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3697 
ovîwrôe
 = 0;

3698 
gë_block_t
 *
gë_block_func
 = 
NULL
;

3699 
dio_Êags
 = 0;

3700 
loff_t
 
föÆ_size
 = 
off£t
 + 
cou¡
;

3701 
‹ph™
 = 0;

3702 
h™dÀ_t
 *
h™dÀ
;

3704 i‡(
föÆ_size
 > 
öode
->
i_size
 || föÆ_sizê> 
ei
->
i_disksize
) {

3706 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3707 i‡(
	`IS_ERR
(
h™dÀ
)) {

3708 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3709 
out
;

3711 
ªt
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3712 i‡(
ªt
) {

3713 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3714 
out
;

3716 
‹ph™
 = 1;

3717 
	`pxt4_upd©e_i_disksize
(
öode
, inode->
i_size
);

3718 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3721 
	`BUG_ON
(
iocb
->
¥iv©e
 =
NULL
);

3728 
	`öode_dio_begö
(
öode
);

3731 
ovîwrôe
 = *((*)
iocb
->
¥iv©e
);

3733 i‡(
ovîwrôe
)

3734 
	`öode_u∆ock
(
öode
);

3756 
iocb
->
¥iv©e
 = 
NULL
;

3757 i‡(
ovîwrôe
)

3758 
gë_block_func
 = 
pxt4_dio_gë_block_ovîwrôe
;

3759 i‡(!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
) ||

3760 
	`round_down
(
off£t
, 
	`i_blocksize
(
öode
)Ë>öode->
i_size
) {

3761 
gë_block_func
 = 
pxt4_dio_gë_block
;

3762 
dio_Êags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

3763 } i‡(
	`is_sync_kiocb
(
iocb
)) {

3764 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_sync
;

3765 
dio_Êags
 = 
DIO_LOCKING
;

3767 
gë_block_func
 = 
pxt4_dio_gë_block_unwrôãn_async
;

3768 
dio_Êags
 = 
DIO_LOCKING
;

3770 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
, 
ôî
,

3771 
gë_block_func
, 
pxt4_íd_io_dio
, 
NULL
,

3772 
dio_Êags
);

3774 i‡(
ªt
 > 0 && !
ovîwrôe
 && 
	`pxt4_ã°_öode_°©e
(
öode
,

3775 
PXT4_STATE_DIO_UNWRITTEN
)) {

3776 
îr
;

3781 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
NULL
, 
öode
,

3782 
off£t
, 
ªt
);

3783 i‡(
îr
 < 0)

3784 
ªt
 = 
îr
;

3785 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_DIO_UNWRITTEN
);

3788 
	`öode_dio_íd
(
öode
);

3790 i‡(
ovîwrôe
)

3791 
	`öode_lock
(
öode
);

3793 i‡(
ªt
 < 0 && 
föÆ_size
 > 
öode
->
i_size
)

3794 
	`pxt4_åunˇã_Áûed_wrôe
(
öode
);

3797 i‡(
‹ph™
) {

3798 
îr
;

3801 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

3802 i‡(
	`IS_ERR
(
h™dÀ
)) {

3813 i‡(!
ªt
)

3814 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

3815 i‡(
öode
->
i_∆ök
)

3816 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

3818 
out
;

3820 i‡(
öode
->
i_∆ök
)

3821 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3822 i‡(
ªt
 > 0) {

3823 
loff_t
 
íd
 = 
off£t
 + 
ªt
;

3824 i‡(
íd
 > 
öode
->
i_size
 ||Énd > 
ei
->
i_disksize
) {

3825 
	`pxt4_upd©e_i_disksize
(
öode
, 
íd
);

3826 i‡(
íd
 > 
öode
->
i_size
)

3827 
	`i_size_wrôe
(
öode
, 
íd
);

3835 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3838 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3839 i‡(
ªt
 == 0)

3840 
ªt
 = 
îr
;

3842 
out
:

3843  
ªt
;

3844 
	}
}

3846 
ssize_t
 
	$pxt4_dúe˘_IO_ªad
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3848 
addªss_•a˚
 *
m≠pög
 = 
iocb
->
ki_fûp
->
f_m≠pög
;

3849 
öode
 *öodê
m≠pög
->
ho°
;

3850 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3851 
ssize_t
 
ªt
;

3858 
	`öode_lock_sh¨ed
(
öode
);

3859 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
iocb
->
ki_pos
,

3860 
iocb
->
ki_pos
 + 
cou¡
 - 1);

3861 i‡(
ªt
)

3862 
out_u∆ock
;

3863 
ªt
 = 
	`__blockdev_dúe˘_IO
(
iocb
, 
öode
, inode->
i_sb
->
s_bdev
,

3864 
ôî
, 
pxt4_dio_gë_block
, 
NULL
, NULL, 0);

3865 
out_u∆ock
:

3866 
	`öode_u∆ock_sh¨ed
(
öode
);

3867  
ªt
;

3868 
	}
}

3870 
ssize_t
 
	$pxt4_dúe˘_IO
(
kiocb
 *
iocb
, 
iov_ôî
 *
ôî
)

3872 
fûe
 *fûê
iocb
->
ki_fûp
;

3873 
öode
 *öodê
fûe
->
f_m≠pög
->
ho°
;

3874 
size_t
 
cou¡
 = 
	`iov_ôî_cou¡
(
ôî
);

3875 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

3876 
ssize_t
 
ªt
;

3878 #ifde‡
CONFIG_FS_ENCRYPTION


3879 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
))

3886 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

3890 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

3893 
	`åa˚_pxt4_dúe˘_IO_íãr
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
));

3894 i‡(
	`iov_ôî_rw
(
ôî
Ë=
READ
)

3895 
ªt
 = 
	`pxt4_dúe˘_IO_ªad
(
iocb
, 
ôî
);

3897 
ªt
 = 
	`pxt4_dúe˘_IO_wrôe
(
iocb
, 
ôî
);

3898 
	`åa˚_pxt4_dúe˘_IO_exô
(
öode
, 
off£t
, 
cou¡
, 
	`iov_ôî_rw
(
ôî
), 
ªt
);

3899  
ªt
;

3900 
	}
}

3915 
	$pxt4_jou∫ÆÀd_£t_∑ge_dúty
(
∑ge
 *page)

3917 
	`SëPageChecked
(
∑ge
);

3918  
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

3919 
	}
}

3921 
	$pxt4_£t_∑ge_dúty
(
∑ge
 *page)

3923 
	`WARN_ON_ONCE
(!
	`PageLocked
(
∑ge
Ë&& !
	`PageDúty
(page));

3924 
	`WARN_ON_ONCE
(!
	`∑ge_has_buf„rs
(
∑ge
));

3925  
	`__£t_∑ge_dúty_buf„rs
(
∑ge
);

3926 
	}
}

3928 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_a›s
 = {

3929 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3930 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3931 .
	gwrôïage
 = 
pxt4_wrôïage
,

3932 .
	gwrôïages
 = 
pxt4_wrôïages
,

3933 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3934 .
	gwrôe_íd
 = 
pxt4_wrôe_íd
,

3935 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3936 .
	gbm≠
 = 
pxt4_bm≠
,

3937 .
	gövÆid©ïage
 = 
pxt4_övÆid©ïage
,

3938 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3939 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3940 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3941 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3942 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3945 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_jou∫ÆÀd_a›s
 = {

3946 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3947 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3948 .
	gwrôïage
 = 
pxt4_wrôïage
,

3949 .
	gwrôïages
 = 
pxt4_wrôïages
,

3950 .
	gwrôe_begö
 = 
pxt4_wrôe_begö
,

3951 .
	gwrôe_íd
 = 
pxt4_jou∫ÆÀd_wrôe_íd
,

3952 .
	g£t_∑ge_dúty
 = 
pxt4_jou∫ÆÀd_£t_∑ge_dúty
,

3953 .
	gbm≠
 = 
pxt4_bm≠
,

3954 .
	gövÆid©ïage
 = 
pxt4_jou∫ÆÀd_övÆid©ïage
,

3955 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3956 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3957 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3958 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3961 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_da_a›s
 = {

3962 .
ªad∑ge
 = 
pxt4_ªad∑ge
,

3963 .
	gªad∑ges
 = 
pxt4_ªad∑ges
,

3964 .
	gwrôïage
 = 
pxt4_wrôïage
,

3965 .
	gwrôïages
 = 
pxt4_wrôïages
,

3966 .
	gwrôe_begö
 = 
pxt4_da_wrôe_begö
,

3967 .
	gwrôe_íd
 = 
pxt4_da_wrôe_íd
,

3968 .
	g£t_∑ge_dúty
 = 
pxt4_£t_∑ge_dúty
,

3969 .
	gbm≠
 = 
pxt4_bm≠
,

3970 .
	gövÆid©ïage
 = 
pxt4_da_övÆid©ïage
,

3971 .
	gªÀa£∑ge
 = 
pxt4_ªÀa£∑ge
,

3972 .
	gdúe˘_IO
 = 
pxt4_dúe˘_IO
,

3973 .
	gmigøã∑ge
 = 
buf„r_migøã_∑ge
,

3974 .
	gis_∑πüŒy_u±od©e
 = 
block_is_∑πüŒy_u±od©e
,

3975 .
	gîr‹_ªmove_∑ge
 = 
gíîic_îr‹_ªmove_∑ge
,

3978 c⁄° 
addªss_•a˚_›î©i⁄s
 
	gpxt4_dax_a›s
 = {

3979 .
wrôïages
 = 
pxt4_dax_wrôïages
,

3980 .
	gdúe˘_IO
 = 
no›_dúe˘_IO
,

3981 .
	g£t_∑ge_dúty
 = 
no›_£t_∑ge_dúty
,

3982 .
	gbm≠
 = 
pxt4_bm≠
,

3983 .
	gövÆid©ïage
 = 
no›_övÆid©ïage
,

3986 
	$pxt4_£t_a›s
(
öode
 *inode)

3988 
	`pxt4_öode_jou∫Æ_mode
(
öode
)) {

3989 
PXT4_INODE_ORDERED_DATA_MODE
:

3990 
PXT4_INODE_WRITEBACK_DATA_MODE
:

3992 
PXT4_INODE_JOURNAL_DATA_MODE
:

3993 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_jou∫ÆÀd_a›s
;

3996 
	`BUG
();

3998 i‡(
	`IS_DAX
(
öode
))

3999 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_dax_a›s
;

4000 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

4001 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_da_a›s
;

4003 
öode
->
i_m≠pög
->
a_›s
 = &
pxt4_a›s
;

4004 
	}
}

4006 
	$__pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4007 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4009 
pxt4_fsblk_t
 
ödex
 = 
‰om
 >> 
PAGE_SHIFT
;

4010 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4011 
blocksize
, 
pos
;

4012 
pxt4_lblk_t
 
iblock
;

4013 
öode
 *öodê
m≠pög
->
ho°
;

4014 
buf„r_hód
 *
bh
;

4015 
∑ge
 *page;

4016 
îr
 = 0;

4018 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
m≠pög
, 
‰om
 >> 
PAGE_SHIFT
,

4019 
	`m≠pög_gÂ_c⁄°øöt
(
m≠pög
, ~
__GFP_FS
));

4020 i‡(!
∑ge
)

4021  -
ENOMEM
;

4023 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4025 
iblock
 = 
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

4027 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

4028 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

4031 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

4032 
pos
 = 
blocksize
;

4033 
off£t
 >
pos
) {

4034 
bh
 = bh->
b_this_∑ge
;

4035 
iblock
++;

4036 
pos
 +
blocksize
;

4038 i‡(
	`buf„r_‰ìd
(
bh
)) {

4039 
	`BUFFER_TRACE
(
bh
, "freed: skip");

4040 
u∆ock
;

4042 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4043 
	`BUFFER_TRACE
(
bh
, "unmapped");

4044 
	`pxt4_gë_block
(
öode
, 
iblock
, 
bh
, 0);

4046 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

4047 
	`BUFFER_TRACE
(
bh
, "still unmapped");

4048 
u∆ock
;

4053 i‡(
	`PageU±od©e
(
∑ge
))

4054 
	`£t_buf„r_u±od©e
(
bh
);

4056 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4057 
îr
 = -
EIO
;

4058 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

4059 
	`waô_⁄_buf„r
(
bh
);

4061 i‡(!
	`buf„r_u±od©e
(
bh
))

4062 
u∆ock
;

4063 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode)) {

4065 
	`BUG_ON
(!
	`fs¸y±_has_í¸y±i⁄_key
(
öode
));

4066 
	`BUG_ON
(
blocksize
 !
PAGE_SIZE
);

4067 
	`WARN_ON_ONCE
(
	`fs¸y±_de¸y±_∑ge
(
∑ge
->
m≠pög
->
ho°
,

4068 
∑ge
, 
PAGE_SIZE
, 0,Öage->
ödex
));

4071 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4072 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

4073 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

4074 i‡(
îr
)

4075 
u∆ock
;

4077 
	`zîo_u£r
(
∑ge
, 
off£t
, 
Àngth
);

4078 
	`BUFFER_TRACE
(
bh
, "zeroedÉnd of block");

4080 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

4081 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

4083 
îr
 = 0;

4084 
	`m¨k_buf„r_dúty
(
bh
);

4085 i‡(
	`pxt4_should_‹dî_d©a
(
öode
))

4086 
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
öode
);

4089 
u∆ock
:

4090 
	`u∆ock_∑ge
(
∑ge
);

4091 
	`put_∑ge
(
∑ge
);

4092  
îr
;

4093 
	}
}

4102 
	$pxt4_block_zîo_∑ge_ønge
(
h™dÀ_t
 *
h™dÀ
,

4103 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
,Üoff_à
Àngth
)

4105 
öode
 *öodê
m≠pög
->
ho°
;

4106 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4107 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4108 
max
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4114 i‡(
Àngth
 > 
max
 ||Üength < 0)

4115 
Àngth
 = 
max
;

4117 i‡(
	`IS_DAX
(
öode
)) {

4118  
	`iom≠_zîo_ønge
(
öode
, 
‰om
, 
Àngth
, 
NULL
,

4119 &
pxt4_iom≠_›s
);

4121  
	`__pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4122 
	}
}

4130 
	$pxt4_block_åunˇã_∑ge
(
h™dÀ_t
 *
h™dÀ
,

4131 
addªss_•a˚
 *
m≠pög
, 
loff_t
 
‰om
)

4133 
off£t
 = 
‰om
 & (
PAGE_SIZE
-1);

4134 
Àngth
;

4135 
blocksize
;

4136 
öode
 *öodê
m≠pög
->
ho°
;

4139 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& !
	`fs¸y±_has_í¸y±i⁄_key
(inode))

4142 
blocksize
 = 
öode
->
i_sb
->
s_blocksize
;

4143 
Àngth
 = 
blocksize
 - (
off£t
 & (blocksize - 1));

4145  
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
, 
‰om
, 
Àngth
);

4146 
	}
}

4148 
	$pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4149 
loff_t
 
l°¨t
,Üoff_à
Àngth
)

4151 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4152 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4153 
∑πül_°¨t
, 
∑πül_íd
;

4154 
pxt4_fsblk_t
 
°¨t
, 
íd
;

4155 
loff_t
 
byã_íd
 = (
l°¨t
 + 
Àngth
 - 1);

4156 
îr
 = 0;

4158 
∑πül_°¨t
 = 
l°¨t
 & (
sb
->
s_blocksize
 - 1);

4159 
∑πül_íd
 = 
byã_íd
 & (
sb
->
s_blocksize
 - 1);

4161 
°¨t
 = 
l°¨t
 >> 
sb
->
s_blocksize_bôs
;

4162 
íd
 = 
byã_íd
 >> 
sb
->
s_blocksize_bôs
;

4165 i‡(
°¨t
 =
íd
 &&

4166 (
∑πül_°¨t
 || (
∑πül_íd
 !
sb
->
s_blocksize
 - 1))) {

4167 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4168 
l°¨t
, 
Àngth
);

4169  
îr
;

4172 i‡(
∑πül_°¨t
) {

4173 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4174 
l°¨t
, 
sb
->
s_blocksize
);

4175 i‡(
îr
)

4176  
îr
;

4179 i‡(
∑πül_íd
 !
sb
->
s_blocksize
 - 1)

4180 
îr
 = 
	`pxt4_block_zîo_∑ge_ønge
(
h™dÀ
, 
m≠pög
,

4181 
byã_íd
 - 
∑πül_íd
,

4182 
∑πül_íd
 + 1);

4183  
îr
;

4184 
	}
}

4186 
	$pxt4_ˇn_åunˇã
(
öode
 *inode)

4188 i‡(
	`S_ISREG
(
öode
->
i_mode
))

4190 i‡(
	`S_ISDIR
(
öode
->
i_mode
))

4192 i‡(
	`S_ISLNK
(
öode
->
i_mode
))

4193  !
	`pxt4_öode_is_Á°_symlök
(
öode
);

4195 
	}
}

4203 
	$pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

4204 
loff_t
 
Àn
)

4206 
h™dÀ_t
 *
h™dÀ
;

4207 
loff_t
 
size
 = 
	`i_size_ªad
(
öode
);

4209 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4210 i‡(
off£t
 > 
size
 || off£à+ 
Àn
 < size)

4213 i‡(
	`PXT4_I
(
öode
)->
i_disksize
 >
size
)

4216 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 1);

4217 i‡(
	`IS_ERR
(
h™dÀ
))

4218  
	`PTR_ERR
(
h™dÀ
);

4219 
	`pxt4_upd©e_i_disksize
(
öode
, 
size
);

4220 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4221 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4224 
	}
}

4226 
	$pxt4_waô_dax_∑ge
(
pxt4_öode_öfo
 *
ei
)

4228 
	`up_wrôe
(&
ei
->
i_mm≠_£m
);

4229 
	`scheduÀ
();

4230 
	`down_wrôe
(&
ei
->
i_mm≠_£m
);

4231 
	}
}

4233 
	$pxt4_bªak_œyouts
(
öode
 *inode)

4235 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4236 
∑ge
 *page;

4237 
îr‹
;

4239 i‡(
	`WARN_ON_ONCE
(!
	`rw£m_is_locked
(&
ei
->
i_mm≠_£m
)))

4240  -
EINVAL
;

4243 
∑ge
 = 
	`dax_œyout_busy_∑ge
(
öode
->
i_m≠pög
);

4244 i‡(!
∑ge
)

4247 
îr‹
 = 
	`___waô_v¨_evít
(&
∑ge
->
_ªfcou¡
,

4248 
	`©omic_ªad
(&
∑ge
->
_ªfcou¡
) == 1,

4249 
TASK_INTERRUPTIBLE
, 0, 0,

4250 
	`pxt4_waô_dax_∑ge
(
ei
));

4251 } 
îr‹
 == 0);

4253  
îr‹
;

4254 
	}
}

4267 
	$pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
)

4269 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4270 
pxt4_lblk_t
 
fú°_block
, 
°›_block
;

4271 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4272 
loff_t
 
fú°_block_off£t
, 
œ°_block_off£t
;

4273 
h™dÀ_t
 *
h™dÀ
;

4274 
¸edôs
;

4275 
ªt
 = 0;

4277 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4278  -
EOPNOTSUPP
;

4280 
	`åa˚_pxt4_punch_hﬁe
(
öode
, 
off£t
, 
Àngth
, 0);

4286 i‡(
	`m≠pög_ègged
(
m≠pög
, 
PAGECACHE_TAG_DIRTY
)) {

4287 
ªt
 = 
	`fûem≠_wrôe_™d_waô_ønge
(
m≠pög
, 
off£t
,

4288 
off£t
 + 
Àngth
 - 1);

4289 i‡(
ªt
)

4290  
ªt
;

4293 
	`öode_lock
(
öode
);

4296 i‡(
off£t
 >
öode
->
i_size
)

4297 
out_muãx
;

4303 i‡(
off£t
 + 
Àngth
 > 
öode
->
i_size
) {

4304 
Àngth
 = 
öode
->
i_size
 +

4305 
PAGE_SIZE
 - (
öode
->
i_size
 & (PAGE_SIZE - 1)) -

4306 
off£t
;

4309 i‡(
off£t
 & (
sb
->
s_blocksize
 - 1) ||

4310 (
off£t
 + 
Àngth
Ë& (
sb
->
s_blocksize
 - 1)) {

4315 
ªt
 = 
	`pxt4_öode_©èch_jöode
(
öode
);

4316 i‡(
ªt
 < 0)

4317 
out_muãx
;

4322 
	`öode_dio_waô
(
öode
);

4328 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4330 
ªt
 = 
	`pxt4_bªak_œyouts
(
öode
);

4331 i‡(
ªt
)

4332 
out_dio
;

4334 
fú°_block_off£t
 = 
	`round_up
(
off£t
, 
sb
->
s_blocksize
);

4335 
œ°_block_off£t
 = 
	`round_down
((
off£t
 + 
Àngth
), 
sb
->
s_blocksize
) - 1;

4338 i‡(
œ°_block_off£t
 > 
fú°_block_off£t
) {

4339 
ªt
 = 
	`pxt4_upd©e_disksize_bef‹e_punch
(
öode
, 
off£t
, 
Àngth
);

4340 i‡(
ªt
)

4341 
out_dio
;

4342 
	`åunˇã_∑geˇche_ønge
(
öode
, 
fú°_block_off£t
,

4343 
œ°_block_off£t
);

4346 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4347 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4349 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4350 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4351 i‡(
	`IS_ERR
(
h™dÀ
)) {

4352 
ªt
 = 
	`PTR_ERR
(
h™dÀ
);

4353 
	`pxt4_°d_îr‹
(
sb
, 
ªt
);

4354 
out_dio
;

4357 
ªt
 = 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ
, 
öode
, 
off£t
,

4358 
Àngth
);

4359 i‡(
ªt
)

4360 
out_°›
;

4362 
fú°_block
 = (
off£t
 + 
sb
->
s_blocksize
 - 1) >>

4363 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4364 
°›_block
 = (
off£t
 + 
Àngth
Ë>> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

4367 i‡(
°›_block
 > 
fú°_block
) {

4369 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4370 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4372 
ªt
 = 
	`pxt4_es_ªmove_exã¡
(
öode
, 
fú°_block
,

4373 
°›_block
 - 
fú°_block
);

4374 i‡(
ªt
) {

4375 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4376 
out_°›
;

4379 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4380 
ªt
 = 
	`pxt4_ext_ªmove_•a˚
(
öode
, 
fú°_block
,

4381 
°›_block
 - 1);

4383 
ªt
 = 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ
, 
öode
, 
fú°_block
,

4384 
°›_block
);

4386 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4388 i‡(
	`IS_SYNC
(
öode
))

4389 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4391 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4392 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4393 i‡(
ªt
 >= 0)

4394 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 1);

4395 
out_°›
:

4396 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4397 
out_dio
:

4398 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

4399 
out_muãx
:

4400 
	`öode_u∆ock
(
öode
);

4401  
ªt
;

4402 
	}
}

4404 
	$pxt4_öode_©èch_jöode
(
öode
 *inode)

4406 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4407 
jbd3_öode
 *
jöode
;

4409 i‡(
ei
->
jöode
 || !
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

4412 
jöode
 = 
	`jbd3_Æloc_öode
(
GFP_KERNEL
);

4413 
	`•ö_lock
(&
öode
->
i_lock
);

4414 i‡(!
ei
->
jöode
) {

4415 i‡(!
jöode
) {

4416 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4417  -
ENOMEM
;

4419 
ei
->
jöode
 = jinode;

4420 
	`jbd3_jou∫Æ_öô_jbd_öode
(
ei
->
jöode
, 
öode
);

4421 
jöode
 = 
NULL
;

4423 
	`•ö_u∆ock
(&
öode
->
i_lock
);

4424 i‡(
	`u∆ikñy
(
jöode
 !
NULL
))

4425 
	`jbd3_‰ì_öode
(
jöode
);

4427 
	}
}

4457 
	$pxt4_åunˇã
(
öode
 *inode)

4459 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

4460 
¸edôs
;

4461 
îr
 = 0;

4462 
h™dÀ_t
 *
h™dÀ
;

4463 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

4470 i‡(!(
öode
->
i_°©e
 & (
I_NEW
|
I_FREEING
)))

4471 
	`WARN_ON
(!
	`öode_is_locked
(
öode
));

4472 
	`åa˚_pxt4_åunˇã_íãr
(
öode
);

4474 i‡(!
	`pxt4_ˇn_åunˇã
(
öode
))

4477 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EOFBLOCKS
);

4479 i‡(
öode
->
i_size
 =0 && !
	`ã°_›t
(öode->
i_sb
, 
NO_AUTO_DA_ALLOC
))

4480 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_DA_ALLOC_CLOSE
);

4482 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

4483 
has_ölöe
 = 1;

4485 
îr
 = 
	`pxt4_ölöe_d©a_åunˇã
(
öode
, &
has_ölöe
);

4486 i‡(
îr
)

4487  
îr
;

4488 i‡(
has_ölöe
)

4493 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1)) {

4494 i‡(
	`pxt4_öode_©èch_jöode
(
öode
) < 0)

4498 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4499 
¸edôs
 = 
	`pxt4_wrôïage_å™s_blocks
(
öode
);

4501 
¸edôs
 = 
	`pxt4_blocks_f‹_åunˇã
(
öode
);

4503 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_TRUNCATE
, 
¸edôs
);

4504 i‡(
	`IS_ERR
(
h™dÀ
))

4505  
	`PTR_ERR
(
h™dÀ
);

4507 i‡(
öode
->
i_size
 & (öode->
i_sb
->
s_blocksize
 - 1))

4508 
	`pxt4_block_åunˇã_∑ge
(
h™dÀ
, 
m≠pög
, 
öode
->
i_size
);

4519 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

4520 i‡(
îr
)

4521 
out_°›
;

4523 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

4525 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4527 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

4528 
îr
 = 
	`pxt4_ext_åunˇã
(
h™dÀ
, 
öode
);

4530 
	`pxt4_öd_åunˇã
(
h™dÀ
, 
öode
);

4532 
	`up_wrôe
(&
ei
->
i_d©a_£m
);

4533 i‡(
îr
)

4534 
out_°›
;

4536 i‡(
	`IS_SYNC
(
öode
))

4537 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

4539 
out_°›
:

4547 i‡(
öode
->
i_∆ök
)

4548 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

4550 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

4551 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

4552 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

4554 
	`åa˚_pxt4_åunˇã_exô
(
öode
);

4555  
îr
;

4556 
	}
}

4564 
	$__pxt4_gë_öode_loc
(
öode
 *inode,

4565 
pxt4_ûoc
 *
ûoc
, 
ö_mem
)

4567 
pxt4_group_desc
 *
gdp
;

4568 
buf„r_hód
 *
bh
;

4569 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4570 
pxt4_fsblk_t
 
block
;

4571 
öodes_≥r_block
, 
öode_off£t
;

4573 
ûoc
->
bh
 = 
NULL
;

4574 i‡(
öode
->
i_öo
 < 
PXT4_ROOT_INO
 ||

4575 
öode
->
i_öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))

4576  -
EFSCORRUPTED
;

4578 
ûoc
->
block_group
 = (
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(
sb
);

4579 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ûoc
->
block_group
, 
NULL
);

4580 i‡(!
gdp
)

4581  -
EIO
;

4586 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

4587 
öode_off£t
 = ((
öode
->
i_öo
 - 1) %

4588 
	`PXT4_INODES_PER_GROUP
(
sb
));

4589 
block
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
Ë+ (
öode_off£t
 / 
öodes_≥r_block
);

4590 
ûoc
->
off£t
 = (
öode_off£t
 % 
öodes_≥r_block
Ë* 
	`PXT4_INODE_SIZE
(
sb
);

4592 
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

4593 i‡(
	`u∆ikñy
(!
bh
))

4594  -
ENOMEM
;

4595 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4596 
	`lock_buf„r
(
bh
);

4604 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
Ë&& !
	`buf„r_u±od©e
(bh))

4605 
	`£t_buf„r_u±od©e
(
bh
);

4607 i‡(
	`buf„r_u±od©e
(
bh
)) {

4609 
	`u∆ock_buf„r
(
bh
);

4610 
has_buf„r
;

4618 i‡(
ö_mem
) {

4619 
buf„r_hód
 *
bôm≠_bh
;

4620 
i
, 
°¨t
;

4622 
°¨t
 = 
öode_off£t
 & ~(
öodes_≥r_block
 - 1);

4625 
bôm≠_bh
 = 
	`sb_gëblk
(
sb
, 
	`pxt4_öode_bôm≠
(sb, 
gdp
));

4626 i‡(
	`u∆ikñy
(!
bôm≠_bh
))

4627 
make_io
;

4634 i‡(!
	`buf„r_u±od©e
(
bôm≠_bh
)) {

4635 
	`bªl£
(
bôm≠_bh
);

4636 
make_io
;

4638 
i
 = 
°¨t
; i < sèπ + 
öodes_≥r_block
; i++) {

4639 i‡(
i
 =
öode_off£t
)

4641 i‡(
	`pxt4_ã°_bô
(
i
, 
bôm≠_bh
->
b_d©a
))

4644 
	`bªl£
(
bôm≠_bh
);

4645 i‡(
i
 =
°¨t
 + 
öodes_≥r_block
) {

4647 
	`mem£t
(
bh
->
b_d©a
, 0, bh->
b_size
);

4648 
	`£t_buf„r_u±od©e
(
bh
);

4649 
	`u∆ock_buf„r
(
bh
);

4650 
has_buf„r
;

4654 
make_io
:

4659 i‡(
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
) {

4660 
pxt4_fsblk_t
 
b
, 
íd
, 
èbÀ
;

4661 
num
;

4662 
__u32
 
ø_blks
 = 
	`PXT4_SB
(
sb
)->
s_öode_ªadahód_blks
;

4664 
èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

4666 
b
 = 
block
 & ~((
pxt4_fsblk_t
Ë
ø_blks
 - 1);

4667 i‡(
èbÀ
 > 
b
)

4668 
b
 = 
èbÀ
;

4669 
íd
 = 
b
 + 
ø_blks
;

4670 
num
 = 
	`PXT4_INODES_PER_GROUP
(
sb
);

4671 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

4672 
num
 -
	`pxt4_ôabÀ_unu£d_cou¡
(
sb
, 
gdp
);

4673 
èbÀ
 +
num
 / 
öodes_≥r_block
;

4674 i‡(
íd
 > 
èbÀ
)

4675 
íd
 = 
èbÀ
;

4676 
b
 <
íd
)

4677 
	`sb_bªadahód
(
sb
, 
b
++);

4685 
	`åa˚_pxt4_lﬂd_öode
(
öode
);

4686 
	`gë_bh
(
bh
);

4687 
bh
->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

4688 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 
bh
);

4689 
	`waô_⁄_buf„r
(
bh
);

4690 i‡(!
	`buf„r_u±od©e
(
bh
)) {

4691 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
,

4693 
	`bªl£
(
bh
);

4694  -
EIO
;

4697 
has_buf„r
:

4698 
ûoc
->
bh
 = bh;

4700 
	}
}

4702 
	$pxt4_gë_öode_loc
(
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

4705  
	`__pxt4_gë_öode_loc
(
öode
, 
ûoc
,

4706 !
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
));

4707 
	}
}

4709 
boﬁ
 
	$pxt4_should_u£_dax
(
öode
 *inode)

4711 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DAX
))

4712  
Ál£
;

4713 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

4714  
Ál£
;

4715 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

4716  
Ál£
;

4717 i‡(
	`pxt4_has_ölöe_d©a
(
öode
))

4718  
Ál£
;

4719 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
))

4720  
Ál£
;

4721  
åue
;

4722 
	}
}

4724 
	$pxt4_£t_öode_Êags
(
öode
 *inode)

4726 
Êags
 = 
	`PXT4_I
(
öode
)->
i_Êags
;

4727 
√w_Ê
 = 0;

4729 i‡(
Êags
 & 
PXT4_SYNC_FL
)

4730 
√w_Ê
 |
S_SYNC
;

4731 i‡(
Êags
 & 
PXT4_APPEND_FL
)

4732 
√w_Ê
 |
S_APPEND
;

4733 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

4734 
√w_Ê
 |
S_IMMUTABLE
;

4735 i‡(
Êags
 & 
PXT4_NOATIME_FL
)

4736 
√w_Ê
 |
S_NOATIME
;

4737 i‡(
Êags
 & 
PXT4_DIRSYNC_FL
)

4738 
√w_Ê
 |
S_DIRSYNC
;

4739 i‡(
	`pxt4_should_u£_dax
(
öode
))

4740 
√w_Ê
 |
S_DAX
;

4741 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

4742 
√w_Ê
 |
S_ENCRYPTED
;

4743 
	`öode_£t_Êags
(
öode
, 
√w_Ê
,

4744 
S_SYNC
|
S_APPEND
|
S_IMMUTABLE
|
S_NOATIME
|
S_DIRSYNC
|
S_DAX
|

4745 
S_ENCRYPTED
);

4746 
	}
}

4748 
blk˙t_t
 
	$pxt4_öode_blocks
(
pxt4_öode
 *
øw_öode
,

4749 
pxt4_öode_öfo
 *
ei
)

4751 
blk˙t_t
 
i_blocks
 ;

4752 
öode
 *öodê&(
ei
->
vfs_öode
);

4753 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4755 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

4757 
i_blocks
 = ((
u64
)
	`À16_to_˝u
(
øw_öode
->
i_blocks_high
)) << 32 |

4758 
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4759 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
)) {

4761  
i_blocks
 << (
öode
->
i_blkbôs
 - 9);

4763  
i_blocks
;

4766  
	`À32_to_˝u
(
øw_öode
->
i_blocks_lo
);

4768 
	}
}

4770 
ölöe
 
	$pxt4_igë_exåa_öode
(
öode
 *inode,

4771 
pxt4_öode
 *
øw_öode
,

4772 
pxt4_öode_öfo
 *
ei
)

4774 
__À32
 *
magic
 = (*)
øw_öode
 +

4775 
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
;

4777 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 + (
__À32
) <=

4778 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) &&

4779 *
magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

4780 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

4781  
	`pxt4_föd_ölöe_d©a_nﬁock
(
öode
);

4783 
	`PXT4_I
(
öode
)->
i_ölöe_off
 = 0;

4785 
	}
}

4787 
	$pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
)

4789 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
))

4790  -
EOPNOTSUPP
;

4791 *
¥ojid
 = 
	`PXT4_I
(
öode
)->
i_¥ojid
;

4793 
	}
}

4800 
ölöe
 
	$pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
 *öode, 
u64
 
vÆ
)

4802 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4803 
	`öode_£t_ivîsi⁄_øw
(
öode
, 
vÆ
);

4805 
	`öode_£t_ivîsi⁄_quîõd
(
öode
, 
vÆ
);

4806 
	}
}

4807 
ölöe
 
u64
 
	$pxt4_öode_≥ek_ivîsi⁄
(c⁄° 
öode
 *inode)

4809 i‡(
	`u∆ikñy
(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
))

4810  
	`öode_≥ek_ivîsi⁄_øw
(
öode
);

4812  
	`öode_≥ek_ivîsi⁄
(
öode
);

4813 
	}
}

4815 
öode
 *
	$__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

4816 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

4817 
löe
)

4819 
pxt4_ûoc
 
ûoc
;

4820 
pxt4_öode
 *
øw_öode
;

4821 
pxt4_öode_öfo
 *
ei
;

4822 
öode
 *inode;

4823 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4824 
ªt
;

4825 
loff_t
 
size
;

4826 
block
;

4827 
uid_t
 
i_uid
;

4828 
gid_t
 
i_gid
;

4829 
¥ojid_t
 
i_¥ojid
;

4831 i‡((!(
Êags
 & 
PXT4_IGET_SPECIAL
) &&

4832 (
öo
 < 
	`PXT4_FIRST_INO
(
sb
Ë&& inÿ!
PXT4_ROOT_INO
)) ||

4833 (
öo
 < 
PXT4_ROOT_INO
) ||

4834 (
öo
 > 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
))) {

4835 i‡(
Êags
 & 
PXT4_IGET_HANDLE
)

4836  
	`ERR_PTR
(-
ESTALE
);

4837 
	`__pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
,

4839 
öo
, 
cuºít
->
comm
);

4840  
	`ERR_PTR
(-
EFSCORRUPTED
);

4843 
öode
 = 
	`igë_locked
(
sb
, 
öo
);

4844 i‡(!
öode
)

4845  
	`ERR_PTR
(-
ENOMEM
);

4846 i‡(!(
öode
->
i_°©e
 & 
I_NEW
))

4847  
öode
;

4849 
ei
 = 
	`PXT4_I
(
öode
);

4850 
ûoc
.
bh
 = 
NULL
;

4852 
ªt
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

4853 i‡(
ªt
 < 0)

4854 
bad_öode
;

4855 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

4857 i‡((
öo
 =
PXT4_ROOT_INO
Ë&& (
øw_öode
->
i_löks_cou¡
 == 0)) {

4858 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4860 
ªt
 = -
EFSCORRUPTED
;

4861 
bad_öode
;

4864 i‡((
Êags
 & 
PXT4_IGET_HANDLE
) &&

4865 (
øw_öode
->
i_löks_cou¡
 =0Ë&& (øw_öode->
i_mode
 == 0)) {

4866 
ªt
 = -
ESTALE
;

4867 
bad_öode
;

4870 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

4871 
ei
->
i_exåa_isize
 = 
	`À16_to_˝u
(
øw_öode
->i_extra_isize);

4872 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
ei
->
i_exåa_isize
 >

4873 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
) ||

4874 (
ei
->
i_exåa_isize
 & 3)) {

4875 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4878 
ei
->
i_exåa_isize
,

4879 
	`PXT4_INODE_SIZE
(
öode
->
i_sb
));

4880 
ªt
 = -
EFSCORRUPTED
;

4881 
bad_öode
;

4884 
ei
->
i_exåa_isize
 = 0;

4887 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

4888 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

4889 
__u32
 
csum
;

4890 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

4891 
__À32
 
gí
 = 
øw_öode
->
i_gíî©i⁄
;

4892 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
,

4893 (
öum
));

4894 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
,

4895 (
gí
));

4898 i‡(!
	`pxt4_öode_csum_vîify
(
öode
, 
øw_öode
, 
ei
)) {

4899 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4901 
ªt
 = -
EFSBADCRC
;

4902 
bad_öode
;

4905 
öode
->
i_mode
 = 
	`À16_to_˝u
(
øw_öode
->i_mode);

4906 
i_uid
 = (
uid_t
)
	`À16_to_˝u
(
øw_öode
->
i_uid_low
);

4907 
i_gid
 = (
gid_t
)
	`À16_to_˝u
(
øw_öode
->
i_gid_low
);

4908 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
) &&

4909 
	`PXT4_INODE_SIZE
(
sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

4910 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

4911 
i_¥ojid
 = (
¥ojid_t
)
	`À32_to_˝u
(
øw_öode
->i_projid);

4913 
i_¥ojid
 = 
PXT4_DEF_PROJID
;

4915 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

4916 
i_uid
 |
	`À16_to_˝u
(
øw_öode
->
i_uid_high
) << 16;

4917 
i_gid
 |
	`À16_to_˝u
(
øw_öode
->
i_gid_high
) << 16;

4919 
	`i_uid_wrôe
(
öode
, 
i_uid
);

4920 
	`i_gid_wrôe
(
öode
, 
i_gid
);

4921 
ei
->
i_¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, i_projid);

4922 
	`£t_∆ök
(
öode
, 
	`À16_to_˝u
(
øw_öode
->
i_löks_cou¡
));

4924 
	`pxt4_˛ór_°©e_Êags
(
ei
);

4925 
ei
->
i_ölöe_off
 = 0;

4926 
ei
->
i_dú_°¨t_lookup
 = 0;

4927 
ei
->
i_dtime
 = 
	`À32_to_˝u
(
øw_öode
->i_dtime);

4933 i‡(
öode
->
i_∆ök
 == 0) {

4934 i‡((
öode
->
i_mode
 == 0 ||

4935 !(
	`PXT4_SB
(
öode
->
i_sb
)->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
)) &&

4936 
öo
 !
PXT4_BOOT_LOADER_INO
) {

4938 
ªt
 = -
ESTALE
;

4939 
bad_öode
;

4948 
ei
->
i_Êags
 = 
	`À32_to_˝u
(
øw_öode
->i_flags);

4949 
	`pxt4_£t_öode_Êags
(
öode
);

4950 
öode
->
i_blocks
 = 
	`pxt4_öode_blocks
(
øw_öode
, 
ei
);

4951 
ei
->
i_fûe_a˛
 = 
	`À32_to_˝u
(
øw_öode
->
i_fûe_a˛_lo
);

4952 i‡(
	`pxt4_has_„©uª_64bô
(
sb
))

4953 
ei
->
i_fûe_a˛
 |=

4954 ((
__u64
)
	`À16_to_˝u
(
øw_öode
->
i_fûe_a˛_high
)) << 32;

4955 
öode
->
i_size
 = 
	`pxt4_isize
(
sb
, 
øw_öode
);

4956 i‡((
size
 = 
	`i_size_ªad
(
öode
)) < 0) {

4957 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

4958 "igë: bad i_sizêvÆue: %Œd", 
size
);

4959 
ªt
 = -
EFSCORRUPTED
;

4960 
bad_öode
;

4962 
ei
->
i_disksize
 = 
öode
->
i_size
;

4963 #ifde‡
CONFIG_QUOTA


4964 
ei
->
i_ª£rved_quŸa
 = 0;

4966 
öode
->
i_gíî©i⁄
 = 
	`À32_to_˝u
(
øw_öode
->i_generation);

4967 
ei
->
i_block_group
 = 
ûoc
.
block_group
;

4968 
ei
->
i_œ°_Æloc_group
 = ~0;

4973 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

4974 
ei
->
i_d©a
[
block
] = 
øw_öode
->
i_block
[block];

4975 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

4984 i‡(
jou∫Æ
) {

4985 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

4986 
tid_t
 
tid
;

4988 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

4989 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

4990 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

4992 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

4993 i‡(
å™ß˘i⁄
)

4994 
tid
 = 
å™ß˘i⁄
->
t_tid
;

4996 
tid
 = 
jou∫Æ
->
j_commô_£quí˚
;

4997 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4998 
ei
->
i_sync_tid
 = 
tid
;

4999 
ei
->
i_d©async_tid
 = 
tid
;

5002 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5003 i‡(
ei
->
i_exåa_isize
 == 0) {

5005 
	`BUILD_BUG_ON
((
pxt4_öode
) & 3);

5006 
ei
->
i_exåa_isize
 = (
pxt4_öode
) -

5007 
PXT4_GOOD_OLD_INODE_SIZE
;

5009 
ªt
 = 
	`pxt4_igë_exåa_öode
(
öode
, 
øw_öode
, 
ei
);

5010 i‡(
ªt
)

5011 
bad_öode
;

5015 
	`PXT4_INODE_GET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5016 
	`PXT4_INODE_GET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5017 
	`PXT4_INODE_GET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5018 
	`PXT4_EINODE_GET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5020 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5021 
u64
 
ivîs
 = 
	`À32_to_˝u
(
øw_öode
->
i_disk_vîsi⁄
);

5023 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
) {

5024 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5025 
ivîs
 |=

5026 (
__u64
)(
	`À32_to_˝u
(
øw_öode
->
i_vîsi⁄_hi
)) << 32;

5028 
	`pxt4_öode_£t_ivîsi⁄_quîõd
(
öode
, 
ivîs
);

5031 
ªt
 = 0;

5032 i‡(
ei
->
i_fûe_a˛
 &&

5033 !
	`pxt4_d©a_block_vÆid
(
	`PXT4_SB
(
sb
), 
ei
->
i_fûe_a˛
, 1)) {

5034 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5036 
ei
->
i_fûe_a˛
);

5037 
ªt
 = -
EFSCORRUPTED
;

5038 
bad_öode
;

5039 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5041 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

5042 (
	`S_ISLNK
(
öode
->
i_mode
) &&

5043 !
	`pxt4_öode_is_Á°_symlök
(
öode
))) {

5044 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))

5045 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

5047 
ªt
 = 
	`pxt4_öd_check_öode
(
öode
);

5050 i‡(
ªt
)

5051 
bad_öode
;

5053 i‡(
	`S_ISREG
(
öode
->
i_mode
)) {

5054 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

5055 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

5056 
	`pxt4_£t_a›s
(
öode
);

5057 } i‡(
	`S_ISDIR
(
öode
->
i_mode
)) {

5058 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

5059 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

5060 } i‡(
	`S_ISLNK
(
öode
->
i_mode
)) {

5062 i‡(
	`IS_APPEND
(
öode
Ë|| 
	`IS_IMMUTABLE
(inode)) {

5063 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5066 
ªt
 = -
EFSCORRUPTED
;

5067 
bad_öode
;

5069 i‡(
	`IS_ENCRYPTED
(
öode
)) {

5070 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

5071 
	`pxt4_£t_a›s
(
öode
);

5072 } i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

5073 
öode
->
i_lök
 = (*)
ei
->
i_d©a
;

5074 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

5075 
	`nd_ãrmö©e_lök
(
ei
->
i_d©a
, 
öode
->
i_size
,

5076 (
ei
->
i_d©a
) - 1);

5078 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

5079 
	`pxt4_£t_a›s
(
öode
);

5081 
	`öode_nohighmem
(
öode
);

5082 } i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode) ||

5083 
	`S_ISFIFO
(
öode
->
i_mode
Ë|| 
	`S_ISSOCK
(inode->i_mode)) {

5084 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

5085 i‡(
øw_öode
->
i_block
[0])

5086 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5087 
	`ﬁd_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[0])));

5089 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
,

5090 
	`√w_decode_dev
(
	`À32_to_˝u
(
øw_öode
->
i_block
[1])));

5091 } i‡(
öo
 =
PXT4_BOOT_LOADER_INO
) {

5092 
	`make_bad_öode
(
öode
);

5094 
ªt
 = -
EFSCORRUPTED
;

5095 
	`pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

5096 "igë: bogu†i_modê(%o)", 
öode
->
i_mode
);

5097 
bad_öode
;

5099 
	`bªl£
(
ûoc
.
bh
);

5101 
	`u∆ock_√w_öode
(
öode
);

5102  
öode
;

5104 
bad_öode
:

5105 
	`bªl£
(
ûoc
.
bh
);

5106 
	`igë_Áûed
(
öode
);

5107  
	`ERR_PTR
(
ªt
);

5108 
	}
}

5110 
	$pxt4_öode_blocks_£t
(
h™dÀ_t
 *
h™dÀ
,

5111 
pxt4_öode
 *
øw_öode
,

5112 
pxt4_öode_öfo
 *
ei
)

5114 
öode
 *öodê&(
ei
->
vfs_öode
);

5115 
u64
 
i_blocks
 = 
öode
->i_blocks;

5116 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5118 i‡(
i_blocks
 <= ~0U) {

5123 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5124 
øw_öode
->
i_blocks_high
 = 0;

5125 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5128 i‡(!
	`pxt4_has_„©uª_huge_fûe
(
sb
))

5129  -
EFBIG
;

5131 i‡(
i_blocks
 <= 0xffffffffffffULL) {

5136 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5137 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5138 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5140 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_HUGE_FILE
);

5142 
i_blocks
 = i_block†>> (
öode
->
i_blkbôs
 - 9);

5143 
øw_öode
->
i_blocks_lo
 = 
	`˝u_to_À32
(
i_blocks
);

5144 
øw_öode
->
i_blocks_high
 = 
	`˝u_to_À16
(
i_blocks
 >> 32);

5147 
	}
}

5149 
	sŸhî_öode
 {

5150 
	m‹ig_öo
;

5151 
pxt4_öode
 *
	møw_öode
;

5154 
	$Ÿhî_öode_m©ch
(
öode
 * inode, 
öo
,

5155 *
d©a
)

5157 
Ÿhî_öode
 *
oi
 = (Ÿhî_öodê*Ë
d©a
;

5159 i‡((
öode
->
i_öo
 !
öo
) ||

5160 (
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5161 
I_DIRTY_INODE
)) ||

5162 ((
öode
->
i_°©e
 & 
I_DIRTY_TIME
) == 0))

5164 
	`•ö_lock
(&
öode
->
i_lock
);

5165 i‡(((
öode
->
i_°©e
 & (
I_FREEING
 | 
I_WILL_FREE
 | 
I_NEW
 |

5166 
I_DIRTY_INODE
)) == 0) &&

5167 (
öode
->
i_°©e
 & 
I_DIRTY_TIME
)) {

5168 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5170 
öode
->
i_°©e
 &~(
I_DIRTY_TIME
 | 
I_DIRTY_TIME_EXPIRED
);

5171 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5173 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5174 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
oi
->
øw_öode
);

5175 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
oi
->
øw_öode
);

5176 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
oi
->
øw_öode
);

5177 
	`pxt4_öode_csum_£t
(
öode
, 
oi
->
øw_öode
, 
ei
);

5178 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5179 
	`åa˚_pxt4_Ÿhî_öode_upd©e_time
(
öode
, 
oi
->
‹ig_öo
);

5182 
	`•ö_u∆ock
(&
öode
->
i_lock
);

5184 
	}
}

5190 
	$pxt4_upd©e_Ÿhî_öodes_time
(
su≥r_block
 *
sb
,

5191 
‹ig_öo
, *
buf
)

5193 
Ÿhî_öode
 
oi
;

5194 
öo
;

5195 
i
, 
öodes_≥r_block
 = 
	`PXT4_SB
(
sb
)->
s_öodes_≥r_block
;

5196 
öode_size
 = 
	`PXT4_INODE_SIZE
(
sb
);

5198 
oi
.
‹ig_öo
 = orig_ino;

5204 
öo
 = ((
‹ig_öo
 - 1Ë& ~(
öodes_≥r_block
 - 1)) + 1;

5205 
i
 = 0; i < 
öodes_≥r_block
; i++, 
öo
++, 
buf
 +
öode_size
) {

5206 i‡(
öo
 =
‹ig_öo
)

5208 
oi
.
øw_öode
 = (
pxt4_öode
 *Ë
buf
;

5209 (Ë
	`föd_öode_nowaô
(
sb
, 
öo
, 
Ÿhî_öode_m©ch
, &
oi
);

5211 
	}
}

5220 
	$pxt4_do_upd©e_öode
(
h™dÀ_t
 *
h™dÀ
,

5221 
öode
 *inode,

5222 
pxt4_ûoc
 *
ûoc
)

5224 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5225 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5226 
buf„r_hód
 *
bh
 = 
ûoc
->bh;

5227 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

5228 
îr
 = 0, 
rc
, 
block
;

5229 
√ed_d©async
 = 0, 
£t_œrge_fûe
 = 0;

5230 
uid_t
 
i_uid
;

5231 
gid_t
 
i_gid
;

5232 
¥ojid_t
 
i_¥ojid
;

5234 
	`•ö_lock
(&
ei
->
i_øw_lock
);

5238 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
))

5239 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

5241 
øw_öode
->
i_mode
 = 
	`˝u_to_À16
(
öode
->i_mode);

5242 
i_uid
 = 
	`i_uid_ªad
(
öode
);

5243 
i_gid
 = 
	`i_gid_ªad
(
öode
);

5244 
i_¥ojid
 = 
	`‰om_k¥ojid
(&
öô_u£r_ns
, 
ei
->i_projid);

5245 i‡(!(
	`ã°_›t
(
öode
->
i_sb
, 
NO_UID32
))) {

5246 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_uid
));

5247 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`low_16_bôs
(
i_gid
));

5252 i‡(
ei
->
i_dtime
 && 
	`li°_em±y
(&ei->
i_‹ph™
)) {

5253 
øw_öode
->
i_uid_high
 = 0;

5254 
øw_öode
->
i_gid_high
 = 0;

5256 
øw_öode
->
i_uid_high
 =

5257 
	`˝u_to_À16
(
	`high_16_bôs
(
i_uid
));

5258 
øw_öode
->
i_gid_high
 =

5259 
	`˝u_to_À16
(
	`high_16_bôs
(
i_gid
));

5262 
øw_öode
->
i_uid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowuid
(
i_uid
));

5263 
øw_öode
->
i_gid_low
 = 
	`˝u_to_À16
(
	`fs_high2lowgid
(
i_gid
));

5264 
øw_öode
->
i_uid_high
 = 0;

5265 
øw_öode
->
i_gid_high
 = 0;

5267 
øw_öode
->
i_löks_cou¡
 = 
	`˝u_to_À16
(
öode
->
i_∆ök
);

5269 
	`PXT4_INODE_SET_XTIME
(
i_˘ime
, 
öode
, 
øw_öode
);

5270 
	`PXT4_INODE_SET_XTIME
(
i_mtime
, 
öode
, 
øw_öode
);

5271 
	`PXT4_INODE_SET_XTIME
(
i_©ime
, 
öode
, 
øw_öode
);

5272 
	`PXT4_EINODE_SET_XTIME
(
i_¸time
, 
ei
, 
øw_öode
);

5274 
îr
 = 
	`pxt4_öode_blocks_£t
(
h™dÀ
, 
øw_öode
, 
ei
);

5275 i‡(
îr
) {

5276 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5277 
out_bªl£
;

5279 
øw_öode
->
i_dtime
 = 
	`˝u_to_À32
(
ei
->i_dtime);

5280 
øw_öode
->
i_Êags
 = 
	`˝u_to_À32
(
ei
->i_flags & 0xFFFFFFFF);

5281 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
)))

5282 
øw_öode
->
i_fûe_a˛_high
 =

5283 
	`˝u_to_À16
(
ei
->
i_fûe_a˛
 >> 32);

5284 
øw_öode
->
i_fûe_a˛_lo
 = 
	`˝u_to_À32
(
ei
->
i_fûe_a˛
);

5285 i‡(
ei
->
i_disksize
 !
	`pxt4_isize
(
öode
->
i_sb
, 
øw_öode
)) {

5286 
	`pxt4_isize_£t
(
øw_öode
, 
ei
->
i_disksize
);

5287 
√ed_d©async
 = 1;

5289 i‡(
ei
->
i_disksize
 > 0x7fffffffULL) {

5290 i‡(!
	`pxt4_has_„©uª_œrge_fûe
(
sb
) ||

5291 
	`PXT4_SB
(
sb
)->
s_es
->
s_ªv_Àvñ
 ==

5292 
	`˝u_to_À32
(
PXT4_GOOD_OLD_REV
))

5293 
£t_œrge_fûe
 = 1;

5295 
øw_öode
->
i_gíî©i⁄
 = 
	`˝u_to_À32
(
öode
->i_generation);

5296 i‡(
	`S_ISCHR
(
öode
->
i_mode
Ë|| 
	`S_ISBLK
(inode->i_mode)) {

5297 i‡(
	`ﬁd_vÆid_dev
(
öode
->
i_rdev
)) {

5298 
øw_öode
->
i_block
[0] =

5299 
	`˝u_to_À32
(
	`ﬁd_ícode_dev
(
öode
->
i_rdev
));

5300 
øw_öode
->
i_block
[1] = 0;

5302 
øw_öode
->
i_block
[0] = 0;

5303 
øw_öode
->
i_block
[1] =

5304 
	`˝u_to_À32
(
	`√w_ícode_dev
(
öode
->
i_rdev
));

5305 
øw_öode
->
i_block
[2] = 0;

5307 } i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

5308 
block
 = 0; block < 
PXT4_N_BLOCKS
; block++)

5309 
øw_öode
->
i_block
[
block
] = 
ei
->
i_d©a
[block];

5312 i‡(
	`likñy
(!
	`ã°_›t2
(
öode
->
i_sb
, 
HURD_COMPAT
))) {

5313 
u64
 
ivîs
 = 
	`pxt4_öode_≥ek_ivîsi⁄
(
öode
);

5315 
øw_öode
->
i_disk_vîsi⁄
 = 
	`˝u_to_À32
(
ivîs
);

5316 i‡(
ei
->
i_exåa_isize
) {

5317 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_vîsi⁄_hi
))

5318 
øw_öode
->
i_vîsi⁄_hi
 =

5319 
	`˝u_to_À32
(
ivîs
 >> 32);

5320 
øw_öode
->
i_exåa_isize
 =

5321 
	`˝u_to_À16
(
ei
->
i_exåa_isize
);

5325 
	`BUG_ON
(!
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
) &&

5326 
i_¥ojid
 !
PXT4_DEF_PROJID
);

5328 i‡(
	`PXT4_INODE_SIZE
(
öode
->
i_sb
Ë> 
PXT4_GOOD_OLD_INODE_SIZE
 &&

5329 
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
))

5330 
øw_öode
->
i_¥ojid
 = 
	`˝u_to_À32
(i_projid);

5332 
	`pxt4_öode_csum_£t
(
öode
, 
øw_öode
, 
ei
);

5333 
	`•ö_u∆ock
(&
ei
->
i_øw_lock
);

5334 i‡(
öode
->
i_sb
->
s_Êags
 & 
SB_LAZYTIME
)

5335 
	`pxt4_upd©e_Ÿhî_öodes_time
(
öode
->
i_sb
, inode->
i_öo
,

5336 
bh
->
b_d©a
);

5338 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

5339 
rc
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5340 i‡(!
îr
)

5341 
îr
 = 
rc
;

5342 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

5343 i‡(
£t_œrge_fûe
) {

5344 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get writeáccess");

5345 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

5346 i‡(
îr
)

5347 
out_bªl£
;

5348 
	`pxt4_£t_„©uª_œrge_fûe
(
sb
);

5349 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

5350 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

5352 
	`pxt4_upd©e_öode_fsync_å™s
(
h™dÀ
, 
öode
, 
√ed_d©async
);

5353 
out_bªl£
:

5354 
	`bªl£
(
bh
);

5355 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5356  
îr
;

5357 
	}
}

5393 
	$pxt4_wrôe_öode
(
öode
 *öode, 
wrôeback_c⁄åﬁ
 *
wbc
)

5395 
îr
;

5397 i‡(
	`WARN_ON_ONCE
(
cuºít
->
Êags
 & 
PF_MEMALLOC
) ||

5398 
	`sb_rd⁄ly
(
öode
->
i_sb
))

5401 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5402  -
EIO
;

5404 i‡(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
) {

5405 i‡(
	`pxt4_jou∫Æ_cuºít_h™dÀ
()) {

5406 
	`jbd_debug
(1, "calledÑecursively,Çon-PF_MEMALLOC!\n");

5407 
	`dump_°ack
();

5408  -
EIO
;

5416 i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
 || wbc->
f‹_sync
)

5419 
îr
 = 
	`jbd3_com∂ëe_å™ß˘i⁄
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
,

5420 
	`PXT4_I
(
öode
)->
i_sync_tid
);

5422 
pxt4_ûoc
 
ûoc
;

5424 
îr
 = 
	`__pxt4_gë_öode_loc
(
öode
, &
ûoc
, 0);

5425 i‡(
îr
)

5426  
îr
;

5431 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 && !wbc->
f‹_sync
)

5432 
	`sync_dúty_buf„r
(
ûoc
.
bh
);

5433 i‡(
	`buf„r_ªq
(
ûoc
.
bh
Ë&& !
	`buf„r_u±od©e
(iloc.bh)) {

5434 
	`PXT4_ERROR_INODE_BLOCK
(
öode
, 
ûoc
.
bh
->
b_blockƒ
,

5436 
îr
 = -
EIO
;

5438 
	`bªl£
(
ûoc
.
bh
);

5440  
îr
;

5441 
	}
}

5448 
	$pxt4_waô_f‹_èû_∑ge_commô
(
öode
 *inode)

5450 
∑ge
 *page;

5451 
off£t
;

5452 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
;

5453 
tid_t
 
commô_tid
 = 0;

5454 
ªt
;

5456 
off£t
 = 
öode
->
i_size
 & (
PAGE_SIZE
 - 1);

5462 i‡(
off£t
 > 
PAGE_SIZE
 - 
	`i_blocksize
(
öode
))

5465 
∑ge
 = 
	`föd_lock_∑ge
(
öode
->
i_m≠pög
,

5466 
öode
->
i_size
 >> 
PAGE_SHIFT
);

5467 i‡(!
∑ge
)

5469 
ªt
 = 
	`__pxt4_jou∫ÆÀd_övÆid©ïage
(
∑ge
, 
off£t
,

5470 
PAGE_SIZE
 - 
off£t
);

5471 
	`u∆ock_∑ge
(
∑ge
);

5472 
	`put_∑ge
(
∑ge
);

5473 i‡(
ªt
 !-
EBUSY
)

5475 
commô_tid
 = 0;

5476 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

5477 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

5478 
commô_tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

5479 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

5480 i‡(
commô_tid
)

5481 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
commô_tid
);

5483 
	}
}

5509 
	$pxt4_£èâr
(
díåy
 *díåy, 
üâr
 *
©å
)

5511 
öode
 *öodê
	`d_öode
(
díåy
);

5512 
îr‹
, 
rc
 = 0;

5513 
‹ph™
 = 0;

5514 c⁄° 
ü_vÆid
 = 
©å
->ia_valid;

5516 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5517  -
EIO
;

5519 
îr‹
 = 
	`£èâr_¥ï¨e
(
díåy
, 
©å
);

5520 i‡(
îr‹
)

5521  
îr‹
;

5523 
îr‹
 = 
	`fs¸y±_¥ï¨e_£èâr
(
díåy
, 
©å
);

5524 i‡(
îr‹
)

5525  
îr‹
;

5527 i‡(
	`is_quŸa_modifiˇti⁄
(
öode
, 
©å
)) {

5528 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

5529 i‡(
îr‹
)

5530  
îr‹
;

5532 i‡((
ü_vÆid
 & 
ATTR_UID
 && !
	`uid_eq
(
©å
->
ü_uid
, 
öode
->
i_uid
)) ||

5533 (
ü_vÆid
 & 
ATTR_GID
 && !
	`gid_eq
(
©å
->
ü_gid
, 
öode
->
i_gid
))) {

5534 
h™dÀ_t
 *
h™dÀ
;

5538 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5539 (
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
öode
->
i_sb
) +

5540 
	`PXT4_MAXQUOTAS_DEL_BLOCKS
(
öode
->
i_sb
)) + 3);

5541 i‡(
	`IS_ERR
(
h™dÀ
)) {

5542 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5543 
îr_out
;

5549 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5550 
îr‹
 = 
	`dquŸ_å™s„r
(
öode
, 
©å
);

5551 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

5553 i‡(
îr‹
) {

5554 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5555  
îr‹
;

5559 i‡(
©å
->
ü_vÆid
 & 
ATTR_UID
)

5560 
öode
->
i_uid
 = 
©å
->
ü_uid
;

5561 i‡(
©å
->
ü_vÆid
 & 
ATTR_GID
)

5562 
öode
->
i_gid
 = 
©å
->
ü_gid
;

5563 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5564 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5567 i‡(
©å
->
ü_vÆid
 & 
ATTR_SIZE
) {

5568 
h™dÀ_t
 *
h™dÀ
;

5569 
loff_t
 
ﬁdsize
 = 
öode
->
i_size
;

5570 
shrök
 = (
©å
->
ü_size
 <
öode
->
i_size
);

5572 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
))) {

5573 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

5575 i‡(
©å
->
ü_size
 > 
sbi
->
s_bôm≠_maxbyãs
)

5576  -
EFBIG
;

5578 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

5579  -
EINVAL
;

5581 i‡(
	`IS_I_VERSION
(
öode
Ë&& 
©å
->
ü_size
 !öode->
i_size
)

5582 
	`öode_öc_ivîsi⁄
(
öode
);

5584 i‡(
	`pxt4_should_‹dî_d©a
(
öode
) &&

5585 (
©å
->
ü_size
 < 
öode
->
i_size
)) {

5586 
îr‹
 = 
	`pxt4_begö_‹dîed_åunˇã
(
öode
,

5587 
©å
->
ü_size
);

5588 i‡(
îr‹
)

5589 
îr_out
;

5591 i‡(
©å
->
ü_size
 !
öode
->
i_size
) {

5592 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 3);

5593 i‡(
	`IS_ERR
(
h™dÀ
)) {

5594 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5595 
îr_out
;

5597 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& 
shrök
) {

5598 
îr‹
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

5599 
‹ph™
 = 1;

5605 i‡(!
shrök
) {

5606 
öode
->
i_mtime
 = 
	`cuºít_time
(inode);

5607 
öode
->
i_˘ime
 = inode->
i_mtime
;

5609 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5610 
	`PXT4_I
(
öode
)->
i_disksize
 = 
©å
->
ü_size
;

5611 
rc
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5612 i‡(!
îr‹
)

5613 
îr‹
 = 
rc
;

5619 i‡(!
îr‹
)

5620 
	`i_size_wrôe
(
öode
, 
©å
->
ü_size
);

5621 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

5622 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5623 i‡(
îr‹
) {

5624 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5625 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5626 
îr_out
;

5629 i‡(!
shrök
) {

5630 
	`∑geˇche_isize_exãnded
(
öode
, 
ﬁdsize
, inode->
i_size
);

5636 
	`öode_dio_waô
(
öode
);

5638 i‡(
‹ph™
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5639 
	`pxt4_waô_f‹_èû_∑ge_commô
(
öode
);

5640 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5642 
rc
 = 
	`pxt4_bªak_œyouts
(
öode
);

5643 i‡(
rc
) {

5644 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5645 
îr‹
 = 
rc
;

5646 
îr_out
;

5653 
	`åunˇã_∑geˇche
(
öode
, inode->
i_size
);

5654 i‡(
shrök
) {

5655 
rc
 = 
	`pxt4_åunˇã
(
öode
);

5656 i‡(
rc
)

5657 
îr‹
 = 
rc
;

5659 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

5662 i‡(!
îr‹
) {

5663 
	`£èâr_c›y
(
öode
, 
©å
);

5664 
	`m¨k_öode_dúty
(
öode
);

5671 i‡(
‹ph™
 && 
öode
->
i_∆ök
)

5672 
	`pxt4_‹ph™_dñ
(
NULL
, 
öode
);

5674 i‡(!
îr‹
 && (
ü_vÆid
 & 
ATTR_MODE
))

5675 
rc
 = 
	`posix_a˛_chmod
(
öode
, inode->
i_mode
);

5677 
îr_out
:

5678 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

5679 i‡(!
îr‹
)

5680 
îr‹
 = 
rc
;

5681  
îr‹
;

5682 
	}
}

5684 
	$pxt4_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5685 
u32
 
ªque°_mask
, 
quîy_Êags
)

5687 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5688 
pxt4_öode
 *
øw_öode
;

5689 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5690 
Êags
;

5692 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¸time
)) {

5693 
°©
->
ªsu…_mask
 |
STATX_BTIME
;

5694 
°©
->
btime
.
tv_£c
 = 
ei
->
i_¸time
.tv_sec;

5695 
°©
->
btime
.
tv_n£c
 = 
ei
->
i_¸time
.tv_nsec;

5698 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

5699 i‡(
Êags
 & 
PXT4_APPEND_FL
)

5700 
°©
->
©åibuãs
 |
STATX_ATTR_APPEND
;

5701 i‡(
Êags
 & 
PXT4_COMPR_FL
)

5702 
°©
->
©åibuãs
 |
STATX_ATTR_COMPRESSED
;

5703 i‡(
Êags
 & 
PXT4_ENCRYPT_FL
)

5704 
°©
->
©åibuãs
 |
STATX_ATTR_ENCRYPTED
;

5705 i‡(
Êags
 & 
PXT4_IMMUTABLE_FL
)

5706 
°©
->
©åibuãs
 |
STATX_ATTR_IMMUTABLE
;

5707 i‡(
Êags
 & 
PXT4_NODUMP_FL
)

5708 
°©
->
©åibuãs
 |
STATX_ATTR_NODUMP
;

5710 
°©
->
©åibuãs_mask
 |(
STATX_ATTR_APPEND
 |

5711 
STATX_ATTR_COMPRESSED
 |

5712 
STATX_ATTR_ENCRYPTED
 |

5713 
STATX_ATTR_IMMUTABLE
 |

5714 
STATX_ATTR_NODUMP
);

5716 
	`gíîic_fûœâr
(
öode
, 
°©
);

5718 
	}
}

5720 
	$pxt4_fûe_gë©å
(c⁄° 
∑th
 *∑th, 
k°©
 *
°©
,

5721 
u32
 
ªque°_mask
, 
quîy_Êags
)

5723 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5724 
u64
 
dñÆloc_blocks
;

5726 
	`pxt4_gë©å
(
∑th
, 
°©
, 
ªque°_mask
, 
quîy_Êags
);

5734 i‡(
	`u∆ikñy
(
	`pxt4_has_ölöe_d©a
(
öode
)))

5735 
°©
->
blocks
 +(°©->
size
 + 511) >> 9;

5747 
dñÆloc_blocks
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
öode
->
i_sb
),

5748 
	`PXT4_I
(
öode
)->
i_ª£rved_d©a_blocks
);

5749 
°©
->
blocks
 +
dñÆloc_blocks
 << (
öode
->
i_sb
->
s_blocksize_bôs
 - 9);

5751 
	}
}

5753 
	$pxt4_ödex_å™s_blocks
(
öode
 *öode, 
lblocks
,

5754 
≥xã¡s
)

5756 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

5757  
	`pxt4_öd_å™s_blocks
(
öode
, 
lblocks
);

5758  
	`pxt4_ext_ödex_å™s_blocks
(
öode
, 
≥xã¡s
);

5759 
	}
}

5772 
	$pxt4_mëa_å™s_blocks
(
öode
 *öode, 
lblocks
,

5773 
≥xã¡s
)

5775 
pxt4_group_t
 
groups
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
öode
->
i_sb
);

5776 
gdpblocks
;

5777 
idxblocks
;

5778 
ªt
 = 0;

5784 
idxblocks
 = 
	`pxt4_ödex_å™s_blocks
(
öode
, 
lblocks
, 
≥xã¡s
);

5786 
ªt
 = 
idxblocks
;

5792 
groups
 = 
idxblocks
 + 
≥xã¡s
;

5793 
gdpblocks
 = 
groups
;

5794 i‡(
groups
 > 
ngroups
)

5795 
groups
 = 
ngroups
;

5796 i‡(
groups
 > 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
)

5797 
gdpblocks
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_gdb_cou¡
;

5800 
ªt
 +
groups
 + 
gdpblocks
;

5803 
ªt
 +
	`PXT4_META_TRANS_BLOCKS
(
öode
->
i_sb
);

5805  
ªt
;

5806 
	}
}

5818 
	$pxt4_wrôïage_å™s_blocks
(
öode
 *inode)

5820 
bµ
 = 
	`pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
);

5821 
ªt
;

5823 
ªt
 = 
	`pxt4_mëa_å™s_blocks
(
öode
, 
bµ
, bpp);

5826 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

5827 
ªt
 +
bµ
;

5828  
ªt
;

5829 
	}
}

5840 
	$pxt4_chunk_å™s_blocks
(
öode
 *öode, 
ƒblocks
)

5842  
	`pxt4_mëa_å™s_blocks
(
öode
, 
ƒblocks
, 1);

5843 
	}
}

5849 
	$pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

5850 
öode
 *öode, 
pxt4_ûoc
 *
ûoc
)

5852 
îr
 = 0;

5854 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
)))) {

5855 
	`put_bh
(
ûoc
->
bh
);

5856  -
EIO
;

5858 i‡(
	`IS_I_VERSION
(
öode
))

5859 
	`öode_öc_ivîsi⁄
(
öode
);

5862 
	`gë_bh
(
ûoc
->
bh
);

5865 
îr
 = 
	`pxt4_do_upd©e_öode
(
h™dÀ
, 
öode
, 
ûoc
);

5866 
	`put_bh
(
ûoc
->
bh
);

5867  
îr
;

5868 
	}
}

5876 
	$pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

5877 
pxt4_ûoc
 *
ûoc
)

5879 
îr
;

5881 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

5882  -
EIO
;

5884 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, 
ûoc
);

5885 i‡(!
îr
) {

5886 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5887 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5888 i‡(
îr
) {

5889 
	`bªl£
(
ûoc
->
bh
);

5890 
ûoc
->
bh
 = 
NULL
;

5893 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

5894  
îr
;

5895 
	}
}

5897 
	$__pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5898 
√w_exåa_isize
,

5899 
pxt4_ûoc
 *
ûoc
,

5900 
h™dÀ_t
 *
h™dÀ
, *
no_ex∑nd
)

5902 
pxt4_öode
 *
øw_öode
;

5903 
pxt4_x©å_ibody_hódî
 *
hódî
;

5904 
îr‹
;

5906 
øw_öode
 = 
	`pxt4_øw_öode
(
ûoc
);

5908 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

5911 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
) ||

5912 
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)) {

5913 
	`mem£t
((*)
øw_öode
 + 
PXT4_GOOD_OLD_INODE_SIZE
 +

5914 
	`PXT4_I
(
öode
)->
i_exåa_isize
, 0,

5915 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
);

5916 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

5921 
îr‹
 = 
	`pxt4_ex∑nd_exåa_isize_ó
(
öode
, 
√w_exåa_isize
,

5922 
øw_öode
, 
h™dÀ
);

5923 i‡(
îr‹
) {

5927 *
no_ex∑nd
 = 1;

5930  
îr‹
;

5931 
	}
}

5937 
	$pxt4_åy_to_ex∑nd_exåa_isize
(
öode
 *inode,

5938 
√w_exåa_isize
,

5939 
pxt4_ûoc
 
ûoc
,

5940 
h™dÀ_t
 *
h™dÀ
)

5942 
no_ex∑nd
;

5943 
îr‹
;

5945 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
))

5946  -
EOVERFLOW
;

5957 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

5958 
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
,

5959 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
)) != 0)

5960  -
ENOSPC
;

5962 i‡(
	`pxt4_wrôe_åylock_x©å
(
öode
, &
no_ex∑nd
) == 0)

5963  -
EBUSY
;

5965 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, &
ûoc
,

5966 
h™dÀ
, &
no_ex∑nd
);

5967 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

5969  
îr‹
;

5970 
	}
}

5972 
	$pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

5973 
√w_exåa_isize
,

5974 
pxt4_ûoc
 *
ûoc
)

5976 
h™dÀ_t
 *
h™dÀ
;

5977 
no_ex∑nd
;

5978 
îr‹
, 
rc
;

5980 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
)) {

5981 
	`bªl£
(
ûoc
->
bh
);

5982  -
EOVERFLOW
;

5985 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
,

5986 
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
));

5987 i‡(
	`IS_ERR
(
h™dÀ
)) {

5988 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

5989 
	`bªl£
(
ûoc
->
bh
);

5990  
îr‹
;

5993 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

5995 
	`BUFFER_TRACE
(
ûoc
->
bh
, "get_write_access");

5996 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
->
bh
);

5997 i‡(
îr‹
) {

5998 
	`bªl£
(
ûoc
->
bh
);

5999 
out_°›
;

6002 
îr‹
 = 
	`__pxt4_ex∑nd_exåa_isize
(
öode
, 
√w_exåa_isize
, 
ûoc
,

6003 
h™dÀ
, &
no_ex∑nd
);

6005 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, 
ûoc
);

6006 i‡(!
îr‹
)

6007 
îr‹
 = 
rc
;

6009 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

6010 
out_°›
:

6011 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6012  
îr‹
;

6013 
	}
}

6028 
	$pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

6030 
pxt4_ûoc
 
ûoc
;

6031 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6032 
îr
;

6034 
	`might_¶ìp
();

6035 
	`åa˚_pxt4_m¨k_öode_dúty
(
öode
, 
_RET_IP_
);

6036 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

6037 i‡(
îr
)

6038  
îr
;

6040 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 < 
sbi
->
s_w™t_exåa_isize
)

6041 
	`pxt4_åy_to_ex∑nd_exåa_isize
(
öode
, 
sbi
->
s_w™t_exåa_isize
,

6042 
ûoc
, 
h™dÀ
);

6044  
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

6045 
	}
}

6065 
	$pxt4_dúty_öode
(
öode
 *öode, 
Êags
)

6067 
h™dÀ_t
 *
h™dÀ
;

6069 i‡(
Êags
 =
I_DIRTY_TIME
)

6071 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 2);

6072 i‡(
	`IS_ERR
(
h™dÀ
))

6073 
out
;

6075 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6077 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6078 
out
:

6080 
	}
}

6082 
	$pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *öode, 
vÆ
)

6084 
jou∫Æ_t
 *
jou∫Æ
;

6085 
h™dÀ_t
 *
h™dÀ
;

6086 
îr
;

6087 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

6099 
jou∫Æ
 = 
	`PXT4_JOURNAL
(
öode
);

6100 i‡(!
jou∫Æ
)

6102 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

6103  -
EROFS
;

6106 
	`öode_dio_waô
(
öode
);

6116 i‡(
vÆ
) {

6117 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6118 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

6119 i‡(
îr
 < 0) {

6120 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6121  
îr
;

6125 
	`≥r˝u_down_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6126 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

6136 i‡(
vÆ
)

6137 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6139 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

6140 i‡(
îr
 < 0) {

6141 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6142 
	`≥r˝u_up_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6143  
îr
;

6145 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
);

6147 
	`pxt4_£t_a›s
(
öode
);

6149 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

6150 
	`≥r˝u_up_wrôe
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

6152 i‡(
vÆ
)

6153 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6157 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

6158 i‡(
	`IS_ERR
(
h™dÀ
))

6159  
	`PTR_ERR
(
h™dÀ
);

6161 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

6162 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

6163 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6164 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

6166  
îr
;

6167 
	}
}

6169 
	$pxt4_bh_unm≠≥d
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

6171  !
	`buf„r_m≠≥d
(
bh
);

6172 
	}
}

6174 
vm_Áu…_t
 
	$pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
)

6176 
vm_¨ó_°ru˘
 *
vma
 = 
vmf
->vma;

6177 
∑ge
 *∑gê
vmf
->page;

6178 
loff_t
 
size
;

6179 
Àn
;

6180 
îr
;

6181 
vm_Áu…_t
 
ªt
;

6182 
fûe
 *fûê
vma
->
vm_fûe
;

6183 
öode
 *öodê
	`fûe_öode
(
fûe
);

6184 
addªss_•a˚
 *
m≠pög
 = 
öode
->
i_m≠pög
;

6185 
h™dÀ_t
 *
h™dÀ
;

6186 
gë_block_t
 *
gë_block
;

6187 
ªåõs
 = 0;

6189 
	`sb_°¨t_∑geÁu…
(
öode
->
i_sb
);

6190 
	`fûe_upd©e_time
(
vma
->
vm_fûe
);

6192 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6194 
îr
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

6195 i‡(
îr
)

6196 
out_ªt
;

6199 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
) &&

6200 !
	`pxt4_should_jou∫Æ_d©a
(
öode
) &&

6201 !
	`pxt4_n⁄da_swôch
(
öode
->
i_sb
)) {

6203 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
,

6204 
pxt4_da_gë_block_¥ï
);

6205 } 
îr
 =-
ENOSPC
 &&

6206 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

6207 
out_ªt
;

6210 
	`lock_∑ge
(
∑ge
);

6211 
size
 = 
	`i_size_ªad
(
öode
);

6213 i‡(
∑ge
->
m≠pög
 !m≠pög || 
	`∑ge_off£t
’ageË> 
size
) {

6214 
	`u∆ock_∑ge
(
∑ge
);

6215 
ªt
 = 
VM_FAULT_NOPAGE
;

6216 
out
;

6219 i‡(
∑ge
->
ödex
 =
size
 >> 
PAGE_SHIFT
)

6220 
Àn
 = 
size
 & ~
PAGE_MASK
;

6222 
Àn
 = 
PAGE_SIZE
;

6227 i‡(
	`∑ge_has_buf„rs
(
∑ge
)) {

6228 i‡(!
	`pxt4_wÆk_∑ge_buf„rs
(
NULL
, 
	`∑ge_buf„rs
(
∑ge
),

6229 0, 
Àn
, 
NULL
,

6230 
pxt4_bh_unm≠≥d
)) {

6232 
	`waô_f‹_°abÀ_∑ge
(
∑ge
);

6233 
ªt
 = 
VM_FAULT_LOCKED
;

6234 
out
;

6237 
	`u∆ock_∑ge
(
∑ge
);

6239 i‡(
	`pxt4_should_di‹ód_nﬁock
(
öode
))

6240 
gë_block
 = 
pxt4_gë_block_unwrôãn
;

6242 
gë_block
 = 
pxt4_gë_block
;

6243 
ªåy_Æloc
:

6244 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_WRITE_PAGE
,

6245 
	`pxt4_wrôïage_å™s_blocks
(
öode
));

6246 i‡(
	`IS_ERR
(
h™dÀ
)) {

6247 
ªt
 = 
VM_FAULT_SIGBUS
;

6248 
out
;

6250 
îr
 = 
	`block_∑ge_mkwrôe
(
vma
, 
vmf
, 
gë_block
);

6251 i‡(!
îr
 && 
	`pxt4_should_jou∫Æ_d©a
(
öode
)) {

6252 i‡(
	`pxt4_wÆk_∑ge_buf„rs
(
h™dÀ
, 
	`∑ge_buf„rs
(
∑ge
), 0,

6253 
PAGE_SIZE
, 
NULL
, 
do_jou∫Æ_gë_wrôe_ac˚ss
)) {

6254 
	`u∆ock_∑ge
(
∑ge
);

6255 
ªt
 = 
VM_FAULT_SIGBUS
;

6256 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6257 
out
;

6259 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_JDATA
);

6261 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

6262 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

6263 
ªåy_Æloc
;

6264 
out_ªt
:

6265 
ªt
 = 
	`block_∑ge_mkwrôe_ªtu∫
(
îr
);

6266 
out
:

6267 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6268 
	`sb_íd_∑geÁu…
(
öode
->
i_sb
);

6269  
ªt
;

6270 
	}
}

6272 
vm_Áu…_t
 
	$pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
)

6274 
öode
 *öodê
	`fûe_öode
(
vmf
->
vma
->
vm_fûe
);

6275 
vm_Áu…_t
 
ªt
;

6277 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6278 
ªt
 = 
	`fûem≠_Áu…
(
vmf
);

6279 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

6281  
ªt
;

6282 
	}
}

	@internal.h

11 #i‚de‡
__MM_INTERNAL_H


12 
	#__MM_INTERNAL_H


	)

14 
	~<löux/fs.h
>

15 
	~<löux/mm.h
>

16 
	~<löux/∑gem≠.h
>

17 
	~<löux/åa˚poöt-defs.h
>

25 
	#GFP_RECLAIM_MASK
 (
__GFP_RECLAIM
|
__GFP_HIGH
|
__GFP_IO
|
__GFP_FS
|\

26 
__GFP_NOWARN
|
__GFP_RETRY_MAYFAIL
|
__GFP_NOFAIL
|\

27 
__GFP_NORETRY
|
__GFP_MEMALLOC
|
__GFP_NOMEMALLOC
|\

28 
__GFP_ATOMIC
)

	)

31 
	#GFP_BOOT_MASK
 (
__GFP_BITS_MASK
 & ~(
__GFP_RECLAIM
|
__GFP_IO
|
__GFP_FS
))

	)

34 
	#GFP_CONSTRAINT_MASK
 (
__GFP_HARDWALL
|
__GFP_THISNODE
)

	)

37 
	#GFP_SLAB_BUG_MASK
 (
__GFP_DMA32
|
__GFP_HIGHMEM
|~
__GFP_BITS_MASK
)

	)

39 
∑ge_wrôeback_öô
();

41 
vm_Áu…_t
 
do_sw≠_∑ge
(
vm_Áu…
 *
vmf
);

43 
‰ì_pgèbÀs
(
mmu_g©hî
 *
éb
, 
vm_¨ó_°ru˘
 *
°¨t_vma
,

44 
Êo‹
, 
˚ûög
);

46 
ölöe
 
boﬁ
 
	$ˇn_madv_d⁄äìd_vma
(
vm_¨ó_°ru˘
 *
vma
)

48  !(
vma
->
vm_Êags
 & (
VM_LOCKED
|
VM_HUGETLB
|
VM_PFNMAP
));

49 
	}
}

51 
unm≠_∑ge_ønge
(
mmu_g©hî
 *
éb
,

52 
vm_¨ó_°ru˘
 *
vma
,

53 
addr
, 
íd
,

54 
z≠_dëaûs
 *
dëaûs
);

56 
__do_∑ge_ˇche_ªadahód
(
addªss_•a˚
 *
m≠pög
,

57 
fûe
 *
fûp
, 
pgoff_t
 
off£t
, 
ƒ_to_ªad
,

58 
lookahód_size
);

63 
ölöe
 
	$ø_submô
(
fûe_ø_°©e
 *
ø
,

64 
addªss_•a˚
 *
m≠pög
, 
fûe
 *
fûp
)

66  
	`__do_∑ge_ˇche_ªadahód
(
m≠pög
, 
fûp
,

67 
ø
->
°¨t
,Ña->
size
,Ña->
async_size
);

68 
	}
}

74 
ölöe
 
	$£t_∑ge_ªfcou¡ed
(
∑ge
 *page)

76 
	`VM_BUG_ON_PAGE
(
	`PageTaû
(
∑ge
),Öage);

77 
	`VM_BUG_ON_PAGE
(
	`∑ge_ªf_cou¡
(
∑ge
),Öage);

78 
	`£t_∑ge_cou¡
(
∑ge
, 1);

79 
	}
}

81 
highe°_memm≠_p‚
;

87 
	#MAX_RECLAIM_RETRIES
 16

	)

92 
isﬁ©e_Ãu_∑ge
(
∑ge
 *page);

93 
putback_Ãu_∑ge
(
∑ge
 *page);

98 
pmd_t
 *
mm_föd_pmd
(
mm_°ru˘
 *
mm
, 
addªss
);

117 
	sÆloc_c⁄ãxt
 {

118 
z⁄ñi°
 *
	mz⁄ñi°
;

119 
nodemask_t
 *
	mnodemask
;

120 
z⁄îef
 *
	m¥e„ºed_z⁄îef
;

121 
	mmigøãty≥
;

122 
z⁄e_ty≥
 
	mhigh_z⁄eidx
;

123 
boﬁ
 
	m•ªad_dúty_∑ges
;

126 
	#ac_˛assz⁄e_idx
(
ac
Ë
	`z⁄ñi°_z⁄e_idx
◊c->
¥e„ºed_z⁄îef
)

	)

145 
ölöe
 

146 
	$__föd_buddy_p‚
(
∑ge_p‚
, 
‹dî
)

148  
∑ge_p‚
 ^ (1 << 
‹dî
);

149 
	}
}

151 
∑ge
 *
__∑geblock_p‚_to_∑ge
(
°¨t_p‚
,

152 
íd_p‚
, 
z⁄e
 *zone);

154 
ölöe
 
∑ge
 *
	$∑geblock_p‚_to_∑ge
(
°¨t_p‚
,

155 
íd_p‚
, 
z⁄e
 *zone)

157 i‡(
z⁄e
->
c⁄tiguous
)

158  
	`p‚_to_∑ge
(
°¨t_p‚
);

160  
	`__∑geblock_p‚_to_∑ge
(
°¨t_p‚
, 
íd_p‚
, 
z⁄e
);

161 
	}
}

163 
__isﬁ©e_‰ì_∑ge
(
∑ge
 *∑ge, 
‹dî
);

164 
memblock_‰ì_∑ges
(
∑ge
 *∑ge, 
p‚
,

165 
‹dî
);

166 
__‰ì_∑ges_c‹e
(
∑ge
 *∑ge, 
‹dî
);

167 
¥ï_compound_∑ge
(
∑ge
 *∑ge, 
‹dî
);

168 
po°_Æloc_hook
(
∑ge
 *∑ge, 
‹dî
,

169 
gÂ_t
 
gÂ_Êags
);

170 
u£r_mö_‰ì_kbyãs
;

172 #i‡
deföed
 
CONFIG_COMPACTION
 || deföed 
CONFIG_CMA


184 
	scom∑˘_c⁄åﬁ
 {

185 
li°_hód
 
	m‰ì∑ges
;

186 
li°_hód
 
	mmigøã∑ges
;

187 
	mƒ_‰ì∑ges
;

188 
	mƒ_migøã∑ges
;

189 
	m‰ì_p‚
;

190 
	mmigøã_p‚
;

191 
	mÁ°_°¨t_p‚
;

192 
z⁄e
 *
	mz⁄e
;

193 
	mtŸÆ_migøã_sˇ¬ed
;

194 
	mtŸÆ_‰ì_sˇ¬ed
;

195 
	mÁ°_£¨ch_Áû
;

196 
	m£¨ch_‹dî
;

197 c⁄° 
gÂ_t
 
	mgÂ_mask
;

198 
	m‹dî
;

199 
	mmigøãty≥
;

200 c⁄° 
	mÆloc_Êags
;

201 c⁄° 
	m˛assz⁄e_idx
;

202 
migøã_mode
 
	mmode
;

203 
boﬁ
 
	mign‹e_skù_höt
;

204 
boﬁ
 
	mno_£t_skù_höt
;

205 
boﬁ
 
	mign‹e_block_suôabÀ
;

206 
boﬁ
 
	mdúe˘_com∑˘i⁄
;

207 
boﬁ
 
	mwhﬁe_z⁄e
;

208 
boﬁ
 
	mc⁄ãnded
;

209 
boﬁ
 
	mªsˇn
;

216 
	sˇ±uª_c⁄åﬁ
 {

217 
com∑˘_c⁄åﬁ
 *
	mcc
;

218 
∑ge
 *
	m∑ge
;

222 
isﬁ©e_‰ì∑ges_ønge
(
com∑˘_c⁄åﬁ
 *
cc
,

223 
°¨t_p‚
, 
íd_p‚
);

225 
isﬁ©e_migøã∑ges_ønge
(
com∑˘_c⁄åﬁ
 *
cc
,

226 
low_p‚
, 
íd_p‚
);

227 
föd_suôabÀ_ÁŒback
(
‰ì_¨ó
 *
¨ó
, 
‹dî
,

228 
migøãty≥
, 
boﬁ
 
⁄ly_°óœbÀ
, boﬁ *
ˇn_°ól
);

240 
ölöe
 
	$∑ge_‹dî
(
∑ge
 *page)

243  
	`∑ge_¥iv©e
(
∑ge
);

244 
	}
}

257 
	#∑ge_‹dî_unß„
(
∑ge
Ë
	`READ_ONCE
(
	`∑ge_¥iv©e
’age))

	)

259 
ölöe
 
boﬁ
 
	$is_cow_m≠pög
(
vm_Êags_t
 
Êags
)

261  (
Êags
 & (
VM_SHARED
 | 
VM_MAYWRITE
)) == VM_MAYWRITE;

262 
	}
}

271 
ölöe
 
boﬁ
 
	$is_exec_m≠pög
(
vm_Êags_t
 
Êags
)

273  (
Êags
 & (
VM_EXEC
 | 
VM_WRITE
 | 
VM_STACK
)) == VM_EXEC;

274 
	}
}

282 
ölöe
 
boﬁ
 
	$is_°ack_m≠pög
(
vm_Êags_t
 
Êags
)

284  (
Êags
 & 
VM_STACK
) == VM_STACK;

285 
	}
}

290 
ölöe
 
boﬁ
 
	$is_d©a_m≠pög
(
vm_Êags_t
 
Êags
)

292  (
Êags
 & (
VM_WRITE
 | 
VM_SHARED
 | 
VM_STACK
)) == VM_WRITE;

293 
	}
}

296 
__vma_lök_li°
(
mm_°ru˘
 *
mm
, 
vm_¨ó_°ru˘
 *
vma
,

297 
vm_¨ó_°ru˘
 *
¥ev
, 
rb_node
 *
rb_∑ª¡
);

299 #ifde‡
CONFIG_MMU


300 
p›uœã_vma_∑ge_ønge
(
vm_¨ó_°ru˘
 *
vma
,

301 
°¨t
, 
íd
, *
n⁄blockög
);

302 
mu∆ock_vma_∑ges_ønge
(
vm_¨ó_°ru˘
 *
vma
,

303 
°¨t
, 
íd
);

304 
ölöe
 
	$mu∆ock_vma_∑ges_Æl
(
vm_¨ó_°ru˘
 *
vma
)

306 
	`mu∆ock_vma_∑ges_ønge
(
vma
, vma->
vm_°¨t
, vma->
vm_íd
);

307 
	}
}

312 
mlock_vma_∑ge
(
∑ge
 *page);

313 
mu∆ock_vma_∑ge
(
∑ge
 *page);

324 
˛ór_∑ge_mlock
(
∑ge
 *page);

331 
ölöe
 
	$mlock_migøã_∑ge
(
∑ge
 *
√w∑ge
, page *page)

333 i‡(
	`Te°CÀ¨PageMlocked
(
∑ge
)) {

334 
ƒ_∑ges
 = 
	`h∑ge_ƒ_∑ges
(
∑ge
);

337 
	`__mod_z⁄e_∑ge_°©e
(
	`∑ge_z⁄e
(
∑ge
), 
NR_MLOCK
, -
ƒ_∑ges
);

338 
	`SëPageMlocked
(
√w∑ge
);

339 
	`__mod_z⁄e_∑ge_°©e
(
	`∑ge_z⁄e
(
√w∑ge
), 
NR_MLOCK
, 
ƒ_∑ges
);

341 
	}
}

343 
pmd_t
 
maybe_pmd_mkwrôe
’md_à
pmd
, 
vm_¨ó_°ru˘
 *
vma
);

348 
ölöe
 

349 
	$__vma_addªss
(
∑ge
 *∑ge, 
vm_¨ó_°ru˘
 *
vma
)

351 
pgoff_t
 
pgoff
 = 
	`∑ge_to_pgoff
(
∑ge
);

352  
vma
->
vm_°¨t
 + ((
pgoff
 - vma->
vm_pgoff
Ë<< 
PAGE_SHIFT
);

353 
	}
}

355 
ölöe
 

356 
	$vma_addªss
(
∑ge
 *∑ge, 
vm_¨ó_°ru˘
 *
vma
)

358 
°¨t
, 
íd
;

360 
°¨t
 = 
	`__vma_addªss
(
∑ge
, 
vma
);

361 
íd
 = 
°¨t
 + 
PAGE_SIZE
 * (
	`h∑ge_ƒ_∑ges
(
∑ge
) - 1);

364 
	`VM_BUG_ON_VMA
(
íd
 < 
vma
->
vm_°¨t
 || 
°¨t
 >vma->
vm_íd
, vma);

366  
	`max
(
°¨t
, 
vma
->
vm_°¨t
);

367 
	}
}

370 
ölöe
 
	$˛ór_∑ge_mlock
(
∑ge
 *∑geË{ 
	}
}

371 
ölöe
 
	$mlock_vma_∑ge
(
∑ge
 *∑geË{ 
	}
}

372 
ölöe
 
	$mlock_migøã_∑ge
(
∑ge
 *
√w
, ∑gê*
ﬁd
Ë{ 
	}
}

381 
ölöe
 
∑ge
 *
	$mem_m≠_off£t
(
∑ge
 *
ba£
, 
off£t
)

383 i‡(
	`u∆ikñy
(
off£t
 >
MAX_ORDER_NR_PAGES
))

384  
	`¡h_∑ge
(
ba£
, 
off£t
);

385  
ba£
 + 
off£t
;

386 
	}
}

392 
ölöe
 
∑ge
 *
	$mem_m≠_√xt
(
∑ge
 *
ôî
,

393 
∑ge
 *
ba£
, 
off£t
)

395 i‡(
	`u∆ikñy
((
off£t
 & (
MAX_ORDER_NR_PAGES
 - 1)) == 0)) {

396 
p‚
 = 
	`∑ge_to_p‚
(
ba£
Ë+ 
off£t
;

397 i‡(!
	`p‚_vÆid
(
p‚
))

398  
NULL
;

399  
	`p‚_to_∑ge
(
p‚
);

401  
ôî
 + 1;

402 
	}
}

405 
	emmöô_Àvñ
 {

406 
	mMMINIT_WARNING
,

407 
	mMMINIT_VERIFY
,

408 
	mMMINIT_TRACE


411 #ifde‡
CONFIG_DEBUG_MEMORY_INIT


413 
mmöô_logÀvñ
;

415 
	#mmöô_d¥ötk
(
Àvñ
, 
¥efix
, 
fmt
, 
¨g
...) \

417 i‡(
Àvñ
 < 
mmöô_logÀvñ
) { \

418 i‡(
Àvñ
 <
MMINIT_WARNING
) \

419 
	`¥_w¨n
("mmöô::" 
¥efix
 " " 
fmt
, ##
¨g
); \

421 
	`¥ötk
(
KERN_DEBUG
 "mmöô::" 
¥efix
 " " 
fmt
, ##
¨g
); \

423 } 0)

	)

425 
mmöô_vîify_∑geÊags_œyout
();

426 
mmöô_vîify_z⁄ñi°
();

429 
ölöe
 
	$mmöô_d¥ötk
(
mmöô_Àvñ
 
Àvñ
,

430 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

432 
	}
}

434 
ölöe
 
	$mmöô_vîify_∑geÊags_œyout
()

436 
	}
}

438 
ölöe
 
	$mmöô_vîify_z⁄ñi°
()

440 
	}
}

444 #i‡
deföed
(
CONFIG_SPARSEMEM
)

445 
mmöô_vÆid©e_memmodñ_limôs
(*
°¨t_p‚
,

446 *
íd_p‚
);

448 
ölöe
 
	$mmöô_vÆid©e_memmodñ_limôs
(*
°¨t_p‚
,

449 *
íd_p‚
)

451 
	}
}

454 
	#NODE_RECLAIM_NOSCAN
 -2

	)

455 
	#NODE_RECLAIM_FULL
 -1

	)

456 
	#NODE_RECLAIM_SOME
 0

	)

457 
	#NODE_RECLAIM_SUCCESS
 1

	)

459 #ifde‡
CONFIG_NUMA


460 
node_ª˛aim
(
pgli°_d©a
 *, 
gÂ_t
, );

462 
ölöe
 
	$node_ª˛aim
(
pgli°_d©a
 *
pgd©
, 
gÂ_t
 
mask
,

463 
‹dî
)

465  
NODE_RECLAIM_NOSCAN
;

466 
	}
}

469 
hwpois⁄_fûãr
(
∑ge
 *
p
);

471 
u32
 
hwpois⁄_fûãr_dev_maj‹
;

472 
u32
 
hwpois⁄_fûãr_dev_mö‹
;

473 
u64
 
hwpois⁄_fûãr_Êags_mask
;

474 
u64
 
hwpois⁄_fûãr_Êags_vÆue
;

475 
u64
 
hwpois⁄_fûãr_memcg
;

476 
u32
 
hwpois⁄_fûãr_íabÀ
;

478 
__mu°_check
 
vm_mm≠_pgoff
(
fûe
 *, ,

482 
£t_∑geblock_‹dî
();

483 
ª˛aim_˛ón_∑ges_‰om_li°
(
z⁄e
 *zone,

484 
li°_hód
 *
∑ge_li°
);

486 
	#ALLOC_WMARK_MIN
 
WMARK_MIN


	)

487 
	#ALLOC_WMARK_LOW
 
WMARK_LOW


	)

488 
	#ALLOC_WMARK_HIGH
 
WMARK_HIGH


	)

489 
	#ALLOC_NO_WATERMARKS
 0x04

	)

492 
	#ALLOC_WMARK_MASK
 (
ALLOC_NO_WATERMARKS
-1)

	)

499 #ifde‡
CONFIG_MMU


500 
	#ALLOC_OOM
 0x08

	)

502 
	#ALLOC_OOM
 
ALLOC_NO_WATERMARKS


	)

505 
	#ALLOC_HARDER
 0x10

	)

506 
	#ALLOC_HIGH
 0x20

	)

507 
	#ALLOC_CPUSET
 0x40

	)

508 
	#ALLOC_CMA
 0x80

	)

509 #ifde‡
CONFIG_ZONE_DMA32


510 
	#ALLOC_NOFRAGMENT
 0x100

	)

512 
	#ALLOC_NOFRAGMENT
 0x0

	)

514 
	#ALLOC_KSWAPD
 0x200

	)

516 
	gâu_Êags
;

517 
	gébÊush_unm≠_b©ch
;

524 
w‹kqueue_°ru˘
 *
mm_≥r˝u_wq
;

526 #ifde‡
CONFIG_ARCH_WANT_BATCHED_UNMAP_TLB_FLUSH


527 
åy_to_unm≠_Êush
();

528 
åy_to_unm≠_Êush_dúty
();

529 
Êush_éb_b©ched_≥ndög
(
mm_°ru˘
 *
mm
);

531 
ölöe
 
	$åy_to_unm≠_Êush
()

533 
	}
}

534 
ölöe
 
	$åy_to_unm≠_Êush_dúty
()

536 
	}
}

537 
ölöe
 
	$Êush_éb_b©ched_≥ndög
(
mm_°ru˘
 *
mm
)

539 
	}
}

542 c⁄° 
åa˚_¥öt_Êags
 
∑geÊag_«mes
[];

543 c⁄° 
åa˚_¥öt_Êags
 
vmaÊag_«mes
[];

544 c⁄° 
åa˚_¥öt_Êags
 
gÂÊag_«mes
[];

546 
ölöe
 
boﬁ
 
	$is_migøã_high©omic
(
migøãty≥
 migratetype)

548  
migøãty≥
 =
MIGRATE_HIGHATOMIC
;

549 
	}
}

551 
ölöe
 
boﬁ
 
	$is_migøã_high©omic_∑ge
(
∑ge
 *page)

553  
	`gë_∑geblock_migøãty≥
(
∑ge
Ë=
MIGRATE_HIGHATOMIC
;

554 
	}
}

556 
£tup_z⁄e_∑ge£t
(
z⁄e
 *zone);

557 
∑ge
 *
Æloc_√w_node_∑ge
(∑gê*∑ge, 
node
);

	@ioctl.c

11 
	~<löux/fs.h
>

12 
	~<löux/ˇ∑bûôy.h
>

13 
	~<löux/time.h
>

14 
	~<löux/com∑t.h
>

15 
	~<löux/mou¡.h
>

16 
	~<löux/fûe.h
>

17 
	~<löux/quŸa›s.h
>

18 
	~<löux/øndom.h
>

19 
	~<löux/uuid.h
>

20 
	~<löux/uac˚ss.h
>

21 
	~<löux/dñay.h
>

22 
	~<löux/ivîsi⁄.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

25 
	~<löux/fsm≠.h
>

26 
	~"fsm≠.h
"

27 
	~<åa˚/evíts/pxt4.h
>

37 
	$memsw≠
(*
a
, *
b
, 
size_t
 
Àn
)

39 *
≠
, *
bp
;

41 
≠
 = (*)
a
;

42 
bp
 = (*)
b
;

43 
Àn
-- > 0) {

44 
	`sw≠
(*
≠
, *
bp
);

45 
≠
++;

46 
bp
++;

48 
	}
}

61 
	$sw≠_öode_d©a
(
öode
 *
öode1
, öodê*
öode2
)

63 
loff_t
 
isize
;

64 
pxt4_öode_öfo
 *
ei1
;

65 
pxt4_öode_öfo
 *
ei2
;

66 
tmp
;

68 
ei1
 = 
	`PXT4_I
(
öode1
);

69 
ei2
 = 
	`PXT4_I
(
öode2
);

71 
	`sw≠
(
öode1
->
i_vîsi⁄
, 
öode2
->i_version);

72 
	`sw≠
(
öode1
->
i_©ime
, 
öode2
->i_atime);

73 
	`sw≠
(
öode1
->
i_mtime
, 
öode2
->i_mtime);

75 
	`memsw≠
(
ei1
->
i_d©a
, 
ei2
->i_data, (ei1->i_data));

76 
tmp
 = 
ei1
->
i_Êags
 & 
PXT4_FL_SHOULD_SWAP
;

77 
ei1
->
i_Êags
 = (
ei2
->i_Êag†& 
PXT4_FL_SHOULD_SWAP
) |

78 (
ei1
->
i_Êags
 & ~
PXT4_FL_SHOULD_SWAP
);

79 
ei2
->
i_Êags
 = 
tmp
 | (ei2->i_Êag†& ~
PXT4_FL_SHOULD_SWAP
);

80 
	`sw≠
(
ei1
->
i_disksize
, 
ei2
->i_disksize);

81 
	`pxt4_es_ªmove_exã¡
(
öode1
, 0, 
EXT_MAX_BLOCKS
);

82 
	`pxt4_es_ªmove_exã¡
(
öode2
, 0, 
EXT_MAX_BLOCKS
);

84 
isize
 = 
	`i_size_ªad
(
öode1
);

85 
	`i_size_wrôe
(
öode1
, 
	`i_size_ªad
(
öode2
));

86 
	`i_size_wrôe
(
öode2
, 
isize
);

87 
	}
}

89 
	$ª£t_öode_£ed
(
öode
 *inode)

91 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

92 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

93 
__À32
 
öum
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

94 
__À32
 
gí
 = 
	`˝u_to_À32
(
öode
->
i_gíî©i⁄
);

95 
__u32
 
csum
;

97 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

100 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
öum
, (inum));

101 
ei
->
i_csum_£ed
 = 
	`pxt4_chksum
(
sbi
, 
csum
, (
__u8
 *)&
gí
, (gen));

102 
	}
}

113 
	$sw≠_öode_boŸ_lﬂdî
(
su≥r_block
 *
sb
,

114 
öode
 *inode)

116 
h™dÀ_t
 *
h™dÀ
;

117 
îr
;

118 
öode
 *
öode_bl
;

119 
pxt4_öode_öfo
 *
ei_bl
;

120 
qsize_t
 
size
, 
size_bl
, 
diff
;

121 
blk˙t_t
 
blocks
;

122 
byãs
;

124 
öode_bl
 = 
	`pxt4_igë
(
sb
, 
PXT4_BOOT_LOADER_INO
, 
PXT4_IGET_SPECIAL
);

125 i‡(
	`IS_ERR
(
öode_bl
))

126  
	`PTR_ERR
(
öode_bl
);

127 
ei_bl
 = 
	`PXT4_I
(
öode_bl
);

131 
	`lock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

133 i‡(
öode
->
i_∆ök
 !1 || !
	`S_ISREG
(öode->
i_mode
) ||

134 
	`IS_SWAPFILE
(
öode
Ë|| 
	`IS_ENCRYPTED
(inode) ||

135 (
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_JOURNAL_DATA_FL
) ||

136 
	`pxt4_has_ölöe_d©a
(
öode
)) {

137 
îr
 = -
EINVAL
;

138 
jou∫Æ_îr_out
;

141 i‡(
	`IS_RDONLY
(
öode
Ë|| 
	`IS_APPEND
(öodeË|| 
	`IS_IMMUTABLE
(inode) ||

142 !
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
Ë|| !
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
)) {

143 
îr
 = -
EPERM
;

144 
jou∫Æ_îr_out
;

147 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

148 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode
->
i_m≠pög
);

149 i‡(
îr
)

150 
îr_out
;

152 
îr
 = 
	`fûem≠_wrôe_™d_waô
(
öode_bl
->
i_m≠pög
);

153 i‡(
îr
)

154 
îr_out
;

157 
	`öode_dio_waô
(
öode
);

158 
	`öode_dio_waô
(
öode_bl
);

160 
	`åunˇã_öode_∑ges
(&
öode
->
i_d©a
, 0);

161 
	`åunˇã_öode_∑ges
(&
öode_bl
->
i_d©a
, 0);

163 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode_bl
, 
PXT4_HT_MOVE_EXTENTS
, 2);

164 i‡(
	`IS_ERR
(
h™dÀ
)) {

165 
îr
 = -
EINVAL
;

166 
îr_out
;

170 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
, 
öode_bl
);

172 i‡(
öode_bl
->
i_∆ök
 == 0) {

174 
	`£t_∆ök
(
öode_bl
, 1);

175 
	`i_uid_wrôe
(
öode_bl
, 0);

176 
	`i_gid_wrôe
(
öode_bl
, 0);

177 
öode_bl
->
i_Êags
 = 0;

178 
ei_bl
->
i_Êags
 = 0;

179 
	`öode_£t_ivîsi⁄
(
öode_bl
, 1);

180 
	`i_size_wrôe
(
öode_bl
, 0);

181 
öode_bl
->
i_mode
 = 
S_IFREG
;

182 i‡(
	`pxt4_has_„©uª_exã¡s
(
sb
)) {

183 
	`pxt4_£t_öode_Êag
(
öode_bl
, 
PXT4_INODE_EXTENTS
);

184 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
öode_bl
);

186 
	`mem£t
(
ei_bl
->
i_d©a
, 0, (ei_bl->i_data));

189 
îr
 = 
	`dquŸ_öôülize
(
öode
);

190 i‡(
îr
)

191 
îr_out1
;

193 
size
 = (
qsize_t
)(
öode
->
i_blocks
Ë* (1 << 9Ë+ inode->
i_byãs
;

194 
size_bl
 = (
qsize_t
)(
öode_bl
->
i_blocks
Ë* (1 << 9Ë+ inode_bl->
i_byãs
;

195 
diff
 = 
size
 - 
size_bl
;

196 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

198 
öode
->
i_˘ime
 = 
öode_bl
->i_˘imê
	`cuºít_time
(inode);

200 
öode
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

201 
öode_bl
->
i_gíî©i⁄
 = 
	`¥™dom_u32
();

202 
	`ª£t_öode_£ed
(
öode
);

203 
	`ª£t_öode_£ed
(
öode_bl
);

205 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

207 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

208 i‡(
îr
 < 0) {

210 
	`pxt4_w¨nög
(
öode
->
i_sb
,

212 
öode
->
i_öo
, 
îr
);

214 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

215 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

216 
îr_out1
;

219 
blocks
 = 
öode_bl
->
i_blocks
;

220 
byãs
 = 
öode_bl
->
i_byãs
;

221 
öode_bl
->
i_blocks
 = 
öode
->i_blocks;

222 
öode_bl
->
i_byãs
 = 
öode
->i_bytes;

223 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

224 i‡(
îr
 < 0) {

226 
	`pxt4_w¨nög
(
öode_bl
->
i_sb
,

228 
öode_bl
->
i_öo
, 
îr
);

229 
ªvît
;

233 i‡(
diff
 > 0)

234 
	`dquŸ_‰ì_•a˚
(
öode
, 
diff
);

236 
îr
 = 
	`dquŸ_Æloc_•a˚
(
öode
, -1 * 
diff
);

238 i‡(
îr
 < 0) {

239 
ªvît
:

241 
öode_bl
->
i_blocks
 = 
blocks
;

242 
öode_bl
->
i_byãs
 = 
byãs
;

243 
	`sw≠_öode_d©a
(
öode
, 
öode_bl
);

244 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

245 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode_bl
);

248 
îr_out1
:

249 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

250 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
, 
öode_bl
);

252 
îr_out
:

253 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

254 
jou∫Æ_îr_out
:

255 
	`u∆ock_two_n⁄dúe˘‹õs
(
öode
, 
öode_bl
);

256 
	`ùut
(
öode_bl
);

257  
îr
;

258 
	}
}

260 #ifde‡
CONFIG_FS_ENCRYPTION


261 
	$uuid_is_zîo
(
__u8
 
u
[16])

263 
i
;

265 
i
 = 0; i < 16; i++)

266 i‡(
u
[
i
])

269 
	}
}

272 
	$pxt4_io˘l_£tÊags
(
öode
 *inode,

273 
Êags
)

275 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

276 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

277 
îr
 = -
EPERM
, 
migøã
 = 0;

278 
pxt4_ûoc
 
ûoc
;

279 
ﬁdÊags
, 
mask
, 
i
;

280 
jÊag
;

283 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

284 
Êags_out
;

286 
ﬁdÊags
 = 
ei
->
i_Êags
;

289 
jÊag
 = 
Êags
 & 
PXT4_JOURNAL_DATA_FL
;

297 i‡((
Êags
 ^ 
ﬁdÊags
Ë& (
PXT4_APPEND_FL
 | 
PXT4_IMMUTABLE_FL
)) {

298 i‡(!
	`ˇ∑bÀ
(
CAP_LINUX_IMMUTABLE
))

299 
Êags_out
;

306 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

307 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

308 
Êags_out
;

310 i‡((
Êags
 ^ 
ﬁdÊags
Ë& 
PXT4_EXTENTS_FL
)

311 
migøã
 = 1;

313 i‡(
Êags
 & 
PXT4_EOFBLOCKS_FL
) {

315 i‡(!(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
)) {

316 
îr
 = -
EOPNOTSUPP
;

317 
Êags_out
;

319 } i‡(
ﬁdÊags
 & 
PXT4_EOFBLOCKS_FL
) {

320 
îr
 = 
	`pxt4_åunˇã
(
öode
);

321 i‡(
îr
)

322 
Êags_out
;

325 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

326 i‡(
	`IS_ERR
(
h™dÀ
)) {

327 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

328 
Êags_out
;

330 i‡(
	`IS_SYNC
(
öode
))

331 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

332 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

333 i‡(
îr
)

334 
Êags_îr
;

336 
i
 = 0, 
mask
 = 1; i < 32; i++, mask <<= 1) {

337 i‡(!(
mask
 & 
PXT4_FL_USER_MODIFIABLE
))

340 i‡(
mask
 =
PXT4_JOURNAL_DATA_FL
 || mask =
PXT4_EXTENTS_FL
)

342 i‡(
mask
 & 
Êags
)

343 
	`pxt4_£t_öode_Êag
(
öode
, 
i
);

345 
	`pxt4_˛ór_öode_Êag
(
öode
, 
i
);

348 
	`pxt4_£t_öode_Êags
(
öode
);

349 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

351 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

352 
Êags_îr
:

353 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

354 i‡(
îr
)

355 
Êags_out
;

357 i‡((
jÊag
 ^ 
ﬁdÊags
Ë& (
PXT4_JOURNAL_DATA_FL
)) {

362 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DAX
)) {

363 
îr
 = -
EBUSY
;

364 
Êags_out
;

367 
îr
 = 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
, 
jÊag
);

368 i‡(
îr
)

369 
Êags_out
;

371 i‡(
migøã
) {

372 i‡(
Êags
 & 
PXT4_EXTENTS_FL
)

373 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

375 
îr
 = 
	`pxt4_öd_migøã
(
öode
);

378 
Êags_out
:

379  
îr
;

380 
	}
}

382 #ifde‡
CONFIG_QUOTA


383 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

385 
öode
 *öodê
	`fûe_öode
(
fûp
);

386 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

387 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

388 
îr
, 
rc
;

389 
h™dÀ_t
 *
h™dÀ
;

390 
k¥ojid_t
 
k¥ojid
;

391 
pxt4_ûoc
 
ûoc
;

392 
pxt4_öode
 *
øw_öode
;

393 
dquŸ
 *
å™s„r_to
[
MAXQUOTAS
] = { };

395 i‡(!
	`pxt4_has_„©uª_¥oje˘
(
sb
)) {

396 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

397  -
EOPNOTSUPP
;

402 i‡(
	`PXT4_INODE_SIZE
(
sb
Ë<
PXT4_GOOD_OLD_INODE_SIZE
)

403  -
EOPNOTSUPP
;

405 
k¥ojid
 = 
	`make_k¥ojid
(&
öô_u£r_ns
, (
¥ojid_t
)
¥ojid
);

407 i‡(
	`¥ojid_eq
(
k¥ojid
, 
	`PXT4_I
(
öode
)->
i_¥ojid
))

410 
îr
 = -
EPERM
;

412 i‡(
	`pxt4_is_quŸa_fûe
(
öode
))

413  
îr
;

415 
îr
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

416 i‡(
îr
)

417  
îr
;

419 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

420 i‡(!
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
ei
, 
i_¥ojid
)) {

421 
îr
 = 
	`pxt4_ex∑nd_exåa_isize
(
öode
,

422 
	`PXT4_SB
(
sb
)->
s_w™t_exåa_isize
,

423 &
ûoc
);

424 i‡(
îr
)

425  
îr
;

427 
	`bªl£
(
ûoc
.
bh
);

430 
îr
 = 
	`dquŸ_öôülize
(
öode
);

431 i‡(
îr
)

432  
îr
;

434 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

435 
	`PXT4_QUOTA_INIT_BLOCKS
(
sb
) +

436 
	`PXT4_QUOTA_DEL_BLOCKS
(
sb
) + 3);

437 i‡(
	`IS_ERR
(
h™dÀ
))

438  
	`PTR_ERR
(
h™dÀ
);

440 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

441 i‡(
îr
)

442 
out_°›
;

444 
å™s„r_to
[
PRJQUOTA
] = 
	`dqgë
(
sb
, 
	`make_kqid_¥ojid
(
k¥ojid
));

445 i‡(!
	`IS_ERR
(
å™s„r_to
[
PRJQUOTA
])) {

450 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

451 
îr
 = 
	`__dquŸ_å™s„r
(
öode
, 
å™s„r_to
);

452 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

453 
	`dqput
(
å™s„r_to
[
PRJQUOTA
]);

454 i‡(
îr
)

455 
out_dúty
;

458 
	`PXT4_I
(
öode
)->
i_¥ojid
 = 
k¥ojid
;

459 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

460 
out_dúty
:

461 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

462 i‡(!
îr
)

463 
îr
 = 
rc
;

464 
out_°›
:

465 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

466  
îr
;

467 
	}
}

469 
	$pxt4_io˘l_£çroje˘
(
fûe
 *
fûp
, 
__u32
 
¥ojid
)

471 i‡(
¥ojid
 !
PXT4_DEF_PROJID
)

472  -
EOPNOTSUPP
;

474 
	}
}

478 
ölöe
 
__u32
 
	$pxt4_iÊags_to_xÊags
(
iÊags
)

480 
__u32
 
xÊags
 = 0;

482 i‡(
iÊags
 & 
PXT4_SYNC_FL
)

483 
xÊags
 |
FS_XFLAG_SYNC
;

484 i‡(
iÊags
 & 
PXT4_IMMUTABLE_FL
)

485 
xÊags
 |
FS_XFLAG_IMMUTABLE
;

486 i‡(
iÊags
 & 
PXT4_APPEND_FL
)

487 
xÊags
 |
FS_XFLAG_APPEND
;

488 i‡(
iÊags
 & 
PXT4_NODUMP_FL
)

489 
xÊags
 |
FS_XFLAG_NODUMP
;

490 i‡(
iÊags
 & 
PXT4_NOATIME_FL
)

491 
xÊags
 |
FS_XFLAG_NOATIME
;

492 i‡(
iÊags
 & 
PXT4_PROJINHERIT_FL
)

493 
xÊags
 |
FS_XFLAG_PROJINHERIT
;

494  
xÊags
;

495 
	}
}

497 
	#PXT4_SUPPORTED_FS_XFLAGS
 (
FS_XFLAG_SYNC
 | 
FS_XFLAG_IMMUTABLE
 | \

498 
FS_XFLAG_APPEND
 | 
FS_XFLAG_NODUMP
 | \

499 
FS_XFLAG_NOATIME
 | 
FS_XFLAG_PROJINHERIT
)

	)

502 
ölöe
 
	$pxt4_xÊags_to_iÊags
(
__u32
 
xÊags
)

504 
iÊags
 = 0;

506 i‡(
xÊags
 & 
FS_XFLAG_SYNC
)

507 
iÊags
 |
PXT4_SYNC_FL
;

508 i‡(
xÊags
 & 
FS_XFLAG_IMMUTABLE
)

509 
iÊags
 |
PXT4_IMMUTABLE_FL
;

510 i‡(
xÊags
 & 
FS_XFLAG_APPEND
)

511 
iÊags
 |
PXT4_APPEND_FL
;

512 i‡(
xÊags
 & 
FS_XFLAG_NODUMP
)

513 
iÊags
 |
PXT4_NODUMP_FL
;

514 i‡(
xÊags
 & 
FS_XFLAG_NOATIME
)

515 
iÊags
 |
PXT4_NOATIME_FL
;

516 i‡(
xÊags
 & 
FS_XFLAG_PROJINHERIT
)

517 
iÊags
 |
PXT4_PROJINHERIT_FL
;

519  
iÊags
;

520 
	}
}

522 
	$pxt4_shutdown
(
su≥r_block
 *
sb
, 
¨g
)

524 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

525 
__u32
 
Êags
;

527 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

528  -
EPERM
;

530 i‡(
	`gë_u£r
(
Êags
, (
__u32
 
__u£r
 *)
¨g
))

531  -
EFAULT
;

533 i‡(
Êags
 > 
PXT4_GOING_FLAGS_NOLOGFLUSH
)

534  -
EINVAL
;

536 i‡(
	`pxt4_f‹˚d_shutdown
(
sbi
))

539 
	`pxt4_msg
(
sb
, 
KERN_ALERT
, "shuàdow¿ªque°ed (%d)", 
Êags
);

540 
	`åa˚_pxt4_shutdown
(
sb
, 
Êags
);

542 
Êags
) {

543 
PXT4_GOING_FLAGS_DEFAULT
:

544 
	`‰ìze_bdev
(
sb
->
s_bdev
);

545 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

546 
	`thaw_bdev
(
sb
->
s_bdev
, sb);

548 
PXT4_GOING_FLAGS_LOGFLUSH
:

549 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

550 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal)) {

551 (Ë
	`pxt4_f‹˚_commô
(
sb
);

552 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

555 
PXT4_GOING_FLAGS_NOLOGFLUSH
:

556 
	`£t_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

557 i‡(
sbi
->
s_jou∫Æ
 && !
	`is_jou∫Æ_ab‹ãd
(sbi->s_journal))

558 
	`jbd3_jou∫Æ_ab‹t
(
sbi
->
s_jou∫Æ
, -
ESHUTDOWN
);

561  -
EINVAL
;

563 
	`˛ór_›t
(
sb
, 
DISCARD
);

565 
	}
}

567 
	sgëfsm≠_öfo
 {

568 
su≥r_block
 *
	mgi_sb
;

569 
fsm≠_hód
 
__u£r
 *
	mgi_d©a
;

570 
	mgi_idx
;

571 
__u32
 
	mgi_œ°_Êags
;

574 
	$pxt4_gëfsm≠_f‹m©
(
pxt4_fsm≠
 *
xfm
, *
¥iv
)

576 
gëfsm≠_öfo
 *
öfo
 = 
¥iv
;

577 
fsm≠
 
fm
;

579 
	`åa˚_pxt4_gëfsm≠_m≠pög
(
öfo
->
gi_sb
, 
xfm
);

581 
öfo
->
gi_œ°_Êags
 = 
xfm
->
fmr_Êags
;

582 
	`pxt4_fsm≠_‰om_öã∫Æ
(
öfo
->
gi_sb
, &
fm
, 
xfm
);

583 i‡(
	`c›y_to_u£r
(&
öfo
->
gi_d©a
->
fmh_ªcs
[öfo->
gi_idx
++], &
fm
,

584 (
fsm≠
)))

585  -
EFAULT
;

588 
	}
}

590 
	$pxt4_ioc_gëfsm≠
(
su≥r_block
 *
sb
,

591 
fsm≠_hód
 
__u£r
 *
¨g
)

593 
gëfsm≠_öfo
 
öfo
 = {0};

594 
pxt4_fsm≠_hód
 
xhód
 = {0};

595 
fsm≠_hód
 
hód
;

596 
boﬁ
 
ab‹ãd
 = 
Ál£
;

597 
îr‹
;

599 i‡(
	`c›y_‰om_u£r
(&
hód
, 
¨g
, (
fsm≠_hód
)))

600  -
EFAULT
;

601 i‡(
	`memchr_öv
(
hód
.
fmh_ª£rved
, 0, (head.fmh_reserved)) ||

602 
	`memchr_öv
(
hód
.
fmh_keys
[0].
fmr_ª£rved
, 0,

603 (
hód
.
fmh_keys
[0].
fmr_ª£rved
)) ||

604 
	`memchr_öv
(
hód
.
fmh_keys
[1].
fmr_ª£rved
, 0,

605 (
hód
.
fmh_keys
[1].
fmr_ª£rved
)))

606  -
EINVAL
;

611 i‡(
hód
.
fmh_keys
[0].
fmr_off£t
 ||

612 (
hód
.
fmh_keys
[1].
fmr_off£t
 != 0 &&

613 
hód
.
fmh_keys
[1].
fmr_off£t
 != -1ULL))

614  -
EINVAL
;

616 
xhód
.
fmh_iÊags
 = 
hód
.fmh_iflags;

617 
xhód
.
fmh_cou¡
 = 
hód
.fmh_count;

618 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[0], &
hód
.fmh_keys[0]);

619 
	`pxt4_fsm≠_to_öã∫Æ
(
sb
, &
xhód
.
fmh_keys
[1], &
hód
.fmh_keys[1]);

621 
	`åa˚_pxt4_gëfsm≠_low_key
(
sb
, &
xhód
.
fmh_keys
[0]);

622 
	`åa˚_pxt4_gëfsm≠_high_key
(
sb
, &
xhód
.
fmh_keys
[1]);

624 
öfo
.
gi_sb
 = 
sb
;

625 
öfo
.
gi_d©a
 = 
¨g
;

626 
îr‹
 = 
	`pxt4_gëfsm≠
(
sb
, &
xhód
, 
pxt4_gëfsm≠_f‹m©
, &
öfo
);

627 i‡(
îr‹
 =
PXT4_QUERY_RANGE_ABORT
) {

628 
îr‹
 = 0;

629 
ab‹ãd
 = 
åue
;

630 } i‡(
îr‹
)

631  
îr‹
;

634 i‡(!
ab‹ãd
 && 
öfo
.
gi_idx
) {

635 
öfo
.
gi_œ°_Êags
 |
FMR_OF_LAST
;

636 i‡(
	`c›y_to_u£r
(&
öfo
.
gi_d©a
->
fmh_ªcs
[öfo.
gi_idx
 - 1].
fmr_Êags
,

637 &
öfo
.
gi_œ°_Êags
,

638 (
öfo
.
gi_œ°_Êags
)))

639  -
EFAULT
;

643 
hód
.
fmh_íåõs
 = 
xhód
.fmh_entries;

644 
hód
.
fmh_oÊags
 = 
xhód
.fmh_oflags;

645 i‡(
	`c›y_to_u£r
(
¨g
, &
hód
, (
fsm≠_hód
)))

646  -
EFAULT
;

649 
	}
}

651 
	$pxt4_io˘l_group_add
(
fûe
 *file,

652 
pxt4_√w_group_d©a
 *
öput
)

654 
su≥r_block
 *
sb
 = 
	`fûe_öode
(
fûe
)->
i_sb
;

655 
îr
, 
îr2
=0;

657 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

658 i‡(
îr
)

659  
îr
;

661 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

662 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

664 
îr
 = -
EOPNOTSUPP
;

665 
group_add_out
;

668 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûe
);

669 i‡(
îr
)

670 
group_add_out
;

672 
îr
 = 
	`pxt4_group_add
(
sb
, 
öput
);

673 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

674 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

675 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

676 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

678 i‡(
îr
 == 0)

679 
îr
 = 
îr2
;

680 
	`m¡_dr›_wrôe_fûe
(
fûe
);

681 i‡(!
îr
 && 
	`pxt4_has_group_desc_csum
(
sb
) &&

682 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

683 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
öput
->
group
);

684 
group_add_out
:

685 
	`pxt4_ªsize_íd
(
sb
);

686  
îr
;

687 
	}
}

689 
	$pxt4_io˘l_check_¥oje˘
(
öode
 *öode, 
fsx©å
 *
Á
)

696 i‡(
	`cuºít_u£r_ns
(Ë=&
öô_u£r_ns
)

699 i‡(
	`__k¥ojid_vÆ
(
	`PXT4_I
(
öode
)->
i_¥ojid
Ë!
Á
->
fsx_¥ojid
)

700  -
EINVAL
;

702 i‡(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_PROJINHERIT
)) {

703 i‡(!(
Á
->
fsx_xÊags
 & 
FS_XFLAG_PROJINHERIT
))

704  -
EINVAL
;

706 i‡(
Á
->
fsx_xÊags
 & 
FS_XFLAG_PROJINHERIT
)

707  -
EINVAL
;

711 
	}
}

713 
	$pxt4_io˘l
(
fûe
 *
fûp
, 
cmd
, 
¨g
)

715 
öode
 *öodê
	`fûe_öode
(
fûp
);

716 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

717 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

718 
Êags
;

720 
	`pxt4_debug
("cmd = %u,árg = %lu\n", 
cmd
, 
¨g
);

722 
cmd
) {

723 
FS_IOC_GETFSMAP
:

724  
	`pxt4_ioc_gëfsm≠
(
sb
, (
__u£r
 *)
¨g
);

725 
PXT4_IOC_GETFLAGS
:

726 
Êags
 = 
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
;

727  
	`put_u£r
(
Êags
, (
__u£r
 *Ë
¨g
);

728 
PXT4_IOC_SETFLAGS
: {

729 
îr
;

731 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

732  -
EACCES
;

734 i‡(
	`gë_u£r
(
Êags
, (
__u£r
 *Ë
¨g
))

735  -
EFAULT
;

737 i‡(
Êags
 & ~
PXT4_FL_USER_VISIBLE
)

738  -
EOPNOTSUPP
;

745 
Êags
 &
PXT4_FL_USER_MODIFIABLE
;

746 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

747  -
EOPNOTSUPP
;

749 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

750 i‡(
îr
)

751  
îr
;

753 
	`öode_lock
(
öode
);

754 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

755 
	`öode_u∆ock
(
öode
);

756 
	`m¡_dr›_wrôe_fûe
(
fûp
);

757  
îr
;

759 
PXT4_IOC_GETVERSION
:

760 
PXT4_IOC_GETVERSION_OLD
:

761  
	`put_u£r
(
öode
->
i_gíî©i⁄
, (
__u£r
 *Ë
¨g
);

762 
PXT4_IOC_SETVERSION
:

763 
PXT4_IOC_SETVERSION_OLD
: {

764 
h™dÀ_t
 *
h™dÀ
;

765 
pxt4_ûoc
 
ûoc
;

766 
__u32
 
gíî©i⁄
;

767 
îr
;

769 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

770  -
EPERM
;

772 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

773 
	`pxt4_w¨nög
(
sb
, "Setting inode version isÇot "

775  -
ENOTTY
;

778 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

779 i‡(
îr
)

780  
îr
;

781 i‡(
	`gë_u£r
(
gíî©i⁄
, (
__u£r
 *Ë
¨g
)) {

782 
îr
 = -
EFAULT
;

783 
£tvîsi⁄_out
;

786 
	`öode_lock
(
öode
);

787 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_INODE
, 1);

788 i‡(
	`IS_ERR
(
h™dÀ
)) {

789 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

790 
u∆ock_out
;

792 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

793 i‡(
îr
 == 0) {

794 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

795 
öode
->
i_gíî©i⁄
 = 
gíî©i⁄
;

796 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

798 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

800 
u∆ock_out
:

801 
	`öode_u∆ock
(
öode
);

802 
£tvîsi⁄_out
:

803 
	`m¡_dr›_wrôe_fûe
(
fûp
);

804  
îr
;

806 
PXT4_IOC_GROUP_EXTEND
: {

807 
pxt4_fsblk_t
 
n_blocks_cou¡
;

808 
îr
, 
îr2
=0;

810 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

811 i‡(
îr
)

812  
îr
;

814 i‡(
	`gë_u£r
(
n_blocks_cou¡
, (
__u32
 
__u£r
 *)
¨g
)) {

815 
îr
 = -
EFAULT
;

816 
group_exãnd_out
;

819 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

820 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

822 
îr
 = -
EOPNOTSUPP
;

823 
group_exãnd_out
;

826 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

827 i‡(
îr
)

828 
group_exãnd_out
;

830 
îr
 = 
	`pxt4_group_exãnd
(
sb
, 
	`PXT4_SB
(sb)->
s_es
, 
n_blocks_cou¡
);

831 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

832 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

833 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

834 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

836 i‡(
îr
 == 0)

837 
îr
 = 
îr2
;

838 
	`m¡_dr›_wrôe_fûe
(
fûp
);

839 
group_exãnd_out
:

840 
	`pxt4_ªsize_íd
(
sb
);

841  
îr
;

844 
PXT4_IOC_MOVE_EXT
: {

845 
move_exã¡
 
me
;

846 
fd
 
d⁄‹
;

847 
îr
;

849 i‡(!(
fûp
->
f_mode
 & 
FMODE_READ
) ||

850 !(
fûp
->
f_mode
 & 
FMODE_WRITE
))

851  -
EBADF
;

853 i‡(
	`c›y_‰om_u£r
(&
me
,

854 (
move_exã¡
 
__u£r
 *)
¨g
, (
me
)))

855  -
EFAULT
;

856 
me
.
moved_Àn
 = 0;

858 
d⁄‹
 = 
	`fdgë
(
me
.
d⁄‹_fd
);

859 i‡(!
d⁄‹
.
fûe
)

860  -
EBADF
;

862 i‡(!(
d⁄‹
.
fûe
->
f_mode
 & 
FMODE_WRITE
)) {

863 
îr
 = -
EBADF
;

864 
mext_out
;

867 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
)) {

868 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

870 
îr
 = -
EOPNOTSUPP
;

871 
mext_out
;

872 } i‡(
	`IS_DAX
(
öode
)) {

873 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

875 
îr
 = -
EOPNOTSUPP
;

876 
mext_out
;

879 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

880 i‡(
îr
)

881 
mext_out
;

883 
îr
 = 
	`pxt4_move_exã¡s
(
fûp
, 
d⁄‹
.
fûe
, 
me
.
‹ig_°¨t
,

884 
me
.
d⁄‹_°¨t
, me.
Àn
, &me.
moved_Àn
);

885 
	`m¡_dr›_wrôe_fûe
(
fûp
);

887 i‡(
	`c›y_to_u£r
((
move_exã¡
 
__u£r
 *)
¨g
,

888 &
me
, (me)))

889 
îr
 = -
EFAULT
;

890 
mext_out
:

891 
	`fdput
(
d⁄‹
);

892  
îr
;

895 
PXT4_IOC_GROUP_ADD
: {

896 
pxt4_√w_group_d©a
 
öput
;

898 i‡(
	`c›y_‰om_u£r
(&
öput
, (
pxt4_√w_group_öput
 
__u£r
 *)
¨g
,

899 (
öput
)))

900  -
EFAULT
;

902  
	`pxt4_io˘l_group_add
(
fûp
, &
öput
);

905 
PXT4_IOC_MIGRATE
:

907 
îr
;

908 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

909  -
EACCES
;

911 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

912 i‡(
îr
)

913  
îr
;

920 
	`öode_lock
((
öode
));

921 
îr
 = 
	`pxt4_ext_migøã
(
öode
);

922 
	`öode_u∆ock
((
öode
));

923 
	`m¡_dr›_wrôe_fûe
(
fûp
);

924  
îr
;

927 
PXT4_IOC_ALLOC_DA_BLKS
:

929 
îr
;

930 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

931  -
EACCES
;

933 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

934 i‡(
îr
)

935  
îr
;

936 
îr
 = 
	`pxt4_Æloc_da_blocks
(
öode
);

937 
	`m¡_dr›_wrôe_fûe
(
fûp
);

938  
îr
;

941 
PXT4_IOC_SWAP_BOOT
:

943 
îr
;

944 i‡(!(
fûp
->
f_mode
 & 
FMODE_WRITE
))

945  -
EBADF
;

946 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

947 i‡(
îr
)

948  
îr
;

949 
îr
 = 
	`sw≠_öode_boŸ_lﬂdî
(
sb
, 
öode
);

950 
	`m¡_dr›_wrôe_fûe
(
fûp
);

951  
îr
;

954 
PXT4_IOC_RESIZE_FS
: {

955 
pxt4_fsblk_t
 
n_blocks_cou¡
;

956 
îr
 = 0, 
îr2
 = 0;

957 
pxt4_group_t
 
o_group
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

959 i‡(
	`c›y_‰om_u£r
(&
n_blocks_cou¡
, (
__u64
 
__u£r
 *)
¨g
,

960 (
__u64
))) {

961  -
EFAULT
;

964 
îr
 = 
	`pxt4_ªsize_begö
(
sb
);

965 i‡(
îr
)

966  
îr
;

968 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

969 i‡(
îr
)

970 
ªsizefs_out
;

972 
îr
 = 
	`pxt4_ªsize_fs
(
sb
, 
n_blocks_cou¡
);

973 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

974 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

975 
îr2
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

976 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

978 i‡(
îr
 == 0)

979 
îr
 = 
îr2
;

980 
	`m¡_dr›_wrôe_fûe
(
fûp
);

981 i‡(!
îr
 && (
o_group
 < 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
) &&

982 
	`pxt4_has_group_desc_csum
(
sb
) &&

983 
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

984 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
o_group
);

986 
ªsizefs_out
:

987 
	`pxt4_ªsize_íd
(
sb
);

988  
îr
;

991 
FITRIM
:

993 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

994 
f°rim_ønge
 
ønge
;

995 
ªt
 = 0;

997 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

998  -
EPERM
;

1000 i‡(!
	`blk_queue_disˇrd
(
q
))

1001  -
EOPNOTSUPP
;

1007 i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb))

1008  -
EROFS
;

1010 i‡(
	`c›y_‰om_u£r
(&
ønge
, (
f°rim_ønge
 
__u£r
 *)
¨g
,

1011 (
ønge
)))

1012  -
EFAULT
;

1014 
ønge
.
möÀn
 = 
	`max
(()range.minlen,

1015 
q
->
limôs
.
disˇrd_gønuœrôy
);

1016 
ªt
 = 
	`pxt4_åim_fs
(
sb
, &
ønge
);

1017 i‡(
ªt
 < 0)

1018  
ªt
;

1020 i‡(
	`c›y_to_u£r
((
f°rim_ønge
 
__u£r
 *)
¨g
, &
ønge
,

1021 (
ønge
)))

1022  -
EFAULT
;

1026 
PXT4_IOC_PRECACHE_EXTENTS
:

1027  
	`pxt4_ext_¥eˇche
(
öode
);

1029 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1030 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1031  -
EOPNOTSUPP
;

1032  
	`fs¸y±_io˘l_£t_pﬁicy
(
fûp
, (c⁄° 
__u£r
 *)
¨g
);

1034 
PXT4_IOC_GET_ENCRYPTION_PWSALT
: {

1035 #ifde‡
CONFIG_FS_ENCRYPTION


1036 
îr
, 
îr2
;

1037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1038 
h™dÀ_t
 *
h™dÀ
;

1040 i‡(!
	`pxt4_has_„©uª_í¸y±
(
sb
))

1041  -
EOPNOTSUPP
;

1042 i‡(
	`uuid_is_zîo
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
)) {

1043 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1044 i‡(
îr
)

1045  
îr
;

1046 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_MISC
, 1);

1047 i‡(
	`IS_ERR
(
h™dÀ
)) {

1048 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1049 
pwß…_îr_exô
;

1051 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1052 i‡(
îr
)

1053 
pwß…_îr_jou∫Æ
;

1054 
	`gíî©e_øndom_uuid
(
sbi
->
s_es
->
s_í¸y±_pw_ß…
);

1055 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
,

1056 
sbi
->
s_sbh
);

1057 
pwß…_îr_jou∫Æ
:

1058 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1059 i‡(
îr2
 && !
îr
)

1060 
îr
 = 
îr2
;

1061 
pwß…_îr_exô
:

1062 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1063 i‡(
îr
)

1064  
îr
;

1066 i‡(
	`c›y_to_u£r
((
__u£r
 *Ë
¨g
,

1067 
sbi
->
s_es
->
s_í¸y±_pw_ß…
, 16))

1068  -
EFAULT
;

1071  -
EOPNOTSUPP
;

1074 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1075  
	`fs¸y±_io˘l_gë_pﬁicy
(
fûp
, (
__u£r
 *)
¨g
);

1077 
PXT4_IOC_FSGETXATTR
:

1079 
fsx©å
 
Á
;

1081 
	`mem£t
(&
Á
, 0, (
fsx©å
));

1082 
Á
.
fsx_xÊags
 = 
	`pxt4_iÊags_to_xÊags
(
ei
->
i_Êags
 & 
PXT4_FL_USER_VISIBLE
);

1084 i‡(
	`pxt4_has_„©uª_¥oje˘
(
öode
->
i_sb
)) {

1085 
Á
.
fsx_¥ojid
 = (
__u32
)
	`‰om_k¥ojid
(&
öô_u£r_ns
,

1086 
	`PXT4_I
(
öode
)->
i_¥ojid
);

1089 i‡(
	`c›y_to_u£r
((
fsx©å
 
__u£r
 *)
¨g
,

1090 &
Á
, (fa)))

1091  -
EFAULT
;

1094 
PXT4_IOC_FSSETXATTR
:

1096 
fsx©å
 
Á
;

1097 
îr
;

1099 i‡(
	`c›y_‰om_u£r
(&
Á
, (
fsx©å
 
__u£r
 *)
¨g
,

1100 (
Á
)))

1101  -
EFAULT
;

1104 i‡(!
	`öode_ow√r_‹_ˇ∑bÀ
(
öode
))

1105  -
EACCES
;

1107 i‡(
Á
.
fsx_xÊags
 & ~
PXT4_SUPPORTED_FS_XFLAGS
)

1108  -
EOPNOTSUPP
;

1110 
Êags
 = 
	`pxt4_xÊags_to_iÊags
(
Á
.
fsx_xÊags
);

1111 i‡(
	`pxt4_mask_Êags
(
öode
->
i_mode
, 
Êags
) != flags)

1112  -
EOPNOTSUPP
;

1114 
îr
 = 
	`m¡_w™t_wrôe_fûe
(
fûp
);

1115 i‡(
îr
)

1116  
îr
;

1118 
	`öode_lock
(
öode
);

1119 
îr
 = 
	`pxt4_io˘l_check_¥oje˘
(
öode
, &
Á
);

1120 i‡(
îr
)

1121 
out
;

1122 
Êags
 = (
ei
->
i_Êags
 & ~
PXT4_FL_XFLAG_VISIBLE
) |

1123 (
Êags
 & 
PXT4_FL_XFLAG_VISIBLE
);

1124 
îr
 = 
	`pxt4_io˘l_£tÊags
(
öode
, 
Êags
);

1125 i‡(
îr
)

1126 
out
;

1127 
îr
 = 
	`pxt4_io˘l_£çroje˘
(
fûp
, 
Á
.
fsx_¥ojid
);

1128 
out
:

1129 
	`öode_u∆ock
(
öode
);

1130 
	`m¡_dr›_wrôe_fûe
(
fûp
);

1131  
îr
;

1133 
PXT4_IOC_SHUTDOWN
:

1134  
	`pxt4_shutdown
(
sb
, 
¨g
);

1136  -
ENOTTY
;

1138 
	}
}

1140 #ifde‡
CONFIG_COMPAT


1141 
	$pxt4_com∑t_io˘l
(
fûe
 *fûe, 
cmd
, 
¨g
)

1144 
cmd
) {

1145 
PXT4_IOC32_GETFLAGS
:

1146 
cmd
 = 
PXT4_IOC_GETFLAGS
;

1148 
PXT4_IOC32_SETFLAGS
:

1149 
cmd
 = 
PXT4_IOC_SETFLAGS
;

1151 
PXT4_IOC32_GETVERSION
:

1152 
cmd
 = 
PXT4_IOC_GETVERSION
;

1154 
PXT4_IOC32_SETVERSION
:

1155 
cmd
 = 
PXT4_IOC_SETVERSION
;

1157 
PXT4_IOC32_GROUP_EXTEND
:

1158 
cmd
 = 
PXT4_IOC_GROUP_EXTEND
;

1160 
PXT4_IOC32_GETVERSION_OLD
:

1161 
cmd
 = 
PXT4_IOC_GETVERSION_OLD
;

1163 
PXT4_IOC32_SETVERSION_OLD
:

1164 
cmd
 = 
PXT4_IOC_SETVERSION_OLD
;

1166 
PXT4_IOC32_GETRSVSZ
:

1167 
cmd
 = 
PXT4_IOC_GETRSVSZ
;

1169 
PXT4_IOC32_SETRSVSZ
:

1170 
cmd
 = 
PXT4_IOC_SETRSVSZ
;

1172 
PXT4_IOC32_GROUP_ADD
: {

1173 
com∑t_pxt4_√w_group_öput
 
__u£r
 *
uöput
;

1174 
pxt4_√w_group_d©a
 
öput
;

1175 
îr
;

1177 
uöput
 = 
	`com∑t_±r
(
¨g
);

1178 
îr
 = 
	`gë_u£r
(
öput
.
group
, &
uöput
->group);

1179 
îr
 |
	`gë_u£r
(
öput
.
block_bôm≠
, &
uöput
->block_bitmap);

1180 
îr
 |
	`gë_u£r
(
öput
.
öode_bôm≠
, &
uöput
->inode_bitmap);

1181 
îr
 |
	`gë_u£r
(
öput
.
öode_èbÀ
, &
uöput
->inode_table);

1182 
îr
 |
	`gë_u£r
(
öput
.
blocks_cou¡
, &
uöput
->blocks_count);

1183 
îr
 |
	`gë_u£r
(
öput
.
ª£rved_blocks
,

1184 &
uöput
->
ª£rved_blocks
);

1185 i‡(
îr
)

1186  -
EFAULT
;

1187  
	`pxt4_io˘l_group_add
(
fûe
, &
öput
);

1189 
PXT4_IOC_MOVE_EXT
:

1190 
PXT4_IOC_RESIZE_FS
:

1191 
PXT4_IOC_PRECACHE_EXTENTS
:

1192 
PXT4_IOC_SET_ENCRYPTION_POLICY
:

1193 
PXT4_IOC_GET_ENCRYPTION_PWSALT
:

1194 
PXT4_IOC_GET_ENCRYPTION_POLICY
:

1195 
PXT4_IOC_SHUTDOWN
:

1196 
FS_IOC_GETFSMAP
:

1199  -
ENOIOCTLCMD
;

1201  
	`pxt4_io˘l
(
fûe
, 
cmd
, (Ë
	`com∑t_±r
(
¨g
));

1202 
	}
}

	@jbd3/checkpoint.c

17 
	~<löux/time.h
>

18 
	~<löux/fs.h
>

19 
	~<löux/jbd3.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/blkdev.h
>

23 
	~<åa˚/evíts/jbd3.h
>

30 
ölöe
 
	$__buf„r_u∆ök_fú°
(
jou∫Æ_hód
 *
jh
)

32 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

34 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh->b_cpprev;

35 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh->b_cpnext;

36 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
jh
) {

37 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
jh
->
b_˝√xt
;

38 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
jh
)

39 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
NULL
;

41 
	}
}

48 
ölöe
 
	$__buf„r_u∆ök
(
jou∫Æ_hód
 *
jh
)

50 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

52 
	`__buf„r_u∆ök_fú°
(
jh
);

53 i‡(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
jh
) {

54 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
jh
->
b_˝√xt
;

55 i‡(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
jh
)

56 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
NULL
;

58 
	}
}

65 
ölöe
 
	$__buf„r_ªlök_io
(
jou∫Æ_hód
 *
jh
)

67 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

69 
	`__buf„r_u∆ök_fú°
(
jh
);

71 i‡(!
å™ß˘i⁄
->
t_checkpoöt_io_li°
) {

72 
jh
->
b_˝√xt
 = jh->
b_˝¥ev
 = jh;

74 
jh
->
b_˝√xt
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
;

75 
jh
->
b_˝¥ev
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
->b_cpprev;

76 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh;

77 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh;

79 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 = 
jh
;

80 
	}
}

89 
	$__åy_to_‰ì_˝_buf
(
jou∫Æ_hód
 *
jh
)

91 
ªt
 = 0;

92 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

94 i‡(
jh
->
b_å™ß˘i⁄
 =
NULL
 && !
	`buf„r_locked
(
bh
) &&

95 !
	`buf„r_dúty
(
bh
Ë&& !
	`buf„r_wrôe_io_îr‹
(bh)) {

96 
	`JBUFFER_TRACE
(
jh
, "remove from checkpointÜist");

97 
ªt
 = 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
) + 1;

99  
ªt
;

100 
	}
}

108 
	$__jbd3_log_waô_f‹_•a˚
(
jou∫Æ_t
 *
jou∫Æ
)

110 
nblocks
, 
•a˚_À·
;

113 
nblocks
 = 
	`jbd3_•a˚_√eded
(
jou∫Æ
);

114 
	`jbd3_log_•a˚_À·
(
jou∫Æ
Ë< 
nblocks
) {

115 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

116 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

129 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

130 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
) {

131 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

134 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

135 
nblocks
 = 
	`jbd3_•a˚_√eded
(
jou∫Æ
);

136 
•a˚_À·
 = 
	`jbd3_log_•a˚_À·
(
jou∫Æ
);

137 i‡(
•a˚_À·
 < 
nblocks
) {

138 
chk±
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
;

139 
tid_t
 
tid
 = 0;

141 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

142 
tid
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

143 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

144 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

145 i‡(
chk±
) {

146 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

147 } i‡(
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
) == 0) {

150 } i‡(
tid
) {

156 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

157 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

158 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

161 
	`¥ötk
(
KERN_ERR
 "%s:Çeeded %d blocksánd "

163 
__func__
, 
nblocks
, 
•a˚_À·
);

164 
	`¥ötk
(
KERN_ERR
 "%s:Ço wayÅo get more "

165 "jou∫Æ s∑˚ i¿%s\n", 
__func__
,

166 
jou∫Æ
->
j_dev«me
);

167 
	`WARN_ON
(1);

168 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 0);

170 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

172 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

174 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

176 
	}
}

179 
	$__Êush_b©ch
(
jou∫Æ_t
 *
jou∫Æ
, *
b©ch_cou¡
)

181 
i
;

182 
blk_∂ug
 
∂ug
;

184 
	`blk_°¨t_∂ug
(&
∂ug
);

185 
i
 = 0; i < *
b©ch_cou¡
; i++)

186 
	`wrôe_dúty_buf„r
(
jou∫Æ
->
j_chk±_bhs
[
i
], 
REQ_SYNC
);

187 
	`blk_föish_∂ug
(&
∂ug
);

189 
i
 = 0; i < *
b©ch_cou¡
; i++) {

190 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_chk±_bhs
[
i
];

191 
	`BUFFER_TRACE
(
bh
, "brelse");

192 
	`__bªl£
(
bh
);

194 *
b©ch_cou¡
 = 0;

195 
	}
}

205 
	$jbd3_log_do_checkpoöt
(
jou∫Æ_t
 *
jou∫Æ
)

207 
jou∫Æ_hód
 *
jh
;

208 
buf„r_hód
 *
bh
;

209 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

210 
tid_t
 
this_tid
;

211 
ªsu…
, 
b©ch_cou¡
 = 0;

213 
	`jbd_debug
(1, "Start checkpoint\n");

220 
ªsu…
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

221 
	`åa˚_jbd3_checkpoöt
(
jou∫Æ
, 
ªsu…
);

222 
	`jbd_debug
(1, "˛ónup_jou∫Æ_èûÑëu∫ed %d\n", 
ªsu…
);

223 i‡(
ªsu…
 <= 0)

224  
ªsu…
;

230 
ªsu…
 = 0;

231 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

232 i‡(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
)

233 
out
;

234 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

235 i‡(
å™ß˘i⁄
->
t_chp_°©s
.
cs_chp_time
 == 0)

236 
å™ß˘i⁄
->
t_chp_°©s
.
cs_chp_time
 = 
jiffõs
;

237 
this_tid
 = 
å™ß˘i⁄
->
t_tid
;

238 
ª°¨t
:

244 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
å™ß˘i⁄
 ||

245 
å™ß˘i⁄
->
t_tid
 !
this_tid
)

246 
out
;

249 
å™ß˘i⁄
->
t_checkpoöt_li°
) {

250 
jh
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
;

251 
bh
 = 
	`jh2bh
(
jh
);

253 i‡(
	`buf„r_locked
(
bh
)) {

254 
	`gë_bh
(
bh
);

255 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

256 
	`waô_⁄_buf„r
(
bh
);

258 
	`BUFFER_TRACE
(
bh
, "brelse");

259 
	`__bªl£
(
bh
);

260 
ªåy
;

262 i‡(
jh
->
b_å™ß˘i⁄
 !
NULL
) {

263 
å™ß˘i⁄_t
 *
t
 = 
jh
->
b_å™ß˘i⁄
;

264 
tid_t
 
tid
 = 
t
->
t_tid
;

266 
å™ß˘i⁄
->
t_chp_°©s
.
cs_f‹˚d_to_˛o£
++;

267 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

268 i‡(
	`u∆ikñy
(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
))

275 
	`¥ötk
(
KERN_ERR


277 
jou∫Æ
->
j_dev«me
, (Ë
bh
->
b_blockƒ
);

279 i‡(
b©ch_cou¡
)

280 
	`__Êush_b©ch
(
jou∫Æ
, &
b©ch_cou¡
);

281 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

290 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

291 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

292 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

293 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

294 
ª°¨t
;

296 i‡(!
	`buf„r_dúty
(
bh
)) {

297 i‡(
	`u∆ikñy
(
	`buf„r_wrôe_io_îr‹
(
bh
)Ë&& !
ªsu…
)

298 
ªsu…
 = -
EIO
;

299 
	`BUFFER_TRACE
(
bh
, "remove from checkpoint");

300 i‡(
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
))

302 
out
;

313 
	`BUFFER_TRACE
(
bh
, "queue");

314 
	`gë_bh
(
bh
);

315 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_jwrôe
(bh));

316 
jou∫Æ
->
j_chk±_bhs
[
b©ch_cou¡
++] = 
bh
;

317 
	`__buf„r_ªlök_io
(
jh
);

318 
å™ß˘i⁄
->
t_chp_°©s
.
cs_wrôãn
++;

319 i‡((
b©ch_cou¡
 =
JBD3_NR_BATCH
) ||

320 
	`√ed_ªsched
() ||

321 
	`•ö_√edbªak
(&
jou∫Æ
->
j_li°_lock
))

322 
u∆ock_™d_Êush
;

325 i‡(
b©ch_cou¡
) {

326 
u∆ock_™d_Êush
:

327 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

328 
ªåy
:

329 i‡(
b©ch_cou¡
)

330 
	`__Êush_b©ch
(
jou∫Æ
, &
b©ch_cou¡
);

331 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

332 
ª°¨t
;

339 
ª°¨t2
:

341 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
å™ß˘i⁄
 ||

342 
å™ß˘i⁄
->
t_tid
 !
this_tid
)

343 
out
;

345 
å™ß˘i⁄
->
t_checkpoöt_io_li°
) {

346 
jh
 = 
å™ß˘i⁄
->
t_checkpoöt_io_li°
;

347 
bh
 = 
	`jh2bh
(
jh
);

348 i‡(
	`buf„r_locked
(
bh
)) {

349 
	`gë_bh
(
bh
);

350 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

351 
	`waô_⁄_buf„r
(
bh
);

353 
	`BUFFER_TRACE
(
bh
, "brelse");

354 
	`__bªl£
(
bh
);

355 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

356 
ª°¨t2
;

358 i‡(
	`u∆ikñy
(
	`buf„r_wrôe_io_îr‹
(
bh
)Ë&& !
ªsu…
)

359 
ªsu…
 = -
EIO
;

366 i‡(
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
))

369 
out
:

370 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

371 i‡(
ªsu…
 < 0)

372 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªsu…
);

374 
ªsu…
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

376  (
ªsu…
 < 0) ?Ñesult : 0;

377 
	}
}

397 
	$jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ_t
 *
jou∫Æ
)

399 
tid_t
 
fú°_tid
;

400 
blockƒ
;

402 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

403  -
EIO
;

405 i‡(!
	`jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ
, &
fú°_tid
, &
blockƒ
))

407 
	`J_ASSERT
(
blockƒ
 != 0);

417 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
)

418 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

420  
	`__jbd3_upd©e_log_èû
(
jou∫Æ
, 
fú°_tid
, 
blockƒ
);

421 
	}
}

435 
	$jou∫Æ_˛ón_⁄e_˝_li°
(
jou∫Æ_hód
 *
jh
, 
boﬁ
 
de°roy
)

437 
jou∫Æ_hód
 *
œ°_jh
;

438 
jou∫Æ_hód
 *
√xt_jh
 = 
jh
;

439 
ªt
;

441 i‡(!
jh
)

444 
œ°_jh
 = 
jh
->
b_˝¥ev
;

446 
jh
 = 
√xt_jh
;

447 
√xt_jh
 = 
jh
->
b_˝√xt
;

448 i‡(!
de°roy
)

449 
ªt
 = 
	`__åy_to_‰ì_˝_buf
(
jh
);

451 
ªt
 = 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
) + 1;

452 i‡(!
ªt
)

454 i‡(
ªt
 == 2)

462 i‡(
	`√ed_ªsched
())

464 } 
jh
 !
œ°_jh
);

467 
	}
}

477 
	$__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ_t
 *
jou∫Æ
, 
boﬁ
 
de°roy
)

479 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, *
œ°_å™ß˘i⁄
, *
√xt_å™ß˘i⁄
;

480 
ªt
;

482 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

483 i‡(!
å™ß˘i⁄
)

486 
œ°_å™ß˘i⁄
 = 
å™ß˘i⁄
->
t_˝¥ev
;

487 
√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

489 
å™ß˘i⁄
 = 
√xt_å™ß˘i⁄
;

490 
√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
->
t_˝√xt
;

491 
ªt
 = 
	`jou∫Æ_˛ón_⁄e_˝_li°
(
å™ß˘i⁄
->
t_checkpoöt_li°
,

492 
de°roy
);

498 i‡(
	`√ed_ªsched
())

500 i‡(
ªt
)

507 
ªt
 = 
	`jou∫Æ_˛ón_⁄e_˝_li°
(
å™ß˘i⁄
->

508 
t_checkpoöt_io_li°
, 
de°roy
);

509 i‡(
	`√ed_ªsched
())

516 i‡(!
ªt
)

518 } 
å™ß˘i⁄
 !
œ°_å™ß˘i⁄
);

519 
	}
}

525 
	$jbd3_jou∫Æ_de°roy_checkpoöt
(
jou∫Æ_t
 *
jou∫Æ
)

532 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

533 i‡(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
) {

534 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

537 
	`__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ
, 
åue
);

538 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

539 
	`c⁄d_ªsched
();

541 
	}
}

561 
	$__jbd3_jou∫Æ_ªmove_checkpoöt
(
jou∫Æ_hód
 *
jh
)

563 
å™ß˘i⁄_chp_°©s_s
 *
°©s
;

564 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

565 
jou∫Æ_t
 *
jou∫Æ
;

566 
ªt
 = 0;

568 
	`JBUFFER_TRACE
(
jh
, "entry");

570 i‡((
å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
Ë=
NULL
) {

571 
	`JBUFFER_TRACE
(
jh
, "not onÅransaction");

572 
out
;

574 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

576 
	`JBUFFER_TRACE
(
jh
, "removing fromÅransaction");

577 
	`__buf„r_u∆ök
(
jh
);

578 
jh
->
b_˝_å™ß˘i⁄
 = 
NULL
;

579 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

581 i‡(
å™ß˘i⁄
->
t_checkpoöt_li°
 !
NULL
 ||

582 
å™ß˘i⁄
->
t_checkpoöt_io_li°
 !
NULL
)

583 
out
;

594 i‡(
å™ß˘i⁄
->
t_°©e
 !
T_FINISHED
)

595 
out
;

599 
°©s
 = &
å™ß˘i⁄
->
t_chp_°©s
;

600 i‡(
°©s
->
cs_chp_time
)

601 
°©s
->
cs_chp_time
 = 
	`jbd3_time_diff
(stats->cs_chp_time,

602 
jiffõs
);

603 
	`åa˚_jbd3_checkpoöt_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

604 
å™ß˘i⁄
->
t_tid
, 
°©s
);

606 
	`__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ
, 
å™ß˘i⁄
);

607 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
å™ß˘i⁄
);

608 
ªt
 = 1;

609 
out
:

610  
ªt
;

611 
	}
}

621 
	$__jbd3_jou∫Æ_ö£π_checkpoöt
(
jou∫Æ_hód
 *
jh
,

622 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

624 
	`JBUFFER_TRACE
(
jh
, "entry");

625 
	`J_ASSERT_JH
(
jh
, 
	`buf„r_dúty
(
	`jh2bh
(jh)Ë|| 
	`buf„r_jbddúty
(jh2bh(jh)));

626 
	`J_ASSERT_JH
(
jh
, jh->
b_˝_å™ß˘i⁄
 =
NULL
);

629 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
	`jh2bh
(
jh
));

630 
jh
->
b_˝_å™ß˘i⁄
 = 
å™ß˘i⁄
;

632 i‡(!
å™ß˘i⁄
->
t_checkpoöt_li°
) {

633 
jh
->
b_˝√xt
 = jh->
b_˝¥ev
 = jh;

635 
jh
->
b_˝√xt
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
;

636 
jh
->
b_˝¥ev
 = 
å™ß˘i⁄
->
t_checkpoöt_li°
->b_cpprev;

637 
jh
->
b_˝¥ev
->
b_˝√xt
 = jh;

638 
jh
->
b_˝√xt
->
b_˝¥ev
 = jh;

640 
å™ß˘i⁄
->
t_checkpoöt_li°
 = 
jh
;

641 
	}
}

653 
	$__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

655 
	`as£π_•ö_locked
(&
jou∫Æ
->
j_li°_lock
);

656 i‡(
å™ß˘i⁄
->
t_˝√xt
) {

657 
å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
 =Åransaction->t_cpprev;

658 
å™ß˘i⁄
->
t_˝¥ev
->
t_˝√xt
 =Åransaction->t_cpnext;

659 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
å™ß˘i⁄
)

660 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =

661 
å™ß˘i⁄
->
t_˝√xt
;

662 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
å™ß˘i⁄
)

663 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 = 
NULL
;

666 
	`J_ASSERT
(
å™ß˘i⁄
->
t_°©e
 =
T_FINISHED
);

667 
	`J_ASSERT
(
å™ß˘i⁄
->
t_buf„rs
 =
NULL
);

668 
	`J_ASSERT
(
å™ß˘i⁄
->
t_f‹gë
 =
NULL
);

669 
	`J_ASSERT
(
å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

670 
	`J_ASSERT
(
å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
);

671 
	`J_ASSERT
(
å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
NULL
);

672 
	`J_ASSERT
(
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
) == 0);

673 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 !
å™ß˘i⁄
);

674 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 !
å™ß˘i⁄
);

676 
	`åa˚_jbd3_dr›_å™ß˘i⁄
(
jou∫Æ
, 
å™ß˘i⁄
);

678 
	`jbd_debug
(1, "Dr›pögÅønß˘i⁄ %d,áŒ d⁄e\n", 
å™ß˘i⁄
->
t_tid
);

679 
	}
}

	@jbd3/commit.c

13 
	~<löux/time.h
>

14 
	~<löux/fs.h
>

15 
	~<löux/jbd3.h
>

16 
	~<löux/î∫o.h
>

17 
	~<löux/¶ab.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/jiffõs.h
>

21 
	~<löux/¸c32.h
>

22 
	~<löux/wrôeback.h
>

23 
	~<löux/backög-dev.h
>

24 
	~<löux/bio.h
>

25 
	~<löux/blkdev.h
>

26 
	~<löux/bô›s.h
>

27 
	~<åa˚/evíts/jbd3.h
>

32 
	$jou∫Æ_íd_buf„r_io_sync
(
buf„r_hód
 *
bh
, 
u±od©e
)

34 
buf„r_hód
 *
‹ig_bh
 = 
bh
->
b_¥iv©e
;

36 
	`BUFFER_TRACE
(
bh
, "");

37 i‡(
u±od©e
)

38 
	`£t_buf„r_u±od©e
(
bh
);

40 
	`˛ór_buf„r_u±od©e
(
bh
);

41 i‡(
‹ig_bh
) {

42 
	`˛ór_bô_u∆ock
(
BH_Shadow
, &
‹ig_bh
->
b_°©e
);

43 
	`smp_mb__a·î_©omic
();

44 
	`wake_up_bô
(&
‹ig_bh
->
b_°©e
, 
BH_Shadow
);

46 
	`u∆ock_buf„r
(
bh
);

47 
	}
}

63 
	$ªÀa£_buf„r_∑ge
(
buf„r_hód
 *
bh
)

65 
∑ge
 *page;

67 i‡(
	`buf„r_dúty
(
bh
))

68 
n›e
;

69 i‡(
	`©omic_ªad
(&
bh
->
b_cou¡
) != 1)

70 
n›e
;

71 
∑ge
 = 
bh
->
b_∑ge
;

72 i‡(!
∑ge
)

73 
n›e
;

74 i‡(
∑ge
->
m≠pög
)

75 
n›e
;

78 i‡(!
	`åylock_∑ge
(
∑ge
))

79 
n›e
;

81 
	`gë_∑ge
(
∑ge
);

82 
	`__bªl£
(
bh
);

83 
	`åy_to_‰ì_buf„rs
(
∑ge
);

84 
	`u∆ock_∑ge
(
∑ge
);

85 
	`put_∑ge
(
∑ge
);

88 
n›e
:

89 
	`__bªl£
(
bh
);

90 
	}
}

92 
	$jbd3_commô_block_csum_£t
(
jou∫Æ_t
 *
j
, 
buf„r_hód
 *
bh
)

94 
commô_hódî
 *
h
;

95 
__u32
 
csum
;

97 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

100 
h
 = (
commô_hódî
 *)(
bh
->
b_d©a
);

101 
h
->
h_chksum_ty≥
 = 0;

102 
h
->
h_chksum_size
 = 0;

103 
h
->
h_chksum
[0] = 0;

104 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

105 
h
->
h_chksum
[0] = 
	`˝u_to_be32
(
csum
);

106 
	}
}

116 
	$jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

117 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
,

118 
buf„r_hód
 **
cbh
,

119 
__u32
 
¸c32_sum
)

121 
commô_hódî
 *
tmp
;

122 
buf„r_hód
 *
bh
;

123 
ªt
;

124 
time•ec64
 
now
;

126 *
cbh
 = 
NULL
;

128 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

131 
bh
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
commô_å™ß˘i⁄
,

132 
JBD3_COMMIT_BLOCK
);

133 i‡(!
bh
)

136 
tmp
 = (
commô_hódî
 *)
bh
->
b_d©a
;

137 
	`ktime_gë_cﬂr£_ªÆ_ts64
(&
now
);

138 
tmp
->
h_commô_£c
 = 
	`˝u_to_be64
(
now
.
tv_£c
);

139 
tmp
->
h_commô_n£c
 = 
	`˝u_to_be32
(
now
.
tv_n£c
);

141 i‡(
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

142 
tmp
->
h_chksum_ty≥
 = 
JBD3_CRC32_CHKSUM
;

143 
tmp
->
h_chksum_size
 = 
JBD3_CRC32_CHKSUM_SIZE
;

144 
tmp
->
h_chksum
[0] = 
	`˝u_to_be32
(
¸c32_sum
);

146 
	`jbd3_commô_block_csum_£t
(
jou∫Æ
, 
bh
);

148 
	`BUFFER_TRACE
(
bh
, "submit commit block");

149 
	`lock_buf„r
(
bh
);

150 
	`˛ór_buf„r_dúty
(
bh
);

151 
	`£t_buf„r_u±od©e
(
bh
);

152 
bh
->
b_íd_io
 = 
jou∫Æ_íd_buf„r_io_sync
;

154 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

155 !
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
))

156 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
,

157 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
, 
bh
);

159 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

161 *
cbh
 = 
bh
;

162  
ªt
;

163 
	}
}

169 
	$jou∫Æ_waô_⁄_commô_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

170 
buf„r_hód
 *
bh
)

172 
ªt
 = 0;

174 
	`˛ór_buf„r_dúty
(
bh
);

175 
	`waô_⁄_buf„r
(
bh
);

177 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

178 
ªt
 = -
EIO
;

179 
	`put_bh
(
bh
);

181  
ªt
;

182 
	}
}

190 
	$jou∫Æ_submô_öode_d©a_buf„rs
(
addªss_•a˚
 *
m≠pög
)

192 
ªt
;

193 
wrôeback_c⁄åﬁ
 
wbc
 = {

194 .
sync_mode
 = 
WB_SYNC_ALL
,

195 .
ƒ_to_wrôe
 = 
m≠pög
->
ƒ∑ges
 * 2,

196 .
ønge_°¨t
 = 0,

197 .
ønge_íd
 = 
	`i_size_ªad
(
m≠pög
->
ho°
),

200 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, &
wbc
);

201  
ªt
;

202 
	}
}

212 
	$jou∫Æ_submô_d©a_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

213 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
)

215 
jbd3_öode
 *
jöode
;

216 
îr
, 
ªt
 = 0;

217 
addªss_•a˚
 *
m≠pög
;

219 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

220 
	`li°_f‹_óch_íåy
(
jöode
, &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

221 i‡(!(
jöode
->
i_Êags
 & 
JI_WRITE_DATA
))

223 
m≠pög
 = 
jöode
->
i_vfs_öode
->
i_m≠pög
;

224 
jöode
->
i_Êags
 |
JI_COMMIT_RUNNING
;

225 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

232 
	`åa˚_jbd3_submô_öode_d©a
(
jöode
->
i_vfs_öode
);

233 
îr
 = 
	`jou∫Æ_submô_öode_d©a_buf„rs
(
m≠pög
);

234 i‡(!
ªt
)

235 
ªt
 = 
îr
;

236 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

237 
	`J_ASSERT
(
jöode
->
i_å™ß˘i⁄
 =
commô_å™ß˘i⁄
);

238 
jöode
->
i_Êags
 &~
JI_COMMIT_RUNNING
;

239 
	`smp_mb
();

240 
	`wake_up_bô
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

242 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

243  
ªt
;

244 
	}
}

251 
	$jou∫Æ_föish_öode_d©a_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

252 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
)

254 
jbd3_öode
 *
jöode
, *
√xt_i
;

255 
îr
, 
ªt
 = 0;

258 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

259 
	`li°_f‹_óch_íåy
(
jöode
, &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

260 i‡(!(
jöode
->
i_Êags
 & 
JI_WAIT_DATA
))

262 
jöode
->
i_Êags
 |
JI_COMMIT_RUNNING
;

263 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

264 
îr
 = 
	`fûem≠_fd©awaô_kìp_îr‹s
(

265 
jöode
->
i_vfs_öode
->
i_m≠pög
);

266 i‡(!
ªt
)

267 
ªt
 = 
îr
;

268 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

269 
jöode
->
i_Êags
 &~
JI_COMMIT_RUNNING
;

270 
	`smp_mb
();

271 
	`wake_up_bô
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

275 
	`li°_f‹_óch_íåy_ß„
(
jöode
, 
√xt_i
,

276 &
commô_å™ß˘i⁄
->
t_öode_li°
, 
i_li°
) {

277 
	`li°_dñ
(&
jöode
->
i_li°
);

278 i‡(
jöode
->
i_√xt_å™ß˘i⁄
) {

279 
jöode
->
i_å™ß˘i⁄
 = jöode->
i_√xt_å™ß˘i⁄
;

280 
jöode
->
i_√xt_å™ß˘i⁄
 = 
NULL
;

281 
	`li°_add
(&
jöode
->
i_li°
,

282 &
jöode
->
i_å™ß˘i⁄
->
t_öode_li°
);

284 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

287 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

289  
ªt
;

290 
	}
}

292 
__u32
 
	$jbd3_checksum_d©a
(
__u32
 
¸c32_sum
, 
buf„r_hód
 *
bh
)

294 
∑ge
 *∑gê
bh
->
b_∑ge
;

295 *
addr
;

296 
__u32
 
checksum
;

298 
addr
 = 
	`km≠_©omic
(
∑ge
);

299 
checksum
 = 
	`¸c32_be
(
¸c32_sum
,

300 (*)(
addr
 + 
	`off£t_ö_∑ge
(
bh
->
b_d©a
)), bh->
b_size
);

301 
	`kunm≠_©omic
(
addr
);

303  
checksum
;

304 
	}
}

306 
	$wrôe_èg_block
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

307 
block
)

309 
èg
->
t_blockƒ
 = 
	`˝u_to_be32
(
block
 & (
u32
)~0);

310 i‡(
	`jbd3_has_„©uª_64bô
(
j
))

311 
èg
->
t_blockƒ_high
 = 
	`˝u_to_be32
((
block
 >> 31) >> 1);

312 
	}
}

314 
	$jbd3_block_èg_csum_£t
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

315 
buf„r_hód
 *
bh
, 
__u32
 
£quí˚
)

317 
jou∫Æ_block_èg3_t
 *
èg3
 = (jou∫Æ_block_èg3_à*)
èg
;

318 
∑ge
 *∑gê
bh
->
b_∑ge
;

319 
__u8
 *
addr
;

320 
__u32
 
csum32
;

321 
__be32
 
£q
;

323 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

326 
£q
 = 
	`˝u_to_be32
(
£quí˚
);

327 
addr
 = 
	`km≠_©omic
(
∑ge
);

328 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

329 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
addr
 + 
	`off£t_ö_∑ge
(
bh
->
b_d©a
),

330 
bh
->
b_size
);

331 
	`kunm≠_©omic
(
addr
);

333 i‡(
	`jbd3_has_„©uª_csum3
(
j
))

334 
èg3
->
t_checksum
 = 
	`˝u_to_be32
(
csum32
);

336 
èg
->
t_checksum
 = 
	`˝u_to_be16
(
csum32
);

337 
	}
}

344 
	$jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
)

346 
å™ß˘i⁄_°©s_s
 
°©s
;

347 
å™ß˘i⁄_t
 *
commô_å™ß˘i⁄
;

348 
jou∫Æ_hód
 *
jh
;

349 
buf„r_hód
 *
des¸ùt‹
;

350 
buf„r_hód
 **
wbuf
 = 
jou∫Æ
->
j_wbuf
;

351 
bufs
;

352 
Êags
;

353 
îr
;

354 
blockƒ
;

355 
ktime_t
 
°¨t_time
;

356 
u64
 
commô_time
;

357 *
ègp
 = 
NULL
;

358 
jou∫Æ_block_èg_t
 *
èg
 = 
NULL
;

359 
•a˚_À·
 = 0;

360 
fú°_èg
 = 0;

361 
èg_Êag
;

362 
i
;

363 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

364 
buf„r_hód
 *
cbh
 = 
NULL
;

365 
__u32
 
¸c32_sum
 = ~0;

366 
blk_∂ug
 
∂ug
;

368 
fú°_block
;

369 
tid_t
 
fú°_tid
;

370 
upd©e_èû
;

371 
csum_size
 = 0;

372 
	`LIST_HEAD
(
io_bufs
);

373 
	`LIST_HEAD
(
log_bufs
);

375 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

376 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

384 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_FLUSHED
) {

385 
	`jbd_debug
(3, "super block updated\n");

386 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

393 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
,

394 
jou∫Æ
->
j_èû_£quí˚
,

395 
jou∫Æ
->
j_èû
,

396 
REQ_SYNC
);

397 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

399 
	`jbd_debug
(3, "superblockÇot updated\n");

402 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 !
NULL
);

403 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 =
NULL
);

405 
commô_å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

407 
	`åa˚_jbd3_°¨t_commô
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

408 
	`jbd_debug
(1, "JBD3: starting commit ofÅransaction %d\n",

409 
commô_å™ß˘i⁄
->
t_tid
);

411 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

412 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_RUNNING
);

413 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_LOCKED
;

415 
	`åa˚_jbd3_commô_lockög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

416 
°©s
.
run
.
rs_waô
 = 
commô_å™ß˘i⁄
->
t_max_waô
;

417 
°©s
.
run
.
rs_ªque°_dñay
 = 0;

418 
°©s
.
run
.
rs_locked
 = 
jiffõs
;

419 i‡(
commô_å™ß˘i⁄
->
t_ªque°ed
)

420 
°©s
.
run
.
rs_ªque°_dñay
 =

421 
	`jbd3_time_diff
(
commô_å™ß˘i⁄
->
t_ªque°ed
,

422 
°©s
.
run
.
rs_locked
);

423 
°©s
.
run
.
rs_ru¬ög
 = 
	`jbd3_time_diff
(
commô_å™ß˘i⁄
->
t_°¨t
,

424 
°©s
.
run
.
rs_locked
);

426 
	`•ö_lock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

427 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_upd©es
)) {

428 
	`DEFINE_WAIT
(
waô
);

430 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
,

431 
TASK_UNINTERRUPTIBLE
);

432 i‡(
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_upd©es
)) {

433 
	`•ö_u∆ock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

434 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

435 
	`scheduÀ
();

436 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

437 
	`•ö_lock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

439 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

441 
	`•ö_u∆ock
(&
commô_å™ß˘i⁄
->
t_h™dÀ_lock
);

442 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_SWITCH
;

443 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

445 
	`J_ASSERT
 (
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
) <=

446 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

464 
commô_å™ß˘i⁄
->
t_ª£rved_li°
) {

465 
jh
 = 
commô_å™ß˘i⁄
->
t_ª£rved_li°
;

466 
	`JBUFFER_TRACE
(
jh
, "reserved, unused:Ñefile");

471 i‡(
jh
->
b_commôãd_d©a
) {

472 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

474 
	`jbd_lock_bh_°©e
(
bh
);

475 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
bh
->
b_size
);

476 
jh
->
b_commôãd_d©a
 = 
NULL
;

477 
	`jbd_u∆ock_bh_°©e
(
bh
);

479 
	`jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ
, 
jh
);

487 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

488 
	`__jbd3_jou∫Æ_˛ón_checkpoöt_li°
(
jou∫Æ
, 
Ál£
);

489 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

491 
	`jbd_debug
(3, "JBD3: commitÖhase 1\n");

497 
	`jbd3_˛ór_buf„r_ªvoked_Êags
(
jou∫Æ
);

502 
	`jbd3_jou∫Æ_swôch_ªvoke_èbÀ
(
jou∫Æ
);

507 
	`©omic_sub
(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
),

508 &
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
);

510 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

511 
	`åa˚_jbd3_commô_Êushög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

512 
°©s
.
run
.
rs_Êushög
 = 
jiffõs
;

513 
°©s
.
run
.
rs_locked
 = 
	`jbd3_time_diff
(stats.run.rs_locked,

514 
°©s
.
run
.
rs_Êushög
);

516 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_FLUSH
;

517 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 = 
commô_å™ß˘i⁄
;

518 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 = 
NULL
;

519 
°¨t_time
 = 
	`ktime_gë
();

520 
commô_å™ß˘i⁄
->
t_log_°¨t
 = 
jou∫Æ
->
j_hód
;

521 
	`wake_up
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

522 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

524 
	`jbd_debug
(3, "JBD3: commitÖhase 2a\n");

530 
îr
 = 
	`jou∫Æ_submô_d©a_buf„rs
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

531 i‡(
îr
)

532 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

534 
	`blk_°¨t_∂ug
(&
∂ug
);

535 
	`jbd3_jou∫Æ_wrôe_ªvoke_ªc‹ds
(
commô_å™ß˘i⁄
, &
log_bufs
);

537 
	`jbd_debug
(3, "JBD3: commitÖhase 2b\n");

544 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

545 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT
;

546 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

548 
	`åa˚_jbd3_commô_loggög
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

549 
°©s
.
run
.
rs_loggög
 = 
jiffõs
;

550 
°©s
.
run
.
rs_Êushög
 = 
	`jbd3_time_diff
(stats.run.rs_flushing,

551 
°©s
.
run
.
rs_loggög
);

552 
°©s
.
run
.
rs_blocks
 =

553 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
);

554 
°©s
.
run
.
rs_blocks_logged
 = 0;

556 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_ƒ_buf„rs
 <=

557 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
));

559 
îr
 = 0;

560 
bufs
 = 0;

561 
des¸ùt‹
 = 
NULL
;

562 
commô_å™ß˘i⁄
->
t_buf„rs
) {

566 
jh
 = 
commô_å™ß˘i⁄
->
t_buf„rs
;

571 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)) {

572 
	`˛ór_buf„r_jbddúty
(
	`jh2bh
(
jh
));

573 
	`JBUFFER_TRACE
(
jh
, "journal isáborting:Ñefile");

574 
	`jbd3_buf„r_ab‹t_åiggî
(
jh
,

575 
jh
->
b_‰ozí_d©a
 ?

576 
jh
->
b_‰ozí_åiggîs
 :

577 
jh
->
b_åiggîs
);

578 
	`jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ
, 
jh
);

583 i‡(!
commô_å™ß˘i⁄
->
t_buf„rs
)

584 
°¨t_jou∫Æ_io
;

591 i‡(!
des¸ùt‹
) {

592 
	`J_ASSERT
 (
bufs
 == 0);

594 
	`jbd_debug
(4, "JBD3: get descriptor\n");

596 
des¸ùt‹
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(

597 
commô_å™ß˘i⁄
,

598 
JBD3_DESCRIPTOR_BLOCK
);

599 i‡(!
des¸ùt‹
) {

600 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

604 
	`jbd_debug
(4, "JBD3: got buffer %llu (%p)\n",

605 ()
des¸ùt‹
->
b_blockƒ
,

606 
des¸ùt‹
->
b_d©a
);

607 
ègp
 = &
des¸ùt‹
->
b_d©a
[(
jou∫Æ_hódî_t
)];

608 
•a˚_À·
 = 
des¸ùt‹
->
b_size
 -

609 (
jou∫Æ_hódî_t
);

610 
fú°_èg
 = 1;

611 
	`£t_buf„r_jwrôe
(
des¸ùt‹
);

612 
	`£t_buf„r_dúty
(
des¸ùt‹
);

613 
wbuf
[
bufs
++] = 
des¸ùt‹
;

617 
	`BUFFER_TRACE
(
des¸ùt‹
, "ph3: fileás descriptor");

618 
	`jbd3_fûe_log_bh
(&
log_bufs
, 
des¸ùt‹
);

623 
îr
 = 
	`jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ
, &
blockƒ
);

627 i‡(
îr
) {

628 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

637 
	`©omic_dec
(&
commô_å™ß˘i⁄
->
t_out°™dög_¸edôs
);

642 
	`©omic_öc
(&
	`jh2bh
(
jh
)->
b_cou¡
);

648 
	`£t_bô
(
BH_JWrôe
, &
	`jh2bh
(
jh
)->
b_°©e
);

649 
	`JBUFFER_TRACE
(
jh
, "ph3: write metadata");

650 
Êags
 = 
	`jbd3_jou∫Æ_wrôe_mëad©a_buf„r
(
commô_å™ß˘i⁄
,

651 
jh
, &
wbuf
[
bufs
], 
blockƒ
);

652 i‡(
Êags
 < 0) {

653 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
Êags
);

656 
	`jbd3_fûe_log_bh
(&
io_bufs
, 
wbuf
[
bufs
]);

661 
èg_Êag
 = 0;

662 i‡(
Êags
 & 1)

663 
èg_Êag
 |
JBD3_FLAG_ESCAPE
;

664 i‡(!
fú°_èg
)

665 
èg_Êag
 |
JBD3_FLAG_SAME_UUID
;

667 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

668 
	`wrôe_èg_block
(
jou∫Æ
, 
èg
, 
	`jh2bh
(
jh
)->
b_blockƒ
);

669 
èg
->
t_Êags
 = 
	`˝u_to_be16
(
èg_Êag
);

670 
	`jbd3_block_èg_csum_£t
(
jou∫Æ
, 
èg
, 
wbuf
[
bufs
],

671 
commô_å™ß˘i⁄
->
t_tid
);

672 
ègp
 +
èg_byãs
;

673 
•a˚_À·
 -
èg_byãs
;

674 
bufs
++;

676 i‡(
fú°_èg
) {

677 
	`mem˝y
 (
ègp
, 
jou∫Æ
->
j_uuid
, 16);

678 
ègp
 += 16;

679 
•a˚_À·
 -= 16;

680 
fú°_èg
 = 0;

686 i‡(
bufs
 =
jou∫Æ
->
j_wbufsize
 ||

687 
commô_å™ß˘i⁄
->
t_buf„rs
 =
NULL
 ||

688 
•a˚_À·
 < 
èg_byãs
 + 16 + 
csum_size
) {

690 
	`jbd_debug
(4, "JBD3: Submô %d IOs\n", 
bufs
);

696 
èg
->
t_Êags
 |
	`˝u_to_be16
(
JBD3_FLAG_LAST_TAG
);

697 
°¨t_jou∫Æ_io
:

698 i‡(
des¸ùt‹
)

699 
	`jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ
,

700 
des¸ùt‹
);

702 
i
 = 0; i < 
bufs
; i++) {

703 
buf„r_hód
 *
bh
 = 
wbuf
[
i
];

707 i‡(
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

708 
¸c32_sum
 =

709 
	`jbd3_checksum_d©a
(
¸c32_sum
, 
bh
);

712 
	`lock_buf„r
(
bh
);

713 
	`˛ór_buf„r_dúty
(
bh
);

714 
	`£t_buf„r_u±od©e
(
bh
);

715 
bh
->
b_íd_io
 = 
jou∫Æ_íd_buf„r_io_sync
;

716 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
, 
bh
);

718 
	`c⁄d_ªsched
();

719 
°©s
.
run
.
rs_blocks_logged
 +
bufs
;

723 
des¸ùt‹
 = 
NULL
;

724 
bufs
 = 0;

728 
îr
 = 
	`jou∫Æ_föish_öode_d©a_buf„rs
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

729 i‡(
îr
) {

730 
	`¥ötk
(
KERN_WARNING


732 "⁄ %s\n", 
jou∫Æ
->
j_dev«me
);

733 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT_ON_SYNCDATA_ERR
)

734 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

735 
îr
 = 0;

745 
upd©e_èû
 =

746 
	`jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ
, &
fú°_tid
, &
fú°_block
);

748 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

749 i‡(
upd©e_èû
) {

750 
‰ìd
 = 
fú°_block
 - 
jou∫Æ
->
j_èû
;

752 i‡(
fú°_block
 < 
jou∫Æ
->
j_èû
)

753 
‰ìd
 +
jou∫Æ
->
j_œ°
 - jou∫Æ->
j_fú°
;

755 i‡(
‰ìd
 < 
jou∫Æ
->
j_maxÀn
 / 4)

756 
upd©e_èû
 = 0;

758 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT
);

759 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_DFLUSH
;

760 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

767 i‡(
commô_å™ß˘i⁄
->
t_√ed_d©a_Êush
 &&

768 (
jou∫Æ
->
j_fs_dev
 !jou∫Æ->
j_dev
) &&

769 (
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

770 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_NOFS
, 
NULL
);

773 i‡(
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

774 
îr
 = 
	`jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ
, 
commô_å™ß˘i⁄
,

775 &
cbh
, 
¸c32_sum
);

776 i‡(
îr
)

777 
	`__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ
);

780 
	`blk_föish_∂ug
(&
∂ug
);

793 
	`jbd_debug
(3, "JBD3: commitÖhase 3\n");

795 !
	`li°_em±y
(&
io_bufs
)) {

796 
buf„r_hód
 *
bh
 = 
	`li°_íåy
(
io_bufs
.
¥ev
,

797 
buf„r_hód
,

798 
b_assoc_buf„rs
);

800 
	`waô_⁄_buf„r
(
bh
);

801 
	`c⁄d_ªsched
();

803 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

804 
îr
 = -
EIO
;

805 
	`jbd3_unfûe_log_bh
(
bh
);

811 
	`BUFFER_TRACE
(
bh
, "dumpingÅemporary bh");

812 
	`__bªl£
(
bh
);

813 
	`J_ASSERT_BH
(
bh
, 
	`©omic_ªad
(&bh->
b_cou¡
) == 0);

814 
	`‰ì_buf„r_hód
(
bh
);

817 
jh
 = 
commô_å™ß˘i⁄
->
t_shadow_li°
->
b_çªv
;

818 
bh
 = 
	`jh2bh
(
jh
);

819 
	`˛ór_buf„r_jwrôe
(
bh
);

820 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_jbddúty
(bh));

821 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_shadow
(bh));

827 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Forget");

828 
	`jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
commô_å™ß˘i⁄
, 
BJ_F‹gë
);

829 
	`JBUFFER_TRACE
(
jh
, "brelse shadowed buffer");

830 
	`__bªl£
(
bh
);

833 
	`J_ASSERT
 (
commô_å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

835 
	`jbd_debug
(3, "JBD3: commitÖhase 4\n");

838 !
	`li°_em±y
(&
log_bufs
)) {

839 
buf„r_hód
 *
bh
;

841 
bh
 = 
	`li°_íåy
(
log_bufs
.
¥ev
, 
buf„r_hód
, 
b_assoc_buf„rs
);

842 
	`waô_⁄_buf„r
(
bh
);

843 
	`c⁄d_ªsched
();

845 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

846 
îr
 = -
EIO
;

848 
	`BUFFER_TRACE
(
bh
, "ph5: control buffer writeout done: unfile");

849 
	`˛ór_buf„r_jwrôe
(
bh
);

850 
	`jbd3_unfûe_log_bh
(
bh
);

851 
	`__bªl£
(
bh
);

855 i‡(
îr
)

856 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

858 
	`jbd_debug
(3, "JBD3: commitÖhase 5\n");

859 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

860 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT_DFLUSH
);

861 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_JFLUSH
;

862 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

864 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

865 
îr
 = 
	`jou∫Æ_submô_commô_ªc‹d
(
jou∫Æ
, 
commô_å™ß˘i⁄
,

866 &
cbh
, 
¸c32_sum
);

867 i‡(
îr
)

868 
	`__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ
);

870 i‡(
cbh
)

871 
îr
 = 
	`jou∫Æ_waô_⁄_commô_ªc‹d
(
jou∫Æ
, 
cbh
);

872 i‡(
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
) &&

873 
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
) {

874 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_dev
, 
GFP_NOFS
, 
NULL
);

877 i‡(
îr
)

878 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
îr
);

885 i‡(
upd©e_èû
)

886 
	`jbd3_upd©e_log_èû
(
jou∫Æ
, 
fú°_tid
, 
fú°_block
);

893 
	`jbd_debug
(3, "JBD3: commitÖhase 6\n");

895 
	`J_ASSERT
(
	`li°_em±y
(&
commô_å™ß˘i⁄
->
t_öode_li°
));

896 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_buf„rs
 =
NULL
);

897 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
);

898 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_shadow_li°
 =
NULL
);

900 
ª°¨t_lo›
:

905 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

906 
commô_å™ß˘i⁄
->
t_f‹gë
) {

907 
å™ß˘i⁄_t
 *
˝_å™ß˘i⁄
;

908 
buf„r_hód
 *
bh
;

909 
åy_to_‰ì
 = 0;

911 
jh
 = 
commô_å™ß˘i⁄
->
t_f‹gë
;

912 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

913 
bh
 = 
	`jh2bh
(
jh
);

918 
	`gë_bh
(
bh
);

919 
	`jbd_lock_bh_°©e
(
bh
);

920 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
commô_å™ß˘i⁄
);

935 i‡(
jh
->
b_commôãd_d©a
) {

936 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
bh
->
b_size
);

937 
jh
->
b_commôãd_d©a
 = 
NULL
;

938 i‡(
jh
->
b_‰ozí_d©a
) {

939 
jh
->
b_commôãd_d©a
 = jh->
b_‰ozí_d©a
;

940 
jh
->
b_‰ozí_d©a
 = 
NULL
;

941 
jh
->
b_‰ozí_åiggîs
 = 
NULL
;

943 } i‡(
jh
->
b_‰ozí_d©a
) {

944 
	`jbd3_‰ì
(
jh
->
b_‰ozí_d©a
, 
bh
->
b_size
);

945 
jh
->
b_‰ozí_d©a
 = 
NULL
;

946 
jh
->
b_‰ozí_åiggîs
 = 
NULL
;

949 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

950 
˝_å™ß˘i⁄
 = 
jh
->
b_˝_å™ß˘i⁄
;

951 i‡(
˝_å™ß˘i⁄
) {

952 
	`JBUFFER_TRACE
(
jh
, "remove from old cpÅransaction");

953 
˝_å™ß˘i⁄
->
t_chp_°©s
.
cs_dr›≥d
++;

954 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

967 i‡(
	`buf„r_‰ìd
(
bh
)) {

983 
jh
->
b_modifõd
 = 0;

984 i‡(!
jh
->
b_√xt_å™ß˘i⁄
) {

985 
	`˛ór_buf„r_‰ìd
(
bh
);

986 
	`˛ór_buf„r_jbddúty
(
bh
);

987 
	`˛ór_buf„r_m≠≥d
(
bh
);

988 
	`˛ór_buf„r_√w
(
bh
);

989 
	`˛ór_buf„r_ªq
(
bh
);

990 
bh
->
b_bdev
 = 
NULL
;

994 i‡(
	`buf„r_jbddúty
(
bh
)) {

995 
	`JBUFFER_TRACE
(
jh
, "addÅoÇew checkpointingÅrans");

996 
	`__jbd3_jou∫Æ_ö£π_checkpoöt
(
jh
, 
commô_å™ß˘i⁄
);

997 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

998 
	`˛ór_buf„r_jbddúty
(
bh
);

1000 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_dúty
(bh));

1010 i‡(!
jh
->
b_√xt_å™ß˘i⁄
)

1011 
åy_to_‰ì
 = 1;

1013 
	`JBUFFER_TRACE
(
jh
, "refile or unfile buffer");

1014 
	`__jbd3_jou∫Æ_ªfûe_buf„r
(
jh
);

1015 
	`jbd_u∆ock_bh_°©e
(
bh
);

1016 i‡(
åy_to_‰ì
)

1017 
	`ªÀa£_buf„r_∑ge
(
bh
);

1019 
	`__bªl£
(
bh
);

1020 
	`c⁄d_ªsched_lock
(&
jou∫Æ
->
j_li°_lock
);

1022 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1029 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1030 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1035 i‡(
commô_å™ß˘i⁄
->
t_f‹gë
) {

1036 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1037 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1038 
ª°¨t_lo›
;

1044 i‡(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
NULL
) {

1045 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 = 
commô_å™ß˘i⁄
;

1046 
commô_å™ß˘i⁄
->
t_˝√xt
 = commit_transaction;

1047 
commô_å™ß˘i⁄
->
t_˝¥ev
 = commit_transaction;

1049 
commô_å™ß˘i⁄
->
t_˝√xt
 =

1050 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

1051 
commô_å™ß˘i⁄
->
t_˝¥ev
 =

1052 
commô_å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
;

1053 
commô_å™ß˘i⁄
->
t_˝√xt
->
t_˝¥ev
 =

1054 
commô_å™ß˘i⁄
;

1055 
commô_å™ß˘i⁄
->
t_˝¥ev
->
t_˝√xt
 =

1056 
commô_å™ß˘i⁄
;

1058 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1062 
	`jbd_debug
(3, "JBD3: commitÖhase 7\n");

1064 
	`J_ASSERT
(
commô_å™ß˘i⁄
->
t_°©e
 =
T_COMMIT_JFLUSH
);

1066 
commô_å™ß˘i⁄
->
t_°¨t
 = 
jiffõs
;

1067 
°©s
.
run
.
rs_loggög
 = 
	`jbd3_time_diff
(stats.run.rs_logging,

1068 
commô_å™ß˘i⁄
->
t_°¨t
);

1073 
°©s
.
ts_tid
 = 
commô_å™ß˘i⁄
->
t_tid
;

1074 
°©s
.
run
.
rs_h™dÀ_cou¡
 =

1075 
	`©omic_ªad
(&
commô_å™ß˘i⁄
->
t_h™dÀ_cou¡
);

1076 
	`åa˚_jbd3_run_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

1077 
commô_å™ß˘i⁄
->
t_tid
, &
°©s
.
run
);

1078 
°©s
.
ts_ªque°ed
 = (
commô_å™ß˘i⁄
->
t_ªque°ed
) ? 1 : 0;

1080 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_COMMIT_CALLBACK
;

1081 
	`J_ASSERT
(
commô_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

1082 
jou∫Æ
->
j_commô_£quí˚
 = 
commô_å™ß˘i⁄
->
t_tid
;

1083 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 = 
NULL
;

1084 
commô_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(), 
°¨t_time
));

1090 i‡(
	`likñy
(
jou∫Æ
->
j_avîage_commô_time
))

1091 
jou∫Æ
->
j_avîage_commô_time
 = (
commô_time
 +

1092 
jou∫Æ
->
j_avîage_commô_time
*3) / 4;

1094 
jou∫Æ
->
j_avîage_commô_time
 = 
commô_time
;

1096 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1098 i‡(
jou∫Æ
->
j_commô_ˇŒback
)

1099 
jou∫Æ
->
	`j_commô_ˇŒback
(jou∫Æ, 
commô_å™ß˘i⁄
);

1101 
	`åa˚_jbd3_íd_commô
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

1102 
	`jbd_debug
(1, "JBD3: commit %d complete, head %d\n",

1103 
jou∫Æ
->
j_commô_£quí˚
, jou∫Æ->
j_èû_£quí˚
);

1105 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1106 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1107 
commô_å™ß˘i⁄
->
t_°©e
 = 
T_FINISHED
;

1109 i‡(
commô_å™ß˘i⁄
->
t_checkpoöt_li°
 =
NULL
 &&

1110 
commô_å™ß˘i⁄
->
t_checkpoöt_io_li°
 =
NULL
) {

1111 
	`__jbd3_jou∫Æ_dr›_å™ß˘i⁄
(
jou∫Æ
, 
commô_å™ß˘i⁄
);

1112 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
commô_å™ß˘i⁄
);

1114 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1115 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1116 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

1121 
	`•ö_lock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1122 
jou∫Æ
->
j_°©s
.
ts_tid
++;

1123 
jou∫Æ
->
j_°©s
.
ts_ªque°ed
 +
°©s
.ts_requested;

1124 
jou∫Æ
->
j_°©s
.
run
.
rs_waô
 +
°©s
.run.rs_wait;

1125 
jou∫Æ
->
j_°©s
.
run
.
rs_ªque°_dñay
 +
°©s
.run.rs_request_delay;

1126 
jou∫Æ
->
j_°©s
.
run
.
rs_ru¬ög
 +
°©s
.run.rs_running;

1127 
jou∫Æ
->
j_°©s
.
run
.
rs_locked
 +
°©s
.run.rs_locked;

1128 
jou∫Æ
->
j_°©s
.
run
.
rs_Êushög
 +
°©s
.run.rs_flushing;

1129 
jou∫Æ
->
j_°©s
.
run
.
rs_loggög
 +
°©s
.run.rs_logging;

1130 
jou∫Æ
->
j_°©s
.
run
.
rs_h™dÀ_cou¡
 +
°©s
.run.rs_handle_count;

1131 
jou∫Æ
->
j_°©s
.
run
.
rs_blocks
 +
°©s
.run.rs_blocks;

1132 
jou∫Æ
->
j_°©s
.
run
.
rs_blocks_logged
 +
°©s
.run.rs_blocks_logged;

1133 
	`•ö_u∆ock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1134 
	}
}

	@jbd3/jbd3.mod.c

1 
	~<löux/buûd-ß….h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/vîmagic.h
>

4 
	~<löux/compûî.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

11 
__visibÀ
 
moduÀ
 
__this_moduÀ


12 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

13 .
«me
 = 
KBUILD_MODNAME
,

14 .
	göô
 = 
öô_moduÀ
,

15 #ifde‡
CONFIG_MODULE_UNLOAD


16 .
	gexô
 = 
˛ónup_moduÀ
,

18 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

21 #ifde‡
CONFIG_RETPOLINE


22 
MODULE_INFO
(
ªçﬁöe
, "Y");

25 c⁄° 
	g__moduÀ_dïíds
[]

26 
__u£d


27 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

31 
MODULE_INFO
(
§cvîsi⁄
, "EFBBFAF13E886D603FAED2E");

	@jbd3/journal.c

22 
	~<löux/moduÀ.h
>

23 
	~<löux/time.h
>

24 
	~<löux/fs.h
>

25 
	~<löux/jbd3.h
>

26 
	~<löux/î∫o.h
>

27 
	~<löux/¶ab.h
>

28 
	~<löux/öô.h
>

29 
	~<löux/mm.h
>

30 
	~<löux/‰ìzî.h
>

31 
	~<löux/∑gem≠.h
>

32 
	~<löux/kthªad.h
>

33 
	~<löux/pois⁄.h
>

34 
	~<löux/¥oc_fs.h
>

35 
	~<löux/£q_fûe.h
>

36 
	~<löux/m©h64.h
>

37 
	~<löux/hash.h
>

38 
	~<löux/log2.h
>

39 
	~<löux/vmÆloc.h
>

40 
	~<löux/backög-dev.h
>

41 
	~<löux/bô›s.h
>

42 
	~<löux/øãlimô.h
>

43 
	~<löux/sched/mm.h
>

45 
	#CREATE_TRACE_POINTS


	)

46 
	~<åa˚/evíts/jbd3.h
>

48 
	~<löux/uac˚ss.h
>

49 
	~<asm/∑ge.h
>

51 #ifde‡
CONFIG_JBD3_DEBUG


52 
ush‹t
 
jbd3_jou∫Æ_íabÀ_debug
 
	g__ªad_mo°ly
;

53 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_íabÀ_debug
);

55 
moduÀ_∑øm_«med
(
jbd3_debug
, 
jbd3_jou∫Æ_íabÀ_debug
, 
ush‹t
, 0644);

56 
MODULE_PARM_DESC
(
jbd3_debug
, "DebuggingÜevel for jbd3");

59 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_exãnd
);

60 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°›
);

61 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_lock_upd©es
);

62 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_u∆ock_upd©es
);

63 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_wrôe_ac˚ss
);

64 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_¸óã_ac˚ss
);

65 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_gë_undo_ac˚ss
);

66 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_£t_åiggîs
);

67 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_dúty_mëad©a
);

68 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹gë
);

70 
EXPORT_SYMBOL
(
jou∫Æ_sync_buf„r
);

72 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_Êush
);

73 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ªvoke
);

75 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_dev
);

76 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_öode
);

77 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_check_u£d_„©uªs
);

78 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs
);

79 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_£t_„©uªs
);

80 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_lﬂd
);

81 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_de°roy
);

82 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ab‹t
);

83 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_î∫o
);

84 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ack_îr
);

85 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_˛ór_îr
);

86 
EXPORT_SYMBOL
(
jbd3_log_waô_commô
);

87 
EXPORT_SYMBOL
(
jbd3_log_°¨t_commô
);

88 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t_commô
);

89 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹˚_commô_√°ed
);

90 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_wùe
);

91 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_blocks_≥r_∑ge
);

92 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_övÆid©ïage
);

93 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_åy_to_‰ì_buf„rs
);

94 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_f‹˚_commô
);

95 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öode_add_wrôe
);

96 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öode_add_waô
);

97 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_öô_jbd_öode
);

98 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ªÀa£_jbd_öode
);

99 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_begö_‹dîed_åunˇã
);

100 
EXPORT_SYMBOL
(
jbd3_öode_ˇche
);

102 
__jou∫Æ_ab‹t_so·
 (
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
);

103 
jbd3_jou∫Æ_¸óã_¶ab
(
size_t
 
¶ab_size
);

105 #ifde‡
CONFIG_JBD3_DEBUG


106 
	$__jbd3_debug
(
Àvñ
, c⁄° *
fûe
, c⁄° *
func
,

107 
löe
, c⁄° *
fmt
, ...)

109 
va_f‹m©
 
vaf
;

110 
va_li°
 
¨gs
;

112 i‡(
Àvñ
 > 
jbd3_jou∫Æ_íabÀ_debug
)

114 
	`va_°¨t
(
¨gs
, 
fmt
);

115 
vaf
.
fmt
 = fmt;

116 
vaf
.
va
 = &
¨gs
;

117 
	`¥ötk
(
KERN_DEBUG
 "%s: (%s, %u): %pV", 
fûe
, 
func
, 
löe
, &
vaf
);

118 
	`va_íd
(
¨gs
);

119 
	}
}

120 
EXPORT_SYMBOL
(
__jbd3_debug
);

124 
	$jbd3_vîify_csum_ty≥
(
jou∫Æ_t
 *
j
, 
jou∫Æ_su≥rblock_t
 *
sb
)

126 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
j
))

129  
sb
->
s_checksum_ty≥
 =
JBD3_CRC32C_CHKSUM
;

130 
	}
}

132 
__be32
 
	$jbd3_su≥rblock_csum
(
jou∫Æ_t
 *
j
, 
jou∫Æ_su≥rblock_t
 *
sb
)

134 
__u32
 
csum
;

135 
__be32
 
ﬁd_csum
;

137 
ﬁd_csum
 = 
sb
->
s_checksum
;

138 
sb
->
s_checksum
 = 0;

139 
csum
 = 
	`jbd3_chksum
(
j
, ~0, (*)
sb
, (
jou∫Æ_su≥rblock_t
));

140 
sb
->
s_checksum
 = 
ﬁd_csum
;

142  
	`˝u_to_be32
(
csum
);

143 
	}
}

149 
	$commô_timeout
(
timî_li°
 *
t
)

151 
jou∫Æ_t
 *
jou∫Æ
 = 
	`‰om_timî
(jou∫Æ, 
t
, 
j_commô_timî
);

153 
	`wake_up_¥o˚ss
(
jou∫Æ
->
j_èsk
);

154 
	}
}

172 
	$kjou∫Æd2
(*
¨g
)

174 
jou∫Æ_t
 *
jou∫Æ
 = 
¨g
;

175 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

181 
	`timî_£tup
(&
jou∫Æ
->
j_commô_timî
, 
commô_timeout
, 0);

183 
	`£t_‰ìzabÀ
();

186 
jou∫Æ
->
j_èsk
 = 
cuºít
;

187 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

195 
	`memÆloc_nofs_ßve
();

200 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

202 
lo›
:

203 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
)

204 
íd_lo›
;

206 
	`jbd_debug
(1, "commit_sequence=%d, commit_request=%d\n",

207 
jou∫Æ
->
j_commô_£quí˚
, jou∫Æ->
j_commô_ªque°
);

209 i‡(
jou∫Æ
->
j_commô_£quí˚
 !jou∫Æ->
j_commô_ªque°
) {

210 
	`jbd_debug
(1, "OK,Ñequests differ\n");

211 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

212 
	`dñ_timî_sync
(&
jou∫Æ
->
j_commô_timî
);

213 
	`jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ
);

214 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

215 
lo›
;

218 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

219 i‡(
	`‰ìzög
(
cuºít
)) {

225 
	`jbd_debug
(1, "Now suspending kjournald2\n");

226 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

227 
	`åy_to_‰ìze
();

228 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

234 
	`DEFINE_WAIT
(
waô
);

235 
should_¶ìp
 = 1;

237 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_commô
, &
waô
,

238 
TASK_INTERRUPTIBLE
);

239 i‡(
jou∫Æ
->
j_commô_£quí˚
 !jou∫Æ->
j_commô_ªque°
)

240 
should_¶ìp
 = 0;

241 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

242 i‡(
å™ß˘i⁄
 && 
	`time_a·î_eq
(
jiffõs
,

243 
å™ß˘i⁄
->
t_expúes
))

244 
should_¶ìp
 = 0;

245 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
)

246 
should_¶ìp
 = 0;

247 i‡(
should_¶ìp
) {

248 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

249 
	`scheduÀ
();

250 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

252 
	`föish_waô
(&
jou∫Æ
->
j_waô_commô
, &
waô
);

255 
	`jbd_debug
(1, "kjournald2 wakes\n");

260 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

261 i‡(
å™ß˘i⁄
 && 
	`time_a·î_eq
(
jiffõs
,Åønß˘i⁄->
t_expúes
)) {

262 
jou∫Æ
->
j_commô_ªque°
 = 
å™ß˘i⁄
->
t_tid
;

263 
	`jbd_debug
(1, "woke because ofÅimeout\n");

265 
lo›
;

267 
íd_lo›
:

268 
	`dñ_timî_sync
(&
jou∫Æ
->
j_commô_timî
);

269 
jou∫Æ
->
j_èsk
 = 
NULL
;

270 
	`wake_up
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

271 
	`jbd_debug
(1, "JournalÅhreadÉxiting.\n");

272 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

274 
	}
}

276 
	$jbd3_jou∫Æ_°¨t_thªad
(
jou∫Æ_t
 *
jou∫Æ
)

278 
èsk_°ru˘
 *
t
;

280 
t
 = 
	`kthªad_run
(
kjou∫Æd2
, 
jou∫Æ
, "jbd3/%s",

281 
jou∫Æ
->
j_dev«me
);

282 i‡(
	`IS_ERR
(
t
))

283  
	`PTR_ERR
(
t
);

285 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
, jou∫Æ->
j_èsk
 !
NULL
);

287 
	}
}

289 
	$jou∫Æ_kûl_thªad
(
jou∫Æ_t
 *
jou∫Æ
)

291 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

292 
jou∫Æ
->
j_Êags
 |
JBD3_UNMOUNT
;

294 
jou∫Æ
->
j_èsk
) {

295 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

296 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

297 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
, jou∫Æ->
j_èsk
 =
NULL
);

298 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

300 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

301 
	}
}

338 
	$jbd3_jou∫Æ_wrôe_mëad©a_buf„r
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

339 
jou∫Æ_hód
 *
jh_ö
,

340 
buf„r_hód
 **
bh_out
,

341 
£˘‹_t
 
blockƒ
)

343 
√ed_c›y_out
 = 0;

344 
d⁄e_c›y_out
 = 0;

345 
do_esˇ≥
 = 0;

346 *
m≠≥d_d©a
;

347 
buf„r_hód
 *
√w_bh
;

348 
∑ge
 *
√w_∑ge
;

349 
√w_off£t
;

350 
buf„r_hód
 *
bh_ö
 = 
	`jh2bh
(
jh_ö
);

351 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

362 
	`J_ASSERT_BH
(
bh_ö
, 
	`buf„r_jbddúty
(bh_in));

364 
√w_bh
 = 
	`Æloc_buf„r_hód
(
GFP_NOFS
|
__GFP_NOFAIL
);

367 
	`©omic_£t
(&
√w_bh
->
b_cou¡
, 1);

369 
	`jbd_lock_bh_°©e
(
bh_ö
);

370 
ª≥©
:

375 i‡(
jh_ö
->
b_‰ozí_d©a
) {

376 
d⁄e_c›y_out
 = 1;

377 
√w_∑ge
 = 
	`vút_to_∑ge
(
jh_ö
->
b_‰ozí_d©a
);

378 
√w_off£t
 = 
	`off£t_ö_∑ge
(
jh_ö
->
b_‰ozí_d©a
);

380 
√w_∑ge
 = 
	`jh2bh
(
jh_ö
)->
b_∑ge
;

381 
√w_off£t
 = 
	`off£t_ö_∑ge
(
	`jh2bh
(
jh_ö
)->
b_d©a
);

384 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

391 i‡(!
d⁄e_c›y_out
)

392 
	`jbd3_buf„r_‰ozí_åiggî
(
jh_ö
, 
m≠≥d_d©a
 + 
√w_off£t
,

393 
jh_ö
->
b_åiggîs
);

398 i‡(*((
__be32
 *)(
m≠≥d_d©a
 + 
√w_off£t
)) ==

399 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
)) {

400 
√ed_c›y_out
 = 1;

401 
do_esˇ≥
 = 1;

403 
	`kunm≠_©omic
(
m≠≥d_d©a
);

408 i‡(
√ed_c›y_out
 && !
d⁄e_c›y_out
) {

409 *
tmp
;

411 
	`jbd_u∆ock_bh_°©e
(
bh_ö
);

412 
tmp
 = 
	`jbd3_Æloc
(
bh_ö
->
b_size
, 
GFP_NOFS
);

413 i‡(!
tmp
) {

414 
	`bªl£
(
√w_bh
);

415  -
ENOMEM
;

417 
	`jbd_lock_bh_°©e
(
bh_ö
);

418 i‡(
jh_ö
->
b_‰ozí_d©a
) {

419 
	`jbd3_‰ì
(
tmp
, 
bh_ö
->
b_size
);

420 
ª≥©
;

423 
jh_ö
->
b_‰ozí_d©a
 = 
tmp
;

424 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

425 
	`mem˝y
(
tmp
, 
m≠≥d_d©a
 + 
√w_off£t
, 
bh_ö
->
b_size
);

426 
	`kunm≠_©omic
(
m≠≥d_d©a
);

428 
√w_∑ge
 = 
	`vút_to_∑ge
(
tmp
);

429 
√w_off£t
 = 
	`off£t_ö_∑ge
(
tmp
);

430 
d⁄e_c›y_out
 = 1;

437 
jh_ö
->
b_‰ozí_åiggîs
 = jh_ö->
b_åiggîs
;

444 i‡(
do_esˇ≥
) {

445 
m≠≥d_d©a
 = 
	`km≠_©omic
(
√w_∑ge
);

446 *((*)(
m≠≥d_d©a
 + 
√w_off£t
)) = 0;

447 
	`kunm≠_©omic
(
m≠≥d_d©a
);

450 
	`£t_bh_∑ge
(
√w_bh
, 
√w_∑ge
, 
√w_off£t
);

451 
√w_bh
->
b_size
 = 
bh_ö
->b_size;

452 
√w_bh
->
b_bdev
 = 
jou∫Æ
->
j_dev
;

453 
√w_bh
->
b_blockƒ
 = 
blockƒ
;

454 
√w_bh
->
b_¥iv©e
 = 
bh_ö
;

455 
	`£t_buf„r_m≠≥d
(
√w_bh
);

456 
	`£t_buf„r_dúty
(
√w_bh
);

458 *
bh_out
 = 
√w_bh
;

465 
	`JBUFFER_TRACE
(
jh_ö
, "fileás BJ_Shadow");

466 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

467 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh_ö
, 
å™ß˘i⁄
, 
BJ_Shadow
);

468 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

469 
	`£t_buf„r_shadow
(
bh_ö
);

470 
	`jbd_u∆ock_bh_°©e
(
bh_ö
);

472  
do_esˇ≥
 | (
d⁄e_c›y_out
 << 1);

473 
	}
}

484 
	$__jbd3_log_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
èrgë
)

487 i‡(
jou∫Æ
->
j_commô_ªque°
 =
èrgë
)

495 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

496 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
èrgë
) {

502 
jou∫Æ
->
j_commô_ªque°
 = 
èrgë
;

503 
	`jbd_debug
(1, "JBD3:Ñequesting commit %d/%d\n",

504 
jou∫Æ
->
j_commô_ªque°
,

505 
jou∫Æ
->
j_commô_£quí˚
);

506 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_ªque°ed
 = 
jiffõs
;

507 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

509 } i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
èrgë
))

513 
	`WARN_ONCE
(1, "JBD3: badÜog_start_commit: %u %u %u %u\n",

514 
jou∫Æ
->
j_commô_ªque°
,

515 
jou∫Æ
->
j_commô_£quí˚
,

516 
èrgë
, 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ?

517 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 : 0);

519 
	}
}

521 
	$jbd3_log_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

523 
ªt
;

525 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

526 
ªt
 = 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

527 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

528  
ªt
;

529 
	}
}

538 
	$__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

540 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
NULL
;

541 
tid_t
 
tid
;

542 
√ed_to_°¨t
 = 0, 
ªt
 = 0;

544 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

545 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 && !
cuºít
->
jou∫Æ_öfo
) {

546 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

547 i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
å™ß˘i⁄
->
t_tid
))

548 
√ed_to_°¨t
 = 1;

549 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

550 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

552 i‡(!
å™ß˘i⁄
) {

554 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

557 
tid
 = 
å™ß˘i⁄
->
t_tid
;

558 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

559 i‡(
√ed_to_°¨t
)

560 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

561 
ªt
 = 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

562 i‡(!
ªt
)

563 
ªt
 = 1;

565  
ªt
;

566 
	}
}

576 
	$jbd3_jou∫Æ_f‹˚_commô_√°ed
(
jou∫Æ_t
 *
jou∫Æ
)

578 
ªt
;

580 
ªt
 = 
	`__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

581  
ªt
 > 0;

582 
	}
}

591 
	$jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

593 
ªt
;

595 
	`J_ASSERT
(!
cuºít
->
jou∫Æ_öfo
);

596 
ªt
 = 
	`__jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

597 i‡(
ªt
 > 0)

598 
ªt
 = 0;

599  
ªt
;

600 
	}
}

607 
	$jbd3_jou∫Æ_°¨t_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 *
±id
)

609 
ªt
 = 0;

611 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

612 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

613 
tid_t
 
tid
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
;

615 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

618 i‡(
±id
)

619 *
±id
 = 
tid
;

620 
ªt
 = 1;

621 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

626 i‡(
±id
)

627 *
±id
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
;

628 
ªt
 = 1;

630 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

631  
ªt
;

632 
	}
}

640 
	$jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

642 
ªt
 = 0;

643 
å™ß˘i⁄_t
 *
commô_å™s
;

645 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

647 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

649 i‡(
	`tid_geq
(
jou∫Æ
->
j_commô_£quí˚
, 
tid
))

650 
out
;

651 
commô_å™s
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

652 i‡(!
commô_å™s
 || commô_å™s->
t_tid
 !
tid
) {

653 
ªt
 = 1;

654 
out
;

660 i‡(
jou∫Æ
->
j_fs_dev
 !jou∫Æ->
j_dev
) {

661 i‡(!
commô_å™s
->
t_√ed_d©a_Êush
 ||

662 
commô_å™s
->
t_°©e
 >
T_COMMIT_DFLUSH
)

663 
out
;

665 i‡(
commô_å™s
->
t_°©e
 >
T_COMMIT_JFLUSH
)

666 
out
;

668 
ªt
 = 1;

669 
out
:

670 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

671  
ªt
;

672 
	}
}

673 
EXPORT_SYMBOL
(
jbd3_å™s_wûl_£nd_d©a_b¨rõr
);

679 
	$jbd3_log_waô_commô
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

681 
îr
 = 0;

683 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

684 #ifde‡
CONFIG_PROVE_LOCKING


690 i‡(
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
) &&

691 (!
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 ||

692 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 !
tid
)) {

693 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

694 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

695 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

698 #ifde‡
CONFIG_JBD3_DEBUG


699 i‡(!
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
)) {

700 
	`¥ötk
(
KERN_ERR


702 
__func__
, 
jou∫Æ
->
j_commô_ªque°
, 
tid
);

705 
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
)) {

706 
	`jbd_debug
(1, "JBD3: want %d, j_commit_sequence=%d\n",

707 
tid
, 
jou∫Æ
->
j_commô_£quí˚
);

708 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

709 
	`wake_up
(&
jou∫Æ
->
j_waô_commô
);

710 
	`waô_evít
(
jou∫Æ
->
j_waô_d⁄e_commô
,

711 !
	`tid_gt
(
tid
, 
jou∫Æ
->
j_commô_£quí˚
));

712 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

714 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

716 i‡(
	`u∆ikñy
(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)))

717 
îr
 = -
EIO
;

718  
îr
;

719 
	}
}

722 
	$jbd3_å™ß˘i⁄_commôãd
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

724 
ªt
 = 1;

726 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

727 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

728 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
tid
)

729 
ªt
 = 0;

730 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

731 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 =
tid
)

732 
ªt
 = 0;

733 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

734  
ªt
;

735 
	}
}

736 
EXPORT_SYMBOL
(
jbd3_å™ß˘i⁄_commôãd
);

745 
	$jbd3_com∂ëe_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
)

747 
√ed_to_waô
 = 1;

749 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

750 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

751 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 =
tid
) {

752 i‡(
jou∫Æ
->
j_commô_ªque°
 !
tid
) {

754 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

755 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

756 
waô_commô
;

758 } i‡(!(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

759 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
->
t_tid
 =
tid
))

760 
√ed_to_waô
 = 0;

761 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

762 i‡(!
√ed_to_waô
)

764 
waô_commô
:

765  
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

766 
	}
}

767 
EXPORT_SYMBOL
(
jbd3_com∂ëe_å™ß˘i⁄
);

773 
	$jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ_t
 *
jou∫Æ
, *
ªç
)

775 
blockƒ
;

777 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

778 
	`J_ASSERT
(
jou∫Æ
->
j_‰ì
 > 1);

780 
blockƒ
 = 
jou∫Æ
->
j_hód
;

781 
jou∫Æ
->
j_hód
++;

782 
jou∫Æ
->
j_‰ì
--;

783 i‡(
jou∫Æ
->
j_hód
 =jou∫Æ->
j_œ°
)

784 
jou∫Æ
->
j_hód
 = jou∫Æ->
j_fú°
;

785 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

786  
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
blockƒ
, 
ªç
);

787 
	}
}

796 
	$jbd3_jou∫Æ_bm≠
(
jou∫Æ_t
 *
jou∫Æ
, 
blockƒ
,

797 *
ªç
)

799 
îr
 = 0;

800 
ªt
;

802 i‡(
jou∫Æ
->
j_öode
) {

803 
ªt
 = 
	`bm≠
(
jou∫Æ
->
j_öode
, 
blockƒ
);

804 i‡(
ªt
)

805 *
ªç
 = 
ªt
;

807 
	`¥ötk
(
KERN_ALERT
 "%s: journal blockÇot found "

809 
__func__
, 
blockƒ
, 
jou∫Æ
->
j_dev«me
);

810 
îr
 = -
EIO
;

811 
	`__jou∫Æ_ab‹t_so·
(
jou∫Æ
, 
îr
);

814 *
ªç
 = 
blockƒ
;

816  
îr
;

817 
	}
}

829 
buf„r_hód
 *

830 
	$jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
ty≥
)

832 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

833 
buf„r_hód
 *
bh
;

834 
blockƒ
;

835 
jou∫Æ_hódî_t
 *
hódî
;

836 
îr
;

838 
îr
 = 
	`jbd3_jou∫Æ_√xt_log_block
(
jou∫Æ
, &
blockƒ
);

840 i‡(
îr
)

841  
NULL
;

843 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

844 i‡(!
bh
)

845  
NULL
;

846 
	`lock_buf„r
(
bh
);

847 
	`mem£t
(
bh
->
b_d©a
, 0, 
jou∫Æ
->
j_blocksize
);

848 
hódî
 = (
jou∫Æ_hódî_t
 *)
bh
->
b_d©a
;

849 
hódî
->
h_magic
 = 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
);

850 
hódî
->
h_blockty≥
 = 
	`˝u_to_be32
(
ty≥
);

851 
hódî
->
h_£quí˚
 = 
	`˝u_to_be32
(
å™ß˘i⁄
->
t_tid
);

852 
	`£t_buf„r_u±od©e
(
bh
);

853 
	`u∆ock_buf„r
(
bh
);

854 
	`BUFFER_TRACE
(
bh
, "returnÅhis buffer");

855  
bh
;

856 
	}
}

858 
	$jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ_t
 *
j
, 
buf„r_hód
 *
bh
)

860 
jbd3_jou∫Æ_block_èû
 *
èû
;

861 
__u32
 
csum
;

863 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

866 
èû
 = (
jbd3_jou∫Æ_block_èû
 *)(
bh
->
b_d©a
 + 
j
->
j_blocksize
 -

867 (
jbd3_jou∫Æ_block_èû
));

868 
èû
->
t_checksum
 = 0;

869 
csum
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
bh
->
b_d©a
, j->
j_blocksize
);

870 
èû
->
t_checksum
 = 
	`˝u_to_be32
(
csum
);

871 
	}
}

883 
	$jbd3_jou∫Æ_gë_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 *
tid
,

884 *
block
)

886 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

887 
ªt
;

889 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

890 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

891 
å™ß˘i⁄
 = 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
;

892 i‡(
å™ß˘i⁄
) {

893 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

894 *
block
 = 
å™ß˘i⁄
->
t_log_°¨t
;

895 } i‡((
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
Ë!
NULL
) {

896 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

897 *
block
 = 
å™ß˘i⁄
->
t_log_°¨t
;

898 } i‡((
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
Ë!
NULL
) {

899 *
tid
 = 
å™ß˘i⁄
->
t_tid
;

900 *
block
 = 
jou∫Æ
->
j_hód
;

902 *
tid
 = 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

903 *
block
 = 
jou∫Æ
->
j_hód
;

905 
ªt
 = 
	`tid_gt
(*
tid
, 
jou∫Æ
->
j_èû_£quí˚
);

906 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

907 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

909  
ªt
;

910 
	}
}

922 
	$__jbd3_upd©e_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
, 
block
)

924 
‰ìd
;

925 
ªt
;

927 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

935 
ªt
 = 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
, 
tid
, 
block
,

936 
REQ_SYNC
 | 
REQ_FUA
);

937 i‡(
ªt
)

938 
out
;

940 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

941 
‰ìd
 = 
block
 - 
jou∫Æ
->
j_èû
;

942 i‡(
block
 < 
jou∫Æ
->
j_èû
)

943 
‰ìd
 +
jou∫Æ
->
j_œ°
 - jou∫Æ->
j_fú°
;

945 
	`åa˚_jbd3_upd©e_log_èû
(
jou∫Æ
, 
tid
, 
block
, 
‰ìd
);

946 
	`jbd_debug
(1,

949 
jou∫Æ
->
j_èû_£quí˚
, 
tid
, 
block
, 
‰ìd
);

951 
jou∫Æ
->
j_‰ì
 +
‰ìd
;

952 
jou∫Æ
->
j_èû_£quí˚
 = 
tid
;

953 
jou∫Æ
->
j_èû
 = 
block
;

954 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

956 
out
:

957  
ªt
;

958 
	}
}

965 
	$jbd3_upd©e_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
tid
, 
block
)

967 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

968 i‡(
	`tid_gt
(
tid
, 
jou∫Æ
->
j_èû_£quí˚
))

969 
	`__jbd3_upd©e_log_èû
(
jou∫Æ
, 
tid
, 
block
);

970 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

971 
	}
}

973 
	sjbd3_°©s_¥oc_£ssi⁄
 {

974 
jou∫Æ_t
 *
	mjou∫Æ
;

975 
å™ß˘i⁄_°©s_s
 *
	m°©s
;

976 
	m°¨t
;

977 
	mmax
;

980 *
	$jbd3_£q_öfo_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

982  *
pos
 ? 
NULL
 : 
SEQ_START_TOKEN
;

983 
	}
}

985 *
	$jbd3_£q_öfo_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

987  
NULL
;

988 
	}
}

990 
	$jbd3_£q_öfo_show
(
£q_fûe
 *
£q
, *
v
)

992 
jbd3_°©s_¥oc_£ssi⁄
 *
s
 = 
£q
->
¥iv©e
;

994 i‡(
v
 !
SEQ_START_TOKEN
)

996 
	`£q_¥ötf
(
£q
, "%luÅransactions (%luÑequested), "

998 
s
->
°©s
->
ts_tid
, s->°©s->
ts_ªque°ed
,

999 
s
->
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

1000 i‡(
s
->
°©s
->
ts_tid
 == 0)

1002 
	`£q_¥ötf
(
£q
, "average: \n %ums waiting forÅransaction\n",

1003 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_waô
 / s->°©s->
ts_tid
));

1004 
	`£q_¥ötf
(
£q
, " %umsÑequest delay\n",

1005 (
s
->
°©s
->
ts_ªque°ed
 == 0) ? 0 :

1006 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_ªque°_dñay
 /

1007 
s
->
°©s
->
ts_ªque°ed
));

1008 
	`£q_¥ötf
(
£q
, " %umsÑunningÅransaction\n",

1009 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_ru¬ög
 / s->°©s->
ts_tid
));

1010 
	`£q_¥ötf
(
£q
, " %umsÅransaction was beingÜocked\n",

1011 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_locked
 / s->°©s->
ts_tid
));

1012 
	`£q_¥ötf
(
£q
, " %ums flushing data (in ordered mode)\n",

1013 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_Êushög
 / s->°©s->
ts_tid
));

1014 
	`£q_¥ötf
(
£q
, " %umsÜoggingÅransaction\n",

1015 
	`jiffõs_to_m£cs
(
s
->
°©s
->
run
.
rs_loggög
 / s->°©s->
ts_tid
));

1016 
	`£q_¥ötf
(
£q
, " %lluusáverageÅransaction commitÅime\n",

1017 
	`div_u64
(
s
->
jou∫Æ
->
j_avîage_commô_time
, 1000));

1018 
	`£q_¥ötf
(
£q
, " %lu handlesÖerÅransaction\n",

1019 
s
->
°©s
->
run
.
rs_h™dÀ_cou¡
 / s->°©s->
ts_tid
);

1020 
	`£q_¥ötf
(
£q
, " %lu blocksÖerÅransaction\n",

1021 
s
->
°©s
->
run
.
rs_blocks
 / s->°©s->
ts_tid
);

1022 
	`£q_¥ötf
(
£q
, " %luÜogged blocksÖerÅransaction\n",

1023 
s
->
°©s
->
run
.
rs_blocks_logged
 / s->°©s->
ts_tid
);

1025 
	}
}

1027 
	$jbd3_£q_öfo_°›
(
£q_fûe
 *
£q
, *
v
)

1029 
	}
}

1031 c⁄° 
£q_›î©i⁄s
 
	gjbd3_£q_öfo_›s
 = {

1032 .
°¨t
 = 
jbd3_£q_öfo_°¨t
,

1033 .
	g√xt
 = 
jbd3_£q_öfo_√xt
,

1034 .
	g°›
 = 
jbd3_£q_öfo_°›
,

1035 .
	gshow
 = 
jbd3_£q_öfo_show
,

1038 
	$jbd3_£q_öfo_›í
(
öode
 *öode, 
fûe
 *file)

1040 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PDE_DATA
(
öode
);

1041 
jbd3_°©s_¥oc_£ssi⁄
 *
s
;

1042 
rc
, 
size
;

1044 
s
 = 
	`kmÆloc
((*s), 
GFP_KERNEL
);

1045 i‡(
s
 =
NULL
)

1046  -
ENOMEM
;

1047 
size
 = (
å™ß˘i⁄_°©s_s
);

1048 
s
->
°©s
 = 
	`kmÆloc
(
size
, 
GFP_KERNEL
);

1049 i‡(
s
->
°©s
 =
NULL
) {

1050 
	`k‰ì
(
s
);

1051  -
ENOMEM
;

1053 
	`•ö_lock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1054 
	`mem˝y
(
s
->
°©s
, &
jou∫Æ
->
j_°©s
, 
size
);

1055 
s
->
jou∫Æ
 = journal;

1056 
	`•ö_u∆ock
(&
jou∫Æ
->
j_hi°‹y_lock
);

1058 
rc
 = 
	`£q_›í
(
fûe
, &
jbd3_£q_öfo_›s
);

1059 i‡(
rc
 == 0) {

1060 
£q_fûe
 *
m
 = 
fûe
->
¥iv©e_d©a
;

1061 
m
->
¥iv©e
 = 
s
;

1063 
	`k‰ì
(
s
->
°©s
);

1064 
	`k‰ì
(
s
);

1066  
rc
;

1068 
	}
}

1070 
	$jbd3_£q_öfo_ªÀa£
(
öode
 *öode, 
fûe
 *file)

1072 
£q_fûe
 *
£q
 = 
fûe
->
¥iv©e_d©a
;

1073 
jbd3_°©s_¥oc_£ssi⁄
 *
s
 = 
£q
->
¥iv©e
;

1074 
	`k‰ì
(
s
->
°©s
);

1075 
	`k‰ì
(
s
);

1076  
	`£q_ªÀa£
(
öode
, 
fûe
);

1077 
	}
}

1079 c⁄° 
fûe_›î©i⁄s
 
	gjbd3_£q_öfo_f›s
 = {

1080 .
ow√r
 = 
THIS_MODULE
,

1081 .
	g›í
 = 
jbd3_£q_öfo_›í
,

1082 .
	gªad
 = 
£q_ªad
,

1083 .
	gŒ£ek
 = 
£q_l£ek
,

1084 .
	gªÀa£
 = 
jbd3_£q_öfo_ªÀa£
,

1087 
¥oc_dú_íåy
 *
	g¥oc_jbd3_°©s
;

1089 
	$jbd3_°©s_¥oc_öô
(
jou∫Æ_t
 *
jou∫Æ
)

1091 
jou∫Æ
->
j_¥oc_íåy
 = 
	`¥oc_mkdú
(jou∫Æ->
j_dev«me
, 
¥oc_jbd3_°©s
);

1092 i‡(
jou∫Æ
->
j_¥oc_íåy
) {

1093 
	`¥oc_¸óã_d©a
("öfo", 
S_IRUGO
, 
jou∫Æ
->
j_¥oc_íåy
,

1094 &
jbd3_£q_öfo_f›s
, 
jou∫Æ
);

1096 
	}
}

1098 
	$jbd3_°©s_¥oc_exô
(
jou∫Æ_t
 *
jou∫Æ
)

1100 
	`ªmove_¥oc_íåy
("öfo", 
jou∫Æ
->
j_¥oc_íåy
);

1101 
	`ªmove_¥oc_íåy
(
jou∫Æ
->
j_dev«me
, 
¥oc_jbd3_°©s
);

1102 
	}
}

1113 
jou∫Æ_t
 *
	$jou∫Æ_öô_comm⁄
(
block_devi˚
 *
bdev
,

1114 
block_devi˚
 *
fs_dev
,

1115 
°¨t
, 
Àn
, 
blocksize
)

1117 
lock_˛ass_key
 
jbd3_å™s_commô_key
;

1118 
jou∫Æ_t
 *
jou∫Æ
;

1119 
îr
;

1120 
buf„r_hód
 *
bh
;

1121 
n
;

1123 
jou∫Æ
 = 
	`kzÆloc
((*jou∫Æ), 
GFP_KERNEL
);

1124 i‡(!
jou∫Æ
)

1125  
NULL
;

1127 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

1128 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_d⁄e_commô
);

1129 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_commô
);

1130 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_upd©es
);

1131 
	`öô_waôqueue_hód
(&
jou∫Æ
->
j_waô_ª£rved
);

1132 
	`muãx_öô
(&
jou∫Æ
->
j_b¨rõr
);

1133 
	`muãx_öô
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1134 
	`•ö_lock_öô
(&
jou∫Æ
->
j_ªvoke_lock
);

1135 
	`•ö_lock_öô
(&
jou∫Æ
->
j_li°_lock
);

1136 
	`rwlock_öô
(&
jou∫Æ
->
j_°©e_lock
);

1138 
jou∫Æ
->
j_commô_öãrvÆ
 = (
HZ
 * 
JBD3_DEFAULT_MAX_COMMIT_AGE
);

1139 
jou∫Æ
->
j_mö_b©ch_time
 = 0;

1140 
jou∫Æ
->
j_max_b©ch_time
 = 15000;

1141 
	`©omic_£t
(&
jou∫Æ
->
j_ª£rved_¸edôs
, 0);

1144 
jou∫Æ
->
j_Êags
 = 
JBD3_ABORT
;

1147 
îr
 = 
	`jbd3_jou∫Æ_öô_ªvoke
(
jou∫Æ
, 
JOURNAL_REVOKE_DEFAULT_HASH
);

1148 i‡(
îr
)

1149 
îr_˛ónup
;

1151 
	`•ö_lock_öô
(&
jou∫Æ
->
j_hi°‹y_lock
);

1153 
	`lockdï_öô_m≠
(&
jou∫Æ
->
j_å™s_commô_m≠
, "jbd3_handle",

1154 &
jbd3_å™s_commô_key
, 0);

1157 
jou∫Æ
->
j_blocksize
 = 
blocksize
;

1158 
jou∫Æ
->
j_dev
 = 
bdev
;

1159 
jou∫Æ
->
j_fs_dev
 = 
fs_dev
;

1160 
jou∫Æ
->
j_blk_off£t
 = 
°¨t
;

1161 
jou∫Æ
->
j_maxÀn
 = 
Àn
;

1162 
n
 = 
jou∫Æ
->
j_blocksize
 / (
jou∫Æ_block_èg_t
);

1163 
jou∫Æ
->
j_wbufsize
 = 
n
;

1164 
jou∫Æ
->
j_wbuf
 = 
	`kmÆloc_¨øy
(
n
, (
buf„r_hód
 *),

1165 
GFP_KERNEL
);

1166 i‡(!
jou∫Æ
->
j_wbuf
)

1167 
îr_˛ónup
;

1169 
bh
 = 
	`gëblk_unmovabÀ
(
jou∫Æ
->
j_dev
, 
°¨t
, jou∫Æ->
j_blocksize
);

1170 i‡(!
bh
) {

1171 
	`¥_îr
("%s: Cannot get buffer for journal superblock\n",

1172 
__func__
);

1173 
îr_˛ónup
;

1175 
jou∫Æ
->
j_sb_buf„r
 = 
bh
;

1176 
jou∫Æ
->
j_su≥rblock
 = (
jou∫Æ_su≥rblock_t
 *)
bh
->
b_d©a
;

1178  
jou∫Æ
;

1180 
îr_˛ónup
:

1181 
	`k‰ì
(
jou∫Æ
->
j_wbuf
);

1182 
	`jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ
);

1183 
	`k‰ì
(
jou∫Æ
);

1184  
NULL
;

1185 
	}
}

1210 
jou∫Æ_t
 *
	$jbd3_jou∫Æ_öô_dev
(
block_devi˚
 *
bdev
,

1211 
block_devi˚
 *
fs_dev
,

1212 
°¨t
, 
Àn
, 
blocksize
)

1214 
jou∫Æ_t
 *
jou∫Æ
;

1216 
jou∫Æ
 = 
	`jou∫Æ_öô_comm⁄
(
bdev
, 
fs_dev
, 
°¨t
, 
Àn
, 
blocksize
);

1217 i‡(!
jou∫Æ
)

1218  
NULL
;

1220 
	`bdev«me
(
jou∫Æ
->
j_dev
, jou∫Æ->
j_dev«me
);

1221 
	`°ºïœ˚
(
jou∫Æ
->
j_dev«me
, '/', '!');

1222 
	`jbd3_°©s_¥oc_öô
(
jou∫Æ
);

1224  
jou∫Æ
;

1225 
	}
}

1235 
jou∫Æ_t
 *
	$jbd3_jou∫Æ_öô_öode
(
öode
 *inode)

1237 
jou∫Æ_t
 *
jou∫Æ
;

1238 *
p
;

1239 
blockƒ
;

1241 
blockƒ
 = 
	`bm≠
(
öode
, 0);

1242 i‡(!
blockƒ
) {

1243 
	`¥_îr
("%s: CannotÜocate journal superblock\n",

1244 
__func__
);

1245  
NULL
;

1248 
	`jbd_debug
(1, "JBD3: inode %s/%ld, size %lld, bits %d, blksize %ld\n",

1249 
öode
->
i_sb
->
s_id
, inode->
i_öo
, (Ëöode->
i_size
,

1250 
öode
->
i_sb
->
s_blocksize_bôs
, inode->i_sb->
s_blocksize
);

1252 
jou∫Æ
 = 
	`jou∫Æ_öô_comm⁄
(
öode
->
i_sb
->
s_bdev
, inode->i_sb->s_bdev,

1253 
blockƒ
, 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
,

1254 
öode
->
i_sb
->
s_blocksize
);

1255 i‡(!
jou∫Æ
)

1256  
NULL
;

1258 
jou∫Æ
->
j_öode
 = 
öode
;

1259 
	`bdev«me
(
jou∫Æ
->
j_dev
, jou∫Æ->
j_dev«me
);

1260 
p
 = 
	`°ºïœ˚
(
jou∫Æ
->
j_dev«me
, '/', '!');

1261 
	`•rötf
(
p
, "-%lu", 
jou∫Æ
->
j_öode
->
i_öo
);

1262 
	`jbd3_°©s_¥oc_öô
(
jou∫Æ
);

1264  
jou∫Æ
;

1265 
	}
}

1272 
	$jou∫Æ_Áû_su≥rblock
 (
jou∫Æ_t
 *
jou∫Æ
)

1274 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1275 
	`bªl£
(
bh
);

1276 
jou∫Æ
->
j_sb_buf„r
 = 
NULL
;

1277 
	}
}

1286 
	$jou∫Æ_ª£t
(
jou∫Æ_t
 *
jou∫Æ
)

1288 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1289 
fú°
, 
œ°
;

1291 
fú°
 = 
	`be32_to_˝u
(
sb
->
s_fú°
);

1292 
œ°
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1293 i‡(
fú°
 + 
JBD3_MIN_JOURNAL_BLOCKS
 > 
œ°
 + 1) {

1294 
	`¥ötk
(
KERN_ERR
 "JBD3: JournalÅoo short (blocks %llu-%llu).\n",

1295 
fú°
, 
œ°
);

1296 
	`jou∫Æ_Áû_su≥rblock
(
jou∫Æ
);

1297  -
EINVAL
;

1300 
jou∫Æ
->
j_fú°
 = 
fú°
;

1301 
jou∫Æ
->
j_œ°
 = 
œ°
;

1303 
jou∫Æ
->
j_hód
 = 
fú°
;

1304 
jou∫Æ
->
j_èû
 = 
fú°
;

1305 
jou∫Æ
->
j_‰ì
 = 
œ°
 - 
fú°
;

1307 
jou∫Æ
->
j_èû_£quí˚
 = jou∫Æ->
j_å™ß˘i⁄_£quí˚
;

1308 
jou∫Æ
->
j_commô_£quí˚
 = jou∫Æ->
j_å™ß˘i⁄_£quí˚
 - 1;

1309 
jou∫Æ
->
j_commô_ªque°
 = jou∫Æ->
j_commô_£quí˚
;

1311 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 = jou∫Æ->
j_maxÀn
 / 4;

1319 i‡(
sb
->
s_°¨t
 == 0) {

1320 
	`jbd_debug
(1, "JBD3: Skipping superblock update onÑecovered sb "

1322 
jou∫Æ
->
j_èû
, jou∫Æ->
j_èû_£quí˚
,

1323 
jou∫Æ
->
j_î∫o
);

1324 
jou∫Æ
->
j_Êags
 |
JBD3_FLUSHED
;

1327 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1334 
	`jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ
,

1335 
jou∫Æ
->
j_èû_£quí˚
,

1336 
jou∫Æ
->
j_èû
,

1337 
REQ_SYNC
 | 
REQ_FUA
);

1338 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1340  
	`jbd3_jou∫Æ_°¨t_thªad
(
jou∫Æ
);

1341 
	}
}

1347 
	$jbd3_wrôe_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe_Êags
)

1349 
buf„r_hód
 *
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1350 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1351 
ªt
;

1354 i‡(!
	`buf„r_m≠≥d
(
bh
))

1355  -
EIO
;

1357 
	`åa˚_jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_Êags
);

1358 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

1359 
wrôe_Êags
 &~(
REQ_FUA
 | 
REQ_PREFLUSH
);

1360 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
)) {

1369 
	`¥ötk
(
KERN_ERR
 "JBD3:Örevious I/OÉrror detected "

1371 
jou∫Æ
->
j_dev«me
);

1372 
	`˛ór_buf„r_wrôe_io_îr‹
(
bh
);

1373 
	`£t_buf„r_u±od©e
(
bh
);

1375 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

1376 
sb
->
s_checksum
 = 
	`jbd3_su≥rblock_csum
(
jou∫Æ
, sb);

1377 
	`gë_bh
(
bh
);

1378 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

1379 
ªt
 = 
	`submô_bh
(
REQ_OP_WRITE
, 
wrôe_Êags
, 
bh
);

1380 
	`waô_⁄_buf„r
(
bh
);

1381 i‡(
	`buf„r_wrôe_io_îr‹
(
bh
)) {

1382 
	`˛ór_buf„r_wrôe_io_îr‹
(
bh
);

1383 
	`£t_buf„r_u±od©e
(
bh
);

1384 
ªt
 = -
EIO
;

1386 i‡(
ªt
) {

1387 
	`¥ötk
(
KERN_ERR
 "JBD3: Error %d detected when updating "

1388 "jou∫Æ su≥rblock f‹ %s.\n", 
ªt
,

1389 
jou∫Æ
->
j_dev«me
);

1390 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªt
);

1393  
ªt
;

1394 
	}
}

1406 
	$jbd3_jou∫Æ_upd©e_sb_log_èû
(
jou∫Æ_t
 *
jou∫Æ
, 
tid_t
 
èû_tid
,

1407 
èû_block
, 
wrôe_›
)

1409 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1410 
ªt
;

1412 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

1413  -
EIO
;

1415 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

1416 
	`jbd_debug
(1, "JBD3: updating superblock (start %lu, seq %u)\n",

1417 
èû_block
, 
èû_tid
);

1419 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1420 
sb
->
s_£quí˚
 = 
	`˝u_to_be32
(
èû_tid
);

1421 
sb
->
s_°¨t
 = 
	`˝u_to_be32
(
èû_block
);

1423 
ªt
 = 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_›
);

1424 i‡(
ªt
)

1425 
out
;

1428 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1429 
	`WARN_ON
(!
sb
->
s_£quí˚
);

1430 
jou∫Æ
->
j_Êags
 &~
JBD3_FLUSHED
;

1431 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1433 
out
:

1434  
ªt
;

1435 
	}
}

1445 
	$jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe_›
)

1447 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1449 
	`BUG_ON
(!
	`muãx_is_locked
(&
jou∫Æ
->
j_checkpoöt_muãx
));

1450 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1451 i‡(
sb
->
s_°¨t
 == 0) {

1452 
	`u∆ock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1456 
	`jbd_debug
(1, "JBD3: Marking journalásÉmpty (seq %d)\n",

1457 
jou∫Æ
->
j_èû_£quí˚
);

1459 
sb
->
s_£quí˚
 = 
	`˝u_to_be32
(
jou∫Æ
->
j_èû_£quí˚
);

1460 
sb
->
s_°¨t
 = 
	`˝u_to_be32
(0);

1462 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
wrôe_›
);

1465 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1466 
jou∫Æ
->
j_Êags
 |
JBD3_FLUSHED
;

1467 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1468 
	}
}

1478 
	$jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ_t
 *
jou∫Æ
)

1480 
jou∫Æ_su≥rblock_t
 *
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1481 
îrcode
;

1483 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1484 
îrcode
 = 
jou∫Æ
->
j_î∫o
;

1485 i‡(
îrcode
 =-
ESHUTDOWN
)

1486 
îrcode
 = 0;

1487 
	`jbd_debug
(1, "JBD3: upd©ög su≥rblockÉº‹ (î∫ÿ%d)\n", 
îrcode
);

1488 
sb
->
s_î∫o
 = 
	`˝u_to_be32
(
îrcode
);

1490 
	`jbd3_wrôe_su≥rblock
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

1491 
	}
}

1492 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_upd©e_sb_î∫o
);

1498 
	$jou∫Æ_gë_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
)

1500 
buf„r_hód
 *
bh
;

1501 
jou∫Æ_su≥rblock_t
 *
sb
;

1502 
îr
 = -
EIO
;

1504 
bh
 = 
jou∫Æ
->
j_sb_buf„r
;

1506 
	`J_ASSERT
(
bh
 !
NULL
);

1507 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1508 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 1, &
bh
);

1509 
	`waô_⁄_buf„r
(
bh
);

1510 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1511 
	`¥ötk
(
KERN_ERR


1513 
out
;

1517 i‡(
	`buf„r_vîifõd
(
bh
))

1520 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1522 
îr
 = -
EINVAL
;

1524 i‡(
sb
->
s_hódî
.
h_magic
 !
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
) ||

1525 
sb
->
s_blocksize
 !
	`˝u_to_be32
(
jou∫Æ
->
j_blocksize
)) {

1526 
	`¥ötk
(
KERN_WARNING
 "JBD3:Ço valid journal superblock found\n");

1527 
out
;

1530 
	`be32_to_˝u
(
sb
->
s_hódî
.
h_blockty≥
)) {

1531 
JBD3_SUPERBLOCK_V1
:

1532 
jou∫Æ
->
j_f‹m©_vîsi⁄
 = 1;

1534 
JBD3_SUPERBLOCK_V2
:

1535 
jou∫Æ
->
j_f‹m©_vîsi⁄
 = 2;

1538 
	`¥ötk
(
KERN_WARNING
 "JBD3: unrecognised superblock format ID\n");

1539 
out
;

1542 i‡(
	`be32_to_˝u
(
sb
->
s_maxÀn
Ë< 
jou∫Æ
->
j_maxÀn
)

1543 
jou∫Æ
->
j_maxÀn
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1544 i‡(
	`be32_to_˝u
(
sb
->
s_maxÀn
Ë> 
jou∫Æ
->
j_maxÀn
) {

1545 
	`¥ötk
(
KERN_WARNING
 "JBD3: journal fileÅoo short\n");

1546 
out
;

1549 i‡(
	`be32_to_˝u
(
sb
->
s_fú°
) == 0 ||

1550 
	`be32_to_˝u
(
sb
->
s_fú°
Ë>
jou∫Æ
->
j_maxÀn
) {

1551 
	`¥ötk
(
KERN_WARNING


1553 
	`be32_to_˝u
(
sb
->
s_fú°
));

1554 
out
;

1557 i‡(
	`jbd3_has_„©uª_csum2
(
jou∫Æ
) &&

1558 
	`jbd3_has_„©uª_csum3
(
jou∫Æ
)) {

1560 
	`¥ötk
(
KERN_ERR
 "JBD3: Can'tÉnable checksumming v2ánd v3 "

1562 
out
;

1565 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
jou∫Æ
) &&

1566 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

1568 
	`¥ötk
(
KERN_ERR
 "JBD3: Can'tÉnable checksumming v1ánd v2/3 "

1570 
out
;

1573 i‡(!
	`jbd3_vîify_csum_ty≥
(
jou∫Æ
, 
sb
)) {

1574 
	`¥ötk
(
KERN_ERR
 "JBD3: Unknown checksumÅype\n");

1575 
out
;

1579 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3_„©uª
(
jou∫Æ
)) {

1580 
jou∫Æ
->
j_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

1581 i‡(
	`IS_ERR
(
jou∫Æ
->
j_chksum_drivî
)) {

1582 
	`¥ötk
(
KERN_ERR
 "JBD3: CannotÜoad crc32c driver.\n");

1583 
îr
 = 
	`PTR_ERR
(
jou∫Æ
->
j_chksum_drivî
);

1584 
jou∫Æ
->
j_chksum_drivî
 = 
NULL
;

1585 
out
;

1589 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
)) {

1591 i‡(
sb
->
s_checksum
 !
	`jbd3_su≥rblock_csum
(
jou∫Æ
, sb)) {

1592 
	`¥ötk
(
KERN_ERR
 "JBD3: journal checksumÉrror\n");

1593 
îr
 = -
EFSBADCRC
;

1594 
out
;

1598 
jou∫Æ
->
j_csum_£ed
 = 
	`jbd3_chksum
(jou∫Æ, ~0, 
sb
->
s_uuid
,

1599 (
sb
->
s_uuid
));

1602 
	`£t_buf„r_vîifõd
(
bh
);

1606 
out
:

1607 
	`jou∫Æ_Áû_su≥rblock
(
jou∫Æ
);

1608  
îr
;

1609 
	}
}

1616 
	$lﬂd_su≥rblock
(
jou∫Æ_t
 *
jou∫Æ
)

1618 
îr
;

1619 
jou∫Æ_su≥rblock_t
 *
sb
;

1621 
îr
 = 
	`jou∫Æ_gë_su≥rblock
(
jou∫Æ
);

1622 i‡(
îr
)

1623  
îr
;

1625 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1627 
jou∫Æ
->
j_èû_£quí˚
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
);

1628 
jou∫Æ
->
j_èû
 = 
	`be32_to_˝u
(
sb
->
s_°¨t
);

1629 
jou∫Æ
->
j_fú°
 = 
	`be32_to_˝u
(
sb
->
s_fú°
);

1630 
jou∫Æ
->
j_œ°
 = 
	`be32_to_˝u
(
sb
->
s_maxÀn
);

1631 
jou∫Æ
->
j_î∫o
 = 
	`be32_to_˝u
(
sb
->
s_î∫o
);

1634 
	}
}

1645 
	$jbd3_jou∫Æ_lﬂd
(
jou∫Æ_t
 *
jou∫Æ
)

1647 
îr
;

1648 
jou∫Æ_su≥rblock_t
 *
sb
;

1650 
îr
 = 
	`lﬂd_su≥rblock
(
jou∫Æ
);

1651 i‡(
îr
)

1652  
îr
;

1654 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1658 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 >= 2) {

1659 i‡((
sb
->
s_„©uª_ro_com∑t
 &

1660 ~
	`˝u_to_be32
(
JBD3_KNOWN_ROCOMPAT_FEATURES
)) ||

1661 (
sb
->
s_„©uª_öcom∑t
 &

1662 ~
	`˝u_to_be32
(
JBD3_KNOWN_INCOMPAT_FEATURES
))) {

1663 
	`¥ötk
(
KERN_WARNING


1665  -
EINVAL
;

1672 
îr
 = 
	`jbd3_jou∫Æ_¸óã_¶ab
(
	`be32_to_˝u
(
sb
->
s_blocksize
));

1673 i‡(
îr
)

1674  
îr
;

1678 i‡(
	`jbd3_jou∫Æ_ªcovî
(
jou∫Æ
))

1679 
ªcovîy_îr‹
;

1681 i‡(
jou∫Æ
->
j_Áûed_commô
) {

1682 
	`¥ötk
(
KERN_ERR
 "JBD3: journalÅransaction %u on %s "

1683 "i†c‹ru±.\n", 
jou∫Æ
->
j_Áûed_commô
,

1684 
jou∫Æ
->
j_dev«me
);

1685  -
EFSCORRUPTED
;

1691 i‡(
	`jou∫Æ_ª£t
(
jou∫Æ
))

1692 
ªcovîy_îr‹
;

1694 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT
;

1695 
jou∫Æ
->
j_Êags
 |
JBD3_LOADED
;

1698 
ªcovîy_îr‹
:

1699 
	`¥ötk
(
KERN_WARNING
 "JBD3:Ñecovery failed\n");

1700  -
EIO
;

1701 
	}
}

1711 
	$jbd3_jou∫Æ_de°roy
(
jou∫Æ_t
 *
jou∫Æ
)

1713 
îr
 = 0;

1716 
	`jou∫Æ_kûl_thªad
(
jou∫Æ
);

1719 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)

1720 
	`jbd3_jou∫Æ_commô_å™ß˘i⁄
(
jou∫Æ
);

1725 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1726 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
) {

1727 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1728 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1729 
îr
 = 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

1730 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1735 i‡(
îr
) {

1736 
	`jbd3_jou∫Æ_de°roy_checkpoöt
(
jou∫Æ
);

1737 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1740 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1743 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 =
NULL
);

1744 
	`J_ASSERT
(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 =
NULL
);

1745 
	`J_ASSERT
(
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 =
NULL
);

1746 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1748 i‡(
jou∫Æ
->
j_sb_buf„r
) {

1749 i‡(!
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)) {

1750 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1752 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1753 
jou∫Æ
->
j_èû_£quí˚
 =

1754 ++
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

1755 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1757 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
,

1758 
REQ_SYNC
 | 
REQ_PREFLUSH
 | 
REQ_FUA
);

1759 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1761 
îr
 = -
EIO
;

1762 
	`bªl£
(
jou∫Æ
->
j_sb_buf„r
);

1765 i‡(
jou∫Æ
->
j_¥oc_íåy
)

1766 
	`jbd3_°©s_¥oc_exô
(
jou∫Æ
);

1767 
	`ùut
(
jou∫Æ
->
j_öode
);

1768 i‡(
jou∫Æ
->
j_ªvoke
)

1769 
	`jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ
);

1770 i‡(
jou∫Æ
->
j_chksum_drivî
)

1771 
	`¸y±o_‰ì_shash
(
jou∫Æ
->
j_chksum_drivî
);

1772 
	`k‰ì
(
jou∫Æ
->
j_wbuf
);

1773 
	`k‰ì
(
jou∫Æ
);

1775  
îr
;

1776 
	}
}

1790 
	$jbd3_jou∫Æ_check_u£d_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1791 
ro
, 
öcom∑t
)

1793 
jou∫Æ_su≥rblock_t
 *
sb
;

1795 i‡(!
com∑t
 && !
ro
 && !
öcom∑t
)

1798 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 == 0 &&

1799 
	`jou∫Æ_gë_su≥rblock
(
jou∫Æ
) != 0)

1801 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 == 1)

1804 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1806 i‡(((
	`be32_to_˝u
(
sb
->
s_„©uª_com∑t
Ë& 
com∑t
) == compat) &&

1807 ((
	`be32_to_˝u
(
sb
->
s_„©uª_ro_com∑t
Ë& 
ro
) ==Ño) &&

1808 ((
	`be32_to_˝u
(
sb
->
s_„©uª_öcom∑t
Ë& 
öcom∑t
) == incompat))

1812 
	}
}

1825 
	$jbd3_jou∫Æ_check_avaûabÀ_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1826 
ro
, 
öcom∑t
)

1828 i‡(!
com∑t
 && !
ro
 && !
öcom∑t
)

1835 i‡(
jou∫Æ
->
j_f‹m©_vîsi⁄
 != 2)

1838 i‡((
com∑t
 & 
JBD3_KNOWN_COMPAT_FEATURES
) == compat &&

1839 (
ro
 & 
JBD3_KNOWN_ROCOMPAT_FEATURES
) ==Ño &&

1840 (
öcom∑t
 & 
JBD3_KNOWN_INCOMPAT_FEATURES
) == incompat)

1844 
	}
}

1858 
	$jbd3_jou∫Æ_£t_„©uªs
 (
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1859 
ro
, 
öcom∑t
)

1861 
	#INCOMPAT_FEATURE_ON
(
f
) \

1862 ((
öcom∑t
 & (
f
)Ë&& !(
sb
->
s_„©uª_öcom∑t
 & 
	`˝u_to_be32
(f)))

	)

1863 
	#COMPAT_FEATURE_ON
(
f
) \

1864 ((
com∑t
 & (
f
)Ë&& !(
sb
->
s_„©uª_com∑t
 & 
	`˝u_to_be32
(f)))

	)

1865 
jou∫Æ_su≥rblock_t
 *
sb
;

1867 i‡(
	`jbd3_jou∫Æ_check_u£d_„©uªs
(
jou∫Æ
, 
com∑t
, 
ro
, 
öcom∑t
))

1870 i‡(!
	`jbd3_jou∫Æ_check_avaûabÀ_„©uªs
(
jou∫Æ
, 
com∑t
, 
ro
, 
öcom∑t
))

1874 i‡(
öcom∑t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V2
) {

1875 
öcom∑t
 &~
JBD3_FEATURE_INCOMPAT_CSUM_V2
;

1876 
öcom∑t
 |
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

1880 i‡(
öcom∑t
 & 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 &&

1881 
com∑t
 & 
JBD3_FEATURE_COMPAT_CHECKSUM
)

1882 
com∑t
 &~
JBD3_FEATURE_COMPAT_CHECKSUM
;

1884 
	`jbd_debug
(1, "SettingÇew features 0x%lx/0x%lx/0x%lx\n",

1885 
com∑t
, 
ro
, 
öcom∑t
);

1887 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1890 i‡((
jou∫Æ
->
j_chksum_drivî
 =
NULL
) &&

1891 
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1892 
jou∫Æ
->
j_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

1893 i‡(
	`IS_ERR
(
jou∫Æ
->
j_chksum_drivî
)) {

1894 
	`¥ötk
(
KERN_ERR
 "JBD3: CannotÜoad crc32c driver.\n");

1895 
jou∫Æ
->
j_chksum_drivî
 = 
NULL
;

1899 
jou∫Æ
->
j_csum_£ed
 = 
	`jbd3_chksum
(jou∫Æ, ~0, 
sb
->
s_uuid
,

1900 (
sb
->
s_uuid
));

1903 
	`lock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1906 i‡(
	`INCOMPAT_FEATURE_ON
(
JBD3_FEATURE_INCOMPAT_CSUM_V3
)) {

1907 
sb
->
s_checksum_ty≥
 = 
JBD3_CRC32C_CHKSUM
;

1908 
sb
->
s_„©uª_com∑t
 &=

1909 ~
	`˝u_to_be32
(
JBD3_FEATURE_COMPAT_CHECKSUM
);

1913 i‡(
	`COMPAT_FEATURE_ON
(
JBD3_FEATURE_COMPAT_CHECKSUM
))

1914 
sb
->
s_„©uª_öcom∑t
 &=

1915 ~
	`˝u_to_be32
(
JBD3_FEATURE_INCOMPAT_CSUM_V2
 |

1916 
JBD3_FEATURE_INCOMPAT_CSUM_V3
);

1918 
sb
->
s_„©uª_com∑t
 |
	`˝u_to_be32
(
com∑t
);

1919 
sb
->
s_„©uª_ro_com∑t
 |
	`˝u_to_be32
(
ro
);

1920 
sb
->
s_„©uª_öcom∑t
 |
	`˝u_to_be32
(
öcom∑t
);

1921 
	`u∆ock_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

1924 #unde‡
COMPAT_FEATURE_ON


1925 #unde‡
INCOMPAT_FEATURE_ON


1926 
	}
}

1939 
	$jbd3_jou∫Æ_˛ór_„©uªs
(
jou∫Æ_t
 *
jou∫Æ
, 
com∑t
,

1940 
ro
, 
öcom∑t
)

1942 
jou∫Æ_su≥rblock_t
 *
sb
;

1944 
	`jbd_debug
(1, "Clear features 0x%lx/0x%lx/0x%lx\n",

1945 
com∑t
, 
ro
, 
öcom∑t
);

1947 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

1949 
sb
->
s_„©uª_com∑t
 &~
	`˝u_to_be32
(
com∑t
);

1950 
sb
->
s_„©uª_ro_com∑t
 &~
	`˝u_to_be32
(
ro
);

1951 
sb
->
s_„©uª_öcom∑t
 &~
	`˝u_to_be32
(
öcom∑t
);

1952 
	}
}

1953 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_˛ór_„©uªs
);

1964 
	$jbd3_jou∫Æ_Êush
(
jou∫Æ_t
 *
jou∫Æ
)

1966 
îr
 = 0;

1967 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
NULL
;

1969 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

1972 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

1973 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

1974 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
å™ß˘i⁄
->
t_tid
);

1975 } i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)

1976 
å™ß˘i⁄
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

1979 i‡(
å™ß˘i⁄
) {

1980 
tid_t
 
tid
 = 
å™ß˘i⁄
->
t_tid
;

1982 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1983 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

1985 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1989 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1990 !
îr
 && 
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
 !
NULL
) {

1991 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1992 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1993 
îr
 = 
	`jbd3_log_do_checkpoöt
(
jou∫Æ
);

1994 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

1995 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1997 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1999 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

2000  -
EIO
;

2002 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2003 i‡(!
îr
) {

2004 
îr
 = 
	`jbd3_˛ónup_jou∫Æ_èû
(
jou∫Æ
);

2005 i‡(
îr
 < 0) {

2006 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2007 
out
;

2009 
îr
 = 0;

2017 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

2018 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2019 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2020 
	`J_ASSERT
(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2021 
	`J_ASSERT
(!
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2022 
	`J_ASSERT
(!
jou∫Æ
->
j_checkpoöt_å™ß˘i⁄s
);

2023 
	`J_ASSERT
(
jou∫Æ
->
j_hód
 =jou∫Æ->
j_èû
);

2024 
	`J_ASSERT
(
jou∫Æ
->
j_èû_£quí˚
 =jou∫Æ->
j_å™ß˘i⁄_£quí˚
);

2025 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2026 
out
:

2027  
îr
;

2028 
	}
}

2043 
	$jbd3_jou∫Æ_wùe
(
jou∫Æ_t
 *
jou∫Æ
, 
wrôe
)

2045 
îr
 = 0;

2047 
	`J_ASSERT
 (!(
jou∫Æ
->
j_Êags
 & 
JBD3_LOADED
));

2049 
îr
 = 
	`lﬂd_su≥rblock
(
jou∫Æ
);

2050 i‡(
îr
)

2051  
îr
;

2053 i‡(!
jou∫Æ
->
j_èû
)

2054 
no_ªcovîy
;

2056 
	`¥ötk
(
KERN_WARNING
 "JBD3: %sÑecovery information on journal\n",

2057 
wrôe
 ? "Clearing" : "Ignoring");

2059 
îr
 = 
	`jbd3_jou∫Æ_skù_ªcovîy
(
jou∫Æ
);

2060 i‡(
wrôe
) {

2062 
	`muãx_lock_io
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2063 
	`jbd3_m¨k_jou∫Æ_em±y
(
jou∫Æ
, 
REQ_SYNC
 | 
REQ_FUA
);

2064 
	`muãx_u∆ock
(&
jou∫Æ
->
j_checkpoöt_muãx
);

2067 
no_ªcovîy
:

2068  
îr
;

2069 
	}
}

2084 
	$__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ_t
 *
jou∫Æ
)

2086 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

2088 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2091 
	`¥ötk
(
KERN_ERR
 "Aborting journal on device %s.\n",

2092 
jou∫Æ
->
j_dev«me
);

2094 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2095 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT
;

2096 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

2097 i‡(
å™ß˘i⁄
)

2098 
	`__jbd3_log_°¨t_commô
(
jou∫Æ
, 
å™ß˘i⁄
->
t_tid
);

2099 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2100 
	}
}

2104 
	$__jou∫Æ_ab‹t_so·
 (
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
)

2106 
ﬁd_î∫o
;

2108 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2109 
ﬁd_î∫o
 = 
jou∫Æ
->
j_î∫o
;

2110 i‡(!
jou∫Æ
->
j_î∫o
 || 
î∫o
 =-
ESHUTDOWN
)

2111 
jou∫Æ
->
j_î∫o
 = 
î∫o
;

2113 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
) {

2114 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2115 i‡(!
ﬁd_î∫o
 && old_î∫ÿ!-
ESHUTDOWN
 &&

2116 
î∫o
 =-
ESHUTDOWN
)

2117 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

2120 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2122 
	`__jbd3_jou∫Æ_ab‹t_h¨d
(
jou∫Æ
);

2124 i‡(
î∫o
) {

2125 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

2126 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2127 
jou∫Æ
->
j_Êags
 |
JBD3_REC_ERR
;

2128 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2130 
	}
}

2178 
	$jbd3_jou∫Æ_ab‹t
(
jou∫Æ_t
 *
jou∫Æ
, 
î∫o
)

2180 
	`__jou∫Æ_ab‹t_so·
(
jou∫Æ
, 
î∫o
);

2181 
	}
}

2194 
	$jbd3_jou∫Æ_î∫o
(
jou∫Æ_t
 *
jou∫Æ
)

2196 
îr
;

2198 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

2199 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2200 
îr
 = -
EROFS
;

2202 
îr
 = 
jou∫Æ
->
j_î∫o
;

2203 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2204  
îr
;

2205 
	}
}

2214 
	$jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ_t
 *
jou∫Æ
)

2216 
îr
 = 0;

2218 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2219 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
)

2220 
îr
 = -
EROFS
;

2222 
jou∫Æ
->
j_î∫o
 = 0;

2223 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2224  
îr
;

2225 
	}
}

2234 
	$jbd3_jou∫Æ_ack_îr
(
jou∫Æ_t
 *
jou∫Æ
)

2236 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2237 i‡(
jou∫Æ
->
j_î∫o
)

2238 
jou∫Æ
->
j_Êags
 |
JBD3_ACK_ERR
;

2239 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2240 
	}
}

2242 
	$jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

2244  1 << (
PAGE_SHIFT
 - 
öode
->
i_sb
->
s_blocksize_bôs
);

2245 
	}
}

2250 
size_t
 
	$jou∫Æ_èg_byãs
(
jou∫Æ_t
 *
jou∫Æ
)

2252 
size_t
 
sz
;

2254 i‡(
	`jbd3_has_„©uª_csum3
(
jou∫Æ
))

2255  (
jou∫Æ_block_èg3_t
);

2257 
sz
 = (
jou∫Æ_block_èg_t
);

2259 i‡(
	`jbd3_has_„©uª_csum2
(
jou∫Æ
))

2260 
sz
 +(
__u16
);

2262 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

2263  
sz
;

2265  
sz
 - (
__u32
);

2266 
	}
}

2283 
	#JBD3_MAX_SLABS
 8

	)

2284 
kmem_ˇche
 *
	gjbd3_¶ab
[
JBD3_MAX_SLABS
];

2286 c⁄° *
	gjbd3_¶ab_«mes
[
JBD3_MAX_SLABS
] = {

2292 
	$jbd3_jou∫Æ_de°roy_¶abs
()

2294 
i
;

2296 
i
 = 0; i < 
JBD3_MAX_SLABS
; i++) {

2297 
	`kmem_ˇche_de°roy
(
jbd3_¶ab
[
i
]);

2298 
jbd3_¶ab
[
i
] = 
NULL
;

2300 
	}
}

2302 
	$jbd3_jou∫Æ_¸óã_¶ab
(
size_t
 
size
)

2304 
	`DEFINE_MUTEX
(
jbd3_¶ab_¸óã_muãx
);

2305 
i
 = 
	`‹dî_ba£_2
(
size
) - 10;

2306 
size_t
 
¶ab_size
;

2308 i‡(
size
 =
PAGE_SIZE
)

2311 i‡(
i
 >
JBD3_MAX_SLABS
)

2312  -
EINVAL
;

2314 i‡(
	`u∆ikñy
(
i
 < 0))

2315 
i
 = 0;

2316 
	`muãx_lock
(&
jbd3_¶ab_¸óã_muãx
);

2317 i‡(
jbd3_¶ab
[
i
]) {

2318 
	`muãx_u∆ock
(&
jbd3_¶ab_¸óã_muãx
);

2322 
¶ab_size
 = 1 << (
i
+10);

2323 
jbd3_¶ab
[
i
] = 
	`kmem_ˇche_¸óã
(
jbd3_¶ab_«mes
[i], 
¶ab_size
,

2324 
¶ab_size
, 0, 
NULL
);

2325 
	`muãx_u∆ock
(&
jbd3_¶ab_¸óã_muãx
);

2326 i‡(!
jbd3_¶ab
[
i
]) {

2327 
	`¥ötk
(
KERN_EMERG
 "JBD3:Ço memory for jbd3_slab cache\n");

2328  -
ENOMEM
;

2331 
	}
}

2333 
kmem_ˇche
 *
	$gë_¶ab
(
size_t
 
size
)

2335 
i
 = 
	`‹dî_ba£_2
(
size
) - 10;

2337 
	`BUG_ON
(
i
 >
JBD3_MAX_SLABS
);

2338 i‡(
	`u∆ikñy
(
i
 < 0))

2339 
i
 = 0;

2340 
	`BUG_ON
(
jbd3_¶ab
[
i
] =
NULL
);

2341  
jbd3_¶ab
[
i
];

2342 
	}
}

2344 *
	$jbd3_Æloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

2346 *
±r
;

2348 
	`BUG_ON
(
size
 & (size-1));

2350 i‡(
size
 < 
PAGE_SIZE
)

2351 
±r
 = 
	`kmem_ˇche_Æloc
(
	`gë_¶ab
(
size
), 
Êags
);

2353 
±r
 = (*)
	`__gë_‰ì_∑ges
(
Êags
, 
	`gë_‹dî
(
size
));

2357 
	`BUG_ON
(((Ë
±r
Ë& (
size
-1));

2359  
±r
;

2360 
	}
}

2362 
	$jbd3_‰ì
(*
±r
, 
size_t
 
size
)

2364 i‡(
size
 < 
PAGE_SIZE
)

2365 
	`kmem_ˇche_‰ì
(
	`gë_¶ab
(
size
), 
±r
);

2367 
	`‰ì_∑ges
(()
±r
, 
	`gë_‹dî
(
size
));

2368 
	}
};

2373 
kmem_ˇche
 *
	gjbd3_jou∫Æ_hód_ˇche
;

2374 #ifde‡
CONFIG_JBD3_DEBUG


2375 
©omic_t
 
	gƒ_jou∫Æ_hóds
 = 
ATOMIC_INIT
(0);

2378 
__öô
 
	$jbd3_jou∫Æ_öô_jou∫Æ_hód_ˇche
()

2380 
	`J_ASSERT
(!
jbd3_jou∫Æ_hód_ˇche
);

2381 
jbd3_jou∫Æ_hód_ˇche
 = 
	`kmem_ˇche_¸óã
("jbd3_journal_head",

2382 (
jou∫Æ_hód
),

2384 
SLAB_TEMPORARY
 | 
SLAB_TYPESAFE_BY_RCU
,

2385 
NULL
);

2386 i‡(!
jbd3_jou∫Æ_hód_ˇche
) {

2387 
	`¥ötk
(
KERN_EMERG
 "JBD3:Ço memory for journal_head cache\n");

2388  -
ENOMEM
;

2391 
	}
}

2393 
	$jbd3_jou∫Æ_de°roy_jou∫Æ_hód_ˇche
()

2395 
	`kmem_ˇche_de°roy
(
jbd3_jou∫Æ_hód_ˇche
);

2396 
jbd3_jou∫Æ_hód_ˇche
 = 
NULL
;

2397 
	}
}

2402 
jou∫Æ_hód
 *
	$jou∫Æ_Æloc_jou∫Æ_hód
()

2404 
jou∫Æ_hód
 *
ªt
;

2406 #ifde‡
CONFIG_JBD3_DEBUG


2407 
	`©omic_öc
(&
ƒ_jou∫Æ_hóds
);

2409 
ªt
 = 
	`kmem_ˇche_zÆloc
(
jbd3_jou∫Æ_hód_ˇche
, 
GFP_NOFS
);

2410 i‡(!
ªt
) {

2411 
	`jbd_debug
(1, "out of memory for journal_head\n");

2412 
	`¥_nŸi˚_øãlimôed
("ENOMEM i¿%s,Ñëryög.\n", 
__func__
);

2413 
ªt
 = 
	`kmem_ˇche_zÆloc
(
jbd3_jou∫Æ_hód_ˇche
,

2414 
GFP_NOFS
 | 
__GFP_NOFAIL
);

2416  
ªt
;

2417 
	}
}

2419 
	$jou∫Æ_‰ì_jou∫Æ_hód
(
jou∫Æ_hód
 *
jh
)

2421 #ifde‡
CONFIG_JBD3_DEBUG


2422 
	`©omic_dec
(&
ƒ_jou∫Æ_hóds
);

2423 
	`mem£t
(
jh
, 
JBD3_POISON_FREE
, (*jh));

2425 
	`kmem_ˇche_‰ì
(
jbd3_jou∫Æ_hód_ˇche
, 
jh
);

2426 
	}
}

2469 
jou∫Æ_hód
 *
	$jbd3_jou∫Æ_add_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2471 
jou∫Æ_hód
 *
jh
;

2472 
jou∫Æ_hód
 *
√w_jh
 = 
NULL
;

2474 
ª≥©
:

2475 i‡(!
	`buf„r_jbd
(
bh
))

2476 
√w_jh
 = 
	`jou∫Æ_Æloc_jou∫Æ_hód
();

2478 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2479 i‡(
	`buf„r_jbd
(
bh
)) {

2480 
jh
 = 
	`bh2jh
(
bh
);

2482 
	`J_ASSERT_BH
(
bh
,

2483 (
	`©omic_ªad
(&
bh
->
b_cou¡
) > 0) ||

2484 (
bh
->
b_∑ge
 && bh->b_∑ge->
m≠pög
));

2486 i‡(!
√w_jh
) {

2487 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2488 
ª≥©
;

2491 
jh
 = 
√w_jh
;

2492 
√w_jh
 = 
NULL
;

2493 
	`£t_buf„r_jbd
(
bh
);

2494 
bh
->
b_¥iv©e
 = 
jh
;

2495 
jh
->
b_bh
 = 
bh
;

2496 
	`gë_bh
(
bh
);

2497 
	`BUFFER_TRACE
(
bh
, "added journal_head");

2499 
jh
->
b_jcou¡
++;

2500 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2501 i‡(
√w_jh
)

2502 
	`jou∫Æ_‰ì_jou∫Æ_hód
(
√w_jh
);

2503  
bh
->
b_¥iv©e
;

2504 
	}
}

2510 
jou∫Æ_hód
 *
	$jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2512 
jou∫Æ_hód
 *
jh
 = 
NULL
;

2514 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2515 i‡(
	`buf„r_jbd
(
bh
)) {

2516 
jh
 = 
	`bh2jh
(
bh
);

2517 
jh
->
b_jcou¡
++;

2519 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2520  
jh
;

2521 
	}
}

2523 
	$__jou∫Æ_ªmove_jou∫Æ_hód
(
buf„r_hód
 *
bh
)

2525 
jou∫Æ_hód
 *
jh
 = 
	`bh2jh
(
bh
);

2527 
	`J_ASSERT_JH
(
jh
, jh->
b_jcou¡
 >= 0);

2528 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
NULL
);

2529 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

2530 
	`J_ASSERT_JH
(
jh
, jh->
b_˝_å™ß˘i⁄
 =
NULL
);

2531 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 =
BJ_N⁄e
);

2532 
	`J_ASSERT_BH
(
bh
, 
	`buf„r_jbd
(bh));

2533 
	`J_ASSERT_BH
(
bh
, 
	`jh2bh
(
jh
) == bh);

2534 
	`BUFFER_TRACE
(
bh
, "remove journal_head");

2535 i‡(
jh
->
b_‰ozí_d©a
) {

2536 
	`¥ötk
(
KERN_WARNING
 "%s: fªeög b_‰ozí_d©a\n", 
__func__
);

2537 
	`jbd3_‰ì
(
jh
->
b_‰ozí_d©a
, 
bh
->
b_size
);

2539 i‡(
jh
->
b_commôãd_d©a
) {

2540 
	`¥ötk
(
KERN_WARNING
 "%s: fªeög b_commôãd_d©a\n", 
__func__
);

2541 
	`jbd3_‰ì
(
jh
->
b_commôãd_d©a
, 
bh
->
b_size
);

2543 
bh
->
b_¥iv©e
 = 
NULL
;

2544 
jh
->
b_bh
 = 
NULL
;

2545 
	`˛ór_buf„r_jbd
(
bh
);

2546 
	`jou∫Æ_‰ì_jou∫Æ_hód
(
jh
);

2547 
	}
}

2553 
	$jbd3_jou∫Æ_put_jou∫Æ_hód
(
jou∫Æ_hód
 *
jh
)

2555 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2557 
	`jbd_lock_bh_jou∫Æ_hód
(
bh
);

2558 
	`J_ASSERT_JH
(
jh
, jh->
b_jcou¡
 > 0);

2559 --
jh
->
b_jcou¡
;

2560 i‡(!
jh
->
b_jcou¡
) {

2561 
	`__jou∫Æ_ªmove_jou∫Æ_hód
(
bh
);

2562 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2563 
	`__bªl£
(
bh
);

2565 
	`jbd_u∆ock_bh_jou∫Æ_hód
(
bh
);

2566 
	}
}

2571 
	$jbd3_jou∫Æ_öô_jbd_öode
(
jbd3_öode
 *
jöode
, 
öode
 *inode)

2573 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

2574 
jöode
->
i_√xt_å™ß˘i⁄
 = 
NULL
;

2575 
jöode
->
i_vfs_öode
 = 
öode
;

2576 
jöode
->
i_Êags
 = 0;

2577 
	`INIT_LIST_HEAD
(&
jöode
->
i_li°
);

2578 
	}
}

2585 
	$jbd3_jou∫Æ_ªÀa£_jbd_öode
(
jou∫Æ_t
 *
jou∫Æ
,

2586 
jbd3_öode
 *
jöode
)

2588 i‡(!
jou∫Æ
)

2590 
ª°¨t
:

2591 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2593 i‡(
jöode
->
i_Êags
 & 
JI_COMMIT_RUNNING
) {

2594 
waô_queue_hód_t
 *
wq
;

2595 
	`DEFINE_WAIT_BIT
(
waô
, &
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

2596 
wq
 = 
	`bô_waôqueue
(&
jöode
->
i_Êags
, 
__JI_COMMIT_RUNNING
);

2597 
	`¥ï¨e_to_waô
(
wq
, &
waô
.
wq_íåy
, 
TASK_UNINTERRUPTIBLE
);

2598 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2599 
	`scheduÀ
();

2600 
	`föish_waô
(
wq
, &
waô
.
wq_íåy
);

2601 
ª°¨t
;

2604 i‡(
jöode
->
i_å™ß˘i⁄
) {

2605 
	`li°_dñ
(&
jöode
->
i_li°
);

2606 
jöode
->
i_å™ß˘i⁄
 = 
NULL
;

2608 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2609 
	}
}

2612 #ifde‡
CONFIG_PROC_FS


2614 
	#JBD3_STATS_PROC_NAME
 "fs/jbd3"

	)

2616 
__öô
 
	$jbd3_¸óã_jbd_°©s_¥oc_íåy
()

2618 
¥oc_jbd3_°©s
 = 
	`¥oc_mkdú
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2619 
	}
}

2621 
__exô
 
	$jbd3_ªmove_jbd_°©s_¥oc_íåy
()

2623 i‡(
¥oc_jbd3_°©s
)

2624 
	`ªmove_¥oc_íåy
(
JBD3_STATS_PROC_NAME
, 
NULL
);

2625 
	}
}

2629 
	#jbd3_¸óã_jbd_°©s_¥oc_íåy
(Ëdÿ{} 0)

	)

2630 
	#jbd3_ªmove_jbd_°©s_¥oc_íåy
(Ëdÿ{} 0)

	)

2634 
kmem_ˇche
 *
	gjbd3_h™dÀ_ˇche
, *
	gjbd3_öode_ˇche
;

2636 
__öô
 
	$jbd3_jou∫Æ_öô_öode_ˇche
()

2638 
	`J_ASSERT
(!
jbd3_öode_ˇche
);

2639 
jbd3_öode_ˇche
 = 
	`KMEM_CACHE
(
jbd3_öode
, 0);

2640 i‡(!
jbd3_öode_ˇche
) {

2641 
	`¥_emîg
("JBD3: failedÅo create inode cache\n");

2642  -
ENOMEM
;

2645 
	}
}

2647 
__öô
 
	$jbd3_jou∫Æ_öô_h™dÀ_ˇche
()

2649 
	`J_ASSERT
(!
jbd3_h™dÀ_ˇche
);

2650 
jbd3_h™dÀ_ˇche
 = 
	`KMEM_CACHE
(
jbd3_jou∫Æ_h™dÀ
, 
SLAB_TEMPORARY
);

2651 i‡(!
jbd3_h™dÀ_ˇche
) {

2652 
	`¥ötk
(
KERN_EMERG
 "JBD3: failedÅo create handle cache\n");

2653  -
ENOMEM
;

2656 
	}
}

2658 
	$jbd3_jou∫Æ_de°roy_öode_ˇche
()

2660 
	`kmem_ˇche_de°roy
(
jbd3_öode_ˇche
);

2661 
jbd3_öode_ˇche
 = 
NULL
;

2662 
	}
}

2664 
	$jbd3_jou∫Æ_de°roy_h™dÀ_ˇche
()

2666 
	`kmem_ˇche_de°roy
(
jbd3_h™dÀ_ˇche
);

2667 
jbd3_h™dÀ_ˇche
 = 
NULL
;

2668 
	}
}

2674 
__öô
 
	$jou∫Æ_öô_ˇches
()

2676 
ªt
;

2678 
ªt
 = 
	`jbd3_jou∫Æ_öô_ªvoke_ªc‹d_ˇche
();

2679 i‡(
ªt
 == 0)

2680 
ªt
 = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ_ˇche
();

2681 i‡(
ªt
 == 0)

2682 
ªt
 = 
	`jbd3_jou∫Æ_öô_jou∫Æ_hód_ˇche
();

2683 i‡(
ªt
 == 0)

2684 
ªt
 = 
	`jbd3_jou∫Æ_öô_h™dÀ_ˇche
();

2685 i‡(
ªt
 == 0)

2686 
ªt
 = 
	`jbd3_jou∫Æ_öô_öode_ˇche
();

2687 i‡(
ªt
 == 0)

2688 
ªt
 = 
	`jbd3_jou∫Æ_öô_å™ß˘i⁄_ˇche
();

2689  
ªt
;

2690 
	}
}

2692 
	$jbd3_jou∫Æ_de°roy_ˇches
()

2694 
	`jbd3_jou∫Æ_de°roy_ªvoke_ªc‹d_ˇche
();

2695 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ_ˇche
();

2696 
	`jbd3_jou∫Æ_de°roy_jou∫Æ_hód_ˇche
();

2697 
	`jbd3_jou∫Æ_de°roy_h™dÀ_ˇche
();

2698 
	`jbd3_jou∫Æ_de°roy_öode_ˇche
();

2699 
	`jbd3_jou∫Æ_de°roy_å™ß˘i⁄_ˇche
();

2700 
	`jbd3_jou∫Æ_de°roy_¶abs
();

2701 
	}
}

2703 
__öô
 
	$jou∫Æ_öô
()

2705 
ªt
;

2707 
	`BUILD_BUG_ON
((
jou∫Æ_su≥rblock_s
) != 1024);

2709 
ªt
 = 
	`jou∫Æ_öô_ˇches
();

2710 i‡(
ªt
 == 0) {

2711 
	`jbd3_¸óã_jbd_°©s_¥oc_íåy
();

2713 
	`jbd3_jou∫Æ_de°roy_ˇches
();

2715  
ªt
;

2716 
	}
}

2718 
__exô
 
	$jou∫Æ_exô
()

2720 #ifde‡
CONFIG_JBD3_DEBUG


2721 
n
 = 
	`©omic_ªad
(&
ƒ_jou∫Æ_hóds
);

2722 i‡(
n
)

2723 
	`¥ötk
(
KERN_ERR
 "JBD3:Üóked %d jou∫Æ_hóds!\n", 
n
);

2725 
	`jbd3_ªmove_jbd_°©s_¥oc_íåy
();

2726 
	`jbd3_jou∫Æ_de°roy_ˇches
();

2727 
	}
}

2729 
MODULE_LICENSE
("GPL");

2730 
moduÀ_öô
(
jou∫Æ_öô
);

2731 
moduÀ_exô
(
jou∫Æ_exô
);

	@jbd3/recovery.c

13 #i‚de‡
__KERNEL__


14 
	~"jfs_u£r.h
"

16 
	~<löux/time.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/jbd3.h
>

19 
	~<löux/î∫o.h
>

20 
	~<löux/¸c32.h
>

21 
	~<löux/blkdev.h
>

28 
	sªcovîy_öfo


30 
tid_t
 
	m°¨t_å™ß˘i⁄
;

31 
tid_t
 
	míd_å™ß˘i⁄
;

33 
	mƒ_ª∂ays
;

34 
	mƒ_ªvokes
;

35 
	mƒ_ªvoke_hôs
;

38 
	e∑s°y≥
 {
	mPASS_SCAN
, 
	mPASS_REVOKE
, 
	mPASS_REPLAY
};

39 
do_⁄e_∑ss
(
jou∫Æ_t
 *
jou∫Æ
,

40 
ªcovîy_öfo
 *
öfo
, 
∑s°y≥
 
∑ss
);

41 
sˇn_ªvoke_ªc‹ds
(
jou∫Æ_t
 *, 
buf„r_hód
 *,

42 
tid_t
, 
ªcovîy_öfo
 *);

44 #ifde‡
__KERNEL__


47 
	$jou∫Æ_bªl£_¨øy
(
buf„r_hód
 *
b
[], 
n
)

49 --
n
 >= 0)

50 
	`bªl£
 (
b
[
n
]);

51 
	}
}

66 
	#MAXBUF
 8

	)

67 
	$do_ªadahód
(
jou∫Æ_t
 *
jou∫Æ
, 
°¨t
)

69 
îr
;

70 
max
, 
nbufs
, 
√xt
;

71 
blockƒ
;

72 
buf„r_hód
 *
bh
;

74 
buf„r_hód
 * 
bufs
[
MAXBUF
];

77 
max
 = 
°¨t
 + (128 * 1024 / 
jou∫Æ
->
j_blocksize
);

78 i‡(
max
 > 
jou∫Æ
->
j_maxÀn
)

79 
max
 = 
jou∫Æ
->
j_maxÀn
;

84 
nbufs
 = 0;

86 
√xt
 = 
°¨t
;Çexà< 
max
;Çext++) {

87 
îr
 = 
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
√xt
, &
blockƒ
);

89 i‡(
îr
) {

90 
	`¥ötk
(
KERN_ERR
 "JBD3: bad blockát offset %u\n",

91 
√xt
);

92 
Áûed
;

95 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

96 i‡(!
bh
) {

97 
îr
 = -
ENOMEM
;

98 
Áûed
;

101 i‡(!
	`buf„r_u±od©e
(
bh
Ë&& !
	`buf„r_locked
(bh)) {

102 
bufs
[
nbufs
++] = 
bh
;

103 i‡(
nbufs
 =
MAXBUF
) {

104 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

105 
	`jou∫Æ_bªl£_¨øy
(
bufs
, 
nbufs
);

106 
nbufs
 = 0;

109 
	`bªl£
(
bh
);

112 i‡(
nbufs
)

113 
	`Œ_rw_block
(
REQ_OP_READ
, 0, 
nbufs
, 
bufs
);

114 
îr
 = 0;

116 
Áûed
:

117 i‡(
nbufs
)

118 
	`jou∫Æ_bªl£_¨øy
(
bufs
, 
nbufs
);

119  
îr
;

120 
	}
}

129 
	$jªad
(
buf„r_hód
 **
bhp
, 
jou∫Æ_t
 *
jou∫Æ
,

130 
off£t
)

132 
îr
;

133 
blockƒ
;

134 
buf„r_hód
 *
bh
;

136 *
bhp
 = 
NULL
;

138 i‡(
off£t
 >
jou∫Æ
->
j_maxÀn
) {

139 
	`¥ötk
(
KERN_ERR
 "JBD3: corrupted journal superblock\n");

140  -
EFSCORRUPTED
;

143 
îr
 = 
	`jbd3_jou∫Æ_bm≠
(
jou∫Æ
, 
off£t
, &
blockƒ
);

145 i‡(
îr
) {

146 
	`¥ötk
(
KERN_ERR
 "JBD3: bad blockát offset %u\n",

147 
off£t
);

148  
îr
;

151 
bh
 = 
	`__gëblk
(
jou∫Æ
->
j_dev
, 
blockƒ
, jou∫Æ->
j_blocksize
);

152 i‡(!
bh
)

153  -
ENOMEM
;

155 i‡(!
	`buf„r_u±od©e
(
bh
)) {

158 i‡(!
	`buf„r_ªq
(
bh
))

159 
	`do_ªadahód
(
jou∫Æ
, 
off£t
);

160 
	`waô_⁄_buf„r
(
bh
);

163 i‡(!
	`buf„r_u±od©e
(
bh
)) {

164 
	`¥ötk
(
KERN_ERR
 "JBD3: FailedÅoÑead blockát offset %u\n",

165 
off£t
);

166 
	`bªl£
(
bh
);

167  -
EIO
;

170 *
bhp
 = 
bh
;

172 
	}
}

174 
	$jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ_t
 *
j
, *
buf
)

176 
jbd3_jou∫Æ_block_èû
 *
èû
;

177 
__be32
 
¥ovided
;

178 
__u32
 
ˇlcuœãd
;

180 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

183 
èû
 = (
jbd3_jou∫Æ_block_èû
 *)(
buf
 + 
j
->
j_blocksize
 -

184 (
jbd3_jou∫Æ_block_èû
));

185 
¥ovided
 = 
èû
->
t_checksum
;

186 
èû
->
t_checksum
 = 0;

187 
ˇlcuœãd
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

188 
èû
->
t_checksum
 = 
¥ovided
;

190  
¥ovided
 =
	`˝u_to_be32
(
ˇlcuœãd
);

191 
	}
}

197 
	$cou¡_ègs
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
)

199 * 
ègp
;

200 
jou∫Æ_block_èg_t
 * 
èg
;

201 
ƒ
 = 0, 
size
 = 
jou∫Æ
->
j_blocksize
;

202 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

204 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

205 
size
 -(
jbd3_jou∫Æ_block_èû
);

207 
ègp
 = &
bh
->
b_d©a
[(
jou∫Æ_hódî_t
)];

209 (
ègp
 - 
bh
->
b_d©a
 + 
èg_byãs
Ë<
size
) {

210 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

212 
ƒ
++;

213 
ègp
 +
èg_byãs
;

214 i‡(!(
èg
->
t_Êags
 & 
	`˝u_to_be16
(
JBD3_FLAG_SAME_UUID
)))

215 
ègp
 += 16;

217 i‡(
èg
->
t_Êags
 & 
	`˝u_to_be16
(
JBD3_FLAG_LAST_TAG
))

221  
ƒ
;

222 
	}
}

226 
	#wøp
(
jou∫Æ
, 
v¨
) \

228 i‡(
v¨
 >(
jou∫Æ
)->
j_œ°
) \

229 
v¨
 -((
jou∫Æ
)->
j_œ°
 - (jou∫Æ)->
j_fú°
); \

230 } 0)

	)

244 
	$jbd3_jou∫Æ_ªcovî
(
jou∫Æ_t
 *
jou∫Æ
)

246 
îr
, 
îr2
;

247 
jou∫Æ_su≥rblock_t
 * 
sb
;

249 
ªcovîy_öfo
 
öfo
;

251 
	`mem£t
(&
öfo
, 0, (info));

252 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

260 i‡(!
sb
->
s_°¨t
) {

261 
	`jbd_debug
(1, "NoÑecoveryÑequired,ÜastÅransaction %d\n",

262 
	`be32_to_˝u
(
sb
->
s_£quí˚
));

263 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
) + 1;

267 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_SCAN
);

268 i‡(!
îr
)

269 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_REVOKE
);

270 i‡(!
îr
)

271 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_REPLAY
);

273 
	`jbd_debug
(1, "JBD3:Ñecovery,Éxit status %d, "

275 
îr
, 
öfo
.
°¨t_å™ß˘i⁄
, info.
íd_å™ß˘i⁄
);

276 
	`jbd_debug
(1, "JBD3: Replayed %dándÑevoked %d/%d blocks\n",

277 
öfo
.
ƒ_ª∂ays
, info.
ƒ_ªvoke_hôs
, info.
ƒ_ªvokes
);

281 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = ++
öfo
.
íd_å™ß˘i⁄
;

283 
	`jbd3_jou∫Æ_˛ór_ªvoke
(
jou∫Æ
);

284 
îr2
 = 
	`sync_blockdev
(
jou∫Æ
->
j_fs_dev
);

285 i‡(!
îr
)

286 
îr
 = 
îr2
;

288 i‡(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
) {

289 
îr2
 = 
	`blkdev_issue_Êush
(
jou∫Æ
->
j_fs_dev
, 
GFP_KERNEL
, 
NULL
);

290 i‡(!
îr
)

291 
îr
 = 
îr2
;

293  
îr
;

294 
	}
}

309 
	$jbd3_jou∫Æ_skù_ªcovîy
(
jou∫Æ_t
 *
jou∫Æ
)

311 
îr
;

313 
ªcovîy_öfo
 
öfo
;

315 
	`mem£t
 (&
öfo
, 0, (info));

317 
îr
 = 
	`do_⁄e_∑ss
(
jou∫Æ
, &
öfo
, 
PASS_SCAN
);

319 i‡(
îr
) {

320 
	`¥ötk
(
KERN_ERR
 "JBD3:Éº‹ %d sˇ¬ög jou∫Æ\n", 
îr
);

321 ++
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
;

323 #ifde‡
CONFIG_JBD3_DEBUG


324 
dr›≥d
 = 
öfo
.
íd_å™ß˘i⁄
 -

325 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_£quí˚
);

326 
	`jbd_debug
(1,

328 
dr›≥d
, (dropped == 1) ? "" : "s");

330 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
 = ++
öfo
.
íd_å™ß˘i⁄
;

333 
jou∫Æ
->
j_èû
 = 0;

334  
îr
;

335 
	}
}

337 
ölöe
 
	$ªad_èg_block
(
jou∫Æ_t
 *
jou∫Æ
,

338 
jou∫Æ_block_èg_t
 *
èg
)

340 
block
 = 
	`be32_to_˝u
(
èg
->
t_blockƒ
);

341 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

342 
block
 |(
u64
)
	`be32_to_˝u
(
èg
->
t_blockƒ_high
) << 32;

343  
block
;

344 
	}
}

350 
	$ˇlc_chksums
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

351 *
√xt_log_block
, 
__u32
 *
¸c32_sum
)

353 
i
, 
num_blks
, 
îr
;

354 
io_block
;

355 
buf„r_hód
 *
obh
;

357 
num_blks
 = 
	`cou¡_ègs
(
jou∫Æ
, 
bh
);

359 *
¸c32_sum
 = 
	`¸c32_be
(*¸c32_sum, (*)
bh
->
b_d©a
, bh->
b_size
);

361 
i
 = 0; i < 
num_blks
; i++) {

362 
io_block
 = (*
√xt_log_block
)++;

363 
	`wøp
(
jou∫Æ
, *
√xt_log_block
);

364 
îr
 = 
	`jªad
(&
obh
, 
jou∫Æ
, 
io_block
);

365 i‡(
îr
) {

366 
	`¥ötk
(
KERN_ERR
 "JBD3: IOÉrror %dÑecovering block "

367 "%lu i¿log\n", 
îr
, 
io_block
);

370 *
¸c32_sum
 = 
	`¸c32_be
(*¸c32_sum, (*)
obh
->
b_d©a
,

371 
obh
->
b_size
);

373 
	`put_bh
(
obh
);

376 
	}
}

378 
	$jbd3_commô_block_csum_vîify
(
jou∫Æ_t
 *
j
, *
buf
)

380 
commô_hódî
 *
h
;

381 
__be32
 
¥ovided
;

382 
__u32
 
ˇlcuœãd
;

384 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

387 
h
 = 
buf
;

388 
¥ovided
 = 
h
->
h_chksum
[0];

389 
h
->
h_chksum
[0] = 0;

390 
ˇlcuœãd
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, 
buf
, j->
j_blocksize
);

391 
h
->
h_chksum
[0] = 
¥ovided
;

393  
¥ovided
 =
	`˝u_to_be32
(
ˇlcuœãd
);

394 
	}
}

396 
	$jbd3_block_èg_csum_vîify
(
jou∫Æ_t
 *
j
, 
jou∫Æ_block_èg_t
 *
èg
,

397 *
buf
, 
__u32
 
£quí˚
)

399 
jou∫Æ_block_èg3_t
 *
èg3
 = (jou∫Æ_block_èg3_à*)
èg
;

400 
__u32
 
csum32
;

401 
__be32
 
£q
;

403 i‡(!
	`jbd3_jou∫Æ_has_csum_v2‹3
(
j
))

406 
£q
 = 
	`˝u_to_be32
(
£quí˚
);

407 
csum32
 = 
	`jbd3_chksum
(
j
, j->
j_csum_£ed
, (
__u8
 *)&
£q
, (seq));

408 
csum32
 = 
	`jbd3_chksum
(
j
, csum32, 
buf
, j->
j_blocksize
);

410 i‡(
	`jbd3_has_„©uª_csum3
(
j
))

411  
èg3
->
t_checksum
 =
	`˝u_to_be32
(
csum32
);

413  
èg
->
t_checksum
 =
	`˝u_to_be16
(
csum32
);

414 
	}
}

416 
	$do_⁄e_∑ss
(
jou∫Æ_t
 *
jou∫Æ
,

417 
ªcovîy_öfo
 *
öfo
, 
∑s°y≥
 
∑ss
)

419 
fú°_commô_ID
, 
√xt_commô_ID
;

420 
√xt_log_block
;

421 
îr
, 
suc˚ss
 = 0;

422 
jou∫Æ_su≥rblock_t
 * 
sb
;

423 
jou∫Æ_hódî_t
 * 
tmp
;

424 
buf„r_hód
 * 
bh
;

425 
£quí˚
;

426 
blockty≥
;

427 
èg_byãs
 = 
	`jou∫Æ_èg_byãs
(
jou∫Æ
);

428 
__u32
 
¸c32_sum
 = ~0;

429 
des¸_csum_size
 = 0;

430 
block_îr‹
 = 0;

438 
sb
 = 
jou∫Æ
->
j_su≥rblock
;

439 
√xt_commô_ID
 = 
	`be32_to_˝u
(
sb
->
s_£quí˚
);

440 
√xt_log_block
 = 
	`be32_to_˝u
(
sb
->
s_°¨t
);

442 
fú°_commô_ID
 = 
√xt_commô_ID
;

443 i‡(
∑ss
 =
PASS_SCAN
)

444 
öfo
->
°¨t_å™ß˘i⁄
 = 
fú°_commô_ID
;

446 
	`jbd_debug
(1, "SèπögÑecovîyÖas†%d\n", 
∑ss
);

456 
Êags
;

457 * 
ègp
;

458 
jou∫Æ_block_èg_t
 * 
èg
;

459 
buf„r_hód
 * 
obh
;

460 
buf„r_hód
 * 
nbh
;

462 
	`c⁄d_ªsched
();

468 i‡(
∑ss
 !
PASS_SCAN
)

469 i‡(
	`tid_geq
(
√xt_commô_ID
, 
öfo
->
íd_å™ß˘i⁄
))

472 
	`jbd_debug
(2, "Scanning for sequence ID %uát %lu/%lu\n",

473 
√xt_commô_ID
, 
√xt_log_block
, 
jou∫Æ
->
j_œ°
);

479 
	`jbd_debug
(3, "JBD3: checkög block %ld\n", 
√xt_log_block
);

480 
îr
 = 
	`jªad
(&
bh
, 
jou∫Æ
, 
√xt_log_block
);

481 i‡(
îr
)

482 
Áûed
;

484 
√xt_log_block
++;

485 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

493 
tmp
 = (
jou∫Æ_hódî_t
 *)
bh
->
b_d©a
;

495 i‡(
tmp
->
h_magic
 !
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
)) {

496 
	`bªl£
(
bh
);

500 
blockty≥
 = 
	`be32_to_˝u
(
tmp
->
h_blockty≥
);

501 
£quí˚
 = 
	`be32_to_˝u
(
tmp
->
h_£quí˚
);

502 
	`jbd_debug
(3, "Found magic %d, sequence %d\n",

503 
blockty≥
, 
£quí˚
);

505 i‡(
£quí˚
 !
√xt_commô_ID
) {

506 
	`bªl£
(
bh
);

514 
blockty≥
) {

515 
JBD3_DESCRIPTOR_BLOCK
:

517 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

518 
des¸_csum_size
 =

519 (
jbd3_jou∫Æ_block_èû
);

520 i‡(
des¸_csum_size
 > 0 &&

521 !
	`jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ
,

522 
bh
->
b_d©a
)) {

523 
	`¥ötk
(
KERN_ERR
 "JBD3: Invalid checksum "

525 
√xt_log_block
);

526 
îr
 = -
EFSBADCRC
;

527 
	`bªl£
(
bh
);

528 
Áûed
;

535 i‡(
∑ss
 !
PASS_REPLAY
) {

536 i‡(
∑ss
 =
PASS_SCAN
 &&

537 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
) &&

538 !
öfo
->
íd_å™ß˘i⁄
) {

539 i‡(
	`ˇlc_chksums
(
jou∫Æ
, 
bh
,

540 &
√xt_log_block
,

541 &
¸c32_sum
)) {

542 
	`put_bh
(
bh
);

545 
	`put_bh
(
bh
);

548 
√xt_log_block
 +
	`cou¡_ègs
(
jou∫Æ
, 
bh
);

549 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

550 
	`put_bh
(
bh
);

558 
ègp
 = &
bh
->
b_d©a
[(
jou∫Æ_hódî_t
)];

559 (
ègp
 - 
bh
->
b_d©a
 + 
èg_byãs
)

560 <
jou∫Æ
->
j_blocksize
 - 
des¸_csum_size
) {

561 
io_block
;

563 
èg
 = (
jou∫Æ_block_èg_t
 *Ë
ègp
;

564 
Êags
 = 
	`be16_to_˝u
(
èg
->
t_Êags
);

566 
io_block
 = 
√xt_log_block
++;

567 
	`wøp
(
jou∫Æ
, 
√xt_log_block
);

568 
îr
 = 
	`jªad
(&
obh
, 
jou∫Æ
, 
io_block
);

569 i‡(
îr
) {

572 
suc˚ss
 = 
îr
;

573 
	`¥ötk
(
KERN_ERR


576 
îr
, 
io_block
);

578 
blockƒ
;

580 
	`J_ASSERT
(
obh
 !
NULL
);

581 
blockƒ
 = 
	`ªad_èg_block
(
jou∫Æ
,

582 
èg
);

587 i‡(
jbd3_jou∫Æ_ã°_ªvoke


588 (
jou∫Æ
, 
blockƒ
,

589 
√xt_commô_ID
)) {

590 
	`bªl£
(
obh
);

591 ++
öfo
->
ƒ_ªvoke_hôs
;

592 
skù_wrôe
;

596 i‡(!
	`jbd3_block_èg_csum_vîify
(

597 
jou∫Æ
, 
èg
, 
obh
->
b_d©a
,

598 
	`be32_to_˝u
(
tmp
->
h_£quí˚
))) {

599 
	`bªl£
(
obh
);

600 
suc˚ss
 = -
EFSBADCRC
;

601 
	`¥ötk
(
KERN_ERR
 "JBD3: Invalid "

604 "log\n", 
blockƒ
);

605 
block_îr‹
 = 1;

606 
skù_wrôe
;

611 
nbh
 = 
	`__gëblk
(
jou∫Æ
->
j_fs_dev
,

612 
blockƒ
,

613 
jou∫Æ
->
j_blocksize
);

614 i‡(
nbh
 =
NULL
) {

615 
	`¥ötk
(
KERN_ERR


618 
îr
 = -
ENOMEM
;

619 
	`bªl£
(
bh
);

620 
	`bªl£
(
obh
);

621 
Áûed
;

624 
	`lock_buf„r
(
nbh
);

625 
	`mem˝y
(
nbh
->
b_d©a
, 
obh
->b_data,

626 
jou∫Æ
->
j_blocksize
);

627 i‡(
Êags
 & 
JBD3_FLAG_ESCAPE
) {

628 *((
__be32
 *)
nbh
->
b_d©a
) =

629 
	`˝u_to_be32
(
JBD3_MAGIC_NUMBER
);

632 
	`BUFFER_TRACE
(
nbh
, "marking dirty");

633 
	`£t_buf„r_u±od©e
(
nbh
);

634 
	`m¨k_buf„r_dúty
(
nbh
);

635 
	`BUFFER_TRACE
(
nbh
, "marking uptodate");

636 ++
öfo
->
ƒ_ª∂ays
;

638 
	`u∆ock_buf„r
(
nbh
);

639 
	`bªl£
(
obh
);

640 
	`bªl£
(
nbh
);

643 
skù_wrôe
:

644 
ègp
 +
èg_byãs
;

645 i‡(!(
Êags
 & 
JBD3_FLAG_SAME_UUID
))

646 
ègp
 += 16;

648 i‡(
Êags
 & 
JBD3_FLAG_LAST_TAG
)

652 
	`bªl£
(
bh
);

655 
JBD3_COMMIT_BLOCK
:

691 i‡(
∑ss
 =
PASS_SCAN
 &&

692 
	`jbd3_has_„©uª_checksum
(
jou∫Æ
)) {

693 
chksum_îr
, 
chksum_£í
;

694 
commô_hódî
 *
cbh
 =

695 (
commô_hódî
 *)
bh
->
b_d©a
;

696 
found_chksum
 =

697 
	`be32_to_˝u
(
cbh
->
h_chksum
[0]);

699 
chksum_îr
 = 
chksum_£í
 = 0;

701 i‡(
öfo
->
íd_å™ß˘i⁄
) {

702 
jou∫Æ
->
j_Áûed_commô
 =

703 
öfo
->
íd_å™ß˘i⁄
;

704 
	`bªl£
(
bh
);

708 i‡(
¸c32_sum
 =
found_chksum
 &&

709 
cbh
->
h_chksum_ty≥
 =
JBD3_CRC32_CHKSUM
 &&

710 
cbh
->
h_chksum_size
 ==

711 
JBD3_CRC32_CHKSUM_SIZE
)

712 
chksum_£í
 = 1;

713 i‡(!(
cbh
->
h_chksum_ty≥
 == 0 &&

714 
cbh
->
h_chksum_size
 == 0 &&

715 
found_chksum
 == 0 &&

716 !
chksum_£í
))

727 
chksum_îr
 = 1;

729 i‡(
chksum_îr
) {

730 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

732 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

733 
jou∫Æ
->
j_Áûed_commô
 =

734 
√xt_commô_ID
;

735 
	`bªl£
(
bh
);

739 
¸c32_sum
 = ~0;

741 i‡(
∑ss
 =
PASS_SCAN
 &&

742 !
	`jbd3_commô_block_csum_vîify
(
jou∫Æ
,

743 
bh
->
b_d©a
)) {

744 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

746 i‡(!
	`jbd3_has_„©uª_async_commô
(
jou∫Æ
)) {

747 
jou∫Æ
->
j_Áûed_commô
 =

748 
√xt_commô_ID
;

749 
	`bªl£
(
bh
);

753 
	`bªl£
(
bh
);

754 
√xt_commô_ID
++;

757 
JBD3_REVOKE_BLOCK
:

760 i‡(
∑ss
 !
PASS_REVOKE
) {

761 
	`bªl£
(
bh
);

765 
îr
 = 
	`sˇn_ªvoke_ªc‹ds
(
jou∫Æ
, 
bh
,

766 
√xt_commô_ID
, 
öfo
);

767 
	`bªl£
(
bh
);

768 i‡(
îr
)

769 
Áûed
;

773 
	`jbd_debug
(3, "Unrecognised magic %d,Énd of scan.\n",

774 
blockty≥
);

775 
	`bªl£
(
bh
);

776 
d⁄e
;

780 
d⁄e
:

788 i‡(
∑ss
 =
PASS_SCAN
) {

789 i‡(!
öfo
->
íd_å™ß˘i⁄
)

790 
öfo
->
íd_å™ß˘i⁄
 = 
√xt_commô_ID
;

794 i‡(
öfo
->
íd_å™ß˘i⁄
 !
√xt_commô_ID
) {

795 
	`¥ötk
(
KERN_ERR
 "JBD3:ÑecoveryÖass %dÉndedát "

797 
∑ss
, 
√xt_commô_ID
, 
öfo
->
íd_å™ß˘i⁄
);

798 i‡(!
suc˚ss
)

799 
suc˚ss
 = -
EIO
;

802 i‡(
block_îr‹
 && 
suc˚ss
 == 0)

803 
suc˚ss
 = -
EIO
;

804  
suc˚ss
;

806 
Áûed
:

807  
îr
;

808 
	}
}

812 
	$sˇn_ªvoke_ªc‹ds
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

813 
tid_t
 
£quí˚
, 
ªcovîy_öfo
 *
öfo
)

815 
jbd3_jou∫Æ_ªvoke_hódî_t
 *
hódî
;

816 
off£t
, 
max
;

817 
csum_size
 = 0;

818 
__u32
 
rcou¡
;

819 
ªc‹d_Àn
 = 4;

821 
hódî
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
 *Ë
bh
->
b_d©a
;

822 
off£t
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
);

823 
rcou¡
 = 
	`be32_to_˝u
(
hódî
->
r_cou¡
);

825 i‡(!
	`jbd3_des¸ùt‹_block_csum_vîify
(
jou∫Æ
, 
hódî
))

826  -
EFSBADCRC
;

828 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

829 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

830 i‡(
rcou¡
 > 
jou∫Æ
->
j_blocksize
 - 
csum_size
)

831  -
EINVAL
;

832 
max
 = 
rcou¡
;

834 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

835 
ªc‹d_Àn
 = 8;

837 
off£t
 + 
ªc‹d_Àn
 <
max
) {

838 
blockƒ
;

839 
îr
;

841 i‡(
ªc‹d_Àn
 == 4)

842 
blockƒ
 = 
	`be32_to_˝u
(* ((
__be32
 *Ë(
bh
->
b_d©a
+
off£t
)));

844 
blockƒ
 = 
	`be64_to_˝u
(* ((
__be64
 *Ë(
bh
->
b_d©a
+
off£t
)));

845 
off£t
 +
ªc‹d_Àn
;

846 
îr
 = 
	`jbd3_jou∫Æ_£t_ªvoke
(
jou∫Æ
, 
blockƒ
, 
£quí˚
);

847 i‡(
îr
)

848  
îr
;

849 ++
öfo
->
ƒ_ªvokes
;

852 
	}
}

	@jbd3/revoke.c

80 #i‚de‡
__KERNEL__


81 
	~"jfs_u£r.h
"

83 
	~<löux/time.h
>

84 
	~<löux/fs.h
>

85 
	~<löux/jbd3.h
>

86 
	~<löux/î∫o.h
>

87 
	~<löux/¶ab.h
>

88 
	~<löux/li°.h
>

89 
	~<löux/öô.h
>

90 
	~<löux/bio.h
>

91 
	~<löux/log2.h
>

92 
	~<löux/hash.h
>

95 
kmem_ˇche
 *
	gjbd3_ªvoke_ªc‹d_ˇche
;

96 
kmem_ˇche
 *
	gjbd3_ªvoke_èbÀ_ˇche
;

102 
	sjbd3_ªvoke_ªc‹d_s


104 
li°_hód
 
	mhash
;

105 
tid_t
 
	m£quí˚
;

106 
	mblockƒ
;

111 
	sjbd3_ªvoke_èbÀ_s


115 
	mhash_size
;

116 
	mhash_shi·
;

117 
li°_hód
 *
	mhash_èbÀ
;

121 #ifde‡
__KERNEL__


122 
wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄_t
 *,

123 
li°_hód
 *,

124 
buf„r_hód
 **, *,

125 
jbd3_ªvoke_ªc‹d_s
 *);

126 
Êush_des¸ùt‹
(
jou∫Æ_t
 *, 
buf„r_hód
 *, );

131 
ölöe
 
	$hash
(
jou∫Æ_t
 *
jou∫Æ
, 
block
)

133  
	`hash_64
(
block
, 
jou∫Æ
->
j_ªvoke
->
hash_shi·
);

134 
	}
}

136 
	$ö£π_ªvoke_hash
(
jou∫Æ_t
 *
jou∫Æ
, 
blockƒ
,

137 
tid_t
 
£q
)

139 
li°_hód
 *
hash_li°
;

140 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

141 
gÂ_t
 
gÂ_mask
 = 
GFP_NOFS
;

143 i‡(
jou∫Æ_oom_ªåy
)

144 
gÂ_mask
 |
__GFP_NOFAIL
;

145 
ªc‹d
 = 
	`kmem_ˇche_Æloc
(
jbd3_ªvoke_ªc‹d_ˇche
, 
gÂ_mask
);

146 i‡(!
ªc‹d
)

147  -
ENOMEM
;

149 
ªc‹d
->
£quí˚
 = 
£q
;

150 
ªc‹d
->
blockƒ
 = blocknr;

151 
hash_li°
 = &
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
	`hash
(jou∫Æ, 
blockƒ
)];

152 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

153 
	`li°_add
(&
ªc‹d
->
hash
, 
hash_li°
);

154 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

156 
	}
}

160 
jbd3_ªvoke_ªc‹d_s
 *
	$föd_ªvoke_ªc‹d
(
jou∫Æ_t
 *
jou∫Æ
,

161 
blockƒ
)

163 
li°_hód
 *
hash_li°
;

164 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

166 
hash_li°
 = &
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
	`hash
(jou∫Æ, 
blockƒ
)];

168 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

169 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *Ë
hash_li°
->
√xt
;

170 &(
ªc‹d
->
hash
Ë!
hash_li°
) {

171 i‡(
ªc‹d
->
blockƒ
 == blocknr) {

172 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

173  
ªc‹d
;

175 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *Ëªc‹d->
hash
.
√xt
;

177 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

178  
NULL
;

179 
	}
}

181 
	$jbd3_jou∫Æ_de°roy_ªvoke_ªc‹d_ˇche
()

183 
	`kmem_ˇche_de°roy
(
jbd3_ªvoke_ªc‹d_ˇche
);

184 
jbd3_ªvoke_ªc‹d_ˇche
 = 
NULL
;

185 
	}
}

187 
	$jbd3_jou∫Æ_de°roy_ªvoke_èbÀ_ˇche
()

189 
	`kmem_ˇche_de°roy
(
jbd3_ªvoke_èbÀ_ˇche
);

190 
jbd3_ªvoke_èbÀ_ˇche
 = 
NULL
;

191 
	}
}

193 
__öô
 
	$jbd3_jou∫Æ_öô_ªvoke_ªc‹d_ˇche
()

195 
	`J_ASSERT
(!
jbd3_ªvoke_ªc‹d_ˇche
);

196 
jbd3_ªvoke_ªc‹d_ˇche
 = 
	`KMEM_CACHE
(
jbd3_ªvoke_ªc‹d_s
,

197 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
);

199 i‡(!
jbd3_ªvoke_ªc‹d_ˇche
) {

200 
	`¥_emîg
("JBD3: failedÅo createÑevoke_record cache\n");

201  -
ENOMEM
;

204 
	}
}

206 
__öô
 
	$jbd3_jou∫Æ_öô_ªvoke_èbÀ_ˇche
()

208 
	`J_ASSERT
(!
jbd3_ªvoke_èbÀ_ˇche
);

209 
jbd3_ªvoke_èbÀ_ˇche
 = 
	`KMEM_CACHE
(
jbd3_ªvoke_èbÀ_s
,

210 
SLAB_TEMPORARY
);

211 i‡(!
jbd3_ªvoke_èbÀ_ˇche
) {

212 
	`¥_emîg
("JBD3: failedÅo createÑevoke_table cache\n");

213  -
ENOMEM
;

216 
	}
}

218 
jbd3_ªvoke_èbÀ_s
 *
	$jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
)

220 
shi·
 = 0;

221 
tmp
 = 
hash_size
;

222 
jbd3_ªvoke_èbÀ_s
 *
èbÀ
;

224 
èbÀ
 = 
	`kmem_ˇche_Æloc
(
jbd3_ªvoke_èbÀ_ˇche
, 
GFP_KERNEL
);

225 i‡(!
èbÀ
)

226 
out
;

228 (
tmp
 >>= 1UL) != 0UL)

229 
shi·
++;

231 
èbÀ
->
hash_size
 = hash_size;

232 
èbÀ
->
hash_shi·
 = 
shi·
;

233 
èbÀ
->
hash_èbÀ
 =

234 
	`kmÆloc_¨øy
(
hash_size
, (
li°_hód
), 
GFP_KERNEL
);

235 i‡(!
èbÀ
->
hash_èbÀ
) {

236 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_èbÀ_ˇche
, 
èbÀ
);

237 
èbÀ
 = 
NULL
;

238 
out
;

241 
tmp
 = 0;Åm∞< 
hash_size
;Åmp++)

242 
	`INIT_LIST_HEAD
(&
èbÀ
->
hash_èbÀ
[
tmp
]);

244 
out
:

245  
èbÀ
;

246 
	}
}

248 
	$jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jbd3_ªvoke_èbÀ_s
 *
èbÀ
)

250 
i
;

251 
li°_hód
 *
hash_li°
;

253 
i
 = 0; i < 
èbÀ
->
hash_size
; i++) {

254 
hash_li°
 = &
èbÀ
->
hash_èbÀ
[
i
];

255 
	`J_ASSERT
(
	`li°_em±y
(
hash_li°
));

258 
	`k‰ì
(
èbÀ
->
hash_èbÀ
);

259 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_èbÀ_ˇche
, 
èbÀ
);

260 
	}
}

263 
	$jbd3_jou∫Æ_öô_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
, 
hash_size
)

265 
	`J_ASSERT
(
jou∫Æ
->
j_ªvoke_èbÀ
[0] =
NULL
);

266 
	`J_ASSERT
(
	`is_powî_of_2
(
hash_size
));

268 
jou∫Æ
->
j_ªvoke_èbÀ
[0] = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
);

269 i‡(!
jou∫Æ
->
j_ªvoke_èbÀ
[0])

270 
Áû0
;

272 
jou∫Æ
->
j_ªvoke_èbÀ
[1] = 
	`jbd3_jou∫Æ_öô_ªvoke_èbÀ
(
hash_size
);

273 i‡(!
jou∫Æ
->
j_ªvoke_èbÀ
[1])

274 
Áû1
;

276 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[1];

278 
	`•ö_lock_öô
(&
jou∫Æ
->
j_ªvoke_lock
);

282 
Áû1
:

283 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[0]);

284 
jou∫Æ
->
j_ªvoke_èbÀ
[0] = 
NULL
;

285 
Áû0
:

286  -
ENOMEM
;

287 
	}
}

290 
	$jbd3_jou∫Æ_de°roy_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
)

292 
jou∫Æ
->
j_ªvoke
 = 
NULL
;

293 i‡(
jou∫Æ
->
j_ªvoke_èbÀ
[0])

294 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[0]);

295 i‡(
jou∫Æ
->
j_ªvoke_èbÀ
[1])

296 
	`jbd3_jou∫Æ_de°roy_ªvoke_èbÀ
(
jou∫Æ
->
j_ªvoke_èbÀ
[1]);

297 
	}
}

300 #ifde‡
__KERNEL__


326 
	$jbd3_jou∫Æ_ªvoke
(
h™dÀ_t
 *
h™dÀ
, 
blockƒ
,

327 
buf„r_hód
 *
bh_ö
)

329 
buf„r_hód
 *
bh
 = 
NULL
;

330 
jou∫Æ_t
 *
jou∫Æ
;

331 
block_devi˚
 *
bdev
;

332 
îr
;

334 
	`might_¶ìp
();

335 i‡(
bh_ö
)

336 
	`BUFFER_TRACE
(
bh_ö
, "enter");

338 
jou∫Æ
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
;

339 i‡(!
	`jbd3_jou∫Æ_£t_„©uªs
(
jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)){

340 
	`J_ASSERT
 (!"Cannot setÑevoke feature!");

341  -
EINVAL
;

344 
bdev
 = 
jou∫Æ
->
j_fs_dev
;

345 
bh
 = 
bh_ö
;

347 i‡(!
bh
) {

348 
bh
 = 
	`__föd_gë_block
(
bdev
, 
blockƒ
, 
jou∫Æ
->
j_blocksize
);

349 i‡(
bh
)

350 
	`BUFFER_TRACE
(
bh
, "found on hash");

352 #ifde‡
JBD3_EXPENSIVE_CHECKING


354 
buf„r_hód
 *
bh2
;

358 
bh2
 = 
	`__föd_gë_block
(
bdev
, 
blockƒ
, 
jou∫Æ
->
j_blocksize
);

359 i‡(
bh2
) {

361 i‡(
bh2
 !
bh
 && 
	`buf„r_ªvokevÆid
(bh2))

368 
	`J_ASSERT_BH
(
bh2
, 
	`buf„r_ªvoked
(bh2));

369 
	`put_bh
(
bh2
);

377 i‡(
bh
) {

378 i‡(!
	`J_EXPECT_BH
(
bh
, !
	`buf„r_ªvoked
(bh),

380 i‡(!
bh_ö
)

381 
	`bªl£
(
bh
);

382  -
EIO
;

384 
	`£t_buf„r_ªvoked
(
bh
);

385 
	`£t_buf„r_ªvokevÆid
(
bh
);

386 i‡(
bh_ö
) {

387 
	`BUFFER_TRACE
(
bh_ö
, "call jbd3_journal_forget");

388 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh_ö
);

390 
	`BUFFER_TRACE
(
bh
, "call brelse");

391 
	`__bªl£
(
bh
);

395 
	`jbd_debug
(2, "ö£πÑevokêf‹ block %Œu, bh_ö=%p\n",
blockƒ
, 
bh_ö
);

396 
îr
 = 
	`ö£π_ªvoke_hash
(
jou∫Æ
, 
blockƒ
,

397 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
);

398 
	`BUFFER_TRACE
(
bh_ö
, "exit");

399  
îr
;

400 
	}
}

417 
	$jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ_t
 *
h™dÀ
, 
jou∫Æ_hód
 *
jh
)

419 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

420 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
;

421 
√ed_ˇn˚l
;

422 
did_ªvoke
 = 0;

423 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

425 
	`jbd_debug
(4, "jou∫Æ_hód %p, c™˚ŒögÑevoke\n", 
jh
);

431 i‡(
	`ã°_£t_buf„r_ªvokevÆid
(
bh
)) {

432 
√ed_ˇn˚l
 = 
	`ã°_˛ór_buf„r_ªvoked
(
bh
);

434 
√ed_ˇn˚l
 = 1;

435 
	`˛ór_buf„r_ªvoked
(
bh
);

438 i‡(
√ed_ˇn˚l
) {

439 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
bh
->
b_blockƒ
);

440 i‡(
ªc‹d
) {

441 
	`jbd_debug
(4, "cancelledÉxistingÑevoke on "

442 "blockƒ %Œu\n", ()
bh
->
b_blockƒ
);

443 
	`•ö_lock
(&
jou∫Æ
->
j_ªvoke_lock
);

444 
	`li°_dñ
(&
ªc‹d
->
hash
);

445 
	`•ö_u∆ock
(&
jou∫Æ
->
j_ªvoke_lock
);

446 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

447 
did_ªvoke
 = 1;

451 #ifde‡
JBD3_EXPENSIVE_CHECKING


453 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
bh
->
b_blockƒ
);

454 
	`J_ASSERT_JH
(
jh
, 
ªc‹d
 =
NULL
);

461 i‡(
√ed_ˇn˚l
) {

462 
buf„r_hód
 *
bh2
;

463 
bh2
 = 
	`__föd_gë_block
(
bh
->
b_bdev
, bh->
b_blockƒ
, bh->
b_size
);

464 i‡(
bh2
) {

465 i‡(
bh2
 !
bh
)

466 
	`˛ór_buf„r_ªvoked
(
bh2
);

467 
	`__bªl£
(
bh2
);

470  
did_ªvoke
;

471 
	}
}

478 
	$jbd3_˛ór_buf„r_ªvoked_Êags
(
jou∫Æ_t
 *
jou∫Æ
)

480 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
 = 
jou∫Æ
->
j_ªvoke
;

481 
i
 = 0;

483 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

484 
li°_hód
 *
hash_li°
;

485 
li°_hód
 *
li°_íåy
;

486 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

488 
	`li°_f‹_óch
(
li°_íåy
, 
hash_li°
) {

489 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

490 
buf„r_hód
 *
bh
;

491 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *)
li°_íåy
;

492 
bh
 = 
	`__föd_gë_block
(
jou∫Æ
->
j_fs_dev
,

493 
ªc‹d
->
blockƒ
,

494 
jou∫Æ
->
j_blocksize
);

495 i‡(
bh
) {

496 
	`˛ór_buf„r_ªvoked
(
bh
);

497 
	`__bªl£
(
bh
);

501 
	}
}

507 
	$jbd3_jou∫Æ_swôch_ªvoke_èbÀ
(
jou∫Æ_t
 *
jou∫Æ
)

509 
i
;

511 i‡(
jou∫Æ
->
j_ªvoke
 =jou∫Æ->
j_ªvoke_èbÀ
[0])

512 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[1];

514 
jou∫Æ
->
j_ªvoke
 = jou∫Æ->
j_ªvoke_èbÀ
[0];

516 
i
 = 0; i < 
jou∫Æ
->
j_ªvoke
->
hash_size
; i++)

517 
	`INIT_LIST_HEAD
(&
jou∫Æ
->
j_ªvoke
->
hash_èbÀ
[
i
]);

518 
	}
}

524 
	$jbd3_jou∫Æ_wrôe_ªvoke_ªc‹ds
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

525 
li°_hód
 *
log_bufs
)

527 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

528 
buf„r_hód
 *
des¸ùt‹
;

529 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

530 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
;

531 
li°_hód
 *
hash_li°
;

532 
i
, 
off£t
, 
cou¡
;

534 
des¸ùt‹
 = 
NULL
;

535 
off£t
 = 0;

536 
cou¡
 = 0;

539 
ªvoke
 = 
jou∫Æ
->
j_ªvoke
 =jou∫Æ->
j_ªvoke_èbÀ
[0] ?

540 
jou∫Æ
->
j_ªvoke_èbÀ
[1] : journal->j_revoke_table[0];

542 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

543 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

545 !
	`li°_em±y
(
hash_li°
)) {

546 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
 *)

547 
hash_li°
->
√xt
;

548 
	`wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄
, 
log_bufs
,

549 &
des¸ùt‹
, &
off£t
, 
ªc‹d
);

550 
cou¡
++;

551 
	`li°_dñ
(&
ªc‹d
->
hash
);

552 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

555 i‡(
des¸ùt‹
)

556 
	`Êush_des¸ùt‹
(
jou∫Æ
, 
des¸ùt‹
, 
off£t
);

557 
	`jbd_debug
(1, "WrŸê%dÑevokêªc‹ds\n", 
cou¡
);

558 
	}
}

565 
	$wrôe_⁄e_ªvoke_ªc‹d
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

566 
li°_hód
 *
log_bufs
,

567 
buf„r_hód
 **
des¸ùt‹p
,

568 *
off£ç
,

569 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
)

571 
jou∫Æ_t
 *
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

572 
csum_size
 = 0;

573 
buf„r_hód
 *
des¸ùt‹
;

574 
sz
, 
off£t
;

580 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
))

583 
des¸ùt‹
 = *
des¸ùt‹p
;

584 
off£t
 = *
off£ç
;

587 i‡(
	`jbd3_jou∫Æ_has_csum_v2‹3
(
jou∫Æ
))

588 
csum_size
 = (
jbd3_jou∫Æ_block_èû
);

590 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

591 
sz
 = 8;

593 
sz
 = 4;

596 i‡(
des¸ùt‹
) {

597 i‡(
off£t
 + 
sz
 > 
jou∫Æ
->
j_blocksize
 - 
csum_size
) {

598 
	`Êush_des¸ùt‹
(
jou∫Æ
, 
des¸ùt‹
, 
off£t
);

599 
des¸ùt‹
 = 
NULL
;

603 i‡(!
des¸ùt‹
) {

604 
des¸ùt‹
 = 
	`jbd3_jou∫Æ_gë_des¸ùt‹_buf„r
(
å™ß˘i⁄
,

605 
JBD3_REVOKE_BLOCK
);

606 i‡(!
des¸ùt‹
)

610 
	`BUFFER_TRACE
(
des¸ùt‹
, "file inÜog_bufs");

611 
	`jbd3_fûe_log_bh
(
log_bufs
, 
des¸ùt‹
);

613 
off£t
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
);

614 *
des¸ùt‹p
 = 
des¸ùt‹
;

617 i‡(
	`jbd3_has_„©uª_64bô
(
jou∫Æ
))

618 * ((
__be64
 *)(&
des¸ùt‹
->
b_d©a
[
off£t
])) =

619 
	`˝u_to_be64
(
ªc‹d
->
blockƒ
);

621 * ((
__be32
 *)(&
des¸ùt‹
->
b_d©a
[
off£t
])) =

622 
	`˝u_to_be32
(
ªc‹d
->
blockƒ
);

623 
off£t
 +
sz
;

625 *
off£ç
 = 
off£t
;

626 
	}
}

635 
	$Êush_des¸ùt‹
(
jou∫Æ_t
 *
jou∫Æ
,

636 
buf„r_hód
 *
des¸ùt‹
,

637 
off£t
)

639 
jbd3_jou∫Æ_ªvoke_hódî_t
 *
hódî
;

641 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
)) {

642 
	`put_bh
(
des¸ùt‹
);

646 
hódî
 = (
jbd3_jou∫Æ_ªvoke_hódî_t
 *)
des¸ùt‹
->
b_d©a
;

647 
hódî
->
r_cou¡
 = 
	`˝u_to_be32
(
off£t
);

648 
	`jbd3_des¸ùt‹_block_csum_£t
(
jou∫Æ
, 
des¸ùt‹
);

650 
	`£t_buf„r_jwrôe
(
des¸ùt‹
);

651 
	`BUFFER_TRACE
(
des¸ùt‹
, "write");

652 
	`£t_buf„r_dúty
(
des¸ùt‹
);

653 
	`wrôe_dúty_buf„r
(
des¸ùt‹
, 
REQ_SYNC
);

654 
	}
}

679 
	$jbd3_jou∫Æ_£t_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
,

680 
blockƒ
,

681 
tid_t
 
£quí˚
)

683 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

685 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
blockƒ
);

686 i‡(
ªc‹d
) {

689 i‡(
	`tid_gt
(
£quí˚
, 
ªc‹d
->sequence))

690 
ªc‹d
->
£quí˚
 = sequence;

693  
	`ö£π_ªvoke_hash
(
jou∫Æ
, 
blockƒ
, 
£quí˚
);

694 
	}
}

703 
	$jbd3_jou∫Æ_ã°_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
,

704 
blockƒ
,

705 
tid_t
 
£quí˚
)

707 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

709 
ªc‹d
 = 
	`föd_ªvoke_ªc‹d
(
jou∫Æ
, 
blockƒ
);

710 i‡(!
ªc‹d
)

712 i‡(
	`tid_gt
(
£quí˚
, 
ªc‹d
->sequence))

715 
	}
}

722 
	$jbd3_jou∫Æ_˛ór_ªvoke
(
jou∫Æ_t
 *
jou∫Æ
)

724 
i
;

725 
li°_hód
 *
hash_li°
;

726 
jbd3_ªvoke_ªc‹d_s
 *
ªc‹d
;

727 
jbd3_ªvoke_èbÀ_s
 *
ªvoke
;

729 
ªvoke
 = 
jou∫Æ
->
j_ªvoke
;

731 
i
 = 0; i < 
ªvoke
->
hash_size
; i++) {

732 
hash_li°
 = &
ªvoke
->
hash_èbÀ
[
i
];

733 !
	`li°_em±y
(
hash_li°
)) {

734 
ªc‹d
 = (
jbd3_ªvoke_ªc‹d_s
*Ë
hash_li°
->
√xt
;

735 
	`li°_dñ
(&
ªc‹d
->
hash
);

736 
	`kmem_ˇche_‰ì
(
jbd3_ªvoke_ªc‹d_ˇche
, 
ªc‹d
);

739 
	}
}

	@jbd3/transaction.c

17 
	~<löux/time.h
>

18 
	~<löux/fs.h
>

19 
	~<löux/jbd3.h
>

20 
	~<löux/î∫o.h
>

21 
	~<löux/¶ab.h
>

22 
	~<löux/timî.h
>

23 
	~<löux/mm.h
>

24 
	~<löux/highmem.h
>

25 
	~<löux/hπimî.h
>

26 
	~<löux/backög-dev.h
>

27 
	~<löux/bug.h
>

28 
	~<löux/moduÀ.h
>

29 
	~<löux/sched/mm.h
>

31 
	~<åa˚/evíts/jbd3.h
>

33 
__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jou∫Æ_hód
 *
jh
);

34 
__jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_hód
 *
jh
);

36 
kmem_ˇche
 *
	gå™ß˘i⁄_ˇche
;

37 
__öô
 
	$jbd3_jou∫Æ_öô_å™ß˘i⁄_ˇche
()

39 
	`J_ASSERT
(!
å™ß˘i⁄_ˇche
);

40 
å™ß˘i⁄_ˇche
 = 
	`kmem_ˇche_¸óã
("jbd3_transaction_s",

41 (
å™ß˘i⁄_t
),

43 
SLAB_HWCACHE_ALIGN
|
SLAB_TEMPORARY
,

44 
NULL
);

45 i‡(!
å™ß˘i⁄_ˇche
) {

46 
	`¥_emîg
("JBD3: failedÅo createÅransaction cache\n");

47  -
ENOMEM
;

50 
	}
}

52 
	$jbd3_jou∫Æ_de°roy_å™ß˘i⁄_ˇche
()

54 
	`kmem_ˇche_de°roy
(
å™ß˘i⁄_ˇche
);

55 
å™ß˘i⁄_ˇche
 = 
NULL
;

56 
	}
}

58 
	$jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

60 i‡(
	`u∆ikñy
(
	`ZERO_OR_NULL_PTR
(
å™ß˘i⁄
)))

62 
	`kmem_ˇche_‰ì
(
å™ß˘i⁄_ˇche
, 
å™ß˘i⁄
);

63 
	}
}

80 
	$jbd3_gë_å™ß˘i⁄
(
jou∫Æ_t
 *
jou∫Æ
,

81 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

83 
å™ß˘i⁄
->
t_jou∫Æ
 = 
jou∫Æ
;

84 
å™ß˘i⁄
->
t_°©e
 = 
T_RUNNING
;

85 
å™ß˘i⁄
->
t_°¨t_time
 = 
	`ktime_gë
();

86 
å™ß˘i⁄
->
t_tid
 = 
jou∫Æ
->
j_å™ß˘i⁄_£quí˚
++;

87 
å™ß˘i⁄
->
t_expúes
 = 
jiffõs
 + 
jou∫Æ
->
j_commô_öãrvÆ
;

88 
	`•ö_lock_öô
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

89 
	`©omic_£t
(&
å™ß˘i⁄
->
t_upd©es
, 0);

90 
	`©omic_£t
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
,

91 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
));

92 
	`©omic_£t
(&
å™ß˘i⁄
->
t_h™dÀ_cou¡
, 0);

93 
	`INIT_LIST_HEAD
(&
å™ß˘i⁄
->
t_öode_li°
);

94 
	`INIT_LIST_HEAD
(&
å™ß˘i⁄
->
t_¥iv©e_li°
);

97 
jou∫Æ
->
j_commô_timî
.
expúes
 = 
	`round_jiffõs_up
(
å™ß˘i⁄
->
t_expúes
);

98 
	`add_timî
(&
jou∫Æ
->
j_commô_timî
);

100 
	`J_ASSERT
(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 =
NULL
);

101 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 = 
å™ß˘i⁄
;

102 
å™ß˘i⁄
->
t_max_waô
 = 0;

103 
å™ß˘i⁄
->
t_°¨t
 = 
jiffõs
;

104 
å™ß˘i⁄
->
t_ªque°ed
 = 0;

105 
	}
}

125 
ölöe
 
	$upd©e_t_max_waô
(
å™ß˘i⁄_t
 *
å™ß˘i⁄
,

126 
ts
)

128 #ifde‡
CONFIG_JBD3_DEBUG


129 i‡(
jbd3_jou∫Æ_íabÀ_debug
 &&

130 
	`time_a·î
(
å™ß˘i⁄
->
t_°¨t
, 
ts
)) {

131 
ts
 = 
	`jbd3_time_diff
—s, 
å™ß˘i⁄
->
t_°¨t
);

132 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

133 i‡(
ts
 > 
å™ß˘i⁄
->
t_max_waô
)

134 
å™ß˘i⁄
->
t_max_waô
 = 
ts
;

135 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

138 
	}
}

145 
	$waô_å™ß˘i⁄_locked
(
jou∫Æ_t
 *
jou∫Æ
)

146 
	`__ªÀa£s
(
jou∫Æ
->
j_°©e_lock
)

148 
	`DEFINE_WAIT
(
waô
);

149 
√ed_to_°¨t
;

150 
tid_t
 
tid
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
;

152 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
,

153 
TASK_UNINTERRUPTIBLE
);

154 
√ed_to_°¨t
 = !
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
);

155 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

156 i‡(
√ed_to_°¨t
)

157 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

158 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

159 
	`scheduÀ
();

160 
	`föish_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
);

161 
	}
}

168 
	$waô_å™ß˘i⁄_swôchög
(
jou∫Æ_t
 *
jou∫Æ
)

169 
	`__ªÀa£s
(
jou∫Æ
->
j_°©e_lock
)

171 
	`DEFINE_WAIT
(
waô
);

173 i‡(
	`WARN_ON
(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ||

174 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_°©e
 !
T_SWITCH
))

176 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
,

177 
TASK_UNINTERRUPTIBLE
);

178 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

185 
	`scheduÀ
();

186 
	`föish_waô
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
, &
waô
);

187 
	}
}

189 
	$sub_ª£rved_¸edôs
(
jou∫Æ_t
 *
jou∫Æ
, 
blocks
)

191 
	`©omic_sub
(
blocks
, &
jou∫Æ
->
j_ª£rved_¸edôs
);

192 
	`wake_up
(&
jou∫Æ
->
j_waô_ª£rved
);

193 
	}
}

201 
	$add_å™ß˘i⁄_¸edôs
(
jou∫Æ_t
 *
jou∫Æ
, 
blocks
,

202 
rsv_blocks
)

204 
å™ß˘i⁄_t
 *
t
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

205 
√eded
;

206 
tŸÆ
 = 
blocks
 + 
rsv_blocks
;

212 i‡(
t
->
t_°©e
 !
T_RUNNING
) {

213 
	`WARN_ON_ONCE
(
t
->
t_°©e
 >
T_FLUSH
);

214 
	`waô_å™ß˘i⁄_locked
(
jou∫Æ
);

223 
√eded
 = 
	`©omic_add_ªtu∫
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

224 i‡(
√eded
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

230 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

236 i‡(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
tŸÆ
 >

237 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

238 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

239 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

240 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

241 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
tŸÆ
 <=

242 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

246 
	`waô_å™ß˘i⁄_locked
(
jou∫Æ
);

261 i‡(
	`jbd3_log_•a˚_À·
(
jou∫Æ
Ë< 
	`jbd3_•a˚_√eded
(journal)) {

262 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

263 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

264 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

265 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

266 i‡(
	`jbd3_log_•a˚_À·
(
jou∫Æ
Ë< 
	`jbd3_•a˚_√eded
(journal))

267 
	`__jbd3_log_waô_f‹_•a˚
(
jou∫Æ
);

268 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

273 i‡(!
rsv_blocks
)

276 
√eded
 = 
	`©omic_add_ªtu∫
(
rsv_blocks
, &
jou∫Æ
->
j_ª£rved_¸edôs
);

278 i‡(
√eded
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2) {

279 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
rsv_blocks
);

280 
	`©omic_sub
(
tŸÆ
, &
t
->
t_out°™dög_¸edôs
);

281 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

282 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

283 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

284 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
Ë+ 
rsv_blocks


285 <
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2);

289 
	}
}

298 
	$°¨t_this_h™dÀ
(
jou∫Æ_t
 *
jou∫Æ
, 
h™dÀ_t
 *
h™dÀ
,

299 
gÂ_t
 
gÂ_mask
)

301 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, *
√w_å™ß˘i⁄
 = 
NULL
;

302 
blocks
 = 
h™dÀ
->
h_buf„r_¸edôs
;

303 
rsv_blocks
 = 0;

304 
ts
 = 
jiffõs
;

306 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

307 
rsv_blocks
 = 
h™dÀ
->
h_rsv_h™dÀ
->
h_buf„r_¸edôs
;

314 i‡((
rsv_blocks
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
 / 2) ||

315 (
rsv_blocks
 + 
blocks
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
)) {

316 
	`¥ötk
(
KERN_ERR
 "JBD3: %s wantsÅoo many credits "

318 
cuºít
->
comm
, 
blocks
, 
rsv_blocks
,

319 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
);

320 
	`WARN_ON
(1);

321  -
ENOSPC
;

324 
Æloc_å™ß˘i⁄
:

325 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

330 i‡((
gÂ_mask
 & 
__GFP_FS
) == 0)

331 
gÂ_mask
 |
__GFP_NOFAIL
;

332 
√w_å™ß˘i⁄
 = 
	`kmem_ˇche_zÆloc
(
å™ß˘i⁄_ˇche
,

333 
gÂ_mask
);

334 i‡(!
√w_å™ß˘i⁄
)

335  -
ENOMEM
;

338 
	`jbd_debug
(3, "New h™dÀ %∞goögÜive.\n", 
h™dÀ
);

344 
ª≥©
:

345 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

346 
	`BUG_ON
(
jou∫Æ
->
j_Êags
 & 
JBD3_UNMOUNT
);

347 i‡(
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
) ||

348 (
jou∫Æ
->
j_î∫o
 !0 && !(jou∫Æ->
j_Êags
 & 
JBD3_ACK_ERR
))) {

349 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

350 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
√w_å™ß˘i⁄
);

351  -
EROFS
;

359 i‡(!
h™dÀ
->
h_ª£rved
 && 
jou∫Æ
->
j_b¨rõr_cou¡
) {

360 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

361 
	`waô_evít
(
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
,

362 
jou∫Æ
->
j_b¨rõr_cou¡
 == 0);

363 
ª≥©
;

366 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

367 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

368 i‡(!
√w_å™ß˘i⁄
)

369 
Æloc_å™ß˘i⁄
;

370 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

371 i‡(!
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 &&

372 (
h™dÀ
->
h_ª£rved
 || !
jou∫Æ
->
j_b¨rõr_cou¡
)) {

373 
	`jbd3_gë_å™ß˘i⁄
(
jou∫Æ
, 
√w_å™ß˘i⁄
);

374 
√w_å™ß˘i⁄
 = 
NULL
;

376 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

377 
ª≥©
;

380 
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

382 i‡(!
h™dÀ
->
h_ª£rved
) {

384 i‡(
	`add_å™ß˘i⁄_¸edôs
(
jou∫Æ
, 
blocks
, 
rsv_blocks
))

385 
ª≥©
;

394 i‡(
å™ß˘i⁄
->
t_°©e
 =
T_SWITCH
) {

395 
	`waô_å™ß˘i⁄_swôchög
(
jou∫Æ
);

396 
ª≥©
;

398 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
blocks
);

399 
h™dÀ
->
h_ª£rved
 = 0;

405 
	`upd©e_t_max_waô
(
å™ß˘i⁄
, 
ts
);

406 
h™dÀ
->
h_å™ß˘i⁄
 = 
å™ß˘i⁄
;

407 
h™dÀ
->
h_ªque°ed_¸edôs
 = 
blocks
;

408 
h™dÀ
->
h_°¨t_jiffõs
 = 
jiffõs
;

409 
	`©omic_öc
(&
å™ß˘i⁄
->
t_upd©es
);

410 
	`©omic_öc
(&
å™ß˘i⁄
->
t_h™dÀ_cou¡
);

411 
	`jbd_debug
(4, "Handle %p given %d credits (total %d, free %lu)\n",

412 
h™dÀ
, 
blocks
,

413 
	`©omic_ªad
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
),

414 
	`jbd3_log_•a˚_À·
(
jou∫Æ
));

415 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

416 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

418 
	`rw£m_acquúe_ªad
(&
jou∫Æ
->
j_å™s_commô_m≠
, 0, 0, 
_THIS_IP_
);

419 
	`jbd3_jou∫Æ_‰ì_å™ß˘i⁄
(
√w_å™ß˘i⁄
);

424 
h™dÀ
->
ßved_Æloc_c⁄ãxt
 = 
	`memÆloc_nofs_ßve
();

426 
	}
}

429 
h™dÀ_t
 *
	$√w_h™dÀ
(
nblocks
)

431 
h™dÀ_t
 *
h™dÀ
 = 
	`jbd3_Æloc_h™dÀ
(
GFP_NOFS
);

432 i‡(!
h™dÀ
)

433  
NULL
;

434 
h™dÀ
->
h_buf„r_¸edôs
 = 
nblocks
;

435 
h™dÀ
->
h_ªf
 = 1;

437  
h™dÀ
;

438 
	}
}

440 
h™dÀ_t
 *
	$jbd3__jou∫Æ_°¨t
(
jou∫Æ_t
 *
jou∫Æ
, 
nblocks
, 
rsv_blocks
,

441 
gÂ_t
 
gÂ_mask
, 
ty≥
,

442 
löe_no
)

444 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

445 
îr
;

447 i‡(!
jou∫Æ
)

448  
	`ERR_PTR
(-
EROFS
);

450 i‡(
h™dÀ
) {

451 
	`J_ASSERT
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
 =
jou∫Æ
);

452 
h™dÀ
->
h_ªf
++;

453  
h™dÀ
;

456 
h™dÀ
 = 
	`√w_h™dÀ
(
nblocks
);

457 i‡(!
h™dÀ
)

458  
	`ERR_PTR
(-
ENOMEM
);

459 i‡(
rsv_blocks
) {

460 
h™dÀ_t
 *
rsv_h™dÀ
;

462 
rsv_h™dÀ
 = 
	`√w_h™dÀ
(
rsv_blocks
);

463 i‡(!
rsv_h™dÀ
) {

464 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

465  
	`ERR_PTR
(-
ENOMEM
);

467 
rsv_h™dÀ
->
h_ª£rved
 = 1;

468 
rsv_h™dÀ
->
h_jou∫Æ
 = 
jou∫Æ
;

469 
h™dÀ
->
h_rsv_h™dÀ
 = 
rsv_h™dÀ
;

472 
îr
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
gÂ_mask
);

473 i‡(
îr
 < 0) {

474 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

475 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
->
h_rsv_h™dÀ
);

476 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

477  
	`ERR_PTR
(
îr
);

479 
h™dÀ
->
h_ty≥
 = 
ty≥
;

480 
h™dÀ
->
h_löe_no
 = 
löe_no
;

481 
	`åa˚_jbd3_h™dÀ_°¨t
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

482 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
, 
ty≥
,

483 
löe_no
, 
nblocks
);

485  
h™dÀ
;

486 
	}
}

487 
EXPORT_SYMBOL
(
jbd3__jou∫Æ_°¨t
);

509 
h™dÀ_t
 *
	$jbd3_jou∫Æ_°¨t
(
jou∫Æ_t
 *
jou∫Æ
, 
nblocks
)

511  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
nblocks
, 0, 
GFP_NOFS
, 0, 0);

512 
	}
}

513 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t
);

515 
	$jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

517 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_jou∫Æ
;

519 
	`WARN_ON
(!
h™dÀ
->
h_ª£rved
);

520 
	`sub_ª£rved_¸edôs
(
jou∫Æ
, 
h™dÀ
->
h_buf„r_¸edôs
);

521 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

522 
	}
}

523 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_‰ì_ª£rved
);

539 
	$jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
ty≥
,

540 
löe_no
)

542 
jou∫Æ_t
 *
jou∫Æ
 = 
h™dÀ
->
h_jou∫Æ
;

543 
ªt
 = -
EIO
;

545 i‡(
	`WARN_ON
(!
h™dÀ
->
h_ª£rved
)) {

547 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

548  
ªt
;

554 i‡(
	`WARN_ON
(
cuºít
->
jou∫Æ_öfo
)) {

555 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

556  
ªt
;

559 
h™dÀ
->
h_jou∫Æ
 = 
NULL
;

564 
ªt
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
GFP_NOFS
);

565 i‡(
ªt
 < 0) {

566 
h™dÀ
->
h_jou∫Æ
 = 
jou∫Æ
;

567 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

568  
ªt
;

570 
h™dÀ
->
h_ty≥
 = 
ty≥
;

571 
h™dÀ
->
h_löe_no
 = 
löe_no
;

573 
	}
}

574 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_°¨t_ª£rved
);

596 
	$jbd3_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

598 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

599 
jou∫Æ_t
 *
jou∫Æ
;

600 
ªsu…
;

601 
w™ãd
;

603 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

604  -
EROFS
;

605 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

607 
ªsu…
 = 1;

609 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

612 i‡(
å™ß˘i⁄
->
t_°©e
 !
T_RUNNING
) {

613 
	`jbd_debug
(3, "denied handle %p %d blocks: "

614 "å™ß˘i⁄ÇŸÑu¬ög\n", 
h™dÀ
, 
nblocks
);

615 
îr‹_out
;

618 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

619 
w™ãd
 = 
	`©omic_add_ªtu∫
(
nblocks
,

620 &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

622 i‡(
w™ãd
 > 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) {

623 
	`jbd_debug
(3, "denied handle %p %d blocks: "

624 "å™ß˘i⁄Åoÿœrge\n", 
h™dÀ
, 
nblocks
);

625 
	`©omic_sub
(
nblocks
, &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

626 
u∆ock
;

629 i‡(
w™ãd
 + (w™ãd >> 
JBD3_CONTROL_BLOCKS_SHIFT
) >

630 
	`jbd3_log_•a˚_À·
(
jou∫Æ
)) {

631 
	`jbd_debug
(3, "denied handle %p %d blocks: "

632 "ösufficõ¡Üog s∑˚\n", 
h™dÀ
, 
nblocks
);

633 
	`©omic_sub
(
nblocks
, &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

634 
u∆ock
;

637 
	`åa˚_jbd3_h™dÀ_exãnd
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

638 
å™ß˘i⁄
->
t_tid
,

639 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

640 
h™dÀ
->
h_buf„r_¸edôs
,

641 
nblocks
);

643 
h™dÀ
->
h_buf„r_¸edôs
 +
nblocks
;

644 
h™dÀ
->
h_ªque°ed_¸edôs
 +
nblocks
;

645 
ªsu…
 = 0;

647 
	`jbd_debug
(3, "exãnded h™dÀ %∞by %d\n", 
h™dÀ
, 
nblocks
);

648 
u∆ock
:

649 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

650 
îr‹_out
:

651 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

652  
ªsu…
;

653 
	}
}

672 
	$jbd3__jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
, 
gÂ_t
 
gÂ_mask
)

674 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

675 
jou∫Æ_t
 *
jou∫Æ
;

676 
tid_t
 
tid
;

677 
√ed_to_°¨t
, 
ªt
;

681 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

683 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

689 
	`J_ASSERT
(
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
) > 0);

690 
	`J_ASSERT
(
	`jou∫Æ_cuºít_h™dÀ
(Ë=
h™dÀ
);

692 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

693 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

694 
	`©omic_sub
(
h™dÀ
->
h_buf„r_¸edôs
,

695 &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

696 i‡(
h™dÀ
->
h_rsv_h™dÀ
) {

697 
	`sub_ª£rved_¸edôs
(
jou∫Æ
,

698 
h™dÀ
->
h_rsv_h™dÀ
->
h_buf„r_¸edôs
);

700 i‡(
	`©omic_dec_™d_ã°
(&
å™ß˘i⁄
->
t_upd©es
))

701 
	`wake_up
(&
jou∫Æ
->
j_waô_upd©es
);

702 
tid
 = 
å™ß˘i⁄
->
t_tid
;

703 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

704 
h™dÀ
->
h_å™ß˘i⁄
 = 
NULL
;

705 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

707 
	`jbd_debug
(2, "ª°¨tög h™dÀ %p\n", 
h™dÀ
);

708 
√ed_to_°¨t
 = !
	`tid_geq
(
jou∫Æ
->
j_commô_ªque°
, 
tid
);

709 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

710 i‡(
√ed_to_°¨t
)

711 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
tid
);

713 
	`rw£m_ªÀa£
(&
jou∫Æ
->
j_å™s_commô_m≠
, 1, 
_THIS_IP_
);

714 
h™dÀ
->
h_buf„r_¸edôs
 = 
nblocks
;

720 
	`memÆloc_nofs_ª°‹e
(
h™dÀ
->
ßved_Æloc_c⁄ãxt
);

721 
ªt
 = 
	`°¨t_this_h™dÀ
(
jou∫Æ
, 
h™dÀ
, 
gÂ_mask
);

722  
ªt
;

723 
	}
}

724 
EXPORT_SYMBOL
(
jbd3__jou∫Æ_ª°¨t
);

727 
	$jbd3_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

729  
	`jbd3__jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
, 
GFP_NOFS
);

730 
	}
}

731 
EXPORT_SYMBOL
(
jbd3_jou∫Æ_ª°¨t
);

743 
	$jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ_t
 *
jou∫Æ
)

745 
	`DEFINE_WAIT
(
waô
);

747 
	`jbd3_might_waô_f‹_commô
(
jou∫Æ
);

749 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

750 ++
jou∫Æ
->
j_b¨rõr_cou¡
;

753 i‡(
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
)) {

754 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

755 
	`waô_evít
(
jou∫Æ
->
j_waô_ª£rved
,

756 
	`©omic_ªad
(&
jou∫Æ
->
j_ª£rved_¸edôs
) == 0);

757 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

762 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

764 i‡(!
å™ß˘i⁄
)

767 
	`•ö_lock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

768 
	`¥ï¨e_to_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
,

769 
TASK_UNINTERRUPTIBLE
);

770 i‡(!
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
)) {

771 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

772 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

775 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_h™dÀ_lock
);

776 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

777 
	`scheduÀ
();

778 
	`föish_waô
(&
jou∫Æ
->
j_waô_upd©es
, &
waô
);

779 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

781 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

789 
	`muãx_lock
(&
jou∫Æ
->
j_b¨rõr
);

790 
	}
}

800 
	$jbd3_jou∫Æ_u∆ock_upd©es
 (
jou∫Æ_t
 *
jou∫Æ
)

802 
	`J_ASSERT
(
jou∫Æ
->
j_b¨rõr_cou¡
 != 0);

804 
	`muãx_u∆ock
(&
jou∫Æ
->
j_b¨rõr
);

805 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

806 --
jou∫Æ
->
j_b¨rõr_cou¡
;

807 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

808 
	`wake_up
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

809 
	}
}

811 
	$w¨n_dúty_buf„r
(
buf„r_hód
 *
bh
)

813 
	`¥ötk
(
KERN_WARNING


817 
bh
->
b_bdev
, ()bh->
b_blockƒ
);

818 
	}
}

821 
	$jbd3_‰ìze_jh_d©a
(
jou∫Æ_hód
 *
jh
)

823 
∑ge
 *page;

824 
off£t
;

825 *
sour˚
;

826 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

828 
	`J_EXPECT_JH
(
jh
, 
	`buf„r_u±od©e
(
bh
), "Possible IO failure.\n");

829 
∑ge
 = 
bh
->
b_∑ge
;

830 
off£t
 = 
	`off£t_ö_∑ge
(
bh
->
b_d©a
);

831 
sour˚
 = 
	`km≠_©omic
(
∑ge
);

833 
	`jbd3_buf„r_‰ozí_åiggî
(
jh
, 
sour˚
 + 
off£t
, jh->
b_åiggîs
);

834 
	`mem˝y
(
jh
->
b_‰ozí_d©a
, 
sour˚
 + 
off£t
, 
bh
->
b_size
);

835 
	`kunm≠_©omic
(
sour˚
);

841 
jh
->
b_‰ozí_åiggîs
 = jh->
b_åiggîs
;

842 
	}
}

855 
	$do_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
jou∫Æ_hód
 *
jh
,

856 
f‹˚_c›y
)

858 
buf„r_hód
 *
bh
;

859 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

860 
jou∫Æ_t
 *
jou∫Æ
;

861 
îr‹
;

862 *
‰ozí_buf„r
 = 
NULL
;

863 
°¨t_lock
, 
time_lock
;

865 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

866  -
EROFS
;

867 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

869 
	`jbd_debug
(5, "jou∫Æ_hód %p, f‹˚_c›y %d\n", 
jh
, 
f‹˚_c›y
);

871 
	`JBUFFER_TRACE
(
jh
, "entry");

872 
ª≥©
:

873 
bh
 = 
	`jh2bh
(
jh
);

877 
°¨t_lock
 = 
jiffõs
;

878 
	`lock_buf„r
(
bh
);

879 
	`jbd_lock_bh_°©e
(
bh
);

882 
time_lock
 = 
	`jbd3_time_diff
(
°¨t_lock
, 
jiffõs
);

883 i‡(
time_lock
 > 
HZ
/10)

884 
	`åa˚_jbd3_lock_buf„r_°Æl
(
bh
->
b_bdev
->
bd_dev
,

885 
	`jiffõs_to_m£cs
(
time_lock
));

900 i‡(
	`buf„r_dúty
(
bh
)) {

905 i‡(
jh
->
b_å™ß˘i⁄
) {

906 
	`J_ASSERT_JH
(
jh
,

907 
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

908 
jh
->
b_å™ß˘i⁄
 ==

909 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

910 i‡(
jh
->
b_√xt_å™ß˘i⁄
)

911 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 ==

912 
å™ß˘i⁄
);

913 
	`w¨n_dúty_buf„r
(
bh
);

920 
	`JBUFFER_TRACE
(
jh
, "Journalling dirty buffer");

921 
	`˛ór_buf„r_dúty
(
bh
);

922 
	`£t_buf„r_jbddúty
(
bh
);

925 
	`u∆ock_buf„r
(
bh
);

927 
îr‹
 = -
EROFS
;

928 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
)) {

929 
	`jbd_u∆ock_bh_°©e
(
bh
);

930 
out
;

932 
îr‹
 = 0;

938 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

939 
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
)

940 
d⁄e
;

946 
jh
->
b_modifõd
 = 0;

953 i‡(!
jh
->
b_å™ß˘i⁄
) {

954 
	`JBUFFER_TRACE
(
jh
, "noÅransaction");

955 
	`J_ASSERT_JH
(
jh
, !jh->
b_√xt_å™ß˘i⁄
);

956 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Reserved");

962 
	`smp_wmb
();

963 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

964 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Re£rved
);

965 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

966 
d⁄e
;

972 i‡(
jh
->
b_‰ozí_d©a
) {

973 
	`JBUFFER_TRACE
(
jh
, "has frozen data");

974 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

975 
©èch_√xt
;

978 
	`JBUFFER_TRACE
(
jh
, "owned by olderÅransaction");

979 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

980 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

991 i‡(
	`buf„r_shadow
(
bh
)) {

992 
	`JBUFFER_TRACE
(
jh
, "on shadow: sleep");

993 
	`jbd_u∆ock_bh_°©e
(
bh
);

994 
	`waô_⁄_bô_io
(&
bh
->
b_°©e
, 
BH_Shadow
, 
TASK_UNINTERRUPTIBLE
);

995 
ª≥©
;

1010 i‡(
jh
->
b_jli°
 =
BJ_Mëad©a
 || 
f‹˚_c›y
) {

1011 
	`JBUFFER_TRACE
(
jh
, "generate frozen data");

1012 i‡(!
‰ozí_buf„r
) {

1013 
	`JBUFFER_TRACE
(
jh
, "allocate memory for buffer");

1014 
	`jbd_u∆ock_bh_°©e
(
bh
);

1015 
‰ozí_buf„r
 = 
	`jbd3_Æloc
(
	`jh2bh
(
jh
)->
b_size
,

1016 
GFP_NOFS
 | 
__GFP_NOFAIL
);

1017 
ª≥©
;

1019 
jh
->
b_‰ozí_d©a
 = 
‰ozí_buf„r
;

1020 
‰ozí_buf„r
 = 
NULL
;

1021 
	`jbd3_‰ìze_jh_d©a
(
jh
);

1023 
©èch_√xt
:

1029 
	`smp_wmb
();

1030 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1032 
d⁄e
:

1033 
	`jbd_u∆ock_bh_°©e
(
bh
);

1039 
	`jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ
, 
jh
);

1041 
out
:

1042 i‡(
	`u∆ikñy
(
‰ozí_buf„r
))

1043 
	`jbd3_‰ì
(
‰ozí_buf„r
, 
bh
->
b_size
);

1045 
	`JBUFFER_TRACE
(
jh
, "exit");

1046  
îr‹
;

1047 
	}
}

1050 
boﬁ
 
	$jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
,

1051 
boﬁ
 
undo
)

1053 
jou∫Æ_hód
 *
jh
;

1054 
boﬁ
 
ªt
 = 
Ál£
;

1057 i‡(
	`buf„r_dúty
(
bh
))

1058  
Ál£
;

1071 
	`rcu_ªad_lock
();

1072 i‡(!
	`buf„r_jbd
(
bh
))

1073 
out
;

1075 
jh
 = 
	`READ_ONCE
(
bh
->
b_¥iv©e
);

1076 i‡(!
jh
)

1077 
out
;

1079 i‡(
undo
 && !
jh
->
b_commôãd_d©a
)

1080 
out
;

1081 i‡(
jh
->
b_å™ß˘i⁄
 !
h™dÀ
->
h_å™ß˘i⁄
 &&

1082 
jh
->
b_√xt_å™ß˘i⁄
 !
h™dÀ
->
h_å™ß˘i⁄
)

1083 
out
;

1093 
	`smp_mb
();

1094 i‡(
	`u∆ikñy
(
jh
->
b_bh
 !
bh
))

1095 
out
;

1096 
ªt
 = 
åue
;

1097 
out
:

1098 
	`rcu_ªad_u∆ock
();

1099  
ªt
;

1100 
	}
}

1113 
	$jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1115 
jou∫Æ_hód
 *
jh
;

1116 
rc
;

1118 i‡(
	`jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ
, 
bh
, 
Ál£
))

1121 
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1125 
rc
 = 
	`do_gë_wrôe_ac˚ss
(
h™dÀ
, 
jh
, 0);

1126 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1127  
rc
;

1128 
	}
}

1150 
	$jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1152 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1153 
jou∫Æ_t
 *
jou∫Æ
;

1154 
jou∫Æ_hód
 *
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1155 
îr
;

1157 
	`jbd_debug
(5, "jou∫Æ_hód %p\n", 
jh
);

1158 
îr
 = -
EROFS
;

1159 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1160 
out
;

1161 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1162 
îr
 = 0;

1164 
	`JBUFFER_TRACE
(
jh
, "entry");

1172 
	`jbd_lock_bh_°©e
(
bh
);

1173 
	`J_ASSERT_JH
(
jh
, (jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

1174 
jh
->
b_å™ß˘i⁄
 =
NULL
 ||

1175 (
jh
->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
 &&

1176 
jh
->
b_jli°
 =
BJ_F‹gë
)));

1178 
	`J_ASSERT_JH
(
jh
, jh->
b_√xt_å™ß˘i⁄
 =
NULL
);

1179 
	`J_ASSERT_JH
(
jh
, 
	`buf„r_locked
(
	`jh2bh
(jh)));

1181 i‡(
jh
->
b_å™ß˘i⁄
 =
NULL
) {

1190 
	`˛ór_buf„r_dúty
(
	`jh2bh
(
jh
));

1192 
jh
->
b_modifõd
 = 0;

1194 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Reserved");

1195 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1196 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Re£rved
);

1197 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1198 } i‡(
jh
->
b_å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

1200 
jh
->
b_modifõd
 = 0;

1202 
	`JBUFFER_TRACE
(
jh
, "setÇextÅransaction");

1203 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1204 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1205 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1207 
	`jbd_u∆ock_bh_°©e
(
bh
);

1216 
	`JBUFFER_TRACE
(
jh
, "cancellingÑevoke");

1217 
	`jbd3_jou∫Æ_ˇn˚l_ªvoke
(
h™dÀ
, 
jh
);

1218 
out
:

1219 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1220  
îr
;

1221 
	}
}

1249 
	$jbd3_jou∫Æ_gë_undo_ac˚ss
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1251 
îr
;

1252 
jou∫Æ_hód
 *
jh
;

1253 *
commôãd_d©a
 = 
NULL
;

1255 i‡(
	`jbd3_wrôe_ac˚ss_gø¡ed
(
h™dÀ
, 
bh
, 
åue
))

1258 
jh
 = 
	`jbd3_jou∫Æ_add_jou∫Æ_hód
(
bh
);

1259 
	`JBUFFER_TRACE
(
jh
, "entry");

1266 
îr
 = 
	`do_gë_wrôe_ac˚ss
(
h™dÀ
, 
jh
, 1);

1267 i‡(
îr
)

1268 
out
;

1270 
ª≥©
:

1271 i‡(!
jh
->
b_commôãd_d©a
)

1272 
commôãd_d©a
 = 
	`jbd3_Æloc
(
	`jh2bh
(
jh
)->
b_size
,

1273 
GFP_NOFS
|
__GFP_NOFAIL
);

1275 
	`jbd_lock_bh_°©e
(
bh
);

1276 i‡(!
jh
->
b_commôãd_d©a
) {

1279 
	`JBUFFER_TRACE
(
jh
, "generate b_committed data");

1280 i‡(!
commôãd_d©a
) {

1281 
	`jbd_u∆ock_bh_°©e
(
bh
);

1282 
ª≥©
;

1285 
jh
->
b_commôãd_d©a
 = 
commôãd_d©a
;

1286 
commôãd_d©a
 = 
NULL
;

1287 
	`mem˝y
(
jh
->
b_commôãd_d©a
, 
bh
->
b_d©a
, bh->
b_size
);

1289 
	`jbd_u∆ock_bh_°©e
(
bh
);

1290 
out
:

1291 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1292 i‡(
	`u∆ikñy
(
commôãd_d©a
))

1293 
	`jbd3_‰ì
(
commôãd_d©a
, 
bh
->
b_size
);

1294  
îr
;

1295 
	}
}

1308 
	$jbd3_jou∫Æ_£t_åiggîs
(
buf„r_hód
 *
bh
,

1309 
jbd3_buf„r_åiggî_ty≥
 *
ty≥
)

1311 
jou∫Æ_hód
 *
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

1313 i‡(
	`WARN_ON
(!
jh
))

1315 
jh
->
b_åiggîs
 = 
ty≥
;

1316 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1317 
	}
}

1319 
	$jbd3_buf„r_‰ozí_åiggî
(
jou∫Æ_hód
 *
jh
, *
m≠≥d_d©a
,

1320 
jbd3_buf„r_åiggî_ty≥
 *
åiggîs
)

1322 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

1324 i‡(!
åiggîs
 || !åiggîs->
t_‰ozí
)

1327 
åiggîs
->
	`t_‰ozí
—riggîs, 
bh
, 
m≠≥d_d©a
, bh->
b_size
);

1328 
	}
}

1330 
	$jbd3_buf„r_ab‹t_åiggî
(
jou∫Æ_hód
 *
jh
,

1331 
jbd3_buf„r_åiggî_ty≥
 *
åiggîs
)

1333 i‡(!
åiggîs
 || !åiggîs->
t_ab‹t
)

1336 
åiggîs
->
	`t_ab‹t
—riggîs, 
	`jh2bh
(
jh
));

1337 
	}
}

1362 
	$jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1364 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1365 
jou∫Æ_t
 *
jou∫Æ
;

1366 
jou∫Æ_hód
 *
jh
;

1367 
ªt
 = 0;

1369 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1370  -
EROFS
;

1371 i‡(!
	`buf„r_jbd
(
bh
))

1372  -
EUCLEAN
;

1378 
jh
 = 
	`bh2jh
(
bh
);

1379 
	`jbd_debug
(5, "jou∫Æ_hód %p\n", 
jh
);

1380 
	`JBUFFER_TRACE
(
jh
, "entry");

1388 i‡(
jh
->
b_å™ß˘i⁄
 !
å™ß˘i⁄
 &&

1389 
jh
->
b_√xt_å™ß˘i⁄
 !
å™ß˘i⁄
) {

1390 
	`jbd_lock_bh_°©e
(
bh
);

1391 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

1392 
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
);

1393 
	`jbd_u∆ock_bh_°©e
(
bh
);

1395 i‡(
jh
->
b_modifõd
 == 1) {

1397 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 &&

1398 
jh
->
b_jli°
 !
BJ_Mëad©a
) {

1399 
	`jbd_lock_bh_°©e
(
bh
);

1400 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 &&

1401 
jh
->
b_jli°
 !
BJ_Mëad©a
)

1402 
	`¥_îr
("JBD3:ássertion failure: h_type=%u "

1404 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

1405 (Ë
bh
->
b_blockƒ
,

1406 
jh
->
b_jli°
);

1407 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 !
å™ß˘i⁄
 ||

1408 
jh
->
b_jli°
 =
BJ_Mëad©a
);

1409 
	`jbd_u∆ock_bh_°©e
(
bh
);

1411 
out
;

1414 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1415 
	`jbd_lock_bh_°©e
(
bh
);

1417 i‡(
jh
->
b_modifõd
 == 0) {

1423 i‡(
h™dÀ
->
h_buf„r_¸edôs
 <= 0) {

1424 
ªt
 = -
ENOSPC
;

1425 
out_u∆ock_bh
;

1427 
jh
->
b_modifõd
 = 1;

1428 
h™dÀ
->
h_buf„r_¸edôs
--;

1438 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 && jh->
b_jli°
 =
BJ_Mëad©a
) {

1439 
	`JBUFFER_TRACE
(
jh
, "fastpath");

1440 i‡(
	`u∆ikñy
(
jh
->
b_å™ß˘i⁄
 !=

1441 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
)) {

1442 
	`¥ötk
(
KERN_ERR
 "JBD3: %s: "

1445 
jou∫Æ
->
j_dev«me
,

1446 (Ë
bh
->
b_blockƒ
,

1447 
jh
->
b_å™ß˘i⁄
,

1448 
jh
->
b_å™ß˘i⁄
 ? jh->b_å™ß˘i⁄->
t_tid
 : 0,

1449 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
,

1450 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 ?

1451 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
->
t_tid
 : 0);

1452 
ªt
 = -
EINVAL
;

1454 
out_u∆ock_bh
;

1457 
	`£t_buf„r_jbddúty
(
bh
);

1465 i‡(
jh
->
b_å™ß˘i⁄
 !
å™ß˘i⁄
) {

1466 
	`JBUFFER_TRACE
(
jh
, "already on otherÅransaction");

1467 i‡(
	`u∆ikñy
(((
jh
->
b_å™ß˘i⁄
 !=

1468 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
)) ||

1469 (
jh
->
b_√xt_å™ß˘i⁄
 !
å™ß˘i⁄
))) {

1470 
	`¥ötk
(
KERN_ERR
 "jbd3_journal_dirty_metadata: %s: "

1475 
jou∫Æ
->
j_dev«me
,

1476 (Ë
bh
->
b_blockƒ
,

1477 
å™ß˘i⁄
,Åønß˘i⁄->
t_tid
,

1478 
jh
->
b_å™ß˘i⁄
,

1479 
jh
->
b_å™ß˘i⁄
 ?

1480 
jh
->
b_å™ß˘i⁄
->
t_tid
 : 0,

1481 
jh
->
b_√xt_å™ß˘i⁄
,

1482 
jh
->
b_√xt_å™ß˘i⁄
 ?

1483 
jh
->
b_√xt_å™ß˘i⁄
->
t_tid
 : 0,

1484 
jh
->
b_jli°
);

1485 
	`WARN_ON
(1);

1486 
ªt
 = -
EINVAL
;

1490 
out_u∆ock_bh
;

1494 
	`J_ASSERT_JH
(
jh
, jh->
b_‰ozí_d©a
 =
NULL
);

1496 
	`JBUFFER_TRACE
(
jh
, "fileás BJ_Metadata");

1497 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1498 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_Mëad©a
);

1499 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1500 
out_u∆ock_bh
:

1501 
	`jbd_u∆ock_bh_°©e
(
bh
);

1502 
out
:

1503 
	`JBUFFER_TRACE
(
jh
, "exit");

1504  
ªt
;

1505 
	}
}

1524 
	$jbd3_jou∫Æ_f‹gë
 (
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

1526 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1527 
jou∫Æ_t
 *
jou∫Æ
;

1528 
jou∫Æ_hód
 *
jh
;

1529 
dr›_ª£rve
 = 0;

1530 
îr
 = 0;

1531 
was_modifõd
 = 0;

1533 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1534  -
EROFS
;

1535 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1537 
	`BUFFER_TRACE
(
bh
, "entry");

1539 
	`jbd_lock_bh_°©e
(
bh
);

1541 i‡(!
	`buf„r_jbd
(
bh
))

1542 
nŸ_jbd
;

1543 
jh
 = 
	`bh2jh
(
bh
);

1547 i‡(!
	`J_EXPECT_JH
(
jh
, !jh->
b_commôãd_d©a
,

1549 
îr
 = -
EIO
;

1550 
nŸ_jbd
;

1554 
was_modifõd
 = 
jh
->
b_modifõd
;

1560 
jh
->
b_modifõd
 = 0;

1562 i‡(
jh
->
b_å™ß˘i⁄
 =
å™ß˘i⁄
) {

1563 
	`J_ASSERT_JH
(
jh
, !jh->
b_‰ozí_d©a
);

1568 
	`˛ór_buf„r_dúty
(
bh
);

1569 
	`˛ór_buf„r_jbddúty
(
bh
);

1571 
	`JBUFFER_TRACE
(
jh
, "belongsÅo currentÅransaction: unfile");

1577 i‡(
was_modifõd
)

1578 
dr›_ª£rve
 = 1;

1592 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1593 i‡(
jh
->
b_˝_å™ß˘i⁄
) {

1594 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

1595 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

1597 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

1598 i‡(!
	`buf„r_jbd
(
bh
)) {

1599 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1600 
nŸ_jbd
;

1603 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1604 } i‡(
jh
->
b_å™ß˘i⁄
) {

1605 
	`J_ASSERT_JH
(
jh
, (jh->
b_å™ß˘i⁄
 ==

1606 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
));

1609 
	`JBUFFER_TRACE
(
jh
, "belongsÅo olderÅransaction");

1617 
	`£t_buf„r_‰ìd
(
bh
);

1619 i‡(!
jh
->
b_√xt_å™ß˘i⁄
) {

1620 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1621 
jh
->
b_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

1622 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1624 
	`J_ASSERT
(
jh
->
b_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
);

1630 i‡(
was_modifõd
)

1631 
dr›_ª£rve
 = 1;

1639 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1640 i‡(!
jh
->
b_˝_å™ß˘i⁄
) {

1641 
	`JBUFFER_TRACE
(
jh
, "belongsÅoÇoneÅransaction");

1642 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1643 
nŸ_jbd
;

1650 i‡(!
	`buf„r_dúty
(
bh
)) {

1651 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

1652 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1653 
nŸ_jbd
;

1662 
	`˛ór_buf„r_dúty
(
bh
);

1663 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

1664 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1667 
	`jbd_u∆ock_bh_°©e
(
bh
);

1668 
	`__bªl£
(
bh
);

1669 
dr›
:

1670 i‡(
dr›_ª£rve
) {

1672 
h™dÀ
->
h_buf„r_¸edôs
++;

1674  
îr
;

1676 
nŸ_jbd
:

1677 
	`jbd_u∆ock_bh_°©e
(
bh
);

1678 
	`__bf‹gë
(
bh
);

1679 
dr›
;

1680 
	}
}

1698 
	$jbd3_jou∫Æ_°›
(
h™dÀ_t
 *
h™dÀ
)

1700 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

1701 
jou∫Æ_t
 *
jou∫Æ
;

1702 
îr
 = 0, 
waô_f‹_commô
 = 0;

1703 
tid_t
 
tid
;

1704 
pid_t
 
pid
;

1706 i‡(!
å™ß˘i⁄
) {

1712 i‡(--
h™dÀ
->
h_ªf
 > 0) {

1713 
	`jbd_debug
(4, "h_ª‡%d -> %d\n", 
h™dÀ
->
h_ªf
 + 1,

1714 
h™dÀ
->
h_ªf
);

1715  
îr
;

1717 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

1718 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
->
h_rsv_h™dÀ
);

1719 
‰ì_™d_exô
;

1722 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

1724 
	`J_ASSERT
(
	`jou∫Æ_cuºít_h™dÀ
(Ë=
h™dÀ
);

1726 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

1727 
îr
 = -
EIO
;

1729 
	`J_ASSERT
(
	`©omic_ªad
(&
å™ß˘i⁄
->
t_upd©es
) > 0);

1731 i‡(--
h™dÀ
->
h_ªf
 > 0) {

1732 
	`jbd_debug
(4, "h_ª‡%d -> %d\n", 
h™dÀ
->
h_ªf
 + 1,

1733 
h™dÀ
->
h_ªf
);

1734  
îr
;

1737 
	`jbd_debug
(4, "H™dÀ %∞goög down\n", 
h™dÀ
);

1738 
	`åa˚_jbd3_h™dÀ_°©s
(
jou∫Æ
->
j_fs_dev
->
bd_dev
,

1739 
å™ß˘i⁄
->
t_tid
,

1740 
h™dÀ
->
h_ty≥
, h™dÀ->
h_löe_no
,

1741 
jiffõs
 - 
h™dÀ
->
h_°¨t_jiffõs
,

1742 
h™dÀ
->
h_sync
, h™dÀ->
h_ªque°ed_¸edôs
,

1743 (
h™dÀ
->
h_ªque°ed_¸edôs
 -

1744 
h™dÀ
->
h_buf„r_¸edôs
));

1775 
pid
 = 
cuºít
->pid;

1776 i‡(
h™dÀ
->
h_sync
 && 
jou∫Æ
->
j_œ°_sync_wrôî
 !
pid
 &&

1777 
jou∫Æ
->
j_max_b©ch_time
) {

1778 
u64
 
commô_time
, 
å™s_time
;

1780 
jou∫Æ
->
j_œ°_sync_wrôî
 = 
pid
;

1782 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

1783 
commô_time
 = 
jou∫Æ
->
j_avîage_commô_time
;

1784 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

1786 
å™s_time
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_gë
(),

1787 
å™ß˘i⁄
->
t_°¨t_time
));

1789 
commô_time
 = 
	`max_t
(
u64
, commit_time,

1790 1000*
jou∫Æ
->
j_mö_b©ch_time
);

1791 
commô_time
 = 
	`mö_t
(
u64
, commit_time,

1792 1000*
jou∫Æ
->
j_max_b©ch_time
);

1794 i‡(
å™s_time
 < 
commô_time
) {

1795 
ktime_t
 
expúes
 = 
	`ktime_add_ns
(
	`ktime_gë
(),

1796 
commô_time
);

1797 
	`£t_cuºít_°©e
(
TASK_UNINTERRUPTIBLE
);

1798 
	`scheduÀ_hπimeout
(&
expúes
, 
HRTIMER_MODE_ABS
);

1802 i‡(
h™dÀ
->
h_sync
)

1803 
å™ß˘i⁄
->
t_synchr⁄ous_commô
 = 1;

1804 
cuºít
->
jou∫Æ_öfo
 = 
NULL
;

1805 
	`©omic_sub
(
h™dÀ
->
h_buf„r_¸edôs
,

1806 &
å™ß˘i⁄
->
t_out°™dög_¸edôs
);

1814 i‡(
h™dÀ
->
h_sync
 ||

1815 (
	`©omic_ªad
(&
å™ß˘i⁄
->
t_out°™dög_¸edôs
) >

1816 
jou∫Æ
->
j_max_å™ß˘i⁄_buf„rs
) ||

1817 
	`time_a·î_eq
(
jiffõs
, 
å™ß˘i⁄
->
t_expúes
)) {

1822 
	`jbd_debug
(2, "transactionÅoo old,Ñequesting commit for "

1823 "h™dÀ %p\n", 
h™dÀ
);

1825 
	`jbd3_log_°¨t_commô
(
jou∫Æ
, 
å™ß˘i⁄
->
t_tid
);

1831 i‡(
h™dÀ
->
h_sync
 && !(
cuºít
->
Êags
 & 
PF_MEMALLOC
))

1832 
waô_f‹_commô
 = 1;

1841 
tid
 = 
å™ß˘i⁄
->
t_tid
;

1842 i‡(
	`©omic_dec_™d_ã°
(&
å™ß˘i⁄
->
t_upd©es
)) {

1843 
	`wake_up
(&
jou∫Æ
->
j_waô_upd©es
);

1844 i‡(
jou∫Æ
->
j_b¨rõr_cou¡
)

1845 
	`wake_up
(&
jou∫Æ
->
j_waô_å™ß˘i⁄_locked
);

1848 
	`rw£m_ªÀa£
(&
jou∫Æ
->
j_å™s_commô_m≠
, 1, 
_THIS_IP_
);

1850 i‡(
waô_f‹_commô
)

1851 
îr
 = 
	`jbd3_log_waô_commô
(
jou∫Æ
, 
tid
);

1853 i‡(
h™dÀ
->
h_rsv_h™dÀ
)

1854 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
->
h_rsv_h™dÀ
);

1855 
‰ì_™d_exô
:

1860 
	`memÆloc_nofs_ª°‹e
(
h™dÀ
->
ßved_Æloc_c⁄ãxt
);

1861 
	`jbd3_‰ì_h™dÀ
(
h™dÀ
);

1862  
îr
;

1863 
	}
}

1881 
ölöe
 

1882 
	$__bli°_add_buf„r
(
jou∫Æ_hód
 **
li°
, jou∫Æ_hód *
jh
)

1884 i‡(!*
li°
) {

1885 
jh
->
b_äext
 = jh->
b_çªv
 = jh;

1886 *
li°
 = 
jh
;

1889 
jou∫Æ_hód
 *
fú°
 = *
li°
, *
œ°
 = fú°->
b_çªv
;

1890 
jh
->
b_çªv
 = 
œ°
;

1891 
jh
->
b_äext
 = 
fú°
;

1892 
œ°
->
b_äext
 = 
fú°
->
b_çªv
 = 
jh
;

1894 
	}
}

1905 
ölöe
 

1906 
	$__bli°_dñ_buf„r
(
jou∫Æ_hód
 **
li°
, jou∫Æ_hód *
jh
)

1908 i‡(*
li°
 =
jh
) {

1909 *
li°
 = 
jh
->
b_äext
;

1910 i‡(*
li°
 =
jh
)

1911 *
li°
 = 
NULL
;

1913 
jh
->
b_çªv
->
b_äext
 = jh->b_tnext;

1914 
jh
->
b_äext
->
b_çªv
 = jh->b_tprev;

1915 
	}
}

1928 
	$__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jou∫Æ_hód
 *
jh
)

1930 
jou∫Æ_hód
 **
li°
 = 
NULL
;

1931 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

1932 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

1934 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_°©e
(
bh
));

1935 
å™ß˘i⁄
 = 
jh
->
b_å™ß˘i⁄
;

1936 i‡(
å™ß˘i⁄
)

1937 
	`as£π_•ö_locked
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

1939 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 < 
BJ_Ty≥s
);

1940 i‡(
jh
->
b_jli°
 !
BJ_N⁄e
)

1941 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
 !
NULL
);

1943 
jh
->
b_jli°
) {

1944 
BJ_N⁄e
:

1946 
BJ_Mëad©a
:

1947 
å™ß˘i⁄
->
t_ƒ_buf„rs
--;

1948 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
->
t_ƒ_buf„rs
 >= 0);

1949 
li°
 = &
å™ß˘i⁄
->
t_buf„rs
;

1951 
BJ_F‹gë
:

1952 
li°
 = &
å™ß˘i⁄
->
t_f‹gë
;

1954 
BJ_Shadow
:

1955 
li°
 = &
å™ß˘i⁄
->
t_shadow_li°
;

1957 
BJ_Re£rved
:

1958 
li°
 = &
å™ß˘i⁄
->
t_ª£rved_li°
;

1962 
	`__bli°_dñ_buf„r
(
li°
, 
jh
);

1963 
jh
->
b_jli°
 = 
BJ_N⁄e
;

1964 i‡(
å™ß˘i⁄
 && 
	`is_jou∫Æ_ab‹ãd
—ønß˘i⁄->
t_jou∫Æ
))

1965 
	`˛ór_buf„r_jbddúty
(
bh
);

1966 i‡(
	`ã°_˛ór_buf„r_jbddúty
(
bh
))

1967 
	`m¨k_buf„r_dúty
(
bh
);

1968 
	}
}

1977 
	$__jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_hód
 *
jh
)

1979 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

1980 
jh
->
b_å™ß˘i⁄
 = 
NULL
;

1981 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

1982 
	}
}

1984 
	$jbd3_jou∫Æ_unfûe_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
jou∫Æ_hód
 *
jh
)

1986 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

1989 
	`gë_bh
(
bh
);

1990 
	`jbd_lock_bh_°©e
(
bh
);

1991 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

1992 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

1993 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

1994 
	`jbd_u∆ock_bh_°©e
(
bh
);

1995 
	`__bªl£
(
bh
);

1996 
	}
}

2004 
	$__jou∫Æ_åy_to_‰ì_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
)

2006 
jou∫Æ_hód
 *
jh
;

2008 
jh
 = 
	`bh2jh
(
bh
);

2010 i‡(
	`buf„r_locked
(
bh
Ë|| 
	`buf„r_dúty
(bh))

2011 
out
;

2013 i‡(
jh
->
b_√xt_å™ß˘i⁄
 !
NULL
 || jh->
b_å™ß˘i⁄
 != NULL)

2014 
out
;

2016 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2017 i‡(
jh
->
b_˝_å™ß˘i⁄
 !
NULL
) {

2019 
	`JBUFFER_TRACE
(
jh
, "remove from checkpointÜist");

2020 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2022 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2023 
out
:

2025 
	}
}

2065 
	$jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ_t
 *
jou∫Æ
,

2066 
∑ge
 *∑ge, 
gÂ_t
 
gÂ_mask
)

2068 
buf„r_hód
 *
hód
;

2069 
buf„r_hód
 *
bh
;

2070 
ªt
 = 0;

2072 
	`J_ASSERT
(
	`PageLocked
(
∑ge
));

2074 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

2075 
bh
 = 
hód
;

2077 
jou∫Æ_hód
 *
jh
;

2084 
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2085 i‡(!
jh
)

2088 
	`jbd_lock_bh_°©e
(
bh
);

2089 
	`__jou∫Æ_åy_to_‰ì_buf„r
(
jou∫Æ
, 
bh
);

2090 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2091 
	`jbd_u∆ock_bh_°©e
(
bh
);

2092 i‡(
	`buf„r_jbd
(
bh
))

2093 
busy
;

2094 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

2096 
ªt
 = 
	`åy_to_‰ì_buf„rs
(
∑ge
);

2098 
busy
:

2099  
ªt
;

2100 
	}
}

2114 
	$__di•o£_buf„r
(
jou∫Æ_hód
 *
jh
, 
å™ß˘i⁄_t
 *
å™ß˘i⁄
)

2116 
may_‰ì
 = 1;

2117 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2119 i‡(
jh
->
b_˝_å™ß˘i⁄
) {

2120 
	`JBUFFER_TRACE
(
jh
, "onÑunning+cpÅransaction");

2121 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2127 
	`˛ór_buf„r_dúty
(
bh
);

2128 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
BJ_F‹gë
);

2129 
may_‰ì
 = 0;

2131 
	`JBUFFER_TRACE
(
jh
, "onÑunningÅransaction");

2132 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

2134  
may_‰ì
;

2135 
	}
}

2184 
	$jou∫Æ_unm≠_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
buf„r_hód
 *
bh
,

2185 
∑πül_∑ge
)

2187 
å™ß˘i⁄_t
 *
å™ß˘i⁄
;

2188 
jou∫Æ_hód
 *
jh
;

2189 
may_‰ì
 = 1;

2191 
	`BUFFER_TRACE
(
bh
, "entry");

2199 i‡(!
	`buf„r_jbd
(
bh
))

2200 
z≠_buf„r_u∆ocked
;

2203 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

2204 
	`jbd_lock_bh_°©e
(
bh
);

2205 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2207 
jh
 = 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2208 i‡(!
jh
)

2209 
z≠_buf„r_no_jh
;

2234 
å™ß˘i⁄
 = 
jh
->
b_å™ß˘i⁄
;

2235 i‡(
å™ß˘i⁄
 =
NULL
) {

2240 i‡(!
jh
->
b_˝_å™ß˘i⁄
) {

2241 
	`JBUFFER_TRACE
(
jh
, "not onányÅransaction: zap");

2242 
z≠_buf„r
;

2245 i‡(!
	`buf„r_dúty
(
bh
)) {

2247 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2248 
z≠_buf„r
;

2255 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
) {

2259 
	`JBUFFER_TRACE
(
jh
, "checkpointed:áddÅo BJ_Forget");

2260 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
,

2261 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2262 
z≠_buf„r
;

2268 i‡(
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

2269 
	`JBUFFER_TRACE
(
jh
, "giveÅo committingÅrans");

2270 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
,

2271 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2272 
z≠_buf„r
;

2276 
	`˛ór_buf„r_jbddúty
(
bh
);

2277 
	`__jbd3_jou∫Æ_ªmove_checkpoöt
(
jh
);

2278 
z≠_buf„r
;

2281 } i‡(
å™ß˘i⁄
 =
jou∫Æ
->
j_commôtög_å™ß˘i⁄
) {

2282 
	`JBUFFER_TRACE
(
jh
, "on committingÅransaction");

2288 i‡(
∑πül_∑ge
) {

2289 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2290 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2291 
	`jbd_u∆ock_bh_°©e
(
bh
);

2292 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2293  -
EBUSY
;

2301 
	`£t_buf„r_‰ìd
(
bh
);

2302 i‡(
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
 && 
	`buf„r_jbddúty
(
bh
))

2303 
jh
->
b_√xt_å™ß˘i⁄
 = 
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
;

2304 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2305 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2306 
	`jbd_u∆ock_bh_°©e
(
bh
);

2307 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2316 
	`J_ASSERT_JH
(
jh
, 
å™ß˘i⁄
 =
jou∫Æ
->
j_ru¬ög_å™ß˘i⁄
);

2317 
	`JBUFFER_TRACE
(
jh
, "onÑunningÅransaction");

2318 
may_‰ì
 = 
	`__di•o£_buf„r
(
jh
, 
å™ß˘i⁄
);

2321 
z≠_buf„r
:

2330 
jh
->
b_modifõd
 = 0;

2331 
	`jbd3_jou∫Æ_put_jou∫Æ_hód
(
jh
);

2332 
z≠_buf„r_no_jh
:

2333 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2334 
	`jbd_u∆ock_bh_°©e
(
bh
);

2335 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2336 
z≠_buf„r_u∆ocked
:

2337 
	`˛ór_buf„r_dúty
(
bh
);

2338 
	`J_ASSERT_BH
(
bh
, !
	`buf„r_jbddúty
(bh));

2339 
	`˛ór_buf„r_m≠≥d
(
bh
);

2340 
	`˛ór_buf„r_ªq
(
bh
);

2341 
	`˛ór_buf„r_√w
(
bh
);

2342 
	`˛ór_buf„r_dñay
(
bh
);

2343 
	`˛ór_buf„r_unwrôãn
(
bh
);

2344 
bh
->
b_bdev
 = 
NULL
;

2345  
may_‰ì
;

2346 
	}
}

2360 
	$jbd3_jou∫Æ_övÆid©ïage
(
jou∫Æ_t
 *
jou∫Æ
,

2361 
∑ge
 *page,

2362 
off£t
,

2363 
Àngth
)

2365 
buf„r_hód
 *
hód
, *
bh
, *
√xt
;

2366 
°›
 = 
off£t
 + 
Àngth
;

2367 
cuº_off
 = 0;

2368 
∑πül_∑ge
 = (
off£t
 || 
Àngth
 < 
PAGE_SIZE
);

2369 
may_‰ì
 = 1;

2370 
ªt
 = 0;

2372 i‡(!
	`PageLocked
(
∑ge
))

2373 
	`BUG
();

2374 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

2377 
	`BUG_ON
(
°›
 > 
PAGE_SIZE
 || st› < 
Àngth
);

2383 
hód
 = 
bh
 = 
	`∑ge_buf„rs
(
∑ge
);

2385 
√xt_off
 = 
cuº_off
 + 
bh
->
b_size
;

2386 
√xt
 = 
bh
->
b_this_∑ge
;

2388 i‡(
√xt_off
 > 
°›
)

2391 i‡(
off£t
 <
cuº_off
) {

2393 
	`lock_buf„r
(
bh
);

2394 
ªt
 = 
	`jou∫Æ_unm≠_buf„r
(
jou∫Æ
, 
bh
, 
∑πül_∑ge
);

2395 
	`u∆ock_buf„r
(
bh
);

2396 i‡(
ªt
 < 0)

2397  
ªt
;

2398 
may_‰ì
 &
ªt
;

2400 
cuº_off
 = 
√xt_off
;

2401 
bh
 = 
√xt
;

2403 } 
bh
 !
hód
);

2405 i‡(!
∑πül_∑ge
) {

2406 i‡(
may_‰ì
 && 
	`åy_to_‰ì_buf„rs
(
∑ge
))

2407 
	`J_ASSERT
(!
	`∑ge_has_buf„rs
(
∑ge
));

2410 
	}
}

2415 
	$__jbd3_jou∫Æ_fûe_buf„r
(
jou∫Æ_hód
 *
jh
,

2416 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
jli°
)

2418 
jou∫Æ_hód
 **
li°
 = 
NULL
;

2419 
was_dúty
 = 0;

2420 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2422 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_°©e
(
bh
));

2423 
	`as£π_•ö_locked
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2425 
	`J_ASSERT_JH
(
jh
, jh->
b_jli°
 < 
BJ_Ty≥s
);

2426 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

2427 
jh
->
b_å™ß˘i⁄
 =
NULL
);

2429 i‡(
jh
->
b_å™ß˘i⁄
 && jh->
b_jli°
 =
jli°
)

2432 i‡(
jli°
 =
BJ_Mëad©a
 || jli° =
BJ_Re£rved
 ||

2433 
jli°
 =
BJ_Shadow
 || jli° =
BJ_F‹gë
) {

2441 i‡(
	`buf„r_dúty
(
bh
))

2442 
	`w¨n_dúty_buf„r
(
bh
);

2443 i‡(
	`ã°_˛ór_buf„r_dúty
(
bh
) ||

2444 
	`ã°_˛ór_buf„r_jbddúty
(
bh
))

2445 
was_dúty
 = 1;

2448 i‡(
jh
->
b_å™ß˘i⁄
)

2449 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2451 
	`jbd3_jou∫Æ_gøb_jou∫Æ_hód
(
bh
);

2452 
jh
->
b_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2454 
jli°
) {

2455 
BJ_N⁄e
:

2456 
	`J_ASSERT_JH
(
jh
, !jh->
b_commôãd_d©a
);

2457 
	`J_ASSERT_JH
(
jh
, !jh->
b_‰ozí_d©a
);

2459 
BJ_Mëad©a
:

2460 
å™ß˘i⁄
->
t_ƒ_buf„rs
++;

2461 
li°
 = &
å™ß˘i⁄
->
t_buf„rs
;

2463 
BJ_F‹gë
:

2464 
li°
 = &
å™ß˘i⁄
->
t_f‹gë
;

2466 
BJ_Shadow
:

2467 
li°
 = &
å™ß˘i⁄
->
t_shadow_li°
;

2469 
BJ_Re£rved
:

2470 
li°
 = &
å™ß˘i⁄
->
t_ª£rved_li°
;

2474 
	`__bli°_add_buf„r
(
li°
, 
jh
);

2475 
jh
->
b_jli°
 = 
jli°
;

2477 i‡(
was_dúty
)

2478 
	`£t_buf„r_jbddúty
(
bh
);

2479 
	}
}

2481 
	$jbd3_jou∫Æ_fûe_buf„r
(
jou∫Æ_hód
 *
jh
,

2482 
å™ß˘i⁄_t
 *
å™ß˘i⁄
, 
jli°
)

2484 
	`jbd_lock_bh_°©e
(
	`jh2bh
(
jh
));

2485 
	`•ö_lock
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2486 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, 
å™ß˘i⁄
, 
jli°
);

2487 
	`•ö_u∆ock
(&
å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2488 
	`jbd_u∆ock_bh_°©e
(
	`jh2bh
(
jh
));

2489 
	}
}

2502 
	$__jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ_hód
 *
jh
)

2504 
was_dúty
, 
jli°
;

2505 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2507 
	`J_ASSERT_JH
(
jh
, 
	`jbd_is_locked_bh_°©e
(
bh
));

2508 i‡(
jh
->
b_å™ß˘i⁄
)

2509 
	`as£π_•ö_locked
(&
jh
->
b_å™ß˘i⁄
->
t_jou∫Æ
->
j_li°_lock
);

2512 i‡(
jh
->
b_√xt_å™ß˘i⁄
 =
NULL
) {

2513 
	`__jbd3_jou∫Æ_unfûe_buf„r
(
jh
);

2522 
was_dúty
 = 
	`ã°_˛ór_buf„r_jbddúty
(
bh
);

2523 
	`__jbd3_jou∫Æ_ãmp_u∆ök_buf„r
(
jh
);

2529 
jh
->
b_å™ß˘i⁄
 = jh->
b_√xt_å™ß˘i⁄
;

2530 
jh
->
b_√xt_å™ß˘i⁄
 = 
NULL
;

2531 i‡(
	`buf„r_‰ìd
(
bh
))

2532 
jli°
 = 
BJ_F‹gë
;

2533 i‡(
jh
->
b_modifõd
)

2534 
jli°
 = 
BJ_Mëad©a
;

2536 
jli°
 = 
BJ_Re£rved
;

2537 
	`__jbd3_jou∫Æ_fûe_buf„r
(
jh
, jh->
b_å™ß˘i⁄
, 
jli°
);

2538 
	`J_ASSERT_JH
(
jh
, jh->
b_å™ß˘i⁄
->
t_°©e
 =
T_RUNNING
);

2540 i‡(
was_dúty
)

2541 
	`£t_buf„r_jbddúty
(
bh
);

2542 
	}
}

2550 
	$jbd3_jou∫Æ_ªfûe_buf„r
(
jou∫Æ_t
 *
jou∫Æ
, 
jou∫Æ_hód
 *
jh
)

2552 
buf„r_hód
 *
bh
 = 
	`jh2bh
(
jh
);

2555 
	`gë_bh
(
bh
);

2556 
	`jbd_lock_bh_°©e
(
bh
);

2557 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2558 
	`__jbd3_jou∫Æ_ªfûe_buf„r
(
jh
);

2559 
	`jbd_u∆ock_bh_°©e
(
bh
);

2560 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2561 
	`__bªl£
(
bh
);

2562 
	}
}

2567 
	$jbd3_jou∫Æ_fûe_öode
(
h™dÀ_t
 *
h™dÀ
, 
jbd3_öode
 *
jöode
,

2568 
Êags
)

2570 
å™ß˘i⁄_t
 *
å™ß˘i⁄
 = 
h™dÀ
->
h_å™ß˘i⁄
;

2571 
jou∫Æ_t
 *
jou∫Æ
;

2573 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

2574  -
EROFS
;

2575 
jou∫Æ
 = 
å™ß˘i⁄
->
t_jou∫Æ
;

2577 
	`jbd_debug
(4, "Addög inodê%lu,Åid:%d\n", 
jöode
->
i_vfs_öode
->
i_öo
,

2578 
å™ß˘i⁄
->
t_tid
);

2593 i‡((
jöode
->
i_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

2594 
jöode
->
i_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
) &&

2595 (
jöode
->
i_Êags
 & 
Êags
) == flags)

2598 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2599 
jöode
->
i_Êags
 |
Êags
;

2601 i‡(
jöode
->
i_å™ß˘i⁄
 =
å™ß˘i⁄
 ||

2602 
jöode
->
i_√xt_å™ß˘i⁄
 =
å™ß˘i⁄
)

2603 
d⁄e
;

2610 i‡(!
å™ß˘i⁄
->
t_√ed_d©a_Êush
)

2611 
å™ß˘i⁄
->
t_√ed_d©a_Êush
 = 1;

2614 i‡(
jöode
->
i_å™ß˘i⁄
) {

2615 
	`J_ASSERT
(
jöode
->
i_√xt_å™ß˘i⁄
 =
NULL
);

2616 
	`J_ASSERT
(
jöode
->
i_å™ß˘i⁄
 ==

2617 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
);

2618 
jöode
->
i_√xt_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2619 
d⁄e
;

2622 
	`J_ASSERT
(!
jöode
->
i_√xt_å™ß˘i⁄
);

2623 
jöode
->
i_å™ß˘i⁄
 = 
å™ß˘i⁄
;

2624 
	`li°_add
(&
jöode
->
i_li°
, &
å™ß˘i⁄
->
t_öode_li°
);

2625 
d⁄e
:

2626 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2629 
	}
}

2631 
	$jbd3_jou∫Æ_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
jbd3_öode
 *
jöode
)

2633  
	`jbd3_jou∫Æ_fûe_öode
(
h™dÀ
, 
jöode
,

2634 
JI_WRITE_DATA
 | 
JI_WAIT_DATA
);

2635 
	}
}

2637 
	$jbd3_jou∫Æ_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
, 
jbd3_öode
 *
jöode
)

2639  
	`jbd3_jou∫Æ_fûe_öode
(
h™dÀ
, 
jöode
, 
JI_WAIT_DATA
);

2640 
	}
}

2662 
	$jbd3_jou∫Æ_begö_‹dîed_åunˇã
(
jou∫Æ_t
 *
jou∫Æ
,

2663 
jbd3_öode
 *
jöode
,

2664 
loff_t
 
√w_size
)

2666 
å™ß˘i⁄_t
 *
öode_å™s
, *
commô_å™s
;

2667 
ªt
 = 0;

2670 i‡(!
jöode
->
i_å™ß˘i⁄
)

2671 
out
;

2675 
	`ªad_lock
(&
jou∫Æ
->
j_°©e_lock
);

2676 
commô_å™s
 = 
jou∫Æ
->
j_commôtög_å™ß˘i⁄
;

2677 
	`ªad_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

2678 
	`•ö_lock
(&
jou∫Æ
->
j_li°_lock
);

2679 
öode_å™s
 = 
jöode
->
i_å™ß˘i⁄
;

2680 
	`•ö_u∆ock
(&
jou∫Æ
->
j_li°_lock
);

2681 i‡(
öode_å™s
 =
commô_å™s
) {

2682 
ªt
 = 
	`fûem≠_fd©awrôe_ønge
(
jöode
->
i_vfs_öode
->
i_m≠pög
,

2683 
√w_size
, 
LLONG_MAX
);

2684 i‡(
ªt
)

2685 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, 
ªt
);

2687 
out
:

2688  
ªt
;

2689 
	}
}

	@mballoc.c

12 
	~"pxt4_jbd3.h
"

13 
	~"mbÆloc.h
"

14 
	~<löux/log2.h
>

15 
	~<löux/moduÀ.h
>

16 
	~<löux/¶ab.h
>

17 
	~<löux/no•ec.h
>

18 
	~<löux/backög-dev.h
>

19 
	~<åa˚/evíts/pxt4.h
>

21 #ifde‡
CONFIG_PXT4_DEBUG


22 
ush‹t
 
pxt4_mbÆloc_debug
 
	g__ªad_mo°ly
;

24 
moduÀ_∑øm_«med
(
mbÆloc_debug
, 
pxt4_mbÆloc_debug
, 
ush‹t
, 0644);

25 
MODULE_PARM_DESC
(
mbÆloc_debug
, "DebuggingÜevel forÖxt4's mballoc");

339 
kmem_ˇche
 *
	gpxt4_p•a˚_ˇchï
;

340 
kmem_ˇche
 *
	gpxt4_ac_ˇchï
;

341 
kmem_ˇche
 *
	gpxt4_‰ì_d©a_ˇchï
;

346 
	#NR_GRPINFO_CACHES
 8

	)

347 
kmem_ˇche
 *
	gpxt4_groupöfo_ˇches
[
NR_GRPINFO_CACHES
];

349 c⁄° * c⁄° 
	gpxt4_groupöfo_¶ab_«mes
[
NR_GRPINFO_CACHES
] = {

355 
pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

356 
pxt4_group_t
 
group
);

357 
pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

358 
pxt4_group_t
 
group
);

360 
ölöe
 *
	$mb_c‹ª˘_addr_™d_bô
(*
bô
, *
addr
)

362 #i‡
BITS_PER_LONG
 == 64

363 *
bô
 +((Ë
addr
 & 7UL) << 3;

364 
addr
 = (*) (()áddr & ~7UL);

365 #ñi‡
BITS_PER_LONG
 == 32

366 *
bô
 +((Ë
addr
 & 3UL) << 3;

367 
addr
 = (*) (()áddr & ~3UL);

371  
addr
;

372 
	}
}

374 
ölöe
 
	$mb_ã°_bô
(
bô
, *
addr
)

380 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

381  
	`pxt4_ã°_bô
(
bô
, 
addr
);

382 
	}
}

384 
ölöe
 
	$mb_£t_bô
(
bô
, *
addr
)

386 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

387 
	`pxt4_£t_bô
(
bô
, 
addr
);

388 
	}
}

390 
ölöe
 
	$mb_˛ór_bô
(
bô
, *
addr
)

392 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

393 
	`pxt4_˛ór_bô
(
bô
, 
addr
);

394 
	}
}

396 
ölöe
 
	$mb_ã°_™d_˛ór_bô
(
bô
, *
addr
)

398 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
bô
,áddr);

399  
	`pxt4_ã°_™d_˛ór_bô
(
bô
, 
addr
);

400 
	}
}

402 
ölöe
 
	$mb_föd_√xt_zîo_bô
(*
addr
, 
max
, 
°¨t
)

404 
fix
 = 0, 
ªt
, 
tmpmax
;

405 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

406 
tmpmax
 = 
max
 + 
fix
;

407 
°¨t
 +
fix
;

409 
ªt
 = 
	`pxt4_föd_√xt_zîo_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

410 i‡(
ªt
 > 
max
)

411  
max
;

412  
ªt
;

413 
	}
}

415 
ölöe
 
	$mb_föd_√xt_bô
(*
addr
, 
max
, 
°¨t
)

417 
fix
 = 0, 
ªt
, 
tmpmax
;

418 
addr
 = 
	`mb_c‹ª˘_addr_™d_bô
(&
fix
,áddr);

419 
tmpmax
 = 
max
 + 
fix
;

420 
°¨t
 +
fix
;

422 
ªt
 = 
	`pxt4_föd_√xt_bô
(
addr
, 
tmpmax
, 
°¨t
Ë- 
fix
;

423 i‡(
ªt
 > 
max
)

424  
max
;

425  
ªt
;

426 
	}
}

428 *
	$mb_föd_buddy
(
pxt4_buddy
 *
e4b
, 
‹dî
, *
max
)

430 *
bb
;

432 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

433 
	`BUG_ON
(
max
 =
NULL
);

435 i‡(
‹dî
 > 
e4b
->
bd_blkbôs
 + 1) {

436 *
max
 = 0;

437  
NULL
;

441 i‡(
‹dî
 == 0) {

442 *
max
 = 1 << (
e4b
->
bd_blkbôs
 + 3);

443  
e4b
->
bd_bôm≠
;

446 
bb
 = 
e4b
->
bd_buddy
 + 
	`PXT4_SB
”4b->
bd_sb
)->
s_mb_off£ts
[
‹dî
];

447 *
max
 = 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[
‹dî
];

449  
bb
;

450 
	}
}

452 #ifde‡
DOUBLE_CHECK


453 
	$mb_‰ì_blocks_doubÀ
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

454 
fú°
, 
cou¡
)

456 
i
;

457 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

459 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

461 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

462 
i
 = 0; i < 
cou¡
; i++) {

463 i‡(!
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
)) {

464 
pxt4_fsblk_t
 
blockƒ
;

466 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

467 
blockƒ
 +
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
fú°
 + 
i
);

468 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

469 
öode
 ? inode->
i_öo
 : 0,

470 
blockƒ
,

473 
fú°
 + 
i
);

474 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

475 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

477 
	`mb_˛ór_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

479 
	}
}

481 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

483 
i
;

485 i‡(
	`u∆ikñy
(
e4b
->
bd_öfo
->
bb_bôm≠
 =
NULL
))

487 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

488 
i
 = 0; i < 
cou¡
; i++) {

489 
	`BUG_ON
(
	`mb_ã°_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
));

490 
	`mb_£t_bô
(
fú°
 + 
i
, 
e4b
->
bd_öfo
->
bb_bôm≠
);

492 
	}
}

494 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

496 i‡(
	`memcmp
(
e4b
->
bd_öfo
->
bb_bôm≠
, 
bôm≠
,É4b->
bd_sb
->
s_blocksize
)) {

497 *
b1
, *
b2
;

498 
i
;

499 
b1
 = (*Ë
e4b
->
bd_öfo
->
bb_bôm≠
;

500 
b2
 = (*Ë
bôm≠
;

501 
i
 = 0; i < 
e4b
->
bd_sb
->
s_blocksize
; i++) {

502 i‡(
b1
[
i
] !
b2
[i]) {

503 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_ERR
,

507 
e4b
->
bd_group
, 
i
, i * 8, 
b1
[i], 
b2
[i]);

508 
	`BUG
();

512 
	}
}

515 
ölöe
 
	$mb_‰ì_blocks_doubÀ
(
öode
 *inode,

516 
pxt4_buddy
 *
e4b
, 
fú°
, 
cou¡
)

519 
	}
}

520 
ölöe
 
	$mb_m¨k_u£d_doubÀ
(
pxt4_buddy
 *
e4b
,

521 
fú°
, 
cou¡
)

524 
	}
}

525 
ölöe
 
	$mb_cmp_bôm≠s
(
pxt4_buddy
 *
e4b
, *
bôm≠
)

528 
	}
}

531 #ifde‡
AGGRESSIVE_CHECK


533 
	#MB_CHECK_ASSERT
(
as£π
) \

535 i‡(!(
as£π
)) { \

536 
	`¥ötk
(
KERN_EMERG
 \

538 
fun˘i⁄
, 
fûe
, 
löe
, #assert); \

539 
	`BUG
(); \

541 } 0)

	)

543 
	$__mb_check_buddy
(
pxt4_buddy
 *
e4b
, *
fûe
,

544 c⁄° *
fun˘i⁄
, 
löe
)

546 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

547 
‹dî
 = 
e4b
->
bd_blkbôs
 + 1;

548 
max
;

549 
max2
;

550 
i
;

551 
j
;

552 
k
;

553 
cou¡
;

554 
pxt4_group_öfo
 *
gΩ
;

555 
‰agmíts
 = 0;

556 
f°¨t
;

557 
li°_hód
 *
cur
;

558 *
buddy
;

559 *
buddy2
;

562 
mb_check_cou¡î
;

563 i‡(
mb_check_cou¡î
++ % 100 != 0)

567 
‹dî
 > 1) {

568 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

569 
	`MB_CHECK_ASSERT
(
buddy
);

570 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
 - 1, &
max2
);

571 
	`MB_CHECK_ASSERT
(
buddy2
);

572 
	`MB_CHECK_ASSERT
(
buddy
 !
buddy2
);

573 
	`MB_CHECK_ASSERT
(
max
 * 2 =
max2
);

575 
cou¡
 = 0;

576 
i
 = 0; i < 
max
; i++) {

578 i‡(
	`mb_ã°_bô
(
i
, 
buddy
)) {

580 i‡(!
	`mb_ã°_bô
(
i
 << 1, 
buddy2
)) {

581 
	`MB_CHECK_ASSERT
(

582 
	`mb_ã°_bô
((
i
<<1)+1, 
buddy2
));

583 } i‡(!
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
)) {

584 
	`MB_CHECK_ASSERT
(

585 
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

591 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
i
 << 1, 
buddy2
));

592 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
((
i
 << 1Ë+ 1, 
buddy2
));

594 
j
 = 0; j < (1 << 
‹dî
); j++) {

595 
k
 = (
i
 * (1 << 
‹dî
)Ë+ 
j
;

596 
	`MB_CHECK_ASSERT
(

597 !
	`mb_ã°_bô
(
k
, 
e4b
->
bd_bôm≠
));

599 
cou¡
++;

601 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] =
cou¡
);

602 
‹dî
--;

605 
f°¨t
 = -1;

606 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

607 
i
 = 0; i < 
max
; i++) {

608 i‡(!
	`mb_ã°_bô
(
i
, 
buddy
)) {

609 
	`MB_CHECK_ASSERT
(
i
 >
e4b
->
bd_öfo
->
bb_fú°_‰ì
);

610 i‡(
f°¨t
 == -1) {

611 
‰agmíts
++;

612 
f°¨t
 = 
i
;

616 
f°¨t
 = -1;

618 
j
 = 0; j < 
e4b
->
bd_blkbôs
 + 1; j++) {

619 
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
j
, &
max2
);

620 
k
 = 
i
 >> 
j
;

621 
	`MB_CHECK_ASSERT
(
k
 < 
max2
);

622 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
, 
buddy2
));

625 
	`MB_CHECK_ASSERT
(!
	`PXT4_MB_GRP_NEED_INIT
(
e4b
->
bd_öfo
));

626 
	`MB_CHECK_ASSERT
(
e4b
->
bd_öfo
->
bb_‰agmíts
 =
‰agmíts
);

628 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
e4b
->
bd_group
);

629 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

630 
pxt4_group_t
 
grou≤r
;

631 
pxt4_¥óŒoc_•a˚
 *
∑
;

632 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

633 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
grou≤r
, &
k
);

634 
	`MB_CHECK_ASSERT
(
grou≤r
 =
e4b
->
bd_group
);

635 
i
 = 0; i < 
∑
->
∑_Àn
; i++)

636 
	`MB_CHECK_ASSERT
(
	`mb_ã°_bô
(
k
 + 
i
, 
buddy
));

639 
	}
}

640 #unde‡
MB_CHECK_ASSERT


641 
	#mb_check_buddy
(
e4b
Ë
	`__mb_check_buddy
(e4b, \

642 
__FILE__
, 
__func__
, 
__LINE__
)

	)

644 
	#mb_check_buddy
(
e4b
)

	)

653 
	$pxt4_mb_m¨k_‰ì_sim∂e
(
su≥r_block
 *
sb
,

654 *
buddy
, 
pxt4_gΩblk_t
 
fú°
,Öxt4_gΩblk_à
Àn
,

655 
pxt4_group_öfo
 *
gΩ
)

657 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

658 
pxt4_gΩblk_t
 
mö
;

659 
pxt4_gΩblk_t
 
max
;

660 
pxt4_gΩblk_t
 
chunk
;

661 
b‹dî
;

663 
	`BUG_ON
(
Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
));

665 
b‹dî
 = 2 << 
sb
->
s_blocksize_bôs
;

667 
Àn
 > 0) {

669 
max
 = 
	`ffs
(
fú°
 | 
b‹dî
) - 1;

672 
mö
 = 
	`Ês
(
Àn
) - 1;

674 i‡(
max
 < 
mö
)

675 
mö
 = 
max
;

676 
chunk
 = 1 << 
mö
;

679 
gΩ
->
bb_cou¡îs
[
mö
]++;

680 i‡(
mö
 > 0)

681 
	`mb_˛ór_bô
(
fú°
 >> 
mö
,

682 
buddy
 + 
sbi
->
s_mb_off£ts
[
mö
]);

684 
Àn
 -
chunk
;

685 
fú°
 +
chunk
;

687 
	}
}

694 
	$mb_£t_œrge°_‰ì_‹dî
(
su≥r_block
 *
sb
, 
pxt4_group_öfo
 *
gΩ
)

696 
i
;

697 
bôs
;

699 
gΩ
->
bb_œrge°_‰ì_‹dî
 = -1;

701 
bôs
 = 
sb
->
s_blocksize_bôs
 + 1;

702 
i
 = 
bôs
; i >= 0; i--) {

703 i‡(
gΩ
->
bb_cou¡îs
[
i
] > 0) {

704 
gΩ
->
bb_œrge°_‰ì_‹dî
 = 
i
;

708 
	}
}

710 
noölöe_f‹_°ack


711 
	$pxt4_mb_gíî©e_buddy
(
su≥r_block
 *
sb
,

712 *
buddy
, *
bôm≠
, 
pxt4_group_t
 
group
)

714 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

715 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

716 
pxt4_gΩblk_t
 
max
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

717 
pxt4_gΩblk_t
 
i
 = 0;

718 
pxt4_gΩblk_t
 
fú°
;

719 
pxt4_gΩblk_t
 
Àn
;

720 
‰ì
 = 0;

721 
‰agmíts
 = 0;

722 
≥riod
 = 
	`gë_cy˛es
();

726 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, 0);

727 
gΩ
->
bb_fú°_‰ì
 = 
i
;

728 
i
 < 
max
) {

729 
‰agmíts
++;

730 
fú°
 = 
i
;

731 
i
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
, i);

732 
Àn
 = 
i
 - 
fú°
;

733 
‰ì
 +
Àn
;

734 i‡(
Àn
 > 1)

735 
	`pxt4_mb_m¨k_‰ì_sim∂e
(
sb
, 
buddy
, 
fú°
, 
Àn
, 
gΩ
);

737 
gΩ
->
bb_cou¡îs
[0]++;

738 i‡(
i
 < 
max
)

739 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
, i);

741 
gΩ
->
bb_‰agmíts
 = 
‰agmíts
;

743 i‡(
‰ì
 !
gΩ
->
bb_‰ì
) {

744 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0,

747 
‰ì
, 
gΩ
->
bb_‰ì
);

752 
gΩ
->
bb_‰ì
 = 
‰ì
;

753 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
group
,

754 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

756 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
gΩ
);

758 
	`˛ór_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &(
gΩ
->
bb_°©e
));

760 
≥riod
 = 
	`gë_cy˛es
() -Öeriod;

761 
	`•ö_lock
(&
sbi
->
s_bÆ_lock
);

762 
sbi
->
s_mb_buddõs_gíî©ed
++;

763 
sbi
->
s_mb_gíî©i⁄_time
 +
≥riod
;

764 
	`•ö_u∆ock
(&
sbi
->
s_bÆ_lock
);

765 
	}
}

767 
	$mb_ªgíî©e_buddy
(
pxt4_buddy
 *
e4b
)

769 
cou¡
;

770 
‹dî
 = 1;

771 *
buddy
;

773 (
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
++, &
cou¡
))) {

774 
	`pxt4_£t_bôs
(
buddy
, 0, 
cou¡
);

776 
e4b
->
bd_öfo
->
bb_‰agmíts
 = 0;

777 
	`mem£t
(
e4b
->
bd_öfo
->
bb_cou¡îs
, 0,

778 (*
e4b
->
bd_öfo
->
bb_cou¡îs
) *

779 (
e4b
->
bd_sb
->
s_blocksize_bôs
 + 2));

781 
	`pxt4_mb_gíî©e_buddy
(
e4b
->
bd_sb
,É4b->
bd_buddy
,

782 
e4b
->
bd_bôm≠
,É4b->
bd_group
);

783 
	}
}

805 
	$pxt4_mb_öô_ˇche
(
∑ge
 *∑ge, *
öc‹e
, 
gÂ_t
 
gÂ
)

807 
pxt4_group_t
 
ngroups
;

808 
blocksize
;

809 
blocks_≥r_∑ge
;

810 
groups_≥r_∑ge
;

811 
îr
 = 0;

812 
i
;

813 
pxt4_group_t
 
fú°_group
, 
group
;

814 
fú°_block
;

815 
su≥r_block
 *
sb
;

816 
buf„r_hód
 *
bhs
;

817 
buf„r_hód
 **
bh
 = 
NULL
;

818 
öode
 *inode;

819 *
d©a
;

820 *
bôm≠
;

821 
pxt4_group_öfo
 *
gröfo
;

823 
	`mb_debug
(1, "öôÖagê%lu\n", 
∑ge
->
ödex
);

825 
öode
 = 
∑ge
->
m≠pög
->
ho°
;

826 
sb
 = 
öode
->
i_sb
;

827 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

828 
blocksize
 = 
	`i_blocksize
(
öode
);

829 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
blocksize
;

831 
groups_≥r_∑ge
 = 
blocks_≥r_∑ge
 >> 1;

832 i‡(
groups_≥r_∑ge
 == 0)

833 
groups_≥r_∑ge
 = 1;

836 i‡(
groups_≥r_∑ge
 > 1) {

837 
i
 = (
buf„r_hód
 *Ë* 
groups_≥r_∑ge
;

838 
bh
 = 
	`kzÆloc
(
i
, 
gÂ
);

839 i‡(
bh
 =
NULL
) {

840 
îr
 = -
ENOMEM
;

841 
out
;

844 
bh
 = &
bhs
;

846 
fú°_group
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
 / 2;

849 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

850 i‡(
group
 >
ngroups
)

853 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

860 i‡(
	`PageU±od©e
(
∑ge
Ë&& !
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
)) {

861 
bh
[
i
] = 
NULL
;

864 
bh
[
i
] = 
	`pxt4_ªad_block_bôm≠_nowaô
(
sb
, 
group
);

865 i‡(
	`IS_ERR
(
bh
[
i
])) {

866 
îr
 = 
	`PTR_ERR
(
bh
[
i
]);

867 
bh
[
i
] = 
NULL
;

868 
out
;

870 
	`mb_debug
(1, "ªad bôm≠ f‹ grou∞%u\n", 
group
);

874 
i
 = 0, 
group
 = 
fú°_group
; i < 
groups_≥r_∑ge
; i++, group++) {

875 
îr2
;

877 i‡(!
bh
[
i
])

879 
îr2
 = 
	`pxt4_waô_block_bôm≠
(
sb
, 
group
, 
bh
[
i
]);

880 i‡(!
îr
)

881 
îr
 = 
îr2
;

884 
fú°_block
 = 
∑ge
->
ödex
 * 
blocks_≥r_∑ge
;

885 
i
 = 0; i < 
blocks_≥r_∑ge
; i++) {

886 
group
 = (
fú°_block
 + 
i
) >> 1;

887 i‡(
group
 >
ngroups
)

890 i‡(!
bh
[
group
 - 
fú°_group
])

894 i‡(!
	`buf„r_vîifõd
(
bh
[
group
 - 
fú°_group
]))

897 
îr
 = 0;

905 
d©a
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
i
 * 
blocksize
);

906 
bôm≠
 = 
bh
[
group
 - 
fú°_group
]->
b_d©a
;

912 i‡((
fú°_block
 + 
i
) & 1) {

914 
	`BUG_ON
(
öc‹e
 =
NULL
);

915 
	`mb_debug
(1, "put buddy for group %u inÖage %lu/%x\n",

916 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

917 
	`åa˚_pxt4_mb_buddy_bôm≠_lﬂd
(
sb
, 
group
);

918 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

919 
gröfo
->
bb_‰agmíts
 = 0;

920 
	`mem£t
(
gröfo
->
bb_cou¡îs
, 0,

921 (*
gröfo
->
bb_cou¡îs
) *

922 (
sb
->
s_blocksize_bôs
+2));

926 
	`pxt4_lock_group
(
sb
, 
group
);

928 
	`mem£t
(
d©a
, 0xff, 
blocksize
);

929 
	`pxt4_mb_gíî©e_buddy
(
sb
, 
d©a
, 
öc‹e
, 
group
);

930 
	`pxt4_u∆ock_group
(
sb
, 
group
);

931 
öc‹e
 = 
NULL
;

934 
	`BUG_ON
(
öc‹e
 !
NULL
);

935 
	`mb_debug
(1, "put bitmap for group %u inÖage %lu/%x\n",

936 
group
, 
∑ge
->
ödex
, 
i
 * 
blocksize
);

937 
	`åa˚_pxt4_mb_bôm≠_lﬂd
(
sb
, 
group
);

940 
	`pxt4_lock_group
(
sb
, 
group
);

941 
	`mem˝y
(
d©a
, 
bôm≠
, 
blocksize
);

944 
	`pxt4_mb_gíî©e_‰om_∑
(
sb
, 
d©a
, 
group
);

945 
	`pxt4_mb_gíî©e_‰om_‰ìli°
(
sb
, 
d©a
, 
group
);

946 
	`pxt4_u∆ock_group
(
sb
, 
group
);

951 
öc‹e
 = 
d©a
;

954 
	`SëPageU±od©e
(
∑ge
);

956 
out
:

957 i‡(
bh
) {

958 
i
 = 0; i < 
groups_≥r_∑ge
; i++)

959 
	`bªl£
(
bh
[
i
]);

960 i‡(
bh
 !&
bhs
)

961 
	`k‰ì
(
bh
);

963  
îr
;

964 
	}
}

972 
	$pxt4_mb_gë_buddy_∑ge_lock
(
su≥r_block
 *
sb
,

973 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

975 
öode
 *öodê
	`PXT4_SB
(
sb
)->
s_buddy_ˇche
;

976 
block
, 
≤um
, 
poff
;

977 
blocks_≥r_∑ge
;

978 
∑ge
 *page;

980 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

981 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

983 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

989 
block
 = 
group
 * 2;

990 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

991 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

992 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

993 i‡(!
∑ge
)

994  -
ENOMEM
;

995 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

996 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

997 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

999 i‡(
blocks_≥r_∑ge
 >= 2) {

1004 
block
++;

1005 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1006 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1007 i‡(!
∑ge
)

1008  -
ENOMEM
;

1009 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1010 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1012 
	}
}

1014 
	$pxt4_mb_put_buddy_∑ge_lock
(
pxt4_buddy
 *
e4b
)

1016 i‡(
e4b
->
bd_bôm≠_∑ge
) {

1017 
	`u∆ock_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1018 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1020 i‡(
e4b
->
bd_buddy_∑ge
) {

1021 
	`u∆ock_∑ge
(
e4b
->
bd_buddy_∑ge
);

1022 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1024 
	}
}

1031 
noölöe_f‹_°ack


1032 
	$pxt4_mb_öô_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
, 
gÂ_t
 
gÂ
)

1035 
pxt4_group_öfo
 *
this_gΩ
;

1036 
pxt4_buddy
 
e4b
;

1037 
∑ge
 *page;

1038 
ªt
 = 0;

1040 
	`might_¶ìp
();

1041 
	`mb_debug
(1, "öô grou∞%u\n", 
group
);

1042 
this_gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1052 
ªt
 = 
	`pxt4_mb_gë_buddy_∑ge_lock
(
sb
, 
group
, &
e4b
, 
gÂ
);

1053 i‡(
ªt
 || !
	`PXT4_MB_GRP_NEED_INIT
(
this_gΩ
)) {

1058 
îr
;

1061 
∑ge
 = 
e4b
.
bd_bôm≠_∑ge
;

1062 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1063 i‡(
ªt
)

1064 
îr
;

1065 i‡(!
	`PageU±od©e
(
∑ge
)) {

1066 
ªt
 = -
EIO
;

1067 
îr
;

1070 i‡(
e4b
.
bd_buddy_∑ge
 =
NULL
) {

1076 
ªt
 = 0;

1077 
îr
;

1080 
∑ge
 = 
e4b
.
bd_buddy_∑ge
;

1081 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
.
bd_bôm≠
, 
gÂ
);

1082 i‡(
ªt
)

1083 
îr
;

1084 i‡(!
	`PageU±od©e
(
∑ge
)) {

1085 
ªt
 = -
EIO
;

1086 
îr
;

1088 
îr
:

1089 
	`pxt4_mb_put_buddy_∑ge_lock
(&
e4b
);

1090  
ªt
;

1091 
	}
}

1098 
noölöe_f‹_°ack
 

1099 
	$pxt4_mb_lﬂd_buddy_gÂ
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1100 
pxt4_buddy
 *
e4b
, 
gÂ_t
 
gÂ
)

1102 
blocks_≥r_∑ge
;

1103 
block
;

1104 
≤um
;

1105 
poff
;

1106 
∑ge
 *page;

1107 
ªt
;

1108 
pxt4_group_öfo
 *
gΩ
;

1109 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1110 
öode
 *öodê
sbi
->
s_buddy_ˇche
;

1112 
	`might_¶ìp
();

1113 
	`mb_debug
(1, "lﬂd grou∞%u\n", 
group
);

1115 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 / 
sb
->
s_blocksize
;

1116 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

1118 
e4b
->
bd_blkbôs
 = 
sb
->
s_blocksize_bôs
;

1119 
e4b
->
bd_öfo
 = 
gΩ
;

1120 
e4b
->
bd_sb
 = 
sb
;

1121 
e4b
->
bd_group
 = 
group
;

1122 
e4b
->
bd_buddy_∑ge
 = 
NULL
;

1123 
e4b
->
bd_bôm≠_∑ge
 = 
NULL
;

1125 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

1130 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
gÂ
);

1131 i‡(
ªt
)

1132  
ªt
;

1140 
block
 = 
group
 * 2;

1141 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1142 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1146 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1147 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1148 i‡(
∑ge
)

1157 
	`put_∑ge
(
∑ge
);

1158 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1159 i‡(
∑ge
) {

1160 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1161 i‡(!
	`PageU±od©e
(
∑ge
)) {

1162 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
NULL
, 
gÂ
);

1163 i‡(
ªt
) {

1164 
	`u∆ock_∑ge
(
∑ge
);

1165 
îr
;

1167 
	`mb_cmp_bôm≠s
(
e4b
, 
	`∑ge_addªss
(
∑ge
) +

1168 (
poff
 * 
sb
->
s_blocksize
));

1170 
	`u∆ock_∑ge
(
∑ge
);

1173 i‡(
∑ge
 =
NULL
) {

1174 
ªt
 = -
ENOMEM
;

1175 
îr
;

1177 i‡(!
	`PageU±od©e
(
∑ge
)) {

1178 
ªt
 = -
EIO
;

1179 
îr
;

1183 
e4b
->
bd_bôm≠_∑ge
 = 
∑ge
;

1184 
e4b
->
bd_bôm≠
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1186 
block
++;

1187 
≤um
 = 
block
 / 
blocks_≥r_∑ge
;

1188 
poff
 = 
block
 % 
blocks_≥r_∑ge
;

1190 
∑ge
 = 
	`föd_gë_∑ge_Êags
(
öode
->
i_m≠pög
, 
≤um
, 
FGP_ACCESSED
);

1191 i‡(
∑ge
 =
NULL
 || !
	`PageU±od©e
(page)) {

1192 i‡(
∑ge
)

1193 
	`put_∑ge
(
∑ge
);

1194 
∑ge
 = 
	`föd_‹_¸óã_∑ge
(
öode
->
i_m≠pög
, 
≤um
, 
gÂ
);

1195 i‡(
∑ge
) {

1196 
	`BUG_ON
(
∑ge
->
m≠pög
 !
öode
->
i_m≠pög
);

1197 i‡(!
	`PageU±od©e
(
∑ge
)) {

1198 
ªt
 = 
	`pxt4_mb_öô_ˇche
(
∑ge
, 
e4b
->
bd_bôm≠
,

1199 
gÂ
);

1200 i‡(
ªt
) {

1201 
	`u∆ock_∑ge
(
∑ge
);

1202 
îr
;

1205 
	`u∆ock_∑ge
(
∑ge
);

1208 i‡(
∑ge
 =
NULL
) {

1209 
ªt
 = -
ENOMEM
;

1210 
îr
;

1212 i‡(!
	`PageU±od©e
(
∑ge
)) {

1213 
ªt
 = -
EIO
;

1214 
îr
;

1218 
e4b
->
bd_buddy_∑ge
 = 
∑ge
;

1219 
e4b
->
bd_buddy
 = 
	`∑ge_addªss
(
∑ge
Ë+ (
poff
 * 
sb
->
s_blocksize
);

1221 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

1222 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

1226 
îr
:

1227 i‡(
∑ge
)

1228 
	`put_∑ge
(
∑ge
);

1229 i‡(
e4b
->
bd_bôm≠_∑ge
)

1230 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1231 i‡(
e4b
->
bd_buddy_∑ge
)

1232 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1233 
e4b
->
bd_buddy
 = 
NULL
;

1234 
e4b
->
bd_bôm≠
 = 
NULL
;

1235  
ªt
;

1236 
	}
}

1238 
	$pxt4_mb_lﬂd_buddy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

1239 
pxt4_buddy
 *
e4b
)

1241  
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, 
e4b
, 
GFP_NOFS
);

1242 
	}
}

1244 
	$pxt4_mb_u∆ﬂd_buddy
(
pxt4_buddy
 *
e4b
)

1246 i‡(
e4b
->
bd_bôm≠_∑ge
)

1247 
	`put_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

1248 i‡(
e4b
->
bd_buddy_∑ge
)

1249 
	`put_∑ge
(
e4b
->
bd_buddy_∑ge
);

1250 
	}
}

1253 
	$mb_föd_‹dî_f‹_block
(
pxt4_buddy
 *
e4b
, 
block
)

1255 
‹dî
 = 1;

1256 
bb_ö¸
 = 1 << (
e4b
->
bd_blkbôs
 - 1);

1257 *
bb
;

1259 
	`BUG_ON
(
e4b
->
bd_bôm≠
 =e4b->
bd_buddy
);

1260 
	`BUG_ON
(
block
 >(1 << (
e4b
->
bd_blkbôs
 + 3)));

1262 
bb
 = 
e4b
->
bd_buddy
;

1263 
‹dî
 <
e4b
->
bd_blkbôs
 + 1) {

1264 
block
 = block >> 1;

1265 i‡(!
	`mb_ã°_bô
(
block
, 
bb
)) {

1267  
‹dî
;

1269 
bb
 +
bb_ö¸
;

1270 
bb_ö¸
 >>= 1;

1271 
‹dî
++;

1274 
	}
}

1276 
	$mb_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1278 
__u32
 *
addr
;

1280 
Àn
 = 
cur
 +Üen;

1281 
cur
 < 
Àn
) {

1282 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1284 
addr
 = 
bm
 + (
cur
 >> 3);

1285 *
addr
 = 0;

1286 
cur
 += 32;

1289 
	`mb_˛ór_bô
(
cur
, 
bm
);

1290 
cur
++;

1292 
	}
}

1297 
	$mb_ã°_™d_˛ór_bôs
(*
bm
, 
cur
, 
Àn
)

1299 
__u32
 *
addr
;

1300 
zîo_bô
 = -1;

1302 
Àn
 = 
cur
 +Üen;

1303 
cur
 < 
Àn
) {

1304 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1306 
addr
 = 
bm
 + (
cur
 >> 3);

1307 i‡(*
addr
 !(
__u32
)(-1Ë&& 
zîo_bô
 == -1)

1308 
zîo_bô
 = 
cur
 + 
	`mb_föd_√xt_zîo_bô
(
addr
, 32, 0);

1309 *
addr
 = 0;

1310 
cur
 += 32;

1313 i‡(!
	`mb_ã°_™d_˛ór_bô
(
cur
, 
bm
Ë&& 
zîo_bô
 == -1)

1314 
zîo_bô
 = 
cur
;

1315 
cur
++;

1318  
zîo_bô
;

1319 
	}
}

1321 
	$pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
)

1323 
__u32
 *
addr
;

1325 
Àn
 = 
cur
 +Üen;

1326 
cur
 < 
Àn
) {

1327 i‡((
cur
 & 31Ë=0 && (
Àn
 - cur) >= 32) {

1329 
addr
 = 
bm
 + (
cur
 >> 3);

1330 *
addr
 = 0xffffffff;

1331 
cur
 += 32;

1334 
	`mb_£t_bô
(
cur
, 
bm
);

1335 
cur
++;

1337 
	}
}

1342 
ölöe
 
	$mb_buddy_adju°_b‹dî
(* 
bô
, * 
bôm≠
, 
side
)

1344 i‡(
	`mb_ã°_bô
(*
bô
 + 
side
, 
bôm≠
)) {

1345 
	`mb_˛ór_bô
(*
bô
, 
bôm≠
);

1346 (*
bô
Ë-
side
;

1350 (*
bô
Ë+
side
;

1351 
	`mb_£t_bô
(*
bô
, 
bôm≠
);

1354 
	}
}

1356 
	$mb_buddy_m¨k_‰ì
(
pxt4_buddy
 *
e4b
, 
fú°
, 
œ°
)

1358 
max
;

1359 
‹dî
 = 1;

1360 *
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
);

1362 
buddy
) {

1363 *
buddy2
;

1394 i‡(
fú°
 & 1)

1395 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
fú°
, 
buddy
, -1);

1396 i‡(!(
œ°
 & 1))

1397 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
] +
	`mb_buddy_adju°_b‹dî
(&
œ°
, 
buddy
, 1);

1398 i‡(
fú°
 > 
œ°
)

1400 
‹dî
++;

1402 i‡(
fú°
 =
œ°
 || !(
buddy2
 = 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
))) {

1403 
	`mb_˛ór_bôs
(
buddy
, 
fú°
, 
œ°
 - first + 1);

1404 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹dî
 - 1] +
œ°
 - 
fú°
 + 1;

1407 
fú°
 >>= 1;

1408 
œ°
 >>= 1;

1409 
buddy
 = 
buddy2
;

1411 
	}
}

1413 
	$mb_‰ì_blocks
(
öode
 *öode, 
pxt4_buddy
 *
e4b
,

1414 
fú°
, 
cou¡
)

1416 
À·_is_‰ì
 = 0;

1417 
right_is_‰ì
 = 0;

1418 
block
;

1419 
œ°
 = 
fú°
 + 
cou¡
 - 1;

1420 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

1422 i‡(
	`WARN_ON
(
cou¡
 == 0))

1424 
	`BUG_ON
(
œ°
 >(
sb
->
s_blocksize
 << 3));

1425 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
e4b
->
bd_group
));

1427 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
)))

1430 
	`mb_check_buddy
(
e4b
);

1431 
	`mb_‰ì_blocks_doubÀ
(
öode
, 
e4b
, 
fú°
, 
cou¡
);

1433 
e4b
->
bd_öfo
->
bb_‰ì
 +
cou¡
;

1434 i‡(
fú°
 < 
e4b
->
bd_öfo
->
bb_fú°_‰ì
)

1435 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 = 
fú°
;

1440 i‡(
fú°
 != 0)

1441 
À·_is_‰ì
 = !
	`mb_ã°_bô
(
fú°
 - 1, 
e4b
->
bd_bôm≠
);

1442 
block
 = 
	`mb_ã°_™d_˛ór_bôs
(
e4b
->
bd_bôm≠
, 
fú°
, 
cou¡
);

1443 i‡(
œ°
 + 1 < 
	`PXT4_SB
(
sb
)->
s_mb_maxs
[0])

1444 
right_is_‰ì
 = !
	`mb_ã°_bô
(
œ°
 + 1, 
e4b
->
bd_bôm≠
);

1446 i‡(
	`u∆ikñy
(
block
 != -1)) {

1447 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1448 
pxt4_fsblk_t
 
blockƒ
;

1450 
blockƒ
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

1451 
blockƒ
 +
	`PXT4_C2B
(
sbi
, 
block
);

1452 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
,

1453 
öode
 ? inode->
i_öo
 : 0,

1454 
blockƒ
,

1457 
block
);

1458 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1459 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1460 
	`mb_ªgíî©e_buddy
(
e4b
);

1461 
d⁄e
;

1465 i‡(
À·_is_‰ì
 && 
right_is_‰ì
)

1466 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1467 i‡(!
À·_is_‰ì
 && !
right_is_‰ì
)

1468 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1476 i‡(
fú°
 & 1) {

1477 
fú°
 +!
À·_is_‰ì
;

1478 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
À·_is_‰ì
 ? -1 : 1;

1480 i‡(!(
œ°
 & 1)) {

1481 
œ°
 -!
right_is_‰ì
;

1482 
e4b
->
bd_öfo
->
bb_cou¡îs
[0] +
right_is_‰ì
 ? -1 : 1;

1485 i‡(
fú°
 <
œ°
)

1486 
	`mb_buddy_m¨k_‰ì
(
e4b
, 
fú°
 >> 1, 
œ°
 >> 1);

1488 
d⁄e
:

1489 
	`mb_£t_œrge°_‰ì_‹dî
(
sb
, 
e4b
->
bd_öfo
);

1490 
	`mb_check_buddy
(
e4b
);

1491 
	}
}

1493 
	$mb_föd_exã¡
(
pxt4_buddy
 *
e4b
, 
block
,

1494 
√eded
, 
pxt4_‰ì_exã¡
 *
ex
)

1496 
√xt
 = 
block
;

1497 
max
, 
‹dî
;

1498 *
buddy
;

1500 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1501 
	`BUG_ON
(
ex
 =
NULL
);

1503 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 0, &
max
);

1504 
	`BUG_ON
(
buddy
 =
NULL
);

1505 
	`BUG_ON
(
block
 >
max
);

1506 i‡(
	`mb_ã°_bô
(
block
, 
buddy
)) {

1507 
ex
->
„_Àn
 = 0;

1508 
ex
->
„_°¨t
 = 0;

1509 
ex
->
„_group
 = 0;

1514 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
block
);

1515 
block
 = block >> 
‹dî
;

1517 
ex
->
„_Àn
 = 1 << 
‹dî
;

1518 
ex
->
„_°¨t
 = 
block
 << 
‹dî
;

1519 
ex
->
„_group
 = 
e4b
->
bd_group
;

1522 
√xt
 =Çexà- 
ex
->
„_°¨t
;

1523 
ex
->
„_Àn
 -
√xt
;

1524 
ex
->
„_°¨t
 +
√xt
;

1526 
√eded
 > 
ex
->
„_Àn
 &&

1527 
	`mb_föd_buddy
(
e4b
, 
‹dî
, &
max
)) {

1529 i‡(
block
 + 1 >
max
)

1532 
√xt
 = (
block
 + 1Ë* (1 << 
‹dî
);

1533 i‡(
	`mb_ã°_bô
(
√xt
, 
e4b
->
bd_bôm≠
))

1536 
‹dî
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
√xt
);

1538 
block
 = 
√xt
 >> 
‹dî
;

1539 
ex
->
„_Àn
 +1 << 
‹dî
;

1542 i‡(
ex
->
„_°¨t
 +Éx->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
e4b
->
bd_sb
)) {

1544 
	`WARN_ON
(1);

1545 
	`pxt4_îr‹
(
e4b
->
bd_sb
, "corruption or bug in mb_find_extent "

1547 
block
, 
‹dî
, 
√eded
, 
ex
->
„_group
,Éx->
„_°¨t
,

1548 
ex
->
„_Àn
,Éx->
„_logiˇl
);

1549 
ex
->
„_Àn
 = 0;

1550 
ex
->
„_°¨t
 = 0;

1551 
ex
->
„_group
 = 0;

1553  
ex
->
„_Àn
;

1554 
	}
}

1556 
	$mb_m¨k_u£d
(
pxt4_buddy
 *
e4b
, 
pxt4_‰ì_exã¡
 *
ex
)

1558 
‹d
;

1559 
mÀn
 = 0;

1560 
max
 = 0;

1561 
cur
;

1562 
°¨t
 = 
ex
->
„_°¨t
;

1563 
Àn
 = 
ex
->
„_Àn
;

1564 
ªt
 = 0;

1565 
Àn0
 = 
Àn
;

1566 *
buddy
;

1568 
	`BUG_ON
(
°¨t
 + 
Àn
 > (
e4b
->
bd_sb
->
s_blocksize
 << 3));

1569 
	`BUG_ON
(
e4b
->
bd_group
 !
ex
->
„_group
);

1570 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
e4b
->
bd_sb
,É4b->
bd_group
));

1571 
	`mb_check_buddy
(
e4b
);

1572 
	`mb_m¨k_u£d_doubÀ
(
e4b
, 
°¨t
, 
Àn
);

1574 
e4b
->
bd_öfo
->
bb_‰ì
 -
Àn
;

1575 i‡(
e4b
->
bd_öfo
->
bb_fú°_‰ì
 =
°¨t
)

1576 
e4b
->
bd_öfo
->
bb_fú°_‰ì
 +
Àn
;

1579 i‡(
°¨t
 != 0)

1580 
mÀn
 = !
	`mb_ã°_bô
(
°¨t
 - 1, 
e4b
->
bd_bôm≠
);

1581 i‡(
°¨t
 + 
Àn
 < 
	`PXT4_SB
(
e4b
->
bd_sb
)->
s_mb_maxs
[0])

1582 
max
 = !
	`mb_ã°_bô
(
°¨t
 + 
Àn
, 
e4b
->
bd_bôm≠
);

1583 i‡(
mÀn
 && 
max
)

1584 
e4b
->
bd_öfo
->
bb_‰agmíts
++;

1585 i‡(!
mÀn
 && !
max
)

1586 
e4b
->
bd_öfo
->
bb_‰agmíts
--;

1589 
Àn
) {

1590 
‹d
 = 
	`mb_föd_‹dî_f‹_block
(
e4b
, 
°¨t
);

1592 i‡(((
°¨t
 >> 
‹d
Ë<< ordË=°¨à&& 
Àn
 >= (1 << ord)) {

1594 
mÀn
 = 1 << 
‹d
;

1595 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1596 
	`BUG_ON
((
°¨t
 >> 
‹d
Ë>
max
);

1597 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1598 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1599 
°¨t
 +
mÀn
;

1600 
Àn
 -
mÀn
;

1601 
	`BUG_ON
(
Àn
 < 0);

1606 i‡(
ªt
 == 0)

1607 
ªt
 = 
Àn
 | (
‹d
 << 16);

1610 
	`BUG_ON
(
‹d
 <= 0);

1611 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1612 
	`mb_£t_bô
(
°¨t
 >> 
‹d
, 
buddy
);

1613 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]--;

1615 
‹d
--;

1616 
cur
 = (
°¨t
 >> 
‹d
) & ~1U;

1617 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
‹d
, &
max
);

1618 
	`mb_˛ór_bô
(
cur
, 
buddy
);

1619 
	`mb_˛ór_bô
(
cur
 + 1, 
buddy
);

1620 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1621 
e4b
->
bd_öfo
->
bb_cou¡îs
[
‹d
]++;

1623 
	`mb_£t_œrge°_‰ì_‹dî
(
e4b
->
bd_sb
,É4b->
bd_öfo
);

1625 
	`pxt4_£t_bôs
(
e4b
->
bd_bôm≠
, 
ex
->
„_°¨t
, 
Àn0
);

1626 
	`mb_check_buddy
(
e4b
);

1628  
ªt
;

1629 
	}
}

1634 
	$pxt4_mb_u£_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1635 
pxt4_buddy
 *
e4b
)

1637 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1638 
ªt
;

1640 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_group
 !
e4b
->
bd_group
);

1641 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

1643 
ac
->
ac_b_ex
.
„_Àn
 = 
	`mö
◊c->ac_b_ex.„_Àn,ác->
ac_g_ex
.fe_len);

1644 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_g_ex
.fe_logical;

1645 
ªt
 = 
	`mb_m¨k_u£d
(
e4b
, &
ac
->
ac_b_ex
);

1649 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

1651 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

1652 
ac
->
ac_èû
 = 
ªt
 & 0xffff;

1653 
ac
->
ac_buddy
 = 
ªt
 >> 16;

1662 
ac
->
ac_bôm≠_∑ge
 = 
e4b
->
bd_bôm≠_∑ge
;

1663 
	`gë_∑ge
(
ac
->
ac_bôm≠_∑ge
);

1664 
ac
->
ac_buddy_∑ge
 = 
e4b
->
bd_buddy_∑ge
;

1665 
	`gë_∑ge
(
ac
->
ac_buddy_∑ge
);

1667 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

1668 
	`•ö_lock
(&
sbi
->
s_md_lock
);

1669 
sbi
->
s_mb_œ°_group
 = 
ac
->
ac_f_ex
.
„_group
;

1670 
sbi
->
s_mb_œ°_°¨t
 = 
ac
->
ac_f_ex
.
„_°¨t
;

1671 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

1673 
	}
}

1679 
	$pxt4_mb_check_limôs
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1680 
pxt4_buddy
 *
e4b
,

1681 
föish_group
)

1683 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1684 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1685 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1686 
pxt4_‰ì_exã¡
 
ex
;

1687 
max
;

1689 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

1694 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
 &&

1695 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1696 
ac
->
ac_°©us
 = 
AC_STATUS_BREAK
;

1703 i‡(
bex
->
„_Àn
 < 
gex
->fe_len)

1706 i‡((
föish_group
 || 
ac
->
ac_found
 > 
sbi
->
s_mb_mö_to_sˇn
)

1707 && 
bex
->
„_group
 =
e4b
->
bd_group
) {

1711 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
bex
->
„_°¨t
, 
gex
->
„_Àn
, &
ex
);

1712 i‡(
max
 >
gex
->
„_Àn
) {

1713 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1717 
	}
}

1729 
	$pxt4_mb_mósuª_exã¡
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1730 
pxt4_‰ì_exã¡
 *
ex
,

1731 
pxt4_buddy
 *
e4b
)

1733 
pxt4_‰ì_exã¡
 *
bex
 = &
ac
->
ac_b_ex
;

1734 
pxt4_‰ì_exã¡
 *
gex
 = &
ac
->
ac_g_ex
;

1736 
	`BUG_ON
(
ex
->
„_Àn
 <= 0);

1737 
	`BUG_ON
(
ex
->
„_Àn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1738 
	`BUG_ON
(
ex
->
„_°¨t
 >
	`PXT4_CLUSTERS_PER_GROUP
(
ac
->
ac_sb
));

1739 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
);

1741 
ac
->
ac_found
++;

1746 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

1747 *
bex
 = *
ex
;

1748 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1755 i‡(
ex
->
„_Àn
 =
gex
->fe_len) {

1756 *
bex
 = *
ex
;

1757 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1764 i‡(
bex
->
„_Àn
 == 0) {

1765 *
bex
 = *
ex
;

1772 i‡(
bex
->
„_Àn
 < 
gex
->fe_len) {

1775 i‡(
ex
->
„_Àn
 > 
bex
->fe_len)

1776 *
bex
 = *
ex
;

1777 } i‡(
ex
->
„_Àn
 > 
gex
->fe_len) {

1781 i‡(
ex
->
„_Àn
 < 
bex
->fe_len)

1782 *
bex
 = *
ex
;

1785 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 0);

1786 
	}
}

1788 
noölöe_f‹_°ack


1789 
	$pxt4_mb_åy_be°_found
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1790 
pxt4_buddy
 *
e4b
)

1792 
pxt4_‰ì_exã¡
 
ex
 = 
ac
->
ac_b_ex
;

1793 
pxt4_group_t
 
group
 = 
ex
.
„_group
;

1794 
max
;

1795 
îr
;

1797 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1798 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1799 i‡(
îr
)

1800  
îr
;

1802 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1803 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ex
.
„_°¨t
,Éx.
„_Àn
, &ex);

1805 i‡(
max
 > 0) {

1806 
ac
->
ac_b_ex
 = 
ex
;

1807 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1810 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1811 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1814 
	}
}

1816 
noölöe_f‹_°ack


1817 
	$pxt4_mb_föd_by_gﬂl
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1818 
pxt4_buddy
 *
e4b
)

1820 
pxt4_group_t
 
group
 = 
ac
->
ac_g_ex
.
„_group
;

1821 
max
;

1822 
îr
;

1823 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

1824 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

1825 
pxt4_‰ì_exã¡
 
ex
;

1827 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_TRY_GOAL
))

1829 i‡(
gΩ
->
bb_‰ì
 == 0)

1832 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
, 
group
, 
e4b
);

1833 i‡(
îr
)

1834  
îr
;

1836 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
e4b
->
bd_öfo
))) {

1837 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1841 
	`pxt4_lock_group
(
ac
->
ac_sb
, 
group
);

1842 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
ac
->
ac_g_ex
.
„_°¨t
,

1843 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1844 
ex
.
„_logiˇl
 = 0xDEADFA11;

1846 i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
 &&ác->ac_g_ex.„_À¿=
sbi
->
s_°rùe
) {

1847 
pxt4_fsblk_t
 
°¨t
;

1849 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
ac
->
ac_sb
, 
e4b
->
bd_group
) +

1850 
ex
.
„_°¨t
;

1852 i‡(
	`do_div
(
°¨t
, 
sbi
->
s_°rùe
) == 0) {

1853 
ac
->
ac_found
++;

1854 
ac
->
ac_b_ex
 = 
ex
;

1855 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1857 } i‡(
max
 >
ac
->
ac_g_ex
.
„_Àn
) {

1858 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1859 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1860 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1861 
ac
->
ac_found
++;

1862 
ac
->
ac_b_ex
 = 
ex
;

1863 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1864 } i‡(
max
 > 0 && (
ac
->
ac_Êags
 & 
PXT4_MB_HINT_MERGE
)) {

1867 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1868 
	`BUG_ON
(
ex
.
„_group
 !
ac
->
ac_g_ex
.fe_group);

1869 
	`BUG_ON
(
ex
.
„_°¨t
 !
ac
->
ac_g_ex
.fe_start);

1870 
ac
->
ac_found
++;

1871 
ac
->
ac_b_ex
 = 
ex
;

1872 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1874 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
, 
group
);

1875 
	`pxt4_mb_u∆ﬂd_buddy
(
e4b
);

1878 
	}
}

1884 
noölöe_f‹_°ack


1885 
	$pxt4_mb_sim∂e_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1886 
pxt4_buddy
 *
e4b
)

1888 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1889 
pxt4_group_öfo
 *
gΩ
 = 
e4b
->
bd_öfo
;

1890 *
buddy
;

1891 
i
;

1892 
k
;

1893 
max
;

1895 
	`BUG_ON
(
ac
->
ac_2‹dî
 <= 0);

1896 
i
 = 
ac
->
ac_2‹dî
; i <
sb
->
s_blocksize_bôs
 + 1; i++) {

1897 i‡(
gΩ
->
bb_cou¡îs
[
i
] == 0)

1900 
buddy
 = 
	`mb_föd_buddy
(
e4b
, 
i
, &
max
);

1901 
	`BUG_ON
(
buddy
 =
NULL
);

1903 
k
 = 
	`mb_föd_√xt_zîo_bô
(
buddy
, 
max
, 0);

1904 
	`BUG_ON
(
k
 >
max
);

1906 
ac
->
ac_found
++;

1908 
ac
->
ac_b_ex
.
„_Àn
 = 1 << 
i
;

1909 
ac
->
ac_b_ex
.
„_°¨t
 = 
k
 << 
i
;

1910 
ac
->
ac_b_ex
.
„_group
 = 
e4b
->
bd_group
;

1912 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

1914 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 !ac->
ac_g_ex
.fe_len);

1916 i‡(
	`PXT4_SB
(
sb
)->
s_mb_°©s
)

1917 
	`©omic_öc
(&
	`PXT4_SB
(
sb
)->
s_bÆ_2‹dîs
);

1921 
	}
}

1928 
noölöe_f‹_°ack


1929 
	$pxt4_mb_com∂ex_sˇn_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1930 
pxt4_buddy
 *
e4b
)

1932 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1933 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1934 
pxt4_‰ì_exã¡
 
ex
;

1935 
i
;

1936 
‰ì
;

1938 
‰ì
 = 
e4b
->
bd_öfo
->
bb_‰ì
;

1939 
	`BUG_ON
(
‰ì
 <= 0);

1941 
i
 = 
e4b
->
bd_öfo
->
bb_fú°_‰ì
;

1943 
‰ì
 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
) {

1944 
i
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
,

1945 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
), 
i
);

1946 i‡(
i
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

1952 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1955 
‰ì
);

1956 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1957 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1961 
	`mb_föd_exã¡
(
e4b
, 
i
, 
ac
->
ac_g_ex
.
„_Àn
, &
ex
);

1962 
	`BUG_ON
(
ex
.
„_Àn
 <= 0);

1963 i‡(
‰ì
 < 
ex
.
„_Àn
) {

1964 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
e4b
->
bd_group
, 0, 0,

1967 
‰ì
, 
ex
.
„_Àn
);

1968 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
sb
, 
e4b
->
bd_group
,

1969 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
);

1977 
ex
.
„_logiˇl
 = 0xDEADC0DE;

1978 
	`pxt4_mb_mósuª_exã¡
(
ac
, &
ex
, 
e4b
);

1980 
i
 +
ex
.
„_Àn
;

1981 
‰ì
 -
ex
.
„_Àn
;

1984 
	`pxt4_mb_check_limôs
(
ac
, 
e4b
, 1);

1985 
	}
}

1991 
noölöe_f‹_°ack


1992 
	$pxt4_mb_sˇn_Æig√d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

1993 
pxt4_buddy
 *
e4b
)

1995 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

1996 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1997 *
bôm≠
 = 
e4b
->
bd_bôm≠
;

1998 
pxt4_‰ì_exã¡
 
ex
;

1999 
pxt4_fsblk_t
 
fú°_group_block
;

2000 
pxt4_fsblk_t
 
a
;

2001 
pxt4_gΩblk_t
 
i
;

2002 
max
;

2004 
	`BUG_ON
(
sbi
->
s_°rùe
 == 0);

2007 
fú°_group_block
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
e4b
->
bd_group
);

2009 
a
 = 
fú°_group_block
 + 
sbi
->
s_°rùe
 - 1;

2010 
	`do_div
(
a
, 
sbi
->
s_°rùe
);

2011 
i
 = (
a
 * 
sbi
->
s_°rùe
Ë- 
fú°_group_block
;

2013 
i
 < 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

2014 i‡(!
	`mb_ã°_bô
(
i
, 
bôm≠
)) {

2015 
max
 = 
	`mb_föd_exã¡
(
e4b
, 
i
, 
sbi
->
s_°rùe
, &
ex
);

2016 i‡(
max
 >
sbi
->
s_°rùe
) {

2017 
ac
->
ac_found
++;

2018 
ex
.
„_logiˇl
 = 0xDEADF00D;

2019 
ac
->
ac_b_ex
 = 
ex
;

2020 
	`pxt4_mb_u£_be°_found
(
ac
, 
e4b
);

2024 
i
 +
sbi
->
s_°rùe
;

2026 
	}
}

2034 
	$pxt4_mb_good_group
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2035 
pxt4_group_t
 
group
, 
¸
)

2037 
‰ì
, 
‰agmíts
;

2038 
Êex_size
 = 
	`pxt4_Êex_bg_size
(
	`PXT4_SB
(
ac
->
ac_sb
));

2039 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
ac
->
ac_sb
, 
group
);

2041 
	`BUG_ON
(
¸
 < 0 || cr >= 4);

2043 
‰ì
 = 
gΩ
->
bb_‰ì
;

2044 i‡(
‰ì
 == 0)

2046 i‡(
¸
 <2 && 
‰ì
 < 
ac
->
ac_g_ex
.
„_Àn
)

2049 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
)))

2053 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

2054 
ªt
 = 
	`pxt4_mb_öô_group
(
ac
->
ac_sb
, 
group
, 
GFP_NOFS
);

2055 i‡(
ªt
)

2056  
ªt
;

2059 
‰agmíts
 = 
gΩ
->
bb_‰agmíts
;

2060 i‡(
‰agmíts
 == 0)

2063 
¸
) {

2065 
	`BUG_ON
(
ac
->
ac_2‹dî
 == 0);

2068 i‡((
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
) &&

2069 (
Êex_size
 >
PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
) &&

2070 ((
group
 % 
Êex_size
) == 0))

2073 i‡((
ac
->
ac_2‹dî
 >ác->
ac_sb
->
s_blocksize_bôs
+1) ||

2074 (
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2077 i‡(
gΩ
->
bb_œrge°_‰ì_‹dî
 < 
ac
->
ac_2‹dî
)

2082 i‡((
‰ì
 / 
‰agmíts
Ë>
ac
->
ac_g_ex
.
„_Àn
)

2086 i‡(
‰ì
 >
ac
->
ac_g_ex
.
„_Àn
)

2092 
	`BUG
();

2096 
	}
}

2098 
noölöe_f‹_°ack
 

2099 
	$pxt4_mb_ªguœr_Æloˇt‹
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

2101 
pxt4_group_t
 
ngroups
, 
group
, 
i
;

2102 
¸
;

2103 
îr
 = 0, 
fú°_îr
 = 0;

2104 
pxt4_sb_öfo
 *
sbi
;

2105 
su≥r_block
 *
sb
;

2106 
pxt4_buddy
 
e4b
;

2108 
sb
 = 
ac
->
ac_sb
;

2109 
sbi
 = 
	`PXT4_SB
(
sb
);

2110 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2112 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)))

2113 
ngroups
 = 
sbi
->
s_blockfûe_groups
;

2115 
	`BUG_ON
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
);

2118 
îr
 = 
	`pxt4_mb_föd_by_gﬂl
(
ac
, &
e4b
);

2119 i‡(
îr
 || 
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)

2120 
out
;

2122 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

2123 
out
;

2130 
i
 = 
	`Ês
(
ac
->
ac_g_ex
.
„_Àn
);

2131 
ac
->
ac_2‹dî
 = 0;

2139 i‡(
i
 >
sbi
->
s_mb_‹dî2_ªqs
 && i <
sb
->
s_blocksize_bôs
 + 2) {

2143 i‡((
ac
->
ac_g_ex
.
„_Àn
 & (~(1 << (
i
 - 1)))) == 0)

2144 
ac
->
ac_2‹dî
 = 
	`¨øy_ödex_no•ec
(
i
 - 1,

2145 
sb
->
s_blocksize_bôs
 + 2);

2149 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_STREAM_ALLOC
) {

2151 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2152 
ac
->
ac_g_ex
.
„_group
 = 
sbi
->
s_mb_œ°_group
;

2153 
ac
->
ac_g_ex
.
„_°¨t
 = 
sbi
->
s_mb_œ°_°¨t
;

2154 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2158 
¸
 = 
ac
->
ac_2‹dî
 ? 0 : 1;

2163 
ª≥©
:

2164 ; 
¸
 < 4 && 
ac
->
ac_°©us
 =
AC_STATUS_CONTINUE
; cr++) {

2165 
ac
->
ac_¸ôîü
 = 
¸
;

2170 
group
 = 
ac
->
ac_g_ex
.
„_group
;

2172 
i
 = 0; i < 
ngroups
; 
group
++, i++) {

2173 
ªt
 = 0;

2174 
	`c⁄d_ªsched
();

2179 i‡(
group
 >
ngroups
)

2180 
group
 = 0;

2183 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2184 i‡(
ªt
 <= 0) {

2185 i‡(!
fú°_îr
)

2186 
fú°_îr
 = 
ªt
;

2190 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2191 i‡(
îr
)

2192 
out
;

2194 
	`pxt4_lock_group
(
sb
, 
group
);

2200 
ªt
 = 
	`pxt4_mb_good_group
(
ac
, 
group
, 
¸
);

2201 i‡(
ªt
 <= 0) {

2202 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2203 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2204 i‡(!
fú°_îr
)

2205 
fú°_îr
 = 
ªt
;

2209 
ac
->
ac_groups_sˇ¬ed
++;

2210 i‡(
¸
 == 0)

2211 
	`pxt4_mb_sim∂e_sˇn_group
(
ac
, &
e4b
);

2212 i‡(
¸
 =1 && 
sbi
->
s_°rùe
 &&

2213 !(
ac
->
ac_g_ex
.
„_Àn
 % 
sbi
->
s_°rùe
))

2214 
	`pxt4_mb_sˇn_Æig√d
(
ac
, &
e4b
);

2216 
	`pxt4_mb_com∂ex_sˇn_group
(
ac
, &
e4b
);

2218 
	`pxt4_u∆ock_group
(
sb
, 
group
);

2219 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2221 i‡(
ac
->
ac_°©us
 !
AC_STATUS_CONTINUE
)

2226 i‡(
ac
->
ac_b_ex
.
„_Àn
 > 0 &&ác->
ac_°©us
 !
AC_STATUS_FOUND
 &&

2227 !(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_FIRST
)) {

2233 
	`pxt4_mb_åy_be°_found
(
ac
, &
e4b
);

2234 i‡(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
) {

2241 
ac
->
ac_b_ex
.
„_group
 = 0;

2242 
ac
->
ac_b_ex
.
„_°¨t
 = 0;

2243 
ac
->
ac_b_ex
.
„_Àn
 = 0;

2244 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

2245 
ac
->
ac_Êags
 |
PXT4_MB_HINT_FIRST
;

2246 
¸
 = 3;

2247 
	`©omic_öc
(&
sbi
->
s_mb_lo°_chunks
);

2248 
ª≥©
;

2251 
out
:

2252 i‡(!
îr
 && 
ac
->
ac_°©us
 !
AC_STATUS_FOUND
 && 
fú°_îr
)

2253 
îr
 = 
fú°_îr
;

2254  
îr
;

2255 
	}
}

2257 *
	$pxt4_mb_£q_groups_°¨t
(
£q_fûe
 *
£q
, 
loff_t
 *
pos
)

2259 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2260 
pxt4_group_t
 
group
;

2262 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2263  
NULL
;

2264 
group
 = *
pos
 + 1;

2265  (*Ë((Ë
group
);

2266 
	}
}

2268 *
	$pxt4_mb_£q_groups_√xt
(
£q_fûe
 *
£q
, *
v
, 
loff_t
 *
pos
)

2270 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2271 
pxt4_group_t
 
group
;

2273 ++*
pos
;

2274 i‡(*
pos
 < 0 || *po†>
	`pxt4_gë_groups_cou¡
(
sb
))

2275  
NULL
;

2276 
group
 = *
pos
 + 1;

2277  (*Ë((Ë
group
);

2278 
	}
}

2280 
	$pxt4_mb_£q_groups_show
(
£q_fûe
 *
£q
, *
v
)

2282 
su≥r_block
 *
sb
 = 
	`PDE_DATA
(
	`fûe_öode
(
£q
->
fûe
));

2283 
pxt4_group_t
 
group
 = (pxt4_group_tË((Ë
v
);

2284 
i
;

2285 
îr
, 
buddy_lﬂded
 = 0;

2286 
pxt4_buddy
 
e4b
;

2287 
pxt4_group_öfo
 *
gröfo
;

2288 
blocksize_bôs
 = 
	`mö_t
(,

2289 
sb
->
s_blocksize_bôs
,

2290 
PXT4_MAX_BLOCK_LOG_SIZE
);

2291 
	ssg
 {

2292 
pxt4_group_öfo
 
öfo
;

2293 
pxt4_gΩblk_t
 
cou¡îs
[
PXT4_MAX_BLOCK_LOG_SIZE
 + 2];

2294 } 
sg
;

2296 
group
--;

2297 i‡(
group
 == 0)

2298 
	`£q_puts
(
£q
, "#group: free frags first ["

2302 
i
 = (
blocksize_bôs
 + 2Ë* (
sg
.
öfo
.
bb_cou¡îs
[0]) +

2303 (
pxt4_group_öfo
);

2305 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

2307 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gröfo
))) {

2308 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

2309 i‡(
îr
) {

2310 
	`£q_¥ötf
(
£q
, "#%-5u: I/OÉº‹\n", 
group
);

2313 
buddy_lﬂded
 = 1;

2316 
	`mem˝y
(&
sg
, 
	`pxt4_gë_group_öfo
(
sb
, 
group
), 
i
);

2318 i‡(
buddy_lﬂded
)

2319 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2321 
	`£q_¥ötf
(
£q
, "#%-5u: %-5u %-5u %-5u [", 
group
, 
sg
.
öfo
.
bb_‰ì
,

2322 
sg
.
öfo
.
bb_‰agmíts
, sg.öfo.
bb_fú°_‰ì
);

2323 
i
 = 0; i <= 13; i++)

2324 
	`£q_¥ötf
(
£q
, " %-5u", 
i
 <
blocksize_bôs
 + 1 ?

2325 
sg
.
öfo
.
bb_cou¡îs
[
i
] : 0);

2326 
	`£q_¥ötf
(
£q
, " ]\n");

2329 
	}
}

2331 
	$pxt4_mb_£q_groups_°›
(
£q_fûe
 *
£q
, *
v
)

2333 
	}
}

2335 c⁄° 
£q_›î©i⁄s
 
	gpxt4_mb_£q_groups_›s
 = {

2336 .
°¨t
 = 
pxt4_mb_£q_groups_°¨t
,

2337 .
	g√xt
 = 
pxt4_mb_£q_groups_√xt
,

2338 .
	g°›
 = 
pxt4_mb_£q_groups_°›
,

2339 .
	gshow
 = 
pxt4_mb_£q_groups_show
,

2342 
kmem_ˇche
 *
	$gë_groupöfo_ˇche
(
blocksize_bôs
)

2344 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2345 
kmem_ˇche
 *
ˇchï
 = 
pxt4_groupöfo_ˇches
[
ˇche_ödex
];

2347 
	`BUG_ON
(!
ˇchï
);

2348  
ˇchï
;

2349 
	}
}

2355 
	$pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroups
)

2357 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2358 
size
;

2359 
pxt4_group_öfo
 ***
√w_groupöfo
;

2361 
size
 = (
ngroups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2362 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2363 i‡(
size
 <
sbi
->
s_group_öfo_size
)

2366 
size
 = 
	`roundup_pow_of_two
((*
sbi
->
s_group_öfo
) * size);

2367 
√w_groupöfo
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2368 i‡(!
√w_groupöfo
) {

2369 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy meta group");

2370  -
ENOMEM
;

2372 i‡(
sbi
->
s_group_öfo
) {

2373 
	`mem˝y
(
√w_groupöfo
, 
sbi
->
s_group_öfo
,

2374 
sbi
->
s_group_öfo_size
 * (*sbi->
s_group_öfo
));

2375 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2377 
sbi
->
s_group_öfo
 = 
√w_groupöfo
;

2378 
sbi
->
s_group_öfo_size
 = 
size
 / (*sbi->
s_group_öfo
);

2379 
	`pxt4_debug
("allocated s_groupinfoárray for %d meta_bg's\n",

2380 
sbi
->
s_group_öfo_size
);

2382 
	}
}

2385 
	$pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2386 
pxt4_group_desc
 *
desc
)

2388 
i
;

2389 
mëÆí
 = 0;

2390 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2391 
pxt4_group_öfo
 **
mëa_group_öfo
;

2392 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2399 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2400 
mëÆí
 = (*
mëa_group_öfo
) <<

2401 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2402 
mëa_group_öfo
 = 
	`kmÆloc
(
mëÆí
, 
GFP_NOFS
);

2403 i‡(
mëa_group_öfo
 =
NULL
) {

2404 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate mem "

2406 
exô_mëa_group_öfo
;

2408 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)] =

2409 
mëa_group_öfo
;

2412 
mëa_group_öfo
 =

2413 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)];

2414 
i
 = 
group
 & (
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1);

2416 
mëa_group_öfo
[
i
] = 
	`kmem_ˇche_zÆloc
(
ˇchï
, 
GFP_NOFS
);

2417 i‡(
mëa_group_öfo
[
i
] =
NULL
) {

2418 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tállocate buddy mem");

2419 
exô_group_öfo
;

2421 
	`£t_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
,

2422 &(
mëa_group_öfo
[
i
]->
bb_°©e
));

2428 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2429 (
desc
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2430 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2431 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
, 
group
, 
desc
);

2433 
mëa_group_öfo
[
i
]->
bb_‰ì
 =

2434 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

2437 
	`INIT_LIST_HEAD
(&
mëa_group_öfo
[
i
]->
bb_¥óŒoc_li°
);

2438 
	`öô_rw£m
(&
mëa_group_öfo
[
i
]->
Æloc_£m
);

2439 
mëa_group_öfo
[
i
]->
bb_‰ì_roŸ
 = 
RB_ROOT
;

2440 
mëa_group_öfo
[
i
]->
bb_œrge°_‰ì_‹dî
 = -1;

2442 #ifde‡
DOUBLE_CHECK


2444 
buf„r_hód
 *
bh
;

2445 
mëa_group_öfo
[
i
]->
bb_bôm≠
 =

2446 
	`kmÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

2447 
	`BUG_ON
(
mëa_group_öfo
[
i
]->
bb_bôm≠
 =
NULL
);

2448 
bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

2449 
	`BUG_ON
(
	`IS_ERR_OR_NULL
(
bh
));

2450 
	`mem˝y
(
mëa_group_öfo
[
i
]->
bb_bôm≠
, 
bh
->
b_d©a
,

2451 
sb
->
s_blocksize
);

2452 
	`put_bh
(
bh
);

2458 
exô_group_öfo
:

2460 i‡(
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
) == 0) {

2461 
	`k‰ì
(
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)]);

2462 
sbi
->
s_group_öfo
[
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)] = 
NULL
;

2464 
exô_mëa_group_öfo
:

2465  -
ENOMEM
;

2466 
	}
}

2468 
	$pxt4_mb_öô_backíd
(
su≥r_block
 *
sb
)

2470 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2471 
pxt4_group_t
 
i
;

2472 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2473 
îr
;

2474 
pxt4_group_desc
 *
desc
;

2475 
kmem_ˇche
 *
ˇchï
;

2477 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
ngroups
);

2478 i‡(
îr
)

2479  
îr
;

2481 
sbi
->
s_buddy_ˇche
 = 
	`√w_öode
(
sb
);

2482 i‡(
sbi
->
s_buddy_ˇche
 =
NULL
) {

2483 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't getÇew inode");

2484 
îr_‰ìsgi
;

2490 
sbi
->
s_buddy_ˇche
->
i_öo
 = 
PXT4_BAD_INO
;

2491 
	`PXT4_I
(
sbi
->
s_buddy_ˇche
)->
i_disksize
 = 0;

2492 
i
 = 0; i < 
ngroups
; i++) {

2493 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2494 i‡(
desc
 =
NULL
) {

2495 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "ˇn'àªad des¸ùt‹ %u", 
i
);

2496 
îr_‰ìbuddy
;

2498 i‡(
	`pxt4_mb_add_groupöfo
(
sb
, 
i
, 
desc
) != 0)

2499 
îr_‰ìbuddy
;

2504 
îr_‰ìbuddy
:

2505 
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2506 
i
-- > 0)

2507 
	`kmem_ˇche_‰ì
(
ˇchï
, 
	`pxt4_gë_group_öfo
(
sb
, 
i
));

2508 
i
 = 
sbi
->
s_group_öfo_size
;

2509 
i
-- > 0)

2510 
	`k‰ì
(
sbi
->
s_group_öfo
[
i
]);

2511 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2512 
îr_‰ìsgi
:

2513 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2514  -
ENOMEM
;

2515 
	}
}

2517 
	$pxt4_groupöfo_de°roy_¶abs
()

2519 
i
;

2521 
i
 = 0; i < 
NR_GRPINFO_CACHES
; i++) {

2522 
	`kmem_ˇche_de°roy
(
pxt4_groupöfo_ˇches
[
i
]);

2523 
pxt4_groupöfo_ˇches
[
i
] = 
NULL
;

2525 
	}
}

2527 
	$pxt4_groupöfo_¸óã_¶ab
(
size_t
 
size
)

2529 
	`DEFINE_MUTEX
(
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2530 
¶ab_size
;

2531 
blocksize_bôs
 = 
	`‹dî_ba£_2
(
size
);

2532 
ˇche_ödex
 = 
blocksize_bôs
 - 
PXT4_MIN_BLOCK_LOG_SIZE
;

2533 
kmem_ˇche
 *
ˇchï
;

2535 i‡(
ˇche_ödex
 >
NR_GRPINFO_CACHES
)

2536  -
EINVAL
;

2538 i‡(
	`u∆ikñy
(
ˇche_ödex
 < 0))

2539 
ˇche_ödex
 = 0;

2541 
	`muãx_lock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2542 i‡(
pxt4_groupöfo_ˇches
[
ˇche_ödex
]) {

2543 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2547 
¶ab_size
 = 
	`off£tof
(
pxt4_group_öfo
,

2548 
bb_cou¡îs
[
blocksize_bôs
 + 2]);

2550 
ˇchï
 = 
	`kmem_ˇche_¸óã
(
pxt4_groupöfo_¶ab_«mes
[
ˇche_ödex
],

2551 
¶ab_size
, 0, 
SLAB_RECLAIM_ACCOUNT
,

2552 
NULL
);

2554 
pxt4_groupöfo_ˇches
[
ˇche_ödex
] = 
ˇchï
;

2556 
	`muãx_u∆ock
(&
pxt4_gΩöfo_¶ab_¸óã_muãx
);

2557 i‡(!
ˇchï
) {

2558 
	`¥ötk
(
KERN_EMERG


2560  -
ENOMEM
;

2564 
	}
}

2566 
	$pxt4_mb_öô
(
su≥r_block
 *
sb
)

2568 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2569 
i
, 
j
;

2570 
off£t
, 
off£t_ö¸
;

2571 
max
;

2572 
ªt
;

2574 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_off£ts
);

2576 
sbi
->
s_mb_off£ts
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2577 i‡(
sbi
->
s_mb_off£ts
 =
NULL
) {

2578 
ªt
 = -
ENOMEM
;

2579 
out
;

2582 
i
 = (
sb
->
s_blocksize_bôs
 + 2Ë* (*
sbi
->
s_mb_maxs
);

2583 
sbi
->
s_mb_maxs
 = 
	`kmÆloc
(
i
, 
GFP_KERNEL
);

2584 i‡(
sbi
->
s_mb_maxs
 =
NULL
) {

2585 
ªt
 = -
ENOMEM
;

2586 
out
;

2589 
ªt
 = 
	`pxt4_groupöfo_¸óã_¶ab
(
sb
->
s_blocksize
);

2590 i‡(
ªt
 < 0)

2591 
out
;

2594 
sbi
->
s_mb_maxs
[0] = 
sb
->
s_blocksize
 << 3;

2595 
sbi
->
s_mb_off£ts
[0] = 0;

2597 
i
 = 1;

2598 
off£t
 = 0;

2599 
off£t_ö¸
 = 1 << (
sb
->
s_blocksize_bôs
 - 1);

2600 
max
 = 
sb
->
s_blocksize
 << 2;

2602 
sbi
->
s_mb_off£ts
[
i
] = 
off£t
;

2603 
sbi
->
s_mb_maxs
[
i
] = 
max
;

2604 
off£t
 +
off£t_ö¸
;

2605 
off£t_ö¸
 = offset_incr >> 1;

2606 
max
 = max >> 1;

2607 
i
++;

2608 } 
i
 <
sb
->
s_blocksize_bôs
 + 1);

2610 
	`•ö_lock_öô
(&
sbi
->
s_md_lock
);

2611 
	`•ö_lock_öô
(&
sbi
->
s_bÆ_lock
);

2612 
sbi
->
s_mb_‰ì_≥ndög
 = 0;

2613 
	`INIT_LIST_HEAD
(&
sbi
->
s_‰ìd_d©a_li°
);

2615 
sbi
->
s_mb_max_to_sˇn
 = 
MB_DEFAULT_MAX_TO_SCAN
;

2616 
sbi
->
s_mb_mö_to_sˇn
 = 
MB_DEFAULT_MIN_TO_SCAN
;

2617 
sbi
->
s_mb_°©s
 = 
MB_DEFAULT_STATS
;

2618 
sbi
->
s_mb_°ªam_ªque°
 = 
MB_DEFAULT_STREAM_THRESHOLD
;

2619 
sbi
->
s_mb_‹dî2_ªqs
 = 
MB_DEFAULT_ORDER2_REQS
;

2632 
sbi
->
s_mb_group_¥óŒoc
 = 
	`max
(
MB_DEFAULT_GROUP_PREALLOC
 >>

2633 
sbi
->
s_˛u°î_bôs
, 32);

2642 i‡(
sbi
->
s_°rùe
 > 1) {

2643 
sbi
->
s_mb_group_¥óŒoc
 = 
	`roundup
(

2644 
sbi
->
s_mb_group_¥óŒoc
, sbi->
s_°rùe
);

2647 
sbi
->
s_loˇlôy_groups
 = 
	`Æloc_≥r˝u
(
pxt4_loˇlôy_group
);

2648 i‡(
sbi
->
s_loˇlôy_groups
 =
NULL
) {

2649 
ªt
 = -
ENOMEM
;

2650 
out
;

2652 
	`f‹_óch_possibÀ_˝u
(
i
) {

2653 
pxt4_loˇlôy_group
 *
lg
;

2654 
lg
 = 
	`≥r_˝u_±r
(
sbi
->
s_loˇlôy_groups
, 
i
);

2655 
	`muãx_öô
(&
lg
->
lg_muãx
);

2656 
j
 = 0; j < 
PREALLOC_TB_SIZE
; j++)

2657 
	`INIT_LIST_HEAD
(&
lg
->
lg_¥óŒoc_li°
[
j
]);

2658 
	`•ö_lock_öô
(&
lg
->
lg_¥óŒoc_lock
);

2662 
ªt
 = 
	`pxt4_mb_öô_backíd
(
sb
);

2663 i‡(
ªt
 != 0)

2664 
out_‰ì_loˇlôy_groups
;

2668 
out_‰ì_loˇlôy_groups
:

2669 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2670 
sbi
->
s_loˇlôy_groups
 = 
NULL
;

2671 
out
:

2672 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2673 
sbi
->
s_mb_off£ts
 = 
NULL
;

2674 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2675 
sbi
->
s_mb_maxs
 = 
NULL
;

2676  
ªt
;

2677 
	}
}

2680 
	$pxt4_mb_˛ónup_∑
(
pxt4_group_öfo
 *
gΩ
)

2682 
pxt4_¥óŒoc_•a˚
 *
∑
;

2683 
li°_hód
 *
cur
, *
tmp
;

2684 
cou¡
 = 0;

2686 
	`li°_f‹_óch_ß„
(
cur
, 
tmp
, &
gΩ
->
bb_¥óŒoc_li°
) {

2687 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

2688 
	`li°_dñ
(&
∑
->
∑_group_li°
);

2689 
cou¡
++;

2690 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

2692 i‡(
cou¡
)

2693 
	`mb_debug
(1, "mbÆloc: %u PA†À·\n", 
cou¡
);

2695 
	}
}

2697 
	$pxt4_mb_ªÀa£
(
su≥r_block
 *
sb
)

2699 
pxt4_group_t
 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

2700 
pxt4_group_t
 
i
;

2701 
num_mëa_group_öfos
;

2702 
pxt4_group_öfo
 *
gröfo
;

2703 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2704 
kmem_ˇche
 *
ˇchï
 = 
	`gë_groupöfo_ˇche
(
sb
->
s_blocksize_bôs
);

2706 i‡(
sbi
->
s_group_öfo
) {

2707 
i
 = 0; i < 
ngroups
; i++) {

2708 
gröfo
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

2709 #ifde‡
DOUBLE_CHECK


2710 
	`k‰ì
(
gröfo
->
bb_bôm≠
);

2712 
	`pxt4_lock_group
(
sb
, 
i
);

2713 
	`pxt4_mb_˛ónup_∑
(
gröfo
);

2714 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2715 
	`kmem_ˇche_‰ì
(
ˇchï
, 
gröfo
);

2717 
num_mëa_group_öfos
 = (
ngroups
 +

2718 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) >>

2719 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

2720 
i
 = 0; i < 
num_mëa_group_öfos
; i++)

2721 
	`k‰ì
(
sbi
->
s_group_öfo
[
i
]);

2722 
	`kv‰ì
(
sbi
->
s_group_öfo
);

2724 
	`k‰ì
(
sbi
->
s_mb_off£ts
);

2725 
	`k‰ì
(
sbi
->
s_mb_maxs
);

2726 
	`ùut
(
sbi
->
s_buddy_ˇche
);

2727 i‡(
sbi
->
s_mb_°©s
) {

2728 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2730 
	`©omic_ªad
(&
sbi
->
s_bÆ_Æloˇãd
),

2731 
	`©omic_ªad
(&
sbi
->
s_bÆ_ªqs
),

2732 
	`©omic_ªad
(&
sbi
->
s_bÆ_suc˚ss
));

2733 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2736 
	`©omic_ªad
(&
sbi
->
s_bÆ_ex_sˇ¬ed
),

2737 
	`©omic_ªad
(&
sbi
->
s_bÆ_gﬂls
),

2738 
	`©omic_ªad
(&
sbi
->
s_bÆ_2‹dîs
),

2739 
	`©omic_ªad
(&
sbi
->
s_bÆ_bªaks
),

2740 
	`©omic_ªad
(&
sbi
->
s_mb_lo°_chunks
));

2741 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2743 
sbi
->
s_mb_buddõs_gíî©ed
,

2744 
sbi
->
s_mb_gíî©i⁄_time
);

2745 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2747 
	`©omic_ªad
(&
sbi
->
s_mb_¥óŒoˇãd
),

2748 
	`©omic_ªad
(&
sbi
->
s_mb_disˇrded
));

2751 
	`‰ì_≥r˝u
(
sbi
->
s_loˇlôy_groups
);

2754 
	}
}

2756 
ölöe
 
	$pxt4_issue_disˇrd
(
su≥r_block
 *
sb
,

2757 
pxt4_group_t
 
block_group
, 
pxt4_gΩblk_t
 
˛u°î
, 
cou¡
,

2758 
bio
 **
bi›
)

2760 
pxt4_fsblk_t
 
disˇrd_block
;

2762 
disˇrd_block
 = (
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
˛u°î
) +

2763 
	`pxt4_group_fú°_block_no
(
sb
, 
block_group
));

2764 
cou¡
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), count);

2765 
	`åa˚_pxt4_disˇrd_blocks
(
sb
,

2766 (Ë
disˇrd_block
, 
cou¡
);

2767 i‡(
bi›
) {

2768  
	`__blkdev_issue_disˇrd
(
sb
->
s_bdev
,

2769 (
£˘‹_t
)
disˇrd_block
 << (
sb
->
s_blocksize_bôs
 - 9),

2770 (
£˘‹_t
)
cou¡
 << (
sb
->
s_blocksize_bôs
 - 9),

2771 
GFP_NOFS
, 0, 
bi›
);

2773  
	`sb_issue_disˇrd
(
sb
, 
disˇrd_block
, 
cou¡
, 
GFP_NOFS
, 0);

2774 
	}
}

2776 
	$pxt4_‰ì_d©a_ö_buddy
(
su≥r_block
 *
sb
,

2777 
pxt4_‰ì_d©a
 *
íåy
)

2779 
pxt4_buddy
 
e4b
;

2780 
pxt4_group_öfo
 *
db
;

2781 
îr
, 
cou¡
 = 0, 
cou¡2
 = 0;

2783 
	`mb_debug
(1, "gonna free %u blocks in group %u (0x%p):",

2784 
íåy
->
efd_cou¡
,É¡ry->
efd_group
,Éntry);

2786 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
íåy
->
efd_group
, &
e4b
);

2788 
	`BUG_ON
(
îr
 != 0);

2790 
	`•ö_lock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2791 
	`PXT4_SB
(
sb
)->
s_mb_‰ì_≥ndög
 -
íåy
->
efd_cou¡
;

2792 
	`•ö_u∆ock
(&
	`PXT4_SB
(
sb
)->
s_md_lock
);

2794 
db
 = 
e4b
.
bd_öfo
;

2796 
cou¡
 +
íåy
->
efd_cou¡
;

2797 
cou¡2
++;

2798 
	`pxt4_lock_group
(
sb
, 
íåy
->
efd_group
);

2800 
	`rb_îa£
(&
íåy
->
efd_node
, &(
db
->
bb_‰ì_roŸ
));

2801 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

2809 i‡(!
	`ã°_›t
(
sb
, 
DISCARD
))

2810 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
db
);

2812 i‡(!
db
->
bb_‰ì_roŸ
.
rb_node
) {

2816 
	`put_∑ge
(
e4b
.
bd_buddy_∑ge
);

2817 
	`put_∑ge
(
e4b
.
bd_bôm≠_∑ge
);

2819 
	`pxt4_u∆ock_group
(
sb
, 
íåy
->
efd_group
);

2820 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

2821 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

2823 
	`mb_debug
(1, "‰ìd %u block†ö %u såu˘uªs\n", 
cou¡
, 
cou¡2
);

2824 
	}
}

2830 
	$pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
)

2832 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2833 
pxt4_‰ì_d©a
 *
íåy
, *
tmp
;

2834 
bio
 *
disˇrd_bio
 = 
NULL
;

2835 
li°_hód
 
‰ìd_d©a_li°
;

2836 
li°_hód
 *
cut_pos
 = 
NULL
;

2837 
îr
;

2839 
	`INIT_LIST_HEAD
(&
‰ìd_d©a_li°
);

2841 
	`•ö_lock
(&
sbi
->
s_md_lock
);

2842 
	`li°_f‹_óch_íåy
(
íåy
, &
sbi
->
s_‰ìd_d©a_li°
, 
efd_li°
) {

2843 i‡(
íåy
->
efd_tid
 !
commô_tid
)

2845 
cut_pos
 = &
íåy
->
efd_li°
;

2847 i‡(
cut_pos
)

2848 
	`li°_cut_posôi⁄
(&
‰ìd_d©a_li°
, &
sbi
->
s_‰ìd_d©a_li°
,

2849 
cut_pos
);

2850 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

2852 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

2853 
	`li°_f‹_óch_íåy
(
íåy
, &
‰ìd_d©a_li°
, 
efd_li°
) {

2854 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
íåy
->
efd_group
,

2855 
íåy
->
efd_°¨t_˛u°î
,

2856 
íåy
->
efd_cou¡
,

2857 &
disˇrd_bio
);

2858 i‡(
îr
 &&Éº !-
EOPNOTSUPP
) {

2859 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

2861 " wôh %d", 
íåy
->
efd_group
,

2862 
íåy
->
efd_°¨t_˛u°î
,

2863 
íåy
->
efd_cou¡
, 
îr
);

2864 } i‡(
îr
 =-
EOPNOTSUPP
)

2868 i‡(
disˇrd_bio
) {

2869 
	`submô_bio_waô
(
disˇrd_bio
);

2870 
	`bio_put
(
disˇrd_bio
);

2874 
	`li°_f‹_óch_íåy_ß„
(
íåy
, 
tmp
, &
‰ìd_d©a_li°
, 
efd_li°
)

2875 
	`pxt4_‰ì_d©a_ö_buddy
(
sb
, 
íåy
);

2876 
	}
}

2878 
__öô
 
	$pxt4_öô_mbÆloc
()

2880 
pxt4_p•a˚_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_¥óŒoc_•a˚
,

2881 
SLAB_RECLAIM_ACCOUNT
);

2882 i‡(
pxt4_p•a˚_ˇchï
 =
NULL
)

2883  -
ENOMEM
;

2885 
pxt4_ac_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_Æloˇti⁄_c⁄ãxt
,

2886 
SLAB_RECLAIM_ACCOUNT
);

2887 i‡(
pxt4_ac_ˇchï
 =
NULL
) {

2888 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2889  -
ENOMEM
;

2892 
pxt4_‰ì_d©a_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_‰ì_d©a
,

2893 
SLAB_RECLAIM_ACCOUNT
);

2894 i‡(
pxt4_‰ì_d©a_ˇchï
 =
NULL
) {

2895 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2896 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2897  -
ENOMEM
;

2900 
	}
}

2902 
	$pxt4_exô_mbÆloc
()

2908 
	`rcu_b¨rõr
();

2909 
	`kmem_ˇche_de°roy
(
pxt4_p•a˚_ˇchï
);

2910 
	`kmem_ˇche_de°roy
(
pxt4_ac_ˇchï
);

2911 
	`kmem_ˇche_de°roy
(
pxt4_‰ì_d©a_ˇchï
);

2912 
	`pxt4_groupöfo_de°roy_¶abs
();

2913 
	}
}

2920 
noölöe_f‹_°ack
 

2921 
	$pxt4_mb_m¨k_disk•a˚_u£d
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

2922 
h™dÀ_t
 *
h™dÀ
, 
ª£rv_˛°rs
)

2924 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

2925 
pxt4_group_desc
 *
gdp
;

2926 
buf„r_hód
 *
gdp_bh
;

2927 
pxt4_sb_öfo
 *
sbi
;

2928 
su≥r_block
 *
sb
;

2929 
pxt4_fsblk_t
 
block
;

2930 
îr
, 
Àn
;

2932 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

2933 
	`BUG_ON
(
ac
->
ac_b_ex
.
„_Àn
 <= 0);

2935 
sb
 = 
ac
->
ac_sb
;

2936 
sbi
 = 
	`PXT4_SB
(
sb
);

2938 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2939 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

2940 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

2941 
bôm≠_bh
 = 
NULL
;

2942 
out_îr
;

2945 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

2946 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

2947 i‡(
îr
)

2948 
out_îr
;

2950 
îr
 = -
EIO
;

2951 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
ac
->
ac_b_ex
.
„_group
, &
gdp_bh
);

2952 i‡(!
gdp
)

2953 
out_îr
;

2955 
	`pxt4_debug
("usög block grou∞%u(%d)\n", 
ac
->
ac_b_ex
.
„_group
,

2956 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
));

2958 
	`BUFFER_TRACE
(
gdp_bh
, "get_write_access");

2959 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdp_bh
);

2960 i‡(
îr
)

2961 
out_îr
;

2963 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

2965 
Àn
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

2966 i‡(!
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
Àn
)) {

2967 
	`pxt4_îr‹
(
sb
, "Allocating blocks %llu-%llu which overlap "

2968 "f†mëad©a", 
block
, block+
Àn
);

2973 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2974 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2975 
ac
->
ac_b_ex
.
„_Àn
);

2976 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2977 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

2978 i‡(!
îr
)

2979 
îr
 = -
EFSCORRUPTED
;

2980 
out_îr
;

2983 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

2984 #ifde‡
AGGRESSIVE_CHECK


2986 
i
;

2987 
i
 = 0; i < 
ac
->
ac_b_ex
.
„_Àn
; i++) {

2988 
	`BUG_ON
(
	`mb_ã°_bô
(
ac
->
ac_b_ex
.
„_°¨t
 + 
i
,

2989 
bôm≠_bh
->
b_d©a
));

2993 
	`pxt4_£t_bôs
(
bôm≠_bh
->
b_d©a
, 
ac
->
ac_b_ex
.
„_°¨t
,

2994 
ac
->
ac_b_ex
.
„_Àn
);

2995 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2996 (
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_BLOCK_UNINIT
))) {

2997 
gdp
->
bg_Êags
 &
	`˝u_to_À16
(~
PXT4_BG_BLOCK_UNINIT
);

2998 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

2999 
	`pxt4_‰ì_˛u°îs_a·î_öô
(
sb
,

3000 
ac
->
ac_b_ex
.
„_group
, 
gdp
));

3002 
Àn
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë- 
ac
->
ac_b_ex
.
„_Àn
;

3003 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
Àn
);

3004 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
, 
bôm≠_bh
);

3005 
	`pxt4_group_desc_csum_£t
(
sb
, 
ac
->
ac_b_ex
.
„_group
, 
gdp
);

3007 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3008 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
ac
->
ac_b_ex
.
„_Àn
);

3012 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_DELALLOC_RESERVED
))

3014 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

3015 
ª£rv_˛°rs
);

3017 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

3018 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
,

3019 
ac
->
ac_b_ex
.
„_group
);

3020 
	`©omic64_sub
(
ac
->
ac_b_ex
.
„_Àn
,

3021 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

3024 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

3025 i‡(
îr
)

3026 
out_îr
;

3027 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdp_bh
);

3029 
out_îr
:

3030 
	`bªl£
(
bôm≠_bh
);

3031  
îr
;

3032 
	}
}

3043 
	$pxt4_mb_n‹mÆize_group_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3045 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3046 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

3048 
	`BUG_ON
(
lg
 =
NULL
);

3049 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_SB
(
sb
)->
s_mb_group_¥óŒoc
;

3050 
	`mb_debug
(1, "#%u: goal %u blocks forÜocality group\n",

3051 
cuºít
->
pid
, 
ac
->
ac_g_ex
.
„_Àn
);

3052 
	}
}

3058 
noölöe_f‹_°ack
 

3059 
	$pxt4_mb_n‹mÆize_ªque°
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3060 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

3062 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3063 
bsbôs
, 
max
;

3064 
pxt4_lblk_t
 
íd
;

3065 
loff_t
 
size
, 
°¨t_off
;

3066 
loff_t
 
‹ig_size
 
__maybe_unu£d
;

3067 
pxt4_lblk_t
 
°¨t
;

3068 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3069 
pxt4_¥óŒoc_•a˚
 *
∑
;

3073 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3077 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

3082 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_NOPREALLOC
)

3085 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
) {

3086 
	`pxt4_mb_n‹mÆize_group_ªque°
(
ac
);

3090 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

3094 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

3095 
size
 = sizê<< 
bsbôs
;

3096 i‡(
size
 < 
	`i_size_ªad
(
ac
->
ac_öode
))

3097 
size
 = 
	`i_size_ªad
(
ac
->
ac_öode
);

3098 
‹ig_size
 = 
size
;

3101 
max
 = 2 << 
bsbôs
;

3103 
	#NRL_CHECK_SIZE
(
ªq
, 
size
, 
max
, 
chunk_size
) \

3104 (
ªq
 <(
size
Ë|| 
max
 <(
chunk_size
))

	)

3108 
°¨t_off
 = 0;

3109 i‡(
size
 <= 16 * 1024) {

3110 
size
 = 16 * 1024;

3111 } i‡(
size
 <= 32 * 1024) {

3112 
size
 = 32 * 1024;

3113 } i‡(
size
 <= 64 * 1024) {

3114 
size
 = 64 * 1024;

3115 } i‡(
size
 <= 128 * 1024) {

3116 
size
 = 128 * 1024;

3117 } i‡(
size
 <= 256 * 1024) {

3118 
size
 = 256 * 1024;

3119 } i‡(
size
 <= 512 * 1024) {

3120 
size
 = 512 * 1024;

3121 } i‡(
size
 <= 1024 * 1024) {

3122 
size
 = 1024 * 1024;

3123 } i‡(
	`NRL_CHECK_SIZE
(
size
, 4 * 1024 * 1024, 
max
, 2 * 1024)) {

3124 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3125 (21 - 
bsbôs
)) << 21;

3126 
size
 = 2 * 1024 * 1024;

3127 } i‡(
	`NRL_CHECK_SIZE
(
size
, 8 * 1024 * 1024, 
max
, 4 * 1024)) {

3128 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3129 (22 - 
bsbôs
)) << 22;

3130 
size
 = 4 * 1024 * 1024;

3131 } i‡(
	`NRL_CHECK_SIZE
(
ac
->
ac_o_ex
.
„_Àn
,

3132 (8<<20)>>
bsbôs
, 
max
, 8 * 1024)) {

3133 
°¨t_off
 = ((
loff_t
)
ac
->
ac_o_ex
.
„_logiˇl
 >>

3134 (23 - 
bsbôs
)) << 23;

3135 
size
 = 8 * 1024 * 1024;

3137 
°¨t_off
 = (
loff_t
Ë
ac
->
ac_o_ex
.
„_logiˇl
 << 
bsbôs
;

3138 
size
 = (
loff_t
Ë
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3139 
ac
->
ac_o_ex
.
„_Àn
Ë<< 
bsbôs
;

3141 
size
 = sizê>> 
bsbôs
;

3142 
°¨t
 = 
°¨t_off
 >> 
bsbôs
;

3145 i‡(
¨
->
∂e·
 && 
°¨t
 <¨->
Œe·
) {

3146 
size
 -
¨
->
Œe·
 + 1 - 
°¨t
;

3147 
°¨t
 = 
¨
->
Œe·
 + 1;

3149 i‡(
¨
->
¥ight
 && 
°¨t
 + 
size
 - 1 >¨->
Ãight
)

3150 
size
 -
°¨t
 + sizê- 
¨
->
Ãight
;

3156 i‡(
size
 > 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
))

3157 
size
 = 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
);

3159 
íd
 = 
°¨t
 + 
size
;

3162 
	`rcu_ªad_lock
();

3163 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3164 
pxt4_lblk_t
 
∑_íd
;

3166 i‡(
∑
->
∑_dñëed
)

3168 
	`•ö_lock
(&
∑
->
∑_lock
);

3169 i‡(
∑
->
∑_dñëed
) {

3170 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3174 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3175 
∑
->
∑_Àn
);

3178 
	`BUG_ON
(!(
ac
->
ac_o_ex
.
„_logiˇl
 >
∑_íd
 ||

3179 
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
));

3182 i‡(
∑
->
∑_l°¨t
 >
íd
 || 
∑_íd
 <
°¨t
) {

3183 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3186 
	`BUG_ON
(
∑
->
∑_l°¨t
 <
°¨t
 && 
∑_íd
 >
íd
);

3189 i‡(
∑_íd
 <
ac
->
ac_o_ex
.
„_logiˇl
) {

3190 
	`BUG_ON
(
∑_íd
 < 
°¨t
);

3191 
°¨t
 = 
∑_íd
;

3192 } i‡(
∑
->
∑_l°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3193 
	`BUG_ON
(
∑
->
∑_l°¨t
 > 
íd
);

3194 
íd
 = 
∑
->
∑_l°¨t
;

3196 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3198 
	`rcu_ªad_u∆ock
();

3199 
size
 = 
íd
 - 
°¨t
;

3202 
	`rcu_ªad_lock
();

3203 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3204 
pxt4_lblk_t
 
∑_íd
;

3206 
	`•ö_lock
(&
∑
->
∑_lock
);

3207 i‡(
∑
->
∑_dñëed
 == 0) {

3208 
∑_íd
 = 
∑
->
∑_l°¨t
 + 
	`PXT4_C2B
(
	`PXT4_SB
(
ac
->
ac_sb
),

3209 
∑
->
∑_Àn
);

3210 
	`BUG_ON
(!(
°¨t
 >
∑_íd
 || 
íd
 <
∑
->
∑_l°¨t
));

3212 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3214 
	`rcu_ªad_u∆ock
();

3216 i‡(
°¨t
 + 
size
 <
ac
->
ac_o_ex
.
„_logiˇl
 &&

3217 
°¨t
 > 
ac
->
ac_o_ex
.
„_logiˇl
) {

3218 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
,

3220 (Ë
°¨t
, (Ë
size
,

3221 (Ë
ac
->
ac_o_ex
.
„_logiˇl
);

3222 
	`BUG
();

3224 
	`BUG_ON
(
size
 <0 || sizê> 
	`PXT4_BLOCKS_PER_GROUP
(
ac
->
ac_sb
));

3230 
ac
->
ac_g_ex
.
„_logiˇl
 = 
°¨t
;

3231 
ac
->
ac_g_ex
.
„_Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
size
);

3234 i‡(
¨
->
¥ight
 && (¨->
Ãight
 =(
°¨t
 + 
size
))) {

3236 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
¥ight
 - 
size
,

3237 &
ac
->
ac_f_ex
.
„_group
,

3238 &
ac
->
ac_f_ex
.
„_°¨t
);

3239 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3241 i‡(
¨
->
∂e·
 && (¨->
Œe·
 + 1 =
°¨t
)) {

3243 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
¨
->
∂e·
 + 1,

3244 &
ac
->
ac_f_ex
.
„_group
,

3245 &
ac
->
ac_f_ex
.
„_°¨t
);

3246 
ac
->
ac_Êags
 |
PXT4_MB_HINT_TRY_GOAL
;

3249 
	`mb_debug
(1, "gﬂl: %u(wa†%uËblock†© %u\n", (Ë
size
,

3250 (Ë
‹ig_size
, (Ë
°¨t
);

3251 
	}
}

3253 
	$pxt4_mb_cﬁÀ˘_°©s
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3255 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3257 i‡(
sbi
->
s_mb_°©s
 && 
ac
->
ac_g_ex
.
„_Àn
 > 1) {

3258 
	`©omic_öc
(&
sbi
->
s_bÆ_ªqs
);

3259 
	`©omic_add
(
ac
->
ac_b_ex
.
„_Àn
, &
sbi
->
s_bÆ_Æloˇãd
);

3260 i‡(
ac
->
ac_b_ex
.
„_Àn
 >ac->
ac_o_ex
.fe_len)

3261 
	`©omic_öc
(&
sbi
->
s_bÆ_suc˚ss
);

3262 
	`©omic_add
(
ac
->
ac_found
, &
sbi
->
s_bÆ_ex_sˇ¬ed
);

3263 i‡(
ac
->
ac_g_ex
.
„_°¨t
 =ac->
ac_b_ex
.fe_start &&

3264 
ac
->
ac_g_ex
.
„_group
 =ac->
ac_b_ex
.fe_group)

3265 
	`©omic_öc
(&
sbi
->
s_bÆ_gﬂls
);

3266 i‡(
ac
->
ac_found
 > 
sbi
->
s_mb_max_to_sˇn
)

3267 
	`©omic_öc
(&
sbi
->
s_bÆ_bªaks
);

3270 i‡(
ac
->
ac_›
 =
PXT4_MB_HISTORY_ALLOC
)

3271 
	`åa˚_pxt4_mbÆloc_Æloc
(
ac
);

3273 
	`åa˚_pxt4_mbÆloc_¥óŒoc
(
ac
);

3274 
	}
}

3282 
	$pxt4_disˇrd_Æloˇãd_blocks
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3284 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

3285 
pxt4_buddy
 
e4b
;

3286 
îr
;

3288 i‡(
∑
 =
NULL
) {

3289 i‡(
ac
->
ac_f_ex
.
„_Àn
 == 0)

3291 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
, &
e4b
);

3292 i‡(
îr
) {

3298 
	`WARN
(1, "mb_lﬂd_buddy faûed (%d)", 
îr
);

3301 
	`pxt4_lock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3302 
	`mb_‰ì_blocks
(
ac
->
ac_öode
, &
e4b
,ác->
ac_f_ex
.
„_°¨t
,

3303 
ac
->
ac_f_ex
.
„_Àn
);

3304 
	`pxt4_u∆ock_group
(
ac
->
ac_sb
,ác->
ac_f_ex
.
„_group
);

3305 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3308 i‡(
∑
->
∑_ty≥
 =
MB_INODE_PA
)

3309 
∑
->
∑_‰ì
 +
ac
->
ac_b_ex
.
„_Àn
;

3310 
	}
}

3315 
	$pxt4_mb_u£_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3316 
pxt4_¥óŒoc_•a˚
 *
∑
)

3318 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3319 
pxt4_fsblk_t
 
°¨t
;

3320 
pxt4_fsblk_t
 
íd
;

3321 
Àn
;

3324 
°¨t
 = 
∑
->
∑_p°¨t
 + (
ac
->
ac_o_ex
.
„_logiˇl
 -Öa->
∑_l°¨t
);

3325 
íd
 = 
	`mö
(
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
),

3326 
°¨t
 + 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_o_ex
.
„_Àn
));

3327 
Àn
 = 
	`PXT4_NUM_B2C
(
sbi
, 
íd
 - 
°¨t
);

3328 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
°¨t
, &ac->
ac_b_ex
.
„_group
,

3329 &
ac
->
ac_b_ex
.
„_°¨t
);

3330 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3331 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3332 
ac
->
ac_∑
 = 
∑
;

3334 
	`BUG_ON
(
°¨t
 < 
∑
->
∑_p°¨t
);

3335 
	`BUG_ON
(
íd
 > 
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
));

3336 
	`BUG_ON
(
∑
->
∑_‰ì
 < 
Àn
);

3337 
∑
->
∑_‰ì
 -
Àn
;

3339 
	`mb_debug
(1, "u£ %Œu/%u from inodê∑ %p\n", 
°¨t
, 
Àn
, 
∑
);

3340 
	}
}

3345 
	$pxt4_mb_u£_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3346 
pxt4_¥óŒoc_•a˚
 *
∑
)

3348 
Àn
 = 
ac
->
ac_o_ex
.
„_Àn
;

3350 
	`pxt4_gë_group_no_™d_off£t
(
ac
->
ac_sb
, 
∑
->
∑_p°¨t
,

3351 &
ac
->
ac_b_ex
.
„_group
,

3352 &
ac
->
ac_b_ex
.
„_°¨t
);

3353 
ac
->
ac_b_ex
.
„_Àn
 = 
Àn
;

3354 
ac
->
ac_°©us
 = 
AC_STATUS_FOUND
;

3355 
ac
->
ac_∑
 = 
∑
;

3363 
	`mb_debug
(1, "u£ %u/%u from grou∞∑ %p\n", 
∑
->
∑_l°¨t
-
Àn
,Üen,Öa);

3364 
	}
}

3372 
pxt4_¥óŒoc_•a˚
 *

3373 
	$pxt4_mb_check_group_∑
(
pxt4_fsblk_t
 
gﬂl_block
,

3374 
pxt4_¥óŒoc_•a˚
 *
∑
,

3375 
pxt4_¥óŒoc_•a˚
 *
˝a
)

3377 
pxt4_fsblk_t
 
cur_di°™˚
, 
√w_di°™˚
;

3379 i‡(
˝a
 =
NULL
) {

3380 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3381  
∑
;

3383 
cur_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
˝a
->
∑_p°¨t
);

3384 
√w_di°™˚
 = 
	`abs
(
gﬂl_block
 - 
∑
->
∑_p°¨t
);

3386 i‡(
cur_di°™˚
 <
√w_di°™˚
)

3387  
˝a
;

3390 
	`©omic_dec
(&
˝a
->
∑_cou¡
);

3391 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3392  
∑
;

3393 
	}
}

3398 
noölöe_f‹_°ack
 

3399 
	$pxt4_mb_u£_¥óŒoˇãd
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3401 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

3402 
‹dî
, 
i
;

3403 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3404 
pxt4_loˇlôy_group
 *
lg
;

3405 
pxt4_¥óŒoc_•a˚
 *
∑
, *
˝a
 = 
NULL
;

3406 
pxt4_fsblk_t
 
gﬂl_block
;

3409 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

3413 
	`rcu_ªad_lock
();

3414 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
ei
->
i_¥óŒoc_li°
, 
∑_öode_li°
) {

3418 i‡(
ac
->
ac_o_ex
.
„_logiˇl
 < 
∑
->
∑_l°¨t
 ||

3419 
ac
->
ac_o_ex
.
„_logiˇl
 >(
∑
->
∑_l°¨t
 +

3420 
	`PXT4_C2B
(
sbi
, 
∑
->
∑_Àn
)))

3424 i‡(!(
	`pxt4_ã°_öode_Êag
(
ac
->
ac_öode
, 
PXT4_INODE_EXTENTS
)) &&

3425 (
∑
->
∑_p°¨t
 + 
	`PXT4_C2B
(
sbi
,Öa->
∑_Àn
) >

3426 
PXT4_MAX_BLOCK_FILE_PHYS
))

3430 
	`•ö_lock
(&
∑
->
∑_lock
);

3431 i‡(
∑
->
∑_dñëed
 =0 &&Öa->
∑_‰ì
) {

3432 
	`©omic_öc
(&
∑
->
∑_cou¡
);

3433 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3434 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3435 
ac
->
ac_¸ôîü
 = 10;

3436 
	`rcu_ªad_u∆ock
();

3439 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3441 
	`rcu_ªad_u∆ock
();

3444 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
))

3448 
lg
 = 
ac
->
ac_lg
;

3449 i‡(
lg
 =
NULL
)

3451 
‹dî
 = 
	`Ês
(
ac
->
ac_o_ex
.
„_Àn
) - 1;

3452 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

3454 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

3456 
gﬂl_block
 = 
	`pxt4_gΩ_offs_to_block
(
ac
->
ac_sb
, &ac->
ac_g_ex
);

3461 
i
 = 
‹dî
; i < 
PREALLOC_TB_SIZE
; i++) {

3462 
	`rcu_ªad_lock
();

3463 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
i
],

3464 
∑_öode_li°
) {

3465 
	`•ö_lock
(&
∑
->
∑_lock
);

3466 i‡(
∑
->
∑_dñëed
 == 0 &&

3467 
∑
->
∑_‰ì
 >
ac
->
ac_o_ex
.
„_Àn
) {

3469 
˝a
 = 
	`pxt4_mb_check_group_∑
(
gﬂl_block
,

3470 
∑
, 
˝a
);

3472 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3474 
	`rcu_ªad_u∆ock
();

3476 i‡(
˝a
) {

3477 
	`pxt4_mb_u£_group_∑
(
ac
, 
˝a
);

3478 
ac
->
ac_¸ôîü
 = 20;

3482 
	}
}

3490 
	$pxt4_mb_gíî©e_‰om_‰ìli°
(
su≥r_block
 *
sb
, *
bôm≠
,

3491 
pxt4_group_t
 
group
)

3493 
rb_node
 *
n
;

3494 
pxt4_group_öfo
 *
gΩ
;

3495 
pxt4_‰ì_d©a
 *
íåy
;

3497 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3498 
n
 = 
	`rb_fú°
(&(
gΩ
->
bb_‰ì_roŸ
));

3500 
n
) {

3501 
íåy
 = 
	`rb_íåy
(
n
, 
pxt4_‰ì_d©a
, 
efd_node
);

3502 
	`pxt4_£t_bôs
(
bôm≠
, 
íåy
->
efd_°¨t_˛u°î
,É¡ry->
efd_cou¡
);

3503 
n
 = 
	`rb_√xt
(n);

3506 
	}
}

3513 
noölöe_f‹_°ack


3514 
	$pxt4_mb_gíî©e_‰om_∑
(
su≥r_block
 *
sb
, *
bôm≠
,

3515 
pxt4_group_t
 
group
)

3517 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3518 
pxt4_¥óŒoc_•a˚
 *
∑
;

3519 
li°_hód
 *
cur
;

3520 
pxt4_group_t
 
grou≤r
;

3521 
pxt4_gΩblk_t
 
°¨t
;

3522 
¥óŒoˇãd
 = 0;

3523 
Àn
;

3533 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

3534 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
, 
∑_group_li°
);

3535 
	`•ö_lock
(&
∑
->
∑_lock
);

3536 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

3537 &
grou≤r
, &
°¨t
);

3538 
Àn
 = 
∑
->
∑_Àn
;

3539 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3540 i‡(
	`u∆ikñy
(
Àn
 == 0))

3542 
	`BUG_ON
(
grou≤r
 !
group
);

3543 
	`pxt4_£t_bôs
(
bôm≠
, 
°¨t
, 
Àn
);

3544 
¥óŒoˇãd
 +
Àn
;

3546 
	`mb_debug
(1, "¥óŒoˇãd %u f‹ grou∞%u\n", 
¥óŒoˇãd
, 
group
);

3547 
	}
}

3549 
	$pxt4_mb_∑_ˇŒback
(
rcu_hód
 *
hód
)

3551 
pxt4_¥óŒoc_•a˚
 *
∑
;

3552 
∑
 = 
	`c⁄èöî_of
(
hód
, 
pxt4_¥óŒoc_•a˚
, 
u
.
∑_rcu
);

3554 
	`BUG_ON
(
	`©omic_ªad
(&
∑
->
∑_cou¡
));

3555 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3556 
	`kmem_ˇche_‰ì
(
pxt4_p•a˚_ˇchï
, 
∑
);

3557 
	}
}

3563 
	$pxt4_mb_put_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

3564 
su≥r_block
 *
sb
, 
pxt4_¥óŒoc_•a˚
 *
∑
)

3566 
pxt4_group_t
 
gΩ
;

3567 
pxt4_fsblk_t
 
gΩ_blk
;

3570 
	`•ö_lock
(&
∑
->
∑_lock
);

3571 i‡(!
	`©omic_dec_™d_ã°
(&
∑
->
∑_cou¡
Ë||Öa->
∑_‰ì
 != 0) {

3572 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3576 i‡(
∑
->
∑_dñëed
 == 1) {

3577 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3581 
∑
->
∑_dñëed
 = 1;

3582 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3584 
gΩ_blk
 = 
∑
->
∑_p°¨t
;

3589 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3590 
gΩ_blk
--;

3592 
gΩ
 = 
	`pxt4_gë_group_numbî
(
sb
, 
gΩ_blk
);

3608 
	`pxt4_lock_group
(
sb
, 
gΩ
);

3609 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3610 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

3612 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3613 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3614 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3616 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3617 
	}
}

3622 
noölöe_f‹_°ack
 

3623 
	$pxt4_mb_√w_öode_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3625 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3626 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3627 
pxt4_¥óŒoc_•a˚
 *
∑
;

3628 
pxt4_group_öfo
 *
gΩ
;

3629 
pxt4_öode_öfo
 *
ei
;

3632 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3633 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3634 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3636 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3637 i‡(
∑
 =
NULL
)

3638  -
ENOMEM
;

3640 i‡(
ac
->
ac_b_ex
.
„_Àn
 <ác->
ac_g_ex
.fe_len) {

3641 
wöl
;

3642 
wös
;

3643 
wö
;

3644 
offs
;

3649 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_logiˇl
 >ác->
ac_o_ex
.fe_logical);

3650 
	`BUG_ON
(
ac
->
ac_g_ex
.
„_Àn
 <ác->
ac_o_ex
.fe_len);

3655 
wöl
 = 
ac
->
ac_o_ex
.
„_logiˇl
 -ác->
ac_g_ex
.fe_logical;

3658 
wös
 = 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
 -ác->
ac_o_ex
.fe_len);

3661 
wö
 = 
	`mö
(
wöl
, 
wös
);

3663 
offs
 = 
ac
->
ac_o_ex
.
„_logiˇl
 %

3664 
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

3665 i‡(
offs
 && off†< 
wö
)

3666 
wö
 = 
offs
;

3668 
ac
->
ac_b_ex
.
„_logiˇl
 =ác->
ac_o_ex
.fe_logical -

3669 
	`PXT4_NUM_B2C
(
sbi
, 
wö
);

3670 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_logiˇl
 <ác->
ac_b_ex
.fe_logical);

3671 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ác->
ac_b_ex
.fe_len);

3676 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3678 
∑
->
∑_l°¨t
 = 
ac
->
ac_b_ex
.
„_logiˇl
;

3679 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3680 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3681 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3682 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3683 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3684 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3685 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3686 
∑
->
∑_dñëed
 = 0;

3687 
∑
->
∑_ty≥
 = 
MB_INODE_PA
;

3689 
	`mb_debug
(1, "√w inodê∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3690 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3691 
	`åa˚_pxt4_mb_√w_öode_∑
(
ac
, 
∑
);

3693 
	`pxt4_mb_u£_öode_∑
(
ac
, 
∑
);

3694 
	`©omic_add
(
∑
->
∑_‰ì
, &
sbi
->
s_mb_¥óŒoˇãd
);

3696 
ei
 = 
	`PXT4_I
(
ac
->
ac_öode
);

3697 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3699 
∑
->
∑_obj_lock
 = &
ei
->
i_¥óŒoc_lock
;

3700 
∑
->
∑_öode
 = 
ac
->
ac_öode
;

3702 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3703 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3704 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3706 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3707 
	`li°_add_rcu
(&
∑
->
∑_öode_li°
, &
ei
->
i_¥óŒoc_li°
);

3708 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3711 
	}
}

3716 
noölöe_f‹_°ack
 

3717 
	$pxt4_mb_√w_group_∑
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3719 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

3720 
pxt4_loˇlôy_group
 *
lg
;

3721 
pxt4_¥óŒoc_•a˚
 *
∑
;

3722 
pxt4_group_öfo
 *
gΩ
;

3725 
	`BUG_ON
(
ac
->
ac_o_ex
.
„_Àn
 >ac->
ac_b_ex
.fe_len);

3726 
	`BUG_ON
(
ac
->
ac_°©us
 !
AC_STATUS_FOUND
);

3727 
	`BUG_ON
(!
	`S_ISREG
(
ac
->
ac_öode
->
i_mode
));

3729 
	`BUG_ON
(
pxt4_p•a˚_ˇchï
 =
NULL
);

3730 
∑
 = 
	`kmem_ˇche_Æloc
(
pxt4_p•a˚_ˇchï
, 
GFP_NOFS
);

3731 i‡(
∑
 =
NULL
)

3732  -
ENOMEM
;

3736 
ac
->
ac_f_ex
 =ác->
ac_b_ex
;

3738 
∑
->
∑_p°¨t
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

3739 
∑
->
∑_l°¨t
 =Öa->
∑_p°¨t
;

3740 
∑
->
∑_Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

3741 
∑
->
∑_‰ì
 =Öa->
∑_Àn
;

3742 
	`©omic_£t
(&
∑
->
∑_cou¡
, 1);

3743 
	`•ö_lock_öô
(&
∑
->
∑_lock
);

3744 
	`INIT_LIST_HEAD
(&
∑
->
∑_öode_li°
);

3745 
	`INIT_LIST_HEAD
(&
∑
->
∑_group_li°
);

3746 
∑
->
∑_dñëed
 = 0;

3747 
∑
->
∑_ty≥
 = 
MB_GROUP_PA
;

3749 
	`mb_debug
(1, "√w grou∞∑ %p: %Œu/%u f‹ %u\n", 
∑
,

3750 
∑
->
∑_p°¨t
,Öa->
∑_Àn
,Öa->
∑_l°¨t
);

3751 
	`åa˚_pxt4_mb_√w_group_∑
(
ac
, 
∑
);

3753 
	`pxt4_mb_u£_group_∑
(
ac
, 
∑
);

3754 
	`©omic_add
(
∑
->
∑_‰ì
, &
	`PXT4_SB
(
sb
)->
s_mb_¥óŒoˇãd
);

3756 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3757 
lg
 = 
ac
->
ac_lg
;

3758 
	`BUG_ON
(
lg
 =
NULL
);

3760 
∑
->
∑_obj_lock
 = &
lg
->
lg_¥óŒoc_lock
;

3761 
∑
->
∑_öode
 = 
NULL
;

3763 
	`pxt4_lock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3764 
	`li°_add
(&
∑
->
∑_group_li°
, &
gΩ
->
bb_¥óŒoc_li°
);

3765 
	`pxt4_u∆ock_group
(
sb
, 
ac
->
ac_b_ex
.
„_group
);

3772 
	}
}

3774 
	$pxt4_mb_√w_¥óŒoˇti⁄
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

3776 
îr
;

3778 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

3779 
îr
 = 
	`pxt4_mb_√w_group_∑
(
ac
);

3781 
îr
 = 
	`pxt4_mb_√w_öode_∑
(
ac
);

3782  
îr
;

3783 
	}
}

3793 
noölöe_f‹_°ack
 

3794 
	$pxt4_mb_ªÀa£_öode_∑
(
pxt4_buddy
 *
e4b
, 
buf„r_hód
 *
bôm≠_bh
,

3795 
pxt4_¥óŒoc_•a˚
 *
∑
)

3797 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3798 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3799 
íd
;

3800 
√xt
;

3801 
pxt4_group_t
 
group
;

3802 
pxt4_gΩblk_t
 
bô
;

3803 
gΩ_blk_°¨t
;

3804 
‰ì
 = 0;

3806 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3807 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3808 
gΩ_blk_°¨t
 = 
∑
->
∑_p°¨t
 - 
	`PXT4_C2B
(
sbi
, 
bô
);

3809 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3810 
íd
 = 
bô
 + 
∑
->
∑_Àn
;

3812 
bô
 < 
íd
) {

3813 
bô
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, bit);

3814 i‡(
bô
 >
íd
)

3816 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠_bh
->
b_d©a
, 
íd
, 
bô
);

3817 
	`mb_debug
(1, " freeÖreallocated %u/%u in group %u\n",

3818 (Ë
	`pxt4_group_fú°_block_no
(
sb
, 
group
Ë+ 
bô
,

3819 (Ë
√xt
 - 
bô
, (Ë
group
);

3820 
‰ì
 +
√xt
 - 
bô
;

3822 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
√xt
 - bit);

3823 
	`åa˚_pxt4_mb_ªÀa£_öode_∑
(
∑
, (
gΩ_blk_°¨t
 +

3824 
	`PXT4_C2B
(
sbi
, 
bô
)),

3825 
√xt
 - 
bô
);

3826 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
, 
√xt
 - bit);

3827 
bô
 = 
√xt
 + 1;

3829 i‡(
‰ì
 !
∑
->
∑_‰ì
) {

3830 
	`pxt4_msg
(
e4b
->
bd_sb
, 
KERN_CRIT
,

3832 
∑
, (Ë∑->
∑_l°¨t
,

3833 (Ë
∑
->
∑_p°¨t
,

3834 (Ë
∑
->
∑_Àn
);

3835 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0, 0, "free %u,Öa_free %u",

3836 
‰ì
, 
∑
->
∑_‰ì
);

3842 
	`©omic_add
(
‰ì
, &
sbi
->
s_mb_disˇrded
);

3845 
	}
}

3847 
noölöe_f‹_°ack
 

3848 
	$pxt4_mb_ªÀa£_group_∑
(
pxt4_buddy
 *
e4b
,

3849 
pxt4_¥óŒoc_•a˚
 *
∑
)

3851 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

3852 
pxt4_group_t
 
group
;

3853 
pxt4_gΩblk_t
 
bô
;

3855 
	`åa˚_pxt4_mb_ªÀa£_group_∑
(
sb
, 
∑
);

3856 
	`BUG_ON
(
∑
->
∑_dñëed
 == 0);

3857 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
, &
group
, &
bô
);

3858 
	`BUG_ON
(
group
 !
e4b
->
bd_group
 && 
∑
->
∑_Àn
 != 0);

3859 
	`mb_‰ì_blocks
(
∑
->
∑_öode
, 
e4b
, 
bô
,Öa->
∑_Àn
);

3860 
	`©omic_add
(
∑
->
∑_Àn
, &
	`PXT4_SB
(
sb
)->
s_mb_disˇrded
);

3861 
	`åa˚_pxt4_mbÆloc_disˇrd
(
sb
, 
NULL
, 
group
, 
bô
, 
∑
->
∑_Àn
);

3864 
	}
}

3875 
noölöe_f‹_°ack
 

3876 
	$pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

3877 
pxt4_group_t
 
group
, 
√eded
)

3879 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

3880 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3881 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3882 
li°_hód
 
li°
;

3883 
pxt4_buddy
 
e4b
;

3884 
îr
;

3885 
busy
 = 0;

3886 
‰ì
 = 0;

3888 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ grou∞%u\n", 
group
);

3890 i‡(
	`li°_em±y
(&
gΩ
->
bb_¥óŒoc_li°
))

3893 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

3894 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

3895 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

3896 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

3897 
îr
, 
group
);

3901 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

3902 i‡(
îr
) {

3903 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

3904 
îr
, 
group
);

3905 
	`put_bh
(
bôm≠_bh
);

3909 i‡(
√eded
 == 0)

3910 
√eded
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) + 1;

3912 
	`INIT_LIST_HEAD
(&
li°
);

3913 
ª≥©
:

3914 
	`pxt4_lock_group
(
sb
, 
group
);

3915 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
,

3916 &
gΩ
->
bb_¥óŒoc_li°
, 
∑_group_li°
) {

3917 
	`•ö_lock
(&
∑
->
∑_lock
);

3918 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

3919 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3920 
busy
 = 1;

3923 i‡(
∑
->
∑_dñëed
) {

3924 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3929 
∑
->
∑_dñëed
 = 1;

3932 
‰ì
 +
∑
->
∑_‰ì
;

3934 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

3936 
	`li°_dñ
(&
∑
->
∑_group_li°
);

3937 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

3941 i‡(
‰ì
 < 
√eded
 && 
busy
) {

3942 
busy
 = 0;

3943 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3944 
	`c⁄d_ªsched
();

3945 
ª≥©
;

3949 i‡(
	`li°_em±y
(&
li°
)) {

3950 
	`BUG_ON
(
‰ì
 != 0);

3951 
out
;

3955 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

3958 
	`•ö_lock
(
∑
->
∑_obj_lock
);

3959 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

3960 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

3962 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
)

3963 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

3965 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

3967 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

3968 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

3971 
out
:

3972 
	`pxt4_u∆ock_group
(
sb
, 
group
);

3973 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

3974 
	`put_bh
(
bôm≠_bh
);

3975  
‰ì
;

3976 
	}
}

3987 
	$pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *inode)

3989 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

3990 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

3991 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

3992 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

3993 
pxt4_group_t
 
group
 = 0;

3994 
li°_hód
 
li°
;

3995 
pxt4_buddy
 
e4b
;

3996 
îr
;

3998 i‡(!
	`S_ISREG
(
öode
->
i_mode
)) {

4003 
	`mb_debug
(1, "disˇrdÖªÆloˇti⁄ f‹ inodê%lu\n", 
öode
->
i_öo
);

4004 
	`åa˚_pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

4006 
	`INIT_LIST_HEAD
(&
li°
);

4008 
ª≥©
:

4010 
	`•ö_lock
(&
ei
->
i_¥óŒoc_lock
);

4011 !
	`li°_em±y
(&
ei
->
i_¥óŒoc_li°
)) {

4012 
∑
 = 
	`li°_íåy
(
ei
->
i_¥óŒoc_li°
.
√xt
,

4013 
pxt4_¥óŒoc_•a˚
, 
∑_öode_li°
);

4014 
	`BUG_ON
(
∑
->
∑_obj_lock
 !&
ei
->
i_¥óŒoc_lock
);

4015 
	`•ö_lock
(&
∑
->
∑_lock
);

4016 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4019 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4020 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4021 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4023 
	`WARN_ON
(1);

4024 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4025 
ª≥©
;

4028 i‡(
∑
->
∑_dñëed
 == 0) {

4029 
∑
->
∑_dñëed
 = 1;

4030 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4031 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4032 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
li°
);

4037 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4038 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4052 
	`scheduÀ_timeout_unöãºu±ibÀ
(
HZ
);

4053 
ª≥©
;

4055 
	`•ö_u∆ock
(&
ei
->
i_¥óŒoc_lock
);

4057 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
li°
, 
u
.
∑_tmp_li°
) {

4058 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_INODE_PA
);

4059 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4061 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4062 
GFP_NOFS
|
__GFP_NOFAIL
);

4063 i‡(
îr
) {

4064 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4065 
îr
, 
group
);

4069 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
group
);

4070 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4071 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4072 
	`pxt4_îr‹
(
sb
, "Error %dÑeading block bitmap for %u",

4073 
îr
, 
group
);

4074 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4078 
	`pxt4_lock_group
(
sb
, 
group
);

4079 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4080 
	`pxt4_mb_ªÀa£_öode_∑
(&
e4b
, 
bôm≠_bh
, 
∑
);

4081 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4083 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4084 
	`put_bh
(
bôm≠_bh
);

4086 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4087 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4089 
	}
}

4091 #ifde‡
CONFIG_PXT4_DEBUG


4092 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4094 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4095 
pxt4_group_t
 
ngroups
, 
i
;

4097 i‡(!
pxt4_mbÆloc_debug
 ||

4098 (
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
))

4101 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "Can'tállocate:"

4103 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "status %d flags %d",

4104 
ac
->
ac_°©us
,ác->
ac_Êags
);

4105 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "orig %lu/%lu/%lu@%lu, "

4108 ()
ac
->
ac_o_ex
.
„_group
,

4109 ()
ac
->
ac_o_ex
.
„_°¨t
,

4110 ()
ac
->
ac_o_ex
.
„_Àn
,

4111 ()
ac
->
ac_o_ex
.
„_logiˇl
,

4112 ()
ac
->
ac_g_ex
.
„_group
,

4113 ()
ac
->
ac_g_ex
.
„_°¨t
,

4114 ()
ac
->
ac_g_ex
.
„_Àn
,

4115 ()
ac
->
ac_g_ex
.
„_logiˇl
,

4116 ()
ac
->
ac_b_ex
.
„_group
,

4117 ()
ac
->
ac_b_ex
.
„_°¨t
,

4118 ()
ac
->
ac_b_ex
.
„_Àn
,

4119 ()
ac
->
ac_b_ex
.
„_logiˇl
,

4120 ()
ac
->
ac_¸ôîü
);

4121 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "%d found",ác->
ac_found
);

4122 
	`pxt4_msg
(
ac
->
ac_sb
, 
KERN_ERR
, "groups: ");

4123 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4124 
i
 = 0; i < 
ngroups
; i++) {

4125 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
i
);

4126 
pxt4_¥óŒoc_•a˚
 *
∑
;

4127 
pxt4_gΩblk_t
 
°¨t
;

4128 
li°_hód
 *
cur
;

4129 
	`pxt4_lock_group
(
sb
, 
i
);

4130 
	`li°_f‹_óch
(
cur
, &
gΩ
->
bb_¥óŒoc_li°
) {

4131 
∑
 = 
	`li°_íåy
(
cur
, 
pxt4_¥óŒoc_•a˚
,

4132 
∑_group_li°
);

4133 
	`•ö_lock
(&
∑
->
∑_lock
);

4134 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
∑
->
∑_p°¨t
,

4135 
NULL
, &
°¨t
);

4136 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4137 
	`¥ötk
(
KERN_ERR
 "PA:%u:%d:%u \n", 
i
,

4138 
°¨t
, 
∑
->
∑_Àn
);

4140 
	`pxt4_u∆ock_group
(
sb
, 
i
);

4142 i‡(
gΩ
->
bb_‰ì
 == 0)

4144 
	`¥ötk
(
KERN_ERR
 "%u: %d/%d \n",

4145 
i
, 
gΩ
->
bb_‰ì
, gΩ->
bb_‰agmíts
);

4147 
	`¥ötk
(
KERN_ERR
 "\n");

4148 
	}
}

4150 
ölöe
 
	$pxt4_mb_show_ac
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4153 
	}
}

4163 
	$pxt4_mb_group_‹_fûe
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4165 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4166 
bsbôs
 = 
ac
->
ac_sb
->
s_blocksize_bôs
;

4167 
loff_t
 
size
, 
isize
;

4169 i‡(!(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_DATA
))

4172 i‡(
	`u∆ikñy
(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GOAL_ONLY
))

4175 
size
 = 
ac
->
ac_o_ex
.
„_logiˇl
 + 
	`PXT4_C2B
(
sbi
,ác->ac_o_ex.
„_Àn
);

4176 
isize
 = (
	`i_size_ªad
(
ac
->
ac_öode
Ë+ác->
ac_sb
->
s_blocksize
 - 1)

4177 >> 
bsbôs
;

4179 i‡((
size
 =
isize
Ë&& !
	`pxt4_fs_is_busy
(
sbi
) &&

4180 !
	`öode_is_›í_f‹_wrôe
(
ac
->
ac_öode
)) {

4181 
ac
->
ac_Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4185 i‡(
sbi
->
s_mb_group_¥óŒoc
 <= 0) {

4186 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4191 
size
 = 
	`max
(size, 
isize
);

4192 i‡(
size
 > 
sbi
->
s_mb_°ªam_ªque°
) {

4193 
ac
->
ac_Êags
 |
PXT4_MB_STREAM_ALLOC
;

4197 
	`BUG_ON
(
ac
->
ac_lg
 !
NULL
);

4203 
ac
->
ac_lg
 = 
	`øw_˝u_±r
(
sbi
->
s_loˇlôy_groups
);

4206 
ac
->
ac_Êags
 |
PXT4_MB_HINT_GROUP_ALLOC
;

4209 
	`muãx_lock
(&
ac
->
ac_lg
->
lg_muãx
);

4210 
	}
}

4212 
noölöe_f‹_°ack
 

4213 
	$pxt4_mb_öôülize_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
,

4214 
pxt4_Æloˇti⁄_ªque°
 *
¨
)

4216 
su≥r_block
 *
sb
 = 
¨
->
öode
->
i_sb
;

4217 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4218 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

4219 
pxt4_group_t
 
group
;

4220 
Àn
;

4221 
pxt4_fsblk_t
 
gﬂl
;

4222 
pxt4_gΩblk_t
 
block
;

4225 
Àn
 = 
¨
->len;

4228 i‡(
Àn
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

4229 
Àn
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

4232 
gﬂl
 = 
¨
->goal;

4233 i‡(
gﬂl
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

4234 
gﬂl
 >
	`pxt4_blocks_cou¡
(
es
))

4235 
gﬂl
 = 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

4236 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
gﬂl
, &
group
, &
block
);

4239 
ac
->
ac_b_ex
.
„_logiˇl
 = 
	`PXT4_LBLK_CMASK
(
sbi
, 
¨
->
logiˇl
);

4240 
ac
->
ac_°©us
 = 
AC_STATUS_CONTINUE
;

4241 
ac
->
ac_sb
 = 
sb
;

4242 
ac
->
ac_öode
 = 
¨
->
öode
;

4243 
ac
->
ac_o_ex
.
„_logiˇl
 =ác->
ac_b_ex
.fe_logical;

4244 
ac
->
ac_o_ex
.
„_group
 = 
group
;

4245 
ac
->
ac_o_ex
.
„_°¨t
 = 
block
;

4246 
ac
->
ac_o_ex
.
„_Àn
 = 
Àn
;

4247 
ac
->
ac_g_ex
 =ác->
ac_o_ex
;

4248 
ac
->
ac_Êags
 = 
¨
->
Êags
;

4252 
	`pxt4_mb_group_‹_fûe
(
ac
);

4254 
	`mb_debug
(1, "initác: %u blocks @ %u, goal %u, flags %x, 2^%d, "

4256 (Ë
¨
->
Àn
, (Ë¨->
logiˇl
,

4257 (Ë
¨
->
gﬂl
, 
ac
->
ac_Êags
,ác->
ac_2‹dî
,

4258 (Ë
¨
->
Œe·
, (Ë¨->
∂e·
,

4259 (Ë
¨
->
Ãight
, (Ë¨->
¥ight
,

4260 
	`öode_is_›í_f‹_wrôe
(
¨
->
öode
) ? "" : "non-");

4263 
	}
}

4265 
noölöe_f‹_°ack
 

4266 
	$pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
,

4267 
pxt4_loˇlôy_group
 *
lg
,

4268 
‹dî
, 
tŸÆ_íåõs
)

4270 
pxt4_group_t
 
group
 = 0;

4271 
pxt4_buddy
 
e4b
;

4272 
li°_hód
 
disˇrd_li°
;

4273 
pxt4_¥óŒoc_•a˚
 *
∑
, *
tmp
;

4275 
	`mb_debug
(1, "discardÜocality groupÖreallocation\n");

4277 
	`INIT_LIST_HEAD
(&
disˇrd_li°
);

4279 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4280 
	`li°_f‹_óch_íåy_rcu
(
∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4281 
∑_öode_li°
) {

4282 
	`•ö_lock
(&
∑
->
∑_lock
);

4283 i‡(
	`©omic_ªad
(&
∑
->
∑_cou¡
)) {

4289 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4292 i‡(
∑
->
∑_dñëed
) {

4293 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4297 
	`BUG_ON
(
∑
->
∑_ty≥
 !
MB_GROUP_PA
);

4300 
∑
->
∑_dñëed
 = 1;

4301 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4303 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4304 
	`li°_add
(&
∑
->
u
.
∑_tmp_li°
, &
disˇrd_li°
);

4306 
tŸÆ_íåõs
--;

4307 i‡(
tŸÆ_íåõs
 <= 5) {

4317 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4319 
	`li°_f‹_óch_íåy_ß„
(
∑
, 
tmp
, &
disˇrd_li°
, 
u
.
∑_tmp_li°
) {

4320 
îr
;

4322 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
∑
->
∑_p°¨t
);

4323 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
group
, &
e4b
,

4324 
GFP_NOFS
|
__GFP_NOFAIL
);

4325 i‡(
îr
) {

4326 
	`pxt4_îr‹
(
sb
, "Error %dÜoading buddy information for %u",

4327 
îr
, 
group
);

4330 
	`pxt4_lock_group
(
sb
, 
group
);

4331 
	`li°_dñ
(&
∑
->
∑_group_li°
);

4332 
	`pxt4_mb_ªÀa£_group_∑
(&
e4b
, 
∑
);

4333 
	`pxt4_u∆ock_group
(
sb
, 
group
);

4335 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4336 
	`li°_dñ
(&
∑
->
u
.
∑_tmp_li°
);

4337 
	`ˇŒ_rcu
(&(
∑
)->
u
.
∑_rcu
, 
pxt4_mb_∑_ˇŒback
);

4339 
	}
}

4350 
	$pxt4_mb_add_n_åim
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4352 
‹dî
, 
added
 = 0, 
lg_¥óŒoc_cou¡
 = 1;

4353 
su≥r_block
 *
sb
 = 
ac
->
ac_sb
;

4354 
pxt4_loˇlôy_group
 *
lg
 = 
ac
->
ac_lg
;

4355 
pxt4_¥óŒoc_•a˚
 *
tmp_∑
, *
∑
 = 
ac
->
ac_∑
;

4357 
‹dî
 = 
	`Ês
(
∑
->
∑_‰ì
) - 1;

4358 i‡(
‹dî
 > 
PREALLOC_TB_SIZE
 - 1)

4360 
‹dî
 = 
PREALLOC_TB_SIZE
 - 1;

4362 
	`•ö_lock
(&
lg
->
lg_¥óŒoc_lock
);

4363 
	`li°_f‹_óch_íåy_rcu
(
tmp_∑
, &
lg
->
lg_¥óŒoc_li°
[
‹dî
],

4364 
∑_öode_li°
) {

4365 
	`•ö_lock
(&
tmp_∑
->
∑_lock
);

4366 i‡(
tmp_∑
->
∑_dñëed
) {

4367 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4370 i‡(!
added
 && 
∑
->
∑_‰ì
 < 
tmp_∑
->pa_free) {

4372 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4373 &
tmp_∑
->
∑_öode_li°
);

4374 
added
 = 1;

4380 
	`•ö_u∆ock
(&
tmp_∑
->
∑_lock
);

4381 
lg_¥óŒoc_cou¡
++;

4383 i‡(!
added
)

4384 
	`li°_add_èû_rcu
(&
∑
->
∑_öode_li°
,

4385 &
lg
->
lg_¥óŒoc_li°
[
‹dî
]);

4386 
	`•ö_u∆ock
(&
lg
->
lg_¥óŒoc_lock
);

4389 i‡(
lg_¥óŒoc_cou¡
 > 8) {

4390 
	`pxt4_mb_disˇrd_lg_¥óŒoˇti⁄s
(
sb
, 
lg
,

4391 
‹dî
, 
lg_¥óŒoc_cou¡
);

4395 
	}
}

4400 
	$pxt4_mb_ªÀa£_c⁄ãxt
(
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
)

4402 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
ac
->
ac_sb
);

4403 
pxt4_¥óŒoc_•a˚
 *
∑
 = 
ac
->
ac_∑
;

4404 i‡(
∑
) {

4405 i‡(
∑
->
∑_ty≥
 =
MB_GROUP_PA
) {

4407 
	`•ö_lock
(&
∑
->
∑_lock
);

4408 
∑
->
∑_p°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4409 
∑
->
∑_l°¨t
 +
	`PXT4_C2B
(
sbi
, 
ac
->
ac_b_ex
.
„_Àn
);

4410 
∑
->
∑_‰ì
 -
ac
->
ac_b_ex
.
„_Àn
;

4411 
∑
->
∑_Àn
 -
ac
->
ac_b_ex
.
„_Àn
;

4412 
	`•ö_u∆ock
(&
∑
->
∑_lock
);

4415 i‡(
∑
) {

4422 i‡((
∑
->
∑_ty≥
 =
MB_GROUP_PA
Ë&& 
	`likñy
’a->
∑_‰ì
)) {

4423 
	`•ö_lock
(
∑
->
∑_obj_lock
);

4424 
	`li°_dñ_rcu
(&
∑
->
∑_öode_li°
);

4425 
	`•ö_u∆ock
(
∑
->
∑_obj_lock
);

4426 
	`pxt4_mb_add_n_åim
(
ac
);

4428 
	`pxt4_mb_put_∑
(
ac
,ác->
ac_sb
, 
∑
);

4430 i‡(
ac
->
ac_bôm≠_∑ge
)

4431 
	`put_∑ge
(
ac
->
ac_bôm≠_∑ge
);

4432 i‡(
ac
->
ac_buddy_∑ge
)

4433 
	`put_∑ge
(
ac
->
ac_buddy_∑ge
);

4434 i‡(
ac
->
ac_Êags
 & 
PXT4_MB_HINT_GROUP_ALLOC
)

4435 
	`muãx_u∆ock
(&
ac
->
ac_lg
->
lg_muãx
);

4436 
	`pxt4_mb_cﬁÀ˘_°©s
(
ac
);

4438 
	}
}

4440 
	$pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
su≥r_block
 *
sb
, 
√eded
)

4442 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

4443 
ªt
;

4444 
‰ìd
 = 0;

4446 
	`åa˚_pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
√eded
);

4447 
i
 = 0; i < 
ngroups
 && 
√eded
 > 0; i++) {

4448 
ªt
 = 
	`pxt4_mb_disˇrd_group_¥óŒoˇti⁄s
(
sb
, 
i
, 
√eded
);

4449 
‰ìd
 +
ªt
;

4450 
√eded
 -
ªt
;

4453  
‰ìd
;

4454 
	}
}

4461 
pxt4_fsblk_t
 
	$pxt4_mb_√w_blocks
(
h™dÀ_t
 *
h™dÀ
,

4462 
pxt4_Æloˇti⁄_ªque°
 *
¨
, *
îΩ
)

4464 
‰ìd
;

4465 
pxt4_Æloˇti⁄_c⁄ãxt
 *
ac
 = 
NULL
;

4466 
pxt4_sb_öfo
 *
sbi
;

4467 
su≥r_block
 *
sb
;

4468 
pxt4_fsblk_t
 
block
 = 0;

4469 
öquŸa
 = 0;

4470 
ª£rv_˛°rs
 = 0;

4472 
	`might_¶ìp
();

4473 
sb
 = 
¨
->
öode
->
i_sb
;

4474 
sbi
 = 
	`PXT4_SB
(
sb
);

4476 
	`åa˚_pxt4_ªque°_blocks
(
¨
);

4479 i‡(
	`pxt4_is_quŸa_fûe
(
¨
->
öode
))

4480 
¨
->
Êags
 |
PXT4_MB_USE_ROOT_BLOCKS
;

4482 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0) {

4487 
¨
->
Àn
 &&

4488 
	`pxt4_˛aim_‰ì_˛u°îs
(
sbi
, 
¨
->
Àn
,ár->
Êags
)) {

4491 
	`c⁄d_ªsched
();

4492 
¨
->
Àn
 =ár->len >> 1;

4494 i‡(!
¨
->
Àn
) {

4495 *
îΩ
 = -
ENOSPC
;

4498 
ª£rv_˛°rs
 = 
¨
->
Àn
;

4499 i‡(
¨
->
Êags
 & 
PXT4_MB_USE_ROOT_BLOCKS
) {

4500 
	`dquŸ_Æloc_block_noÁû
(
¨
->
öode
,

4501 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
));

4503 
¨
->
Àn
 &&

4504 
	`dquŸ_Æloc_block
(
¨
->
öode
,

4505 
	`PXT4_C2B
(
sbi
, 
¨
->
Àn
))) {

4507 
¨
->
Êags
 |
PXT4_MB_HINT_NOPREALLOC
;

4508 
¨
->
Àn
--;

4511 
öquŸa
 = 
¨
->
Àn
;

4512 i‡(
¨
->
Àn
 == 0) {

4513 *
îΩ
 = -
EDQUOT
;

4514 
out
;

4518 
ac
 = 
	`kmem_ˇche_zÆloc
(
pxt4_ac_ˇchï
, 
GFP_NOFS
);

4519 i‡(!
ac
) {

4520 
¨
->
Àn
 = 0;

4521 *
îΩ
 = -
ENOMEM
;

4522 
out
;

4525 *
îΩ
 = 
	`pxt4_mb_öôülize_c⁄ãxt
(
ac
, 
¨
);

4526 i‡(*
îΩ
) {

4527 
¨
->
Àn
 = 0;

4528 
out
;

4531 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_PREALLOC
;

4532 i‡(!
	`pxt4_mb_u£_¥óŒoˇãd
(
ac
)) {

4533 
ac
->
ac_›
 = 
PXT4_MB_HISTORY_ALLOC
;

4534 
	`pxt4_mb_n‹mÆize_ªque°
(
ac
, 
¨
);

4535 
ª≥©
:

4537 *
îΩ
 = 
	`pxt4_mb_ªguœr_Æloˇt‹
(
ac
);

4538 i‡(*
îΩ
)

4539 
disˇrd_™d_exô
;

4544 i‡(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
 &&

4545 
ac
->
ac_o_ex
.
„_Àn
 <ác->
ac_b_ex
.fe_len)

4546 *
îΩ
 = 
	`pxt4_mb_√w_¥óŒoˇti⁄
(
ac
);

4547 i‡(*
îΩ
) {

4548 
disˇrd_™d_exô
:

4549 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4550 
îrout
;

4553 i‡(
	`likñy
(
ac
->
ac_°©us
 =
AC_STATUS_FOUND
)) {

4554 *
îΩ
 = 
	`pxt4_mb_m¨k_disk•a˚_u£d
(
ac
, 
h™dÀ
, 
ª£rv_˛°rs
);

4555 i‡(*
îΩ
) {

4556 
	`pxt4_disˇrd_Æloˇãd_blocks
(
ac
);

4557 
îrout
;

4559 
block
 = 
	`pxt4_gΩ_offs_to_block
(
sb
, &
ac
->
ac_b_ex
);

4560 
¨
->
Àn
 = 
ac
->
ac_b_ex
.
„_Àn
;

4563 
‰ìd
 = 
	`pxt4_mb_disˇrd_¥óŒoˇti⁄s
(
sb
, 
ac
->
ac_o_ex
.
„_Àn
);

4564 i‡(
‰ìd
)

4565 
ª≥©
;

4566 *
îΩ
 = -
ENOSPC
;

4569 
îrout
:

4570 i‡(*
îΩ
) {

4571 
ac
->
ac_b_ex
.
„_Àn
 = 0;

4572 
¨
->
Àn
 = 0;

4573 
	`pxt4_mb_show_ac
(
ac
);

4575 
	`pxt4_mb_ªÀa£_c⁄ãxt
(
ac
);

4576 
out
:

4577 i‡(
ac
)

4578 
	`kmem_ˇche_‰ì
(
pxt4_ac_ˇchï
, 
ac
);

4579 i‡(
öquŸa
 && 
¨
->
Àn
 < inquota)

4580 
	`dquŸ_‰ì_block
(
¨
->
öode
, 
	`PXT4_C2B
(
sbi
, 
öquŸa
 -ár->
Àn
));

4581 i‡(!
¨
->
Àn
) {

4582 i‡((
¨
->
Êags
 & 
PXT4_MB_DELALLOC_RESERVED
) == 0)

4584 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_dúty˛u°îs_cou¡î
,

4585 
ª£rv_˛°rs
);

4588 
	`åa˚_pxt4_Æloˇã_blocks
(
¨
, ()
block
);

4590  
block
;

4591 
	}
}

4598 
	$pxt4_åy_mîge_‰ìd_exã¡
(
pxt4_sb_öfo
 *
sbi
,

4599 
pxt4_‰ì_d©a
 *
íåy
,

4600 
pxt4_‰ì_d©a
 *
√w_íåy
,

4601 
rb_roŸ
 *
íåy_rb_roŸ
)

4603 i‡((
íåy
->
efd_tid
 !
√w_íåy
->efd_tid) ||

4604 (
íåy
->
efd_group
 !
√w_íåy
->efd_group))

4606 i‡(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
 ==

4607 
√w_íåy
->
efd_°¨t_˛u°î
) {

4608 
√w_íåy
->
efd_°¨t_˛u°î
 = 
íåy
->efd_start_cluster;

4609 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4610 } i‡(
√w_íåy
->
efd_°¨t_˛u°î
 +Çew_íåy->
efd_cou¡
 ==

4611 
íåy
->
efd_°¨t_˛u°î
) {

4612 
√w_íåy
->
efd_cou¡
 +
íåy
->efd_count;

4615 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4616 
	`li°_dñ
(&
íåy
->
efd_li°
);

4617 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4618 
	`rb_îa£
(&
íåy
->
efd_node
, 
íåy_rb_roŸ
);

4619 
	`kmem_ˇche_‰ì
(
pxt4_‰ì_d©a_ˇchï
, 
íåy
);

4620 
	}
}

4622 
noölöe_f‹_°ack
 

4623 
	$pxt4_mb_‰ì_mëad©a
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_buddy
 *
e4b
,

4624 
pxt4_‰ì_d©a
 *
√w_íåy
)

4626 
pxt4_group_t
 
group
 = 
e4b
->
bd_group
;

4627 
pxt4_gΩblk_t
 
˛u°î
;

4628 
pxt4_gΩblk_t
 
˛u°îs
 = 
√w_íåy
->
efd_cou¡
;

4629 
pxt4_‰ì_d©a
 *
íåy
;

4630 
pxt4_group_öfo
 *
db
 = 
e4b
->
bd_öfo
;

4631 
su≥r_block
 *
sb
 = 
e4b
->
bd_sb
;

4632 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4633 
rb_node
 **
n
 = &
db
->
bb_‰ì_roŸ
.rb_node, *
node
;

4634 
rb_node
 *
∑ª¡
 = 
NULL
, *
√w_node
;

4636 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

4637 
	`BUG_ON
(
e4b
->
bd_bôm≠_∑ge
 =
NULL
);

4638 
	`BUG_ON
(
e4b
->
bd_buddy_∑ge
 =
NULL
);

4640 
√w_node
 = &
√w_íåy
->
efd_node
;

4641 
˛u°î
 = 
√w_íåy
->
efd_°¨t_˛u°î
;

4643 i‡(!*
n
) {

4649 
	`gë_∑ge
(
e4b
->
bd_buddy_∑ge
);

4650 
	`gë_∑ge
(
e4b
->
bd_bôm≠_∑ge
);

4652 *
n
) {

4653 
∑ª¡
 = *
n
;

4654 
íåy
 = 
	`rb_íåy
(
∑ª¡
, 
pxt4_‰ì_d©a
, 
efd_node
);

4655 i‡(
˛u°î
 < 
íåy
->
efd_°¨t_˛u°î
)

4656 
n
 = &(*n)->
rb_À·
;

4657 i‡(
˛u°î
 >(
íåy
->
efd_°¨t_˛u°î
 +É¡ry->
efd_cou¡
))

4658 
n
 = &(*n)->
rb_right
;

4660 
	`pxt4_gΩ_locked_îr‹
(
sb
, 
group
, 0,

4661 
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

4662 
	`PXT4_C2B
(
sbi
, 
˛u°î
),

4668 
	`rb_lök_node
(
√w_node
, 
∑ª¡
, 
n
);

4669 
	`rb_ö£π_cﬁ‹
(
√w_node
, &
db
->
bb_‰ì_roŸ
);

4672 
node
 = 
	`rb_¥ev
(
√w_node
);

4673 i‡(
node
) {

4674 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4675 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4676 &(
db
->
bb_‰ì_roŸ
));

4679 
node
 = 
	`rb_√xt
(
√w_node
);

4680 i‡(
node
) {

4681 
íåy
 = 
	`rb_íåy
(
node
, 
pxt4_‰ì_d©a
, 
efd_node
);

4682 
	`pxt4_åy_mîge_‰ìd_exã¡
(
sbi
, 
íåy
, 
√w_íåy
,

4683 &(
db
->
bb_‰ì_roŸ
));

4686 
	`•ö_lock
(&
sbi
->
s_md_lock
);

4687 
	`li°_add_èû
(&
√w_íåy
->
efd_li°
, &
sbi
->
s_‰ìd_d©a_li°
);

4688 
sbi
->
s_mb_‰ì_≥ndög
 +
˛u°îs
;

4689 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

4691 
	}
}

4701 
	$pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

4702 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

4703 
cou¡
, 
Êags
)

4705 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4706 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

4707 
pxt4_group_desc
 *
gdp
;

4708 
ovîÊow
;

4709 
pxt4_gΩblk_t
 
bô
;

4710 
buf„r_hód
 *
gd_bh
;

4711 
pxt4_group_t
 
block_group
;

4712 
pxt4_sb_öfo
 *
sbi
;

4713 
pxt4_buddy
 
e4b
;

4714 
cou¡_˛u°îs
;

4715 
îr
 = 0;

4716 
ªt
;

4718 
	`might_¶ìp
();

4719 i‡(
bh
) {

4720 i‡(
block
)

4721 
	`BUG_ON
(
block
 !
bh
->
b_blockƒ
);

4723 
block
 = 
bh
->
b_blockƒ
;

4726 
sbi
 = 
	`PXT4_SB
(
sb
);

4727 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_VALIDATED
) &&

4728 !
	`pxt4_d©a_block_vÆid
(
sbi
, 
block
, 
cou¡
)) {

4729 
	`pxt4_îr‹
(
sb
, "Freeing blocksÇot in datazone - "

4730 "block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4731 
îr‹_ªtu∫
;

4734 
	`pxt4_debug
("‰ìög block %Œu\n", 
block
);

4735 
	`åa˚_pxt4_‰ì_blocks
(
öode
, 
block
, 
cou¡
, 
Êags
);

4737 i‡(
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4738 
	`BUG_ON
(
cou¡
 > 1);

4740 
	`pxt4_f‹gë
(
h™dÀ
, 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
,

4741 
öode
, 
bh
, 
block
);

4751 
ovîÊow
 = 
	`PXT4_PBLK_COFF
(
sbi
, 
block
);

4752 i‡(
ovîÊow
) {

4753 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
) {

4754 
ovîÊow
 = 
sbi
->
s_˛u°î_øtio
 - overflow;

4755 
block
 +
ovîÊow
;

4756 i‡(
cou¡
 > 
ovîÊow
)

4757 
cou¡
 -
ovîÊow
;

4761 
block
 -
ovîÊow
;

4762 
cou¡
 +
ovîÊow
;

4765 
ovîÊow
 = 
	`PXT4_LBLK_COFF
(
sbi
, 
cou¡
);

4766 i‡(
ovîÊow
) {

4767 i‡(
Êags
 & 
PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
) {

4768 i‡(
cou¡
 > 
ovîÊow
)

4769 
cou¡
 -
ovîÊow
;

4773 
cou¡
 +
sbi
->
s_˛u°î_øtio
 - 
ovîÊow
;

4776 i‡(!
bh
 && (
Êags
 & 
PXT4_FREE_BLOCKS_FORGET
)) {

4777 
i
;

4778 
is_mëad©a
 = 
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
;

4780 
i
 = 0; i < 
cou¡
; i++) {

4781 
	`c⁄d_ªsched
();

4782 i‡(
is_mëad©a
)

4783 
bh
 = 
	`sb_föd_gë_block
(
öode
->
i_sb
, 
block
 + 
i
);

4784 
	`pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block
 + 
i
);

4788 
do_m‹e
:

4789 
ovîÊow
 = 0;

4790 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4792 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_BBITMAP_CORRUPT
(

4793 
	`pxt4_gë_group_öfo
(
sb
, 
block_group
))))

4800 i‡(
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

4801 
ovîÊow
 = 
	`PXT4_C2B
(
sbi
, 
bô
Ë+ 
cou¡
 -

4802 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

4803 
cou¡
 -
ovîÊow
;

4805 
cou¡_˛u°îs
 = 
	`PXT4_NUM_B2C
(
sbi
, 
cou¡
);

4806 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4807 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4808 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4809 
bôm≠_bh
 = 
NULL
;

4810 
îr‹_ªtu∫
;

4812 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

4813 i‡(!
gdp
) {

4814 
îr
 = -
EIO
;

4815 
îr‹_ªtu∫
;

4818 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4819 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
gdp
), 
block
, 
cou¡
) ||

4820 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4821 
sbi
->
s_ôb_≥r_group
) ||

4822 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
),

4823 
sbi
->
s_ôb_≥r_group
)) {

4825 
	`pxt4_îr‹
(
sb
, "Freeing blocks in system zone - "

4826 "Block = %Œu, cou¡ = %lu", 
block
, 
cou¡
);

4828 
îr‹_ªtu∫
;

4831 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

4832 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

4833 i‡(
îr
)

4834 
îr‹_ªtu∫
;

4841 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

4842 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

4843 i‡(
îr
)

4844 
îr‹_ªtu∫
;

4845 #ifde‡
AGGRESSIVE_CHECK


4847 
i
;

4848 
i
 = 0; i < 
cou¡_˛u°îs
; i++)

4849 
	`BUG_ON
(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
));

4852 
	`åa˚_pxt4_mbÆloc_‰ì
(
sb
, 
öode
, 
block_group
, 
bô
, 
cou¡_˛u°îs
);

4855 
îr
 = 
	`pxt4_mb_lﬂd_buddy_gÂ
(
sb
, 
block_group
, &
e4b
,

4856 
GFP_NOFS
|
__GFP_NOFAIL
);

4857 i‡(
îr
)

4858 
îr‹_ªtu∫
;

4866 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

4867 ((
Êags
 & 
PXT4_FREE_BLOCKS_METADATA
) ||

4868 !
	`pxt4_should_wrôeback_d©a
(
öode
))) {

4869 
pxt4_‰ì_d©a
 *
√w_íåy
;

4874 
√w_íåy
 = 
	`kmem_ˇche_Æloc
(
pxt4_‰ì_d©a_ˇchï
,

4875 
GFP_NOFS
|
__GFP_NOFAIL
);

4876 
√w_íåy
->
efd_°¨t_˛u°î
 = 
bô
;

4877 
√w_íåy
->
efd_group
 = 
block_group
;

4878 
√w_íåy
->
efd_cou¡
 = 
cou¡_˛u°îs
;

4879 
√w_íåy
->
efd_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

4881 
	`pxt4_lock_group
(
sb
, 
block_group
);

4882 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4883 
	`pxt4_mb_‰ì_mëad©a
(
h™dÀ
, &
e4b
, 
√w_íåy
);

4889 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4890 
îr
 = 
	`pxt4_issue_disˇrd
(
sb
, 
block_group
, 
bô
, 
cou¡
,

4891 
NULL
);

4892 i‡(
îr
 &&Éº !-
EOPNOTSUPP
)

4893 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "discardÑequest in"

4895 " wôh %d", 
block_group
, 
bô
, 
cou¡
,

4896 
îr
);

4898 
	`PXT4_MB_GRP_CLEAR_TRIMMED
(
e4b
.
bd_öfo
);

4900 
	`pxt4_lock_group
(
sb
, 
block_group
);

4901 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
cou¡_˛u°îs
);

4902 
	`mb_‰ì_blocks
(
öode
, &
e4b
, 
bô
, 
cou¡_˛u°îs
);

4905 
ªt
 = 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
Ë+ 
cou¡_˛u°îs
;

4906 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
, 
ªt
);

4907 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
gdp
, 
bôm≠_bh
);

4908 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
gdp
);

4909 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

4911 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

4912 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

4913 
	`©omic64_add
(
cou¡_˛u°îs
,

4914 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

4922 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
)) {

4923 i‡(!(
Êags
 & 
PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
))

4924 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
sbi
, 
cou¡_˛u°îs
));

4925 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

4926 
cou¡_˛u°îs
);

4929 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

4932 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

4933 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

4936 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

4937 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

4938 i‡(!
îr
)

4939 
îr
 = 
ªt
;

4941 i‡(
ovîÊow
 && !
îr
) {

4942 
block
 +
cou¡
;

4943 
cou¡
 = 
ovîÊow
;

4944 
	`put_bh
(
bôm≠_bh
);

4945 
do_m‹e
;

4947 
îr‹_ªtu∫
:

4948 
	`bªl£
(
bôm≠_bh
);

4949 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

4951 
	}
}

4962 
	$pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

4963 
pxt4_fsblk_t
 
block
, 
cou¡
)

4965 
buf„r_hód
 *
bôm≠_bh
 = 
NULL
;

4966 
buf„r_hód
 *
gd_bh
;

4967 
pxt4_group_t
 
block_group
;

4968 
pxt4_gΩblk_t
 
bô
;

4969 
i
;

4970 
pxt4_group_desc
 *
desc
;

4971 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4972 
pxt4_buddy
 
e4b
;

4973 
îr
 = 0, 
ªt
, 
‰ì_˛u°îs_cou¡
;

4974 
pxt4_gΩblk_t
 
˛u°îs_‰ìd
;

4975 
pxt4_fsblk_t
 
fú°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
);

4976 
pxt4_fsblk_t
 
œ°_˛u°î
 = 
	`PXT4_B2C
(
sbi
, 
block
 + 
cou¡
 - 1);

4977 
˛u°î_cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

4979 
	`pxt4_debug
("Addög block(sË%Œu-%Œu\n", 
block
, block + 
cou¡
 - 1);

4981 i‡(
cou¡
 == 0)

4984 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
block
, &
block_group
, &
bô
);

4989 i‡(
bô
 + 
˛u°î_cou¡
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
)) {

4990 
	`pxt4_w¨nög
(
sb
, "too many blocksáddedÅo group %u",

4991 
block_group
);

4992 
îr
 = -
EINVAL
;

4993 
îr‹_ªtu∫
;

4996 
bôm≠_bh
 = 
	`pxt4_ªad_block_bôm≠
(
sb
, 
block_group
);

4997 i‡(
	`IS_ERR
(
bôm≠_bh
)) {

4998 
îr
 = 
	`PTR_ERR
(
bôm≠_bh
);

4999 
bôm≠_bh
 = 
NULL
;

5000 
îr‹_ªtu∫
;

5003 
desc
 = 
	`pxt4_gë_group_desc
(
sb
, 
block_group
, &
gd_bh
);

5004 i‡(!
desc
) {

5005 
îr
 = -
EIO
;

5006 
îr‹_ªtu∫
;

5009 i‡(
	`ö_ønge
(
	`pxt4_block_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5010 
	`ö_ønge
(
	`pxt4_öode_bôm≠
(
sb
, 
desc
), 
block
, 
cou¡
) ||

5011 
	`ö_ønge
(
block
, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
), 
sbi
->
s_ôb_≥r_group
) ||

5012 
	`ö_ønge
(
block
 + 
cou¡
 - 1, 
	`pxt4_öode_èbÀ
(
sb
, 
desc
),

5013 
sbi
->
s_ôb_≥r_group
)) {

5014 
	`pxt4_îr‹
(
sb
, "Adding blocks in system zones - "

5016 
block
, 
cou¡
);

5017 
îr
 = -
EINVAL
;

5018 
îr‹_ªtu∫
;

5021 
	`BUFFER_TRACE
(
bôm≠_bh
, "getting writeáccess");

5022 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bôm≠_bh
);

5023 i‡(
îr
)

5024 
îr‹_ªtu∫
;

5031 
	`BUFFER_TRACE
(
gd_bh
, "get_write_access");

5032 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gd_bh
);

5033 i‡(
îr
)

5034 
îr‹_ªtu∫
;

5036 
i
 = 0, 
˛u°îs_‰ìd
 = 0; i < 
˛u°î_cou¡
; i++) {

5037 
	`BUFFER_TRACE
(
bôm≠_bh
, "clear bit");

5038 i‡(!
	`mb_ã°_bô
(
bô
 + 
i
, 
bôm≠_bh
->
b_d©a
)) {

5039 
	`pxt4_îr‹
(
sb
, "bitálready cleared for block %llu",

5040 (
pxt4_fsblk_t
)(
block
 + 
i
));

5041 
	`BUFFER_TRACE
(
bôm≠_bh
, "bitálready cleared");

5043 
˛u°îs_‰ìd
++;

5047 
îr
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
block_group
, &
e4b
);

5048 i‡(
îr
)

5049 
îr‹_ªtu∫
;

5056 
	`pxt4_lock_group
(
sb
, 
block_group
);

5057 
	`mb_˛ór_bôs
(
bôm≠_bh
->
b_d©a
, 
bô
, 
˛u°î_cou¡
);

5058 
	`mb_‰ì_blocks
(
NULL
, &
e4b
, 
bô
, 
˛u°î_cou¡
);

5059 
‰ì_˛u°îs_cou¡
 = 
˛u°îs_‰ìd
 +

5060 
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
desc
);

5061 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
desc
, 
‰ì_˛u°îs_cou¡
);

5062 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
block_group
, 
desc
, 
bôm≠_bh
);

5063 
	`pxt4_group_desc_csum_£t
(
sb
, 
block_group
, 
desc
);

5064 
	`pxt4_u∆ock_group
(
sb
, 
block_group
);

5065 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

5066 
˛u°îs_‰ìd
);

5068 i‡(
sbi
->
s_log_groups_≥r_Êex
) {

5069 
pxt4_group_t
 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
block_group
);

5070 
	`©omic64_add
(
˛u°îs_‰ìd
,

5071 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

5074 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5077 
	`BUFFER_TRACE
(
bôm≠_bh
, "dirtied bitmap block");

5078 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bôm≠_bh
);

5081 
	`BUFFER_TRACE
(
gd_bh
, "dirtied group descriptor block");

5082 
ªt
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gd_bh
);

5083 i‡(!
îr
)

5084 
îr
 = 
ªt
;

5086 
îr‹_ªtu∫
:

5087 
	`bªl£
(
bôm≠_bh
);

5088 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

5089  
îr
;

5090 
	}
}

5104 
	$pxt4_åim_exã¡
(
su≥r_block
 *
sb
, 
°¨t
, 
cou¡
,

5105 
pxt4_group_t
 
group
, 
pxt4_buddy
 *
e4b
)

5106 
	$__ªÀa£s
(
bôlock
)

5107 
	$__acquúes
(
bôlock
)

5109 
pxt4_‰ì_exã¡
 
ex
;

5110 
ªt
 = 0;

5112 
	`åa˚_pxt4_åim_exã¡
(
sb
, 
group
, 
°¨t
, 
cou¡
);

5114 
	`as£π_•ö_locked
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

5116 
ex
.
„_°¨t
 = 
°¨t
;

5117 
ex
.
„_group
 = 
group
;

5118 
ex
.
„_Àn
 = 
cou¡
;

5124 
	`mb_m¨k_u£d
(
e4b
, &
ex
);

5125 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5126 
ªt
 = 
	`pxt4_issue_disˇrd
(
sb
, 
group
, 
°¨t
, 
cou¡
, 
NULL
);

5127 
	`pxt4_lock_group
(
sb
, 
group
);

5128 
	`mb_‰ì_blocks
(
NULL
, 
e4b
, 
°¨t
, 
ex
.
„_Àn
);

5129  
ªt
;

5130 
	}
}

5150 
pxt4_gΩblk_t


5151 
	$pxt4_åim_Æl_‰ì
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

5152 
pxt4_gΩblk_t
 
°¨t
,Öxt4_gΩblk_à
max
,

5153 
pxt4_gΩblk_t
 
möblocks
)

5155 *
bôm≠
;

5156 
pxt4_gΩblk_t
 
√xt
, 
cou¡
 = 0, 
‰ì_cou¡
 = 0;

5157 
pxt4_buddy
 
e4b
;

5158 
ªt
 = 0;

5160 
	`åa˚_pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
°¨t
, 
max
);

5162 
ªt
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5163 i‡(
ªt
) {

5164 
	`pxt4_w¨nög
(
sb
, "Error %dÜoading buddy information for %u",

5165 
ªt
, 
group
);

5166  
ªt
;

5168 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5170 
	`pxt4_lock_group
(
sb
, 
group
);

5171 i‡(
	`PXT4_MB_GRP_WAS_TRIMMED
(
e4b
.
bd_öfo
) &&

5172 
möblocks
 >
	`©omic_ªad
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
))

5173 
out
;

5175 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5176 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5178 
°¨t
 <
max
) {

5179 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
max
 + 1, start);

5180 i‡(
°¨t
 > 
max
)

5182 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
max
 + 1, 
°¨t
);

5184 i‡((
√xt
 - 
°¨t
Ë>
möblocks
) {

5185 
ªt
 = 
	`pxt4_åim_exã¡
(
sb
, 
°¨t
,

5186 
√xt
 - 
°¨t
, 
group
, &
e4b
);

5187 i‡(
ªt
 &&Ñë !-
EOPNOTSUPP
)

5189 
ªt
 = 0;

5190 
cou¡
 +
√xt
 - 
°¨t
;

5192 
‰ì_cou¡
 +
√xt
 - 
°¨t
;

5193 
°¨t
 = 
√xt
 + 1;

5195 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

5196 
cou¡
 = -
ERESTARTSYS
;

5200 i‡(
	`√ed_ªsched
()) {

5201 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5202 
	`c⁄d_ªsched
();

5203 
	`pxt4_lock_group
(
sb
, 
group
);

5206 i‡((
e4b
.
bd_öfo
->
bb_‰ì
 - 
‰ì_cou¡
Ë< 
möblocks
)

5210 i‡(!
ªt
) {

5211 
ªt
 = 
cou¡
;

5212 
	`PXT4_MB_GRP_SET_TRIMMED
(
e4b
.
bd_öfo
);

5214 
out
:

5215 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5216 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5218 
	`pxt4_debug
("trimmed %d blocks inÅhe group %d\n",

5219 
cou¡
, 
group
);

5221  
ªt
;

5222 
	}
}

5236 
	$pxt4_åim_fs
(
su≥r_block
 *
sb
, 
f°rim_ønge
 *
ønge
)

5238 
pxt4_group_öfo
 *
gΩ
;

5239 
pxt4_group_t
 
group
, 
fú°_group
, 
œ°_group
;

5240 
pxt4_gΩblk_t
 
˙t
 = 0, 
fú°_˛u°î
, 
œ°_˛u°î
;

5241 
uöt64_t
 
°¨t
, 
íd
, 
möÀn
, 
åimmed
 = 0;

5242 
pxt4_fsblk_t
 
fú°_d©a_blk
 =

5243 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

5244 
pxt4_fsblk_t
 
max_blks
 = 
	`pxt4_blocks_cou¡
(
	`PXT4_SB
(
sb
)->
s_es
);

5245 
ªt
 = 0;

5247 
°¨t
 = 
ønge
->°¨à>> 
sb
->
s_blocksize_bôs
;

5248 
íd
 = 
°¨t
 + (
ønge
->
Àn
 >> 
sb
->
s_blocksize_bôs
) - 1;

5249 
möÀn
 = 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

5250 
ønge
->
möÀn
 >> 
sb
->
s_blocksize_bôs
);

5252 i‡(
möÀn
 > 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) ||

5253 
°¨t
 >
max_blks
 ||

5254 
ønge
->
Àn
 < 
sb
->
s_blocksize
)

5255  -
EINVAL
;

5256 i‡(
íd
 >
max_blks
)

5257 
íd
 = 
max_blks
 - 1;

5258 i‡(
íd
 <
fú°_d©a_blk
)

5259 
out
;

5260 i‡(
°¨t
 < 
fú°_d©a_blk
)

5261 
°¨t
 = 
fú°_d©a_blk
;

5264 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
°¨t
,

5265 &
fú°_group
, &
fú°_˛u°î
);

5266 
	`pxt4_gë_group_no_™d_off£t
(
sb
, (
pxt4_fsblk_t
Ë
íd
,

5267 &
œ°_group
, &
œ°_˛u°î
);

5270 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5272 
group
 = 
fú°_group
; grou∞<
œ°_group
; group++) {

5273 
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

5275 i‡(
	`u∆ikñy
(
	`PXT4_MB_GRP_NEED_INIT
(
gΩ
))) {

5276 
ªt
 = 
	`pxt4_mb_öô_group
(
sb
, 
group
, 
GFP_NOFS
);

5277 i‡(
ªt
)

5287 i‡(
group
 =
œ°_group
)

5288 
íd
 = 
œ°_˛u°î
;

5290 i‡(
gΩ
->
bb_‰ì
 >
möÀn
) {

5291 
˙t
 = 
	`pxt4_åim_Æl_‰ì
(
sb
, 
group
, 
fú°_˛u°î
,

5292 
íd
, 
möÀn
);

5293 i‡(
˙t
 < 0) {

5294 
ªt
 = 
˙t
;

5297 
åimmed
 +
˙t
;

5304 
fú°_˛u°î
 = 0;

5307 i‡(!
ªt
)

5308 
	`©omic_£t
(&
	`PXT4_SB
(
sb
)->
s_œ°_åim_möblks
, 
möÀn
);

5310 
out
:

5311 
ønge
->
Àn
 = 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
åimmed
Ë<< sb->
s_blocksize_bôs
;

5312  
ªt
;

5313 
	}
}

5317 
	$pxt4_mbÆloc_quîy_ønge
(

5318 
su≥r_block
 *
sb
,

5319 
pxt4_group_t
 
group
,

5320 
pxt4_gΩblk_t
 
°¨t
,

5321 
pxt4_gΩblk_t
 
íd
,

5322 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

5323 *
¥iv
)

5325 *
bôm≠
;

5326 
pxt4_gΩblk_t
 
√xt
;

5327 
pxt4_buddy
 
e4b
;

5328 
îr‹
;

5330 
îr‹
 = 
	`pxt4_mb_lﬂd_buddy
(
sb
, 
group
, &
e4b
);

5331 i‡(
îr‹
)

5332  
îr‹
;

5333 
bôm≠
 = 
e4b
.
bd_bôm≠
;

5335 
	`pxt4_lock_group
(
sb
, 
group
);

5337 
°¨t
 = (
e4b
.
bd_öfo
->
bb_fú°_‰ì
 > start) ?

5338 
e4b
.
bd_öfo
->
bb_fú°_‰ì
 : 
°¨t
;

5339 i‡(
íd
 >
	`PXT4_CLUSTERS_PER_GROUP
(
sb
))

5340 
íd
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) - 1;

5342 
°¨t
 <
íd
) {

5343 
°¨t
 = 
	`mb_föd_√xt_zîo_bô
(
bôm≠
, 
íd
 + 1, start);

5344 i‡(
°¨t
 > 
íd
)

5346 
√xt
 = 
	`mb_föd_√xt_bô
(
bôm≠
, 
íd
 + 1, 
°¨t
);

5348 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5349 
îr‹
 = 
	`f‹m©ãr
(
sb
, 
group
, 
°¨t
, 
√xt
 - sèπ, 
¥iv
);

5350 i‡(
îr‹
)

5351 
out_u∆ﬂd
;

5352 
	`pxt4_lock_group
(
sb
, 
group
);

5354 
°¨t
 = 
√xt
 + 1;

5357 
	`pxt4_u∆ock_group
(
sb
, 
group
);

5358 
out_u∆ﬂd
:

5359 
	`pxt4_mb_u∆ﬂd_buddy
(&
e4b
);

5361  
îr‹
;

5362 
	}
}

	@mballoc.h

8 #i‚de‡
_PXT4_MBALLOC_H


9 
	#_PXT4_MBALLOC_H


	)

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/«mei.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/buf„r_hód.h
>

16 
	~<löux/moduÀ.h
>

17 
	~<löux/sw≠.h
>

18 
	~<löux/¥oc_fs.h
>

19 
	~<löux/∑gem≠.h
>

20 
	~<löux/£q_fûe.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/muãx.h
>

23 
	~"pxt4_jbd3.h
"

24 
	~"pxt4.h
"

28 #ifde‡
CONFIG_PXT4_DEBUG


29 
ush‹t
 
pxt4_mbÆloc_debug
;

31 
	#mb_debug
(
n
, 
fmt
, ...) \

33 i‡((
n
Ë<
pxt4_mbÆloc_debug
) { \

34 
	`¥ötk
(
KERN_DEBUG
 "(%s, %d): %s: " 
fmt
, \

35 
__FILE__
, 
__LINE__
, 
__func__
, ##
__VA_ARGS__
); \

37 } 0)

	)

39 
	#mb_debug
(
n
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

42 
	#PXT4_MB_HISTORY_ALLOC
 1

	)

43 
	#PXT4_MB_HISTORY_PREALLOC
 2

	)

48 
	#MB_DEFAULT_MAX_TO_SCAN
 200

	)

53 
	#MB_DEFAULT_MIN_TO_SCAN
 10

	)

59 
	#MB_DEFAULT_STATS
 0

	)

68 
	#MB_DEFAULT_STREAM_THRESHOLD
 16

	)

73 
	#MB_DEFAULT_ORDER2_REQS
 2

	)

78 
	#MB_DEFAULT_GROUP_PREALLOC
 512

	)

81 
	spxt4_‰ì_d©a
 {

83 
li°_hód
 
	mefd_li°
;

86 
rb_node
 
	mefd_node
;

89 
pxt4_group_t
 
	mefd_group
;

92 
pxt4_gΩblk_t
 
	mefd_°¨t_˛u°î
;

93 
pxt4_gΩblk_t
 
	mefd_cou¡
;

96 
tid_t
 
	mefd_tid
;

99 
	spxt4_¥óŒoc_•a˚
 {

100 
li°_hód
 
	m∑_öode_li°
;

101 
li°_hód
 
	m∑_group_li°
;

103 
li°_hód
 
	m∑_tmp_li°
;

104 
rcu_hód
 
	m∑_rcu
;

105 } 
	mu
;

106 
•ölock_t
 
	m∑_lock
;

107 
©omic_t
 
	m∑_cou¡
;

108 
	m∑_dñëed
;

109 
pxt4_fsblk_t
 
	m∑_p°¨t
;

110 
pxt4_lblk_t
 
	m∑_l°¨t
;

111 
pxt4_gΩblk_t
 
	m∑_Àn
;

112 
pxt4_gΩblk_t
 
	m∑_‰ì
;

113 
	m∑_ty≥
;

114 
•ölock_t
 *
	m∑_obj_lock
;

115 
öode
 *
	m∑_öode
;

119 
	mMB_INODE_PA
 = 0,

120 
	mMB_GROUP_PA
 = 1

123 
	spxt4_‰ì_exã¡
 {

124 
pxt4_lblk_t
 
	m„_logiˇl
;

125 
pxt4_gΩblk_t
 
	m„_°¨t
;

126 
pxt4_group_t
 
	m„_group
;

127 
pxt4_gΩblk_t
 
	m„_Àn
;

138 
	#PREALLOC_TB_SIZE
 10

	)

139 
	spxt4_loˇlôy_group
 {

142 
muãx
 
	mlg_muãx
;

144 
li°_hód
 
	mlg_¥óŒoc_li°
[
PREALLOC_TB_SIZE
];

145 
•ölock_t
 
	mlg_¥óŒoc_lock
;

148 
	spxt4_Æloˇti⁄_c⁄ãxt
 {

149 
öode
 *
	mac_öode
;

150 
su≥r_block
 *
	mac_sb
;

153 
pxt4_‰ì_exã¡
 
	mac_o_ex
;

156 
pxt4_‰ì_exã¡
 
	mac_g_ex
;

159 
pxt4_‰ì_exã¡
 
	mac_b_ex
;

162 
pxt4_‰ì_exã¡
 
	mac_f_ex
;

164 
__u16
 
	mac_groups_sˇ¬ed
;

165 
__u16
 
	mac_found
;

166 
__u16
 
	mac_èû
;

167 
__u16
 
	mac_buddy
;

168 
__u16
 
	mac_Êags
;

169 
__u8
 
	mac_°©us
;

170 
__u8
 
	mac_¸ôîü
;

171 
__u8
 
	mac_2‹dî
;

173 
__u8
 
	mac_›
;

174 
∑ge
 *
	mac_bôm≠_∑ge
;

175 
∑ge
 *
	mac_buddy_∑ge
;

176 
pxt4_¥óŒoc_•a˚
 *
	mac_∑
;

177 
pxt4_loˇlôy_group
 *
	mac_lg
;

180 
	#AC_STATUS_CONTINUE
 1

	)

181 
	#AC_STATUS_FOUND
 2

	)

182 
	#AC_STATUS_BREAK
 3

	)

184 
	spxt4_buddy
 {

185 
∑ge
 *
	mbd_buddy_∑ge
;

186 *
	mbd_buddy
;

187 
∑ge
 *
	mbd_bôm≠_∑ge
;

188 *
	mbd_bôm≠
;

189 
pxt4_group_öfo
 *
	mbd_öfo
;

190 
su≥r_block
 *
	mbd_sb
;

191 
__u16
 
	mbd_blkbôs
;

192 
pxt4_group_t
 
	mbd_group
;

195 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_gΩ_offs_to_block
(
su≥r_block
 *
sb
,

196 
pxt4_‰ì_exã¡
 *
„x
)

198  
	`pxt4_group_fú°_block_no
(
sb
, 
„x
->
„_group
) +

199 (
„x
->
„_°¨t
 << 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

200 
	}
}

202 (*
	tpxt4_mbÆloc_quîy_ønge_‚
)(

203 
	tsu≥r_block
 *
	tsb
,

204 
	tpxt4_group_t
 
	tagno
,

205 
	tpxt4_gΩblk_t
 
	t°¨t
,

206 
	tpxt4_gΩblk_t
 
	tÀn
,

207 *
	t¥iv
);

210 
	`pxt4_mbÆloc_quîy_ønge
(

211 
su≥r_block
 *
sb
,

212 
pxt4_group_t
 
agno
,

213 
pxt4_gΩblk_t
 
°¨t
,

214 
pxt4_gΩblk_t
 
íd
,

215 
pxt4_mbÆloc_quîy_ønge_‚
 
f‹m©ãr
,

216 *
¥iv
);

	@migrate.c

8 
	~<löux/¶ab.h
>

9 
	~"pxt4_jbd3.h
"

10 
	~"pxt4_exã¡s.h
"

16 
	smigøã_°ru˘
 {

17 
pxt4_lblk_t
 
	mfú°_block
, 
	mœ°_block
, 
	mcuº_block
;

18 
pxt4_fsblk_t
 
	mfú°_pblock
, 
	mœ°_pblock
;

21 
	$föish_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

22 
migøã_°ru˘
 *
lb
)

25 
ªtvÆ
 = 0, 
√eded
;

26 
pxt4_exã¡
 
√wext
;

27 
pxt4_ext_∑th
 *
∑th
;

28 i‡(
lb
->
fú°_pblock
 == 0)

32 
√wext
.
ì_block
 = 
	`˝u_to_À32
(
lb
->
fú°_block
);

33 
√wext
.
ì_Àn
 = 
	`˝u_to_À16
(
lb
->
œ°_block
 -Üb->
fú°_block
 + 1);

34 
	`pxt4_ext_°‹e_pblock
(&
√wext
, 
lb
->
fú°_pblock
);

36 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

37 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lb
->
fú°_block
, 
NULL
, 0);

38 i‡(
	`IS_ERR
(
∑th
)) {

39 
ªtvÆ
 = 
	`PTR_ERR
(
∑th
);

40 
∑th
 = 
NULL
;

41 
îr_out
;

50 
√eded
 = 
	`pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
,

51 
lb
->
œ°_block
 -Üb->
fú°_block
 + 1, 
∑th
);

56 i‡(
√eded
 && 
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
,

57 
PXT4_RESERVE_TRANS_BLOCKS
)) {

58 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

59 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

60 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

61 i‡(
ªtvÆ
)

62 
îr_out
;

63 } i‡(
√eded
) {

64 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
);

65 i‡(
ªtvÆ
) {

69 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

70 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

71 
	`down_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

72 i‡(
ªtvÆ
)

73 
îr_out
;

76 
ªtvÆ
 = 
	`pxt4_ext_ö£π_exã¡
(
h™dÀ
, 
öode
, &
∑th
, &
√wext
, 0);

77 
îr_out
:

78 
	`up_wrôe
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

79 
	`pxt4_ext_dr›_ªfs
(
∑th
);

80 
	`k‰ì
(
∑th
);

81 
lb
->
fú°_pblock
 = 0;

82  
ªtvÆ
;

83 
	}
}

85 
	$upd©e_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

86 
pxt4_fsblk_t
 
pblock
, 
migøã_°ru˘
 *
lb
)

88 
ªtvÆ
;

92 i‡(
lb
->
fú°_pblock
 &&

93 (
lb
->
œ°_pblock
+1 =
pblock
) &&

94 (
lb
->
œ°_block
+1 =lb->
cuº_block
)) {

95 
lb
->
œ°_pblock
 = 
pblock
;

96 
lb
->
œ°_block
 =Üb->
cuº_block
;

97 
lb
->
cuº_block
++;

103 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
öode
, 
lb
);

104 
lb
->
fú°_pblock
 =Üb->
œ°_pblock
 = 
pblock
;

105 
lb
->
fú°_block
 =Üb->
œ°_block
 =Üb->
cuº_block
;

106 
lb
->
cuº_block
++;

107  
ªtvÆ
;

108 
	}
}

110 
	$upd©e_öd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

111 
pxt4_fsblk_t
 
pblock
,

112 
migøã_°ru˘
 *
lb
)

114 
buf„r_hód
 *
bh
;

115 
__À32
 *
i_d©a
;

116 
i
, 
ªtvÆ
 = 0;

117 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

119 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

120 i‡(
	`IS_ERR
(
bh
))

121  
	`PTR_ERR
(
bh
);

123 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

124 
i
 = 0; i < 
max_íåõs
; i++) {

125 i‡(
i_d©a
[
i
]) {

126 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
öode
,

127 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

128 i‡(
ªtvÆ
)

131 
lb
->
cuº_block
++;

134 
	`put_bh
(
bh
);

135  
ªtvÆ
;

137 
	}
}

139 
	$upd©e_död_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

140 
pxt4_fsblk_t
 
pblock
,

141 
migøã_°ru˘
 *
lb
)

143 
buf„r_hód
 *
bh
;

144 
__À32
 *
i_d©a
;

145 
i
, 
ªtvÆ
 = 0;

146 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

148 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

149 i‡(
	`IS_ERR
(
bh
))

150  
	`PTR_ERR
(
bh
);

152 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

153 
i
 = 0; i < 
max_íåõs
; i++) {

154 i‡(
i_d©a
[
i
]) {

155 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
öode
,

156 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

157 i‡(
ªtvÆ
)

161 
lb
->
cuº_block
 +
max_íåõs
;

164 
	`put_bh
(
bh
);

165  
ªtvÆ
;

167 
	}
}

169 
	$upd©e_töd_exã¡_ønge
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

170 
pxt4_fsblk_t
 
pblock
,

171 
migøã_°ru˘
 *
lb
)

173 
buf„r_hód
 *
bh
;

174 
__À32
 *
i_d©a
;

175 
i
, 
ªtvÆ
 = 0;

176 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

178 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
pblock
, 0);

179 i‡(
	`IS_ERR
(
bh
))

180  
	`PTR_ERR
(
bh
);

182 
i_d©a
 = (
__À32
 *)
bh
->
b_d©a
;

183 
i
 = 0; i < 
max_íåõs
; i++) {

184 i‡(
i_d©a
[
i
]) {

185 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
öode
,

186 
	`À32_to_˝u
(
i_d©a
[
i
]), 
lb
);

187 i‡(
ªtvÆ
)

191 
lb
->
cuº_block
 +
max_íåõs
 * max_entries;

194 
	`put_bh
(
bh
);

195  
ªtvÆ
;

197 
	}
}

199 
	$exãnd_¸edô_f‹_blkdñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

201 
ªtvÆ
 = 0, 
√eded
;

203 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
PXT4_RESERVE_TRANS_BLOCKS
+1))

211 
√eded
 = 3 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
);

213 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
√eded
) != 0)

214 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
√eded
);

216  
ªtvÆ
;

217 
	}
}

219 
	$‰ì_död_blocks
(
h™dÀ_t
 *
h™dÀ
,

220 
öode
 *öode, 
__À32
 
i_d©a
)

222 
i
;

223 
__À32
 *
tmp_id©a
;

224 
buf„r_hód
 *
bh
;

225 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

227 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

228 i‡(
	`IS_ERR
(
bh
))

229  
	`PTR_ERR
(
bh
);

231 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

232 
i
 = 0; i < 
max_íåõs
; i++) {

233 i‡(
tmp_id©a
[
i
]) {

234 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

235 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

236 
	`À32_to_˝u
(
tmp_id©a
[
i
]), 1,

237 
PXT4_FREE_BLOCKS_METADATA
 |

238 
PXT4_FREE_BLOCKS_FORGET
);

241 
	`put_bh
(
bh
);

242 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

243 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

244 
PXT4_FREE_BLOCKS_METADATA
 |

245 
PXT4_FREE_BLOCKS_FORGET
);

247 
	}
}

249 
	$‰ì_töd_blocks
(
h™dÀ_t
 *
h™dÀ
,

250 
öode
 *öode, 
__À32
 
i_d©a
)

252 
i
, 
ªtvÆ
 = 0;

253 
__À32
 *
tmp_id©a
;

254 
buf„r_hód
 *
bh
;

255 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

257 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`À32_to_˝u
(
i_d©a
), 0);

258 i‡(
	`IS_ERR
(
bh
))

259  
	`PTR_ERR
(
bh
);

261 
tmp_id©a
 = (
__À32
 *)
bh
->
b_d©a
;

262 
i
 = 0; i < 
max_íåõs
; i++) {

263 i‡(
tmp_id©a
[
i
]) {

264 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
,

265 
öode
, 
tmp_id©a
[
i
]);

266 i‡(
ªtvÆ
) {

267 
	`put_bh
(
bh
);

268  
ªtvÆ
;

272 
	`put_bh
(
bh
);

273 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
	`À32_to_˝u
(
i_d©a
), 1,

275 
PXT4_FREE_BLOCKS_METADATA
 |

276 
PXT4_FREE_BLOCKS_FORGET
);

278 
	}
}

280 
	$‰ì_öd_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
__À32
 *
i_d©a
)

282 
ªtvÆ
;

285 i‡(
i_d©a
[0]) {

286 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

287 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
,

288 
	`À32_to_˝u
(
i_d©a
[0]), 1,

289 
PXT4_FREE_BLOCKS_METADATA
 |

290 
PXT4_FREE_BLOCKS_FORGET
);

294 i‡(
i_d©a
[1]) {

295 
ªtvÆ
 = 
	`‰ì_död_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[1]);

296 i‡(
ªtvÆ
)

297  
ªtvÆ
;

301 i‡(
i_d©a
[2]) {

302 
ªtvÆ
 = 
	`‰ì_töd_blocks
(
h™dÀ
, 
öode
, 
i_d©a
[2]);

303 i‡(
ªtvÆ
)

304  
ªtvÆ
;

307 
	}
}

309 
	$pxt4_ext_sw≠_öode_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

310 
öode
 *
tmp_öode
)

312 
ªtvÆ
;

313 
__À32
 
i_d©a
[3];

314 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

315 
pxt4_öode_öfo
 *
tmp_ei
 = 
	`PXT4_I
(
tmp_öode
);

321 
ªtvÆ
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1);

322 i‡(
ªtvÆ
) {

323 
ªtvÆ
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

324 i‡(
ªtvÆ
)

325 
îr_out
;

328 
i_d©a
[0] = 
ei
->i_d©a[
PXT4_IND_BLOCK
];

329 
i_d©a
[1] = 
ei
->i_d©a[
PXT4_DIND_BLOCK
];

330 
i_d©a
[2] = 
ei
->i_d©a[
PXT4_TIND_BLOCK
];

332 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

338 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
)) {

339 
ªtvÆ
 = -
EAGAIN
;

340 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

341 
îr_out
;

343 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

348 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

349 
	`mem˝y
(
ei
->
i_d©a
, 
tmp_ei
->i_data, (ei->i_data));

360 
	`•ö_lock
(&
öode
->
i_lock
);

361 
öode
->
i_blocks
 +
tmp_öode
->i_blocks;

362 
	`•ö_u∆ock
(&
öode
->
i_lock
);

363 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

369 
ªtvÆ
 = 
	`‰ì_öd_block
(
h™dÀ
, 
öode
, 
i_d©a
);

370 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

372 
îr_out
:

373  
ªtvÆ
;

374 
	}
}

376 
	$‰ì_ext_idx
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

377 
pxt4_exã¡_idx
 *
ix
)

379 
i
, 
ªtvÆ
 = 0;

380 
pxt4_fsblk_t
 
block
;

381 
buf„r_hód
 *
bh
;

382 
pxt4_exã¡_hódî
 *
eh
;

384 
block
 = 
	`pxt4_idx_pblock
(
ix
);

385 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
block
, 0);

386 i‡(
	`IS_ERR
(
bh
))

387  
	`PTR_ERR
(
bh
);

389 
eh
 = (
pxt4_exã¡_hódî
 *)
bh
->
b_d©a
;

390 i‡(
eh
->
eh_dïth
 != 0) {

391 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

392 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

393 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

394 i‡(
ªtvÆ
)

398 
	`put_bh
(
bh
);

399 
	`exãnd_¸edô_f‹_blkdñ
(
h™dÀ
, 
öode
);

400 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

401 
PXT4_FREE_BLOCKS_METADATA
 | 
PXT4_FREE_BLOCKS_FORGET
);

402  
ªtvÆ
;

403 
	}
}

408 
	$‰ì_ext_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

410 
i
, 
ªtvÆ
 = 0;

411 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

412 
pxt4_exã¡_hódî
 *
eh
 = (pxt4_exã¡_hódî *)
ei
->
i_d©a
;

413 
pxt4_exã¡_idx
 *
ix
;

414 i‡(
eh
->
eh_dïth
 == 0)

419 
ix
 = 
	`EXT_FIRST_INDEX
(
eh
);

420 
i
 = 0; i < 
	`À16_to_˝u
(
eh
->
eh_íåõs
); i++, 
ix
++) {

421 
ªtvÆ
 = 
	`‰ì_ext_idx
(
h™dÀ
, 
öode
, 
ix
);

422 i‡(
ªtvÆ
)

423  
ªtvÆ
;

425  
ªtvÆ
;

426 
	}
}

428 
	$pxt4_ext_migøã
(
öode
 *inode)

430 
h™dÀ_t
 *
h™dÀ
;

431 
ªtvÆ
 = 0, 
i
;

432 
__À32
 *
i_d©a
;

433 
pxt4_öode_öfo
 *
ei
;

434 
öode
 *
tmp_öode
 = 
NULL
;

435 
migøã_°ru˘
 
lb
;

436 
max_íåõs
;

437 
__u32
 
gﬂl
;

438 
uid_t
 
ow√r
[2];

444 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

445 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

446  -
EINVAL
;

448 i‡(
	`S_ISLNK
(
öode
->
i_mode
Ë&& inode->
i_blocks
 == 0)

452  
ªtvÆ
;

459 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
,

460 4 + 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
öode
->
i_sb
));

462 i‡(
	`IS_ERR
(
h™dÀ
)) {

463 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

464  
ªtvÆ
;

466 
gﬂl
 = (((
öode
->
i_öo
 - 1Ë/ 
	`PXT4_INODES_PER_GROUP
(öode->
i_sb
)) *

467 
	`PXT4_INODES_PER_GROUP
(
öode
->
i_sb
)) + 1;

468 
ow√r
[0] = 
	`i_uid_ªad
(
öode
);

469 
ow√r
[1] = 
	`i_gid_ªad
(
öode
);

470 
tmp_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
	`d_öode
(
öode
->
i_sb
->
s_roŸ
),

471 
S_IFREG
, 
NULL
, 
gﬂl
, 
ow√r
, 0);

472 i‡(
	`IS_ERR
(
tmp_öode
)) {

473 
ªtvÆ
 = 
	`PTR_ERR
(
tmp_öode
);

474 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

475  
ªtvÆ
;

477 
	`i_size_wrôe
(
tmp_öode
, 
	`i_size_ªad
(
öode
));

482 
	`˛ór_∆ök
(
tmp_öode
);

484 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

485 
	`pxt4_‹ph™_add
(
h™dÀ
, 
tmp_öode
);

486 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

504 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

505 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_EXT_MIGRATE
);

506 
	`up_ªad
((&
	`PXT4_I
(
öode
)->
i_d©a_£m
));

508 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

509 i‡(
	`IS_ERR
(
h™dÀ
)) {

515 
	`pxt4_‹ph™_dñ
(
NULL
, 
tmp_öode
);

516 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

517 
out
;

520 
ei
 = 
	`PXT4_I
(
öode
);

521 
i_d©a
 = 
ei
->i_data;

522 
	`mem£t
(&
lb
, 0, (lb));

525 
max_íåõs
 = 
öode
->
i_sb
->
s_blocksize
 >> 2;

526 
i
 = 0; i < 
PXT4_NDIR_BLOCKS
; i++) {

527 i‡(
i_d©a
[
i
]) {

528 
ªtvÆ
 = 
	`upd©e_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

529 
	`À32_to_˝u
(
i_d©a
[
i
]), &
lb
);

530 i‡(
ªtvÆ
)

531 
îr_out
;

533 
lb
.
cuº_block
++;

535 i‡(
i_d©a
[
PXT4_IND_BLOCK
]) {

536 
ªtvÆ
 = 
	`upd©e_öd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

537 
	`À32_to_˝u
(
i_d©a
[
PXT4_IND_BLOCK
]), &
lb
);

538 i‡(
ªtvÆ
)

539 
îr_out
;

541 
lb
.
cuº_block
 +
max_íåõs
;

542 i‡(
i_d©a
[
PXT4_DIND_BLOCK
]) {

543 
ªtvÆ
 = 
	`upd©e_död_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

544 
	`À32_to_˝u
(
i_d©a
[
PXT4_DIND_BLOCK
]), &
lb
);

545 i‡(
ªtvÆ
)

546 
îr_out
;

548 
lb
.
cuº_block
 +
max_íåõs
 * max_entries;

549 i‡(
i_d©a
[
PXT4_TIND_BLOCK
]) {

550 
ªtvÆ
 = 
	`upd©e_töd_exã¡_ønge
(
h™dÀ
, 
tmp_öode
,

551 
	`À32_to_˝u
(
i_d©a
[
PXT4_TIND_BLOCK
]), &
lb
);

552 i‡(
ªtvÆ
)

553 
îr_out
;

558 
ªtvÆ
 = 
	`föish_ønge
(
h™dÀ
, 
tmp_öode
, &
lb
);

559 
îr_out
:

560 i‡(
ªtvÆ
)

565 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

567 
ªtvÆ
 = 
	`pxt4_ext_sw≠_öode_d©a
(
h™dÀ
, 
öode
, 
tmp_öode
);

568 i‡(
ªtvÆ
)

573 
	`‰ì_ext_block
(
h™dÀ
, 
tmp_öode
);

577 i‡(
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 1) != 0)

578 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 1);

583 
	`i_size_wrôe
(
tmp_öode
, 0);

593 
tmp_öode
->
i_blocks
 = 0;

596 
	`pxt4_ext_åì_öô
(
h™dÀ
, 
tmp_öode
);

597 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

598 
out
:

599 
	`u∆ock_√w_öode
(
tmp_öode
);

600 
	`ùut
(
tmp_öode
);

602  
ªtvÆ
;

603 
	}
}

608 
	$pxt4_öd_migøã
(
öode
 *inode)

610 
pxt4_exã¡_hódî
 *
eh
;

611 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

612 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

613 
pxt4_exã¡
 *
ex
;

614 
i
, 
Àn
;

615 
pxt4_lblk_t
 
°¨t
, 
íd
;

616 
pxt4_fsblk_t
 
blk
;

617 
h™dÀ_t
 *
h™dÀ
;

618 
ªt
;

620 i‡(!
	`pxt4_has_„©uª_exã¡s
(
öode
->
i_sb
) ||

621 (!
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

622  -
EINVAL
;

624 i‡(
	`pxt4_has_„©uª_bigÆloc
(
öode
->
i_sb
))

625  -
EOPNOTSUPP
;

632 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))

633 
	`pxt4_Æloc_da_blocks
(
öode
);

635 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MIGRATE
, 1);

636 i‡(
	`IS_ERR
(
h™dÀ
))

637  
	`PTR_ERR
(
h™dÀ
);

639 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

640 
ªt
 = 
	`pxt4_ext_check_öode
(
öode
);

641 i‡(
ªt
)

642 
îrout
;

644 
eh
 = 
	`ext_öode_hdr
(
öode
);

645 
ex
 = 
	`EXT_FIRST_EXTENT
(
eh
);

646 i‡(
	`pxt4_blocks_cou¡
(
es
Ë> 
PXT4_MAX_BLOCK_FILE_PHYS
 ||

647 
eh
->
eh_dïth
 !0 || 
	`À16_to_˝u
”h->
eh_íåõs
) > 1) {

648 
ªt
 = -
EOPNOTSUPP
;

649 
îrout
;

651 i‡(
eh
->
eh_íåõs
 == 0)

652 
blk
 = 
Àn
 = 
°¨t
 = 
íd
 = 0;

654 
Àn
 = 
	`À16_to_˝u
(
ex
->
ì_Àn
);

655 
blk
 = 
	`pxt4_ext_pblock
(
ex
);

656 
°¨t
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

657 
íd
 = 
°¨t
 + 
Àn
 - 1;

658 i‡(
íd
 >
PXT4_NDIR_BLOCKS
) {

659 
ªt
 = -
EOPNOTSUPP
;

660 
îrout
;

664 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

665 
	`mem£t
(
ei
->
i_d©a
, 0, (ei->i_data));

666 
i
 = 
°¨t
; i <
íd
; i++)

667 
ei
->
i_d©a
[
i
] = 
	`˝u_to_À32
(
blk
++);

668 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

669 
îrout
:

670 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

671 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

672  
ªt
;

673 
	}
}

	@mmp.c

2 
	~<löux/fs.h
>

3 
	~<löux/øndom.h
>

4 
	~<löux/buf„r_hód.h
>

5 
	~<löux/ut¢ame.h
>

6 
	~<löux/kthªad.h
>

8 
	~"pxt4.h
"

11 
__À32
 
	$pxt4_mmp_csum
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

13 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

14 
off£t
 = 
	`off£tof
(
mmp_°ru˘
, 
mmp_checksum
);

15 
__u32
 
csum
;

17 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (*)
mmp
, 
off£t
);

19  
	`˝u_to_À32
(
csum
);

20 
	}
}

22 
	$pxt4_mmp_csum_vîify
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

24 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

27  
mmp
->
mmp_checksum
 =
	`pxt4_mmp_csum
(
sb
, mmp);

28 
	}
}

30 
	$pxt4_mmp_csum_£t
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
)

32 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

35 
mmp
->
mmp_checksum
 = 
	`pxt4_mmp_csum
(
sb
, mmp);

36 
	}
}

42 
	$wrôe_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 *
bh
)

44 
mmp_°ru˘
 *
mmp
 = (mmp_°ru˘ *)(
bh
->
b_d©a
);

50 
	`sb_°¨t_wrôe
(
sb
);

51 
	`pxt4_mmp_csum_£t
(
sb
, 
mmp
);

52 
	`lock_buf„r
(
bh
);

53 
bh
->
b_íd_io
 = 
íd_buf„r_wrôe_sync
;

54 
	`gë_bh
(
bh
);

55 
	`submô_bh
(
REQ_OP_WRITE
, 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

56 
	`waô_⁄_buf„r
(
bh
);

57 
	`sb_íd_wrôe
(
sb
);

58 i‡(
	`u∆ikñy
(!
	`buf„r_u±od©e
(
bh
)))

62 
	}
}

68 
	$ªad_mmp_block
(
su≥r_block
 *
sb
, 
buf„r_hód
 **
bh
,

69 
pxt4_fsblk_t
 
mmp_block
)

71 
mmp_°ru˘
 *
mmp
;

72 
ªt
;

74 i‡(*
bh
)

75 
	`˛ór_buf„r_u±od©e
(*
bh
);

80 i‡(!*
bh
) {

81 *
bh
 = 
	`sb_gëblk
(
sb
, 
mmp_block
);

82 i‡(!*
bh
) {

83 
ªt
 = -
ENOMEM
;

84 
w¨n_exô
;

88 
	`gë_bh
(*
bh
);

89 
	`lock_buf„r
(*
bh
);

90 (*
bh
)->
b_íd_io
 = 
íd_buf„r_ªad_sync
;

91 
	`submô_bh
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, *
bh
);

92 
	`waô_⁄_buf„r
(*
bh
);

93 i‡(!
	`buf„r_u±od©e
(*
bh
)) {

94 
ªt
 = -
EIO
;

95 
w¨n_exô
;

97 
mmp
 = (
mmp_°ru˘
 *)((*
bh
)->
b_d©a
);

98 i‡(
	`À32_to_˝u
(
mmp
->
mmp_magic
Ë!
PXT4_MMP_MAGIC
) {

99 
ªt
 = -
EFSCORRUPTED
;

100 
w¨n_exô
;

102 i‡(!
	`pxt4_mmp_csum_vîify
(
sb
, 
mmp
)) {

103 
ªt
 = -
EFSBADCRC
;

104 
w¨n_exô
;

107 
w¨n_exô
:

108 
	`bªl£
(*
bh
);

109 *
bh
 = 
NULL
;

110 
	`pxt4_w¨nög
(
sb
, "Error %d whileÑeading MMP block %llu",

111 
ªt
, 
mmp_block
);

112  
ªt
;

113 
	}
}

118 
	$__dump_mmp_msg
(
su≥r_block
 *
sb
, 
mmp_°ru˘
 *
mmp
,

119 c⁄° *
fun˘i⁄
, 
löe
, c⁄° *
msg
)

121 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
, "%s", 
msg
);

122 
	`__pxt4_w¨nög
(
sb
, 
fun˘i⁄
, 
löe
,

125 (Ë
	`À64_to_˝u
(
mmp
->
mmp_time
),

126 
mmp
->
mmp_nodíame
, mmp->
mmp_bdev«me
);

127 
	}
}

132 
	$kmmpd
(*
d©a
)

134 
su≥r_block
 *
sb
 = ((
mmpd_d©a
 *Ë
d©a
)->sb;

135 
buf„r_hód
 *
bh
 = ((
mmpd_d©a
 *Ë
d©a
)->bh;

136 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

137 
mmp_°ru˘
 *
mmp
;

138 
pxt4_fsblk_t
 
mmp_block
;

139 
u32
 
£q
 = 0;

140 
Áûed_wrôes
 = 0;

141 
mmp_upd©e_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

142 
mmp_check_öãrvÆ
;

143 
œ°_upd©e_time
;

144 
diff
;

145 
ªtvÆ
;

147 
mmp_block
 = 
	`À64_to_˝u
(
es
->
s_mmp_block
);

148 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

149 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

154 
mmp_check_öãrvÆ
 = 
	`max
(
PXT4_MMP_CHECK_MULT
 * 
mmp_upd©e_öãrvÆ
,

155 
PXT4_MMP_MIN_CHECK_INTERVAL
);

156 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

157 
	`bdev«me
(
bh
->
b_bdev
, 
mmp
->
mmp_bdev«me
);

159 
	`mem˝y
(
mmp
->
mmp_nodíame
, 
	`öô_ut¢ame
()->
nodíame
,

160 (
mmp
->
mmp_nodíame
));

162 !
	`kthªad_should_°›
()) {

163 i‡(++
£q
 > 
PXT4_MMP_SEQ_MAX
)

164 
£q
 = 1;

166 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

167 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

168 
œ°_upd©e_time
 = 
jiffõs
;

170 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

175 i‡(
ªtvÆ
) {

176 i‡((
Áûed_wrôes
 % 60) == 0)

177 
	`pxt4_îr‹
(
sb
, "Error writingÅo MMP block");

178 
Áûed_wrôes
++;

181 i‡(!(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

182 
PXT4_FEATURE_INCOMPAT_MMP
)) {

183 
	`pxt4_w¨nög
(
sb
, "kmmpd being stopped since MMP feature"

185 
exô_thªad
;

188 i‡(
	`sb_rd⁄ly
(
sb
))

191 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

192 i‡(
diff
 < 
mmp_upd©e_öãrvÆ
 * 
HZ
)

193 
	`scheduÀ_timeout_öãºu±ibÀ
(
mmp_upd©e_öãrvÆ
 *

194 
HZ
 - 
diff
);

201 
diff
 = 
jiffõs
 - 
œ°_upd©e_time
;

202 i‡(
diff
 > 
mmp_check_öãrvÆ
 * 
HZ
) {

203 
buf„r_hód
 *
bh_check
 = 
NULL
;

204 
mmp_°ru˘
 *
mmp_check
;

206 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh_check
, 
mmp_block
);

207 i‡(
ªtvÆ
) {

208 
	`pxt4_îr‹
(
sb
, "errorÑeading MMP data: %d",

209 
ªtvÆ
);

210 
exô_thªad
;

213 
mmp_check
 = (
mmp_°ru˘
 *)(
bh_check
->
b_d©a
);

214 i‡(
mmp
->
mmp_£q
 !
mmp_check
->mmp_seq ||

215 
	`memcmp
(
mmp
->
mmp_nodíame
, 
mmp_check
->mmp_nodename,

216 (
mmp
->
mmp_nodíame
))) {

217 
	`dump_mmp_msg
(
sb
, 
mmp_check
,

221 
	`pxt4_îr‹
(
sb
, "abort");

222 
	`put_bh
(
bh_check
);

223 
ªtvÆ
 = -
EBUSY
;

224 
exô_thªad
;

226 
	`put_bh
(
bh_check
);

233 
mmp_check_öãrvÆ
 = 
	`max
(
	`mö
(
PXT4_MMP_CHECK_MULT
 * 
diff
 / 
HZ
,

234 
PXT4_MMP_MAX_CHECK_INTERVAL
),

235 
PXT4_MMP_MIN_CHECK_INTERVAL
);

236 
mmp
->
mmp_check_öãrvÆ
 = 
	`˝u_to_À16
(mmp_check_interval);

242 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
PXT4_MMP_SEQ_CLEAN
);

243 
mmp
->
mmp_time
 = 
	`˝u_to_À64
(
	`ktime_gë_ªÆ_£c⁄ds
());

245 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

247 
exô_thªad
:

248 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

249 
	`k‰ì
(
d©a
);

250 
	`bªl£
(
bh
);

251  
ªtvÆ
;

252 
	}
}

258 
	$mmp_√w_£q
()

260 
u32
 
√w_£q
;

263 
√w_£q
 = 
	`¥™dom_u32
();

264 } 
√w_£q
 > 
PXT4_MMP_SEQ_MAX
);

266  
√w_£q
;

267 
	}
}

272 
	$pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *
sb
,

273 
pxt4_fsblk_t
 
mmp_block
)

275 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

276 
buf„r_hód
 *
bh
 = 
NULL
;

277 
mmp_°ru˘
 *
mmp
 = 
NULL
;

278 
mmpd_d©a
 *mmpd_data;

279 
u32
 
£q
;

280 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
es
->
s_mmp_upd©e_öãrvÆ
);

281 
waô_time
 = 0;

282 
ªtvÆ
;

284 i‡(
mmp_block
 < 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) ||

285 
mmp_block
 >
	`pxt4_blocks_cou¡
(
es
)) {

286 
	`pxt4_w¨nög
(
sb
, "Invalid MMP block in superblock");

287 
Áûed
;

290 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

291 i‡(
ªtvÆ
)

292 
Áûed
;

294 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

296 i‡(
mmp_check_öãrvÆ
 < 
PXT4_MMP_MIN_CHECK_INTERVAL
)

297 
mmp_check_öãrvÆ
 = 
PXT4_MMP_MIN_CHECK_INTERVAL
;

303 i‡(
	`À16_to_˝u
(
mmp
->
mmp_check_öãrvÆ
) > mmp_check_interval)

304 
mmp_check_öãrvÆ
 = 
	`À16_to_˝u
(
mmp
->mmp_check_interval);

306 
£q
 = 
	`À32_to_˝u
(
mmp
->
mmp_£q
);

307 i‡(
£q
 =
PXT4_MMP_SEQ_CLEAN
)

308 
skù
;

310 i‡(
£q
 =
PXT4_MMP_SEQ_FSCK
) {

311 
	`dump_mmp_msg
(
sb
, 
mmp
, "fsck isÑunning onÅhe filesystem");

312 
Áûed
;

315 
waô_time
 = 
	`mö
(
mmp_check_öãrvÆ
 * 2 + 1,

316 
mmp_check_öãrvÆ
 + 60);

319 i‡(
waô_time
 > 
PXT4_MMP_MIN_CHECK_INTERVAL
 * 4)

320 
	`pxt4_w¨nög
(
sb
, "MMP interval %u higherÅhanÉxpected,Ölease"

321 " waô.\n", 
waô_time
 * 2);

323 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

324 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount\n");

325 
Áûed
;

328 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

329 i‡(
ªtvÆ
)

330 
Áûed
;

331 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

332 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

333 
	`dump_mmp_msg
(
sb
, 
mmp
,

335 
Áûed
;

338 
skù
:

342 
£q
 = 
	`mmp_√w_£q
();

343 
mmp
->
mmp_£q
 = 
	`˝u_to_À32
(
£q
);

345 
ªtvÆ
 = 
	`wrôe_mmp_block
(
sb
, 
bh
);

346 i‡(
ªtvÆ
)

347 
Áûed
;

352 i‡(
	`scheduÀ_timeout_öãºu±ibÀ
(
HZ
 * 
waô_time
) != 0) {

353 
	`pxt4_w¨nög
(
sb
, "MMP startup interrupted, failing mount");

354 
Áûed
;

357 
ªtvÆ
 = 
	`ªad_mmp_block
(
sb
, &
bh
, 
mmp_block
);

358 i‡(
ªtvÆ
)

359 
Áûed
;

360 
mmp
 = (
mmp_°ru˘
 *)(
bh
->
b_d©a
);

361 i‡(
£q
 !
	`À32_to_˝u
(
mmp
->
mmp_£q
)) {

362 
	`dump_mmp_msg
(
sb
, 
mmp
,

364 
Áûed
;

367 
mmpd_d©a
 = 
	`kmÆloc
((*mmpd_d©a), 
GFP_KERNEL
);

368 i‡(!
mmpd_d©a
) {

369 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for mmpd_data");

370 
Áûed
;

372 
mmpd_d©a
->
sb
 = sb;

373 
mmpd_d©a
->
bh
 = bh;

378 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
	`kthªad_run
(
kmmpd
, 
mmpd_d©a
, "kmmpd-%s",

379 
	`bdev«me
(
bh
->
b_bdev
,

380 
mmp
->
mmp_bdev«me
));

381 i‡(
	`IS_ERR
(
	`PXT4_SB
(
sb
)->
s_mmp_tsk
)) {

382 
	`PXT4_SB
(
sb
)->
s_mmp_tsk
 = 
NULL
;

383 
	`k‰ì
(
mmpd_d©a
);

384 
	`pxt4_w¨nög
(
sb
, "UnableÅo create kmmpdÅhread for %s.",

385 
sb
->
s_id
);

386 
Áûed
;

391 
Áûed
:

392 
	`bªl£
(
bh
);

394 
	}
}

	@move_extent.c

8 
	~<löux/fs.h
>

9 
	~<löux/quŸa›s.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"pxt4_exã¡s.h
"

25 
ölöe
 

26 
	$gë_ext_∑th
(
öode
 *öode, 
pxt4_lblk_t
 
lblock
,

27 
pxt4_ext_∑th
 **
µ©h
)

29 
pxt4_ext_∑th
 *
∑th
;

31 
∑th
 = 
	`pxt4_föd_exã¡
(
öode
, 
lblock
, 
µ©h
, 
PXT4_EX_NOCACHE
);

32 i‡(
	`IS_ERR
(
∑th
))

33  
	`PTR_ERR
(
∑th
);

34 i‡(
∑th
[
	`ext_dïth
(
öode
)].
p_ext
 =
NULL
) {

35 
	`pxt4_ext_dr›_ªfs
(
∑th
);

36 
	`k‰ì
(
∑th
);

37 *
µ©h
 = 
NULL
;

38  -
ENODATA
;

40 *
µ©h
 = 
∑th
;

42 
	}
}

51 
	$pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
, öodê*
£c⁄d
)

53 i‡(
fú°
 < 
£c⁄d
) {

54 
	`down_wrôe
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
);

55 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

57 
	`down_wrôe
(&
	`PXT4_I
(
£c⁄d
)->
i_d©a_£m
);

58 
	`down_wrôe_√°ed
(&
	`PXT4_I
(
fú°
)->
i_d©a_£m
, 
I_DATA_SEM_OTHER
);

61 
	}
}

71 
	$pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

72 
öode
 *
d⁄‹_öode
)

74 
	`up_wrôe
(&
	`PXT4_I
(
‹ig_öode
)->
i_d©a_£m
);

75 
	`up_wrôe
(&
	`PXT4_I
(
d⁄‹_öode
)->
i_d©a_£m
);

76 
	}
}

90 
	$mext_check_covîage
(
öode
 *öode, 
pxt4_lblk_t
 
‰om
,Öxt4_lblk_à
cou¡
,

91 
unwrôãn
, *
îr
)

93 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

94 
pxt4_exã¡
 *
ext
;

95 
ªt
 = 0;

96 
pxt4_lblk_t
 
œ°
 = 
‰om
 + 
cou¡
;

97 
‰om
 < 
œ°
) {

98 *
îr
 = 
	`gë_ext_∑th
(
öode
, 
‰om
, &
∑th
);

99 i‡(*
îr
)

100 
out
;

101 
ext
 = 
∑th
[
	`ext_dïth
(
öode
)].
p_ext
;

102 i‡(
unwrôãn
 !
	`pxt4_ext_is_unwrôãn
(
ext
))

103 
out
;

104 
‰om
 +
	`pxt4_ext_gë_a˘uÆ_Àn
(
ext
);

105 
	`pxt4_ext_dr›_ªfs
(
∑th
);

107 
ªt
 = 1;

108 
out
:

109 
	`pxt4_ext_dr›_ªfs
(
∑th
);

110 
	`k‰ì
(
∑th
);

111  
ªt
;

112 
	}
}

126 
	$mext_∑ge_doubÀ_lock
(
öode
 *
öode1
, öodê*
öode2
,

127 
pgoff_t
 
ödex1
,Ögoff_à
ödex2
, 
∑ge
 *page[2])

129 
addªss_•a˚
 *
m≠pög
[2];

130 
Ê
 = 
AOP_FLAG_NOFS
;

132 
	`BUG_ON
(!
öode1
 || !
öode2
);

133 i‡(
öode1
 < 
öode2
) {

134 
m≠pög
[0] = 
öode1
->
i_m≠pög
;

135 
m≠pög
[1] = 
öode2
->
i_m≠pög
;

137 
	`sw≠
(
ödex1
, 
ödex2
);

138 
m≠pög
[0] = 
öode2
->
i_m≠pög
;

139 
m≠pög
[1] = 
öode1
->
i_m≠pög
;

142 
∑ge
[0] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[0], 
ödex1
, 
Ê
);

143 i‡(!
∑ge
[0])

144  -
ENOMEM
;

146 
∑ge
[1] = 
	`gøb_ˇche_∑ge_wrôe_begö
(
m≠pög
[1], 
ödex2
, 
Ê
);

147 i‡(!
∑ge
[1]) {

148 
	`u∆ock_∑ge
(
∑ge
[0]);

149 
	`put_∑ge
(
∑ge
[0]);

150  -
ENOMEM
;

157 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[0]);

158 
	`waô_⁄_∑ge_wrôeback
(
∑ge
[1]);

159 i‡(
öode1
 > 
öode2
)

160 
	`sw≠
(
∑ge
[0],Öage[1]);

163 
	}
}

167 
	$mext_∑ge_mku±od©e
(
∑ge
 *∑ge, 
‰om
, 
to
)

169 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

170 
£˘‹_t
 
block
;

171 
buf„r_hód
 *
bh
, *
hód
, *
¨r
[
MAX_BUF_PER_PAGE
];

172 
blocksize
, 
block_°¨t
, 
block_íd
;

173 
i
, 
îr
, 
ƒ
 = 0, 
∑πül
 = 0;

174 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

175 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

177 i‡(
	`PageU±od©e
(
∑ge
))

180 
blocksize
 = 
	`i_blocksize
(
öode
);

181 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

182 
	`¸óã_em±y_buf„rs
(
∑ge
, 
blocksize
, 0);

184 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

185 
block
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
öode
->
i_blkbôs
);

186 
bh
 = 
hód
, 
block_°¨t
 = 0; bh != head || !block_start;

187 
block
++, 
block_°¨t
 = 
block_íd
, 
bh
 = bh->
b_this_∑ge
) {

188 
block_íd
 = 
block_°¨t
 + 
blocksize
;

189 i‡(
block_íd
 <
‰om
 || 
block_°¨t
 >
to
) {

190 i‡(!
	`buf„r_u±od©e
(
bh
))

191 
∑πül
 = 1;

194 i‡(
	`buf„r_u±od©e
(
bh
))

196 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

197 
îr
 = 
	`pxt4_gë_block
(
öode
, 
block
, 
bh
, 0);

198 i‡(
îr
) {

199 
	`SëPageEº‹
(
∑ge
);

200  
îr
;

202 i‡(!
	`buf„r_m≠≥d
(
bh
)) {

203 
	`zîo_u£r
(
∑ge
, 
block_°¨t
, 
blocksize
);

204 
	`£t_buf„r_u±od©e
(
bh
);

208 
	`BUG_ON
(
ƒ
 >
MAX_BUF_PER_PAGE
);

209 
¨r
[
ƒ
++] = 
bh
;

212 i‡(!
ƒ
)

213 
out
;

215 
i
 = 0; i < 
ƒ
; i++) {

216 
bh
 = 
¨r
[
i
];

217 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

218 
îr
 = 
	`bh_submô_ªad
(
bh
);

219 i‡(
îr
)

220  
îr
;

223 
out
:

224 i‡(!
∑πül
)

225 
	`SëPageU±od©e
(
∑ge
);

227 
	}
}

247 
	$move_exã¡_≥r_∑ge
(
fûe
 *
o_fûp
, 
öode
 *
d⁄‹_öode
,

248 
pgoff_t
 
‹ig_∑ge_off£t
,Ögoff_à
d⁄‹_∑ge_off£t
,

249 
d©a_off£t_ö_∑ge
,

250 
block_Àn_ö_∑ge
, 
unwrôãn
, *
îr
)

252 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

253 
∑ge
 *
∑gï
[2] = {
NULL
, NULL};

254 
h™dÀ_t
 *
h™dÀ
;

255 
pxt4_lblk_t
 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
;

256 
blocksize
 = 
‹ig_öode
->
i_sb
->
s_blocksize
;

257 
tmp_d©a_size
, 
d©a_size
, 
ª∂a˚d_size
;

258 
i
, 
îr2
, 
jblocks
, 
ªåõs
 = 0;

259 
ª∂a˚d_cou¡
 = 0;

260 
‰om
 = 
d©a_off£t_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

261 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

262 
su≥r_block
 *
sb
 = 
‹ig_öode
->
i_sb
;

263 
buf„r_hód
 *
bh
 = 
NULL
;

269 
agaö
:

270 *
îr
 = 0;

271 
jblocks
 = 
	`pxt4_wrôïage_å™s_blocks
(
‹ig_öode
) * 2;

272 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
‹ig_öode
, 
PXT4_HT_MOVE_EXTENTS
, 
jblocks
);

273 i‡(
	`IS_ERR
(
h™dÀ
)) {

274 *
îr
 = 
	`PTR_ERR
(
h™dÀ
);

278 
‹ig_blk_off£t
 = 
‹ig_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

279 
d©a_off£t_ö_∑ge
;

281 
d⁄‹_blk_off£t
 = 
d⁄‹_∑ge_off£t
 * 
blocks_≥r_∑ge
 +

282 
d©a_off£t_ö_∑ge
;

285 i‡((
‹ig_blk_off£t
 + 
block_Àn_ö_∑ge
 - 1) ==

286 ((
‹ig_öode
->
i_size
 - 1Ë>> orig_öode->
i_blkbôs
)) {

288 
tmp_d©a_size
 = 
‹ig_öode
->
i_size
 & (
blocksize
 - 1);

293 i‡(
tmp_d©a_size
 == 0)

294 
tmp_d©a_size
 = 
blocksize
;

296 
d©a_size
 = 
tmp_d©a_size
 +

297 ((
block_Àn_ö_∑ge
 - 1Ë<< 
‹ig_öode
->
i_blkbôs
);

299 
d©a_size
 = 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

301 
ª∂a˚d_size
 = 
d©a_size
;

303 *
îr
 = 
	`mext_∑ge_doubÀ_lock
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_∑ge_off£t
,

304 
d⁄‹_∑ge_off£t
, 
∑gï
);

305 i‡(
	`u∆ikñy
(*
îr
 < 0))

306 
°›_jou∫Æ
;

314 i‡(
unwrôãn
) {

315 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

318 
unwrôãn
 = 
	`mext_check_covîage
(
‹ig_öode
, 
‹ig_blk_off£t
,

319 
block_Àn_ö_∑ge
, 1, 
îr
);

320 i‡(*
îr
)

321 
dr›_d©a_£m
;

323 
unwrôãn
 &
	`mext_check_covîage
(
d⁄‹_öode
, 
d⁄‹_blk_off£t
,

324 
block_Àn_ö_∑ge
, 1, 
îr
);

325 i‡(*
îr
)

326 
dr›_d©a_£m
;

328 i‡(!
unwrôãn
) {

329 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

330 
d©a_c›y
;

332 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]) &&

333 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[0], 0)) ||

334 (
	`∑ge_has_¥iv©e
(
∑gï
[1]) &&

335 !
	`åy_to_ªÀa£_∑ge
(
∑gï
[1], 0))) {

336 *
îr
 = -
EBUSY
;

337 
dr›_d©a_£m
;

339 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
,

340 
d⁄‹_öode
, 
‹ig_blk_off£t
,

341 
d⁄‹_blk_off£t
,

342 
block_Àn_ö_∑ge
, 1, 
îr
);

343 
dr›_d©a_£m
:

344 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

345 
u∆ock_∑ges
;

347 
d©a_c›y
:

348 *
îr
 = 
	`mext_∑ge_mku±od©e
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

349 i‡(*
îr
)

350 
u∆ock_∑ges
;

354 i‡((
	`∑ge_has_¥iv©e
(
∑gï
[0]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[0], 0)) ||

355 (
	`∑ge_has_¥iv©e
(
∑gï
[1]Ë&& !
	`åy_to_ªÀa£_∑ge
(pagep[1], 0))) {

356 *
îr
 = -
EBUSY
;

357 
u∆ock_∑ges
;

359 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

360 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
‹ig_öode
, 
d⁄‹_öode
,

361 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

362 
block_Àn_ö_∑ge
, 1, 
îr
);

363 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

364 i‡(*
îr
) {

365 i‡(
ª∂a˚d_cou¡
) {

366 
block_Àn_ö_∑ge
 = 
ª∂a˚d_cou¡
;

367 
ª∂a˚d_size
 =

368 
block_Àn_ö_∑ge
 << 
‹ig_öode
->
i_blkbôs
;

370 
u∆ock_∑ges
;

374 i‡(!
	`∑ge_has_buf„rs
(
∑gï
[0]))

375 
	`¸óã_em±y_buf„rs
(
∑gï
[0], 1 << 
‹ig_öode
->
i_blkbôs
, 0);

376 
bh
 = 
	`∑ge_buf„rs
(
∑gï
[0]);

377 
i
 = 0; i < 
d©a_off£t_ö_∑ge
; i++)

378 
bh
 = bh->
b_this_∑ge
;

379 
i
 = 0; i < 
block_Àn_ö_∑ge
; i++) {

380 *
îr
 = 
	`pxt4_gë_block
(
‹ig_öode
, 
‹ig_blk_off£t
 + 
i
, 
bh
, 0);

381 i‡(*
îr
 < 0)

383 
bh
 = bh->
b_this_∑ge
;

385 i‡(!*
îr
)

386 *
îr
 = 
	`block_commô_wrôe
(
∑gï
[0], 
‰om
, from + 
ª∂a˚d_size
);

388 i‡(
	`u∆ikñy
(*
îr
 < 0))

389 
ª∑ú_bønches
;

393 *
îr
 = 
	`pxt4_jbd3_öode_add_wrôe
(
h™dÀ
, 
‹ig_öode
);

395 
u∆ock_∑ges
:

396 
	`u∆ock_∑ge
(
∑gï
[0]);

397 
	`put_∑ge
(
∑gï
[0]);

398 
	`u∆ock_∑ge
(
∑gï
[1]);

399 
	`put_∑ge
(
∑gï
[1]);

400 
°›_jou∫Æ
:

401 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

402 i‡(*
îr
 =-
ENOSPC
 &&

403 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

404 
agaö
;

407 i‡(*
îr
 =-
EBUSY
 && 
ªåõs
++ < 4 && 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

408 
	`jbd3_jou∫Æ_f‹˚_commô_√°ed
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
))

409 
agaö
;

410  
ª∂a˚d_cou¡
;

412 
ª∑ú_bønches
:

418 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

419 
ª∂a˚d_cou¡
 = 
	`pxt4_sw≠_exã¡s
(
h™dÀ
, 
d⁄‹_öode
, 
‹ig_öode
,

420 
‹ig_blk_off£t
, 
d⁄‹_blk_off£t
,

421 
block_Àn_ö_∑ge
, 0, &
îr2
);

422 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

423 i‡(
ª∂a˚d_cou¡
 !
block_Àn_ö_∑ge
) {

424 
	`PXT4_ERROR_INODE_BLOCK
(
‹ig_öode
, (
£˘‹_t
)(
‹ig_blk_off£t
),

427 *
îr
 = -
EIO
;

429 
ª∂a˚d_cou¡
 = 0;

430 
u∆ock_∑ges
;

431 
	}
}

447 
	$mext_check_¨gumíts
(
öode
 *
‹ig_öode
,

448 
öode
 *
d⁄‹_öode
, 
__u64
 
‹ig_°¨t
,

449 
__u64
 
d⁄‹_°¨t
, __u64 *
Àn
)

451 
__u64
 
‹ig_eof
, 
d⁄‹_eof
;

452 
blkbôs
 = 
‹ig_öode
->
i_blkbôs
;

453 
blocksize
 = 1 << 
blkbôs
;

455 
‹ig_eof
 = (
	`i_size_ªad
(
‹ig_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

456 
d⁄‹_eof
 = (
	`i_size_ªad
(
d⁄‹_öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

459 i‡(
d⁄‹_öode
->
i_mode
 & (
S_ISUID
|
S_ISGID
)) {

460 
	`pxt4_debug
("pxt4 moveÉxtent: suid or sgid is set"

462 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

463  -
EINVAL
;

466 i‡(
	`IS_IMMUTABLE
(
d⁄‹_öode
Ë|| 
	`IS_APPEND
(donor_inode))

467  -
EPERM
;

470 i‡(
	`IS_SWAPFILE
(
‹ig_öode
Ë|| IS_SWAPFILE(
d⁄‹_öode
)) {

471 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

473 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

474  -
EBUSY
;

477 i‡(
	`pxt4_is_quŸa_fûe
(
‹ig_öode
Ë&&Öxt4_is_quŸa_fûe(
d⁄‹_öode
)) {

478 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should "

480 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

481  -
EBUSY
;

485 i‡(!(
	`pxt4_ã°_öode_Êag
(
‹ig_öode
, 
PXT4_INODE_EXTENTS
))) {

486 
	`pxt4_debug
("pxt4 moveÉxtent: orig file isÇotÉxtents "

487 "ba£d fûê[öo:‹ig %lu]\n", 
‹ig_öode
->
i_öo
);

488  -
EOPNOTSUPP
;

489 } i‡(!(
	`pxt4_ã°_öode_Êag
(
d⁄‹_öode
, 
PXT4_INODE_EXTENTS
))) {

490 
	`pxt4_debug
("pxt4 moveÉxtent: donor file isÇotÉxtents "

491 "ba£d fûê[öo:d⁄‹ %lu]\n", 
d⁄‹_öode
->
i_öo
);

492  -
EOPNOTSUPP
;

495 i‡((!
‹ig_öode
->
i_size
Ë|| (!
d⁄‹_öode
->i_size)) {

496 
	`pxt4_debug
("pxt4 moveÉxtent: File size is 0 byte\n");

497  -
EINVAL
;

501 i‡((
‹ig_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
)) !=

502 (
d⁄‹_°¨t
 & ~(
PAGE_MASK
 >> 
‹ig_öode
->
i_blkbôs
))) {

503 
	`pxt4_debug
("pxt4 moveÉxtent: origánd donor's start "

505 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

506  -
EINVAL
;

509 i‡((
‹ig_°¨t
 >
EXT_MAX_BLOCKS
) ||

510 (
d⁄‹_°¨t
 >
EXT_MAX_BLOCKS
) ||

511 (*
Àn
 > 
EXT_MAX_BLOCKS
) ||

512 (
d⁄‹_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
) ||

513 (
‹ig_°¨t
 + *
Àn
 >
EXT_MAX_BLOCKS
)) {

514 
	`pxt4_debug
("pxt4 moveÉxtent: Can't handle over [%u] blocks "

515 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
EXT_MAX_BLOCKS
,

516 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

517  -
EINVAL
;

519 i‡(
‹ig_eof
 <
‹ig_°¨t
)

520 *
Àn
 = 0;

521 i‡(
‹ig_eof
 < 
‹ig_°¨t
 + *
Àn
 - 1)

522 *
Àn
 = 
‹ig_eof
 - 
‹ig_°¨t
;

523 i‡(
d⁄‹_eof
 <
d⁄‹_°¨t
)

524 *
Àn
 = 0;

525 i‡(
d⁄‹_eof
 < 
d⁄‹_°¨t
 + *
Àn
 - 1)

526 *
Àn
 = 
d⁄‹_eof
 - 
d⁄‹_°¨t
;

527 i‡(!*
Àn
) {

528 
	`pxt4_debug
("pxt4 moveÉxtent:Üen shouldÇot be 0 "

529 "[öo:‹ig %lu, d⁄‹ %lu]\n", 
‹ig_öode
->
i_öo
,

530 
d⁄‹_öode
->
i_öo
);

531  -
EINVAL
;

535 
	}
}

552 
	$pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
, 
__u64
 
‹ig_blk
,

553 
__u64
 
d⁄‹_blk
, __u64 
Àn
, __u64 *
moved_Àn
)

555 
öode
 *
‹ig_öode
 = 
	`fûe_öode
(
o_fûp
);

556 
öode
 *
d⁄‹_öode
 = 
	`fûe_öode
(
d_fûp
);

557 
pxt4_ext_∑th
 *
∑th
 = 
NULL
;

558 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
‹ig_öode
->
i_blkbôs
;

559 
pxt4_lblk_t
 
o_íd
, 
o_°¨t
 = 
‹ig_blk
;

560 
pxt4_lblk_t
 
d_°¨t
 = 
d⁄‹_blk
;

561 
ªt
;

563 i‡(
‹ig_öode
->
i_sb
 !
d⁄‹_öode
->i_sb) {

564 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files "

566 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

567  -
EINVAL
;

571 i‡(
‹ig_öode
 =
d⁄‹_öode
) {

572 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files shouldÇot "

574 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

575  -
EINVAL
;

579 i‡(!
	`S_ISREG
(
‹ig_öode
->
i_mode
Ë|| !S_ISREG(
d⁄‹_öode
->i_mode)) {

580 
	`pxt4_debug
("pxt4 moveÉxtent: Theárgument files should be "

582 
‹ig_öode
->
i_öo
, 
d⁄‹_öode
->i_ino);

583  -
EINVAL
;

588 i‡(
	`pxt4_should_jou∫Æ_d©a
(
‹ig_öode
) ||

589 
	`pxt4_should_jou∫Æ_d©a
(
d⁄‹_öode
)) {

590 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

592  -
EOPNOTSUPP
;

595 i‡(
	`IS_ENCRYPTED
(
‹ig_öode
Ë|| IS_ENCRYPTED(
d⁄‹_öode
)) {

596 
	`pxt4_msg
(
‹ig_öode
->
i_sb
, 
KERN_ERR
,

598  -
EOPNOTSUPP
;

602 
	`lock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

605 
	`öode_dio_waô
(
‹ig_öode
);

606 
	`öode_dio_waô
(
d⁄‹_öode
);

609 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

611 
ªt
 = 
	`mext_check_¨gumíts
(
‹ig_öode
, 
d⁄‹_öode
, 
‹ig_blk
,

612 
d⁄‹_blk
, &
Àn
);

613 i‡(
ªt
)

614 
out
;

615 
o_íd
 = 
o_°¨t
 + 
Àn
;

617 
o_°¨t
 < 
o_íd
) {

618 
pxt4_exã¡
 *
ex
;

619 
pxt4_lblk_t
 
cur_blk
, 
√xt_blk
;

620 
pgoff_t
 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
;

621 
off£t_ö_∑ge
;

622 
unwrôãn
, 
cur_Àn
;

624 
ªt
 = 
	`gë_ext_∑th
(
‹ig_öode
, 
o_°¨t
, &
∑th
);

625 i‡(
ªt
)

626 
out
;

627 
ex
 = 
∑th
[∑th->
p_dïth
].
p_ext
;

628 
√xt_blk
 = 
	`pxt4_ext_√xt_Æloˇãd_block
(
∑th
);

629 
cur_blk
 = 
	`À32_to_˝u
(
ex
->
ì_block
);

630 
cur_Àn
 = 
	`pxt4_ext_gë_a˘uÆ_Àn
(
ex
);

632 i‡(
cur_blk
 + 
cur_Àn
 - 1 < 
o_°¨t
) {

633 i‡(
√xt_blk
 =
EXT_MAX_BLOCKS
) {

634 
o_°¨t
 = 
o_íd
;

635 
ªt
 = -
ENODATA
;

636 
out
;

638 
d_°¨t
 +
√xt_blk
 - 
o_°¨t
;

639 
o_°¨t
 = 
√xt_blk
;

642 } i‡(
cur_blk
 > 
o_°¨t
) {

644 
d_°¨t
 +
cur_blk
 - 
o_°¨t
;

645 
o_°¨t
 = 
cur_blk
;

647 i‡(
cur_blk
 >
o_íd
)

648 
out
;

650 
cur_Àn
 +
cur_blk
 - 
o_°¨t
;

652 
unwrôãn
 = 
	`pxt4_ext_is_unwrôãn
(
ex
);

653 i‡(
o_íd
 - 
o_°¨t
 < 
cur_Àn
)

654 
cur_Àn
 = 
o_íd
 - 
o_°¨t
;

656 
‹ig_∑ge_ödex
 = 
o_°¨t
 >> (
PAGE_SHIFT
 -

657 
‹ig_öode
->
i_blkbôs
);

658 
d⁄‹_∑ge_ödex
 = 
d_°¨t
 >> (
PAGE_SHIFT
 -

659 
d⁄‹_öode
->
i_blkbôs
);

660 
off£t_ö_∑ge
 = 
o_°¨t
 % 
blocks_≥r_∑ge
;

661 i‡(
cur_Àn
 > 
blocks_≥r_∑ge
- 
off£t_ö_∑ge
)

662 
cur_Àn
 = 
blocks_≥r_∑ge
 - 
off£t_ö_∑ge
;

670 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

672 
	`move_exã¡_≥r_∑ge
(
o_fûp
, 
d⁄‹_öode
,

673 
‹ig_∑ge_ödex
, 
d⁄‹_∑ge_ödex
,

674 
off£t_ö_∑ge
, 
cur_Àn
,

675 
unwrôãn
, &
ªt
);

676 
	`pxt4_doubÀ_down_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

677 i‡(
ªt
 < 0)

679 
o_°¨t
 +
cur_Àn
;

680 
d_°¨t
 +
cur_Àn
;

682 *
moved_Àn
 = 
o_°¨t
 - 
‹ig_blk
;

683 i‡(*
moved_Àn
 > 
Àn
)

684 *
moved_Àn
 = 
Àn
;

686 
out
:

687 i‡(*
moved_Àn
) {

688 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
‹ig_öode
);

689 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
d⁄‹_öode
);

692 
	`pxt4_ext_dr›_ªfs
(
∑th
);

693 
	`k‰ì
(
∑th
);

694 
	`pxt4_doubÀ_up_wrôe_d©a_£m
(
‹ig_öode
, 
d⁄‹_öode
);

695 
	`u∆ock_two_n⁄dúe˘‹õs
(
‹ig_öode
, 
d⁄‹_öode
);

697  
ªt
;

698 
	}
}

	@namei.c

28 
	~<löux/fs.h
>

29 
	~<löux/∑gem≠.h
>

30 
	~<löux/time.h
>

31 
	~<löux/f˙é.h
>

32 
	~<löux/°©.h
>

33 
	~<löux/°rög.h
>

34 
	~<löux/quŸa›s.h
>

35 
	~<löux/buf„r_hód.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/ivîsi⁄.h
>

38 
	~"pxt4.h
"

39 
	~"pxt4_jbd3.h
"

41 
	~"x©å.h
"

42 
	~"a˛.h
"

44 
	~<åa˚/evíts/pxt4.h
>

48 
	#NAMEI_RA_CHUNKS
 2

	)

49 
	#NAMEI_RA_BLOCKS
 4

	)

50 
	#NAMEI_RA_SIZE
 (
NAMEI_RA_CHUNKS
 * 
NAMEI_RA_BLOCKS
)

	)

52 
buf„r_hód
 *
	$pxt4_≠≥nd
(
h™dÀ_t
 *
h™dÀ
,

53 
öode
 *inode,

54 
pxt4_lblk_t
 *
block
)

56 
buf„r_hód
 *
bh
;

57 
îr
;

59 i‡(
	`u∆ikñy
(
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
 &&

60 ((
öode
->
i_size
 >> 10) >=

61 
	`PXT4_SB
(
öode
->
i_sb
)->
s_max_dú_size_kb
)))

62  
	`ERR_PTR
(-
ENOSPC
);

64 *
block
 = 
öode
->
i_size
 >> inode->
i_sb
->
s_blocksize_bôs
;

66 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, *
block
, 
PXT4_GET_BLOCKS_CREATE
);

67 i‡(
	`IS_ERR
(
bh
))

68  
bh
;

69 
öode
->
i_size
 +öode->
i_sb
->
s_blocksize
;

70 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

71 
	`BUFFER_TRACE
(
bh
, "get_write_access");

72 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

73 i‡(
îr
) {

74 
	`bªl£
(
bh
);

75 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

76  
	`ERR_PTR
(
îr
);

78  
bh
;

79 
	}
}

81 
pxt4_dx_csum_vîify
(
öode
 *inode,

82 
pxt4_dú_íåy
 *
dúít
);

85 
	mEITHER
, 
	mINDEX
, 
	mDIRENT


86 } 
	tdúblock_ty≥_t
;

88 
	#pxt4_ªad_dúblock
(
öode
, 
block
, 
ty≥
) \

89 
	`__pxt4_ªad_dúblock
((
öode
), (
block
), (
ty≥
), 
__func__
, 
__LINE__
)

	)

91 
buf„r_hód
 *
	$__pxt4_ªad_dúblock
(
öode
 *inode,

92 
pxt4_lblk_t
 
block
,

93 
dúblock_ty≥_t
 
ty≥
,

94 c⁄° *
func
,

95 
löe
)

97 
buf„r_hód
 *
bh
;

98 
pxt4_dú_íåy
 *
dúít
;

99 
is_dx_block
 = 0;

101 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
block
, 0);

102 i‡(
	`IS_ERR
(
bh
)) {

103 
	`__pxt4_w¨nög
(
öode
->
i_sb
, 
func
, 
löe
,

106 
öode
->
i_öo
, ()
block
,

107 
cuºít
->
comm
, 
	`PTR_ERR
(
bh
));

109  
bh
;

111 i‡(!
bh
) {

112 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

114  
	`ERR_PTR
(-
EFSCORRUPTED
);

116 
dúít
 = (
pxt4_dú_íåy
 *Ë
bh
->
b_d©a
;

118 i‡(
	`is_dx
(
öode
)) {

119 i‡(
block
 == 0)

120 
is_dx_block
 = 1;

121 i‡(
	`pxt4_ªc_Àn_‰om_disk
(
dúít
->
ªc_Àn
,

122 
öode
->
i_sb
->
s_blocksize
) ==

123 
öode
->
i_sb
->
s_blocksize
)

124 
is_dx_block
 = 1;

126 i‡(!
is_dx_block
 && 
ty≥
 =
INDEX
) {

127 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

129 
	`bªl£
(
bh
);

130  
	`ERR_PTR
(-
EFSCORRUPTED
);

132 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
) ||

133 
	`buf„r_vîifõd
(
bh
))

134  
bh
;

141 i‡(
is_dx_block
 && 
ty≥
 =
INDEX
) {

142 i‡(
	`pxt4_dx_csum_vîify
(
öode
, 
dúít
))

143 
	`£t_buf„r_vîifõd
(
bh
);

145 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

147 
	`bªl£
(
bh
);

148  
	`ERR_PTR
(-
EFSBADCRC
);

151 i‡(!
is_dx_block
) {

152 i‡(
	`pxt4_dúít_csum_vîify
(
öode
, 
dúít
))

153 
	`£t_buf„r_vîifõd
(
bh
);

155 
	`pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
,

157 
	`bªl£
(
bh
);

158  
	`ERR_PTR
(-
EFSBADCRC
);

161  
bh
;

162 
	}
}

164 #i‚de‡
as£π


165 
	#as£π
(
ã°
Ë
	`J_ASSERT
—e°)

	)

168 #ifde‡
DX_DEBUG


169 
	#dxåa˚
(
comm™d
Ë
	)
command

171 
	#dxåa˚
(
comm™d
)

	)

174 
	sÁke_dúít


176 
__À32
 
	möode
;

177 
__À16
 
	mªc_Àn
;

178 
u8
 
	m«me_Àn
;

179 
u8
 
	mfûe_ty≥
;

182 
	sdx_cou¡limô


184 
__À16
 
	mlimô
;

185 
__À16
 
	mcou¡
;

188 
	sdx_íåy


190 
__À32
 
	mhash
;

191 
__À32
 
	mblock
;

200 
	sdx_roŸ


202 
Áke_dúít
 
	mdŸ
;

203 
	mdŸ_«me
[4];

204 
Áke_dúít
 
	mdŸdŸ
;

205 
	mdŸdŸ_«me
[4];

206 
	sdx_roŸ_öfo


208 
__À32
 
	mª£rved_zîo
;

209 
u8
 
	mhash_vîsi⁄
;

210 
u8
 
	möfo_Àngth
;

211 
u8
 
	mödúe˘_Àvñs
;

212 
u8
 
	munu£d_Êags
;

214 
	möfo
;

215 
dx_íåy
 
	míåõs
[0];

218 
	sdx_node


220 
Áke_dúít
 
	mÁke
;

221 
dx_íåy
 
	míåõs
[0];

225 
	sdx_‰ame


227 
buf„r_hód
 *
	mbh
;

228 
dx_íåy
 *
	míåõs
;

229 
dx_íåy
 *
	m©
;

232 
	sdx_m≠_íåy


234 
u32
 
	mhash
;

235 
u16
 
	moffs
;

236 
u16
 
	msize
;

242 
	sdx_èû
 {

243 
u32
 
	mdt_ª£rved
;

244 
__À32
 
	mdt_checksum
;

247 
ölöe
 
pxt4_lblk_t
 
dx_gë_block
(
dx_íåy
 *
íåy
);

248 
dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
);

249 
ölöe
 
dx_gë_hash
(
dx_íåy
 *
íåy
);

250 
dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
);

251 
dx_gë_cou¡
(
dx_íåy
 *
íåõs
);

252 
dx_gë_limô
(
dx_íåy
 *
íåõs
);

253 
dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
);

254 
dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
);

255 
dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
);

256 
dx_node_limô
(
öode
 *
dú
);

257 
dx_‰ame
 *
dx_¥obe
(
pxt4_fûíame
 *
‚ame
,

258 
öode
 *
dú
,

259 
dx_hash_öfo
 *
höfo
,

260 
dx_‰ame
 *
‰ame
);

261 
dx_ªÀa£
(
dx_‰ame
 *
‰ames
);

262 
dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

263 
blocksize
, 
dx_hash_öfo
 *
höfo
,

264 
dx_m≠_íåy
 
m≠
[]);

265 
dx_s‹t_m≠
(
dx_m≠_íåy
 *
m≠
, 
cou¡
);

266 
pxt4_dú_íåy_2
 *
dx_move_dúíts
(*
‰om
, *
to
,

267 
dx_m≠_íåy
 *
off£ts
, 
cou¡
, 
blocksize
);

268 
pxt4_dú_íåy_2
* 
dx_∑ck_dúíts
(*
ba£
, 
blocksize
);

269 
dx_ö£π_block
(
dx_‰ame
 *
‰ame
,

270 
u32
 
hash
, 
pxt4_lblk_t
 
block
);

271 
pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

272 
dx_‰ame
 *
‰ame
,

273 
dx_‰ame
 *
‰ames
,

274 
__u32
 *
°¨t_hash
);

275 
buf„r_hód
 * 
pxt4_dx_föd_íåy
(
öode
 *
dú
,

276 
pxt4_fûíame
 *
‚ame
,

277 
pxt4_dú_íåy_2
 **
ªs_dú
);

278 
pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

279 
öode
 *
dú
, inode *inode);

282 
	$öôülize_dúít_èû
(
pxt4_dú_íåy_èû
 *
t
,

283 
blocksize
)

285 
	`mem£t
(
t
, 0, (
pxt4_dú_íåy_èû
));

286 
t
->
dë_ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

287 (
pxt4_dú_íåy_èû
), 
blocksize
);

288 
t
->
dë_ª£rved_·
 = 
PXT4_FT_DIR_CSUM
;

289 
	}
}

292 
pxt4_dú_íåy_èû
 *
	$gë_dúít_èû
(
öode
 *inode,

293 
pxt4_dú_íåy
 *
de
)

295 
pxt4_dú_íåy_èû
 *
t
;

297 #ifde‡
PARANOID


298 
pxt4_dú_íåy
 *
d
, *
t›
;

300 
d
 = 
de
;

301 
t›
 = (
pxt4_dú_íåy
 *)(((*)
de
) +

302 (
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) -

303 (
pxt4_dú_íåy_èû
)));

304 
d
 < 
t›
 && d->
ªc_Àn
)

305 
d
 = (
pxt4_dú_íåy
 *)(((*)d) +

306 
	`À16_to_˝u
(
d
->
ªc_Àn
));

308 i‡(
d
 !
t›
)

309  
NULL
;

311 
t
 = (
pxt4_dú_íåy_èû
 *)
d
;

313 
t
 = 
	`PXT4_DIRENT_TAIL
(
de
, 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
));

316 i‡(
t
->
dë_ª£rved_zîo1
 ||

317 
	`À16_to_˝u
(
t
->
dë_ªc_Àn
Ë!(
pxt4_dú_íåy_èû
) ||

318 
t
->
dë_ª£rved_zîo2
 ||

319 
t
->
dë_ª£rved_·
 !
PXT4_FT_DIR_CSUM
)

320  
NULL
;

322  
t
;

323 
	}
}

325 
__À32
 
	$pxt4_dúít_csum
(
öode
 *inode,

326 
pxt4_dú_íåy
 *
dúít
, 
size
)

328 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

329 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

330 
__u32
 
csum
;

332 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

333  
	`˝u_to_À32
(
csum
);

334 
	}
}

336 
	#w¨n_no_•a˚_f‹_csum
(
öode
) \

337 
	`__w¨n_no_•a˚_f‹_csum
((
öode
), 
__func__
, 
__LINE__
)

	)

339 
	$__w¨n_no_•a˚_f‹_csum
(
öode
 *öode, c⁄° *
func
,

340 
löe
)

342 
	`__pxt4_w¨nög_öode
(
öode
, 
func
, 
löe
,

344 
	}
}

346 
	$pxt4_dúít_csum_vîify
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

348 
pxt4_dú_íåy_èû
 *
t
;

350 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

353 
t
 = 
	`gë_dúít_èû
(
öode
, 
dúít
);

354 i‡(!
t
) {

355 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

359 i‡(
t
->
dë_checksum
 !
	`pxt4_dúít_csum
(
öode
, 
dúít
,

360 (*)
t
 - (*)
dúít
))

364 
	}
}

366 
	$pxt4_dúít_csum_£t
(
öode
 *inode,

367 
pxt4_dú_íåy
 *
dúít
)

369 
pxt4_dú_íåy_èû
 *
t
;

371 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

374 
t
 = 
	`gë_dúít_èû
(
öode
, 
dúít
);

375 i‡(!
t
) {

376 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

380 
t
->
dë_checksum
 = 
	`pxt4_dúít_csum
(
öode
, 
dúít
,

381 (*)
t
 - (*)
dúít
);

382 
	}
}

384 
	$pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ_t
 *
h™dÀ
,

385 
öode
 *inode,

386 
buf„r_hód
 *
bh
)

388 
	`pxt4_dúít_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

389  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

390 
	}
}

392 
dx_cou¡limô
 *
	$gë_dx_cou¡limô
(
öode
 *inode,

393 
pxt4_dú_íåy
 *
dúít
,

394 *
off£t
)

396 
pxt4_dú_íåy
 *
dp
;

397 
dx_roŸ_öfo
 *
roŸ
;

398 
cou¡_off£t
;

400 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
Ë=
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
))

401 
cou¡_off£t
 = 8;

402 i‡(
	`À16_to_˝u
(
dúít
->
ªc_Àn
) == 12) {

403 
dp
 = (
pxt4_dú_íåy
 *)(((*)
dúít
) + 12);

404 i‡(
	`À16_to_˝u
(
dp
->
ªc_Àn
) !=

405 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
) - 12)

406  
NULL
;

407 
roŸ
 = (
dx_roŸ_öfo
 *)(((*)
dp
 + 12));

408 i‡(
roŸ
->
ª£rved_zîo
 ||

409 
roŸ
->
öfo_Àngth
 !(
dx_roŸ_öfo
))

410  
NULL
;

411 
cou¡_off£t
 = 32;

413  
NULL
;

415 i‡(
off£t
)

416 *
off£t
 = 
cou¡_off£t
;

417  (
dx_cou¡limô
 *)(((*)
dúít
Ë+ 
cou¡_off£t
);

418 
	}
}

420 
__À32
 
	$pxt4_dx_csum
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
,

421 
cou¡_off£t
, 
cou¡
, 
dx_èû
 *
t
)

423 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

424 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

425 
__u32
 
csum
;

426 
size
;

427 
__u32
 
dummy_csum
 = 0;

428 
off£t
 = 
	`off£tof
(
dx_èû
, 
dt_checksum
);

430 
size
 = 
cou¡_off£t
 + (
cou¡
 * (
dx_íåy
));

431 
csum
 = 
	`pxt4_chksum
(
sbi
, 
ei
->
i_csum_£ed
, (
__u8
 *)
dúít
, 
size
);

432 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
t
, 
off£t
);

433 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

435  
	`˝u_to_À32
(
csum
);

436 
	}
}

438 
	$pxt4_dx_csum_vîify
(
öode
 *inode,

439 
pxt4_dú_íåy
 *
dúít
)

441 
dx_cou¡limô
 *
c
;

442 
dx_èû
 *
t
;

443 
cou¡_off£t
, 
limô
, 
cou¡
;

445 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

448 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

449 i‡(!
c
) {

450 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

453 
limô
 = 
	`À16_to_˝u
(
c
->limit);

454 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

455 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

456 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

457 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

460 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

462 i‡(
t
->
dt_checksum
 !
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
,

463 
cou¡
, 
t
))

466 
	}
}

468 
	$pxt4_dx_csum_£t
(
öode
 *öode, 
pxt4_dú_íåy
 *
dúít
)

470 
dx_cou¡limô
 *
c
;

471 
dx_èû
 *
t
;

472 
cou¡_off£t
, 
limô
, 
cou¡
;

474 i‡(!
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

477 
c
 = 
	`gë_dx_cou¡limô
(
öode
, 
dúít
, &
cou¡_off£t
);

478 i‡(!
c
) {

479 
	`PXT4_ERROR_INODE
(
öode
, "dir seems corrupt? RunÉ2fsck -D.");

482 
limô
 = 
	`À16_to_˝u
(
c
->limit);

483 
cou¡
 = 
	`À16_to_˝u
(
c
->count);

484 i‡(
cou¡_off£t
 + (
limô
 * (
dx_íåy
)) >

485 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- (
dx_èû
)) {

486 
	`w¨n_no_•a˚_f‹_csum
(
öode
);

489 
t
 = (
dx_èû
 *)(((
dx_íåy
 *)
c
Ë+ 
limô
);

491 
t
->
dt_checksum
 = 
	`pxt4_dx_csum
(
öode
, 
dúít
, 
cou¡_off£t
, 
cou¡
,Å);

492 
	}
}

494 
ölöe
 
	$pxt4_h™dÀ_dúty_dx_node
(
h™dÀ_t
 *
h™dÀ
,

495 
öode
 *inode,

496 
buf„r_hód
 *
bh
)

498 
	`pxt4_dx_csum_£t
(
öode
, (
pxt4_dú_íåy
 *)
bh
->
b_d©a
);

499  
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

500 
	}
}

505 
ölöe
 
pxt4_dú_íåy_2
 *

506 
	$pxt4_√xt_íåy
(
pxt4_dú_íåy_2
 *
p
, 
blocksize
)

508  (
pxt4_dú_íåy_2
 *)((*)
p
 +

509 
	`pxt4_ªc_Àn_‰om_disk
(
p
->
ªc_Àn
, 
blocksize
));

510 
	}
}

517 
ölöe
 
pxt4_lblk_t
 
	$dx_gë_block
(
dx_íåy
 *
íåy
)

519  
	`À32_to_˝u
(
íåy
->
block
) & 0x0fffffff;

520 
	}
}

522 
ölöe
 
	$dx_£t_block
(
dx_íåy
 *
íåy
, 
pxt4_lblk_t
 
vÆue
)

524 
íåy
->
block
 = 
	`˝u_to_À32
(
vÆue
);

525 
	}
}

527 
ölöe
 
	$dx_gë_hash
(
dx_íåy
 *
íåy
)

529  
	`À32_to_˝u
(
íåy
->
hash
);

530 
	}
}

532 
ölöe
 
	$dx_£t_hash
(
dx_íåy
 *
íåy
, 
vÆue
)

534 
íåy
->
hash
 = 
	`˝u_to_À32
(
vÆue
);

535 
	}
}

537 
ölöe
 
	$dx_gë_cou¡
(
dx_íåy
 *
íåõs
)

539  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
);

540 
	}
}

542 
ölöe
 
	$dx_gë_limô
(
dx_íåy
 *
íåõs
)

544  
	`À16_to_˝u
(((
dx_cou¡limô
 *Ë
íåõs
)->
limô
);

545 
	}
}

547 
ölöe
 
	$dx_£t_cou¡
(
dx_íåy
 *
íåõs
, 
vÆue
)

549 ((
dx_cou¡limô
 *Ë
íåõs
)->
cou¡
 = 
	`˝u_to_À16
(
vÆue
);

550 
	}
}

552 
ölöe
 
	$dx_£t_limô
(
dx_íåy
 *
íåõs
, 
vÆue
)

554 ((
dx_cou¡limô
 *Ë
íåõs
)->
limô
 = 
	`˝u_to_À16
(
vÆue
);

555 
	}
}

557 
ölöe
 
	$dx_roŸ_limô
(
öode
 *
dú
, 
öfosize
)

559 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(1) -

560 
	`PXT4_DIR_REC_LEN
(2Ë- 
öfosize
;

562 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

563 
íåy_•a˚
 -(
dx_èû
);

564  
íåy_•a˚
 / (
dx_íåy
);

565 
	}
}

567 
ölöe
 
	$dx_node_limô
(
öode
 *
dú
)

569 
íåy_•a˚
 = 
dú
->
i_sb
->
s_blocksize
 - 
	`PXT4_DIR_REC_LEN
(0);

571 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

572 
íåy_•a˚
 -(
dx_èû
);

573  
íåy_•a˚
 / (
dx_íåy
);

574 
	}
}

579 #ifde‡
DX_DEBUG


580 
	$dx_show_ödex
(* 
œbñ
, 
dx_íåy
 *
íåõs
)

582 
i
, 
n
 = 
	`dx_gë_cou¡
 (
íåõs
);

583 
	`¥ötk
(
KERN_DEBUG
 "%†ödex", 
œbñ
);

584 
i
 = 0; i < 
n
; i++) {

585 
	`¥ötk
(
KERN_CONT
 " %x->%lu",

586 
i
 ? 
	`dx_gë_hash
(
íåõs
 + i) : 0,

587 ()
	`dx_gë_block
(
íåõs
 + 
i
));

589 
	`¥ötk
(
KERN_CONT
 "\n");

590 
	}
}

592 
	s°©s


594 
	m«mes
;

595 
	m•a˚
;

596 
	mbcou¡
;

599 
°©s
 
	$dx_show_Àaf
(
öode
 *
dú
,

600 
dx_hash_öfo
 *
höfo
,

601 
pxt4_dú_íåy_2
 *
de
,

602 
size
, 
show_«mes
)

604 
«mes
 = 0, 
•a˚
 = 0;

605 *
ba£
 = (*Ë
de
;

606 
dx_hash_öfo
 
h
 = *
höfo
;

608 
	`¥ötk
("names: ");

609 (*Ë
de
 < 
ba£
 + 
size
)

611 i‡(
de
->
öode
)

613 i‡(
show_«mes
)

615 #ifde‡
CONFIG_FS_ENCRYPTION


616 
Àn
;

617 *
«me
;

618 
fs¸y±_°r
 
‚ame_¸y±o_°r
 =

619 
	`FSTR_INIT
(
NULL
, 0);

620 
ªs
 = 0;

622 
«me
 = 
de
->name;

623 
Àn
 = 
de
->
«me_Àn
;

624 i‡(
	`IS_ENCRYPTED
(
dú
))

625 
ªs
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

626 i‡(
ªs
) {

627 
	`¥ötk
(
KERN_WARNING
 "Error setting up"

628 " f«mê¸y±o: %d\n", 
ªs
);

630 i‡(!
	`fs¸y±_has_í¸y±i⁄_key
(
dú
)) {

632 
	`pxt4fs_dúhash
(
de
->
«me
,

633 
de
->
«me_Àn
, &
h
);

634 
	`¥ötk
("%*.s:(U)%x.%u ", 
Àn
,

635 
«me
, 
h
.
hash
,

636 (Ë((*Ë
de


637 - 
ba£
));

639 
fs¸y±_°r
 
de_«me
 =

640 
	`FSTR_INIT
(
«me
, 
Àn
);

643 
ªs
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(

644 
dú
, 
Àn
,

645 &
‚ame_¸y±o_°r
);

646 i‡(
ªs
)

647 
	`¥ötk
(
KERN_WARNING
 "Error "

651 
ªs
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
,

652 0, 0, &
de_«me
,

653 &
‚ame_¸y±o_°r
);

654 i‡(
ªs
) {

655 
	`¥ötk
(
KERN_WARNING
 "Error "

659 
«me
 = "??";

660 
Àn
 = 2;

662 
«me
 = 
‚ame_¸y±o_°r
.name;

663 
Àn
 = 
‚ame_¸y±o_°r
.len;

665 
	`pxt4fs_dúhash
(
de
->
«me
, de->
«me_Àn
,

666 &
h
);

667 
	`¥ötk
("%*.s:(E)%x.%u ", 
Àn
, 
«me
,

668 
h
.
hash
, (Ë((*Ë
de


669 - 
ba£
));

670 
	`fs¸y±_‚ame_‰ì_buf„r
(

671 &
‚ame_¸y±o_°r
);

674 
Àn
 = 
de
->
«me_Àn
;

675 *
«me
 = 
de
->name;

676 
	`pxt4fs_dúhash
(
de
->
«me
, de->
«me_Àn
, &
h
);

677 
	`¥ötk
("%*.s:%x.%u ", 
Àn
, 
«me
, 
h
.
hash
,

678 (Ë((*Ë
de
 - 
ba£
));

681 
•a˚
 +
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

682 
«mes
++;

684 
de
 = 
	`pxt4_√xt_íåy
(de, 
size
);

686 
	`¥ötk
(
KERN_CONT
 "(%i)\n", 
«mes
);

687  (
°©s
Ë{ 
«mes
, 
•a˚
, 1 };

688 
	}
}

690 
°©s
 
	$dx_show_íåõs
(
dx_hash_öfo
 *
höfo
, 
öode
 *
dú
,

691 
dx_íåy
 *
íåõs
, 
Àvñs
)

693 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

694 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
), 
«mes
 = 0, 
•a˚
 = 0, 
i
;

695 
bcou¡
 = 0;

696 
buf„r_hód
 *
bh
;

697 
	`¥ötk
("%òödexed blocks...\n", 
cou¡
);

698 
i
 = 0; i < 
cou¡
; i++, 
íåõs
++)

700 
pxt4_lblk_t
 
block
 = 
	`dx_gë_block
(
íåõs
);

701 
pxt4_lblk_t
 
hash
 = 
i
 ? 
	`dx_gë_hash
(
íåõs
): 0;

702 
u32
 
ønge
 = 
i
 < 
cou¡
 - 1? (
	`dx_gë_hash
(
íåõs
 + 1Ë- 
hash
): ~hash;

703 
°©s
 stats;

704 
	`¥ötk
("%s%3u:%03u hash %8x/%8x ",
Àvñs
?"":" ", 
i
, 
block
, 
hash
, 
ønge
);

705 
bh
 = 
	`pxt4_bªad
(
NULL
,
dú
, 
block
, 0);

706 i‡(!
bh
 || 
	`IS_ERR
(bh))

708 
°©s
 = 
Àvñs
?

709 
	`dx_show_íåõs
(
höfo
, 
dú
, ((
dx_node
 *Ë
bh
->
b_d©a
)->
íåõs
, 
Àvñs
 - 1):

710 
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *)

711 
bh
->
b_d©a
, 
blocksize
, 0);

712 
«mes
 +
°©s
.names;

713 
•a˚
 +
°©s
.space;

714 
bcou¡
 +
°©s
.bcount;

715 
	`bªl£
(
bh
);

717 i‡(
bcou¡
)

718 
	`¥ötk
(
KERN_DEBUG
 "%snames %u, fullness %u (%u%%)\n",

719 
Àvñs
 ? "" : " ", 
«mes
, 
•a˚
/
bcou¡
,

720 (
•a˚
/
bcou¡
)*100/
blocksize
);

721  (
°©s
Ë{ 
«mes
, 
•a˚
, 
bcou¡
};

722 
	}
}

734 
dx_‰ame
 *

735 
	$dx_¥obe
(
pxt4_fûíame
 *
‚ame
, 
öode
 *
dú
,

736 
dx_hash_öfo
 *
höfo
, 
dx_‰ame
 *
‰ame_ö
)

738 
cou¡
, 
ödúe˘
;

739 
dx_íåy
 *
©
, *
íåõs
, *
p
, *
q
, *
m
;

740 
dx_roŸ
 *
roŸ
;

741 
dx_‰ame
 *
‰ame
 = 
‰ame_ö
;

742 
dx_‰ame
 *
ªt_îr
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

743 
u32
 
hash
;

745 
	`mem£t
(
‰ame_ö
, 0, 
PXT4_HTREE_LEVEL
 * (frame_in[0]));

746 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 0, 
INDEX
);

747 i‡(
	`IS_ERR
(
‰ame
->
bh
))

748  (
dx_‰ame
 *Ë
‰ame
->
bh
;

750 
roŸ
 = (
dx_roŸ
 *Ë
‰ame
->
bh
->
b_d©a
;

751 i‡(
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_TEA
 &&

752 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_HALF_MD4
 &&

753 
roŸ
->
öfo
.
hash_vîsi⁄
 !
DX_HASH_LEGACY
) {

754 
	`pxt4_w¨nög_öode
(
dú
, "Unrecognised inode hash code %u",

755 
roŸ
->
öfo
.
hash_vîsi⁄
);

756 
Áû
;

758 i‡(
‚ame
)

759 
höfo
 = &
‚ame
->hinfo;

760 
höfo
->
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

761 i‡(
höfo
->
hash_vîsi⁄
 <
DX_HASH_TEA
)

762 
höfo
->
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

763 
höfo
->
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

764 i‡(
‚ame
 && 
	`‚ame_«me
(fname))

765 
	`pxt4fs_dúhash
(
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), 
höfo
);

766 
hash
 = 
höfo
->hash;

768 i‡(
roŸ
->
öfo
.
unu£d_Êags
 & 1) {

769 
	`pxt4_w¨nög_öode
(
dú
, "Unimplemented hash flags: %#06x",

770 
roŸ
->
öfo
.
unu£d_Êags
);

771 
Áû
;

774 
ödúe˘
 = 
roŸ
->
öfo
.
ödúe˘_Àvñs
;

775 i‡(
ödúe˘
 >
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
)) {

776 
	`pxt4_w¨nög
(
dú
->
i_sb
,

778 "suµ‹ãd vÆue", 
dú
->
i_öo
,

779 
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
));

780 i‡(
	`pxt4_dú_håì_Àvñ
(
dú
->
i_sb
Ë< 
PXT4_HTREE_LEVEL
) {

781 
	`pxt4_w¨nög
(
dú
->
i_sb
, "EnableÜarge directory "

784 
Áû
;

787 
íåõs
 = (
dx_íåy
 *)(((*)&
roŸ
->
öfo
) +

788 
roŸ
->
öfo
.
öfo_Àngth
);

790 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_roŸ_limô
(
dú
,

791 
roŸ
->
öfo
.
öfo_Àngth
)) {

792 
	`pxt4_w¨nög_öode
(
dú
, "dxÉntry:Üimit %u !=ÑootÜimit %u",

793 
	`dx_gë_limô
(
íåõs
),

794 
	`dx_roŸ_limô
(
dú
, 
roŸ
->
öfo
.
öfo_Àngth
));

795 
Áû
;

798 
	`dxåa˚
(
	`¥ötk
("Look u∞%x", 
hash
));

800 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

801 i‡(!
cou¡
 || cou¡ > 
	`dx_gë_limô
(
íåõs
)) {

802 
	`pxt4_w¨nög_öode
(
dú
,

804 
cou¡
, 
	`dx_gë_limô
(
íåõs
));

805 
Áû
;

808 
p
 = 
íåõs
 + 1;

809 
q
 = 
íåõs
 + 
cou¡
 - 1;

810 
p
 <
q
) {

811 
m
 = 
p
 + (
q
 -Ö) / 2;

812 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 "."));

813 i‡(
	`dx_gë_hash
(
m
Ë> 
hash
)

814 
q
 = 
m
 - 1;

816 
p
 = 
m
 + 1;

820 
n
 = 
cou¡
 - 1;

821 
©
 = 
íåõs
;

822 
n
--)

824 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 ","));

825 i‡(
	`dx_gë_hash
(++
©
Ë> 
hash
)

827 
©
--;

831 
	`as£π
 (
©
 =
p
 - 1);

834 
©
 = 
p
 - 1;

835 
	`dxåa˚
(
	`¥ötk
(
KERN_CONT
 " %x->%u\n",

836 
©
 =
íåõs
 ? 0 : 
	`dx_gë_hash
(at),

837 
	`dx_gë_block
(
©
)));

838 
‰ame
->
íåõs
 =Éntries;

839 
‰ame
->
©
 =át;

840 i‡(!
ödúe˘
--)

841  
‰ame
;

842 
‰ame
++;

843 
‰ame
->
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
©
), 
INDEX
);

844 i‡(
	`IS_ERR
(
‰ame
->
bh
)) {

845 
ªt_îr
 = (
dx_‰ame
 *Ë
‰ame
->
bh
;

846 
‰ame
->
bh
 = 
NULL
;

847 
Áû
;

849 
íåõs
 = ((
dx_node
 *Ë
‰ame
->
bh
->
b_d©a
)->entries;

851 i‡(
	`dx_gë_limô
(
íåõs
Ë!
	`dx_node_limô
(
dú
)) {

852 
	`pxt4_w¨nög_öode
(
dú
,

854 
	`dx_gë_limô
(
íåõs
), 
	`dx_node_limô
(
dú
));

855 
Áû
;

858 
Áû
:

859 
‰ame
 >
‰ame_ö
) {

860 
	`bªl£
(
‰ame
->
bh
);

861 
‰ame
--;

864 i‡(
ªt_îr
 =
	`ERR_PTR
(
ERR_BAD_DX_DIR
))

865 
	`pxt4_w¨nög_öode
(
dú
,

867  
ªt_îr
;

868 
	}
}

870 
	$dx_ªÀa£
(
dx_‰ame
 *
‰ames
)

872 
dx_roŸ_öfo
 *
öfo
;

873 
i
;

874 
ödúe˘_Àvñs
;

876 i‡(
‰ames
[0].
bh
 =
NULL
)

879 
öfo
 = &((
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
)->info;

881 
ödúe˘_Àvñs
 = 
öfo
->indirect_levels;

882 
i
 = 0; i <
ödúe˘_Àvñs
; i++) {

883 i‡(
‰ames
[
i
].
bh
 =
NULL
)

885 
	`bªl£
(
‰ames
[
i
].
bh
);

886 
‰ames
[
i
].
bh
 = 
NULL
;

888 
	}
}

907 
	$pxt4_håì_√xt_block
(
öode
 *
dú
, 
__u32
 
hash
,

908 
dx_‰ame
 *
‰ame
,

909 
dx_‰ame
 *
‰ames
,

910 
__u32
 *
°¨t_hash
)

912 
dx_‰ame
 *
p
;

913 
buf„r_hód
 *
bh
;

914 
num_‰ames
 = 0;

915 
__u32
 
bhash
;

917 
p
 = 
‰ame
;

926 i‡(++(
p
->
©
Ë<Ö->
íåõs
 + 
	`dx_gë_cou¡
(p->entries))

928 i‡(
p
 =
‰ames
)

930 
num_‰ames
++;

931 
p
--;

941 
bhash
 = 
	`dx_gë_hash
(
p
->
©
);

942 i‡(
°¨t_hash
)

943 *
°¨t_hash
 = 
bhash
;

944 i‡((
hash
 & 1) == 0) {

945 i‡((
bhash
 & ~1Ë!
hash
)

952 
num_‰ames
--) {

953 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
p
->
©
), 
INDEX
);

954 i‡(
	`IS_ERR
(
bh
))

955  
	`PTR_ERR
(
bh
);

956 
p
++;

957 
	`bªl£
(
p
->
bh
);

958 
p
->
bh
 = bh;

959 
p
->
©
 =Ö->
íåõs
 = ((
dx_node
 *Ë
bh
->
b_d©a
)->entries;

962 
	}
}

970 
	$håì_dúblock_to_åì
(
fûe
 *
dú_fûe
,

971 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

972 
dx_hash_öfo
 *
höfo
,

973 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
)

975 
buf„r_hód
 *
bh
;

976 
pxt4_dú_íåy_2
 *
de
, *
t›
;

977 
îr
 = 0, 
cou¡
 = 0;

978 
fs¸y±_°r
 
‚ame_¸y±o_°r
 = 
	`FSTR_INIT
(
NULL
, 0), 
tmp_°r
;

980 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "In htree dirblock_to_tree: block %lu\n",

981 ()
block
));

982 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

983 i‡(
	`IS_ERR
(
bh
))

984  
	`PTR_ERR
(
bh
);

986 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

987 
t›
 = (
pxt4_dú_íåy_2
 *Ë((*Ë
de
 +

988 
dú
->
i_sb
->
s_blocksize
 -

989 
	`PXT4_DIR_REC_LEN
(0));

990 #ifde‡
CONFIG_FS_ENCRYPTION


992 i‡(
	`IS_ENCRYPTED
(
dú
)) {

993 
îr
 = 
	`fs¸y±_gë_í¸y±i⁄_öfo
(
dú
);

994 i‡(
îr
 < 0) {

995 
	`bªl£
(
bh
);

996  
îr
;

998 
îr
 = 
	`fs¸y±_‚ame_Æloc_buf„r
(
dú
, 
PXT4_NAME_LEN
,

999 &
‚ame_¸y±o_°r
);

1000 i‡(
îr
 < 0) {

1001 
	`bªl£
(
bh
);

1002  
îr
;

1006 ; 
de
 < 
t›
; dê
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
)) {

1007 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1008 
bh
->
b_d©a
, bh->
b_size
,

1009 (
block
<<
	`PXT4_BLOCK_SIZE_BITS
(
dú
->
i_sb
))

1010 + ((*)
de
 - 
bh
->
b_d©a
))) {

1014 
	`pxt4fs_dúhash
(
de
->
«me
, de->
«me_Àn
, 
höfo
);

1015 i‡((
höfo
->
hash
 < 
°¨t_hash
) ||

1016 ((
höfo
->
hash
 =
°¨t_hash
) &&

1017 (
höfo
->
mö‹_hash
 < 
°¨t_mö‹_hash
)))

1019 i‡(
de
->
öode
 == 0)

1021 i‡(!
	`IS_ENCRYPTED
(
dú
)) {

1022 
tmp_°r
.
«me
 = 
de
->name;

1023 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1024 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1025 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1026 &
tmp_°r
);

1028 
ßve_Àn
 = 
‚ame_¸y±o_°r
.
Àn
;

1029 
fs¸y±_°r
 
de_«me
 = 
	`FSTR_INIT
(
de
->
«me
,

1030 
de
->
«me_Àn
);

1033 
îr
 = 
	`fs¸y±_‚ame_disk_to_u§
(
dú
, 
höfo
->
hash
,

1034 
höfo
->
mö‹_hash
, &
de_«me
,

1035 &
‚ame_¸y±o_°r
);

1036 i‡(
îr
) {

1037 
cou¡
 = 
îr
;

1038 
îrout
;

1040 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
,

1041 
höfo
->
hash
, höfo->
mö‹_hash
, 
de
,

1042 &
‚ame_¸y±o_°r
);

1043 
‚ame_¸y±o_°r
.
Àn
 = 
ßve_Àn
;

1045 i‡(
îr
 != 0) {

1046 
cou¡
 = 
îr
;

1047 
îrout
;

1049 
cou¡
++;

1051 
îrout
:

1052 
	`bªl£
(
bh
);

1053 #ifde‡
CONFIG_FS_ENCRYPTION


1054 
	`fs¸y±_‚ame_‰ì_buf„r
(&
‚ame_¸y±o_°r
);

1056  
cou¡
;

1057 
	}
}

1068 
	$pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

1069 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
)

1071 
dx_hash_öfo
 
höfo
;

1072 
pxt4_dú_íåy_2
 *
de
;

1073 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1074 
öode
 *
dú
;

1075 
pxt4_lblk_t
 
block
;

1076 
cou¡
 = 0;

1077 
ªt
, 
îr
;

1078 
__u32
 
hashvÆ
;

1079 
fs¸y±_°r
 
tmp_°r
;

1081 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "In htree_fill_tree, start hash: %x:%x\n",

1082 
°¨t_hash
, 
°¨t_mö‹_hash
));

1083 
dú
 = 
	`fûe_öode
(
dú_fûe
);

1084 i‡(!(
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
))) {

1085 
höfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1086 i‡(
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1087 
höfo
.
hash_vîsi⁄
 +=

1088 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1089 
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1090 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1091 
has_ölöe_d©a
 = 1;

1092 
cou¡
 = 
	`håì_ölöedú_to_åì
(
dú_fûe
, 
dú
, 0,

1093 &
höfo
, 
°¨t_hash
,

1094 
°¨t_mö‹_hash
,

1095 &
has_ölöe_d©a
);

1096 i‡(
has_ölöe_d©a
) {

1097 *
√xt_hash
 = ~0;

1098  
cou¡
;

1101 
cou¡
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 0, &
höfo
,

1102 
°¨t_hash
, 
°¨t_mö‹_hash
);

1103 *
√xt_hash
 = ~0;

1104  
cou¡
;

1106 
höfo
.
hash
 = 
°¨t_hash
;

1107 
höfo
.
mö‹_hash
 = 0;

1108 
‰ame
 = 
	`dx_¥obe
(
NULL
, 
dú
, &
höfo
, 
‰ames
);

1109 i‡(
	`IS_ERR
(
‰ame
))

1110  
	`PTR_ERR
(
‰ame
);

1113 i‡(!
°¨t_hash
 && !
°¨t_mö‹_hash
) {

1114 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1115 
tmp_°r
.
«me
 = 
de
->name;

1116 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1117 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 0, 0,

1118 
de
, &
tmp_°r
);

1119 i‡(
îr
 != 0)

1120 
îrout
;

1121 
cou¡
++;

1123 i‡(
°¨t_hash
 < 2 || (°¨t_hash ==2 && 
°¨t_mö‹_hash
==0)) {

1124 
de
 = (
pxt4_dú_íåy_2
 *Ë
‰ames
[0].
bh
->
b_d©a
;

1125 
de
 = 
	`pxt4_√xt_íåy
(de, 
dú
->
i_sb
->
s_blocksize
);

1126 
tmp_°r
.
«me
 = 
de
->name;

1127 
tmp_°r
.
Àn
 = 
de
->
«me_Àn
;

1128 
îr
 = 
	`pxt4_håì_°‹e_dúít
(
dú_fûe
, 2, 0,

1129 
de
, &
tmp_°r
);

1130 i‡(
îr
 != 0)

1131 
îrout
;

1132 
cou¡
++;

1136 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
)) {

1137 
îr
 = -
ERESTARTSYS
;

1138 
îrout
;

1140 
	`c⁄d_ªsched
();

1141 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1142 
ªt
 = 
	`håì_dúblock_to_åì
(
dú_fûe
, 
dú
, 
block
, &
höfo
,

1143 
°¨t_hash
, 
°¨t_mö‹_hash
);

1144 i‡(
ªt
 < 0) {

1145 
îr
 = 
ªt
;

1146 
îrout
;

1148 
cou¡
 +
ªt
;

1149 
hashvÆ
 = ~0;

1150 
ªt
 = 
	`pxt4_håì_√xt_block
(
dú
, 
HASH_NB_ALWAYS
,

1151 
‰ame
, 
‰ames
, &
hashvÆ
);

1152 *
√xt_hash
 = 
hashvÆ
;

1153 i‡(
ªt
 < 0) {

1154 
îr
 = 
ªt
;

1155 
îrout
;

1162 i‡((
ªt
 == 0) ||

1163 (
cou¡
 && ((
hashvÆ
 & 1) == 0)))

1166 
	`dx_ªÀa£
(
‰ames
);

1167 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "FillÅree:Ñeturned %dÉntries, "

1168 "√xàhash: %x\n", 
cou¡
, *
√xt_hash
));

1169  
cou¡
;

1170 
îrout
:

1171 
	`dx_ªÀa£
(
‰ames
);

1172  (
îr
);

1173 
	}
}

1175 
ölöe
 
	$£¨ch_dúblock
(
buf„r_hód
 *
bh
,

1176 
öode
 *
dú
,

1177 
pxt4_fûíame
 *
‚ame
,

1178 
off£t
,

1179 
pxt4_dú_íåy_2
 **
ªs_dú
)

1181  
	`pxt4_£¨ch_dú
(
bh
, bh->
b_d©a
, 
dú
->
i_sb
->
s_blocksize
, dir,

1182 
‚ame
, 
off£t
, 
ªs_dú
);

1183 
	}
}

1193 
	$dx_make_m≠
(
öode
 *
dú
, 
pxt4_dú_íåy_2
 *
de
,

1194 
blocksize
, 
dx_hash_öfo
 *
höfo
,

1195 
dx_m≠_íåy
 *
m≠_èû
)

1197 
cou¡
 = 0;

1198 *
ba£
 = (*Ë
de
;

1199 
dx_hash_öfo
 
h
 = *
höfo
;

1201 (*Ë
de
 < 
ba£
 + 
blocksize
) {

1202 i‡(
de
->
«me_Àn
 && de->
öode
) {

1203 
	`pxt4fs_dúhash
(
de
->
«me
, de->
«me_Àn
, &
h
);

1204 
m≠_èû
--;

1205 
m≠_èû
->
hash
 = 
h
.hash;

1206 
m≠_èû
->
offs
 = ((*Ë
de
 - 
ba£
)>>2;

1207 
m≠_èû
->
size
 = 
	`À16_to_˝u
(
de
->
ªc_Àn
);

1208 
cou¡
++;

1209 
	`c⁄d_ªsched
();

1212 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

1214  
cou¡
;

1215 
	}
}

1218 
	$dx_s‹t_m≠
 (
dx_m≠_íåy
 *
m≠
, 
cou¡
)

1220 
dx_m≠_íåy
 *
p
, *
q
, *
t›
 = 
m≠
 + 
cou¡
 - 1;

1221 
m‹e
;

1223 
cou¡
 > 2) {

1224 
cou¡
 = count*10/13;

1225 i‡(
cou¡
 - 9 < 2)

1226 
cou¡
 = 11;

1227 
p
 = 
t›
, 
q
 =Ö - 
cou¡
; q >
m≠
;Ö--, q--)

1228 i‡(
p
->
hash
 < 
q
->hash)

1229 
	`sw≠
(*
p
, *
q
);

1233 
m‹e
 = 0;

1234 
q
 = 
t›
;

1235 
q
-- > 
m≠
) {

1236 i‡(
q
[1].
hash
 >= q[0].hash)

1238 
	`sw≠
(*(
q
+1), *q);

1239 
m‹e
 = 1;

1241 } 
m‹e
);

1242 
	}
}

1244 
	$dx_ö£π_block
(
dx_‰ame
 *
‰ame
, 
u32
 
hash
, 
pxt4_lblk_t
 
block
)

1246 
dx_íåy
 *
íåõs
 = 
‰ame
->entries;

1247 
dx_íåy
 *
ﬁd
 = 
‰ame
->
©
, *
√w
 = old + 1;

1248 
cou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

1250 
	`as£π
(
cou¡
 < 
	`dx_gë_limô
(
íåõs
));

1251 
	`as£π
(
ﬁd
 < 
íåõs
 + 
cou¡
);

1252 
	`memmove
(
√w
 + 1,Çew, (*)(
íåõs
 + 
cou¡
) - (*)(new));

1253 
	`dx_£t_hash
(
√w
, 
hash
);

1254 
	`dx_£t_block
(
√w
, 
block
);

1255 
	`dx_£t_cou¡
(
íåõs
, 
cou¡
 + 1);

1256 
	}
}

1263 
ölöe
 
boﬁ
 
	$pxt4_m©ch
(c⁄° 
pxt4_fûíame
 *
‚ame
,

1264 c⁄° 
pxt4_dú_íåy_2
 *
de
)

1266 
fs¸y±_«me
 
f
;

1268 i‡(!
de
->
öode
)

1269  
Ál£
;

1271 
f
.
u§_‚ame
 = 
‚ame
->usr_fname;

1272 
f
.
disk_«me
 = 
‚ame
->disk_name;

1273 #ifde‡
CONFIG_FS_ENCRYPTION


1274 
f
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

1276  
	`fs¸y±_m©ch_«me
(&
f
, 
de
->
«me
, de->
«me_Àn
);

1277 
	}
}

1282 
	$pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
, *
£¨ch_buf
, 
buf_size
,

1283 
öode
 *
dú
, 
pxt4_fûíame
 *
‚ame
,

1284 
off£t
, 
pxt4_dú_íåy_2
 **
ªs_dú
)

1286 
pxt4_dú_íåy_2
 * 
de
;

1287 * 
dlimô
;

1288 
de_Àn
;

1290 
de
 = (
pxt4_dú_íåy_2
 *)
£¨ch_buf
;

1291 
dlimô
 = 
£¨ch_buf
 + 
buf_size
;

1292 (*Ë
de
 < 
dlimô
) {

1295 i‡((*Ë
de
 + de->
«me_Àn
 <
dlimô
 &&

1296 
	`pxt4_m©ch
(
‚ame
, 
de
)) {

1299 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
, bh->
b_d©a
,

1300 
bh
->
b_size
, 
off£t
))

1302 *
ªs_dú
 = 
de
;

1306 
de_Àn
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

1307 
dú
->
i_sb
->
s_blocksize
);

1308 i‡(
de_Àn
 <= 0)

1310 
off£t
 +
de_Àn
;

1311 
de
 = (
pxt4_dú_íåy_2
 *Ë((*Ëdê+ 
de_Àn
);

1314 
	}
}

1316 
	$is_dx_öã∫Æ_node
(
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

1317 
pxt4_dú_íåy
 *
de
)

1319 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

1321 i‡(!
	`is_dx
(
dú
))

1323 i‡(
block
 == 0)

1325 i‡(
de
->
öode
 == 0 &&

1326 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) ==

1327 
sb
->
s_blocksize
)

1330 
	}
}

1343 
buf„r_hód
 * 
	$pxt4_föd_íåy
 (
öode
 *
dú
,

1344 c⁄° 
q°r
 *
d_«me
,

1345 
pxt4_dú_íåy_2
 **
ªs_dú
,

1346 *
ölöed
)

1348 
su≥r_block
 *
sb
;

1349 
buf„r_hód
 *
bh_u£
[
NAMEI_RA_SIZE
];

1350 
buf„r_hód
 *
bh
, *
ªt
 = 
NULL
;

1351 
pxt4_lblk_t
 
°¨t
, 
block
;

1352 c⁄° 
u8
 *
«me
 = 
d_«me
->name;

1353 
size_t
 
ø_max
 = 0;

1355 
size_t
 
ø_±r
 = 0;

1357 
pxt4_lblk_t
 
nblocks
;

1358 
i
, 
«mñí
, 
ªtvÆ
;

1359 
pxt4_fûíame
 
‚ame
;

1361 *
ªs_dú
 = 
NULL
;

1362 
sb
 = 
dú
->
i_sb
;

1363 
«mñí
 = 
d_«me
->
Àn
;

1364 i‡(
«mñí
 > 
PXT4_NAME_LEN
)

1365  
NULL
;

1367 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, 
d_«me
, 1, &
‚ame
);

1368 i‡(
ªtvÆ
 =-
ENOENT
)

1369  
NULL
;

1370 i‡(
ªtvÆ
)

1371  
	`ERR_PTR
(
ªtvÆ
);

1373 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

1374 
has_ölöe_d©a
 = 1;

1375 
ªt
 = 
	`pxt4_föd_ölöe_íåy
(
dú
, &
‚ame
, 
ªs_dú
,

1376 &
has_ölöe_d©a
);

1377 i‡(
has_ölöe_d©a
) {

1378 i‡(
ölöed
)

1379 *
ölöed
 = 1;

1380 
˛ónup_™d_exô
;

1384 i‡((
«mñí
 <2Ë&& (
«me
[0] == '.') &&

1385 (
«me
[1] == '.' ||Çame[1] == '\0')) {

1390 
block
 = 
°¨t
 = 0;

1391 
nblocks
 = 1;

1392 
ª°¨t
;

1394 i‡(
	`is_dx
(
dú
)) {

1395 
ªt
 = 
	`pxt4_dx_föd_íåy
(
dú
, &
‚ame
, 
ªs_dú
);

1401 i‡(!
	`IS_ERR
(
ªt
Ë|| 
	`PTR_ERR
‘ëË!
ERR_BAD_DX_DIR
)

1402 
˛ónup_™d_exô
;

1403 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "pxt4_find_entry: dx failed, "

1405 
ªt
 = 
NULL
;

1407 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1408 i‡(!
nblocks
) {

1409 
ªt
 = 
NULL
;

1410 
˛ónup_™d_exô
;

1412 
°¨t
 = 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
;

1413 i‡(
°¨t
 >
nblocks
)

1414 
°¨t
 = 0;

1415 
block
 = 
°¨t
;

1416 
ª°¨t
:

1421 i‡(
ø_±r
 >
ø_max
) {

1423 
ø_±r
 = 0;

1424 i‡(
block
 < 
°¨t
)

1425 
ø_max
 = 
°¨t
 - 
block
;

1427 
ø_max
 = 
nblocks
 - 
block
;

1428 
ø_max
 = 
	`mö
‘a_max, 
	`ARRAY_SIZE
(
bh_u£
));

1429 
ªtvÆ
 = 
	`pxt4_bªad_b©ch
(
dú
, 
block
, 
ø_max
,

1430 
Ál£
 , 
bh_u£
);

1431 i‡(
ªtvÆ
) {

1432 
ªt
 = 
	`ERR_PTR
(
ªtvÆ
);

1433 
ø_max
 = 0;

1434 
˛ónup_™d_exô
;

1437 i‡((
bh
 = 
bh_u£
[
ø_±r
++]Ë=
NULL
)

1438 
√xt
;

1439 
	`waô_⁄_buf„r
(
bh
);

1440 i‡(!
	`buf„r_u±od©e
(
bh
)) {

1441 
	`PXT4_ERROR_INODE
(
dú
, "reading directoryÜblock %lu",

1442 (Ë
block
);

1443 
	`bªl£
(
bh
);

1444 
ªt
 = 
	`ERR_PTR
(-
EIO
);

1445 
˛ónup_™d_exô
;

1447 i‡(!
	`buf„r_vîifõd
(
bh
) &&

1448 !
	`is_dx_öã∫Æ_node
(
dú
, 
block
,

1449 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
) &&

1450 !
	`pxt4_dúít_csum_vîify
(
dú
,

1451 (
pxt4_dú_íåy
 *)
bh
->
b_d©a
)) {

1452 
	`PXT4_ERROR_INODE
(
dú
, "checksumming directory "

1453 "block %lu", ()
block
);

1454 
	`bªl£
(
bh
);

1455 
ªt
 = 
	`ERR_PTR
(-
EFSBADCRC
);

1456 
˛ónup_™d_exô
;

1458 
	`£t_buf„r_vîifõd
(
bh
);

1459 
i
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, &
‚ame
,

1460 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
), 
ªs_dú
);

1461 i‡(
i
 == 1) {

1462 
	`PXT4_I
(
dú
)->
i_dú_°¨t_lookup
 = 
block
;

1463 
ªt
 = 
bh
;

1464 
˛ónup_™d_exô
;

1466 
	`bªl£
(
bh
);

1467 i‡(
i
 < 0)

1468 
˛ónup_™d_exô
;

1470 
√xt
:

1471 i‡(++
block
 >
nblocks
)

1472 
block
 = 0;

1473 } 
block
 !
°¨t
);

1479 
block
 = 
nblocks
;

1480 
nblocks
 = 
dú
->
i_size
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

1481 i‡(
block
 < 
nblocks
) {

1482 
°¨t
 = 0;

1483 
ª°¨t
;

1486 
˛ónup_™d_exô
:

1488 ; 
ø_±r
 < 
ø_max
;Ña_ptr++)

1489 
	`bªl£
(
bh_u£
[
ø_±r
]);

1490 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

1491  
ªt
;

1492 
	}
}

1494 
buf„r_hód
 * 
	$pxt4_dx_föd_íåy
(
öode
 *
dú
,

1495 
pxt4_fûíame
 *
‚ame
,

1496 
pxt4_dú_íåy_2
 **
ªs_dú
)

1498 
su≥r_block
 * 
sb
 = 
dú
->
i_sb
;

1499 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1500 
buf„r_hód
 *
bh
;

1501 
pxt4_lblk_t
 
block
;

1502 
ªtvÆ
;

1504 #ifde‡
CONFIG_FS_ENCRYPTION


1505 *
ªs_dú
 = 
NULL
;

1507 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

1508 i‡(
	`IS_ERR
(
‰ame
))

1509  (
buf„r_hód
 *Ë
‰ame
;

1511 
block
 = 
	`dx_gë_block
(
‰ame
->
©
);

1512 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

1513 i‡(
	`IS_ERR
(
bh
))

1514 
îrout
;

1516 
ªtvÆ
 = 
	`£¨ch_dúblock
(
bh
, 
dú
, 
‚ame
,

1517 
block
 << 
	`PXT4_BLOCK_SIZE_BITS
(
sb
),

1518 
ªs_dú
);

1519 i‡(
ªtvÆ
 == 1)

1520 
suc˚ss
;

1521 
	`bªl£
(
bh
);

1522 i‡(
ªtvÆ
 == -1) {

1523 
bh
 = 
	`ERR_PTR
(
ERR_BAD_DX_DIR
);

1524 
îrout
;

1528 
ªtvÆ
 = 
	`pxt4_håì_√xt_block
(
dú
, 
‚ame
->
höfo
.
hash
, 
‰ame
,

1529 
‰ames
, 
NULL
);

1530 i‡(
ªtvÆ
 < 0) {

1531 
	`pxt4_w¨nög_öode
(
dú
,

1533 
ªtvÆ
);

1534 
bh
 = 
	`ERR_PTR
(
ªtvÆ
);

1535 
îrout
;

1537 } 
ªtvÆ
 == 1);

1539 
bh
 = 
NULL
;

1540 
îrout
:

1541 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "%†nŸ found\n", 
‚ame
->
u§_‚ame
->
«me
));

1542 
suc˚ss
:

1543 
	`dx_ªÀa£
(
‰ames
);

1544  
bh
;

1545 
	}
}

1547 
díåy
 *
	$pxt4_lookup
(
öode
 *
dú
, 
díåy
 *díåy, 
Êags
)

1549 
öode
 *inode;

1550 
pxt4_dú_íåy_2
 *
de
;

1551 
buf„r_hód
 *
bh
;

1552 
îr
;

1554 
îr
 = 
	`fs¸y±_¥ï¨e_lookup
(
dú
, 
díåy
, 
Êags
);

1555 i‡(
îr
)

1556  
	`ERR_PTR
(
îr
);

1558 i‡(
díåy
->
d_«me
.
Àn
 > 
PXT4_NAME_LEN
)

1559  
	`ERR_PTR
(-
ENAMETOOLONG
);

1561 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

1562 i‡(
	`IS_ERR
(
bh
))

1563  
	`ERR_CAST
(
bh
);

1564 
öode
 = 
NULL
;

1565 i‡(
bh
) {

1566 
__u32
 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1567 
	`bªl£
(
bh
);

1568 i‡(!
	`pxt4_vÆid_öum
(
dú
->
i_sb
, 
öo
)) {

1569 
	`PXT4_ERROR_INODE
(
dú
, "bad inodênumbî: %u", 
öo
);

1570  
	`ERR_PTR
(-
EFSCORRUPTED
);

1572 i‡(
	`u∆ikñy
(
öo
 =
dú
->
i_öo
)) {

1573 
	`PXT4_ERROR_INODE
(
dú
, "'%pd'ÜinkedÅoÖarent dir",

1574 
díåy
);

1575  
	`ERR_PTR
(-
EFSCORRUPTED
);

1577 
öode
 = 
	`pxt4_igë
(
dú
->
i_sb
, 
öo
, 
PXT4_IGET_NORMAL
);

1578 i‡(
öode
 =
	`ERR_PTR
(-
ESTALE
)) {

1579 
	`PXT4_ERROR_INODE
(
dú
,

1581 
öo
);

1582  
	`ERR_PTR
(-
EFSCORRUPTED
);

1584 i‡(!
	`IS_ERR
(
öode
Ë&& 
	`IS_ENCRYPTED
(
dú
) &&

1585 (
	`S_ISDIR
(
öode
->
i_mode
Ë|| 
	`S_ISLNK
(inode->i_mode)) &&

1586 !
	`fs¸y±_has_≥rmôãd_c⁄ãxt
(
dú
, 
öode
)) {

1587 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1589 
dú
->
i_öo
, 
öode
->i_ino);

1590 
	`ùut
(
öode
);

1591  
	`ERR_PTR
(-
EPERM
);

1594  
	`d_•li˚_Æüs
(
öode
, 
díåy
);

1595 
	}
}

1598 
díåy
 *
	$pxt4_gë_∑ª¡
(
díåy
 *
chûd
)

1600 
__u32
 
öo
;

1601 c⁄° 
q°r
 
dŸdŸ
 = 
	`QSTR_INIT
("..", 2);

1602 
pxt4_dú_íåy_2
 * 
de
;

1603 
buf„r_hód
 *
bh
;

1605 
bh
 = 
	`pxt4_föd_íåy
(
	`d_öode
(
chûd
), &
dŸdŸ
, &
de
, 
NULL
);

1606 i‡(
	`IS_ERR
(
bh
))

1607  
	`ERR_CAST
(
bh
);

1608 i‡(!
bh
)

1609  
	`ERR_PTR
(-
ENOENT
);

1610 
öo
 = 
	`À32_to_˝u
(
de
->
öode
);

1611 
	`bªl£
(
bh
);

1613 i‡(!
	`pxt4_vÆid_öum
(
chûd
->
d_sb
, 
öo
)) {

1614 
	`PXT4_ERROR_INODE
(
	`d_öode
(
chûd
),

1615 "badÖ¨íàöodênumbî: %u", 
öo
);

1616  
	`ERR_PTR
(-
EFSCORRUPTED
);

1619  
	`d_obèö_Æüs
(
	`pxt4_igë
(
chûd
->
d_sb
, 
öo
, 
PXT4_IGET_NORMAL
));

1620 
	}
}

1626 
pxt4_dú_íåy_2
 *

1627 
	$dx_move_dúíts
(*
‰om
, *
to
, 
dx_m≠_íåy
 *
m≠
, 
cou¡
,

1628 
blocksize
)

1630 
ªc_Àn
 = 0;

1632 
cou¡
--) {

1633 
pxt4_dú_íåy_2
 *
de
 = (pxt4_dir_entry_2 *)

1634 (
‰om
 + (
m≠
->
offs
<<2));

1635 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1636 
	`mem˝y
 (
to
, 
de
, 
ªc_Àn
);

1637 ((
pxt4_dú_íåy_2
 *Ë
to
)->
ªc_Àn
 =

1638 
	`pxt4_ªc_Àn_to_disk
(
ªc_Àn
, 
blocksize
);

1639 
de
->
öode
 = 0;

1640 
m≠
++;

1641 
to
 +
ªc_Àn
;

1643  (
pxt4_dú_íåy_2
 *Ë(
to
 - 
ªc_Àn
);

1644 
	}
}

1650 
pxt4_dú_íåy_2
* 
	$dx_∑ck_dúíts
(*
ba£
, 
blocksize
)

1652 
pxt4_dú_íåy_2
 *
√xt
, *
to
, *
¥ev
, *
de
 = (pxt4_dú_íåy_2 *Ë
ba£
;

1653 
ªc_Àn
 = 0;

1655 
¥ev
 = 
to
 = 
de
;

1656 (*)
de
 < 
ba£
 + 
blocksize
) {

1657 
√xt
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

1658 i‡(
de
->
öode
 && de->
«me_Àn
) {

1659 
ªc_Àn
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1660 i‡(
de
 > 
to
)

1661 
	`memmove
(
to
, 
de
, 
ªc_Àn
);

1662 
to
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
‘ec_Àn, 
blocksize
);

1663 
¥ev
 = 
to
;

1664 
to
 = (
pxt4_dú_íåy_2
 *Ë(((*ËtoË+ 
ªc_Àn
);

1666 
de
 = 
√xt
;

1668  
¥ev
;

1669 
	}
}

1676 
pxt4_dú_íåy_2
 *
	$do_•lô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

1677 
buf„r_hód
 **
bh
,
dx_‰ame
 *
‰ame
,

1678 
dx_hash_öfo
 *
höfo
)

1680 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1681 
cou¡
, 
c⁄töued
;

1682 
buf„r_hód
 *
bh2
;

1683 
pxt4_lblk_t
 
√wblock
;

1684 
u32
 
hash2
;

1685 
dx_m≠_íåy
 *
m≠
;

1686 *
d©a1
 = (*
bh
)->
b_d©a
, *
d©a2
;

1687 
•lô
, 
move
, 
size
;

1688 
pxt4_dú_íåy_2
 *
de
 = 
NULL
, *
de2
;

1689 
pxt4_dú_íåy_èû
 *
t
;

1690 
csum_size
 = 0;

1691 
îr
 = 0, 
i
;

1693 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

1694 
csum_size
 = (
pxt4_dú_íåy_èû
);

1696 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

1697 i‡(
	`IS_ERR
(
bh2
)) {

1698 
	`bªl£
(*
bh
);

1699 *
bh
 = 
NULL
;

1700  (
pxt4_dú_íåy_2
 *Ë
bh2
;

1703 
	`BUFFER_TRACE
(*
bh
, "get_write_access");

1704 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, *
bh
);

1705 i‡(
îr
)

1706 
jou∫Æ_îr‹
;

1708 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

1709 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

1710 i‡(
îr
)

1711 
jou∫Æ_îr‹
;

1713 
d©a2
 = 
bh2
->
b_d©a
;

1716 
m≠
 = (
dx_m≠_íåy
 *Ë(
d©a2
 + 
blocksize
);

1717 
cou¡
 = 
	`dx_make_m≠
(
dú
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1718 
blocksize
, 
höfo
, 
m≠
);

1719 
m≠
 -
cou¡
;

1720 
	`dx_s‹t_m≠
(
m≠
, 
cou¡
);

1722 
size
 = 0;

1723 
move
 = 0;

1724 
i
 = 
cou¡
-1; i >= 0; i--) {

1726 i‡(
size
 + 
m≠
[
i
].size/2 > 
blocksize
/2)

1728 
size
 +
m≠
[
i
].size;

1729 
move
++;

1732 
•lô
 = 
cou¡
 - 
move
;

1733 
hash2
 = 
m≠
[
•lô
].
hash
;

1734 
c⁄töued
 = 
hash2
 =
m≠
[
•lô
 - 1].
hash
;

1735 
	`dxåa˚
(
	`¥ötk
(
KERN_INFO
 "Split block %luát %x, %i/%i\n",

1736 ()
	`dx_gë_block
(
‰ame
->
©
),

1737 
hash2
, 
•lô
, 
cou¡
-split));

1740 
de2
 = 
	`dx_move_dúíts
(
d©a1
, 
d©a2
, 
m≠
 + 
•lô
, 
cou¡
 - split,

1741 
blocksize
);

1742 
de
 = 
	`dx_∑ck_dúíts
(
d©a1
, 
blocksize
);

1743 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1744 (*Ë
de
,

1745 
blocksize
);

1746 
de2
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a2
 + (
blocksize
 - 
csum_size
) -

1747 (*Ë
de2
,

1748 
blocksize
);

1749 i‡(
csum_size
) {

1750 
t
 = 
	`PXT4_DIRENT_TAIL
(
d©a2
, 
blocksize
);

1751 
	`öôülize_dúít_èû
(
t
, 
blocksize
);

1753 
t
 = 
	`PXT4_DIRENT_TAIL
(
d©a1
, 
blocksize
);

1754 
	`öôülize_dúít_èû
(
t
, 
blocksize
);

1757 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a1
,

1758 
blocksize
, 1));

1759 
	`dxåa˚
(
	`dx_show_Àaf
(
dú
, 
höfo
, (
pxt4_dú_íåy_2
 *Ë
d©a2
,

1760 
blocksize
, 1));

1763 i‡(
höfo
->
hash
 >
hash2
) {

1764 
	`sw≠
(*
bh
, 
bh2
);

1765 
de
 = 
de2
;

1767 
	`dx_ö£π_block
(
‰ame
, 
hash2
 + 
c⁄töued
, 
√wblock
);

1768 
îr
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
dú
, 
bh2
);

1769 i‡(
îr
)

1770 
jou∫Æ_îr‹
;

1771 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1772 i‡(
îr
)

1773 
jou∫Æ_îr‹
;

1774 
	`bªl£
(
bh2
);

1775 
	`dxåa˚
(
	`dx_show_ödex
("‰ame", 
‰ame
->
íåõs
));

1776  
de
;

1778 
jou∫Æ_îr‹
:

1779 
	`bªl£
(*
bh
);

1780 
	`bªl£
(
bh2
);

1781 *
bh
 = 
NULL
;

1782 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1783  
	`ERR_PTR
(
îr
);

1784 
	}
}

1786 
	$pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

1787 
buf„r_hód
 *
bh
,

1788 *
buf
, 
buf_size
,

1789 
pxt4_fûíame
 *
‚ame
,

1790 
pxt4_dú_íåy_2
 **
de°_de
)

1792 
pxt4_dú_íåy_2
 *
de
;

1793 
ª˛í
 = 
	`PXT4_DIR_REC_LEN
(
	`‚ame_Àn
(
‚ame
));

1794 
∆í
, 
æí
;

1795 
off£t
 = 0;

1796 *
t›
;

1798 
de
 = (
pxt4_dú_íåy_2
 *)
buf
;

1799 
t›
 = 
buf
 + 
buf_size
 - 
ª˛í
;

1800 (*Ë
de
 <
t›
) {

1801 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

1802 
buf
, 
buf_size
, 
off£t
))

1803  -
EFSCORRUPTED
;

1804 i‡(
	`pxt4_m©ch
(
‚ame
, 
de
))

1805  -
EEXIST
;

1806 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1807 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1808 i‡((
de
->
öode
 ? 
æí
 - 
∆í
 :ÑÀnË>
ª˛í
)

1810 
de
 = (
pxt4_dú_íåy_2
 *)((*)dê+ 
æí
);

1811 
off£t
 +
æí
;

1813 i‡((*Ë
de
 > 
t›
)

1814  -
ENOSPC
;

1816 *
de°_de
 = 
de
;

1818 
	}
}

1820 
	$pxt4_ö£π_díåy
(
öode
 *inode,

1821 
pxt4_dú_íåy_2
 *
de
,

1822 
buf_size
,

1823 
pxt4_fûíame
 *
‚ame
)

1826 
∆í
, 
æí
;

1828 
∆í
 = 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
);

1829 
æí
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
buf_size
);

1830 i‡(
de
->
öode
) {

1831 
pxt4_dú_íåy_2
 *
de1
 =

1832 (
pxt4_dú_íåy_2
 *)((*)
de
 + 
∆í
);

1833 
de1
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
æí
 - 
∆í
, 
buf_size
);

1834 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
∆í
, 
buf_size
);

1835 
de
 = 
de1
;

1837 
de
->
fûe_ty≥
 = 
PXT4_FT_UNKNOWN
;

1838 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

1839 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, inode->
i_mode
);

1840 
de
->
«me_Àn
 = 
	`‚ame_Àn
(
‚ame
);

1841 
	`mem˝y
(
de
->
«me
, 
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(fname));

1842 
	}
}

1852 
	$add_dúít_to_buf
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1853 
öode
 *
dú
,

1854 
öode
 *öode, 
pxt4_dú_íåy_2
 *
de
,

1855 
buf„r_hód
 *
bh
)

1857 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1858 
csum_size
 = 0;

1859 
îr
;

1861 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1862 
csum_size
 = (
pxt4_dú_íåy_èû
);

1864 i‡(!
de
) {

1865 
îr
 = 
	`pxt4_föd_de°_de
(
dú
, 
öode
, 
bh
, bh->
b_d©a
,

1866 
blocksize
 - 
csum_size
, 
‚ame
, &
de
);

1867 i‡(
îr
)

1868  
îr
;

1870 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1871 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1872 i‡(
îr
) {

1873 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1874  
îr
;

1878 
	`pxt4_ö£π_díåy
(
öode
, 
de
, 
blocksize
, 
‚ame
);

1891 
dú
->
i_mtime
 = dú->
i_˘ime
 = 
	`cuºít_time
(dir);

1892 
	`pxt4_upd©e_dx_Êag
(
dú
);

1893 
	`öode_öc_ivîsi⁄
(
dú
);

1894 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

1895 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

1896 
îr
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
dú
, 
bh
);

1897 i‡(
îr
)

1898 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

1900 
	}
}

1906 
	$make_ödexed_dú
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

1907 
öode
 *
dú
,

1908 
öode
 *öode, 
buf„r_hód
 *
bh
)

1910 
buf„r_hód
 *
bh2
;

1911 
dx_roŸ
 *
roŸ
;

1912 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

1913 
dx_íåy
 *
íåõs
;

1914 
pxt4_dú_íåy_2
 *
de
, *
de2
;

1915 
pxt4_dú_íåy_èû
 *
t
;

1916 *
d©a1
, *
t›
;

1917 
Àn
;

1918 
ªtvÆ
;

1919 
blocksize
;

1920 
pxt4_lblk_t
 
block
;

1921 
Áke_dúít
 *
fde
;

1922 
csum_size
 = 0;

1924 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

1925 
csum_size
 = (
pxt4_dú_íåy_èû
);

1927 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

1928 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Cª©ög index: inodê%lu\n", 
dú
->
i_öo
));

1929 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1930 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1931 i‡(
ªtvÆ
) {

1932 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
ªtvÆ
);

1933 
	`bªl£
(
bh
);

1934  
ªtvÆ
;

1936 
roŸ
 = (
dx_roŸ
 *Ë
bh
->
b_d©a
;

1939 
fde
 = &
roŸ
->
dŸdŸ
;

1940 
de
 = (
pxt4_dú_íåy_2
 *)((*)
fde
 +

1941 
	`pxt4_ªc_Àn_‰om_disk
(
fde
->
ªc_Àn
, 
blocksize
));

1942 i‡((*Ë
de
 >(((*Ë
roŸ
Ë+ 
blocksize
)) {

1943 
	`PXT4_ERROR_INODE
(
dú
, "invalidÑec_len for '..'");

1944 
	`bªl£
(
bh
);

1945  -
EFSCORRUPTED
;

1947 
Àn
 = ((*Ë
roŸ
Ë+ (
blocksize
 - 
csum_size
Ë- (*Ë
de
;

1950 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

1951 i‡(
	`IS_ERR
(
bh2
)) {

1952 
	`bªl£
(
bh
);

1953  
	`PTR_ERR
(
bh2
);

1955 
	`pxt4_£t_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

1956 
d©a1
 = 
bh2
->
b_d©a
;

1958 
	`mem˝y
 (
d©a1
, 
de
, 
Àn
);

1959 
de
 = (
pxt4_dú_íåy_2
 *Ë
d©a1
;

1960 
t›
 = 
d©a1
 + 
Àn
;

1961 (*)(
de2
 = 
	`pxt4_√xt_íåy
(
de
, 
blocksize
)Ë< 
t›
)

1962 
de
 = 
de2
;

1963 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
d©a1
 + (
blocksize
 - 
csum_size
) -

1964 (*Ë
de
,

1965 
blocksize
);

1967 i‡(
csum_size
) {

1968 
t
 = 
	`PXT4_DIRENT_TAIL
(
d©a1
, 
blocksize
);

1969 
	`öôülize_dúít_èû
(
t
, 
blocksize
);

1973 
de
 = (
pxt4_dú_íåy_2
 *Ë(&
roŸ
->
dŸdŸ
);

1974 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
	`PXT4_DIR_REC_LEN
(2),

1975 
blocksize
);

1976 
	`mem£t
 (&
roŸ
->
öfo
, 0, (root->info));

1977 
roŸ
->
öfo
.
öfo_Àngth
 = (root->info);

1978 
roŸ
->
öfo
.
hash_vîsi⁄
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_def_hash_vîsi⁄
;

1979 
íåõs
 = 
roŸ
->entries;

1980 
	`dx_£t_block
(
íåõs
, 1);

1981 
	`dx_£t_cou¡
(
íåõs
, 1);

1982 
	`dx_£t_limô
(
íåõs
, 
	`dx_roŸ_limô
(
dú
, (
roŸ
->
öfo
)));

1985 
‚ame
->
höfo
.
hash_vîsi⁄
 = 
roŸ
->
öfo
.hash_version;

1986 i‡(
‚ame
->
höfo
.
hash_vîsi⁄
 <
DX_HASH_TEA
)

1987 
‚ame
->
höfo
.
hash_vîsi⁄
 +
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_unsig√d
;

1988 
‚ame
->
höfo
.
£ed
 = 
	`PXT4_SB
(
dú
->
i_sb
)->
s_hash_£ed
;

1989 
	`pxt4fs_dúhash
(
	`‚ame_«me
(
‚ame
), 
	`‚ame_Àn
(‚ame), &‚ame->
höfo
);

1991 
	`mem£t
(
‰ames
, 0, (frames));

1992 
‰ame
 = 
‰ames
;

1993 
‰ame
->
íåõs
 =Éntries;

1994 
‰ame
->
©
 = 
íåõs
;

1995 
‰ame
->
bh
 = bh;

1997 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

1998 i‡(
ªtvÆ
)

1999 
out_‰ames
;

2000 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
dú
, 
bh2
);

2001 i‡(
ªtvÆ
)

2002 
out_‰ames
;

2004 
de
 = 
	`do_•lô
(
h™dÀ
,
dú
, &
bh2
, 
‰ame
, &
‚ame
->
höfo
);

2005 i‡(
	`IS_ERR
(
de
)) {

2006 
ªtvÆ
 = 
	`PTR_ERR
(
de
);

2007 
out_‰ames
;

2010 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh2
);

2011 
out_‰ames
:

2017 i‡(
ªtvÆ
)

2018 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2019 
	`dx_ªÀa£
(
‰ames
);

2020 
	`bªl£
(
bh2
);

2021  
ªtvÆ
;

2022 
	}
}

2034 
	$pxt4_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
díåy
 *dentry,

2035 
öode
 *inode)

2037 
öode
 *
dú
 = 
	`d_öode
(
díåy
->
d_∑ª¡
);

2038 
buf„r_hód
 *
bh
 = 
NULL
;

2039 
pxt4_dú_íåy_2
 *
de
;

2040 
pxt4_dú_íåy_èû
 *
t
;

2041 
su≥r_block
 *
sb
;

2042 
pxt4_fûíame
 
‚ame
;

2043 
ªtvÆ
;

2044 
dx_ÁŒback
=0;

2045 
blocksize
;

2046 
pxt4_lblk_t
 
block
, 
blocks
;

2047 
csum_size
 = 0;

2049 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

2050 
csum_size
 = (
pxt4_dú_íåy_èû
);

2052 
sb
 = 
dú
->
i_sb
;

2053 
blocksize
 = 
sb
->
s_blocksize
;

2054 i‡(!
díåy
->
d_«me
.
Àn
)

2055  -
EINVAL
;

2057 
ªtvÆ
 = 
	`pxt4_‚ame_£tup_fûíame
(
dú
, &
díåy
->
d_«me
, 0, &
‚ame
);

2058 i‡(
ªtvÆ
)

2059  
ªtvÆ
;

2061 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2062 
ªtvÆ
 = 
	`pxt4_åy_add_ölöe_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2063 i‡(
ªtvÆ
 < 0)

2064 
out
;

2065 i‡(
ªtvÆ
 == 1) {

2066 
ªtvÆ
 = 0;

2067 
out
;

2071 i‡(
	`is_dx
(
dú
)) {

2072 
ªtvÆ
 = 
	`pxt4_dx_add_íåy
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
);

2073 i‡(!
ªtvÆ
 || (ªtvÆ !
ERR_BAD_DX_DIR
))

2074 
out
;

2075 
	`pxt4_˛ór_öode_Êag
(
dú
, 
PXT4_INODE_INDEX
);

2076 
dx_ÁŒback
++;

2077 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2079 
blocks
 = 
dú
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

2080 
block
 = 0; block < 
blocks
; block++) {

2081 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
block
, 
DIRENT
);

2082 i‡(
	`IS_ERR
(
bh
)) {

2083 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2084 
bh
 = 
NULL
;

2085 
out
;

2087 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
,

2088 
NULL
, 
bh
);

2089 i‡(
ªtvÆ
 !-
ENOSPC
)

2090 
out
;

2092 i‡(
blocks
 =1 && !
dx_ÁŒback
 &&

2093 
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

2094 
ªtvÆ
 = 
	`make_ödexed_dú
(
h™dÀ
, &
‚ame
, 
dú
,

2095 
öode
, 
bh
);

2096 
bh
 = 
NULL
;

2097 
out
;

2099 
	`bªl£
(
bh
);

2101 
bh
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
block
);

2102 i‡(
	`IS_ERR
(
bh
)) {

2103 
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

2104 
bh
 = 
NULL
;

2105 
out
;

2107 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2108 
de
->
öode
 = 0;

2109 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 - 
csum_size
, blocksize);

2111 i‡(
csum_size
) {

2112 
t
 = 
	`PXT4_DIRENT_TAIL
(
bh
->
b_d©a
, 
blocksize
);

2113 
	`öôülize_dúít_èû
(
t
, 
blocksize
);

2116 
ªtvÆ
 = 
	`add_dúít_to_buf
(
h™dÀ
, &
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2117 
out
:

2118 
	`pxt4_‚ame_‰ì_fûíame
(&
‚ame
);

2119 
	`bªl£
(
bh
);

2120 i‡(
ªtvÆ
 == 0)

2121 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NEWENTRY
);

2122  
ªtvÆ
;

2123 
	}
}

2128 
	$pxt4_dx_add_íåy
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_fûíame
 *
‚ame
,

2129 
öode
 *
dú
, inode *inode)

2131 
dx_‰ame
 
‰ames
[
PXT4_HTREE_LEVEL
], *
‰ame
;

2132 
dx_íåy
 *
íåõs
, *
©
;

2133 
buf„r_hód
 *
bh
;

2134 
su≥r_block
 *
sb
 = 
dú
->
i_sb
;

2135 
pxt4_dú_íåy_2
 *
de
;

2136 
ª°¨t
;

2137 
îr
;

2139 
agaö
:

2140 
ª°¨t
 = 0;

2141 
‰ame
 = 
	`dx_¥obe
(
‚ame
, 
dú
, 
NULL
, 
‰ames
);

2142 i‡(
	`IS_ERR
(
‰ame
))

2143  
	`PTR_ERR
(
‰ame
);

2144 
íåõs
 = 
‰ame
->entries;

2145 
©
 = 
‰ame
->at;

2146 
bh
 = 
	`pxt4_ªad_dúblock
(
dú
, 
	`dx_gë_block
(
‰ame
->
©
), 
DIRENT
);

2147 i‡(
	`IS_ERR
(
bh
)) {

2148 
îr
 = 
	`PTR_ERR
(
bh
);

2149 
bh
 = 
NULL
;

2150 
˛ónup
;

2153 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2154 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2155 i‡(
îr
)

2156 
jou∫Æ_îr‹
;

2158 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
NULL
, 
bh
);

2159 i‡(
îr
 !-
ENOSPC
)

2160 
˛ónup
;

2162 
îr
 = 0;

2164 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "using %u of %uÇodeÉntries\n",

2165 
	`dx_gë_cou¡
(
íåõs
), 
	`dx_gë_limô
(entries)));

2167 i‡(
	`dx_gë_cou¡
(
íåõs
Ë=
	`dx_gë_limô
(entries)) {

2168 
pxt4_lblk_t
 
√wblock
;

2169 
Àvñs
 = 
‰ame
 - 
‰ames
 + 1;

2170 
icou¡
;

2171 
add_Àvñ
 = 1;

2172 
dx_íåy
 *
íåõs2
;

2173 
dx_node
 *
node2
;

2174 
buf„r_hód
 *
bh2
;

2176 
‰ame
 > 
‰ames
) {

2177 i‡(
	`dx_gë_cou¡
((
‰ame
 - 1)->
íåõs
) <

2178 
	`dx_gë_limô
((
‰ame
 - 1)->
íåõs
)) {

2179 
add_Àvñ
 = 0;

2182 
‰ame
--;

2183 
©
 = 
‰ame
->at;

2184 
íåõs
 = 
‰ame
->entries;

2185 
ª°¨t
 = 1;

2187 i‡(
add_Àvñ
 && 
Àvñs
 =
	`pxt4_dú_håì_Àvñ
(
sb
)) {

2188 
	`pxt4_w¨nög
(
sb
, "Directory (ino: %lu) index full, "

2190 
dú
->
i_öo
, 
Àvñs
);

2191 i‡(
	`pxt4_dú_håì_Àvñ
(
sb
Ë< 
PXT4_HTREE_LEVEL
) {

2192 
	`pxt4_w¨nög
(
sb
, "Large directory feature is "

2196 
îr
 = -
ENOSPC
;

2197 
˛ónup
;

2199 
icou¡
 = 
	`dx_gë_cou¡
(
íåõs
);

2200 
bh2
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
dú
, &
√wblock
);

2201 i‡(
	`IS_ERR
(
bh2
)) {

2202 
îr
 = 
	`PTR_ERR
(
bh2
);

2203 
˛ónup
;

2205 
node2
 = (
dx_node
 *)(
bh2
->
b_d©a
);

2206 
íåõs2
 = 
node2
->
íåõs
;

2207 
	`mem£t
(&
node2
->
Áke
, 0, (
Áke_dúít
));

2208 
node2
->
Áke
.
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
sb
->
s_blocksize
,

2209 
sb
->
s_blocksize
);

2210 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2211 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
‰ame
->
bh
);

2212 i‡(
îr
)

2213 
jou∫Æ_îr‹
;

2214 i‡(!
add_Àvñ
) {

2215 
icou¡1
 = 
icou¡
/2, 
icou¡2
 = icount - icount1;

2216 
hash2
 = 
	`dx_gë_hash
(
íåõs
 + 
icou¡1
);

2217 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG
 "Split index %i/%i\n",

2218 
icou¡1
, 
icou¡2
));

2220 
	`BUFFER_TRACE
(
‰ame
->
bh
, "get_write_access");

2221 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2222 (
‰ame
 - 1)->
bh
);

2223 i‡(
îr
)

2224 
jou∫Æ_îr‹
;

2226 
	`mem˝y
((*Ë
íåõs2
, (*Ë(
íåõs
 + 
icou¡1
),

2227 
icou¡2
 * (
dx_íåy
));

2228 
	`dx_£t_cou¡
(
íåõs
, 
icou¡1
);

2229 
	`dx_£t_cou¡
(
íåõs2
, 
icou¡2
);

2230 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2233 i‡(
©
 - 
íåõs
 >
icou¡1
) {

2234 
‰ame
->
©
 =áà© - 
íåõs
 - 
icou¡1
 + 
íåõs2
;

2235 
‰ame
->
íåõs
 =É¡rõ†
íåõs2
;

2236 
	`sw≠
(
‰ame
->
bh
, 
bh2
);

2238 
	`dx_ö£π_block
((
‰ame
 - 1), 
hash2
, 
√wblock
);

2239 
	`dxåa˚
(
	`dx_show_ödex
("node", 
‰ame
->
íåõs
));

2240 
	`dxåa˚
(
	`dx_show_ödex
("node",

2241 ((
dx_node
 *Ë
bh2
->
b_d©a
)->
íåõs
));

2242 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2243 i‡(
îr
)

2244 
jou∫Æ_îr‹
;

2245 
	`bªl£
 (
bh2
);

2246 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2247 (
‰ame
 - 1)->
bh
);

2248 i‡(
îr
)

2249 
jou∫Æ_îr‹
;

2250 i‡(
ª°¨t
) {

2251 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
,

2252 
‰ame
->
bh
);

2253 
jou∫Æ_îr‹
;

2256 
dx_roŸ
 *
dxroŸ
;

2257 
	`mem˝y
((*Ë
íåõs2
, (*Ë
íåõs
,

2258 
icou¡
 * (
dx_íåy
));

2259 
	`dx_£t_limô
(
íåõs2
, 
	`dx_node_limô
(
dú
));

2262 
	`dx_£t_cou¡
(
íåõs
, 1);

2263 
	`dx_£t_block
(
íåõs
 + 0, 
√wblock
);

2264 
dxroŸ
 = (
dx_roŸ
 *)
‰ames
[0].
bh
->
b_d©a
;

2265 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
 += 1;

2266 
	`dxåa˚
(
	`¥ötk
(
KERN_DEBUG


2268 
dxroŸ
->
öfo
.
ödúe˘_Àvñs
));

2269 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
‰ame
->
bh
);

2270 i‡(
îr
)

2271 
jou∫Æ_îr‹
;

2272 
îr
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
, 
dú
, 
bh2
);

2273 
	`bªl£
(
bh2
);

2274 
ª°¨t
 = 1;

2275 
jou∫Æ_îr‹
;

2278 
de
 = 
	`do_•lô
(
h™dÀ
, 
dú
, &
bh
, 
‰ame
, &
‚ame
->
höfo
);

2279 i‡(
	`IS_ERR
(
de
)) {

2280 
îr
 = 
	`PTR_ERR
(
de
);

2281 
˛ónup
;

2283 
îr
 = 
	`add_dúít_to_buf
(
h™dÀ
, 
‚ame
, 
dú
, 
öode
, 
de
, 
bh
);

2284 
˛ónup
;

2286 
jou∫Æ_îr‹
:

2287 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2288 
˛ónup
:

2289 
	`bªl£
(
bh
);

2290 
	`dx_ªÀa£
(
‰ames
);

2294 i‡(
ª°¨t
 && 
îr
 == 0)

2295 
agaö
;

2296  
îr
;

2297 
	}
}

2303 
	$pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2304 
öode
 *
dú
,

2305 
pxt4_dú_íåy_2
 *
de_dñ
,

2306 
buf„r_hód
 *
bh
,

2307 *
íåy_buf
,

2308 
buf_size
,

2309 
csum_size
)

2311 
pxt4_dú_íåy_2
 *
de
, *
pde
;

2312 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2313 
i
;

2315 
i
 = 0;

2316 
pde
 = 
NULL
;

2317 
de
 = (
pxt4_dú_íåy_2
 *)
íåy_buf
;

2318 
i
 < 
buf_size
 - 
csum_size
) {

2319 i‡(
	`pxt4_check_dú_íåy
(
dú
, 
NULL
, 
de
, 
bh
,

2320 
bh
->
b_d©a
, bh->
b_size
, 
i
))

2321  -
EFSCORRUPTED
;

2322 i‡(
de
 =
de_dñ
) {

2323 i‡(
pde
)

2324 
pde
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2325 
	`pxt4_ªc_Àn_‰om_disk
(
pde
->
ªc_Àn
,

2326 
blocksize
) +

2327 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
,

2328 
blocksize
),

2329 
blocksize
);

2331 
de
->
öode
 = 0;

2332 
	`öode_öc_ivîsi⁄
(
dú
);

2335 
i
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
blocksize
);

2336 
pde
 = 
de
;

2337 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2339  -
ENOENT
;

2340 
	}
}

2342 
	$pxt4_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2343 
öode
 *
dú
,

2344 
pxt4_dú_íåy_2
 *
de_dñ
,

2345 
buf„r_hód
 *
bh
)

2347 
îr
, 
csum_size
 = 0;

2349 i‡(
	`pxt4_has_ölöe_d©a
(
dú
)) {

2350 
has_ölöe_d©a
 = 1;

2351 
îr
 = 
	`pxt4_dñëe_ölöe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
, 
bh
,

2352 &
has_ölöe_d©a
);

2353 i‡(
has_ölöe_d©a
)

2354  
îr
;

2357 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2358 
csum_size
 = (
pxt4_dú_íåy_èû
);

2360 
	`BUFFER_TRACE
(
bh
, "get_write_access");

2361 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

2362 i‡(
	`u∆ikñy
(
îr
))

2363 
out
;

2365 
îr
 = 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ
, 
dú
, 
de_dñ
,

2366 
bh
, bh->
b_d©a
,

2367 
dú
->
i_sb
->
s_blocksize
, 
csum_size
);

2368 i‡(
îr
)

2369 
out
;

2371 
	`BUFFER_TRACE
(
bh
, "callÖxt4_handle_dirty_metadata");

2372 
îr
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
dú
, 
bh
);

2373 i‡(
	`u∆ikñy
(
îr
))

2374 
out
;

2377 
out
:

2378 i‡(
îr
 !-
ENOENT
)

2379 
	`pxt4_°d_îr‹
(
dú
->
i_sb
, 
îr
);

2380  
îr
;

2381 
	}
}

2394 
	$pxt4_öc_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2396 
	`öc_∆ök
(
öode
);

2397 i‡(
	`is_dx
(
öode
) &&

2398 (
öode
->
i_∆ök
 > 
PXT4_LINK_MAX
 || inode->i_nlink == 2))

2399 
	`£t_∆ök
(
öode
, 1);

2400 
	}
}

2406 
	$pxt4_dec_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2408 i‡(!
	`S_ISDIR
(
öode
->
i_mode
Ë|| inode->
i_∆ök
 > 2)

2409 
	`dr›_∆ök
(
öode
);

2410 
	}
}

2413 
	$pxt4_add_n⁄dú
(
h™dÀ_t
 *
h™dÀ
,

2414 
díåy
 *díåy, 
öode
 *inode)

2416 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2417 i‡(!
îr
) {

2418 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2419 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2422 
	`dr›_∆ök
(
öode
);

2423 
	`u∆ock_√w_öode
(
öode
);

2424 
	`ùut
(
öode
);

2425  
îr
;

2426 
	}
}

2436 
	$pxt4_¸óã
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
,

2437 
boﬁ
 
ex˛
)

2439 
h™dÀ_t
 *
h™dÀ
;

2440 
öode
 *inode;

2441 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2443 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2444 i‡(
îr
)

2445  
îr
;

2447 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2448 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2449 
ªåy
:

2450 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2451 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2452 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2453 
îr
 = 
	`PTR_ERR
(
öode
);

2454 i‡(!
	`IS_ERR
(
öode
)) {

2455 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2456 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2457 
	`pxt4_£t_a›s
(
öode
);

2458 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2459 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2460 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2462 i‡(
h™dÀ
)

2463 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2464 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2465 
ªåy
;

2466  
îr
;

2467 
	}
}

2469 
	$pxt4_mknod
(
öode
 *
dú
, 
díåy
 *dentry,

2470 
umode_t
 
mode
, 
dev_t
 
rdev
)

2472 
h™dÀ_t
 *
h™dÀ
;

2473 
öode
 *inode;

2474 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2476 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2477 i‡(
îr
)

2478  
îr
;

2480 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2481 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2482 
ªåy
:

2483 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, &
díåy
->
d_«me
, 0,

2484 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2485 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2486 
îr
 = 
	`PTR_ERR
(
öode
);

2487 i‡(!
	`IS_ERR
(
öode
)) {

2488 
	`öô_•ecül_öode
(
öode
, inode->
i_mode
, 
rdev
);

2489 
öode
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

2490 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

2491 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

2492 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2494 i‡(
h™dÀ
)

2495 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2496 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2497 
ªåy
;

2498  
îr
;

2499 
	}
}

2501 
	$pxt4_tmpfûe
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2503 
h™dÀ_t
 *
h™dÀ
;

2504 
öode
 *inode;

2505 
îr
, 
ªåõs
 = 0;

2507 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2508 i‡(
îr
)

2509  
îr
;

2511 
ªåy
:

2512 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
,

2513 
NULL
, 0, NULL,

2514 
PXT4_HT_DIR
,

2515 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

2516 4 + 
PXT4_XATTR_TRANS_BLOCKS
);

2517 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2518 
îr
 = 
	`PTR_ERR
(
öode
);

2519 i‡(!
	`IS_ERR
(
öode
)) {

2520 
öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

2521 
öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

2522 
	`pxt4_£t_a›s
(
öode
);

2523 
	`d_tmpfûe
(
díåy
, 
öode
);

2524 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2525 i‡(
îr
)

2526 
îr_u∆ock_öode
;

2527 
	`m¨k_öode_dúty
(
öode
);

2528 
	`u∆ock_√w_öode
(
öode
);

2530 i‡(
h™dÀ
)

2531 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2532 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2533 
ªåy
;

2534  
îr
;

2535 
îr_u∆ock_öode
:

2536 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2537 
	`u∆ock_√w_öode
(
öode
);

2538  
îr
;

2539 
	}
}

2541 
pxt4_dú_íåy_2
 *
	$pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

2542 
pxt4_dú_íåy_2
 *
de
,

2543 
blocksize
, 
csum_size
,

2544 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
)

2546 
de
->
öode
 = 
	`˝u_to_À32
(öode->
i_öo
);

2547 
de
->
«me_Àn
 = 1;

2548 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
	`PXT4_DIR_REC_LEN
(de->
«me_Àn
),

2549 
blocksize
);

2550 
	`°r˝y
(
de
->
«me
, ".");

2551 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2553 
de
 = 
	`pxt4_√xt_íåy
(de, 
blocksize
);

2554 
de
->
öode
 = 
	`˝u_to_À32
(
∑ª¡_öo
);

2555 
de
->
«me_Àn
 = 2;

2556 i‡(!
dŸdŸ_ªÆ_Àn
)

2557 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(
blocksize
 -

2558 (
csum_size
 + 
	`PXT4_DIR_REC_LEN
(1)),

2559 
blocksize
);

2561 
de
->
ªc_Àn
 = 
	`pxt4_ªc_Àn_to_disk
(

2562 
	`PXT4_DIR_REC_LEN
(
de
->
«me_Àn
), 
blocksize
);

2563 
	`°r˝y
(
de
->
«me
, "..");

2564 
	`pxt4_£t_de_ty≥
(
öode
->
i_sb
, 
de
, 
S_IFDIR
);

2566  
	`pxt4_√xt_íåy
(
de
, 
blocksize
);

2567 
	}
}

2569 
	$pxt4_öô_√w_dú
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

2570 
öode
 *inode)

2572 
buf„r_hód
 *
dú_block
 = 
NULL
;

2573 
pxt4_dú_íåy_2
 *
de
;

2574 
pxt4_dú_íåy_èû
 *
t
;

2575 
pxt4_lblk_t
 
block
 = 0;

2576 
blocksize
 = 
dú
->
i_sb
->
s_blocksize
;

2577 
csum_size
 = 0;

2578 
îr
;

2580 i‡(
	`pxt4_has_mëad©a_csum
(
dú
->
i_sb
))

2581 
csum_size
 = (
pxt4_dú_íåy_èû
);

2583 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_MAY_INLINE_DATA
)) {

2584 
îr
 = 
	`pxt4_åy_¸óã_ölöe_dú
(
h™dÀ
, 
dú
, 
öode
);

2585 i‡(
îr
 < 0 &&Éº !-
ENOSPC
)

2586 
out
;

2587 i‡(!
îr
)

2588 
out
;

2591 
öode
->
i_size
 = 0;

2592 
dú_block
 = 
	`pxt4_≠≥nd
(
h™dÀ
, 
öode
, &
block
);

2593 i‡(
	`IS_ERR
(
dú_block
))

2594  
	`PTR_ERR
(
dú_block
);

2595 
de
 = (
pxt4_dú_íåy_2
 *)
dú_block
->
b_d©a
;

2596 
	`pxt4_öô_dŸ_dŸdŸ
(
öode
, 
de
, 
blocksize
, 
csum_size
, 
dú
->
i_öo
, 0);

2597 
	`£t_∆ök
(
öode
, 2);

2598 i‡(
csum_size
) {

2599 
t
 = 
	`PXT4_DIRENT_TAIL
(
dú_block
->
b_d©a
, 
blocksize
);

2600 
	`öôülize_dúít_èû
(
t
, 
blocksize
);

2603 
	`BUFFER_TRACE
(
dú_block
, "callÖxt4_handle_dirty_metadata");

2604 
îr
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
, 
öode
, 
dú_block
);

2605 i‡(
îr
)

2606 
out
;

2607 
	`£t_buf„r_vîifõd
(
dú_block
);

2608 
out
:

2609 
	`bªl£
(
dú_block
);

2610  
îr
;

2611 
	}
}

2613 
	$pxt4_mkdú
(
öode
 *
dú
, 
díåy
 *díåy, 
umode_t
 
mode
)

2615 
h™dÀ_t
 *
h™dÀ
;

2616 
öode
 *inode;

2617 
îr
, 
¸edôs
, 
ªåõs
 = 0;

2619 i‡(
	`PXT4_DIR_LINK_MAX
(
dú
))

2620  -
EMLINK
;

2622 
îr
 = 
	`dquŸ_öôülize
(
dú
);

2623 i‡(
îr
)

2624  
îr
;

2626 
¸edôs
 = (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

2627 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3);

2628 
ªåy
:

2629 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFDIR
 | 
mode
,

2630 &
díåy
->
d_«me
,

2631 0, 
NULL
, 
PXT4_HT_DIR
, 
¸edôs
);

2632 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

2633 
îr
 = 
	`PTR_ERR
(
öode
);

2634 i‡(
	`IS_ERR
(
öode
))

2635 
out_°›
;

2637 
öode
->
i_›
 = &
pxt4_dú_öode_›î©i⁄s
;

2638 
öode
->
i_f›
 = &
pxt4_dú_›î©i⁄s
;

2639 
îr
 = 
	`pxt4_öô_√w_dú
(
h™dÀ
, 
dú
, 
öode
);

2640 i‡(
îr
)

2641 
out_˛ór_öode
;

2642 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2643 i‡(!
îr
)

2644 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

2645 i‡(
îr
) {

2646 
out_˛ór_öode
:

2647 
	`˛ór_∆ök
(
öode
);

2648 
	`u∆ock_√w_öode
(
öode
);

2649 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2650 
	`ùut
(
öode
);

2651 
out_°›
;

2653 
	`pxt4_öc_cou¡
(
h™dÀ
, 
dú
);

2654 
	`pxt4_upd©e_dx_Êag
(
dú
);

2655 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2656 i‡(
îr
)

2657 
out_˛ór_öode
;

2658 
	`d_ö°™tüã_√w
(
díåy
, 
öode
);

2659 i‡(
	`IS_DIRSYNC
(
dú
))

2660 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2662 
out_°›
:

2663 i‡(
h™dÀ
)

2664 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2665 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

2666 
ªåy
;

2667  
îr
;

2668 
	}
}

2673 
boﬁ
 
	$pxt4_em±y_dú
(
öode
 *inode)

2675 
off£t
;

2676 
buf„r_hód
 *
bh
;

2677 
pxt4_dú_íåy_2
 *
de
, *
de1
;

2678 
su≥r_block
 *
sb
;

2680 i‡(
	`pxt4_has_ölöe_d©a
(
öode
)) {

2681 
has_ölöe_d©a
 = 1;

2682 
ªt
;

2684 
ªt
 = 
	`em±y_ölöe_dú
(
öode
, &
has_ölöe_d©a
);

2685 i‡(
has_ölöe_d©a
)

2686  
ªt
;

2689 
sb
 = 
öode
->
i_sb
;

2690 i‡(
öode
->
i_size
 < 
	`PXT4_DIR_REC_LEN
(1) + PXT4_DIR_REC_LEN(2)) {

2691 
	`PXT4_ERROR_INODE
(
öode
, "invalid size");

2692  
åue
;

2694 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
EITHER
);

2695 i‡(
	`IS_ERR
(
bh
))

2696  
åue
;

2698 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2699 
de1
 = 
	`pxt4_√xt_íåy
(
de
, 
sb
->
s_blocksize
);

2700 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
 ||

2701 
	`À32_to_˝u
(
de1
->
öode
) == 0 ||

2702 
	`°rcmp
(".", 
de
->
«me
Ë|| såcmp("..", 
de1
->name)) {

2703 
	`pxt4_w¨nög_öode
(
öode
, "directory missing '.'ánd/or '..'");

2704 
	`bªl£
(
bh
);

2705  
åue
;

2707 
off£t
 = 
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
) +

2708 
	`pxt4_ªc_Àn_‰om_disk
(
de1
->
ªc_Àn
, 
sb
->
s_blocksize
);

2709 
de
 = 
	`pxt4_√xt_íåy
(
de1
, 
sb
->
s_blocksize
);

2710 
off£t
 < 
öode
->
i_size
) {

2711 i‡((*Ë
de
 >(*Ë(
bh
->
b_d©a
+
sb
->
s_blocksize
)) {

2712 
lblock
;

2713 
	`bªl£
(
bh
);

2714 
lblock
 = 
off£t
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

2715 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 
lblock
, 
EITHER
);

2716 i‡(
	`IS_ERR
(
bh
))

2717  
åue
;

2718 
de
 = (
pxt4_dú_íåy_2
 *Ë
bh
->
b_d©a
;

2720 i‡(
	`pxt4_check_dú_íåy
(
öode
, 
NULL
, 
de
, 
bh
,

2721 
bh
->
b_d©a
, bh->
b_size
, 
off£t
)) {

2722 
de
 = (
pxt4_dú_íåy_2
 *)(
bh
->
b_d©a
 +

2723 
sb
->
s_blocksize
);

2724 
off£t
 = (off£à| (
sb
->
s_blocksize
 - 1)) + 1;

2727 i‡(
	`À32_to_˝u
(
de
->
öode
)) {

2728 
	`bªl£
(
bh
);

2729  
Ál£
;

2731 
off£t
 +
	`pxt4_ªc_Àn_‰om_disk
(
de
->
ªc_Àn
, 
sb
->
s_blocksize
);

2732 
de
 = 
	`pxt4_√xt_íåy
(de, 
sb
->
s_blocksize
);

2734 
	`bªl£
(
bh
);

2735  
åue
;

2736 
	}
}

2750 
	$pxt4_‹ph™_add
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2752 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2753 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2754 
pxt4_ûoc
 
ûoc
;

2755 
îr
 = 0, 
rc
;

2756 
boﬁ
 
dúty
 = 
Ál£
;

2758 i‡(!
sbi
->
s_jou∫Æ
 || 
	`is_bad_öode
(
öode
))

2761 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2762 !
	`öode_is_locked
(
öode
));

2767 i‡(!
	`li°_em±y
(&
	`PXT4_I
(
öode
)->
i_‹ph™
))

2776 
	`J_ASSERT
((
	`S_ISREG
(
öode
->
i_mode
Ë|| 
	`S_ISDIR
(inode->i_mode) ||

2777 
	`S_ISLNK
(
öode
->
i_mode
)Ë|| inode->
i_∆ök
 == 0);

2779 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2780 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2781 i‡(
îr
)

2782 
out
;

2784 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2785 i‡(
îr
)

2786 
out
;

2788 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2793 i‡(!
	`NEXT_ORPHAN
(
öode
) || NEXT_ORPHAN(inode) >

2794 (
	`À32_to_˝u
(
sbi
->
s_es
->
s_öodes_cou¡
))) {

2796 
	`NEXT_ORPHAN
(
öode
Ë
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
);

2797 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

2798 
dúty
 = 
åue
;

2800 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
sbi
->
s_‹ph™
);

2801 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2803 i‡(
dúty
) {

2804 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

2805 
rc
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2806 i‡(!
îr
)

2807 
îr
 = 
rc
;

2808 i‡(
îr
) {

2814 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2815 
	`li°_dñ_öô
(&
	`PXT4_I
(
öode
)->
i_‹ph™
);

2816 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2819 
	`bªl£
(
ûoc
.
bh
);

2821 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%lu\n", 
öode
->
i_öo
);

2822 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %d\n",

2823 
öode
->
i_öo
, 
	`NEXT_ORPHAN
(inode));

2824 
out
:

2825 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

2826  
îr
;

2827 
	}
}

2833 
	$pxt4_‹ph™_dñ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode)

2835 
li°_hód
 *
¥ev
;

2836 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

2837 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2838 
__u32
 
öo_√xt
;

2839 
pxt4_ûoc
 
ûoc
;

2840 
îr
 = 0;

2842 i‡(!
sbi
->
s_jou∫Æ
 && !(sbi->
s_mou¡_°©e
 & 
PXT4_ORPHAN_FS
))

2845 
	`WARN_ON_ONCE
(!(
öode
->
i_°©e
 & (
I_NEW
 | 
I_FREEING
)) &&

2846 !
	`öode_is_locked
(
öode
));

2848 i‡(
	`li°_em±y
(&
ei
->
i_‹ph™
))

2851 i‡(
h™dÀ
) {

2853 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

2856 
	`muãx_lock
(&
sbi
->
s_‹ph™_lock
);

2857 
	`jbd_debug
(4, "ªmovêöodê%lu from oΩh™Üi°\n", 
öode
->
i_öo
);

2859 
¥ev
 = 
ei
->
i_‹ph™
.prev;

2860 
	`li°_dñ_öô
(&
ei
->
i_‹ph™
);

2866 i‡(!
h™dÀ
 || 
îr
) {

2867 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2868 
out_îr
;

2871 
öo_√xt
 = 
	`NEXT_ORPHAN
(
öode
);

2872 i‡(
¥ev
 =&
sbi
->
s_‹ph™
) {

2873 
	`jbd_debug
(4, "su≥rblock wû»poöàtÿ%u\n", 
öo_√xt
);

2874 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

2875 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

2876 i‡(
îr
) {

2877 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2878 
out_bªl£
;

2880 
sbi
->
s_es
->
s_œ°_‹ph™
 = 
	`˝u_to_À32
(
öo_√xt
);

2881 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2882 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
öode
->
i_sb
);

2884 
pxt4_ûoc
 
ûoc2
;

2885 
öode
 *
i_¥ev
 =

2886 &
	`li°_íåy
(
¥ev
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

2888 
	`jbd_debug
(4, "orphan inode %lu willÖointÅo %u\n",

2889 
i_¥ev
->
i_öo
, 
öo_√xt
);

2890 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

2891 i‡(
îr
) {

2892 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2893 
out_bªl£
;

2895 
	`NEXT_ORPHAN
(
i_¥ev
Ë
öo_√xt
;

2896 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
i_¥ev
, &
ûoc2
);

2897 
	`muãx_u∆ock
(&
sbi
->
s_‹ph™_lock
);

2899 i‡(
îr
)

2900 
out_bªl£
;

2901 
	`NEXT_ORPHAN
(
öode
) = 0;

2902 
îr
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

2903 
out_îr
:

2904 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr
);

2905  
îr
;

2907 
out_bªl£
:

2908 
	`bªl£
(
ûoc
.
bh
);

2909 
out_îr
;

2910 
	}
}

2912 
	$pxt4_rmdú
(
öode
 *
dú
, 
díåy
 *dentry)

2914 
ªtvÆ
;

2915 
öode
 *inode;

2916 
buf„r_hód
 *
bh
;

2917 
pxt4_dú_íåy_2
 *
de
;

2918 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2920 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

2921  -
EIO
;

2925 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

2926 i‡(
ªtvÆ
)

2927  
ªtvÆ
;

2928 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

2929 i‡(
ªtvÆ
)

2930  
ªtvÆ
;

2932 
ªtvÆ
 = -
ENOENT
;

2933 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

2934 i‡(
	`IS_ERR
(
bh
))

2935  
	`PTR_ERR
(
bh
);

2936 i‡(!
bh
)

2937 
íd_rmdú
;

2939 
öode
 = 
	`d_öode
(
díåy
);

2941 
ªtvÆ
 = -
EFSCORRUPTED
;

2942 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

2943 
íd_rmdú
;

2945 
ªtvÆ
 = -
ENOTEMPTY
;

2946 i‡(!
	`pxt4_em±y_dú
(
öode
))

2947 
íd_rmdú
;

2949 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

2950 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

2951 i‡(
	`IS_ERR
(
h™dÀ
)) {

2952 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

2953 
h™dÀ
 = 
NULL
;

2954 
íd_rmdú
;

2957 i‡(
	`IS_DIRSYNC
(
dú
))

2958 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2960 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

2961 i‡(
ªtvÆ
)

2962 
íd_rmdú
;

2963 i‡(!
	`PXT4_DIR_LINK_EMPTY
(
öode
))

2964 
	`pxt4_w¨nög_öode
(
öode
,

2966 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
,

2967 
öode
->
i_∆ök
);

2968 
	`öode_öc_ivîsi⁄
(
öode
);

2969 
	`˛ór_∆ök
(
öode
);

2973 
öode
->
i_size
 = 0;

2974 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

2975 
öode
->
i_˘ime
 = 
dú
->i_˘imêdú->
i_mtime
 = 
	`cuºít_time
(inode);

2976 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2977 
	`pxt4_dec_cou¡
(
h™dÀ
, 
dú
);

2978 
	`pxt4_upd©e_dx_Êag
(
dú
);

2979 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

2981 
íd_rmdú
:

2982 
	`bªl£
(
bh
);

2983 i‡(
h™dÀ
)

2984 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2985  
ªtvÆ
;

2986 
	}
}

2988 
	$pxt4_u∆ök
(
öode
 *
dú
, 
díåy
 *dentry)

2990 
ªtvÆ
;

2991 
öode
 *inode;

2992 
buf„r_hód
 *
bh
;

2993 
pxt4_dú_íåy_2
 *
de
;

2994 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

2996 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

2997  -
EIO
;

2999 
	`åa˚_pxt4_u∆ök_íãr
(
dú
, 
díåy
);

3002 
ªtvÆ
 = 
	`dquŸ_öôülize
(
dú
);

3003 i‡(
ªtvÆ
)

3004  
ªtvÆ
;

3005 
ªtvÆ
 = 
	`dquŸ_öôülize
(
	`d_öode
(
díåy
));

3006 i‡(
ªtvÆ
)

3007  
ªtvÆ
;

3009 
ªtvÆ
 = -
ENOENT
;

3010 
bh
 = 
	`pxt4_föd_íåy
(
dú
, &
díåy
->
d_«me
, &
de
, 
NULL
);

3011 i‡(
	`IS_ERR
(
bh
))

3012  
	`PTR_ERR
(
bh
);

3013 i‡(!
bh
)

3014 
íd_u∆ök
;

3016 
öode
 = 
	`d_öode
(
díåy
);

3018 
ªtvÆ
 = -
EFSCORRUPTED
;

3019 i‡(
	`À32_to_˝u
(
de
->
öode
Ë!öode->
i_öo
)

3020 
íd_u∆ök
;

3022 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3023 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
));

3024 i‡(
	`IS_ERR
(
h™dÀ
)) {

3025 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3026 
h™dÀ
 = 
NULL
;

3027 
íd_u∆ök
;

3030 i‡(
	`IS_DIRSYNC
(
dú
))

3031 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3033 i‡(
öode
->
i_∆ök
 == 0) {

3034 
	`pxt4_w¨nög_öode
(
öode
, "Deleting file '%.*s' withÇoÜinks",

3035 
díåy
->
d_«me
.
Àn
, díåy->d_«me.
«me
);

3036 
	`£t_∆ök
(
öode
, 1);

3038 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3039 i‡(
ªtvÆ
)

3040 
íd_u∆ök
;

3041 
dú
->
i_˘ime
 = dú->
i_mtime
 = 
	`cuºít_time
(dir);

3042 
	`pxt4_upd©e_dx_Êag
(
dú
);

3043 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
dú
);

3044 
	`dr›_∆ök
(
öode
);

3045 i‡(!
öode
->
i_∆ök
)

3046 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3047 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3048 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3050 
íd_u∆ök
:

3051 
	`bªl£
(
bh
);

3052 i‡(
h™dÀ
)

3053 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3054 
	`åa˚_pxt4_u∆ök_exô
(
díåy
, 
ªtvÆ
);

3055  
ªtvÆ
;

3056 
	}
}

3058 
	$pxt4_symlök
(
öode
 *
dú
,

3059 
díåy
 *díåy, c⁄° *
sym«me
)

3061 
h™dÀ_t
 *
h™dÀ
;

3062 
öode
 *inode;

3063 
îr
, 
Àn
 = 
	`°æí
(
sym«me
);

3064 
¸edôs
;

3065 
fs¸y±_°r
 
disk_lök
;

3067 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
dú
->
i_sb
))))

3068  -
EIO
;

3070 
îr
 = 
	`fs¸y±_¥ï¨e_symlök
(
dú
, 
sym«me
, 
Àn
, dú->
i_sb
->
s_blocksize
,

3071 &
disk_lök
);

3072 i‡(
îr
)

3073  
îr
;

3075 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3076 i‡(
îr
)

3077  
îr
;

3079 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3086 
¸edôs
 = 4 + 
	`PXT4_MAXQUOTAS_INIT_BLOCKS
(
dú
->
i_sb
) +

3087 
PXT4_XATTR_TRANS_BLOCKS
;

3095 
¸edôs
 = 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3096 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 3;

3099 
öode
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
S_IFLNK
|
S_IRWXUGO
,

3100 &
díåy
->
d_«me
, 0, 
NULL
,

3101 
PXT4_HT_DIR
, 
¸edôs
);

3102 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3103 i‡(
	`IS_ERR
(
öode
)) {

3104 i‡(
h™dÀ
)

3105 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3106  
	`PTR_ERR
(
öode
);

3109 i‡(
	`IS_ENCRYPTED
(
öode
)) {

3110 
îr
 = 
	`fs¸y±_í¸y±_symlök
(
öode
, 
sym«me
, 
Àn
, &
disk_lök
);

3111 i‡(
îr
)

3112 
îr_dr›_öode
;

3113 
öode
->
i_›
 = &
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3116 i‡((
disk_lök
.
Àn
 > 
PXT4_N_BLOCKS
 * 4)) {

3117 i‡(!
	`IS_ENCRYPTED
(
öode
))

3118 
öode
->
i_›
 = &
pxt4_symlök_öode_›î©i⁄s
;

3119 
	`öode_nohighmem
(
öode
);

3120 
	`pxt4_£t_a›s
(
öode
);

3131 
	`dr›_∆ök
(
öode
);

3132 
îr
 = 
	`pxt4_‹ph™_add
(
h™dÀ
, 
öode
);

3133 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3134 
h™dÀ
 = 
NULL
;

3135 i‡(
îr
)

3136 
îr_dr›_öode
;

3137 
îr
 = 
	`__∑ge_symlök
(
öode
, 
disk_lök
.
«me
, disk_lök.
Àn
, 1);

3138 i‡(
îr
)

3139 
îr_dr›_öode
;

3144 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3145 
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3146 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 1);

3147 i‡(
	`IS_ERR
(
h™dÀ
)) {

3148 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

3149 
h™dÀ
 = 
NULL
;

3150 
îr_dr›_öode
;

3152 
	`£t_∆ök
(
öode
, 1);

3153 
îr
 = 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3154 i‡(
îr
)

3155 
îr_dr›_öode
;

3158 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
);

3159 i‡(!
	`IS_ENCRYPTED
(
öode
)) {

3160 
öode
->
i_›
 = &
pxt4_Á°_symlök_öode_›î©i⁄s
;

3161 
öode
->
i_lök
 = (*)&
	`PXT4_I
(öode)->
i_d©a
;

3163 
	`mem˝y
((*)&
	`PXT4_I
(
öode
)->
i_d©a
, 
disk_lök
.
«me
,

3164 
disk_lök
.
Àn
);

3165 
öode
->
i_size
 = 
disk_lök
.
Àn
 - 1;

3167 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

3168 
îr
 = 
	`pxt4_add_n⁄dú
(
h™dÀ
, 
díåy
, 
öode
);

3169 i‡(!
îr
 && 
	`IS_DIRSYNC
(
dú
))

3170 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3172 i‡(
h™dÀ
)

3173 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3174 
out_‰ì_í¸y±ed_lök
;

3176 
îr_dr›_öode
:

3177 i‡(
h™dÀ
)

3178 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3179 
	`˛ór_∆ök
(
öode
);

3180 
	`u∆ock_√w_öode
(
öode
);

3181 
	`ùut
(
öode
);

3182 
out_‰ì_í¸y±ed_lök
:

3183 i‡(
disk_lök
.
«me
 !(*)
sym«me
)

3184 
	`k‰ì
(
disk_lök
.
«me
);

3185  
îr
;

3186 
	}
}

3188 
	$pxt4_lök
(
díåy
 *
ﬁd_díåy
,

3189 
öode
 *
dú
, 
díåy
 *dentry)

3191 
h™dÀ_t
 *
h™dÀ
;

3192 
öode
 *öodê
	`d_öode
(
ﬁd_díåy
);

3193 
îr
, 
ªåõs
 = 0;

3195 i‡(
öode
->
i_∆ök
 >
PXT4_LINK_MAX
)

3196  -
EMLINK
;

3198 
îr
 = 
	`fs¸y±_¥ï¨e_lök
(
ﬁd_díåy
, 
dú
, 
díåy
);

3199 i‡(
îr
)

3200  
îr
;

3202 i‡((
	`pxt4_ã°_öode_Êag
(
dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3203 (!
	`¥ojid_eq
(
	`PXT4_I
(
dú
)->
i_¥ojid
,

3204 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3205  -
EXDEV
;

3207 
îr
 = 
	`dquŸ_öôülize
(
dú
);

3208 i‡(
îr
)

3209  
îr
;

3211 
ªåy
:

3212 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
dú
, 
PXT4_HT_DIR
,

3213 (
	`PXT4_DATA_TRANS_BLOCKS
(
dú
->
i_sb
) +

3214 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
) + 1);

3215 i‡(
	`IS_ERR
(
h™dÀ
))

3216  
	`PTR_ERR
(
h™dÀ
);

3218 i‡(
	`IS_DIRSYNC
(
dú
))

3219 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3221 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

3222 
	`pxt4_öc_cou¡
(
h™dÀ
, 
öode
);

3223 
	`ihﬁd
(
öode
);

3225 
îr
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
díåy
, 
öode
);

3226 i‡(!
îr
) {

3227 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

3231 i‡(
öode
->
i_∆ök
 == 1)

3232 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
öode
);

3233 
	`d_ö°™tüã
(
díåy
, 
öode
);

3235 
	`dr›_∆ök
(
öode
);

3236 
	`ùut
(
öode
);

3238 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3239 i‡(
îr
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
dú
->
i_sb
, &
ªåõs
))

3240 
ªåy
;

3241  
îr
;

3242 
	}
}

3250 
buf„r_hód
 *
	$pxt4_gë_fú°_dú_block
(
h™dÀ_t
 *
h™dÀ
,

3251 
öode
 *inode,

3252 *
ªtvÆ
,

3253 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3254 *
ölöed
)

3256 
buf„r_hód
 *
bh
;

3258 i‡(!
	`pxt4_has_ölöe_d©a
(
öode
)) {

3259 
bh
 = 
	`pxt4_ªad_dúblock
(
öode
, 0, 
EITHER
);

3260 i‡(
	`IS_ERR
(
bh
)) {

3261 *
ªtvÆ
 = 
	`PTR_ERR
(
bh
);

3262  
NULL
;

3264 *
∑ª¡_de
 = 
	`pxt4_√xt_íåy
(

3265 (
pxt4_dú_íåy_2
 *)
bh
->
b_d©a
,

3266 
öode
->
i_sb
->
s_blocksize
);

3267  
bh
;

3270 *
ölöed
 = 1;

3271  
	`pxt4_gë_fú°_ölöe_block
(
öode
, 
∑ª¡_de
, 
ªtvÆ
);

3272 
	}
}

3274 
	spxt4_ª«mít
 {

3275 
öode
 *
	mdú
;

3276 
díåy
 *
	mdíåy
;

3277 
öode
 *
	möode
;

3278 
boﬁ
 
	mis_dú
;

3279 
	mdú_∆ök_dñè
;

3282 
buf„r_hód
 *
	mbh
;

3283 
pxt4_dú_íåy_2
 *
	mde
;

3284 
	mölöed
;

3287 
buf„r_hód
 *
	mdú_bh
;

3288 
pxt4_dú_íåy_2
 *
	m∑ª¡_de
;

3289 
	mdú_ölöed
;

3292 
	$pxt4_ª«me_dú_¥ï¨e
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3294 
ªtvÆ
;

3296 
ít
->
dú_bh
 = 
	`pxt4_gë_fú°_dú_block
(
h™dÀ
,É¡->
öode
,

3297 &
ªtvÆ
, &
ít
->
∑ª¡_de
,

3298 &
ít
->
dú_ölöed
);

3299 i‡(!
ít
->
dú_bh
)

3300  
ªtvÆ
;

3301 i‡(
	`À32_to_˝u
(
ít
->
∑ª¡_de
->
öode
Ë!ít->
dú
->
i_öo
)

3302  -
EFSCORRUPTED
;

3303 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "get_write_access");

3304  
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
dú_bh
);

3305 
	}
}

3307 
	$pxt4_ª«me_dú_föish
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3308 
dú_öo
)

3310 
ªtvÆ
;

3312 
ít
->
∑ª¡_de
->
öode
 = 
	`˝u_to_À32
(
dú_öo
);

3313 
	`BUFFER_TRACE
(
ít
->
dú_bh
, "callÖxt4_handle_dirty_metadata");

3314 i‡(!
ít
->
dú_ölöed
) {

3315 i‡(
	`is_dx
(
ít
->
öode
)) {

3316 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dx_node
(
h™dÀ
,

3317 
ít
->
öode
,

3318 
ít
->
dú_bh
);

3320 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
,

3321 
ít
->
öode
,

3322 
ít
->
dú_bh
);

3325 
ªtvÆ
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
öode
);

3327 i‡(
ªtvÆ
) {

3328 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3329  
ªtvÆ
;

3332 
	}
}

3334 
	$pxt4_£ã¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3335 
öo
, 
fûe_ty≥
)

3337 
ªtvÆ
;

3339 
	`BUFFER_TRACE
(
ít
->
bh
, "get writeáccess");

3340 
ªtvÆ
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ít
->
bh
);

3341 i‡(
ªtvÆ
)

3342  
ªtvÆ
;

3343 
ít
->
de
->
öode
 = 
	`˝u_to_À32
(
öo
);

3344 i‡(
	`pxt4_has_„©uª_fûëy≥
(
ít
->
dú
->
i_sb
))

3345 
ít
->
de
->
fûe_ty≥
 = file_type;

3346 
	`öode_öc_ivîsi⁄
(
ít
->
dú
);

3347 
ít
->
dú
->
i_˘ime
 =É¡->dú->
i_mtime
 =

3348 
	`cuºít_time
(
ít
->
dú
);

3349 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3350 
	`BUFFER_TRACE
(
ít
->
bh
, "callÖxt4_handle_dirty_metadata");

3351 i‡(!
ít
->
ölöed
) {

3352 
ªtvÆ
 = 
	`pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ
,

3353 
ít
->
dú
,É¡->
bh
);

3354 i‡(
	`u∆ikñy
(
ªtvÆ
)) {

3355 
	`pxt4_°d_îr‹
(
ít
->
dú
->
i_sb
, 
ªtvÆ
);

3356  
ªtvÆ
;

3359 
	`bªl£
(
ít
->
bh
);

3360 
ít
->
bh
 = 
NULL
;

3363 
	}
}

3365 
	$pxt4_föd_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
dú
,

3366 c⁄° 
q°r
 *
d_«me
)

3368 
ªtvÆ
 = -
ENOENT
;

3369 
buf„r_hód
 *
bh
;

3370 
pxt4_dú_íåy_2
 *
de
;

3372 
bh
 = 
	`pxt4_föd_íåy
(
dú
, 
d_«me
, &
de
, 
NULL
);

3373 i‡(
	`IS_ERR
(
bh
))

3374  
	`PTR_ERR
(
bh
);

3375 i‡(
bh
) {

3376 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
dú
, 
de
, 
bh
);

3377 
	`bªl£
(
bh
);

3379  
ªtvÆ
;

3380 
	}
}

3382 
	$pxt4_ª«me_dñëe
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
,

3383 
f‹˚_ªªad
)

3385 
ªtvÆ
;

3392 i‡(
	`À32_to_˝u
(
ít
->
de
->
öode
Ë!ít->öode->
i_öo
 ||

3393 
ít
->
de
->
«me_Àn
 !ít->
díåy
->
d_«me
.
Àn
 ||

3394 
	`°∫cmp
(
ít
->
de
->
«me
,É¡->
díåy
->
d_«me
.name,

3395 
ít
->
de
->
«me_Àn
) ||

3396 
f‹˚_ªªad
) {

3397 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3398 &
ít
->
díåy
->
d_«me
);

3400 
ªtvÆ
 = 
	`pxt4_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,É¡->
de
,É¡->
bh
);

3401 i‡(
ªtvÆ
 =-
ENOENT
) {

3402 
ªtvÆ
 = 
	`pxt4_föd_dñëe_íåy
(
h™dÀ
, 
ít
->
dú
,

3403 &
ít
->
díåy
->
d_«me
);

3407 i‡(
ªtvÆ
) {

3408 
	`pxt4_w¨nög_öode
(
ít
->
dú
,

3410 
ít
->
dú
->
i_∆ök
, 
ªtvÆ
);

3412 
	}
}

3414 
	$pxt4_upd©e_dú_cou¡
(
h™dÀ_t
 *
h™dÀ
, 
pxt4_ª«mít
 *
ít
)

3416 i‡(
ít
->
dú_∆ök_dñè
) {

3417 i‡(
ít
->
dú_∆ök_dñè
 == -1)

3418 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ít
->
dú
);

3420 
	`pxt4_öc_cou¡
(
h™dÀ
, 
ít
->
dú
);

3421 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ít
->
dú
);

3423 
	}
}

3425 
öode
 *
	$pxt4_whôeout_f‹_ª«me
(
pxt4_ª«mít
 *
ít
,

3426 
¸edôs
, 
h™dÀ_t
 **
h
)

3428 
öode
 *
wh
;

3429 
h™dÀ_t
 *
h™dÀ
;

3430 
ªåõs
 = 0;

3436 
¸edôs
 +(
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
ít
->
dú
->
i_sb
) +

3437 
PXT4_XATTR_TRANS_BLOCKS
 + 4);

3438 
ªåy
:

3439 
wh
 = 
	`pxt4_√w_öode_°¨t_h™dÀ
(
ít
->
dú
, 
S_IFCHR
 | 
WHITEOUT_MODE
,

3440 &
ít
->
díåy
->
d_«me
, 0, 
NULL
,

3441 
PXT4_HT_DIR
, 
¸edôs
);

3443 
h™dÀ
 = 
	`pxt4_jou∫Æ_cuºít_h™dÀ
();

3444 i‡(
	`IS_ERR
(
wh
)) {

3445 i‡(
h™dÀ
)

3446 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3447 i‡(
	`PTR_ERR
(
wh
Ë=-
ENOSPC
 &&

3448 
	`pxt4_should_ªåy_Æloc
(
ít
->
dú
->
i_sb
, &
ªåõs
))

3449 
ªåy
;

3451 *
h
 = 
h™dÀ
;

3452 
	`öô_•ecül_öode
(
wh
, wh->
i_mode
, 
WHITEOUT_DEV
);

3453 
wh
->
i_›
 = &
pxt4_•ecül_öode_›î©i⁄s
;

3455  
wh
;

3456 
	}
}

3466 
	$pxt4_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3467 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3468 
Êags
)

3470 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3471 
pxt4_ª«mít
 
ﬁd
 = {

3472 .
dú
 = 
ﬁd_dú
,

3473 .
díåy
 = 
ﬁd_díåy
,

3474 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3476 
pxt4_ª«mít
 
√w
 = {

3477 .
dú
 = 
√w_dú
,

3478 .
díåy
 = 
√w_díåy
,

3479 .
öode
 = 
	`d_öode
(
√w_díåy
),

3481 
f‹˚_ªªad
;

3482 
ªtvÆ
;

3483 
öode
 *
whôeout
 = 
NULL
;

3484 
¸edôs
;

3485 
u8
 
ﬁd_fûe_ty≥
;

3487 i‡(
√w
.
öode
 &&Çew.öode->
i_∆ök
 == 0) {

3488 
	`PXT4_ERROR_INODE
(
√w
.
öode
,

3490  -
EFSCORRUPTED
;

3493 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
)) &&

3494 (!
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3495 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)))

3496  -
EXDEV
;

3498 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3499 i‡(
ªtvÆ
)

3500  
ªtvÆ
;

3501 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3502 i‡(
ªtvÆ
)

3503  
ªtvÆ
;

3507 i‡(
√w
.
öode
) {

3508 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
öode
);

3509 i‡(
ªtvÆ
)

3510  
ªtvÆ
;

3513 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
, &ﬁd.
de
, 
NULL
);

3514 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3515  
	`PTR_ERR
(
ﬁd
.
bh
);

3522 
ªtvÆ
 = -
ENOENT
;

3523 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3524 
íd_ª«me
;

3526 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3527 &
√w
.
de
, &√w.
ölöed
);

3528 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3529 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3530 
√w
.
bh
 = 
NULL
;

3531 
íd_ª«me
;

3533 i‡(
√w
.
bh
) {

3534 i‡(!
√w
.
öode
) {

3535 
	`bªl£
(
√w
.
bh
);

3536 
√w
.
bh
 = 
NULL
;

3539 i‡(
√w
.
öode
 && !
	`ã°_›t
“ew.
dú
->
i_sb
, 
NO_AUTO_DA_ALLOC
))

3540 
	`pxt4_Æloc_da_blocks
(
ﬁd
.
öode
);

3542 
¸edôs
 = (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3543 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2);

3544 i‡(!(
Êags
 & 
RENAME_WHITEOUT
)) {

3545 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
, 
¸edôs
);

3546 i‡(
	`IS_ERR
(
h™dÀ
)) {

3547 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3548 
h™dÀ
 = 
NULL
;

3549 
íd_ª«me
;

3552 
whôeout
 = 
	`pxt4_whôeout_f‹_ª«me
(&
ﬁd
, 
¸edôs
, &
h™dÀ
);

3553 i‡(
	`IS_ERR
(
whôeout
)) {

3554 
ªtvÆ
 = 
	`PTR_ERR
(
whôeout
);

3555 
whôeout
 = 
NULL
;

3556 
íd_ª«me
;

3560 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3561 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3563 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3564 i‡(
√w
.
öode
) {

3565 
ªtvÆ
 = -
ENOTEMPTY
;

3566 i‡(!
	`pxt4_em±y_dú
(
√w
.
öode
))

3567 
íd_ª«me
;

3569 
ªtvÆ
 = -
EMLINK
;

3570 i‡(
√w
.
dú
 !
ﬁd
.dú && 
	`PXT4_DIR_LINK_MAX
(new.dir))

3571 
íd_ª«me
;

3573 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3574 i‡(
ªtvÆ
)

3575 
íd_ª«me
;

3584 
f‹˚_ªªad
 = (
√w
.
dú
->
i_öo
 =
ﬁd
.dir->i_ino &&

3585 
	`pxt4_ã°_öode_Êag
(
√w
.
dú
, 
PXT4_INODE_INLINE_DATA
));

3587 
ﬁd_fûe_ty≥
 = 
ﬁd
.
de
->
fûe_ty≥
;

3588 i‡(
whôeout
) {

3593 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
whôeout
->
i_öo
,

3594 
PXT4_FT_CHRDEV
);

3595 i‡(
ªtvÆ
)

3596 
íd_ª«me
;

3597 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
whôeout
);

3599 i‡(!
√w
.
bh
) {

3600 
ªtvÆ
 = 
	`pxt4_add_íåy
(
h™dÀ
, 
√w
.
díåy
, 
ﬁd
.
öode
);

3601 i‡(
ªtvÆ
)

3602 
íd_ª«me
;

3604 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
,

3605 
ﬁd
.
öode
->
i_öo
, 
ﬁd_fûe_ty≥
);

3606 i‡(
ªtvÆ
)

3607 
íd_ª«me
;

3609 i‡(
f‹˚_ªªad
)

3610 
f‹˚_ªªad
 = !
	`pxt4_ã°_öode_Êag
(
√w
.
dú
,

3611 
PXT4_INODE_INLINE_DATA
);

3617 
ﬁd
.
öode
->
i_˘ime
 = 
	`cuºít_time
(old.inode);

3618 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3620 i‡(!
whôeout
) {

3624 
	`pxt4_ª«me_dñëe
(
h™dÀ
, &
ﬁd
, 
f‹˚_ªªad
);

3627 i‡(
√w
.
öode
) {

3628 
	`pxt4_dec_cou¡
(
h™dÀ
, 
√w
.
öode
);

3629 
√w
.
öode
->
i_˘ime
 = 
	`cuºít_time
(new.inode);

3631 
ﬁd
.
dú
->
i_˘ime
 = old.dú->
i_mtime
 = 
	`cuºít_time
(old.dir);

3632 
	`pxt4_upd©e_dx_Êag
(
ﬁd
.
dú
);

3633 i‡(
ﬁd
.
dú_bh
) {

3634 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3635 i‡(
ªtvÆ
)

3636 
íd_ª«me
;

3638 
	`pxt4_dec_cou¡
(
h™dÀ
, 
ﬁd
.
dú
);

3639 i‡(
√w
.
öode
) {

3643 
	`˛ór_∆ök
(
√w
.
öode
);

3645 
	`pxt4_öc_cou¡
(
h™dÀ
, 
√w
.
dú
);

3646 
	`pxt4_upd©e_dx_Êag
(
√w
.
dú
);

3647 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
dú
);

3650 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
dú
);

3651 i‡(
√w
.
öode
) {

3652 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3653 i‡(!
√w
.
öode
->
i_∆ök
)

3654 
	`pxt4_‹ph™_add
(
h™dÀ
, 
√w
.
öode
);

3656 
ªtvÆ
 = 0;

3658 
íd_ª«me
:

3659 
	`bªl£
(
ﬁd
.
dú_bh
);

3660 
	`bªl£
(
ﬁd
.
bh
);

3661 
	`bªl£
(
√w
.
bh
);

3662 i‡(
whôeout
) {

3663 i‡(
ªtvÆ
)

3664 
	`dr›_∆ök
(
whôeout
);

3665 
	`u∆ock_√w_öode
(
whôeout
);

3666 
	`ùut
(
whôeout
);

3668 i‡(
h™dÀ
)

3669 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3670  
ªtvÆ
;

3671 
	}
}

3673 
	$pxt4_¸oss_ª«me
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3674 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
)

3676 
h™dÀ_t
 *
h™dÀ
 = 
NULL
;

3677 
pxt4_ª«mít
 
ﬁd
 = {

3678 .
dú
 = 
ﬁd_dú
,

3679 .
díåy
 = 
ﬁd_díåy
,

3680 .
öode
 = 
	`d_öode
(
ﬁd_díåy
),

3682 
pxt4_ª«mít
 
√w
 = {

3683 .
dú
 = 
√w_dú
,

3684 .
díåy
 = 
√w_díåy
,

3685 .
öode
 = 
	`d_öode
(
√w_díåy
),

3687 
u8
 
√w_fûe_ty≥
;

3688 
ªtvÆ
;

3689 
time•ec64
 
˘ime
;

3691 i‡((
	`pxt4_ã°_öode_Êag
(
√w_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3692 !
	`¥ojid_eq
(
	`PXT4_I
(
√w_dú
)->
i_¥ojid
,

3693 
	`PXT4_I
(
ﬁd_díåy
->
d_öode
)->
i_¥ojid
)) ||

3694 (
	`pxt4_ã°_öode_Êag
(
ﬁd_dú
, 
PXT4_INODE_PROJINHERIT
) &&

3695 !
	`¥ojid_eq
(
	`PXT4_I
(
ﬁd_dú
)->
i_¥ojid
,

3696 
	`PXT4_I
(
√w_díåy
->
d_öode
)->
i_¥ojid
)))

3697  -
EXDEV
;

3699 
ªtvÆ
 = 
	`dquŸ_öôülize
(
ﬁd
.
dú
);

3700 i‡(
ªtvÆ
)

3701  
ªtvÆ
;

3702 
ªtvÆ
 = 
	`dquŸ_öôülize
(
√w
.
dú
);

3703 i‡(
ªtvÆ
)

3704  
ªtvÆ
;

3706 
ﬁd
.
bh
 = 
	`pxt4_föd_íåy
(ﬁd.
dú
, &ﬁd.
díåy
->
d_«me
,

3707 &
ﬁd
.
de
, &ﬁd.
ölöed
);

3708 i‡(
	`IS_ERR
(
ﬁd
.
bh
))

3709  
	`PTR_ERR
(
ﬁd
.
bh
);

3716 
ªtvÆ
 = -
ENOENT
;

3717 i‡(!
ﬁd
.
bh
 || 
	`À32_to_˝u
(ﬁd.
de
->
öode
Ë!ﬁd.öode->
i_öo
)

3718 
íd_ª«me
;

3720 
√w
.
bh
 = 
	`pxt4_föd_íåy
“ew.
dú
, &√w.
díåy
->
d_«me
,

3721 &
√w
.
de
, &√w.
ölöed
);

3722 i‡(
	`IS_ERR
(
√w
.
bh
)) {

3723 
ªtvÆ
 = 
	`PTR_ERR
(
√w
.
bh
);

3724 
√w
.
bh
 = 
NULL
;

3725 
íd_ª«me
;

3729 i‡(!
√w
.
bh
 || 
	`À32_to_˝u
“ew.
de
->
öode
Ë!√w.öode->
i_öo
)

3730 
íd_ª«me
;

3732 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
ﬁd
.
dú
, 
PXT4_HT_DIR
,

3733 (2 * 
	`PXT4_DATA_TRANS_BLOCKS
(
ﬁd
.
dú
->
i_sb
) +

3734 2 * 
PXT4_INDEX_EXTRA_TRANS_BLOCKS
 + 2));

3735 i‡(
	`IS_ERR
(
h™dÀ
)) {

3736 
ªtvÆ
 = 
	`PTR_ERR
(
h™dÀ
);

3737 
h™dÀ
 = 
NULL
;

3738 
íd_ª«me
;

3741 i‡(
	`IS_DIRSYNC
(
ﬁd
.
dú
Ë|| IS_DIRSYNC(
√w
.dir))

3742 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

3744 i‡(
	`S_ISDIR
(
ﬁd
.
öode
->
i_mode
)) {

3745 
ﬁd
.
is_dú
 = 
åue
;

3746 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
ﬁd
);

3747 i‡(
ªtvÆ
)

3748 
íd_ª«me
;

3750 i‡(
	`S_ISDIR
(
√w
.
öode
->
i_mode
)) {

3751 
√w
.
is_dú
 = 
åue
;

3752 
ªtvÆ
 = 
	`pxt4_ª«me_dú_¥ï¨e
(
h™dÀ
, &
√w
);

3753 i‡(
ªtvÆ
)

3754 
íd_ª«me
;

3761 i‡(
ﬁd
.
dú
 !
√w
.dú && old.
is_dú
 !=Çew.is_dir) {

3762 
ﬁd
.
dú_∆ök_dñè
 = old.
is_dú
 ? -1 : 1;

3763 
√w
.
dú_∆ök_dñè
 = -
ﬁd
.dir_nlink_delta;

3764 
ªtvÆ
 = -
EMLINK
;

3765 i‡((
ﬁd
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
(ﬁd.
dú
)) ||

3766 (
√w
.
dú_∆ök_dñè
 > 0 && 
	`PXT4_DIR_LINK_MAX
“ew.
dú
)))

3767 
íd_ª«me
;

3770 
√w_fûe_ty≥
 = 
√w
.
de
->
fûe_ty≥
;

3771 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
√w
, 
ﬁd
.
öode
->
i_öo
, old.
de
->
fûe_ty≥
);

3772 i‡(
ªtvÆ
)

3773 
íd_ª«me
;

3775 
ªtvÆ
 = 
	`pxt4_£ã¡
(
h™dÀ
, &
ﬁd
, 
√w
.
öode
->
i_öo
, 
√w_fûe_ty≥
);

3776 i‡(
ªtvÆ
)

3777 
íd_ª«me
;

3783 
˘ime
 = 
	`cuºít_time
(
ﬁd
.
öode
);

3784 
ﬁd
.
öode
->
i_˘ime
 = 
˘ime
;

3785 
√w
.
öode
->
i_˘ime
 = 
˘ime
;

3786 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ﬁd
.
öode
);

3787 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
√w
.
öode
);

3789 i‡(
ﬁd
.
dú_bh
) {

3790 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
ﬁd
, 
√w
.
dú
->
i_öo
);

3791 i‡(
ªtvÆ
)

3792 
íd_ª«me
;

3794 i‡(
√w
.
dú_bh
) {

3795 
ªtvÆ
 = 
	`pxt4_ª«me_dú_föish
(
h™dÀ
, &
√w
, 
ﬁd
.
dú
->
i_öo
);

3796 i‡(
ªtvÆ
)

3797 
íd_ª«me
;

3799 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
ﬁd
);

3800 
	`pxt4_upd©e_dú_cou¡
(
h™dÀ
, &
√w
);

3801 
ªtvÆ
 = 0;

3803 
íd_ª«me
:

3804 
	`bªl£
(
ﬁd
.
dú_bh
);

3805 
	`bªl£
(
√w
.
dú_bh
);

3806 
	`bªl£
(
ﬁd
.
bh
);

3807 
	`bªl£
(
√w
.
bh
);

3808 i‡(
h™dÀ
)

3809 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

3810  
ªtvÆ
;

3811 
	}
}

3813 
	$pxt4_ª«me2
(
öode
 *
ﬁd_dú
, 
díåy
 *
ﬁd_díåy
,

3814 
öode
 *
√w_dú
, 
díåy
 *
√w_díåy
,

3815 
Êags
)

3817 
îr
;

3819 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
ﬁd_dú
->
i_sb
))))

3820  -
EIO
;

3822 i‡(
Êags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

3823  -
EINVAL
;

3825 
îr
 = 
	`fs¸y±_¥ï¨e_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
,

3826 
Êags
);

3827 i‡(
îr
)

3828  
îr
;

3830 i‡(
Êags
 & 
RENAME_EXCHANGE
) {

3831  
	`pxt4_¸oss_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
,

3832 
√w_dú
, 
√w_díåy
);

3835  
	`pxt4_ª«me
(
ﬁd_dú
, 
ﬁd_díåy
, 
√w_dú
, 
√w_díåy
, 
Êags
);

3836 
	}
}

3841 c⁄° 
öode_›î©i⁄s
 
	gpxt4_dú_öode_›î©i⁄s
 = {

3842 .
¸óã
 = 
pxt4_¸óã
,

3843 .
	glookup
 = 
pxt4_lookup
,

3844 .
	glök
 = 
pxt4_lök
,

3845 .
	gu∆ök
 = 
pxt4_u∆ök
,

3846 .
	gsymlök
 = 
pxt4_symlök
,

3847 .
	gmkdú
 = 
pxt4_mkdú
,

3848 .
	grmdú
 = 
pxt4_rmdú
,

3849 .
	gmknod
 = 
pxt4_mknod
,

3850 .
	gtmpfûe
 = 
pxt4_tmpfûe
,

3851 .
	gª«me
 = 
pxt4_ª«me2
,

3852 .
	g£èâr
 = 
pxt4_£èâr
,

3853 .
	ggë©å
 = 
pxt4_gë©å
,

3854 .
	gli°x©å
 = 
pxt4_li°x©å
,

3855 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

3856 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

3857 .
	gfõm≠
 = 
pxt4_fõm≠
,

3860 c⁄° 
öode_›î©i⁄s
 
	gpxt4_•ecül_öode_›î©i⁄s
 = {

3861 .
£èâr
 = 
pxt4_£èâr
,

3862 .
	ggë©å
 = 
pxt4_gë©å
,

3863 .
	gli°x©å
 = 
pxt4_li°x©å
,

3864 .
	ggë_a˛
 = 
pxt4_gë_a˛
,

3865 .
	g£t_a˛
 = 
pxt4_£t_a˛
,

	@page-io.c

10 
	~<löux/fs.h
>

11 
	~<löux/time.h
>

12 
	~<löux/highuid.h
>

13 
	~<löux/∑gem≠.h
>

14 
	~<löux/quŸa›s.h
>

15 
	~<löux/°rög.h
>

16 
	~<löux/buf„r_hód.h
>

17 
	~<löux/wrôeback.h
>

18 
	~<löux/∑gevec.h
>

19 
	~<löux/m∑ge.h
>

20 
	~<löux/«mei.h
>

21 
	~<löux/uio.h
>

22 
	~<löux/bio.h
>

23 
	~<löux/w‹kqueue.h
>

24 
	~<löux/kî√l.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/mm.h
>

27 
	~<löux/backög-dev.h
>

29 
	~"pxt4_jbd3.h
"

30 
	~"x©å.h
"

31 
	~"a˛.h
"

33 
kmem_ˇche
 *
	gio_íd_ˇchï
;

35 
__öô
 
	$pxt4_öô_∑geio
()

37 
io_íd_ˇchï
 = 
	`KMEM_CACHE
(
pxt4_io_íd
, 
SLAB_RECLAIM_ACCOUNT
);

38 i‡(
io_íd_ˇchï
 =
NULL
)

39  -
ENOMEM
;

41 
	}
}

43 
	$pxt4_exô_∑geio
()

45 
	`kmem_ˇche_de°roy
(
io_íd_ˇchï
);

46 
	}
}

55 
	$buf„r_io_îr‹
(
buf„r_hód
 *
bh
)

57 
	`¥ötk_øãlimôed
(
KERN_ERR
 "Buffer I/OÉrror on device %pg,Üogical block %llu\n",

58 
bh
->
b_bdev
,

59 ()
bh
->
b_blockƒ
);

60 
	}
}

62 
	$pxt4_föish_bio
(
bio
 *bio)

64 
i
;

65 
bio_vec
 *
bvec
;

66 
bvec_ôî_Æl
 
ôî_Æl
;

68 
	`bio_f‹_óch_£gmít_Æl
(
bvec
, 
bio
, 
i
, 
ôî_Æl
) {

69 
∑ge
 *∑gê
bvec
->
bv_∑ge
;

70 #ifde‡
CONFIG_FS_ENCRYPTION


71 
∑ge
 *
d©a_∑ge
 = 
NULL
;

73 
buf„r_hód
 *
bh
, *
hód
;

74 
bio_°¨t
 = 
bvec
->
bv_off£t
;

75 
bio_íd
 = 
bio_°¨t
 + 
bvec
->
bv_Àn
;

76 
undî_io
 = 0;

77 
Êags
;

79 i‡(!
∑ge
)

82 #ifde‡
CONFIG_FS_ENCRYPTION


83 i‡(!
∑ge
->
m≠pög
) {

85 
d©a_∑ge
 = 
∑ge
;

86 
	`fs¸y±_puŒback_bio_∑ge
(&
∑ge
, 
Ál£
);

90 i‡(
bio
->
bi_°©us
) {

91 
	`SëPageEº‹
(
∑ge
);

92 
	`m≠pög_£t_îr‹
(
∑ge
->
m≠pög
, -
EIO
);

94 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

99 
	`loˇl_úq_ßve
(
Êags
);

100 
	`bô_•ö_lock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

102 i‡(
	`bh_off£t
(
bh
Ë< 
bio_°¨t
 ||

103 
	`bh_off£t
(
bh
Ë+ bh->
b_size
 > 
bio_íd
) {

104 i‡(
	`buf„r_async_wrôe
(
bh
))

105 
undî_io
++;

108 
	`˛ór_buf„r_async_wrôe
(
bh
);

109 i‡(
bio
->
bi_°©us
)

110 
	`buf„r_io_îr‹
(
bh
);

111 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

112 
	`bô_•ö_u∆ock
(
BH_U±od©e_Lock
, &
hód
->
b_°©e
);

113 
	`loˇl_úq_ª°‹e
(
Êags
);

114 i‡(!
undî_io
) {

115 #ifde‡
CONFIG_FS_ENCRYPTION


116 i‡(
d©a_∑ge
)

117 
	`fs¸y±_ª°‹e_c⁄åﬁ_∑ge
(
d©a_∑ge
);

119 
	`íd_∑ge_wrôeback
(
∑ge
);

122 
	}
}

124 
	$pxt4_ªÀa£_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

126 
bio
 *bio, *
√xt_bio
;

128 
	`BUG_ON
(!
	`li°_em±y
(&
io_íd
->
li°
));

129 
	`BUG_ON
(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
);

130 
	`WARN_ON
(
io_íd
->
h™dÀ
);

132 
bio
 = 
io_íd
->bio; bio; biÿ
√xt_bio
) {

133 
√xt_bio
 = 
bio
->
bi_¥iv©e
;

134 
	`pxt4_föish_bio
(
bio
);

135 
	`bio_put
(
bio
);

137 
	`kmem_ˇche_‰ì
(
io_íd_ˇchï
, 
io_íd
);

138 
	}
}

148 
	$pxt4_íd_io
(
pxt4_io_íd_t
 *
io
)

150 
öode
 *öodê
io
->inode;

151 
loff_t
 
off£t
 = 
io
->offset;

152 
ssize_t
 
size
 = 
io
->size;

153 
h™dÀ_t
 *
h™dÀ
 = 
io
->handle;

154 
ªt
 = 0;

156 
	`pxt4_debug
("pxt4_end_io_nolock: io 0x%p from inode %lu,list->next 0x%p,"

158 
io
, 
öode
->
i_öo
, io->
li°
.
√xt
, io->li°.
¥ev
);

160 
io
->
h™dÀ
 = 
NULL
;

161 
ªt
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ
, 
öode
, 
off£t
, 
size
);

162 i‡(
ªt
 < 0 && !
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))) {

163 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_EMERG
,

167 
öode
->
i_öo
, 
off£t
, 
size
, 
ªt
);

169 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io
);

170 
	`pxt4_ªÀa£_io_íd
(
io
);

171  
ªt
;

172 
	}
}

174 
	$dump_com∂ëed_IO
(
öode
 *öode, 
li°_hód
 *
hód
)

176 #ifdef 
PXT4FS_DEBUG


177 
li°_hód
 *
cur
, *
bef‹e
, *
a·î
;

178 
pxt4_io_íd_t
 *
io
, *
io0
, *
io1
;

180 i‡(
	`li°_em±y
(
hód
))

183 
	`pxt4_debug
("Dum∞öodê%lu com∂ëed iÿli°\n", 
öode
->
i_öo
);

184 
	`li°_f‹_óch_íåy
(
io
, 
hód
, 
li°
) {

185 
cur
 = &
io
->
li°
;

186 
bef‹e
 = 
cur
->
¥ev
;

187 
io0
 = 
	`c⁄èöî_of
(
bef‹e
, 
pxt4_io_íd_t
, 
li°
);

188 
a·î
 = 
cur
->
√xt
;

189 
io1
 = 
	`c⁄èöî_of
(
a·î
, 
pxt4_io_íd_t
, 
li°
);

191 
	`pxt4_debug
("io 0x%p from inode %lu,prev 0x%p,next 0x%p\n",

192 
io
, 
öode
->
i_öo
, 
io0
, 
io1
);

195 
	}
}

198 
	$pxt4_add_com∂ëe_io
(
pxt4_io_íd_t
 *
io_íd
)

200 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
io_íd
->
öode
);

201 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
io_íd
->
öode
->
i_sb
);

202 
w‹kqueue_°ru˘
 *
wq
;

203 
Êags
;

206 
	`WARN_ON
(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

207 
	`WARN_ON
(!
io_íd
->
h™dÀ
 && 
sbi
->
s_jou∫Æ
);

208 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

209 
wq
 = 
sbi
->
rsv_c⁄vîsi⁄_wq
;

210 i‡(
	`li°_em±y
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
))

211 
	`queue_w‹k
(
wq
, &
ei
->
i_rsv_c⁄vîsi⁄_w‹k
);

212 
	`li°_add_èû
(&
io_íd
->
li°
, &
ei
->
i_rsv_c⁄vîsi⁄_li°
);

213 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

214 
	}
}

216 
	$pxt4_do_Êush_com∂ëed_IO
(
öode
 *inode,

217 
li°_hód
 *
hód
)

219 
pxt4_io_íd_t
 *
io
;

220 
li°_hód
 
unwrôãn
;

221 
Êags
;

222 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

223 
îr
, 
ªt
 = 0;

225 
	`•ö_lock_úqßve
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

226 
	`dump_com∂ëed_IO
(
öode
, 
hód
);

227 
	`li°_ª∂a˚_öô
(
hód
, &
unwrôãn
);

228 
	`•ö_u∆ock_úqª°‹e
(&
ei
->
i_com∂ëed_io_lock
, 
Êags
);

230 !
	`li°_em±y
(&
unwrôãn
)) {

231 
io
 = 
	`li°_íåy
(
unwrôãn
.
√xt
, 
pxt4_io_íd_t
, 
li°
);

232 
	`BUG_ON
(!(
io
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
));

233 
	`li°_dñ_öô
(&
io
->
li°
);

235 
îr
 = 
	`pxt4_íd_io
(
io
);

236 i‡(
	`u∆ikñy
(!
ªt
 && 
îr
))

237 
ªt
 = 
îr
;

239  
ªt
;

240 
	}
}

245 
	$pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
)

247 
pxt4_öode_öfo
 *
ei
 = 
	`c⁄èöî_of
(
w‹k
, pxt4_inode_info,

248 
i_rsv_c⁄vîsi⁄_w‹k
);

249 
	`pxt4_do_Êush_com∂ëed_IO
(&
ei
->
vfs_öode
, &ei->
i_rsv_c⁄vîsi⁄_li°
);

250 
	}
}

252 
pxt4_io_íd_t
 *
	$pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
)

254 
pxt4_io_íd_t
 *
io
 = 
	`kmem_ˇche_zÆloc
(
io_íd_ˇchï
, 
Êags
);

255 i‡(
io
) {

256 
io
->
öode
 = inode;

257 
	`INIT_LIST_HEAD
(&
io
->
li°
);

258 
	`©omic_£t
(&
io
->
cou¡
, 1);

260  
io
;

261 
	}
}

263 
	$pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
)

265 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

266 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
Ë|| !io_íd->
size
) {

267 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

270 
	`pxt4_add_com∂ëe_io
(
io_íd
);

272 
	}
}

274 
	$pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

276 
îr
 = 0;

278 i‡(
	`©omic_dec_™d_ã°
(&
io_íd
->
cou¡
)) {

279 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

280 
îr
 = 
	`pxt4_c⁄vît_unwrôãn_exã¡s
(
io_íd
->
h™dÀ
,

281 
io_íd
->
öode
, io_íd->
off£t
,

282 
io_íd
->
size
);

283 
io_íd
->
h™dÀ
 = 
NULL
;

284 
	`pxt4_˛ór_io_unwrôãn_Êag
(
io_íd
);

286 
	`pxt4_ªÀa£_io_íd
(
io_íd
);

288  
îr
;

289 
	}
}

291 
pxt4_io_íd_t
 *
	$pxt4_gë_io_íd
(
pxt4_io_íd_t
 *
io_íd
)

293 
	`©omic_öc
(&
io_íd
->
cou¡
);

294  
io_íd
;

295 
	}
}

298 
	$pxt4_íd_bio
(
bio
 *bio)

300 
pxt4_io_íd_t
 *
io_íd
 = 
bio
->
bi_¥iv©e
;

301 
£˘‹_t
 
bi_£˘‹
 = 
bio
->
bi_ôî
.bi_sector;

302 
b
[
BDEVNAME_SIZE
];

304 i‡(
	`WARN_ONCE
(!
io_íd
, "io_end is NULL: %s: sector %LuÜen %uÉrr %d\n",

305 
	`bio_dev«me
(
bio
, 
b
),

306 (Ë
bio
->
bi_ôî
.
bi_£˘‹
,

307 (Ë
	`bio_£˘‹s
(
bio
),

308 
bio
->
bi_°©us
)) {

309 
	`pxt4_föish_bio
(
bio
);

310 
	`bio_put
(
bio
);

313 
bio
->
bi_íd_io
 = 
NULL
;

315 i‡(
bio
->
bi_°©us
) {

316 
öode
 *öodê
io_íd
->inode;

318 
	`pxt4_w¨nög
(
öode
->
i_sb
, "I/OÉrror %d writingÅo inode %lu "

320 
bio
->
bi_°©us
, 
öode
->
i_öo
,

321 (Ë
io_íd
->
off£t
,

322 (Ë
io_íd
->
size
,

324 
bi_£˘‹
 >> (
öode
->
i_blkbôs
 - 9));

325 
	`m≠pög_£t_îr‹
(
öode
->
i_m≠pög
,

326 
	`blk_°©us_to_î∫o
(
bio
->
bi_°©us
));

329 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

335 
bio
->
bi_¥iv©e
 = 
	`xchg
(&
io_íd
->bio, bio);

336 
	`pxt4_put_io_íd_de„r
(
io_íd
);

342 
	`pxt4_put_io_íd_de„r
(
io_íd
);

343 
	`pxt4_föish_bio
(
bio
);

344 
	`bio_put
(
bio
);

346 
	}
}

348 
	$pxt4_io_submô
(
pxt4_io_submô
 *
io
)

350 
bio
 *biÿ
io
->
io_bio
;

352 i‡(
bio
) {

353 
io_›_Êags
 = 
io
->
io_wbc
->
sync_mode
 =
WB_SYNC_ALL
 ?

354 
REQ_SYNC
 : 0;

355 
io
->
io_bio
->
bi_wrôe_höt
 = io->
io_íd
->
öode
->
i_wrôe_höt
;

356 
	`bio_£t_›_©ås
(
io
->
io_bio
, 
REQ_OP_WRITE
, 
io_›_Êags
);

357 
	`submô_bio
(
io
->
io_bio
);

359 
io
->
io_bio
 = 
NULL
;

360 
	}
}

362 
	$pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

363 
wrôeback_c⁄åﬁ
 *
wbc
)

365 
io
->
io_wbc
 = 
wbc
;

366 
io
->
io_bio
 = 
NULL
;

367 
io
->
io_íd
 = 
NULL
;

368 
	}
}

370 
	$io_submô_öô_bio
(
pxt4_io_submô
 *
io
,

371 
buf„r_hód
 *
bh
)

373 
bio
 *bio;

375 
bio
 = 
	`bio_Æloc
(
GFP_NOIO
, 
BIO_MAX_PAGES
);

376 i‡(!
bio
)

377  -
ENOMEM
;

378 
bio
->
bi_ôî
.
bi_£˘‹
 = 
bh
->
b_blockƒ
 * (bh->
b_size
 >> 9);

379 
	`bio_£t_dev
(
bio
, 
bh
->
b_bdev
);

380 
bio
->
bi_íd_io
 = 
pxt4_íd_bio
;

381 
bio
->
bi_¥iv©e
 = 
	`pxt4_gë_io_íd
(
io
->
io_íd
);

382 
io
->
io_bio
 = 
bio
;

383 
io
->
io_√xt_block
 = 
bh
->
b_blockƒ
;

384 
	`wbc_öô_bio
(
io
->
io_wbc
, 
bio
);

386 
	}
}

388 
	$io_submô_add_bh
(
pxt4_io_submô
 *
io
,

389 
öode
 *inode,

390 
∑ge
 *page,

391 
buf„r_hód
 *
bh
)

393 
ªt
;

395 i‡(
io
->
io_bio
 && 
bh
->
b_blockƒ
 !io->
io_√xt_block
) {

396 
submô_™d_ªåy
:

397 
	`pxt4_io_submô
(
io
);

399 i‡(
io
->
io_bio
 =
NULL
) {

400 
ªt
 = 
	`io_submô_öô_bio
(
io
, 
bh
);

401 i‡(
ªt
)

402  
ªt
;

403 
io
->
io_bio
->
bi_wrôe_höt
 = 
öode
->
i_wrôe_höt
;

405 
ªt
 = 
	`bio_add_∑ge
(
io
->
io_bio
, 
∑ge
, 
bh
->
b_size
, 
	`bh_off£t
(bh));

406 i‡(
ªt
 !
bh
->
b_size
)

407 
submô_™d_ªåy
;

408 
	`wbc_accou¡_io
(
io
->
io_wbc
, 
∑ge
, 
bh
->
b_size
);

409 
io
->
io_√xt_block
++;

411 
	}
}

413 
	$pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

414 
∑ge
 *page,

415 
Àn
,

416 
wrôeback_c⁄åﬁ
 *
wbc
,

417 
boﬁ
 
kìp_towrôe
)

419 
∑ge
 *
d©a_∑ge
 = 
NULL
;

420 
öode
 *öodê
∑ge
->
m≠pög
->
ho°
;

421 
block_°¨t
;

422 
buf„r_hód
 *
bh
, *
hód
;

423 
ªt
 = 0;

424 
ƒ_submôãd
 = 0;

425 
ƒ_to_submô
 = 0;

427 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

428 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

430 i‡(
kìp_towrôe
)

431 
	`£t_∑ge_wrôeback_kìpwrôe
(
∑ge
);

433 
	`£t_∑ge_wrôeback
(
∑ge
);

434 
	`CÀ¨PageEº‹
(
∑ge
);

445 i‡(
Àn
 < 
PAGE_SIZE
)

446 
	`zîo_u£r_£gmít
(
∑ge
, 
Àn
, 
PAGE_SIZE
);

454 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

456 
block_°¨t
 = 
	`bh_off£t
(
bh
);

457 i‡(
block_°¨t
 >
Àn
) {

458 
	`˛ór_buf„r_dúty
(
bh
);

459 
	`£t_buf„r_u±od©e
(
bh
);

462 i‡(!
	`buf„r_dúty
(
bh
Ë|| 
	`buf„r_dñay
(bh) ||

463 !
	`buf„r_m≠≥d
(
bh
Ë|| 
	`buf„r_unwrôãn
(bh)) {

465 i‡(!
	`buf„r_m≠≥d
(
bh
))

466 
	`˛ór_buf„r_dúty
(
bh
);

467 i‡(
io
->
io_bio
)

468 
	`pxt4_io_submô
(
io
);

471 i‡(
	`buf„r_√w
(
bh
))

472 
	`˛ór_buf„r_√w
(
bh
);

473 
	`£t_buf„r_async_wrôe
(
bh
);

474 
ƒ_to_submô
++;

475 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

477 
bh
 = 
hód
 = 
	`∑ge_buf„rs
(
∑ge
);

479 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
Ë&& 
ƒ_to_submô
) {

480 
gÂ_t
 
gÂ_Êags
 = 
GFP_NOFS
;

482 
ªåy_í¸y±
:

483 
d©a_∑ge
 = 
	`fs¸y±_í¸y±_∑ge
(
öode
, 
∑ge
, 
PAGE_SIZE
, 0,

484 
∑ge
->
ödex
, 
gÂ_Êags
);

485 i‡(
	`IS_ERR
(
d©a_∑ge
)) {

486 
ªt
 = 
	`PTR_ERR
(
d©a_∑ge
);

487 i‡(
ªt
 =-
ENOMEM
 && 
wbc
->
sync_mode
 =
WB_SYNC_ALL
) {

488 i‡(
io
->
io_bio
) {

489 
	`pxt4_io_submô
(
io
);

490 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

492 
gÂ_Êags
 |
__GFP_NOFAIL
;

493 
ªåy_í¸y±
;

495 
d©a_∑ge
 = 
NULL
;

496 
out
;

502 i‡(!
	`buf„r_async_wrôe
(
bh
))

504 
ªt
 = 
	`io_submô_add_bh
(
io
, 
öode
,

505 
d©a_∑ge
 ? d©a_∑gê: 
∑ge
, 
bh
);

506 i‡(
ªt
) {

514 
ƒ_submôãd
++;

515 
	`˛ór_buf„r_dúty
(
bh
);

516 } (
bh
 = bh->
b_this_∑ge
Ë!
hód
);

519 i‡(
ªt
) {

520 
out
:

521 i‡(
d©a_∑ge
)

522 
	`fs¸y±_ª°‹e_c⁄åﬁ_∑ge
(
d©a_∑ge
);

523 
	`¥ötk_øãlimôed
(
KERN_ERR
 "%s:Ñë = %d\n", 
__func__
, 
ªt
);

524 
	`ªdúty_∑ge_f‹_wrôïage
(
wbc
, 
∑ge
);

526 
	`˛ór_buf„r_async_wrôe
(
bh
);

527 
bh
 = bh->
b_this_∑ge
;

528 } 
bh
 !
hód
);

530 
	`u∆ock_∑ge
(
∑ge
);

532 i‡(!
ƒ_submôãd
)

533 
	`íd_∑ge_wrôeback
(
∑ge
);

534  
ªt
;

535 
	}
}

	@page-writeback.c

14 
	~<löux/kî√l.h
>

15 
	~<löux/exp‹t.h
>

16 
	~<löux/•ölock.h
>

17 
	~<löux/fs.h
>

18 
	~<löux/mm.h
>

19 
	~<löux/sw≠.h
>

20 
	~<löux/¶ab.h
>

21 
	~<löux/∑gem≠.h
>

22 
	~<löux/wrôeback.h
>

23 
	~<löux/öô.h
>

24 
	~<löux/backög-dev.h
>

25 
	~<löux/èsk_io_accou¡ög_›s.h
>

26 
	~<löux/blkdev.h
>

27 
	~<löux/m∑ge.h
>

28 
	~<löux/rm≠.h
>

29 
	~<löux/≥r˝u.h
>

30 
	~<löux/smp.h
>

31 
	~<löux/sys˘l.h
>

32 
	~<löux/˝u.h
>

33 
	~<löux/sysˇŒs.h
>

34 
	~<löux/buf„r_hód.h
>

35 
	~<löux/∑gevec.h
>

36 
	~<löux/timî.h
>

37 
	~<löux/sched/π.h
>

38 
	~<löux/sched/sig«l.h
>

39 
	~<löux/mm_ölöe.h
>

40 
	~<åa˚/evíts/wrôeback.h
>

42 
	~"öã∫Æ.h
"

47 
	#MAX_PAUSE
 
	`max
(
HZ
/5, 1)

	)

53 
	#DIRTY_POLL_THRESH
 (128 >> (
PAGE_SHIFT
 - 10))

	)

58 
	#BANDWIDTH_INTERVAL
 
	`max
(
HZ
/5, 1)

	)

60 
	#RATELIMIT_CALC_SHIFT
 10

	)

66 
	gøãlimô_∑ges
 = 32;

73 
	gdúty_background_øtio
 = 10;

79 
	gdúty_background_byãs
;

85 
	gvm_highmem_is_dútyabÀ
;

90 
	gvm_dúty_øtio
 = 20;

96 
	gvm_dúty_byãs
;

101 
	gdúty_wrôeback_öãrvÆ
 = 5 * 100;

103 
EXPORT_SYMBOL_GPL
(
dúty_wrôeback_öãrvÆ
);

108 
	gdúty_expúe_öãrvÆ
 = 30 * 100;

113 
	gblock_dump
;

119 
	gœ±›_mode
;

121 
EXPORT_SYMBOL
(
œ±›_mode
);

125 
wb_domaö
 
	gglobÆ_wb_domaö
;

128 
	sdúty_thrŸée_c⁄åﬁ
 {

129 #ifde‡
CONFIG_CGROUP_WRITEBACK


130 
wb_domaö
 *
	mdom
;

131 
dúty_thrŸée_c⁄åﬁ
 *
	mgdtc
;

133 
bdi_wrôeback
 *
	mwb
;

134 
Âr›_loˇl_≥r˝u
 *
	mwb_com∂ëi⁄s
;

136 
	mavaû
;

137 
	mdúty
;

138 
	mthªsh
;

139 
	mbg_thªsh
;

141 
	mwb_dúty
;

142 
	mwb_thªsh
;

143 
	mwb_bg_thªsh
;

145 
	mpos_øtio
;

153 
	#VM_COMPLETIONS_PERIOD_LEN
 (3*
HZ
)

	)

155 #ifde‡
CONFIG_CGROUP_WRITEBACK


157 
	#GDTC_INIT
(
__wb
Ë.
wb
 = (__wb), \

158 .
dom
 = &
globÆ_wb_domaö
, \

159 .
wb_com∂ëi⁄s
 = &(
__wb
)->
com∂ëi⁄s


	)

161 
	#GDTC_INIT_NO_WB
 .
dom
 = &
globÆ_wb_domaö


	)

163 
	#MDTC_INIT
(
__wb
, 
__gdtc
Ë.
wb
 = (__wb), \

164 .
dom
 = 
	`mem_cgroup_wb_domaö
(
__wb
), \

165 .
wb_com∂ëi⁄s
 = &(
__wb
)->
memcg_com∂ëi⁄s
, \

166 .
gdtc
 = 
__gdtc


	)

168 
boﬁ
 
	$mdtc_vÆid
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

170  
dtc
->
dom
;

171 
	}
}

173 
wb_domaö
 *
	$dtc_dom
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

175  
dtc
->
dom
;

176 
	}
}

178 
dúty_thrŸée_c⁄åﬁ
 *
	$mdtc_gdtc
(
dúty_thrŸée_c⁄åﬁ
 *
mdtc
)

180  
mdtc
->
gdtc
;

181 
	}
}

183 
Âr›_loˇl_≥r˝u
 *
	$wb_memcg_com∂ëi⁄s
(
bdi_wrôeback
 *
wb
)

185  &
wb
->
memcg_com∂ëi⁄s
;

186 
	}
}

188 
	$wb_mö_max_øtio
(
bdi_wrôeback
 *
wb
,

189 *
möp
, *
maxp
)

191 
this_bw
 = 
wb
->
avg_wrôe_b™dwidth
;

192 
tŸ_bw
 = 
	`©omic_l⁄g_ªad
(&
wb
->
bdi
->
tŸ_wrôe_b™dwidth
);

193 
mö
 = 
wb
->
bdi
->
mö_øtio
;

194 
max
 = 
wb
->
bdi
->
max_øtio
;

200 i‡(
this_bw
 < 
tŸ_bw
) {

201 i‡(
mö
) {

202 
mö
 *
this_bw
;

203 
	`do_div
(
mö
, 
tŸ_bw
);

205 i‡(
max
 < 100) {

206 
max
 *
this_bw
;

207 
	`do_div
(
max
, 
tŸ_bw
);

211 *
möp
 = 
mö
;

212 *
maxp
 = 
max
;

213 
	}
}

217 
	#GDTC_INIT
(
__wb
Ë.
wb
 = (__wb), \

218 .
wb_com∂ëi⁄s
 = &(
__wb
)->
com∂ëi⁄s


	)

219 
	#GDTC_INIT_NO_WB


	)

220 
	#MDTC_INIT
(
__wb
, 
__gdtc
)

	)

222 
boﬁ
 
	$mdtc_vÆid
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

224  
Ál£
;

225 
	}
}

227 
wb_domaö
 *
	$dtc_dom
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

229  &
globÆ_wb_domaö
;

230 
	}
}

232 
dúty_thrŸée_c⁄åﬁ
 *
	$mdtc_gdtc
(
dúty_thrŸée_c⁄åﬁ
 *
mdtc
)

234  
NULL
;

235 
	}
}

237 
Âr›_loˇl_≥r˝u
 *
	$wb_memcg_com∂ëi⁄s
(
bdi_wrôeback
 *
wb
)

239  
NULL
;

240 
	}
}

242 
	$wb_mö_max_øtio
(
bdi_wrôeback
 *
wb
,

243 *
möp
, *
maxp
)

245 *
möp
 = 
wb
->
bdi
->
mö_øtio
;

246 *
maxp
 = 
wb
->
bdi
->
max_øtio
;

247 
	}
}

276 
	$node_dútyabÀ_mem‹y
(
pgli°_d©a
 *
pgd©
)

278 
ƒ_∑ges
 = 0;

279 
z
;

281 
z
 = 0; z < 
MAX_NR_ZONES
; z++) {

282 
z⁄e
 *z⁄ê
pgd©
->
node_z⁄es
 + 
z
;

284 i‡(!
	`p›uœãd_z⁄e
(
z⁄e
))

287 
ƒ_∑ges
 +
	`z⁄e_∑ge_°©e
(
z⁄e
, 
NR_FREE_PAGES
);

295 
ƒ_∑ges
 -
	`mö
“r_∑ges, 
pgd©
->
tŸÆª£rve_∑ges
);

297 
ƒ_∑ges
 +
	`node_∑ge_°©e
(
pgd©
, 
NR_INACTIVE_FILE
);

298 
ƒ_∑ges
 +
	`node_∑ge_°©e
(
pgd©
, 
NR_ACTIVE_FILE
);

300  
ƒ_∑ges
;

301 
	}
}

303 
	$highmem_dútyabÀ_mem‹y
(
tŸÆ
)

305 #ifde‡
CONFIG_HIGHMEM


306 
node
;

307 
x
 = 0;

308 
i
;

310 
	`f‹_óch_node_°©e
(
node
, 
N_HIGH_MEMORY
) {

311 
i
 = 
ZONE_NORMAL
 + 1; i < 
MAX_NR_ZONES
; i++) {

312 
z⁄e
 *
z
;

313 
ƒ_∑ges
;

315 i‡(!
	`is_highmem_idx
(
i
))

318 
z
 = &
	`NODE_DATA
(
node
)->
node_z⁄es
[
i
];

319 i‡(!
	`p›uœãd_z⁄e
(
z
))

322 
ƒ_∑ges
 = 
	`z⁄e_∑ge_°©e
(
z
, 
NR_FREE_PAGES
);

324 
ƒ_∑ges
 -
	`mö
“r_∑ges, 
	`high_wm¨k_∑ges
(
z
));

325 
ƒ_∑ges
 +
	`z⁄e_∑ge_°©e
(
z
, 
NR_ZONE_INACTIVE_FILE
);

326 
ƒ_∑ges
 +
	`z⁄e_∑ge_°©e
(
z
, 
NR_ZONE_ACTIVE_FILE
);

327 
x
 +
ƒ_∑ges
;

340 i‡(()
x
 < 0)

341 
x
 = 0;

349  
	`mö
(
x
, 
tŸÆ
);

353 
	}
}

361 
	$globÆ_dútyabÀ_mem‹y
()

363 
x
;

365 
x
 = 
	`globÆ_z⁄e_∑ge_°©e
(
NR_FREE_PAGES
);

371 
x
 -
	`mö
(x, 
tŸÆª£rve_∑ges
);

373 
x
 +
	`globÆ_node_∑ge_°©e
(
NR_INACTIVE_FILE
);

374 
x
 +
	`globÆ_node_∑ge_°©e
(
NR_ACTIVE_FILE
);

376 i‡(!
vm_highmem_is_dútyabÀ
)

377 
x
 -
	`highmem_dútyabÀ_mem‹y
(x);

379  
x
 + 1;

380 
	}
}

392 
	$domaö_dúty_limôs
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

394 c⁄° 
avaûabÀ_mem‹y
 = 
dtc
->
avaû
;

395 
dúty_thrŸée_c⁄åﬁ
 *
gdtc
 = 
	`mdtc_gdtc
(
dtc
);

396 
byãs
 = 
vm_dúty_byãs
;

397 
bg_byãs
 = 
dúty_background_byãs
;

399 
øtio
 = (
vm_dúty_øtio
 * 
PAGE_SIZE
) / 100;

400 
bg_øtio
 = (
dúty_background_øtio
 * 
PAGE_SIZE
) / 100;

401 
thªsh
;

402 
bg_thªsh
;

403 
èsk_°ru˘
 *
tsk
;

406 i‡(
gdtc
) {

407 
globÆ_avaû
 = 
gdtc
->
avaû
;

416 i‡(
byãs
)

417 
øtio
 = 
	`mö
(
	`DIV_ROUND_UP
(
byãs
, 
globÆ_avaû
),

418 
PAGE_SIZE
);

419 i‡(
bg_byãs
)

420 
bg_øtio
 = 
	`mö
(
	`DIV_ROUND_UP
(
bg_byãs
, 
globÆ_avaû
),

421 
PAGE_SIZE
);

422 
byãs
 = 
bg_byãs
 = 0;

425 i‡(
byãs
)

426 
thªsh
 = 
	`DIV_ROUND_UP
(
byãs
, 
PAGE_SIZE
);

428 
thªsh
 = (
øtio
 * 
avaûabÀ_mem‹y
Ë/ 
PAGE_SIZE
;

430 i‡(
bg_byãs
)

431 
bg_thªsh
 = 
	`DIV_ROUND_UP
(
bg_byãs
, 
PAGE_SIZE
);

433 
bg_thªsh
 = (
bg_øtio
 * 
avaûabÀ_mem‹y
Ë/ 
PAGE_SIZE
;

435 i‡(
bg_thªsh
 >
thªsh
)

436 
bg_thªsh
 = 
thªsh
 / 2;

437 
tsk
 = 
cuºít
;

438 i‡(
tsk
->
Êags
 & 
PF_LESS_THROTTLE
 || 
	`π_èsk
(tsk)) {

439 
bg_thªsh
 +bg_thªsh / 4 + 
globÆ_wb_domaö
.
dúty_limô
 / 32;

440 
thªsh
 +thªsh / 4 + 
globÆ_wb_domaö
.
dúty_limô
 / 32;

442 
dtc
->
thªsh
 =Åhresh;

443 
dtc
->
bg_thªsh
 = bg_thresh;

446 i‡(!
gdtc
)

447 
	`åa˚_globÆ_dúty_°©e
(
bg_thªsh
, 
thªsh
);

448 
	}
}

458 
	$globÆ_dúty_limôs
(*
pbackground
, *
pdúty
)

460 
dúty_thrŸée_c⁄åﬁ
 
gdtc
 = { 
GDTC_INIT_NO_WB
 };

462 
gdtc
.
avaû
 = 
	`globÆ_dútyabÀ_mem‹y
();

463 
	`domaö_dúty_limôs
(&
gdtc
);

465 *
pbackground
 = 
gdtc
.
bg_thªsh
;

466 *
pdúty
 = 
gdtc
.
thªsh
;

467 
	}
}

476 
	$node_dúty_limô
(
pgli°_d©a
 *
pgd©
)

478 
node_mem‹y
 = 
	`node_dútyabÀ_mem‹y
(
pgd©
);

479 
èsk_°ru˘
 *
tsk
 = 
cuºít
;

480 
dúty
;

482 i‡(
vm_dúty_byãs
)

483 
dúty
 = 
	`DIV_ROUND_UP
(
vm_dúty_byãs
, 
PAGE_SIZE
) *

484 
node_mem‹y
 / 
	`globÆ_dútyabÀ_mem‹y
();

486 
dúty
 = 
vm_dúty_øtio
 * 
node_mem‹y
 / 100;

488 i‡(
tsk
->
Êags
 & 
PF_LESS_THROTTLE
 || 
	`π_èsk
(tsk))

489 
dúty
 += dirty / 4;

491  
dúty
;

492 
	}
}

501 
boﬁ
 
	$node_dúty_ok
(
pgli°_d©a
 *
pgd©
)

503 
limô
 = 
	`node_dúty_limô
(
pgd©
);

504 
ƒ_∑ges
 = 0;

506 
ƒ_∑ges
 +
	`node_∑ge_°©e
(
pgd©
, 
NR_FILE_DIRTY
);

507 
ƒ_∑ges
 +
	`node_∑ge_°©e
(
pgd©
, 
NR_UNSTABLE_NFS
);

508 
ƒ_∑ges
 +
	`node_∑ge_°©e
(
pgd©
, 
NR_WRITEBACK
);

510  
ƒ_∑ges
 <
limô
;

511 
	}
}

513 
	$dúty_background_øtio_h™dÀr
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

514 
__u£r
 *
buf„r
, 
size_t
 *
À≈
,

515 
loff_t
 *
µos
)

517 
ªt
;

519 
ªt
 = 
	`¥oc_doötvec_mömax
(
èbÀ
, 
wrôe
, 
buf„r
, 
À≈
, 
µos
);

520 i‡(
ªt
 =0 && 
wrôe
)

521 
dúty_background_byãs
 = 0;

522  
ªt
;

523 
	}
}

525 
	$dúty_background_byãs_h™dÀr
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

526 
__u£r
 *
buf„r
, 
size_t
 *
À≈
,

527 
loff_t
 *
µos
)

529 
ªt
;

531 
ªt
 = 
	`¥oc_doul⁄gvec_mömax
(
èbÀ
, 
wrôe
, 
buf„r
, 
À≈
, 
µos
);

532 i‡(
ªt
 =0 && 
wrôe
)

533 
dúty_background_øtio
 = 0;

534  
ªt
;

535 
	}
}

537 
	$dúty_øtio_h™dÀr
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

538 
__u£r
 *
buf„r
, 
size_t
 *
À≈
,

539 
loff_t
 *
µos
)

541 
ﬁd_øtio
 = 
vm_dúty_øtio
;

542 
ªt
;

544 
ªt
 = 
	`¥oc_doötvec_mömax
(
èbÀ
, 
wrôe
, 
buf„r
, 
À≈
, 
µos
);

545 i‡(
ªt
 =0 && 
wrôe
 && 
vm_dúty_øtio
 !
ﬁd_øtio
) {

546 
	`wrôeback_£t_øãlimô
();

547 
vm_dúty_byãs
 = 0;

549  
ªt
;

550 
	}
}

552 
	$dúty_byãs_h™dÀr
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

553 
__u£r
 *
buf„r
, 
size_t
 *
À≈
,

554 
loff_t
 *
µos
)

556 
ﬁd_byãs
 = 
vm_dúty_byãs
;

557 
ªt
;

559 
ªt
 = 
	`¥oc_doul⁄gvec_mömax
(
èbÀ
, 
wrôe
, 
buf„r
, 
À≈
, 
µos
);

560 i‡(
ªt
 =0 && 
wrôe
 && 
vm_dúty_byãs
 !
ﬁd_byãs
) {

561 
	`wrôeback_£t_øãlimô
();

562 
vm_dúty_øtio
 = 0;

564  
ªt
;

565 
	}
}

567 
	$wp_√xt_time
(
cur_time
)

569 
cur_time
 +
VM_COMPLETIONS_PERIOD_LEN
;

571 i‡(!
cur_time
)

573  
cur_time
;

574 
	}
}

576 
	$wb_domaö_wrôeout_öc
(
wb_domaö
 *
dom
,

577 
Âr›_loˇl_≥r˝u
 *
com∂ëi⁄s
,

578 
max_¥›_‰ac
)

580 
	`__Âr›_öc_≥r˝u_max
(&
dom
->
com∂ëi⁄s
, completions,

581 
max_¥›_‰ac
);

583 i‡(
	`u∆ikñy
(!
dom
->
≥riod_time
)) {

590 
dom
->
≥riod_time
 = 
	`wp_√xt_time
(
jiffõs
);

591 
	`mod_timî
(&
dom
->
≥riod_timî
, dom->
≥riod_time
);

593 
	}
}

599 
ölöe
 
	$__wb_wrôeout_öc
(
bdi_wrôeback
 *
wb
)

601 
wb_domaö
 *
cgdom
;

603 
	`öc_wb_°©
(
wb
, 
WB_WRITTEN
);

604 
	`wb_domaö_wrôeout_öc
(&
globÆ_wb_domaö
, &
wb
->
com∂ëi⁄s
,

605 
wb
->
bdi
->
max_¥›_‰ac
);

607 
cgdom
 = 
	`mem_cgroup_wb_domaö
(
wb
);

608 i‡(
cgdom
)

609 
	`wb_domaö_wrôeout_öc
(
cgdom
, 
	`wb_memcg_com∂ëi⁄s
(
wb
),

610 
wb
->
bdi
->
max_¥›_‰ac
);

611 
	}
}

613 
	$wb_wrôeout_öc
(
bdi_wrôeback
 *
wb
)

615 
Êags
;

617 
	`loˇl_úq_ßve
(
Êags
);

618 
	`__wb_wrôeout_öc
(
wb
);

619 
	`loˇl_úq_ª°‹e
(
Êags
);

620 
	}
}

621 
EXPORT_SYMBOL_GPL
(
wb_wrôeout_öc
);

627 
	$wrôeout_≥riod
(
timî_li°
 *
t
)

629 
wb_domaö
 *
dom
 = 
	`‰om_timî
(dom, 
t
, 
≥riod_timî
);

630 
miss_≥riods
 = (
jiffõs
 - 
dom
->
≥riod_time
) /

631 
VM_COMPLETIONS_PERIOD_LEN
;

633 i‡(
	`Âr›_√w_≥riod
(&
dom
->
com∂ëi⁄s
, 
miss_≥riods
 + 1)) {

634 
dom
->
≥riod_time
 = 
	`wp_√xt_time
(dom->period_time +

635 
miss_≥riods
 * 
VM_COMPLETIONS_PERIOD_LEN
);

636 
	`mod_timî
(&
dom
->
≥riod_timî
, dom->
≥riod_time
);

642 
dom
->
≥riod_time
 = 0;

644 
	}
}

646 
	$wb_domaö_öô
(
wb_domaö
 *
dom
, 
gÂ_t
 
gÂ
)

648 
	`mem£t
(
dom
, 0, (*dom));

650 
	`•ö_lock_öô
(&
dom
->
lock
);

652 
	`timî_£tup
(&
dom
->
≥riod_timî
, 
wrôeout_≥riod
, 
TIMER_DEFERRABLE
);

654 
dom
->
dúty_limô_t°amp
 = 
jiffõs
;

656  
	`Âr›_globÆ_öô
(&
dom
->
com∂ëi⁄s
, 
gÂ
);

657 
	}
}

659 #ifde‡
CONFIG_CGROUP_WRITEBACK


660 
	$wb_domaö_exô
(
wb_domaö
 *
dom
)

662 
	`dñ_timî_sync
(&
dom
->
≥riod_timî
);

663 
	`Âr›_globÆ_de°roy
(&
dom
->
com∂ëi⁄s
);

664 
	}
}

672 
	gbdi_mö_øtio
;

674 
	$bdi_£t_mö_øtio
(
backög_dev_öfo
 *
bdi
, 
mö_øtio
)

676 
ªt
 = 0;

678 
	`•ö_lock_bh
(&
bdi_lock
);

679 i‡(
mö_øtio
 > 
bdi
->
max_øtio
) {

680 
ªt
 = -
EINVAL
;

682 
mö_øtio
 -
bdi
->min_ratio;

683 i‡(
bdi_mö_øtio
 + 
mö_øtio
 < 100) {

684 
bdi_mö_øtio
 +
mö_øtio
;

685 
bdi
->
mö_øtio
 += min_ratio;

687 
ªt
 = -
EINVAL
;

690 
	`•ö_u∆ock_bh
(&
bdi_lock
);

692  
ªt
;

693 
	}
}

695 
	$bdi_£t_max_øtio
(
backög_dev_öfo
 *
bdi
, 
max_øtio
)

697 
ªt
 = 0;

699 i‡(
max_øtio
 > 100)

700  -
EINVAL
;

702 
	`•ö_lock_bh
(&
bdi_lock
);

703 i‡(
bdi
->
mö_øtio
 > 
max_øtio
) {

704 
ªt
 = -
EINVAL
;

706 
bdi
->
max_øtio
 = max_ratio;

707 
bdi
->
max_¥›_‰ac
 = (
FPROP_FRAC_BASE
 * 
max_øtio
) / 100;

709 
	`•ö_u∆ock_bh
(&
bdi_lock
);

711  
ªt
;

712 
	}
}

713 
EXPORT_SYMBOL
(
bdi_£t_max_øtio
);

715 
	$dúty_‰ìrun_˚ûög
(
thªsh
,

716 
bg_thªsh
)

718  (
thªsh
 + 
bg_thªsh
) / 2;

719 
	}
}

721 
	$h¨d_dúty_limô
(
wb_domaö
 *
dom
,

722 
thªsh
)

724  
	`max
(
thªsh
, 
dom
->
dúty_limô
);

725 
	}
}

731 
	$mdtc_ˇlc_avaû
(
dúty_thrŸée_c⁄åﬁ
 *
mdtc
,

732 
fûïages
, 
hódroom
)

734 
dúty_thrŸée_c⁄åﬁ
 *
gdtc
 = 
	`mdtc_gdtc
(
mdtc
);

735 
˛ón
 = 
fûïages
 - 
	`mö
(fûïages, 
mdtc
->
dúty
);

736 
globÆ_˛ón
 = 
gdtc
->
avaû
 - 
	`mö
(gdtc->avaû, gdtc->
dúty
);

737 
Ÿhî_˛ón
 = 
globÆ_˛ón
 - 
	`mö
(globÆ_˛ón, 
˛ón
);

739 
mdtc
->
avaû
 = 
fûïages
 + 
	`mö
(
hódroom
, 
Ÿhî_˛ón
);

740 
	}
}

763 
	$__wb_ˇlc_thªsh
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

765 
wb_domaö
 *
dom
 = 
	`dtc_dom
(
dtc
);

766 
thªsh
 = 
dtc
->thresh;

767 
u64
 
wb_thªsh
;

768 
numî©‹
, 
díomö©‹
;

769 
wb_mö_øtio
, 
wb_max_øtio
;

774 
	`Âr›_‰a˘i⁄_≥r˝u
(&
dom
->
com∂ëi⁄s
, 
dtc
->
wb_com∂ëi⁄s
,

775 &
numî©‹
, &
díomö©‹
);

777 
wb_thªsh
 = (
thªsh
 * (100 - 
bdi_mö_øtio
)) / 100;

778 
wb_thªsh
 *
numî©‹
;

779 
	`do_div
(
wb_thªsh
, 
díomö©‹
);

781 
	`wb_mö_max_øtio
(
dtc
->
wb
, &
wb_mö_øtio
, &
wb_max_øtio
);

783 
wb_thªsh
 +(
thªsh
 * 
wb_mö_øtio
) / 100;

784 i‡(
wb_thªsh
 > (
thªsh
 * 
wb_max_øtio
) / 100)

785 
wb_thªsh
 = 
thªsh
 * 
wb_max_øtio
 / 100;

787  
wb_thªsh
;

788 
	}
}

790 
	$wb_ˇlc_thªsh
(
bdi_wrôeback
 *
wb
, 
thªsh
)

792 
dúty_thrŸée_c⁄åﬁ
 
gdtc
 = { 
	`GDTC_INIT
(
wb
),

793 .
thªsh
 =Åhresh };

794  
	`__wb_ˇlc_thªsh
(&
gdtc
);

795 
	}
}

811 
	$pos_øtio_pﬁynom
(
£çoöt
,

812 
dúty
,

813 
limô
)

815 
pos_øtio
;

816 
x
;

818 
x
 = 
	`div64_s64
(((
s64
)
£çoöt
 - (s64)
dúty
Ë<< 
RATELIMIT_CALC_SHIFT
,

819 (
limô
 - 
£çoöt
) | 1);

820 
pos_øtio
 = 
x
;

821 
pos_øtio
 =Öos_øtiÿ* 
x
 >> 
RATELIMIT_CALC_SHIFT
;

822 
pos_øtio
 =Öos_øtiÿ* 
x
 >> 
RATELIMIT_CALC_SHIFT
;

823 
pos_øtio
 +1 << 
RATELIMIT_CALC_SHIFT
;

825  
	`˛amp
(
pos_øtio
, 0LL, 2LL << 
RATELIMIT_CALC_SHIFT
);

826 
	}
}

903 
	$wb_posôi⁄_øtio
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

905 
bdi_wrôeback
 *
wb
 = 
dtc
->wb;

906 
wrôe_bw
 = 
wb
->
avg_wrôe_b™dwidth
;

907 
‰ìrun
 = 
	`dúty_‰ìrun_˚ûög
(
dtc
->
thªsh
, dtc->
bg_thªsh
);

908 
limô
 = 
	`h¨d_dúty_limô
(
	`dtc_dom
(
dtc
), dtc->
thªsh
);

909 
wb_thªsh
 = 
dtc
->wb_thresh;

910 
x_öãr˚±
;

911 
£çoöt
;

912 
wb_£çoöt
;

913 
•™
;

914 
pos_øtio
;

915 
x
;

917 
dtc
->
pos_øtio
 = 0;

919 i‡(
	`u∆ikñy
(
dtc
->
dúty
 >
limô
))

927 
£çoöt
 = (
‰ìrun
 + 
limô
) / 2;

928 
pos_øtio
 = 
	`pos_øtio_pﬁynom
(
£çoöt
, 
dtc
->
dúty
, 
limô
);

955 i‡(
	`u∆ikñy
(
wb
->
bdi
->
ˇ∑bûôõs
 & 
BDI_CAP_STRICTLIMIT
)) {

956 
wb_pos_øtio
;

958 i‡(
dtc
->
wb_dúty
 < 8) {

959 
dtc
->
pos_øtio
 = 
	`mö_t
(,Öos_ratio * 2,

960 2 << 
RATELIMIT_CALC_SHIFT
);

964 i‡(
dtc
->
wb_dúty
 >
wb_thªsh
)

967 
wb_£çoöt
 = 
	`dúty_‰ìrun_˚ûög
(
wb_thªsh
,

968 
dtc
->
wb_bg_thªsh
);

970 i‡(
wb_£çoöt
 =0 || wb_£çoöà=
wb_thªsh
)

973 
wb_pos_øtio
 = 
	`pos_øtio_pﬁynom
(
wb_£çoöt
, 
dtc
->
wb_dúty
,

974 
wb_thªsh
);

997 
dtc
->
pos_øtio
 = 
	`mö
’os_øtio, 
wb_pos_øtio
);

1032 i‡(
	`u∆ikñy
(
wb_thªsh
 > 
dtc
->
thªsh
))

1033 
wb_thªsh
 = 
dtc
->
thªsh
;

1041 
wb_thªsh
 = 
	`max
(wb_thªsh, (
limô
 - 
dtc
->
dúty
) / 8);

1046 
x
 = 
	`div_u64
((
u64
)
wb_thªsh
 << 16, 
dtc
->
thªsh
 | 1);

1047 
wb_£çoöt
 = 
£çoöt
 * (
u64
)
x
 >> 16;

1056 
•™
 = (
dtc
->
thªsh
 - 
wb_thªsh
 + 8 * 
wrôe_bw
Ë* (
u64
)
x
 >> 16;

1057 
x_öãr˚±
 = 
wb_£çoöt
 + 
•™
;

1059 i‡(
dtc
->
wb_dúty
 < 
x_öãr˚±
 - 
•™
 / 4) {

1060 
pos_øtio
 = 
	`div64_u64
’os_øtiÿ* (
x_öãr˚±
 - 
dtc
->
wb_dúty
),

1061 (
x_öãr˚±
 - 
wb_£çoöt
) | 1);

1063 
pos_øtio
 /= 4;

1070 
x_öãr˚±
 = 
wb_thªsh
 / 2;

1071 i‡(
dtc
->
wb_dúty
 < 
x_öãr˚±
) {

1072 i‡(
dtc
->
wb_dúty
 > 
x_öãr˚±
 / 8)

1073 
pos_øtio
 = 
	`div_u64
’os_øtiÿ* 
x_öãr˚±
,

1074 
dtc
->
wb_dúty
);

1076 
pos_øtio
 *= 8;

1079 
dtc
->
pos_øtio
 =Öos_ratio;

1080 
	}
}

1082 
	$wb_upd©e_wrôe_b™dwidth
(
bdi_wrôeback
 *
wb
,

1083 
ñ≠£d
,

1084 
wrôãn
)

1086 c⁄° 
≥riod
 = 
	`roundup_pow_of_two
(3 * 
HZ
);

1087 
avg
 = 
wb
->
avg_wrôe_b™dwidth
;

1088 
ﬁd
 = 
wb
->
wrôe_b™dwidth
;

1089 
u64
 
bw
;

1101 
bw
 = 
wrôãn
 - 
	`mö
(wrôãn, 
wb
->
wrôãn_°amp
);

1102 
bw
 *
HZ
;

1103 i‡(
	`u∆ikñy
(
ñ≠£d
 > 
≥riod
)) {

1104 
	`do_div
(
bw
, 
ñ≠£d
);

1105 
avg
 = 
bw
;

1106 
out
;

1108 
bw
 +(
u64
)
wb
->
wrôe_b™dwidth
 * (
≥riod
 - 
ñ≠£d
);

1109 
bw
 >>
	`ûog2
(
≥riod
);

1114 i‡(
avg
 > 
ﬁd
 && old >()
bw
)

1115 
avg
 -◊vg - 
ﬁd
) >> 3;

1117 i‡(
avg
 < 
ﬁd
 && old <()
bw
)

1118 
avg
 +(
ﬁd
 -ávg) >> 3;

1120 
out
:

1122 
avg
 = 
	`max
(avg, 1LU);

1123 i‡(
	`wb_has_dúty_io
(
wb
)) {

1124 
dñè
 = 
avg
 - 
wb
->
avg_wrôe_b™dwidth
;

1125 
	`WARN_ON_ONCE
(
	`©omic_l⁄g_add_ªtu∫
(
dñè
,

1126 &
wb
->
bdi
->
tŸ_wrôe_b™dwidth
) <= 0);

1128 
wb
->
wrôe_b™dwidth
 = 
bw
;

1129 
wb
->
avg_wrôe_b™dwidth
 = 
avg
;

1130 
	}
}

1132 
	$upd©e_dúty_limô
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

1134 
wb_domaö
 *
dom
 = 
	`dtc_dom
(
dtc
);

1135 
thªsh
 = 
dtc
->thresh;

1136 
limô
 = 
dom
->
dúty_limô
;

1141 i‡(
limô
 < 
thªsh
) {

1142 
limô
 = 
thªsh
;

1143 
upd©e
;

1151 
thªsh
 = 
	`max
—hªsh, 
dtc
->
dúty
);

1152 i‡(
limô
 > 
thªsh
) {

1153 
limô
 -÷imô - 
thªsh
) >> 5;

1154 
upd©e
;

1157 
upd©e
:

1158 
dom
->
dúty_limô
 = 
limô
;

1159 
	}
}

1161 
	$domaö_upd©e_b™dwidth
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
,

1162 
now
)

1164 
wb_domaö
 *
dom
 = 
	`dtc_dom
(
dtc
);

1169 i‡(
	`time_bef‹e
(
now
, 
dom
->
dúty_limô_t°amp
 + 
BANDWIDTH_INTERVAL
))

1172 
	`•ö_lock
(&
dom
->
lock
);

1173 i‡(
	`time_a·î_eq
(
now
, 
dom
->
dúty_limô_t°amp
 + 
BANDWIDTH_INTERVAL
)) {

1174 
	`upd©e_dúty_limô
(
dtc
);

1175 
dom
->
dúty_limô_t°amp
 = 
now
;

1177 
	`•ö_u∆ock
(&
dom
->
lock
);

1178 
	}
}

1186 
	$wb_upd©e_dúty_øãlimô
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
,

1187 
dútõd
,

1188 
ñ≠£d
)

1190 
bdi_wrôeback
 *
wb
 = 
dtc
->wb;

1191 
dúty
 = 
dtc
->dirty;

1192 
‰ìrun
 = 
	`dúty_‰ìrun_˚ûög
(
dtc
->
thªsh
, dtc->
bg_thªsh
);

1193 
limô
 = 
	`h¨d_dúty_limô
(
	`dtc_dom
(
dtc
), dtc->
thªsh
);

1194 
£çoöt
 = (
‰ìrun
 + 
limô
) / 2;

1195 
wrôe_bw
 = 
wb
->
avg_wrôe_b™dwidth
;

1196 
dúty_øãlimô
 = 
wb
->dirty_ratelimit;

1197 
dúty_øã
;

1198 
èsk_øãlimô
;

1199 
bÆ™˚d_dúty_øãlimô
;

1200 
°ï
;

1201 
x
;

1202 
shi·
;

1208 
dúty_øã
 = (
dútõd
 - 
wb
->
dútõd_°amp
Ë* 
HZ
 / 
ñ≠£d
;

1213 
èsk_øãlimô
 = (
u64
)
dúty_øãlimô
 *

1214 
dtc
->
pos_øtio
 >> 
RATELIMIT_CALC_SHIFT
;

1215 
èsk_øãlimô
++;

1247 
bÆ™˚d_dúty_øãlimô
 = 
	`div_u64
((
u64
)
èsk_øãlimô
 * 
wrôe_bw
,

1248 
dúty_øã
 | 1);

1252 i‡(
	`u∆ikñy
(
bÆ™˚d_dúty_øãlimô
 > 
wrôe_bw
))

1253 
bÆ™˚d_dúty_øãlimô
 = 
wrôe_bw
;

1289 
°ï
 = 0;

1302 i‡(
	`u∆ikñy
(
wb
->
bdi
->
ˇ∑bûôõs
 & 
BDI_CAP_STRICTLIMIT
)) {

1303 
dúty
 = 
dtc
->
wb_dúty
;

1304 i‡(
dtc
->
wb_dúty
 < 8)

1305 
£çoöt
 = 
dtc
->
wb_dúty
 + 1;

1307 
£çoöt
 = (
dtc
->
wb_thªsh
 + dtc->
wb_bg_thªsh
) / 2;

1310 i‡(
dúty
 < 
£çoöt
) {

1311 
x
 = 
	`mö3
(
wb
->
bÆ™˚d_dúty_øãlimô
,

1312 
bÆ™˚d_dúty_øãlimô
, 
èsk_øãlimô
);

1313 i‡(
dúty_øãlimô
 < 
x
)

1314 
°ï
 = 
x
 - 
dúty_øãlimô
;

1316 
x
 = 
	`max3
(
wb
->
bÆ™˚d_dúty_øãlimô
,

1317 
bÆ™˚d_dúty_øãlimô
, 
èsk_øãlimô
);

1318 i‡(
dúty_øãlimô
 > 
x
)

1319 
°ï
 = 
dúty_øãlimô
 - 
x
;

1327 
shi·
 = 
dúty_øãlimô
 / (2 * 
°ï
 + 1);

1328 i‡(
shi·
 < 
BITS_PER_LONG
)

1329 
°ï
 = 
	`DIV_ROUND_UP
(°ï >> 
shi·
, 8);

1331 
°ï
 = 0;

1333 i‡(
dúty_øãlimô
 < 
bÆ™˚d_dúty_øãlimô
)

1334 
dúty_øãlimô
 +
°ï
;

1336 
dúty_øãlimô
 -
°ï
;

1338 
wb
->
dúty_øãlimô
 = 
	`max
(dirty_ratelimit, 1UL);

1339 
wb
->
bÆ™˚d_dúty_øãlimô
 = balanced_dirty_ratelimit;

1341 
	`åa˚_bdi_dúty_øãlimô
(
wb
, 
dúty_øã
, 
èsk_øãlimô
);

1342 
	}
}

1344 
	$__wb_upd©e_b™dwidth
(
dúty_thrŸée_c⁄åﬁ
 *
gdtc
,

1345 
dúty_thrŸée_c⁄åﬁ
 *
mdtc
,

1346 
°¨t_time
,

1347 
boﬁ
 
upd©e_øãlimô
)

1349 
bdi_wrôeback
 *
wb
 = 
gdtc
->wb;

1350 
now
 = 
jiffõs
;

1351 
ñ≠£d
 = 
now
 - 
wb
->
bw_time_°amp
;

1352 
dútõd
;

1353 
wrôãn
;

1355 
	`lockdï_as£π_hñd
(&
wb
->
li°_lock
);

1360 i‡(
ñ≠£d
 < 
BANDWIDTH_INTERVAL
)

1363 
dútõd
 = 
	`≥r˝u_cou¡î_ªad
(&
wb
->
°©
[
WB_DIRTIED
]);

1364 
wrôãn
 = 
	`≥r˝u_cou¡î_ªad
(&
wb
->
°©
[
WB_WRITTEN
]);

1370 i‡(
ñ≠£d
 > 
HZ
 && 
	`time_bef‹e
(
wb
->
bw_time_°amp
, 
°¨t_time
))

1371 
¢≠shŸ
;

1373 i‡(
upd©e_øãlimô
) {

1374 
	`domaö_upd©e_b™dwidth
(
gdtc
, 
now
);

1375 
	`wb_upd©e_dúty_øãlimô
(
gdtc
, 
dútõd
, 
ñ≠£d
);

1381 i‡(
	`IS_ENABLED
(
CONFIG_CGROUP_WRITEBACK
Ë&& 
mdtc
) {

1382 
	`domaö_upd©e_b™dwidth
(
mdtc
, 
now
);

1383 
	`wb_upd©e_dúty_øãlimô
(
mdtc
, 
dútõd
, 
ñ≠£d
);

1386 
	`wb_upd©e_wrôe_b™dwidth
(
wb
, 
ñ≠£d
, 
wrôãn
);

1388 
¢≠shŸ
:

1389 
wb
->
dútõd_°amp
 = 
dútõd
;

1390 
wb
->
wrôãn_°amp
 = 
wrôãn
;

1391 
wb
->
bw_time_°amp
 = 
now
;

1392 
	}
}

1394 
	$wb_upd©e_b™dwidth
(
bdi_wrôeback
 *
wb
, 
°¨t_time
)

1396 
dúty_thrŸée_c⁄åﬁ
 
gdtc
 = { 
	`GDTC_INIT
(
wb
) };

1398 
	`__wb_upd©e_b™dwidth
(&
gdtc
, 
NULL
, 
°¨t_time
, 
Ál£
);

1399 
	}
}

1409 
	$dúty_pﬁl_öãrvÆ
(
dúty
,

1410 
thªsh
)

1412 i‡(
thªsh
 > 
dúty
)

1413  1UL << (
	`ûog2
(
thªsh
 - 
dúty
) >> 1);

1416 
	}
}

1418 
	$wb_max_∑u£
(
bdi_wrôeback
 *
wb
,

1419 
wb_dúty
)

1421 
bw
 = 
wb
->
avg_wrôe_b™dwidth
;

1422 
t
;

1431 
t
 = 
wb_dúty
 / (1 + 
bw
 / 
	`roundup_pow_of_two
(1 + 
HZ
 / 8));

1432 
t
++;

1434  
	`mö_t
(, 
t
, 
MAX_PAUSE
);

1435 
	}
}

1437 
	$wb_mö_∑u£
(
bdi_wrôeback
 *
wb
,

1438 
max_∑u£
,

1439 
èsk_øãlimô
,

1440 
dúty_øãlimô
,

1441 *
ƒ_dútõd_∑u£
)

1443 
hi
 = 
	`ûog2
(
wb
->
avg_wrôe_b™dwidth
);

1444 
lo
 = 
	`ûog2
(
wb
->
dúty_øãlimô
);

1445 
t
;

1446 
∑u£
;

1447 
∑ges
;

1450 
t
 = 
	`max
(1, 
HZ
 / 100);

1458 i‡(
hi
 > 
lo
)

1459 
t
 +(
hi
 - 
lo
Ë* (10 * 
HZ
) / 1024;

1479 
t
 = 
	`mö
—, 1 + 
max_∑u£
 / 2);

1480 
∑ges
 = 
dúty_øãlimô
 * 
t
 / 
	`roundup_pow_of_two
(
HZ
);

1490 i‡(
∑ges
 < 
DIRTY_POLL_THRESH
) {

1491 
t
 = 
max_∑u£
;

1492 
∑ges
 = 
dúty_øãlimô
 * 
t
 / 
	`roundup_pow_of_two
(
HZ
);

1493 i‡(
∑ges
 > 
DIRTY_POLL_THRESH
) {

1494 
∑ges
 = 
DIRTY_POLL_THRESH
;

1495 
t
 = 
HZ
 * 
DIRTY_POLL_THRESH
 / 
dúty_øãlimô
;

1499 
∑u£
 = 
HZ
 * 
∑ges
 / (
èsk_øãlimô
 + 1);

1500 i‡(
∑u£
 > 
max_∑u£
) {

1501 
t
 = 
max_∑u£
;

1502 
∑ges
 = 
èsk_øãlimô
 * 
t
 / 
	`roundup_pow_of_two
(
HZ
);

1505 *
ƒ_dútõd_∑u£
 = 
∑ges
;

1509  
∑ges
 >
DIRTY_POLL_THRESH
 ? 1 + 
t
 / 2 :Å;

1510 
	}
}

1512 
ölöe
 
	$wb_dúty_limôs
(
dúty_thrŸée_c⁄åﬁ
 *
dtc
)

1514 
bdi_wrôeback
 *
wb
 = 
dtc
->wb;

1515 
wb_ª˛aimabÀ
;

1530 
dtc
->
wb_thªsh
 = 
	`__wb_ˇlc_thªsh
(dtc);

1531 
dtc
->
wb_bg_thªsh
 = dtc->
thªsh
 ?

1532 
	`div_u64
((
u64
)
dtc
->
wb_thªsh
 * dtc->
bg_thªsh
, dtc->
thªsh
) : 0;

1544 i‡(
dtc
->
wb_thªsh
 < 2 * 
	`wb_°©_îr‹
()) {

1545 
wb_ª˛aimabÀ
 = 
	`wb_°©_sum
(
wb
, 
WB_RECLAIMABLE
);

1546 
dtc
->
wb_dúty
 = 
wb_ª˛aimabÀ
 + 
	`wb_°©_sum
(
wb
, 
WB_WRITEBACK
);

1548 
wb_ª˛aimabÀ
 = 
	`wb_°©
(
wb
, 
WB_RECLAIMABLE
);

1549 
dtc
->
wb_dúty
 = 
wb_ª˛aimabÀ
 + 
	`wb_°©
(
wb
, 
WB_WRITEBACK
);

1551 
	}
}

1560 
	$bÆ™˚_dúty_∑ges
(
bdi_wrôeback
 *
wb
,

1561 
∑ges_dútõd
)

1563 
dúty_thrŸée_c⁄åﬁ
 
gdtc_°‹
 = { 
	`GDTC_INIT
(
wb
) };

1564 
dúty_thrŸée_c⁄åﬁ
 
mdtc_°‹
 = { 
	`MDTC_INIT
(
wb
, &
gdtc_°‹
) };

1565 
dúty_thrŸée_c⁄åﬁ
 * c⁄° 
gdtc
 = &
gdtc_°‹
;

1566 
dúty_thrŸée_c⁄åﬁ
 * c⁄° 
mdtc
 = 
	`mdtc_vÆid
(&
mdtc_°‹
) ?

1567 &
mdtc_°‹
 : 
NULL
;

1568 
dúty_thrŸée_c⁄åﬁ
 *
sdtc
;

1569 
ƒ_ª˛aimabÀ
;

1570 
≥riod
;

1571 
∑u£
;

1572 
max_∑u£
;

1573 
mö_∑u£
;

1574 
ƒ_dútõd_∑u£
;

1575 
boﬁ
 
dúty_ex˚eded
 = 
Ál£
;

1576 
èsk_øãlimô
;

1577 
dúty_øãlimô
;

1578 
backög_dev_öfo
 *
bdi
 = 
wb
->bdi;

1579 
boﬁ
 
°ri˘limô
 = 
bdi
->
ˇ∑bûôõs
 & 
BDI_CAP_STRICTLIMIT
;

1580 
°¨t_time
 = 
jiffõs
;

1583 
now
 = 
jiffõs
;

1584 
dúty
, 
thªsh
, 
bg_thªsh
;

1585 
m_dúty
 = 0;

1586 
m_thªsh
 = 0;

1587 
m_bg_thªsh
 = 0;

1595 
ƒ_ª˛aimabÀ
 = 
	`globÆ_node_∑ge_°©e
(
NR_FILE_DIRTY
) +

1596 
	`globÆ_node_∑ge_°©e
(
NR_UNSTABLE_NFS
);

1597 
gdtc
->
avaû
 = 
	`globÆ_dútyabÀ_mem‹y
();

1598 
gdtc
->
dúty
 = 
ƒ_ª˛aimabÀ
 + 
	`globÆ_node_∑ge_°©e
(
NR_WRITEBACK
);

1600 
	`domaö_dúty_limôs
(
gdtc
);

1602 i‡(
	`u∆ikñy
(
°ri˘limô
)) {

1603 
	`wb_dúty_limôs
(
gdtc
);

1605 
dúty
 = 
gdtc
->
wb_dúty
;

1606 
thªsh
 = 
gdtc
->
wb_thªsh
;

1607 
bg_thªsh
 = 
gdtc
->
wb_bg_thªsh
;

1609 
dúty
 = 
gdtc
->dirty;

1610 
thªsh
 = 
gdtc
->thresh;

1611 
bg_thªsh
 = 
gdtc
->bg_thresh;

1614 i‡(
mdtc
) {

1615 
fûïages
, 
hódroom
, 
wrôeback
;

1621 
	`mem_cgroup_wb_°©s
(
wb
, &
fûïages
, &
hódroom
,

1622 &
mdtc
->
dúty
, &
wrôeback
);

1623 
mdtc
->
dúty
 +
wrôeback
;

1624 
	`mdtc_ˇlc_avaû
(
mdtc
, 
fûïages
, 
hódroom
);

1626 
	`domaö_dúty_limôs
(
mdtc
);

1628 i‡(
	`u∆ikñy
(
°ri˘limô
)) {

1629 
	`wb_dúty_limôs
(
mdtc
);

1630 
m_dúty
 = 
mdtc
->
wb_dúty
;

1631 
m_thªsh
 = 
mdtc
->
wb_thªsh
;

1632 
m_bg_thªsh
 = 
mdtc
->
wb_bg_thªsh
;

1634 
m_dúty
 = 
mdtc
->
dúty
;

1635 
m_thªsh
 = 
mdtc
->
thªsh
;

1636 
m_bg_thªsh
 = 
mdtc
->
bg_thªsh
;

1652 i‡(
dúty
 <
	`dúty_‰ìrun_˚ûög
(
thªsh
, 
bg_thªsh
) &&

1653 (!
mdtc
 ||

1654 
m_dúty
 <
	`dúty_‰ìrun_˚ûög
(
m_thªsh
, 
m_bg_thªsh
))) {

1655 
ötv
 = 
	`dúty_pﬁl_öãrvÆ
(
dúty
, 
thªsh
);

1656 
m_ötv
 = 
ULONG_MAX
;

1658 
cuºít
->
dúty_∑u£d_whí
 = 
now
;

1659 
cuºít
->
ƒ_dútõd
 = 0;

1660 i‡(
mdtc
)

1661 
m_ötv
 = 
	`dúty_pﬁl_öãrvÆ
(
m_dúty
, 
m_thªsh
);

1662 
cuºít
->
ƒ_dútõd_∑u£
 = 
	`mö
(
ötv
, 
m_ötv
);

1666 i‡(
	`u∆ikñy
(!
	`wrôeback_ö_¥ogªss
(
wb
)))

1667 
	`wb_°¨t_background_wrôeback
(
wb
);

1673 i‡(!
°ri˘limô
)

1674 
	`wb_dúty_limôs
(
gdtc
);

1676 
dúty_ex˚eded
 = (
gdtc
->
wb_dúty
 > gdtc->
wb_thªsh
) &&

1677 ((
gdtc
->
dúty
 > gdtc->
thªsh
Ë|| 
°ri˘limô
);

1679 
	`wb_posôi⁄_øtio
(
gdtc
);

1680 
sdtc
 = 
gdtc
;

1682 i‡(
mdtc
) {

1689 i‡(!
°ri˘limô
)

1690 
	`wb_dúty_limôs
(
mdtc
);

1692 
dúty_ex˚eded
 |(
mdtc
->
wb_dúty
 > mdtc->
wb_thªsh
) &&

1693 ((
mdtc
->
dúty
 > mdtc->
thªsh
Ë|| 
°ri˘limô
);

1695 
	`wb_posôi⁄_øtio
(
mdtc
);

1696 i‡(
mdtc
->
pos_øtio
 < 
gdtc
->pos_ratio)

1697 
sdtc
 = 
mdtc
;

1700 i‡(
dúty_ex˚eded
 && !
wb
->dirty_exceeded)

1701 
wb
->
dúty_ex˚eded
 = 1;

1703 i‡(
	`time_is_bef‹e_jiffõs
(
wb
->
bw_time_°amp
 +

1704 
BANDWIDTH_INTERVAL
)) {

1705 
	`•ö_lock
(&
wb
->
li°_lock
);

1706 
	`__wb_upd©e_b™dwidth
(
gdtc
, 
mdtc
, 
°¨t_time
, 
åue
);

1707 
	`•ö_u∆ock
(&
wb
->
li°_lock
);

1711 
dúty_øãlimô
 = 
wb
->dirty_ratelimit;

1712 
èsk_øãlimô
 = ((
u64
)
dúty_øãlimô
 * 
sdtc
->
pos_øtio
) >>

1713 
RATELIMIT_CALC_SHIFT
;

1714 
max_∑u£
 = 
	`wb_max_∑u£
(
wb
, 
sdtc
->
wb_dúty
);

1715 
mö_∑u£
 = 
	`wb_mö_∑u£
(
wb
, 
max_∑u£
,

1716 
èsk_øãlimô
, 
dúty_øãlimô
,

1717 &
ƒ_dútõd_∑u£
);

1719 i‡(
	`u∆ikñy
(
èsk_øãlimô
 == 0)) {

1720 
≥riod
 = 
max_∑u£
;

1721 
∑u£
 = 
max_∑u£
;

1722 
∑u£
;

1724 
≥riod
 = 
HZ
 * 
∑ges_dútõd
 / 
èsk_øãlimô
;

1725 
∑u£
 = 
≥riod
;

1726 i‡(
cuºít
->
dúty_∑u£d_whí
)

1727 
∑u£
 -
now
 - 
cuºít
->
dúty_∑u£d_whí
;

1735 i‡(
∑u£
 < 
mö_∑u£
) {

1736 
	`åa˚_bÆ™˚_dúty_∑ges
(
wb
,

1737 
sdtc
->
thªsh
,

1738 
sdtc
->
bg_thªsh
,

1739 
sdtc
->
dúty
,

1740 
sdtc
->
wb_thªsh
,

1741 
sdtc
->
wb_dúty
,

1742 
dúty_øãlimô
,

1743 
èsk_øãlimô
,

1744 
∑ges_dútõd
,

1745 
≥riod
,

1746 
	`mö
(
∑u£
, 0L),

1747 
°¨t_time
);

1748 i‡(
∑u£
 < -
HZ
) {

1749 
cuºít
->
dúty_∑u£d_whí
 = 
now
;

1750 
cuºít
->
ƒ_dútõd
 = 0;

1751 } i‡(
≥riod
) {

1752 
cuºít
->
dúty_∑u£d_whí
 +
≥riod
;

1753 
cuºít
->
ƒ_dútõd
 = 0;

1754 } i‡(
cuºít
->
ƒ_dútõd_∑u£
 <
∑ges_dútõd
)

1755 
cuºít
->
ƒ_dútõd_∑u£
 +
∑ges_dútõd
;

1758 i‡(
	`u∆ikñy
(
∑u£
 > 
max_∑u£
)) {

1760 
now
 +
	`mö
(
∑u£
 - 
max_∑u£
, max_pause);

1761 
∑u£
 = 
max_∑u£
;

1764 
∑u£
:

1765 
	`åa˚_bÆ™˚_dúty_∑ges
(
wb
,

1766 
sdtc
->
thªsh
,

1767 
sdtc
->
bg_thªsh
,

1768 
sdtc
->
dúty
,

1769 
sdtc
->
wb_thªsh
,

1770 
sdtc
->
wb_dúty
,

1771 
dúty_øãlimô
,

1772 
èsk_øãlimô
,

1773 
∑ges_dútõd
,

1774 
≥riod
,

1775 
∑u£
,

1776 
°¨t_time
);

1777 
	`__£t_cuºít_°©e
(
TASK_KILLABLE
);

1778 
wb
->
dúty_¶ìp
 = 
now
;

1779 
	`io_scheduÀ_timeout
(
∑u£
);

1781 
cuºít
->
dúty_∑u£d_whí
 = 
now
 + 
∑u£
;

1782 
cuºít
->
ƒ_dútõd
 = 0;

1783 
cuºít
->
ƒ_dútõd_∑u£
 =Çr_dirtied_pause;

1789 i‡(
èsk_øãlimô
)

1802 i‡(
sdtc
->
wb_dúty
 <
	`wb_°©_îr‹
())

1805 i‡(
	`Áèl_sig«l_≥ndög
(
cuºít
))

1809 i‡(!
dúty_ex˚eded
 && 
wb
->dirty_exceeded)

1810 
wb
->
dúty_ex˚eded
 = 0;

1812 i‡(
	`wrôeback_ö_¥ogªss
(
wb
))

1823 i‡(
œ±›_mode
)

1826 i‡(
ƒ_ª˛aimabÀ
 > 
gdtc
->
bg_thªsh
)

1827 
	`wb_°¨t_background_wrôeback
(
wb
);

1828 
	}
}

1830 
DEFINE_PER_CPU
(, 
bdp_øãlimôs
);

1846 
DEFINE_PER_CPU
(, 
dúty_thrŸée_Àaks
) = 0;

1861 
	$bÆ™˚_dúty_∑ges_øãlimôed
(
addªss_•a˚
 *
m≠pög
)

1863 
öode
 *öodê
m≠pög
->
ho°
;

1864 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
öode
);

1865 
bdi_wrôeback
 *
wb
 = 
NULL
;

1866 
øãlimô
;

1867 *
p
;

1869 i‡(!
	`bdi_ˇp_accou¡_dúty
(
bdi
))

1872 i‡(
	`öode_cgwb_íabÀd
(
öode
))

1873 
wb
 = 
	`wb_gë_¸óã_cuºít
(
bdi
, 
GFP_KERNEL
);

1874 i‡(!
wb
)

1875 
wb
 = &
bdi
->wb;

1877 
øãlimô
 = 
cuºít
->
ƒ_dútõd_∑u£
;

1878 i‡(
wb
->
dúty_ex˚eded
)

1879 
øãlimô
 = 
	`mö
‘©ñimô, 32 >> (
PAGE_SHIFT
 - 10));

1881 
	`¥ìm±_dißbÀ
();

1888 
p
 = 
	`this_˝u_±r
(&
bdp_øãlimôs
);

1889 i‡(
	`u∆ikñy
(
cuºít
->
ƒ_dútõd
 >
øãlimô
))

1890 *
p
 = 0;

1891 i‡(
	`u∆ikñy
(*
p
 >
øãlimô_∑ges
)) {

1892 *
p
 = 0;

1893 
øãlimô
 = 0;

1900 
p
 = 
	`this_˝u_±r
(&
dúty_thrŸée_Àaks
);

1901 i‡(*
p
 > 0 && 
cuºít
->
ƒ_dútõd
 < 
øãlimô
) {

1902 
ƒ_∑ges_dútõd
;

1903 
ƒ_∑ges_dútõd
 = 
	`mö
(*
p
, 
øãlimô
 - 
cuºít
->
ƒ_dútõd
);

1904 *
p
 -
ƒ_∑ges_dútõd
;

1905 
cuºít
->
ƒ_dútõd
 +
ƒ_∑ges_dútõd
;

1907 
	`¥ìm±_íabÀ
();

1909 i‡(
	`u∆ikñy
(
cuºít
->
ƒ_dútõd
 >
øãlimô
))

1910 
	`bÆ™˚_dúty_∑ges
(
wb
, 
cuºít
->
ƒ_dútõd
);

1912 
	`wb_put
(
wb
);

1913 
	}
}

1914 
EXPORT_SYMBOL
(
bÆ™˚_dúty_∑ges_øãlimôed
);

1925 
boﬁ
 
	$wb_ovî_bg_thªsh
(
bdi_wrôeback
 *
wb
)

1927 
dúty_thrŸée_c⁄åﬁ
 
gdtc_°‹
 = { 
	`GDTC_INIT
(
wb
) };

1928 
dúty_thrŸée_c⁄åﬁ
 
mdtc_°‹
 = { 
	`MDTC_INIT
(
wb
, &
gdtc_°‹
) };

1929 
dúty_thrŸée_c⁄åﬁ
 * c⁄° 
gdtc
 = &
gdtc_°‹
;

1930 
dúty_thrŸée_c⁄åﬁ
 * c⁄° 
mdtc
 = 
	`mdtc_vÆid
(&
mdtc_°‹
) ?

1931 &
mdtc_°‹
 : 
NULL
;

1937 
gdtc
->
avaû
 = 
	`globÆ_dútyabÀ_mem‹y
();

1938 
gdtc
->
dúty
 = 
	`globÆ_node_∑ge_°©e
(
NR_FILE_DIRTY
) +

1939 
	`globÆ_node_∑ge_°©e
(
NR_UNSTABLE_NFS
);

1940 
	`domaö_dúty_limôs
(
gdtc
);

1942 i‡(
gdtc
->
dúty
 > gdtc->
bg_thªsh
)

1943  
åue
;

1945 i‡(
	`wb_°©
(
wb
, 
WB_RECLAIMABLE
) >

1946 
	`wb_ˇlc_thªsh
(
gdtc
->
wb
, gdtc->
bg_thªsh
))

1947  
åue
;

1949 i‡(
mdtc
) {

1950 
fûïages
, 
hódroom
, 
wrôeback
;

1952 
	`mem_cgroup_wb_°©s
(
wb
, &
fûïages
, &
hódroom
, &
mdtc
->
dúty
,

1953 &
wrôeback
);

1954 
	`mdtc_ˇlc_avaû
(
mdtc
, 
fûïages
, 
hódroom
);

1955 
	`domaö_dúty_limôs
(
mdtc
);

1957 i‡(
mdtc
->
dúty
 > mdtc->
bg_thªsh
)

1958  
åue
;

1960 i‡(
	`wb_°©
(
wb
, 
WB_RECLAIMABLE
) >

1961 
	`wb_ˇlc_thªsh
(
mdtc
->
wb
, mdtc->
bg_thªsh
))

1962  
åue
;

1965  
Ál£
;

1966 
	}
}

1971 
	$dúty_wrôeback_˚¡i£cs_h™dÀr
(
˘l_èbÀ
 *
èbÀ
, 
wrôe
,

1972 
__u£r
 *
buf„r
, 
size_t
 *
Àngth
, 
loff_t
 *
µos
)

1974 
ﬁd_öãrvÆ
 = 
dúty_wrôeback_öãrvÆ
;

1975 
ªt
;

1977 
ªt
 = 
	`¥oc_doötvec
(
èbÀ
, 
wrôe
, 
buf„r
, 
Àngth
, 
µos
);

1986 i‡(!
ªt
 && 
wrôe
 && 
dúty_wrôeback_öãrvÆ
 &&

1987 
dúty_wrôeback_öãrvÆ
 !
ﬁd_öãrvÆ
)

1988 
	`wakeup_Êushî_thªads
(
WB_REASON_PERIODIC
);

1990  
ªt
;

1991 
	}
}

1993 #ifde‡
CONFIG_BLOCK


1994 
	$œ±›_mode_timî_‚
(
timî_li°
 *
t
)

1996 
backög_dev_öfo
 *backing_dev_info =

1997 
	`‰om_timî
(
backög_dev_öfo
, 
t
, 
œ±›_mode_wb_timî
);

1999 
	`wakeup_Êushî_thªads_bdi
(
backög_dev_öfo
, 
WB_REASON_LAPTOP_TIMER
);

2000 
	}
}

2007 
	$œ±›_io_com∂ëi⁄
(
backög_dev_öfo
 *
öfo
)

2009 
	`mod_timî
(&
öfo
->
œ±›_mode_wb_timî
, 
jiffõs
 + 
œ±›_mode
);

2010 
	}
}

2017 
	$œ±›_sync_com∂ëi⁄
()

2019 
backög_dev_öfo
 *
bdi
;

2021 
	`rcu_ªad_lock
();

2023 
	`li°_f‹_óch_íåy_rcu
(
bdi
, &
bdi_li°
, bdi_list)

2024 
	`dñ_timî
(&
bdi
->
œ±›_mode_wb_timî
);

2026 
	`rcu_ªad_u∆ock
();

2027 
	}
}

2041 
	$wrôeback_£t_øãlimô
()

2043 
wb_domaö
 *
dom
 = &
globÆ_wb_domaö
;

2044 
background_thªsh
;

2045 
dúty_thªsh
;

2047 
	`globÆ_dúty_limôs
(&
background_thªsh
, &
dúty_thªsh
);

2048 
dom
->
dúty_limô
 = 
dúty_thªsh
;

2049 
øãlimô_∑ges
 = 
dúty_thªsh
 / (
	`num_⁄löe_˝us
() * 32);

2050 i‡(
øãlimô_∑ges
 < 16)

2051 
øãlimô_∑ges
 = 16;

2052 
	}
}

2054 
	$∑ge_wrôeback_˝u_⁄löe
(
˝u
)

2056 
	`wrôeback_£t_øãlimô
();

2058 
	}
}

2078 
__öô
 
	$∑ge_wrôeback_öô
()

2080 
	`BUG_ON
(
	`wb_domaö_öô
(&
globÆ_wb_domaö
, 
GFP_KERNEL
));

2082 
	`˝uhp_£tup_°©e
(
CPUHP_AP_ONLINE_DYN
, "mm/writeback:online",

2083 
∑ge_wrôeback_˝u_⁄löe
, 
NULL
);

2084 
	`˝uhp_£tup_°©e
(
CPUHP_MM_WRITEBACK_DEAD
, "mm/wrôeback:dód", 
NULL
,

2085 
∑ge_wrôeback_˝u_⁄löe
);

2086 
	}
}

2102 
	$èg_∑ges_f‹_wrôeback
(
addªss_•a˚
 *
m≠pög
,

2103 
pgoff_t
 
°¨t
,Ögoff_à
íd
)

2105 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
°¨t
);

2106 
ègged
 = 0;

2107 *
∑ge
;

2109 
	`xas_lock_úq
(&
xas
);

2110 
	`xas_f‹_óch_m¨ked
(&
xas
, 
∑ge
, 
íd
, 
PAGECACHE_TAG_DIRTY
) {

2111 
	`xas_£t_m¨k
(&
xas
, 
PAGECACHE_TAG_TOWRITE
);

2112 i‡(++
ègged
 % 
XA_CHECK_SCHED
)

2115 
	`xas_∑u£
(&
xas
);

2116 
	`xas_u∆ock_úq
(&
xas
);

2117 
	`c⁄d_ªsched
();

2118 
	`xas_lock_úq
(&
xas
);

2120 
	`xas_u∆ock_úq
(&
xas
);

2121 
	}
}

2122 
EXPORT_SYMBOL
(
èg_∑ges_f‹_wrôeback
);

2155 
	$wrôe_ˇche_∑ges
(
addªss_•a˚
 *
m≠pög
,

2156 
wrôeback_c⁄åﬁ
 *
wbc
, 
wrôïage_t
 
wrôïage
,

2157 *
d©a
)

2159 
ªt
 = 0;

2160 
d⁄e
 = 0;

2161 
îr‹
;

2162 
∑gevec
 
pvec
;

2163 
ƒ_∑ges
;

2164 
pgoff_t
 
	`unöôülized_v¨
(
wrôeback_ödex
);

2165 
pgoff_t
 
ödex
;

2166 
pgoff_t
 
íd
;

2167 
pgoff_t
 
d⁄e_ödex
;

2168 
ønge_whﬁe
 = 0;

2169 
xa_m¨k_t
 
èg
;

2171 
	`∑gevec_öô
(&
pvec
);

2172 i‡(
wbc
->
ønge_cy˛ic
) {

2173 
wrôeback_ödex
 = 
m≠pög
->writeback_index;

2174 
ödex
 = 
wrôeback_ödex
;

2175 
íd
 = -1;

2177 
ödex
 = 
wbc
->
ønge_°¨t
 >> 
PAGE_SHIFT
;

2178 
íd
 = 
wbc
->
ønge_íd
 >> 
PAGE_SHIFT
;

2179 i‡(
wbc
->
ønge_°¨t
 =0 && wbc->
ønge_íd
 =
LLONG_MAX
)

2180 
ønge_whﬁe
 = 1;

2182 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2183 
èg
 = 
PAGECACHE_TAG_TOWRITE
;

2185 
èg
 = 
PAGECACHE_TAG_DIRTY
;

2186 i‡(
wbc
->
sync_mode
 =
WB_SYNC_ALL
 || wbc->
ègged_wrôïages
)

2187 
	`èg_∑ges_f‹_wrôeback
(
m≠pög
, 
ödex
, 
íd
);

2188 
d⁄e_ödex
 = 
ödex
;

2189 !
d⁄e
 && (
ödex
 <
íd
)) {

2190 
i
;

2192 
ƒ_∑ges
 = 
	`∑gevec_lookup_ønge_èg
(&
pvec
, 
m≠pög
, &
ödex
, 
íd
,

2193 
èg
);

2194 i‡(
ƒ_∑ges
 == 0)

2197 
i
 = 0; i < 
ƒ_∑ges
; i++) {

2198 
∑ge
 *∑gê
pvec
.
∑ges
[
i
];

2200 
d⁄e_ödex
 = 
∑ge
->
ödex
;

2202 
	`lock_∑ge
(
∑ge
);

2212 i‡(
	`u∆ikñy
(
∑ge
->
m≠pög
 != mapping)) {

2213 
c⁄töue_u∆ock
:

2214 
	`u∆ock_∑ge
(
∑ge
);

2218 i‡(!
	`PageDúty
(
∑ge
)) {

2220 
c⁄töue_u∆ock
;

2223 i‡(
	`PageWrôeback
(
∑ge
)) {

2224 i‡(
wbc
->
sync_mode
 !
WB_SYNC_NONE
)

2225 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2227 
c⁄töue_u∆ock
;

2230 
	`BUG_ON
(
	`PageWrôeback
(
∑ge
));

2231 i‡(!
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
))

2232 
c⁄töue_u∆ock
;

2234 
	`åa˚_wbc_wrôïage
(
wbc
, 
	`öode_to_bdi
(
m≠pög
->
ho°
));

2235 
îr‹
 = (*
wrôïage
)(
∑ge
, 
wbc
, 
d©a
);

2236 i‡(
	`u∆ikñy
(
îr‹
)) {

2249 i‡(
îr‹
 =
AOP_WRITEPAGE_ACTIVATE
) {

2250 
	`u∆ock_∑ge
(
∑ge
);

2251 
îr‹
 = 0;

2252 } i‡(
wbc
->
sync_mode
 !
WB_SYNC_ALL
) {

2253 
ªt
 = 
îr‹
;

2254 
d⁄e_ödex
 = 
∑ge
->
ödex
 + 1;

2255 
d⁄e
 = 1;

2258 i‡(!
ªt
)

2259 
ªt
 = 
îr‹
;

2268 i‡(--
wbc
->
ƒ_to_wrôe
 <= 0 &&

2269 
wbc
->
sync_mode
 =
WB_SYNC_NONE
) {

2270 
d⁄e
 = 1;

2274 
	`∑gevec_ªÀa£
(&
pvec
);

2275 
	`c⁄d_ªsched
();

2283 i‡(
wbc
->
ønge_cy˛ic
 && !
d⁄e
)

2284 
d⁄e_ödex
 = 0;

2285 i‡(
wbc
->
ønge_cy˛ic
 || (
ønge_whﬁe
 && wbc->
ƒ_to_wrôe
 > 0))

2286 
m≠pög
->
wrôeback_ödex
 = 
d⁄e_ödex
;

2288  
ªt
;

2289 
	}
}

2290 
EXPORT_SYMBOL
(
wrôe_ˇche_∑ges
);

2296 
	$__wrôïage
(
∑ge
 *∑ge, 
wrôeback_c⁄åﬁ
 *
wbc
,

2297 *
d©a
)

2299 
addªss_•a˚
 *
m≠pög
 = 
d©a
;

2300 
ªt
 = 
m≠pög
->
a_›s
->
	`wrôïage
(
∑ge
, 
wbc
);

2301 
	`m≠pög_£t_îr‹
(
m≠pög
, 
ªt
);

2302  
ªt
;

2303 
	}
}

2315 
	$gíîic_wrôïages
(
addªss_•a˚
 *
m≠pög
,

2316 
wrôeback_c⁄åﬁ
 *
wbc
)

2318 
blk_∂ug
 
∂ug
;

2319 
ªt
;

2322 i‡(!
m≠pög
->
a_›s
->
wrôïage
)

2325 
	`blk_°¨t_∂ug
(&
∂ug
);

2326 
ªt
 = 
	`wrôe_ˇche_∑ges
(
m≠pög
, 
wbc
, 
__wrôïage
, mapping);

2327 
	`blk_föish_∂ug
(&
∂ug
);

2328  
ªt
;

2329 
	}
}

2331 
EXPORT_SYMBOL
(
gíîic_wrôïages
);

2333 
	$do_wrôïages
(
addªss_•a˚
 *
m≠pög
, 
wrôeback_c⁄åﬁ
 *
wbc
)

2335 
ªt
;

2337 i‡(
wbc
->
ƒ_to_wrôe
 <= 0)

2340 i‡(
m≠pög
->
a_›s
->
wrôïages
)

2341 
ªt
 = 
m≠pög
->
a_›s
->
	`wrôïages
(m≠pög, 
wbc
);

2343 
ªt
 = 
	`gíîic_wrôïages
(
m≠pög
, 
wbc
);

2344 i‡((
ªt
 !-
ENOMEM
Ë|| (
wbc
->
sync_mode
 !
WB_SYNC_ALL
))

2346 
	`c⁄d_ªsched
();

2347 
	`c⁄ge°i⁄_waô
(
BLK_RW_ASYNC
, 
HZ
/50);

2349  
ªt
;

2350 
	}
}

2363 
	$wrôe_⁄e_∑ge
(
∑ge
 *page)

2365 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

2366 
ªt
 = 0;

2367 
wrôeback_c⁄åﬁ
 
wbc
 = {

2368 .
sync_mode
 = 
WB_SYNC_ALL
,

2369 .
ƒ_to_wrôe
 = 1,

2372 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

2374 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2376 i‡(
	`˛ór_∑ge_dúty_f‹_io
(
∑ge
)) {

2377 
	`gë_∑ge
(
∑ge
);

2378 
ªt
 = 
m≠pög
->
a_›s
->
	`wrôïage
(
∑ge
, &
wbc
);

2379 i‡(
ªt
 == 0)

2380 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2381 
	`put_∑ge
(
∑ge
);

2383 
	`u∆ock_∑ge
(
∑ge
);

2386 i‡(!
ªt
)

2387 
ªt
 = 
	`fûem≠_check_îr‹s
(
m≠pög
);

2388  
ªt
;

2389 
	}
}

2390 
EXPORT_SYMBOL
(
wrôe_⁄e_∑ge
);

2395 
	$__£t_∑ge_dúty_no_wrôeback
(
∑ge
 *page)

2397 i‡(!
	`PageDúty
(
∑ge
))

2398  !
	`Te°SëPageDúty
(
∑ge
);

2400 
	}
}

2409 
	$accou¡_∑ge_dútõd
(
∑ge
 *∑ge, 
addªss_•a˚
 *
m≠pög
)

2411 
öode
 *öodê
m≠pög
->
ho°
;

2413 
	`åa˚_wrôeback_dúty_∑ge
(
∑ge
, 
m≠pög
);

2415 i‡(
	`m≠pög_ˇp_accou¡_dúty
(
m≠pög
)) {

2416 
bdi_wrôeback
 *
wb
;

2418 
	`öode_©èch_wb
(
öode
, 
∑ge
);

2419 
wb
 = 
	`öode_to_wb
(
öode
);

2421 
	`__öc_Ãuvec_∑ge_°©e
(
∑ge
, 
NR_FILE_DIRTY
);

2422 
	`__öc_z⁄e_∑ge_°©e
(
∑ge
, 
NR_ZONE_WRITE_PENDING
);

2423 
	`__öc_node_∑ge_°©e
(
∑ge
, 
NR_DIRTIED
);

2424 
	`öc_wb_°©
(
wb
, 
WB_RECLAIMABLE
);

2425 
	`öc_wb_°©
(
wb
, 
WB_DIRTIED
);

2426 
	`èsk_io_accou¡_wrôe
(
PAGE_SIZE
);

2427 
cuºít
->
ƒ_dútõd
++;

2428 
	`this_˝u_öc
(
bdp_øãlimôs
);

2430 
	}
}

2431 
EXPORT_SYMBOL
(
accou¡_∑ge_dútõd
);

2438 
	$accou¡_∑ge_˛ó√d
(
∑ge
 *∑ge, 
addªss_•a˚
 *
m≠pög
,

2439 
bdi_wrôeback
 *
wb
)

2441 i‡(
	`m≠pög_ˇp_accou¡_dúty
(
m≠pög
)) {

2442 
	`dec_Ãuvec_∑ge_°©e
(
∑ge
, 
NR_FILE_DIRTY
);

2443 
	`dec_z⁄e_∑ge_°©e
(
∑ge
, 
NR_ZONE_WRITE_PENDING
);

2444 
	`dec_wb_°©
(
wb
, 
WB_RECLAIMABLE
);

2445 
	`èsk_io_accou¡_ˇn˚Œed_wrôe
(
PAGE_SIZE
);

2447 
	}
}

2461 
	$__£t_∑ge_dúty_nobuf„rs
(
∑ge
 *page)

2463 
	`lock_∑ge_memcg
(
∑ge
);

2464 i‡(!
	`Te°SëPageDúty
(
∑ge
)) {

2465 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2466 
Êags
;

2468 i‡(!
m≠pög
) {

2469 
	`u∆ock_∑ge_memcg
(
∑ge
);

2473 
	`xa_lock_úqßve
(&
m≠pög
->
i_∑ges
, 
Êags
);

2474 
	`BUG_ON
(
	`∑ge_m≠pög
(
∑ge
Ë!
m≠pög
);

2475 
	`WARN_ON_ONCE
(!
	`PagePriv©e
(
∑ge
Ë&& !
	`PageU±od©e
(page));

2476 
	`accou¡_∑ge_dútõd
(
∑ge
, 
m≠pög
);

2477 
	`__xa_£t_m¨k
(&
m≠pög
->
i_∑ges
, 
	`∑ge_ödex
(
∑ge
),

2478 
PAGECACHE_TAG_DIRTY
);

2479 
	`xa_u∆ock_úqª°‹e
(&
m≠pög
->
i_∑ges
, 
Êags
);

2480 
	`u∆ock_∑ge_memcg
(
∑ge
);

2482 i‡(
m≠pög
->
ho°
) {

2484 
	`__m¨k_öode_dúty
(
m≠pög
->
ho°
, 
I_DIRTY_PAGES
);

2488 
	`u∆ock_∑ge_memcg
(
∑ge
);

2490 
	}
}

2491 
EXPORT_SYMBOL
(
__£t_∑ge_dúty_nobuf„rs
);

2500 
	$accou¡_∑ge_ªdúty
(
∑ge
 *page)

2502 
addªss_•a˚
 *
m≠pög
 = 
∑ge
->mapping;

2504 i‡(
m≠pög
 && 
	`m≠pög_ˇp_accou¡_dúty
(mapping)) {

2505 
öode
 *öodê
m≠pög
->
ho°
;

2506 
bdi_wrôeback
 *
wb
;

2507 
wb_lock_cookõ
 
cookõ
 = {};

2509 
wb
 = 
	`u∆ocked_öode_to_wb_begö
(
öode
, &
cookõ
);

2510 
cuºít
->
ƒ_dútõd
--;

2511 
	`dec_node_∑ge_°©e
(
∑ge
, 
NR_DIRTIED
);

2512 
	`dec_wb_°©
(
wb
, 
WB_DIRTIED
);

2513 
	`u∆ocked_öode_to_wb_íd
(
öode
, &
cookõ
);

2515 
	}
}

2516 
EXPORT_SYMBOL
(
accou¡_∑ge_ªdúty
);

2523 
	$ªdúty_∑ge_f‹_wrôïage
(
wrôeback_c⁄åﬁ
 *
wbc
, 
∑ge
 *page)

2525 
ªt
;

2527 
wbc
->
∑ges_skù≥d
++;

2528 
ªt
 = 
	`__£t_∑ge_dúty_nobuf„rs
(
∑ge
);

2529 
	`accou¡_∑ge_ªdúty
(
∑ge
);

2530  
ªt
;

2531 
	}
}

2532 
EXPORT_SYMBOL
(
ªdúty_∑ge_f‹_wrôïage
);

2545 
	$£t_∑ge_dúty
(
∑ge
 *page)

2547 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2549 
∑ge
 = 
	`compound_hód
(page);

2550 i‡(
	`likñy
(
m≠pög
)) {

2551 (*
•d
)(
∑ge
 *Ë
m≠pög
->
a_›s
->
£t_∑ge_dúty
;

2562 i‡(
	`PageRe˛aim
(
∑ge
))

2563 
	`CÀ¨PageRe˛aim
(
∑ge
);

2564 #ifde‡
CONFIG_BLOCK


2565 i‡(!
•d
)

2566 
•d
 = 
__£t_∑ge_dúty_buf„rs
;

2568  (*
•d
)(
∑ge
);

2570 i‡(!
	`PageDúty
(
∑ge
)) {

2571 i‡(!
	`Te°SëPageDúty
(
∑ge
))

2575 
	}
}

2576 
EXPORT_SYMBOL
(
£t_∑ge_dúty
);

2588 
	$£t_∑ge_dúty_lock
(
∑ge
 *page)

2590 
ªt
;

2592 
	`lock_∑ge
(
∑ge
);

2593 
ªt
 = 
	`£t_∑ge_dúty
(
∑ge
);

2594 
	`u∆ock_∑ge
(
∑ge
);

2595  
ªt
;

2596 
	}
}

2597 
EXPORT_SYMBOL
(
£t_∑ge_dúty_lock
);

2612 
	$__ˇn˚l_dúty_∑ge
(
∑ge
 *page)

2614 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2616 i‡(
	`m≠pög_ˇp_accou¡_dúty
(
m≠pög
)) {

2617 
öode
 *öodê
m≠pög
->
ho°
;

2618 
bdi_wrôeback
 *
wb
;

2619 
wb_lock_cookõ
 
cookõ
 = {};

2621 
	`lock_∑ge_memcg
(
∑ge
);

2622 
wb
 = 
	`u∆ocked_öode_to_wb_begö
(
öode
, &
cookõ
);

2624 i‡(
	`Te°CÀ¨PageDúty
(
∑ge
))

2625 
	`accou¡_∑ge_˛ó√d
(
∑ge
, 
m≠pög
, 
wb
);

2627 
	`u∆ocked_öode_to_wb_íd
(
öode
, &
cookõ
);

2628 
	`u∆ock_∑ge_memcg
(
∑ge
);

2630 
	`CÀ¨PageDúty
(
∑ge
);

2632 
	}
}

2633 
EXPORT_SYMBOL
(
__ˇn˚l_dúty_∑ge
);

2649 
	$˛ór_∑ge_dúty_f‹_io
(
∑ge
 *page)

2651 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2652 
ªt
 = 0;

2654 
	`BUG_ON
(!
	`PageLocked
(
∑ge
));

2656 i‡(
m≠pög
 && 
	`m≠pög_ˇp_accou¡_dúty
(mapping)) {

2657 
öode
 *öodê
m≠pög
->
ho°
;

2658 
bdi_wrôeback
 *
wb
;

2659 
wb_lock_cookõ
 
cookõ
 = {};

2686 i‡(
	`∑ge_mk˛ón
(
∑ge
))

2687 
	`£t_∑ge_dúty
(
∑ge
);

2696 
wb
 = 
	`u∆ocked_öode_to_wb_begö
(
öode
, &
cookõ
);

2697 i‡(
	`Te°CÀ¨PageDúty
(
∑ge
)) {

2698 
	`dec_Ãuvec_∑ge_°©e
(
∑ge
, 
NR_FILE_DIRTY
);

2699 
	`dec_z⁄e_∑ge_°©e
(
∑ge
, 
NR_ZONE_WRITE_PENDING
);

2700 
	`dec_wb_°©
(
wb
, 
WB_RECLAIMABLE
);

2701 
ªt
 = 1;

2703 
	`u∆ocked_öode_to_wb_íd
(
öode
, &
cookõ
);

2704  
ªt
;

2706  
	`Te°CÀ¨PageDúty
(
∑ge
);

2707 
	}
}

2708 
EXPORT_SYMBOL
(
˛ór_∑ge_dúty_f‹_io
);

2710 
	$ã°_˛ór_∑ge_wrôeback
(
∑ge
 *page)

2712 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2713 
mem_cgroup
 *
memcg
;

2714 
Ãuvec
 *lruvec;

2715 
ªt
;

2717 
memcg
 = 
	`lock_∑ge_memcg
(
∑ge
);

2718 
Ãuvec
 = 
	`mem_cgroup_∑ge_Ãuvec
(
∑ge
, 
	`∑ge_pgd©
(page));

2719 i‡(
m≠pög
 && 
	`m≠pög_u£_wrôeback_ègs
(mapping)) {

2720 
öode
 *öodê
m≠pög
->
ho°
;

2721 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
öode
);

2722 
Êags
;

2724 
	`xa_lock_úqßve
(&
m≠pög
->
i_∑ges
, 
Êags
);

2725 
ªt
 = 
	`Te°CÀ¨PageWrôeback
(
∑ge
);

2726 i‡(
ªt
) {

2727 
	`__xa_˛ór_m¨k
(&
m≠pög
->
i_∑ges
, 
	`∑ge_ödex
(
∑ge
),

2728 
PAGECACHE_TAG_WRITEBACK
);

2729 i‡(
	`bdi_ˇp_accou¡_wrôeback
(
bdi
)) {

2730 
bdi_wrôeback
 *
wb
 = 
	`öode_to_wb
(
öode
);

2732 
	`dec_wb_°©
(
wb
, 
WB_WRITEBACK
);

2733 
	`__wb_wrôeout_öc
(
wb
);

2737 i‡(
m≠pög
->
ho°
 && !
	`m≠pög_ègged
(mapping,

2738 
PAGECACHE_TAG_WRITEBACK
))

2739 
	`sb_˛ór_öode_wrôeback
(
m≠pög
->
ho°
);

2741 
	`xa_u∆ock_úqª°‹e
(&
m≠pög
->
i_∑ges
, 
Êags
);

2743 
ªt
 = 
	`Te°CÀ¨PageWrôeback
(
∑ge
);

2751 i‡(
ªt
) {

2752 
	`dec_Ãuvec_°©e
(
Ãuvec
, 
NR_WRITEBACK
);

2753 
	`dec_z⁄e_∑ge_°©e
(
∑ge
, 
NR_ZONE_WRITE_PENDING
);

2754 
	`öc_node_∑ge_°©e
(
∑ge
, 
NR_WRITTEN
);

2756 
	`__u∆ock_∑ge_memcg
(
memcg
);

2757  
ªt
;

2758 
	}
}

2760 
	$__ã°_£t_∑ge_wrôeback
(
∑ge
 *∑ge, 
boﬁ
 
kìp_wrôe
)

2762 
addªss_•a˚
 *
m≠pög
 = 
	`∑ge_m≠pög
(
∑ge
);

2763 
ªt
;

2765 
	`lock_∑ge_memcg
(
∑ge
);

2766 i‡(
m≠pög
 && 
	`m≠pög_u£_wrôeback_ègs
(mapping)) {

2767 
	`XA_STATE
(
xas
, &
m≠pög
->
i_∑ges
, 
	`∑ge_ödex
(
∑ge
));

2768 
öode
 *öodê
m≠pög
->
ho°
;

2769 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
öode
);

2770 
Êags
;

2772 
	`xas_lock_úqßve
(&
xas
, 
Êags
);

2773 
	`xas_lﬂd
(&
xas
);

2774 
ªt
 = 
	`Te°SëPageWrôeback
(
∑ge
);

2775 i‡(!
ªt
) {

2776 
boﬁ
 
⁄_wbli°
;

2778 
⁄_wbli°
 = 
	`m≠pög_ègged
(
m≠pög
,

2779 
PAGECACHE_TAG_WRITEBACK
);

2781 
	`xas_£t_m¨k
(&
xas
, 
PAGECACHE_TAG_WRITEBACK
);

2782 i‡(
	`bdi_ˇp_accou¡_wrôeback
(
bdi
))

2783 
	`öc_wb_°©
(
	`öode_to_wb
(
öode
), 
WB_WRITEBACK
);

2790 i‡(
m≠pög
->
ho°
 && !
⁄_wbli°
)

2791 
	`sb_m¨k_öode_wrôeback
(
m≠pög
->
ho°
);

2793 i‡(!
	`PageDúty
(
∑ge
))

2794 
	`xas_˛ór_m¨k
(&
xas
, 
PAGECACHE_TAG_DIRTY
);

2795 i‡(!
kìp_wrôe
)

2796 
	`xas_˛ór_m¨k
(&
xas
, 
PAGECACHE_TAG_TOWRITE
);

2797 
	`xas_u∆ock_úqª°‹e
(&
xas
, 
Êags
);

2799 
ªt
 = 
	`Te°SëPageWrôeback
(
∑ge
);

2801 i‡(!
ªt
) {

2802 
	`öc_Ãuvec_∑ge_°©e
(
∑ge
, 
NR_WRITEBACK
);

2803 
	`öc_z⁄e_∑ge_°©e
(
∑ge
, 
NR_ZONE_WRITE_PENDING
);

2805 
	`u∆ock_∑ge_memcg
(
∑ge
);

2806  
ªt
;

2808 
	}
}

2809 
EXPORT_SYMBOL
(
__ã°_£t_∑ge_wrôeback
);

2819 
	$waô_f‹_°abÀ_∑ge
(
∑ge
 *page)

2821 i‡(
	`bdi_ˇp_°abÀ_∑ges_ªquúed
(
	`öode_to_bdi
(
∑ge
->
m≠pög
->
ho°
)))

2822 
	`waô_⁄_∑ge_wrôeback
(
∑ge
);

2823 
	}
}

2824 
EXPORT_SYMBOL_GPL
(
waô_f‹_°abÀ_∑ge
);

	@pxt4.h

17 #i‚de‡
_PXT4_H


18 
	#_PXT4_H


	)

20 
	~<löux/ty≥s.h
>

21 
	~<löux/blkdev.h
>

22 
	~<löux/magic.h
>

23 
	~<löux/jbd3.h
>

24 
	~<löux/quŸa.h
>

25 
	~<löux/rw£m.h
>

26 
	~<löux/rbåì.h
>

27 
	~<löux/£qlock.h
>

28 
	~<löux/muãx.h
>

29 
	~<löux/timî.h
>

30 
	~<löux/vîsi⁄.h
>

31 
	~<löux/waô.h
>

32 
	~<löux/sched/sig«l.h
>

33 
	~<löux/blockgroup_lock.h
>

34 
	~<löux/≥r˝u_cou¡î.h
>

35 
	~<löux/øãlimô.h
>

36 
	~<¸y±o/hash.h
>

37 
	~<löux/ÁŒoc.h
>

38 
	~<löux/≥r˝u-rw£m.h
>

39 #ifde‡
__KERNEL__


40 
	~<löux/com∑t.h
>

43 
	~<löux/fs¸y±.h
>

45 
	~<löux/compûî.h
>

55 
	#AGGRESSIVE_CHECK__


	)

61 
	#DOUBLE_CHECK__


	)

66 #unde‡
PXT4FS_DEBUG


71 #ifde‡
PXT4FS_DEBUG


72 
	#pxt4_debug
(
f
, 
a
...) \

74 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs DEBUG (%s, %d): %s:", \

75 
__FILE__
, 
__LINE__
, 
__func__
); \

76 
	`¥ötk
(
KERN_DEBUG
 
f
, ## 
a
); \

77 } 0)

	)

79 
	#pxt4_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

85 
	#EXT_DEBUG__


	)

86 #ifde‡
EXT_DEBUG


87 
	#ext_debug
(
fmt
, ...Ë
	`¥ötk
(fmt, ##
__VA_ARGS__
)

	)

89 
	#ext_debug
(
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

93 
	tpxt4_gΩblk_t
;

96 
	tpxt4_fsblk_t
;

99 
__u32
 
	tpxt4_lblk_t
;

102 
	tpxt4_group_t
;

104 
	eSHIFT_DIRECTION
 {

105 
	mSHIFT_LEFT
 = 0,

106 
	mSHIFT_RIGHT
,

117 
	#PXT4_MB_HINT_MERGE
 0x0001

	)

119 
	#PXT4_MB_HINT_RESERVED
 0x0002

	)

121 
	#PXT4_MB_HINT_METADATA
 0x0004

	)

123 
	#PXT4_MB_HINT_FIRST
 0x0008

	)

125 
	#PXT4_MB_HINT_BEST
 0x0010

	)

127 
	#PXT4_MB_HINT_DATA
 0x0020

	)

129 
	#PXT4_MB_HINT_NOPREALLOC
 0x0040

	)

131 
	#PXT4_MB_HINT_GROUP_ALLOC
 0x0080

	)

133 
	#PXT4_MB_HINT_GOAL_ONLY
 0x0100

	)

135 
	#PXT4_MB_HINT_TRY_GOAL
 0x0200

	)

137 
	#PXT4_MB_DELALLOC_RESERVED
 0x0400

	)

139 
	#PXT4_MB_STREAM_ALLOC
 0x0800

	)

141 
	#PXT4_MB_USE_ROOT_BLOCKS
 0x1000

	)

143 
	#PXT4_MB_USE_RESERVED
 0x2000

	)

145 
	spxt4_Æloˇti⁄_ªque°
 {

147 
öode
 *
	möode
;

149 
	mÀn
;

151 
pxt4_lblk_t
 
	mlogiˇl
;

153 
pxt4_lblk_t
 
	mŒe·
;

155 
pxt4_lblk_t
 
	mÃight
;

157 
pxt4_fsblk_t
 
	mgﬂl
;

159 
pxt4_fsblk_t
 
	m∂e·
;

161 
pxt4_fsblk_t
 
	m¥ight
;

163 
	mÊags
;

173 
	#PXT4_MAP_NEW
 (1 << 
BH_New
)

	)

174 
	#PXT4_MAP_MAPPED
 (1 << 
BH_M≠≥d
)

	)

175 
	#PXT4_MAP_UNWRITTEN
 (1 << 
BH_Unwrôãn
)

	)

176 
	#PXT4_MAP_BOUNDARY
 (1 << 
BH_Bound¨y
)

	)

177 
	#PXT4_MAP_FLAGS
 (
PXT4_MAP_NEW
 | 
PXT4_MAP_MAPPED
 |\

178 
PXT4_MAP_UNWRITTEN
 | 
PXT4_MAP_BOUNDARY
)

	)

180 
	spxt4_m≠_blocks
 {

181 
pxt4_fsblk_t
 
	mm_pblk
;

182 
pxt4_lblk_t
 
	mm_lblk
;

183 
	mm_Àn
;

184 
	mm_Êags
;

190 
	#PXT4_IO_END_UNWRITTEN
 0x0001

	)

196 
	spxt4_io_íd
 {

197 
li°_hód
 
	mli°
;

198 
h™dÀ_t
 *
	mh™dÀ
;

200 
öode
 *
	möode
;

201 
bio
 *
	mbio
;

203 
	mÊag
;

204 
©omic_t
 
	mcou¡
;

205 
loff_t
 
	moff£t
;

206 
ssize_t
 
	msize
;

207 } 
	tpxt4_io_íd_t
;

209 
	spxt4_io_submô
 {

210 
wrôeback_c⁄åﬁ
 *
	mio_wbc
;

211 
bio
 *
	mio_bio
;

212 
pxt4_io_íd_t
 *
	mio_íd
;

213 
£˘‹_t
 
	mio_√xt_block
;

219 
	#PXT4_BAD_INO
 1

	)

220 
	#PXT4_ROOT_INO
 2

	)

221 
	#PXT4_USR_QUOTA_INO
 3

	)

222 
	#PXT4_GRP_QUOTA_INO
 4

	)

223 
	#PXT4_BOOT_LOADER_INO
 5

	)

224 
	#PXT4_UNDEL_DIR_INO
 6

	)

225 
	#PXT4_RESIZE_INO
 7

	)

226 
	#PXT4_JOURNAL_INO
 8

	)

229 
	#PXT4_GOOD_OLD_FIRST_INO
 11

	)

234 
	#PXT4_LINK_MAX
 65000

	)

239 
	#PXT4_MIN_BLOCK_SIZE
 1024

	)

240 
	#PXT4_MAX_BLOCK_SIZE
 65536

	)

241 
	#PXT4_MIN_BLOCK_LOG_SIZE
 10

	)

242 
	#PXT4_MAX_BLOCK_LOG_SIZE
 16

	)

243 
	#PXT4_MAX_CLUSTER_LOG_SIZE
 30

	)

244 #ifde‡
__KERNEL__


245 
	#PXT4_BLOCK_SIZE
(
s
Ë((s)->
s_blocksize
)

	)

247 
	#PXT4_BLOCK_SIZE
(
s
Ë(
PXT4_MIN_BLOCK_SIZE
 << (s)->
s_log_block_size
)

	)

249 
	#PXT4_ADDR_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ (
__u32
))

	)

250 
	#PXT4_CLUSTER_SIZE
(
s
Ë(
	`PXT4_BLOCK_SIZE
(s) << \

251 
	`PXT4_SB
(
s
)->
s_˛u°î_bôs
)

	)

252 #ifde‡
__KERNEL__


253 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_blocksize_bôs
)

	)

254 
	#PXT4_CLUSTER_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°î_bôs
)

	)

256 
	#PXT4_BLOCK_SIZE_BITS
(
s
Ë((s)->
s_log_block_size
 + 10)

	)

258 #ifde‡
__KERNEL__


259 
	#PXT4_ADDR_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_addr_≥r_block_bôs
)

	)

260 
	#PXT4_INODE_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_öode_size
)

	)

261 
	#PXT4_FIRST_INO
(
s
Ë(
	`PXT4_SB
(s)->
s_fú°_öo
)

	)

263 
	#PXT4_INODE_SIZE
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

264 
PXT4_GOOD_OLD_INODE_SIZE
 : \

265 (
s
)->
s_öode_size
)

	)

266 
	#PXT4_FIRST_INO
(
s
Ë(((s)->
s_ªv_Àvñ
 =
PXT4_GOOD_OLD_REV
) ? \

267 
PXT4_GOOD_OLD_FIRST_INO
 : \

268 (
s
)->
s_fú°_öo
)

	)

270 
	#PXT4_BLOCK_ALIGN
(
size
, 
blkbôs
Ë
	`ALIGN
((size), (1 << (blkbôs)))

	)

271 
	#PXT4_MAX_BLOCKS
(
size
, 
off£t
, 
blkbôs
) \

272 ((
	`PXT4_BLOCK_ALIGN
(
size
 + 
off£t
, 
blkbôs
) >> blkbits) - (offset >> \

273 
blkbôs
))

	)

276 
	#PXT4_B2C
(
sbi
, 
blk
Ë((blkË>> (sbi)->
s_˛u°î_bôs
)

	)

278 
	#PXT4_C2B
(
sbi
, 
˛u°î
Ë((˛u°îË<< (sbi)->
s_˛u°î_bôs
)

	)

280 
	#PXT4_NUM_B2C
(
sbi
, 
blks
Ë(((blksË+ (sbi)->
s_˛u°î_øtio
 - 1) >> \

281 (
sbi
)->
s_˛u°î_bôs
)

	)

283 
	#PXT4_PBLK_CMASK
(
s
, 
pblk
) ((pblk) & \

284 ~((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

285 
	#PXT4_LBLK_CMASK
(
s
, 
lblk
) ((lblk) & \

286 ~((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

288 
	#PXT4_PBLK_COFF
(
s
, 
pblk
) ((pblk) & \

289 ((
pxt4_fsblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

290 
	#PXT4_LBLK_COFF
(
s
, 
lblk
) ((lblk) & \

291 ((
pxt4_lblk_t
Ë(
s
)->
s_˛u°î_øtio
 - 1))

	)

296 
	spxt4_group_desc


298 
__À32
 
	mbg_block_bôm≠_lo
;

299 
__À32
 
	mbg_öode_bôm≠_lo
;

300 
__À32
 
	mbg_öode_èbÀ_lo
;

301 
__À16
 
	mbg_‰ì_blocks_cou¡_lo
;

302 
__À16
 
	mbg_‰ì_öodes_cou¡_lo
;

303 
__À16
 
	mbg_u£d_dús_cou¡_lo
;

304 
__À16
 
	mbg_Êags
;

305 
__À32
 
	mbg_ex˛ude_bôm≠_lo
;

306 
__À16
 
	mbg_block_bôm≠_csum_lo
;

307 
__À16
 
	mbg_öode_bôm≠_csum_lo
;

308 
__À16
 
	mbg_ôabÀ_unu£d_lo
;

309 
__À16
 
	mbg_checksum
;

310 
__À32
 
	mbg_block_bôm≠_hi
;

311 
__À32
 
	mbg_öode_bôm≠_hi
;

312 
__À32
 
	mbg_öode_èbÀ_hi
;

313 
__À16
 
	mbg_‰ì_blocks_cou¡_hi
;

314 
__À16
 
	mbg_‰ì_öodes_cou¡_hi
;

315 
__À16
 
	mbg_u£d_dús_cou¡_hi
;

316 
__À16
 
	mbg_ôabÀ_unu£d_hi
;

317 
__À32
 
	mbg_ex˛ude_bôm≠_hi
;

318 
__À16
 
	mbg_block_bôm≠_csum_hi
;

319 
__À16
 
	mbg_öode_bôm≠_csum_hi
;

320 
__u32
 
	mbg_ª£rved
;

323 
	#PXT4_BG_INODE_BITMAP_CSUM_HI_END
 \

324 (
	`off£tof
(
pxt4_group_desc
, 
bg_öode_bôm≠_csum_hi
) + \

325 (
__À16
))

	)

326 
	#PXT4_BG_BLOCK_BITMAP_CSUM_HI_END
 \

327 (
	`off£tof
(
pxt4_group_desc
, 
bg_block_bôm≠_csum_hi
) + \

328 (
__À16
))

	)

334 
	sÊex_groups
 {

335 
©omic64_t
 
	m‰ì_˛u°îs
;

336 
©omic_t
 
	m‰ì_öodes
;

337 
©omic_t
 
	mu£d_dús
;

340 
	#PXT4_BG_INODE_UNINIT
 0x0001

	)

341 
	#PXT4_BG_BLOCK_UNINIT
 0x0002

	)

342 
	#PXT4_BG_INODE_ZEROED
 0x0004

	)

347 
	#PXT4_MIN_DESC_SIZE
 32

	)

348 
	#PXT4_MIN_DESC_SIZE_64BIT
 64

	)

349 
	#PXT4_MAX_DESC_SIZE
 
PXT4_MIN_BLOCK_SIZE


	)

350 
	#PXT4_DESC_SIZE
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_size
)

	)

351 #ifde‡
__KERNEL__


352 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_blocks_≥r_group
)

	)

353 
	#PXT4_CLUSTERS_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_˛u°îs_≥r_group
)

	)

354 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block
)

	)

355 
	#PXT4_INODES_PER_GROUP
(
s
Ë(
	`PXT4_SB
(s)->
s_öodes_≥r_group
)

	)

356 
	#PXT4_DESC_PER_BLOCK_BITS
(
s
Ë(
	`PXT4_SB
(s)->
s_desc_≥r_block_bôs
)

	)

358 
	#PXT4_BLOCKS_PER_GROUP
(
s
Ë((s)->
s_blocks_≥r_group
)

	)

359 
	#PXT4_DESC_PER_BLOCK
(
s
Ë(
	`PXT4_BLOCK_SIZE
(sË/ 
	`PXT4_DESC_SIZE
(s))

	)

360 
	#PXT4_INODES_PER_GROUP
(
s
Ë((s)->
s_öodes_≥r_group
)

	)

366 
	#PXT4_NDIR_BLOCKS
 12

	)

367 
	#PXT4_IND_BLOCK
 
PXT4_NDIR_BLOCKS


	)

368 
	#PXT4_DIND_BLOCK
 (
PXT4_IND_BLOCK
 + 1)

	)

369 
	#PXT4_TIND_BLOCK
 (
PXT4_DIND_BLOCK
 + 1)

	)

370 
	#PXT4_N_BLOCKS
 (
PXT4_TIND_BLOCK
 + 1)

	)

375 
	#PXT4_SECRM_FL
 0x00000001

	)

376 
	#PXT4_UNRM_FL
 0x00000002

	)

377 
	#PXT4_COMPR_FL
 0x00000004

	)

378 
	#PXT4_SYNC_FL
 0x00000008

	)

379 
	#PXT4_IMMUTABLE_FL
 0x00000010

	)

380 
	#PXT4_APPEND_FL
 0x00000020

	)

381 
	#PXT4_NODUMP_FL
 0x00000040

	)

382 
	#PXT4_NOATIME_FL
 0x00000080

	)

384 
	#PXT4_DIRTY_FL
 0x00000100

	)

385 
	#PXT4_COMPRBLK_FL
 0x00000200

	)

386 
	#PXT4_NOCOMPR_FL
 0x00000400

	)

388 
	#PXT4_ENCRYPT_FL
 0x00000800

	)

390 
	#PXT4_INDEX_FL
 0x00001000

	)

391 
	#PXT4_IMAGIC_FL
 0x00002000

	)

392 
	#PXT4_JOURNAL_DATA_FL
 0x00004000

	)

393 
	#PXT4_NOTAIL_FL
 0x00008000

	)

394 
	#PXT4_DIRSYNC_FL
 0x00010000

	)

395 
	#PXT4_TOPDIR_FL
 0x00020000

	)

396 
	#PXT4_HUGE_FILE_FL
 0x00040000

	)

397 
	#PXT4_EXTENTS_FL
 0x00080000

	)

398 
	#PXT4_EA_INODE_FL
 0x00200000

	)

399 
	#PXT4_EOFBLOCKS_FL
 0x00400000

	)

400 
	#PXT4_INLINE_DATA_FL
 0x10000000

	)

401 
	#PXT4_PROJINHERIT_FL
 0x20000000

	)

402 
	#PXT4_RESERVED_FL
 0x80000000

	)

404 
	#PXT4_FL_USER_VISIBLE
 0x304BDFFF

	)

405 
	#PXT4_FL_USER_MODIFIABLE
 0x204BC0FF

	)

408 
	#PXT4_FL_XFLAG_VISIBLE
 (
PXT4_SYNC_FL
 | \

409 
PXT4_IMMUTABLE_FL
 | \

410 
PXT4_APPEND_FL
 | \

411 
PXT4_NODUMP_FL
 | \

412 
PXT4_NOATIME_FL
 | \

413 
PXT4_PROJINHERIT_FL
)

	)

416 
	#PXT4_FL_INHERITED
 (
PXT4_SECRM_FL
 | 
PXT4_UNRM_FL
 | 
PXT4_COMPR_FL
 |\

417 
PXT4_SYNC_FL
 | 
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
 |\

418 
PXT4_NOCOMPR_FL
 | 
PXT4_JOURNAL_DATA_FL
 |\

419 
PXT4_NOTAIL_FL
 | 
PXT4_DIRSYNC_FL
 |\

420 
PXT4_PROJINHERIT_FL
)

	)

423 
	#PXT4_REG_FLMASK
 (~(
PXT4_DIRSYNC_FL
 | 
PXT4_TOPDIR_FL
))

	)

426 
	#PXT4_OTHER_FLMASK
 (
PXT4_NODUMP_FL
 | 
PXT4_NOATIME_FL
)

	)

429 
	#PXT4_FL_SHOULD_SWAP
 (
PXT4_HUGE_FILE_FL
 | 
PXT4_EXTENTS_FL
)

	)

432 
ölöe
 
__u32
 
	$pxt4_mask_Êags
(
umode_t
 
mode
, 
__u32
 
Êags
)

434 i‡(
	`S_ISDIR
(
mode
))

435  
Êags
;

436 i‡(
	`S_ISREG
(
mode
))

437  
Êags
 & 
PXT4_REG_FLMASK
;

439  
Êags
 & 
PXT4_OTHER_FLMASK
;

440 
	}
}

446 
	mPXT4_INODE_SECRM
 = 0,

447 
	mPXT4_INODE_UNRM
 = 1,

448 
	mPXT4_INODE_COMPR
 = 2,

449 
	mPXT4_INODE_SYNC
 = 3,

450 
	mPXT4_INODE_IMMUTABLE
 = 4,

451 
	mPXT4_INODE_APPEND
 = 5,

452 
	mPXT4_INODE_NODUMP
 = 6,

453 
	mPXT4_INODE_NOATIME
 = 7,

455 
	mPXT4_INODE_DIRTY
 = 8,

456 
	mPXT4_INODE_COMPRBLK
 = 9,

457 
	mPXT4_INODE_NOCOMPR
 = 10,

458 
	mPXT4_INODE_ENCRYPT
 = 11,

460 
	mPXT4_INODE_INDEX
 = 12,

461 
	mPXT4_INODE_IMAGIC
 = 13,

462 
	mPXT4_INODE_JOURNAL_DATA
 = 14,

463 
	mPXT4_INODE_NOTAIL
 = 15,

464 
	mPXT4_INODE_DIRSYNC
 = 16,

465 
	mPXT4_INODE_TOPDIR
 = 17,

466 
	mPXT4_INODE_HUGE_FILE
 = 18,

467 
	mPXT4_INODE_EXTENTS
 = 19,

468 
	mPXT4_INODE_EA_INODE
 = 21,

469 
	mPXT4_INODE_EOFBLOCKS
 = 22,

470 
	mPXT4_INODE_INLINE_DATA
 = 28,

471 
	mPXT4_INODE_PROJINHERIT
 = 29,

472 
	mPXT4_INODE_RESERVED
 = 31,

488 
	#TEST_FLAG_VALUE
(
FLAG
Ë(
PXT4_
##FLAG##
_FL
 =(1 << 
PXT4_INODE_
##FLAG))

	)

489 
	#CHECK_FLAG_VALUE
(
FLAG
Ë
	`BUILD_BUG_ON
(!
	`TEST_FLAG_VALUE
(FLAG))

	)

491 
ölöe
 
	$pxt4_check_Êag_vÆues
()

493 
	`CHECK_FLAG_VALUE
(
SECRM
);

494 
	`CHECK_FLAG_VALUE
(
UNRM
);

495 
	`CHECK_FLAG_VALUE
(
COMPR
);

496 
	`CHECK_FLAG_VALUE
(
SYNC
);

497 
	`CHECK_FLAG_VALUE
(
IMMUTABLE
);

498 
	`CHECK_FLAG_VALUE
(
APPEND
);

499 
	`CHECK_FLAG_VALUE
(
NODUMP
);

500 
	`CHECK_FLAG_VALUE
(
NOATIME
);

501 
	`CHECK_FLAG_VALUE
(
DIRTY
);

502 
	`CHECK_FLAG_VALUE
(
COMPRBLK
);

503 
	`CHECK_FLAG_VALUE
(
NOCOMPR
);

504 
	`CHECK_FLAG_VALUE
(
ENCRYPT
);

505 
	`CHECK_FLAG_VALUE
(
INDEX
);

506 
	`CHECK_FLAG_VALUE
(
IMAGIC
);

507 
	`CHECK_FLAG_VALUE
(
JOURNAL_DATA
);

508 
	`CHECK_FLAG_VALUE
(
NOTAIL
);

509 
	`CHECK_FLAG_VALUE
(
DIRSYNC
);

510 
	`CHECK_FLAG_VALUE
(
TOPDIR
);

511 
	`CHECK_FLAG_VALUE
(
HUGE_FILE
);

512 
	`CHECK_FLAG_VALUE
(
EXTENTS
);

513 
	`CHECK_FLAG_VALUE
(
EA_INODE
);

514 
	`CHECK_FLAG_VALUE
(
EOFBLOCKS
);

515 
	`CHECK_FLAG_VALUE
(
INLINE_DATA
);

516 
	`CHECK_FLAG_VALUE
(
PROJINHERIT
);

517 
	`CHECK_FLAG_VALUE
(
RESERVED
);

518 
	}
}

521 
	spxt4_√w_group_öput
 {

522 
__u32
 
	mgroup
;

523 
__u64
 
	mblock_bôm≠
;

524 
__u64
 
	möode_bôm≠
;

525 
__u64
 
	möode_èbÀ
;

526 
__u32
 
	mblocks_cou¡
;

527 
__u16
 
	mª£rved_blocks
;

528 
__u16
 
	munu£d
;

531 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

532 
	scom∑t_pxt4_√w_group_öput
 {

533 
u32
 
	mgroup
;

534 
com∑t_u64
 
	mblock_bôm≠
;

535 
com∑t_u64
 
	möode_bôm≠
;

536 
com∑t_u64
 
	möode_èbÀ
;

537 
u32
 
	mblocks_cou¡
;

538 
u16
 
	mª£rved_blocks
;

539 
u16
 
	munu£d
;

544 
	spxt4_√w_group_d©a
 {

545 
__u32
 
	mgroup
;

546 
__u64
 
	mblock_bôm≠
;

547 
__u64
 
	möode_bôm≠
;

548 
__u64
 
	möode_èbÀ
;

549 
__u32
 
	mblocks_cou¡
;

550 
__u16
 
	mª£rved_blocks
;

551 
__u16
 
	mmd©a_blocks
;

552 
__u32
 
	m‰ì_˛u°îs_cou¡
;

557 
	mBLOCK_BITMAP
 = 0,

558 
	mINODE_BITMAP
,

559 
	mINODE_TABLE
,

560 
	mGROUP_TABLE_COUNT
,

568 
	#PXT4_GET_BLOCKS_CREATE
 0x0001

	)

570 
	#PXT4_GET_BLOCKS_UNWRIT_EXT
 0x0002

	)

571 
	#PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
 (
PXT4_GET_BLOCKS_UNWRIT_EXT
|\

572 
PXT4_GET_BLOCKS_CREATE
)

	)

575 
	#PXT4_GET_BLOCKS_DELALLOC_RESERVE
 0x0004

	)

579 
	#PXT4_GET_BLOCKS_PRE_IO
 0x0008

	)

580 
	#PXT4_GET_BLOCKS_CONVERT
 0x0010

	)

581 
	#PXT4_GET_BLOCKS_IO_CREATE_EXT
 (
PXT4_GET_BLOCKS_PRE_IO
|\

582 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

584 
	#PXT4_GET_BLOCKS_IO_CONVERT_EXT
 (
PXT4_GET_BLOCKS_CONVERT
|\

585 
PXT4_GET_BLOCKS_CREATE_UNWRIT_EXT
)

	)

588 
	#PXT4_GET_BLOCKS_METADATA_NOFAIL
 0x0020

	)

590 
	#PXT4_GET_BLOCKS_NO_NORMALIZE
 0x0040

	)

592 
	#PXT4_GET_BLOCKS_KEEP_SIZE
 0x0080

	)

594 
	#PXT4_GET_BLOCKS_CONVERT_UNWRITTEN
 0x0100

	)

596 
	#PXT4_GET_BLOCKS_ZERO
 0x0200

	)

597 
	#PXT4_GET_BLOCKS_CREATE_ZERO
 (
PXT4_GET_BLOCKS_CREATE
 |\

598 
PXT4_GET_BLOCKS_ZERO
)

	)

601 
	#PXT4_GET_BLOCKS_IO_SUBMIT
 0x0400

	)

612 
	#PXT4_EX_NOCACHE
 0x40000000

	)

613 
	#PXT4_EX_FORCE_CACHE
 0x20000000

	)

618 
	#PXT4_FREE_BLOCKS_METADATA
 0x0001

	)

619 
	#PXT4_FREE_BLOCKS_FORGET
 0x0002

	)

620 
	#PXT4_FREE_BLOCKS_VALIDATED
 0x0004

	)

621 
	#PXT4_FREE_BLOCKS_NO_QUOT_UPDATE
 0x0008

	)

622 
	#PXT4_FREE_BLOCKS_NOFREE_FIRST_CLUSTER
 0x0010

	)

623 
	#PXT4_FREE_BLOCKS_NOFREE_LAST_CLUSTER
 0x0020

	)

624 
	#PXT4_FREE_BLOCKS_RERESERVE_CLUSTER
 0x0040

	)

629 
	#PXT4_IOC_GETFLAGS
 
FS_IOC_GETFLAGS


	)

630 
	#PXT4_IOC_SETFLAGS
 
FS_IOC_SETFLAGS


	)

631 
	#PXT4_IOC_GETVERSION
 
	`_IOR
('f', 3, )

	)

632 
	#PXT4_IOC_SETVERSION
 
	`_IOW
('f', 4, )

	)

633 
	#PXT4_IOC_GETVERSION_OLD
 
FS_IOC_GETVERSION


	)

634 
	#PXT4_IOC_SETVERSION_OLD
 
FS_IOC_SETVERSION


	)

635 
	#PXT4_IOC_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

636 
	#PXT4_IOC_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

637 
	#PXT4_IOC_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

638 
	#PXT4_IOC_GROUP_ADD
 
	`_IOW
('f', 8, 
pxt4_√w_group_öput
)

	)

639 
	#PXT4_IOC_MIGRATE
 
	`_IO
('f', 9)

	)

642 
	#PXT4_IOC_ALLOC_DA_BLKS
 
	`_IO
('f', 12)

	)

643 
	#PXT4_IOC_MOVE_EXT
 
	`_IOWR
('f', 15, 
move_exã¡
)

	)

644 
	#PXT4_IOC_RESIZE_FS
 
	`_IOW
('f', 16, 
__u64
)

	)

645 
	#PXT4_IOC_SWAP_BOOT
 
	`_IO
('f', 17)

	)

646 
	#PXT4_IOC_PRECACHE_EXTENTS
 
	`_IO
('f', 18)

	)

647 
	#PXT4_IOC_SET_ENCRYPTION_POLICY
 
FS_IOC_SET_ENCRYPTION_POLICY


	)

648 
	#PXT4_IOC_GET_ENCRYPTION_PWSALT
 
FS_IOC_GET_ENCRYPTION_PWSALT


	)

649 
	#PXT4_IOC_GET_ENCRYPTION_POLICY
 
FS_IOC_GET_ENCRYPTION_POLICY


	)

651 
	#PXT4_IOC_FSGETXATTR
 
FS_IOC_FSGETXATTR


	)

652 
	#PXT4_IOC_FSSETXATTR
 
FS_IOC_FSSETXATTR


	)

654 
	#PXT4_IOC_SHUTDOWN
 
	`_IOR
 ('X', 125, 
__u32
)

	)

659 
	#PXT4_GOING_FLAGS_DEFAULT
 0x0

	)

660 
	#PXT4_GOING_FLAGS_LOGFLUSH
 0x1

	)

661 
	#PXT4_GOING_FLAGS_NOLOGFLUSH
 0x2

	)

664 #i‡
deföed
(
__KERNEL__
Ë&& deföed(
CONFIG_COMPAT
)

668 
	#PXT4_IOC32_GETFLAGS
 
FS_IOC32_GETFLAGS


	)

669 
	#PXT4_IOC32_SETFLAGS
 
FS_IOC32_SETFLAGS


	)

670 
	#PXT4_IOC32_GETVERSION
 
	`_IOR
('f', 3, )

	)

671 
	#PXT4_IOC32_SETVERSION
 
	`_IOW
('f', 4, )

	)

672 
	#PXT4_IOC32_GETRSVSZ
 
	`_IOR
('f', 5, )

	)

673 
	#PXT4_IOC32_SETRSVSZ
 
	`_IOW
('f', 6, )

	)

674 
	#PXT4_IOC32_GROUP_EXTEND
 
	`_IOW
('f', 7, )

	)

675 
	#PXT4_IOC32_GROUP_ADD
 
	`_IOW
('f', 8, 
com∑t_pxt4_√w_group_öput
)

	)

676 
	#PXT4_IOC32_GETVERSION_OLD
 
FS_IOC32_GETVERSION


	)

677 
	#PXT4_IOC32_SETVERSION_OLD
 
FS_IOC32_SETVERSION


	)

681 
	#PXT4_MAX_BLOCK_FILE_PHYS
 0xFFFFFFFF

	)

684 
	#PXT4_MAX_LOGICAL_BLOCK
 0xFFFFFFFF

	)

689 
	spxt4_öode
 {

690 
__À16
 
	mi_mode
;

691 
__À16
 
	mi_uid
;

692 
__À32
 
	mi_size_lo
;

693 
__À32
 
	mi_©ime
;

694 
__À32
 
	mi_˘ime
;

695 
__À32
 
	mi_mtime
;

696 
__À32
 
	mi_dtime
;

697 
__À16
 
	mi_gid
;

698 
__À16
 
	mi_löks_cou¡
;

699 
__À32
 
	mi_blocks_lo
;

700 
__À32
 
	mi_Êags
;

703 
__À32
 
	ml_i_vîsi⁄
;

704 } 
	mlöux1
;

706 
__u32
 
	mh_i_å™¶©‹
;

707 } 
	mhurd1
;

709 
__u32
 
	mm_i_ª£rved1
;

710 } 
	mmasix1
;

711 } 
	mosd1
;

712 
__À32
 
	mi_block
[
PXT4_N_BLOCKS
];

713 
__À32
 
	mi_gíî©i⁄
;

714 
__À32
 
	mi_fûe_a˛_lo
;

715 
__À32
 
	mi_size_high
;

716 
__À32
 
	mi_obso_Áddr
;

719 
__À16
 
	ml_i_blocks_high
;

720 
__À16
 
	ml_i_fûe_a˛_high
;

721 
__À16
 
	ml_i_uid_high
;

722 
__À16
 
	ml_i_gid_high
;

723 
__À16
 
	ml_i_checksum_lo
;

724 
__À16
 
	ml_i_ª£rved
;

725 } 
	mlöux2
;

727 
__À16
 
	mh_i_ª£rved1
;

728 
__u16
 
	mh_i_mode_high
;

729 
__u16
 
	mh_i_uid_high
;

730 
__u16
 
	mh_i_gid_high
;

731 
__u32
 
	mh_i_auth‹
;

732 } 
	mhurd2
;

734 
__À16
 
	mh_i_ª£rved1
;

735 
__À16
 
	mm_i_fûe_a˛_high
;

736 
__u32
 
	mm_i_ª£rved2
[2];

737 } 
	mmasix2
;

738 } 
	mosd2
;

739 
__À16
 
	mi_exåa_isize
;

740 
__À16
 
	mi_checksum_hi
;

741 
__À32
 
	mi_˘ime_exåa
;

742 
__À32
 
	mi_mtime_exåa
;

743 
__À32
 
	mi_©ime_exåa
;

744 
__À32
 
	mi_¸time
;

745 
__À32
 
	mi_¸time_exåa
;

746 
__À32
 
	mi_vîsi⁄_hi
;

747 
__À32
 
	mi_¥ojid
;

750 
	smove_exã¡
 {

751 
__u32
 
	mª£rved
;

752 
__u32
 
	md⁄‹_fd
;

753 
__u64
 
	m‹ig_°¨t
;

754 
__u64
 
	md⁄‹_°¨t
;

755 
__u64
 
	mÀn
;

756 
__u64
 
	mmoved_Àn
;

759 
	#PXT4_EPOCH_BITS
 2

	)

760 
	#PXT4_EPOCH_MASK
 ((1 << 
PXT4_EPOCH_BITS
Ë- 1)

	)

761 
	#PXT4_NSEC_MASK
 (~0UL << 
PXT4_EPOCH_BITS
)

	)

773 
	#PXT4_FITS_IN_INODE
(
pxt4_öode
, 
eöode
, 
fõld
) \

774 ((
	`off£tof
(
	`ty≥of
(*
pxt4_öode
), 
fõld
) + \

775 ((
pxt4_öode
)->
fõld
)) \

776 <(
PXT4_GOOD_OLD_INODE_SIZE
 + \

777 (
eöode
)->
i_exåa_isize
)) \

778 

	)

800 
ölöe
 
__À32
 
	$pxt4_ícode_exåa_time
(
time•ec64
 *
time
)

802 
u32
 
exåa
 =((
time
->
tv_£c
 - (
s32
Èime->tv_£cË>> 32Ë& 
PXT4_EPOCH_MASK
;

803  
	`˝u_to_À32
(
exåa
 | (
time
->
tv_n£c
 << 
PXT4_EPOCH_BITS
));

804 
	}
}

806 
ölöe
 
	$pxt4_decode_exåa_time
(
time•ec64
 *
time
,

807 
__À32
 
exåa
)

809 i‡(
	`u∆ikñy
(
exåa
 & 
	`˝u_to_À32
(
PXT4_EPOCH_MASK
))) {

816 
u64
 
exåa_bôs
 = 
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
;

817 i‡(
exåa_bôs
 =3 && ((
time
->
tv_£c
) & 0x80000000) != 0)

818 
exåa_bôs
 = 0;

819 
time
->
tv_£c
 +
exåa_bôs
 << 32;

821 
time
->
tv_£c
 +(
u64
)(
	`À32_to_˝u
(
exåa
Ë& 
PXT4_EPOCH_MASK
) << 32;

824 
time
->
tv_n£c
 = (
	`À32_to_˝u
(
exåa
Ë& 
PXT4_NSEC_MASK
Ë>> 
PXT4_EPOCH_BITS
;

825 
	}
}

827 
	#PXT4_INODE_SET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

829 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
öode
)->xtime.
tv_£c
); \

830 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) {\

831 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

832 
	`pxt4_ícode_exåa_time
(&(
öode
)->
xtime
); \

834 } 0)

	)

836 
	#PXT4_EINODE_SET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

838 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

839 (
øw_öode
)->
xtime
 = 
	`˝u_to_À32
((
eöode
)->xtime.
tv_£c
); \

840 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

841 (
øw_öode
)->
xtime
 ## 
_exåa
 = \

842 
	`pxt4_ícode_exåa_time
(&(
eöode
)->
xtime
); \

843 } 0)

	)

845 
	#PXT4_INODE_GET_XTIME
(
xtime
, 
öode
, 
øw_öode
) \

847 (
öode
)->
xtime
.
tv_£c
 = (sig√d)
	`À32_to_˝u
((
øw_öode
)->xtime); \

848 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
	`PXT4_I
(
öode
), 
xtime
 ## 
_exåa
)) { \

849 
	`pxt4_decode_exåa_time
(&(
öode
)->
xtime
, \

850 
øw_öode
->
xtime
 ## 
_exåa
); \

853 (
öode
)->
xtime
.
tv_n£c
 = 0; \

854 } 0)

	)

857 
	#PXT4_EINODE_GET_XTIME
(
xtime
, 
eöode
, 
øw_öode
) \

859 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
)) \

860 (
eöode
)->
xtime
.
tv_£c
 = \

861 (sig√d)
	`À32_to_˝u
((
øw_öode
)->
xtime
); \

863 (
eöode
)->
xtime
.
tv_£c
 = 0; \

864 i‡(
	`PXT4_FITS_IN_INODE
(
øw_öode
, 
eöode
, 
xtime
 ## 
_exåa
)) \

865 
	`pxt4_decode_exåa_time
(&(
eöode
)->
xtime
, \

866 
øw_öode
->
xtime
 ## 
_exåa
); \

868 (
eöode
)->
xtime
.
tv_n£c
 = 0; \

869 } 0)

	)

871 
	#i_disk_vîsi⁄
 
osd1
.
löux1
.
l_i_vîsi⁄


	)

873 #i‡
deföed
(
__KERNEL__
Ë|| deföed(
__löux__
)

874 
	#i_ª£rved1
 
osd1
.
löux1
.
l_i_ª£rved1


	)

875 
	#i_fûe_a˛_high
 
osd2
.
löux2
.
l_i_fûe_a˛_high


	)

876 
	#i_blocks_high
 
osd2
.
löux2
.
l_i_blocks_high


	)

877 
	#i_uid_low
 
i_uid


	)

878 
	#i_gid_low
 
i_gid


	)

879 
	#i_uid_high
 
osd2
.
löux2
.
l_i_uid_high


	)

880 
	#i_gid_high
 
osd2
.
löux2
.
l_i_gid_high


	)

881 
	#i_checksum_lo
 
osd2
.
löux2
.
l_i_checksum_lo


	)

883 #ñi‡
deföed
(
__GNU__
)

885 
	#i_å™¶©‹
 
osd1
.
hurd1
.
h_i_å™¶©‹


	)

886 
	#i_uid_high
 
osd2
.
hurd2
.
h_i_uid_high


	)

887 
	#i_gid_high
 
osd2
.
hurd2
.
h_i_gid_high


	)

888 
	#i_auth‹
 
osd2
.
hurd2
.
h_i_auth‹


	)

890 #ñi‡
deföed
(
__masix__
)

892 
	#i_ª£rved1
 
osd1
.
masix1
.
m_i_ª£rved1


	)

893 
	#i_fûe_a˛_high
 
osd2
.
masix2
.
m_i_fûe_a˛_high


	)

894 
	#i_ª£rved2
 
osd2
.
masix2
.
m_i_ª£rved2


	)

898 
	~"exã¡s_°©us.h
"

917 
	mI_DATA_SEM_NORMAL
 = 0,

918 
	mI_DATA_SEM_OTHER
,

919 
	mI_DATA_SEM_QUOTA
,

926 
	spxt4_öode_öfo
 {

927 
__À32
 
	mi_d©a
[15];

928 
__u32
 
	mi_dtime
;

929 
pxt4_fsblk_t
 
	mi_fûe_a˛
;

938 
pxt4_group_t
 
	mi_block_group
;

939 
pxt4_lblk_t
 
	mi_dú_°¨t_lookup
;

940 #i‡(
BITS_PER_LONG
 < 64)

941 
	mi_°©e_Êags
;

943 
	mi_Êags
;

952 
rw_£m≠h‹e
 
	mx©å_£m
;

954 
li°_hód
 
	mi_‹ph™
;

971 
loff_t
 
	mi_disksize
;

983 
rw_£m≠h‹e
 
	mi_d©a_£m
;

992 
rw_£m≠h‹e
 
	mi_mm≠_£m
;

993 
öode
 
	mvfs_öode
;

994 
jbd3_öode
 *
	mjöode
;

996 
•ölock_t
 
	mi_øw_lock
;

1002 
time•ec64
 
	mi_¸time
;

1005 
li°_hód
 
	mi_¥óŒoc_li°
;

1006 
•ölock_t
 
	mi_¥óŒoc_lock
;

1009 
pxt4_es_åì
 
	mi_es_åì
;

1010 
rwlock_t
 
	mi_es_lock
;

1011 
li°_hód
 
	mi_es_li°
;

1012 
	mi_es_Æl_ƒ
;

1013 
	mi_es_shk_ƒ
;

1014 
pxt4_lblk_t
 
	mi_es_shrök_lblk
;

1019 
pxt4_group_t
 
	mi_œ°_Æloc_group
;

1023 
	mi_ª£rved_d©a_blocks
;

1024 
pxt4_lblk_t
 
	mi_da_mëad©a_ˇlc_œ°_lblock
;

1025 
	mi_da_mëad©a_ˇlc_Àn
;

1028 
pxt4_≥ndög_åì
 
	mi_≥ndög_åì
;

1031 
__u16
 
	mi_exåa_isize
;

1034 
u16
 
	mi_ölöe_off
;

1035 
u16
 
	mi_ölöe_size
;

1037 #ifde‡
CONFIG_QUOTA


1039 
qsize_t
 
	mi_ª£rved_quŸa
;

1043 
•ölock_t
 
	mi_com∂ëed_io_lock
;

1048 
li°_hód
 
	mi_rsv_c⁄vîsi⁄_li°
;

1049 
w‹k_°ru˘
 
	mi_rsv_c⁄vîsi⁄_w‹k
;

1050 
©omic_t
 
	mi_unwrôãn
;

1052 
•ölock_t
 
	mi_block_ª£rv©i⁄_lock
;

1058 
tid_t
 
	mi_sync_tid
;

1059 
tid_t
 
	mi_d©async_tid
;

1061 #ifde‡
CONFIG_QUOTA


1062 
dquŸ
 *
	mi_dquŸ
[
MAXQUOTAS
];

1066 
__u32
 
	mi_csum_£ed
;

1068 
k¥ojid_t
 
	mi_¥ojid
;

1074 
	#PXT4_VALID_FS
 0x0001

	)

1075 
	#PXT4_ERROR_FS
 0x0002

	)

1076 
	#PXT4_ORPHAN_FS
 0x0004

	)

1081 
	#PXT2_FLAGS_SIGNED_HASH
 0x0001

	)

1082 
	#PXT2_FLAGS_UNSIGNED_HASH
 0x0002

	)

1083 
	#PXT2_FLAGS_TEST_FILESYS
 0x0004

	)

1088 
	#PXT4_MOUNT_NO_MBCACHE
 0x00001

	)

1089 
	#PXT4_MOUNT_GRPID
 0x00004

	)

1090 
	#PXT4_MOUNT_DEBUG
 0x00008

	)

1091 
	#PXT4_MOUNT_ERRORS_CONT
 0x00010

	)

1092 
	#PXT4_MOUNT_ERRORS_RO
 0x00020

	)

1093 
	#PXT4_MOUNT_ERRORS_PANIC
 0x00040

	)

1094 
	#PXT4_MOUNT_ERRORS_MASK
 0x00070

	)

1095 
	#PXT4_MOUNT_MINIX_DF
 0x00080

	)

1096 
	#PXT4_MOUNT_NOLOAD
 0x00100

	)

1097 #ifde‡
CONFIG_FS_DAX


1098 
	#PXT4_MOUNT_DAX
 0x00200

	)

1100 
	#PXT4_MOUNT_DAX
 0

	)

1102 
	#PXT4_MOUNT_DATA_FLAGS
 0x00C00

	)

1103 
	#PXT4_MOUNT_JOURNAL_DATA
 0x00400

	)

1104 
	#PXT4_MOUNT_ORDERED_DATA
 0x00800

	)

1105 
	#PXT4_MOUNT_WRITEBACK_DATA
 0x00C00

	)

1106 
	#PXT4_MOUNT_UPDATE_JOURNAL
 0x01000

	)

1107 
	#PXT4_MOUNT_NO_UID32
 0x02000

	)

1108 
	#PXT4_MOUNT_XATTR_USER
 0x04000

	)

1109 
	#PXT4_MOUNT_POSIX_ACL
 0x08000

	)

1110 
	#PXT4_MOUNT_NO_AUTO_DA_ALLOC
 0x10000

	)

1111 
	#PXT4_MOUNT_BARRIER
 0x20000

	)

1112 
	#PXT4_MOUNT_QUOTA
 0x40000

	)

1113 
	#PXT4_MOUNT_USRQUOTA
 0x80000

	)

1116 
	#PXT4_MOUNT_GRPQUOTA
 0x100000

	)

1119 
	#PXT4_MOUNT_PRJQUOTA
 0x200000

	)

1121 
	#PXT4_MOUNT_DIOREAD_NOLOCK
 0x400000

	)

1122 
	#PXT4_MOUNT_JOURNAL_CHECKSUM
 0x800000

	)

1123 
	#PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 0x1000000

	)

1124 
	#PXT4_MOUNT_WARN_ON_ERROR
 0x2000000

	)

1125 
	#PXT4_MOUNT_DELALLOC
 0x8000000

	)

1126 
	#PXT4_MOUNT_DATA_ERR_ABORT
 0x10000000

	)

1127 
	#PXT4_MOUNT_BLOCK_VALIDITY
 0x20000000

	)

1128 
	#PXT4_MOUNT_DISCARD
 0x40000000

	)

1129 
	#PXT4_MOUNT_INIT_INODE_TABLE
 0x80000000

	)

1136 
	#PXT4_MOUNT2_EXPLICIT_DELALLOC
 0x00000001

	)

1138 
	#PXT4_MOUNT2_STD_GROUP_SIZE
 0x00000002

	)

1141 
	#PXT4_MOUNT2_HURD_COMPAT
 0x00000004

	)

1144 
	#PXT4_MOUNT2_EXPLICIT_JOURNAL_CHECKSUM
 0x00000008

	)

1147 
	#˛ór_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 &= \

1148 ~
PXT4_MOUNT_
##
›t


	)

1149 
	#£t_›t
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t
 |= \

1150 
PXT4_MOUNT_
##
›t


	)

1151 
	#ã°_›t
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t
 & \

1152 
PXT4_MOUNT_
##
›t
)

	)

1154 
	#˛ór_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 &= \

1155 ~
PXT4_MOUNT2_
##
›t


	)

1156 
	#£t_›t2
(
sb
, 
›t
Ë
	`PXT4_SB
(sb)->
s_mou¡_›t2
 |= \

1157 
PXT4_MOUNT2_
##
›t


	)

1158 
	#ã°_›t2
(
sb
, 
›t
Ë(
	`PXT4_SB
(sb)->
s_mou¡_›t2
 & \

1159 
PXT4_MOUNT2_
##
›t
)

	)

1161 
	#pxt4_ã°_™d_£t_bô
 
__ã°_™d_£t_bô_À


	)

1162 
	#pxt4_£t_bô
 
__£t_bô_À


	)

1163 
	#pxt4_£t_bô_©omic
 
pxt2_£t_bô_©omic


	)

1164 
	#pxt4_ã°_™d_˛ór_bô
 
__ã°_™d_˛ór_bô_À


	)

1165 
	#pxt4_˛ór_bô
 
__˛ór_bô_À


	)

1166 
	#pxt4_˛ór_bô_©omic
 
pxt2_˛ór_bô_©omic


	)

1167 
	#pxt4_ã°_bô
 
ã°_bô_À


	)

1168 
	#pxt4_föd_√xt_zîo_bô
 
föd_√xt_zîo_bô_À


	)

1169 
	#pxt4_föd_√xt_bô
 
föd_√xt_bô_À


	)

1171 
pxt4_£t_bôs
(*
bm
, 
cur
, 
Àn
);

1176 
	#PXT4_DFL_MAX_MNT_COUNT
 20

	)

1177 
	#PXT4_DFL_CHECKINTERVAL
 0

	)

1182 
	#PXT4_ERRORS_CONTINUE
 1

	)

1183 
	#PXT4_ERRORS_RO
 2

	)

1184 
	#PXT4_ERRORS_PANIC
 3

	)

1185 
	#PXT4_ERRORS_DEFAULT
 
PXT4_ERRORS_CONTINUE


	)

1188 
	#PXT4_CRC32C_CHKSUM
 1

	)

1193 
	spxt4_su≥r_block
 {

1194  
__À32
 
	ms_öodes_cou¡
;

1195 
__À32
 
	ms_blocks_cou¡_lo
;

1196 
__À32
 
	ms_r_blocks_cou¡_lo
;

1197 
__À32
 
	ms_‰ì_blocks_cou¡_lo
;

1198  
__À32
 
	ms_‰ì_öodes_cou¡
;

1199 
__À32
 
	ms_fú°_d©a_block
;

1200 
__À32
 
	ms_log_block_size
;

1201 
__À32
 
	ms_log_˛u°î_size
;

1202  
__À32
 
	ms_blocks_≥r_group
;

1203 
__À32
 
	ms_˛u°îs_≥r_group
;

1204 
__À32
 
	ms_öodes_≥r_group
;

1205 
__À32
 
	ms_mtime
;

1206  
__À32
 
	ms_wtime
;

1207 
__À16
 
	ms_m¡_cou¡
;

1208 
__À16
 
	ms_max_m¡_cou¡
;

1209 
__À16
 
	ms_magic
;

1210 
__À16
 
	ms_°©e
;

1211 
__À16
 
	ms_îr‹s
;

1212 
__À16
 
	ms_mö‹_ªv_Àvñ
;

1213  
__À32
 
	ms_œ°check
;

1214 
__À32
 
	ms_checköãrvÆ
;

1215 
__À32
 
	ms_¸ót‹_os
;

1216 
__À32
 
	ms_ªv_Àvñ
;

1217  
__À16
 
	ms_def_ªsuid
;

1218 
__À16
 
	ms_def_ªsgid
;

1232 
__À32
 
	ms_fú°_öo
;

1233 
__À16
 
	ms_öode_size
;

1234 
__À16
 
	ms_block_group_ƒ
;

1235 
__À32
 
	ms_„©uª_com∑t
;

1236  
__À32
 
	ms_„©uª_öcom∑t
;

1237 
__À32
 
	ms_„©uª_ro_com∑t
;

1238  
__u8
 
	ms_uuid
[16];

1239  
	ms_vﬁume_«me
[16];

1240  
	ms_œ°_mou¡ed
[64] 
	m__n⁄°rög
;

1241  
__À32
 
	ms_Æg‹ôhm_ußge_bôm≠
;

1246 
__u8
 
	ms_¥óŒoc_blocks
;

1247 
__u8
 
	ms_¥óŒoc_dú_blocks
;

1248 
__À16
 
	ms_ª£rved_gdt_blocks
;

1252  
__u8
 
	ms_jou∫Æ_uuid
[16];

1253  
__À32
 
	ms_jou∫Æ_öum
;

1254 
__À32
 
	ms_jou∫Æ_dev
;

1255 
__À32
 
	ms_œ°_‹ph™
;

1256 
__À32
 
	ms_hash_£ed
[4];

1257 
__u8
 
	ms_def_hash_vîsi⁄
;

1258 
__u8
 
	ms_j∆_backup_ty≥
;

1259 
__À16
 
	ms_desc_size
;

1260  
__À32
 
	ms_deÁu…_mou¡_›ts
;

1261 
__À32
 
	ms_fú°_mëa_bg
;

1262 
__À32
 
	ms_mkfs_time
;

1263 
__À32
 
	ms_j∆_blocks
[17];

1265  
__À32
 
	ms_blocks_cou¡_hi
;

1266 
__À32
 
	ms_r_blocks_cou¡_hi
;

1267 
__À32
 
	ms_‰ì_blocks_cou¡_hi
;

1268 
__À16
 
	ms_mö_exåa_isize
;

1269 
__À16
 
	ms_w™t_exåa_isize
;

1270 
__À32
 
	ms_Êags
;

1271 
__À16
 
	ms_øid_°ride
;

1272 
__À16
 
	ms_mmp_upd©e_öãrvÆ
;

1273 
__À64
 
	ms_mmp_block
;

1274 
__À32
 
	ms_øid_°rùe_width
;

1275 
__u8
 
	ms_log_groups_≥r_Êex
;

1276 
__u8
 
	ms_checksum_ty≥
;

1277 
__u8
 
	ms_í¸y±i⁄_Àvñ
;

1278 
__u8
 
	ms_ª£rved_∑d
;

1279 
__À64
 
	ms_kbyãs_wrôãn
;

1280 
__À32
 
	ms_¢≠shŸ_öum
;

1281 
__À32
 
	ms_¢≠shŸ_id
;

1282 
__À64
 
	ms_¢≠shŸ_r_blocks_cou¡
;

1284 
__À32
 
	ms_¢≠shŸ_li°
;

1286 
	#PXT4_S_ERR_START
 
	`off£tof
(
pxt4_su≥r_block
, 
s_îr‹_cou¡
)

	)

1287 
__À32
 
	ms_îr‹_cou¡
;

1288 
__À32
 
	ms_fú°_îr‹_time
;

1289 
__À32
 
	ms_fú°_îr‹_öo
;

1290 
__À64
 
	ms_fú°_îr‹_block
;

1291 
__u8
 
	ms_fú°_îr‹_func
[32] 
	m__n⁄°rög
;

1292 
__À32
 
	ms_fú°_îr‹_löe
;

1293 
__À32
 
	ms_œ°_îr‹_time
;

1294 
__À32
 
	ms_œ°_îr‹_öo
;

1295 
__À32
 
	ms_œ°_îr‹_löe
;

1296 
__À64
 
	ms_œ°_îr‹_block
;

1297 
__u8
 
	ms_œ°_îr‹_func
[32] 
	m__n⁄°rög
;

1298 
	#PXT4_S_ERR_END
 
	`off£tof
(
pxt4_su≥r_block
, 
s_mou¡_›ts
)

	)

1299 
__u8
 
	ms_mou¡_›ts
[64];

1300 
__À32
 
	ms_u§_quŸa_öum
;

1301 
__À32
 
	ms_gΩ_quŸa_öum
;

1302 
__À32
 
	ms_ovîhód_˛u°îs
;

1303 
__À32
 
	ms_backup_bgs
[2];

1304 
__u8
 
	ms_í¸y±_Ægos
[4];

1305 
__u8
 
	ms_í¸y±_pw_ß…
[16];

1306 
__À32
 
	ms_Õf_öo
;

1307 
__À32
 
	ms_¥j_quŸa_öum
;

1308 
__À32
 
	ms_checksum_£ed
;

1309 
__u8
 
	ms_wtime_hi
;

1310 
__u8
 
	ms_mtime_hi
;

1311 
__u8
 
	ms_mkfs_time_hi
;

1312 
__u8
 
	ms_œ°check_hi
;

1313 
__u8
 
	ms_fú°_îr‹_time_hi
;

1314 
__u8
 
	ms_œ°_îr‹_time_hi
;

1315 
__u8
 
	ms_∑d
[2];

1316 
__À32
 
	ms_ª£rved
[96];

1317 
__À32
 
	ms_checksum
;

1320 
	#PXT4_S_ERR_LEN
 (
PXT4_S_ERR_END
 - 
PXT4_S_ERR_START
)

	)

1322 #ifde‡
__KERNEL__


1327 
	#PXT4_MF_MNTDIR_SAMPLED
 0x0001

	)

1328 
	#PXT4_MF_FS_ABORTED
 0x0002

	)

1329 
	#PXT4_MF_TEST_DUMMY_ENCRYPTION
 0x0004

	)

1331 #ifde‡
CONFIG_FS_ENCRYPTION


1332 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(
	`u∆ikñy
((sbi)->
s_mou¡_Êags
 & \

1333 
PXT4_MF_TEST_DUMMY_ENCRYPTION
))

	)

1335 
	#DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë(0)

	)

1339 
	#PXT4_MAXQUOTAS
 3

	)

1344 
	spxt4_sb_öfo
 {

1345 
	ms_desc_size
;

1346 
	ms_öodes_≥r_block
;

1347 
	ms_blocks_≥r_group
;

1348 
	ms_˛u°îs_≥r_group
;

1349 
	ms_öodes_≥r_group
;

1350 
	ms_ôb_≥r_group
;

1351 
	ms_gdb_cou¡
;

1352 
	ms_desc_≥r_block
;

1353 
pxt4_group_t
 
	ms_groups_cou¡
;

1354 
pxt4_group_t
 
	ms_blockfûe_groups
;

1355 
	ms_ovîhód
;

1356 
	ms_˛u°î_øtio
;

1357 
	ms_˛u°î_bôs
;

1358 
loff_t
 
	ms_bôm≠_maxbyãs
;

1359 
buf„r_hód
 * 
	ms_sbh
;

1360 
pxt4_su≥r_block
 *
	ms_es
;

1361 
buf„r_hód
 **
	ms_group_desc
;

1362 
	ms_mou¡_›t
;

1363 
	ms_mou¡_›t2
;

1364 
	ms_mou¡_Êags
;

1365 
	ms_def_mou¡_›t
;

1366 
pxt4_fsblk_t
 
	ms_sb_block
;

1367 
©omic64_t
 
	ms_ªsv_˛u°îs
;

1368 
kuid_t
 
	ms_ªsuid
;

1369 
kgid_t
 
	ms_ªsgid
;

1370 
	ms_mou¡_°©e
;

1371 
	ms_∑d
;

1372 
	ms_addr_≥r_block_bôs
;

1373 
	ms_desc_≥r_block_bôs
;

1374 
	ms_öode_size
;

1375 
	ms_fú°_öo
;

1376 
	ms_öode_ªadahód_blks
;

1377 
	ms_öode_gﬂl
;

1378 
u32
 
	ms_hash_£ed
[4];

1379 
	ms_def_hash_vîsi⁄
;

1380 
	ms_hash_unsig√d
;

1381 
≥r˝u_cou¡î
 
	ms_‰ì˛u°îs_cou¡î
;

1382 
≥r˝u_cou¡î
 
	ms_‰ìöodes_cou¡î
;

1383 
≥r˝u_cou¡î
 
	ms_dús_cou¡î
;

1384 
≥r˝u_cou¡î
 
	ms_dúty˛u°îs_cou¡î
;

1385 
blockgroup_lock
 *
	ms_blockgroup_lock
;

1386 
¥oc_dú_íåy
 *
	ms_¥oc
;

1387 
kobje˘
 
	ms_kobj
;

1388 
com∂ëi⁄
 
	ms_kobj_uƒegi°î
;

1389 
su≥r_block
 *
	ms_sb
;

1392 
jou∫Æ_s
 *
	ms_jou∫Æ
;

1393 
li°_hód
 
	ms_‹ph™
;

1394 
muãx
 
	ms_‹ph™_lock
;

1395 
	ms_pxt4_Êags
;

1396 
	ms_commô_öãrvÆ
;

1397 
u32
 
	ms_max_b©ch_time
;

1398 
u32
 
	ms_mö_b©ch_time
;

1399 
block_devi˚
 *
	mjou∫Æ_bdev
;

1400 #ifde‡
CONFIG_QUOTA


1402 
__rcu
 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

1403 
	ms_jquŸa_fmt
;

1405 
	ms_w™t_exåa_isize
;

1406 
rb_roŸ
 
	msy°em_blks
;

1408 #ifde‡
EXTENTS_STATS


1410 
	ms_ext_mö
;

1411 
	ms_ext_max
;

1412 
	ms_dïth_max
;

1413 
•ölock_t
 
	ms_ext_°©s_lock
;

1414 
	ms_ext_blocks
;

1415 
	ms_ext_exã¡s
;

1419 
pxt4_group_öfo
 ***
	ms_group_öfo
;

1420 
öode
 *
	ms_buddy_ˇche
;

1421 
•ölock_t
 
	ms_md_lock
;

1422 *
	ms_mb_off£ts
;

1423 *
	ms_mb_maxs
;

1424 
	ms_group_öfo_size
;

1425 
	ms_mb_‰ì_≥ndög
;

1426 
li°_hód
 
	ms_‰ìd_d©a_li°
;

1430 
	ms_°rùe
;

1431 
	ms_mb_°ªam_ªque°
;

1432 
	ms_mb_max_to_sˇn
;

1433 
	ms_mb_mö_to_sˇn
;

1434 
	ms_mb_°©s
;

1435 
	ms_mb_‹dî2_ªqs
;

1436 
	ms_mb_group_¥óŒoc
;

1437 
	ms_max_dú_size_kb
;

1439 
	ms_mb_œ°_group
;

1440 
	ms_mb_œ°_°¨t
;

1443 
©omic_t
 
	ms_bÆ_ªqs
;

1444 
©omic_t
 
	ms_bÆ_suc˚ss
;

1445 
©omic_t
 
	ms_bÆ_Æloˇãd
;

1446 
©omic_t
 
	ms_bÆ_ex_sˇ¬ed
;

1447 
©omic_t
 
	ms_bÆ_gﬂls
;

1448 
©omic_t
 
	ms_bÆ_bªaks
;

1449 
©omic_t
 
	ms_bÆ_2‹dîs
;

1450 
•ölock_t
 
	ms_bÆ_lock
;

1451 
	ms_mb_buddõs_gíî©ed
;

1452 
	ms_mb_gíî©i⁄_time
;

1453 
©omic_t
 
	ms_mb_lo°_chunks
;

1454 
©omic_t
 
	ms_mb_¥óŒoˇãd
;

1455 
©omic_t
 
	ms_mb_disˇrded
;

1456 
©omic_t
 
	ms_lock_busy
;

1459 
pxt4_loˇlôy_group
 
__≥r˝u
 *
	ms_loˇlôy_groups
;

1462 
	ms_£˘‹s_wrôãn_°¨t
;

1463 
u64
 
	ms_kbyãs_wrôãn
;

1466 
	ms_exã¡_max_zîoout_kb
;

1468 
	ms_log_groups_≥r_Êex
;

1469 
Êex_groups
 *
	ms_Êex_groups
;

1470 
pxt4_group_t
 
	ms_Êex_groups_Æloˇãd
;

1473 
w‹kqueue_°ru˘
 *
	mrsv_c⁄vîsi⁄_wq
;

1476 
timî_li°
 
	ms_îr_ªp‹t
;

1479 
pxt4_li_ªque°
 *
	ms_li_ªque°
;

1481 
	ms_li_waô_mu…
;

1484 
èsk_°ru˘
 *
	ms_mmp_tsk
;

1487 
©omic_t
 
	ms_œ°_åim_möblks
;

1490 
¸y±o_shash
 *
	ms_chksum_drivî
;

1493 
__u32
 
	ms_csum_£ed
;

1496 
shrökî
 
	ms_es_shrökî
;

1497 
li°_hód
 
	ms_es_li°
;

1498 
	ms_es_ƒ_öode
;

1499 
pxt4_es_°©s
 
	ms_es_°©s
;

1500 
mb_ˇche
 *
	ms_ó_block_ˇche
;

1501 
mb_ˇche
 *
	ms_ó_öode_ˇche
;

1502 
•ölock_t
 
s_es_lock
 
	m____ˇchñöe_Æig√d_ö_smp
;

1505 
øãlimô_°©e
 
	ms_îr_øãlimô_°©e
;

1506 
øãlimô_°©e
 
	ms_w¨nög_øãlimô_°©e
;

1507 
øãlimô_°©e
 
	ms_msg_øãlimô_°©e
;

1510 
≥r˝u_rw_£m≠h‹e
 
	ms_jou∫Æ_Êag_rw£m
;

1511 
dax_devi˚
 *
	ms_daxdev
;

1514 
ölöe
 
pxt4_sb_öfo
 *
	$PXT4_SB
(
su≥r_block
 *
sb
)

1516  
sb
->
s_fs_öfo
;

1517 
	}
}

1518 
ölöe
 
pxt4_öode_öfo
 *
	$PXT4_I
(
öode
 *inode)

1520  
	`c⁄èöî_of
(
öode
, 
pxt4_öode_öfo
, 
vfs_öode
);

1521 
	}
}

1523 
ölöe
 
	$pxt4_vÆid_öum
(
su≥r_block
 *
sb
, 
öo
)

1525  
öo
 =
PXT4_ROOT_INO
 ||

1526 (
öo
 >
	`PXT4_FIRST_INO
(
sb
) &&

1527 
öo
 <
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_öodes_cou¡
));

1528 
	}
}

1534 
	mPXT4_STATE_JDATA
,

1535 
	mPXT4_STATE_NEW
,

1536 
	mPXT4_STATE_XATTR
,

1537 
	mPXT4_STATE_NO_EXPAND
,

1538 
	mPXT4_STATE_DA_ALLOC_CLOSE
,

1539 
	mPXT4_STATE_EXT_MIGRATE
,

1540 
	mPXT4_STATE_DIO_UNWRITTEN
,

1541 
	mPXT4_STATE_NEWENTRY
,

1542 
	mPXT4_STATE_MAY_INLINE_DATA
,

1543 
	mPXT4_STATE_EXT_PRECACHED
,

1544 
	mPXT4_STATE_LUSTRE_EA_INODE
,

1547 
	#PXT4_INODE_BIT_FNS
(
«me
, 
fõld
, 
off£t
) \

1548 
ölöe
 
pxt4_ã°_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1550  
	`ã°_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1552 
ölöe
 
pxt4_£t_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1554 
	`£t_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1556 
ölöe
 
pxt4_˛ór_öode_
##
	`«me
(
öode
 *öode, 
bô
) \

1558 
	`˛ór_bô
(
bô
 + (
off£t
), &
	`PXT4_I
(
öode
)->
i_
##
fõld
); \

1559 }

	)

1563 
ölöe
 
pxt4_ã°_öode_Êag
(
öode
 *öode, 
bô
);

1564 
ölöe
 
pxt4_£t_öode_Êag
(
öode
 *öode, 
bô
);

1565 
ölöe
 
pxt4_˛ór_öode_Êag
(
öode
 *öode, 
bô
);

1566 
	$PXT4_INODE_BIT_FNS
(
Êag
, 
Êags
, 0)

1570 
ölöe
 
	`pxt4_ã°_öode_°©e
(
öode
 *öode, 
bô
);

1571 
ölöe
 
	`pxt4_£t_öode_°©e
(
öode
 *öode, 
bô
);

1572 
ölöe
 
	`pxt4_˛ór_öode_°©e
(
öode
 *öode, 
bô
);

1573 #i‡(
BITS_PER_LONG
 < 64)

1574 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
°©e_Êags
, 0)

1576 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1578 (
ei
)->
i_°©e_Êags
 = 0;

1579 
	}
}

1581 
	$PXT4_INODE_BIT_FNS
(
°©e
, 
Êags
, 32)

1583 
ölöe
 
	$pxt4_˛ór_°©e_Êags
(
pxt4_öode_öfo
 *
ei
)

1586 
	}
}

1592 
	#PXT4_SB
(
sb
Ë(sb)

	)

1598 
	#NEXT_ORPHAN
(
öode
Ë
	`PXT4_I
(öode)->
i_dtime


	)

1603 
	#PXT4_OS_LINUX
 0

	)

1604 
	#PXT4_OS_HURD
 1

	)

1605 
	#PXT4_OS_MASIX
 2

	)

1606 
	#PXT4_OS_FREEBSD
 3

	)

1607 
	#PXT4_OS_LITES
 4

	)

1612 
	#PXT4_GOOD_OLD_REV
 0

	)

1613 
	#PXT4_DYNAMIC_REV
 1

	)

1615 
	#PXT4_CURRENT_REV
 
PXT4_GOOD_OLD_REV


	)

1616 
	#PXT4_MAX_SUPP_REV
 
PXT4_DYNAMIC_REV


	)

1618 
	#PXT4_GOOD_OLD_INODE_SIZE
 128

	)

1624 
	#PXT4_FEATURE_COMPAT_DIR_PREALLOC
 0x0001

	)

1625 
	#PXT4_FEATURE_COMPAT_IMAGIC_INODES
 0x0002

	)

1626 
	#PXT4_FEATURE_COMPAT_HAS_JOURNAL
 0x0004

	)

1627 
	#PXT4_FEATURE_COMPAT_EXT_ATTR
 0x0008

	)

1628 
	#PXT4_FEATURE_COMPAT_RESIZE_INODE
 0x0010

	)

1629 
	#PXT4_FEATURE_COMPAT_DIR_INDEX
 0x0020

	)

1630 
	#PXT4_FEATURE_COMPAT_SPARSE_SUPER2
 0x0200

	)

1632 
	#PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
 0x0001

	)

1633 
	#PXT4_FEATURE_RO_COMPAT_LARGE_FILE
 0x0002

	)

1634 
	#PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 0x0004

	)

1635 
	#PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 0x0008

	)

1636 
	#PXT4_FEATURE_RO_COMPAT_GDT_CSUM
 0x0010

	)

1637 
	#PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 0x0020

	)

1638 
	#PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 0x0040

	)

1639 
	#PXT4_FEATURE_RO_COMPAT_QUOTA
 0x0100

	)

1640 
	#PXT4_FEATURE_RO_COMPAT_BIGALLOC
 0x0200

	)

1647 
	#PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
 0x0400

	)

1648 
	#PXT4_FEATURE_RO_COMPAT_READONLY
 0x1000

	)

1649 
	#PXT4_FEATURE_RO_COMPAT_PROJECT
 0x2000

	)

1651 
	#PXT4_FEATURE_INCOMPAT_COMPRESSION
 0x0001

	)

1652 
	#PXT4_FEATURE_INCOMPAT_FILETYPE
 0x0002

	)

1653 
	#PXT4_FEATURE_INCOMPAT_RECOVER
 0x0004

	)

1654 
	#PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
 0x0008

	)

1655 
	#PXT4_FEATURE_INCOMPAT_META_BG
 0x0010

	)

1656 
	#PXT4_FEATURE_INCOMPAT_EXTENTS
 0x0040

	)

1657 
	#PXT4_FEATURE_INCOMPAT_64BIT
 0x0080

	)

1658 
	#PXT4_FEATURE_INCOMPAT_MMP
 0x0100

	)

1659 
	#PXT4_FEATURE_INCOMPAT_FLEX_BG
 0x0200

	)

1660 
	#PXT4_FEATURE_INCOMPAT_EA_INODE
 0x0400

	)

1661 
	#PXT4_FEATURE_INCOMPAT_DIRDATA
 0x1000

	)

1662 
	#PXT4_FEATURE_INCOMPAT_CSUM_SEED
 0x2000

	)

1663 
	#PXT4_FEATURE_INCOMPAT_LARGEDIR
 0x4000

	)

1664 
	#PXT4_FEATURE_INCOMPAT_INLINE_DATA
 0x8000

	)

1665 
	#PXT4_FEATURE_INCOMPAT_ENCRYPT
 0x10000

	)

1667 
pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
);

1669 
	#PXT4_FEATURE_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1670 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1672  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1673 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
)) != 0); \

1675 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1677 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1678 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 |= \

1679 
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1681 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1683 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 &= \

1684 ~
	`˝u_to_À32
(
PXT4_FEATURE_COMPAT_
##
Êag«me
); \

1685 }

	)

1687 
	#PXT4_FEATURE_RO_COMPAT_FUNCS
(
«me
, 
Êag«me
) \

1688 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1690  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1691 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
)) != 0); \

1693 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1695 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1696 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 |= \

1697 
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1699 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1701 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 &= \

1702 ~
	`˝u_to_À32
(
PXT4_FEATURE_RO_COMPAT_
##
Êag«me
); \

1703 }

	)

1705 
	#PXT4_FEATURE_INCOMPAT_FUNCS
(
«me
, 
Êag«me
) \

1706 
ölöe
 
boﬁ
 
pxt4_has_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1708  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1709 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
)) != 0); \

1711 
ölöe
 
pxt4_£t_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1713 
	`pxt4_upd©e_dy«mic_ªv
(
sb
); \

1714 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 |= \

1715 
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1717 
ölöe
 
pxt4_˛ór_„©uª_
##
	`«me
(
su≥r_block
 *
sb
) \

1719 
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 &= \

1720 ~
	`˝u_to_À32
(
PXT4_FEATURE_INCOMPAT_
##
Êag«me
); \

1721 }

	)

1723 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_¥óŒoc
, 
DIR_PREALLOC
)

1724 
	$PXT4_FEATURE_COMPAT_FUNCS
(
imagic_öodes
, 
IMAGIC_INODES
)

1725 
	$PXT4_FEATURE_COMPAT_FUNCS
(
jou∫Æ
, 
HAS_JOURNAL
)

1726 
	$PXT4_FEATURE_COMPAT_FUNCS
(
x©å
, 
EXT_ATTR
)

1727 
	$PXT4_FEATURE_COMPAT_FUNCS
(
ªsize_öode
, 
RESIZE_INODE
)

1728 
	$PXT4_FEATURE_COMPAT_FUNCS
(
dú_ödex
, 
DIR_INDEX
)

1729 
	$PXT4_FEATURE_COMPAT_FUNCS
(
•¨£_su≥r2
, 
SPARSE_SUPER2
)

1731 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
•¨£_su≥r
, 
SPARSE_SUPER
)

1732 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
œrge_fûe
, 
LARGE_FILE
)

1733 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
båì_dú
, 
BTREE_DIR
)

1734 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
huge_fûe
, 
HUGE_FILE
)

1735 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
gdt_csum
, 
GDT_CSUM
)

1736 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
dú_∆ök
, 
DIR_NLINK
)

1737 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
exåa_isize
, 
EXTRA_ISIZE
)

1738 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
quŸa
, 
QUOTA
)

1739 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
bigÆloc
, 
BIGALLOC
)

1740 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
mëad©a_csum
, 
METADATA_CSUM
)

1741 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
ªad⁄ly
, 
READONLY
)

1742 
	$PXT4_FEATURE_RO_COMPAT_FUNCS
(
¥oje˘
, 
PROJECT
)

1744 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
com¥essi⁄
, 
COMPRESSION
)

1745 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
fûëy≥
, 
FILETYPE
)

1746 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_√eds_ªcovîy
, 
RECOVER
)

1747 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
jou∫Æ_dev
, 
JOURNAL_DEV
)

1748 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mëa_bg
, 
META_BG
)

1749 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
exã¡s
, 
EXTENTS
)

1750 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(64b
ô
, 64B
IT
)

1751 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
mmp
, 
MMP
)

1752 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
Êex_bg
, 
FLEX_BG
)

1753 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ó_öode
, 
EA_INODE
)

1754 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
dúd©a
, 
DIRDATA
)

1755 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
csum_£ed
, 
CSUM_SEED
)

1756 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
œrgedú
, 
LARGEDIR
)

1757 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
ölöe_d©a
, 
INLINE_DATA
)

1758 
	$PXT4_FEATURE_INCOMPAT_FUNCS
(
í¸y±
, 
ENCRYPT
)

1760 
	#PXT2_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1761 
	#PXT2_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1762 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1763 
	#PXT2_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1764 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1765 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1767 
	#PXT3_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1768 
	#PXT3_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1769 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1770 
PXT4_FEATURE_INCOMPAT_META_BG
)

	)

1771 
	#PXT3_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1772 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1773 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
)

	)

1775 
	#PXT4_FEATURE_COMPAT_SUPP
 
PXT4_FEATURE_COMPAT_EXT_ATTR


	)

1776 
	#PXT4_FEATURE_INCOMPAT_SUPP
 (
PXT4_FEATURE_INCOMPAT_FILETYPE
| \

1777 
PXT4_FEATURE_INCOMPAT_RECOVER
| \

1778 
PXT4_FEATURE_INCOMPAT_META_BG
| \

1779 
PXT4_FEATURE_INCOMPAT_EXTENTS
| \

1780 
PXT4_FEATURE_INCOMPAT_64BIT
| \

1781 
PXT4_FEATURE_INCOMPAT_FLEX_BG
| \

1782 
PXT4_FEATURE_INCOMPAT_EA_INODE
| \

1783 
PXT4_FEATURE_INCOMPAT_MMP
 | \

1784 
PXT4_FEATURE_INCOMPAT_INLINE_DATA
 | \

1785 
PXT4_FEATURE_INCOMPAT_ENCRYPT
 | \

1786 
PXT4_FEATURE_INCOMPAT_CSUM_SEED
 | \

1787 
PXT4_FEATURE_INCOMPAT_LARGEDIR
)

	)

1788 
	#PXT4_FEATURE_RO_COMPAT_SUPP
 (
PXT4_FEATURE_RO_COMPAT_SPARSE_SUPER
| \

1789 
PXT4_FEATURE_RO_COMPAT_LARGE_FILE
| \

1790 
PXT4_FEATURE_RO_COMPAT_GDT_CSUM
| \

1791 
PXT4_FEATURE_RO_COMPAT_DIR_NLINK
 | \

1792 
PXT4_FEATURE_RO_COMPAT_EXTRA_ISIZE
 | \

1793 
PXT4_FEATURE_RO_COMPAT_BTREE_DIR
 |\

1794 
PXT4_FEATURE_RO_COMPAT_HUGE_FILE
 |\

1795 
PXT4_FEATURE_RO_COMPAT_BIGALLOC
 |\

1796 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
|\

1797 
PXT4_FEATURE_RO_COMPAT_QUOTA
 |\

1798 
PXT4_FEATURE_RO_COMPAT_PROJECT
)

	)

1800 
	#EXTN_FEATURE_FUNCS
(
vî
) \

1801 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1803  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 & \

1804 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_COMPAT_SUPP
)) != 0); \

1805 
	}
} \

1806 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
) \

1808  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 & \

1809 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_RO_COMPAT_SUPP
)) != 0); \

1811 
ölöe
 
boﬁ
 
pxt4_has_unknown_ext
##
vî
##
	`_öcom∑t_„©uªs
(
su≥r_block
 *
sb
) \

1813  ((
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 & \

1814 
	`˝u_to_À32
(~
PXT
##
vî
##
_FEATURE_INCOMPAT_SUPP
)) != 0); \

1815 }

	)

1817 
	$EXTN_FEATURE_FUNCS
(2)

1818 
	$EXTN_FEATURE_FUNCS
(3)

1819 
	$EXTN_FEATURE_FUNCS
(4)

1821 
ölöe
 
boﬁ
 
	$pxt4_has_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1823  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_com∑t
 != 0);

1824 
	}
}

1825 
ölöe
 
boﬁ
 
	$pxt4_has_ro_com∑t_„©uªs
(
su≥r_block
 *
sb
)

1827  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
 != 0);

1828 
	}
}

1829 
ölöe
 
boﬁ
 
	$pxt4_has_öcom∑t_„©uªs
(
su≥r_block
 *
sb
)

1831  (
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
 != 0);

1832 
	}
}

1837 
	#PXT4_FLAGS_RESIZING
 0

	)

1838 
	#PXT4_FLAGS_SHUTDOWN
 1

	)

1840 
ölöe
 
	$pxt4_f‹˚d_shutdown
(
pxt4_sb_öfo
 *
sbi
)

1842  
	`ã°_bô
(
PXT4_FLAGS_SHUTDOWN
, &
sbi
->
s_pxt4_Êags
);

1843 
	}
}

1849 
	#PXT4_DEF_RESUID
 0

	)

1850 
	#PXT4_DEF_RESGID
 0

	)

1855 
	#PXT4_DEF_PROJID
 0

	)

1857 
	#PXT4_DEF_INODE_READAHEAD_BLKS
 32

	)

1862 
	#PXT4_DEFM_DEBUG
 0x0001

	)

1863 
	#PXT4_DEFM_BSDGROUPS
 0x0002

	)

1864 
	#PXT4_DEFM_XATTR_USER
 0x0004

	)

1865 
	#PXT4_DEFM_ACL
 0x0008

	)

1866 
	#PXT4_DEFM_UID16
 0x0010

	)

1867 
	#PXT4_DEFM_JMODE
 0x0060

	)

1868 
	#PXT4_DEFM_JMODE_DATA
 0x0020

	)

1869 
	#PXT4_DEFM_JMODE_ORDERED
 0x0040

	)

1870 
	#PXT4_DEFM_JMODE_WBACK
 0x0060

	)

1871 
	#PXT4_DEFM_NOBARRIER
 0x0100

	)

1872 
	#PXT4_DEFM_BLOCK_VALIDITY
 0x0200

	)

1873 
	#PXT4_DEFM_DISCARD
 0x0400

	)

1874 
	#PXT4_DEFM_NODELALLOC
 0x0800

	)

1879 
	#PXT4_DEF_MIN_BATCH_TIME
 0

	)

1880 
	#PXT4_DEF_MAX_BATCH_TIME
 15000

	)

1886 
	#PXT4_FLEX_SIZE_DIR_ALLOC_SCHEME
 4

	)

1891 
	#PXT4_NAME_LEN
 255

	)

1893 
	spxt4_dú_íåy
 {

1894 
__À32
 
	möode
;

1895 
__À16
 
	mªc_Àn
;

1896 
__À16
 
	m«me_Àn
;

1897 
	m«me
[
PXT4_NAME_LEN
];

1906 
	spxt4_dú_íåy_2
 {

1907 
__À32
 
	möode
;

1908 
__À16
 
	mªc_Àn
;

1909 
__u8
 
	m«me_Àn
;

1910 
__u8
 
	mfûe_ty≥
;

1911 
	m«me
[
PXT4_NAME_LEN
];

1918 
	spxt4_dú_íåy_èû
 {

1919 
__À32
 
	mdë_ª£rved_zîo1
;

1920 
__À16
 
	mdë_ªc_Àn
;

1921 
__u8
 
	mdë_ª£rved_zîo2
;

1922 
__u8
 
	mdë_ª£rved_·
;

1923 
__À32
 
	mdë_checksum
;

1926 
	#PXT4_DIRENT_TAIL
(
block
, 
blocksize
) \

1927 ((
pxt4_dú_íåy_èû
 *)(((*)(
block
)) + \

1928 ((
blocksize
) - \

1929 (
pxt4_dú_íåy_èû
))))

	)

1935 
	#PXT4_FT_UNKNOWN
 0

	)

1936 
	#PXT4_FT_REG_FILE
 1

	)

1937 
	#PXT4_FT_DIR
 2

	)

1938 
	#PXT4_FT_CHRDEV
 3

	)

1939 
	#PXT4_FT_BLKDEV
 4

	)

1940 
	#PXT4_FT_FIFO
 5

	)

1941 
	#PXT4_FT_SOCK
 6

	)

1942 
	#PXT4_FT_SYMLINK
 7

	)

1944 
	#PXT4_FT_MAX
 8

	)

1946 
	#PXT4_FT_DIR_CSUM
 0xDE

	)

1953 
	#PXT4_DIR_PAD
 4

	)

1954 
	#PXT4_DIR_ROUND
 (
PXT4_DIR_PAD
 - 1)

	)

1955 
	#PXT4_DIR_REC_LEN
(
«me_Àn
Ë((“ame_ÀnË+ 8 + 
PXT4_DIR_ROUND
) & \

1956 ~
PXT4_DIR_ROUND
)

	)

1957 
	#PXT4_MAX_REC_LEN
 ((1<<16)-1)

	)

1963 
ölöe
 

1964 
	$pxt4_ªc_Àn_‰om_disk
(
__À16
 
dÀn
, 
blocksize
)

1966 
Àn
 = 
	`À16_to_˝u
(
dÀn
);

1968 #i‡(
PAGE_SIZE
 >= 65536)

1969 i‡(
Àn
 =
PXT4_MAX_REC_LEN
 ||Üen == 0)

1970  
blocksize
;

1971  (
Àn
 & 65532) | ((len & 3) << 16);

1973  
Àn
;

1975 
	}
}

1977 
ölöe
 
__À16
 
	$pxt4_ªc_Àn_to_disk
(
Àn
, 
blocksize
)

1979 i‡((
Àn
 > 
blocksize
) || (blocksize > (1 << 18)) || (len & 3))

1980 
	`BUG
();

1981 #i‡(
PAGE_SIZE
 >= 65536)

1982 i‡(
Àn
 < 65536)

1983  
	`˝u_to_À16
(
Àn
);

1984 i‡(
Àn
 =
blocksize
) {

1985 i‡(
blocksize
 == 65536)

1986  
	`˝u_to_À16
(
PXT4_MAX_REC_LEN
);

1988  
	`˝u_to_À16
(0);

1990  
	`˝u_to_À16
((
Àn
 & 65532) | ((len >> 16) & 3));

1992  
	`˝u_to_À16
(
Àn
);

1994 
	}
}

2001 
	#is_dx
(
dú
Ë(
	`pxt4_has_„©uª_dú_ödex
((dú)->
i_sb
) && \

2002 
	`pxt4_ã°_öode_Êag
((
dú
), 
PXT4_INODE_INDEX
))

	)

2003 
	#PXT4_DIR_LINK_MAX
(
dú
Ë
	`u∆ikñy
((dú)->
i_∆ök
 >
PXT4_LINK_MAX
 && \

2004 !(
	`pxt4_has_„©uª_dú_∆ök
((
dú
)->
i_sb
Ë&& 
	`is_dx
(dú)))

	)

2005 
	#PXT4_DIR_LINK_EMPTY
(
dú
Ë((dú)->
i_∆ök
 =2 || (dú)->i_∆ök =1)

	)

2009 
	#DX_HASH_LEGACY
 0

	)

2010 
	#DX_HASH_HALF_MD4
 1

	)

2011 
	#DX_HASH_TEA
 2

	)

2012 
	#DX_HASH_LEGACY_UNSIGNED
 3

	)

2013 
	#DX_HASH_HALF_MD4_UNSIGNED
 4

	)

2014 
	#DX_HASH_TEA_UNSIGNED
 5

	)

2016 
ölöe
 
u32
 
	$pxt4_chksum
(
pxt4_sb_öfo
 *
sbi
, 
u32
 
¸c
,

2017 c⁄° *
addªss
, 
Àngth
)

2020 
shash_desc
 
shash
;

2021 
˘x
[4];

2022 } 
desc
;

2024 
	`BUG_ON
(
	`¸y±o_shash_descsize
(
sbi
->
s_chksum_drivî
)!=(
desc
.
˘x
));

2026 
desc
.
shash
.
tfm
 = 
sbi
->
s_chksum_drivî
;

2027 
desc
.
shash
.
Êags
 = 0;

2028 *(
u32
 *)
desc
.
˘x
 = 
¸c
;

2030 
	`BUG_ON
(
	`¸y±o_shash_upd©e
(&
desc
.
shash
, 
addªss
, 
Àngth
));

2032  *(
u32
 *)
desc
.
˘x
;

2033 
	}
}

2035 #ifde‡
__KERNEL__


2038 
	sdx_hash_öfo


2040 
u32
 
	mhash
;

2041 
u32
 
	mmö‹_hash
;

2042 
	mhash_vîsi⁄
;

2043 
u32
 *
	m£ed
;

2048 
	#PXT4_HTREE_EOF_32BIT
 ((1UL << (32 - 1)Ë- 1)

	)

2049 
	#PXT4_HTREE_EOF_64BIT
 ((1ULL << (64 - 1)Ë- 1)

	)

2055 
	#HASH_NB_ALWAYS
 1

	)

2057 
	spxt4_fûíame
 {

2058 c⁄° 
q°r
 *
	mu§_‚ame
;

2059 
fs¸y±_°r
 
	mdisk_«me
;

2060 
dx_hash_öfo
 
	mhöfo
;

2061 #ifde‡
CONFIG_FS_ENCRYPTION


2062 
fs¸y±_°r
 
	m¸y±o_buf
;

2066 
	#‚ame_«me
(
p
Ë(’)->
disk_«me
.
«me
)

	)

2067 
	#‚ame_Àn
(
p
Ë(’)->
disk_«me
.
Àn
)

	)

2072 
	spxt4_ûoc


2074 
buf„r_hód
 *
	mbh
;

2075 
	moff£t
;

2076 
pxt4_group_t
 
	mblock_group
;

2079 
ölöe
 
pxt4_öode
 *
	$pxt4_øw_öode
(
pxt4_ûoc
 *
ûoc
)

2081  (
pxt4_öode
 *Ë(
ûoc
->
bh
->
b_d©a
 + iloc->
off£t
);

2082 
	}
}

2084 
ölöe
 
boﬁ
 
	$pxt4_is_quŸa_fûe
(
öode
 *inode)

2086  
	`IS_NOQUOTA
(
öode
) &&

2087 !(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
);

2088 
	}
}

2095 
	sdú_¥iv©e_öfo
 {

2096 
rb_roŸ
 
	mroŸ
;

2097 
rb_node
 *
	mcuº_node
;

2098 
‚ame
 *
	mexåa_‚ame
;

2099 
loff_t
 
	mœ°_pos
;

2100 
__u32
 
	mcuº_hash
;

2101 
__u32
 
	mcuº_mö‹_hash
;

2102 
__u32
 
	m√xt_hash
;

2106 
ölöe
 
pxt4_fsblk_t


2107 
	$pxt4_group_fú°_block_no
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group_no
)

2109  
group_no
 * (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

2110 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
);

2111 
	}
}

2116 
	#ERR_BAD_DX_DIR
 (-(
MAX_ERRNO
 - 1))

	)

2119 
	#PXT4_HTREE_LEVEL_COMPAT
 2

	)

2120 
	#PXT4_HTREE_LEVEL
 3

	)

2122 
ölöe
 
	$pxt4_dú_håì_Àvñ
(
su≥r_block
 *
sb
)

2124  
	`pxt4_has_„©uª_œrgedú
(
sb
) ?

2125 
PXT4_HTREE_LEVEL
 : 
PXT4_HTREE_LEVEL_COMPAT
;

2126 
	}
}

2131 
	#PXT4_DEF_LI_WAIT_MULT
 10

	)

2132 
	#PXT4_DEF_LI_MAX_START_DELAY
 5

	)

2133 
	#PXT4_LAZYINIT_QUIT
 0x0001

	)

2134 
	#PXT4_LAZYINIT_RUNNING
 0x0002

	)

2139 
	spxt4_œzy_öô
 {

2140 
	mli_°©e
;

2141 
li°_hód
 
	mli_ªque°_li°
;

2142 
muãx
 
	mli_li°_mtx
;

2145 
	spxt4_li_ªque°
 {

2146 
su≥r_block
 *
	mÃ_su≥r
;

2147 
pxt4_sb_öfo
 *
	mÃ_sbi
;

2148 
pxt4_group_t
 
	mÃ_√xt_group
;

2149 
li°_hód
 
	mÃ_ªque°
;

2150 
	mÃ_√xt_sched
;

2151 
	mÃ_timeout
;

2154 
	spxt4_„©uªs
 {

2155 
kobje˘
 
	mf_kobj
;

2156 
com∂ëi⁄
 
	mf_kobj_uƒegi°î
;

2166 
	#PXT4_MMP_MAGIC
 0x004D4D50U

	)

2167 
	#PXT4_MMP_SEQ_CLEAN
 0xFF4D4D50U

	)

2168 
	#PXT4_MMP_SEQ_FSCK
 0xE24D4D50U

	)

2169 
	#PXT4_MMP_SEQ_MAX
 0xE24D4D4FU

	)

2171 
	smmp_°ru˘
 {

2172 
__À32
 
	mmmp_magic
;

2173 
__À32
 
	mmmp_£q
;

2179 
__À64
 
	mmmp_time
;

2180 
	mmmp_nodíame
[64];

2181 
	mmmp_bdev«me
[32];

2188 
__À16
 
	mmmp_check_öãrvÆ
;

2190 
__À16
 
	mmmp_∑d1
;

2191 
__À32
 
	mmmp_∑d2
[226];

2192 
__À32
 
	mmmp_checksum
;

2196 
	smmpd_d©a
 {

2197 
buf„r_hód
 *
	mbh
;

2198 
su≥r_block
 *
	msb
;

2209 
	#PXT4_MMP_CHECK_MULT
 2UL

	)

2214 
	#PXT4_MMP_MIN_CHECK_INTERVAL
 5UL

	)

2219 
	#PXT4_MMP_MAX_CHECK_INTERVAL
 300UL

	)

2229 
	#NORET_TYPE


	)

2230 
	#ATTRIB_NORET
 
	`__©åibuã__
((
n‹ëu∫
))

	)

2231 
	#NORET_AND
 
n‹ëu∫
,

	)

2234 
pxt4_cou¡_‰ì
(*
bôm≠
, 
numch¨s
);

2235 
pxt4_öode_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2236 
pxt4_group_desc
 *
gdp
,

2237 
buf„r_hód
 *
bh
, 
sz
);

2238 
pxt4_öode_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2239 
pxt4_group_desc
 *
gdp
,

2240 
buf„r_hód
 *
bh
, 
sz
);

2241 
pxt4_block_bôm≠_csum_£t
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2242 
pxt4_group_desc
 *
gdp
,

2243 
buf„r_hód
 *
bh
);

2244 
pxt4_block_bôm≠_csum_vîify
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
,

2245 
pxt4_group_desc
 *
gdp
,

2246 
buf„r_hód
 *
bh
);

2249 
pxt4_gë_group_no_™d_off£t
(
su≥r_block
 *
sb
,

2250 
pxt4_fsblk_t
 
blockƒ
,

2251 
pxt4_group_t
 *
blockgΩp
,

2252 
pxt4_gΩblk_t
 *
off£ç
);

2253 
pxt4_group_t
 
pxt4_gë_group_numbî
(
su≥r_block
 *
sb
,

2254 
pxt4_fsblk_t
 
block
);

2256 
pxt4_block_group
(
su≥r_block
 *
sb
,

2257 
pxt4_fsblk_t
 
blockƒ
);

2258 
pxt4_gΩblk_t
 
pxt4_block_group_off£t
(
su≥r_block
 *
sb
,

2259 
pxt4_fsblk_t
 
blockƒ
);

2260 
pxt4_bg_has_su≥r
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
);

2261 
pxt4_bg_num_gdb
(
su≥r_block
 *
sb
,

2262 
pxt4_group_t
 
group
);

2263 
pxt4_fsblk_t
 
pxt4_√w_mëa_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2264 
pxt4_fsblk_t
 
gﬂl
,

2265 
Êags
,

2266 *
cou¡
,

2267 *
îΩ
);

2268 
pxt4_˛aim_‰ì_˛u°îs
(
pxt4_sb_öfo
 *
sbi
,

2269 
s64
 
n˛u°îs
, 
Êags
);

2270 
pxt4_fsblk_t
 
pxt4_cou¡_‰ì_˛u°îs
(
su≥r_block
 *);

2271 
pxt4_check_blocks_bôm≠
(
su≥r_block
 *);

2272 
pxt4_group_desc
 * 
pxt4_gë_group_desc
(
su≥r_block
 * 
sb
,

2273 
pxt4_group_t
 
block_group
,

2274 
buf„r_hód
 ** 
bh
);

2275 
pxt4_should_ªåy_Æloc
(
su≥r_block
 *
sb
, *
ªåõs
);

2277 
buf„r_hód
 *
pxt4_ªad_block_bôm≠_nowaô
(
su≥r_block
 *
sb
,

2278 
pxt4_group_t
 
block_group
);

2279 
pxt4_waô_block_bôm≠
(
su≥r_block
 *
sb
,

2280 
pxt4_group_t
 
block_group
,

2281 
buf„r_hód
 *
bh
);

2282 
buf„r_hód
 *
pxt4_ªad_block_bôm≠
(
su≥r_block
 *
sb
,

2283 
pxt4_group_t
 
block_group
);

2284 
pxt4_‰ì_˛u°îs_a·î_öô
(
su≥r_block
 *
sb
,

2285 
pxt4_group_t
 
block_group
,

2286 
pxt4_group_desc
 *
gdp
);

2287 
pxt4_fsblk_t
 
pxt4_öode_to_gﬂl_block
(
öode
 *);

2289 #ifde‡
CONFIG_FS_ENCRYPTION


2290 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2291 c⁄° 
q°r
 *
öame
,

2292 
lookup
, 
pxt4_fûíame
 *
‚ame
)

2294 
fs¸y±_«me
 
«me
;

2295 
îr
;

2297 
	`mem£t
(
‚ame
, 0, (
pxt4_fûíame
));

2299 
îr
 = 
	`fs¸y±_£tup_fûíame
(
dú
, 
öame
, 
lookup
, &
«me
);

2301 
‚ame
->
u§_‚ame
 = 
«me
.usr_fname;

2302 
‚ame
->
disk_«me
 = 
«me
.disk_name;

2303 
‚ame
->
höfo
.
hash
 = 
«me
.hash;

2304 
‚ame
->
höfo
.
mö‹_hash
 = 
«me
.minor_hash;

2305 
‚ame
->
¸y±o_buf
 = 
«me
.crypto_buf;

2306  
îr
;

2307 
	}
}

2309 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
)

2311 
fs¸y±_«me
 
«me
;

2313 
«me
.
¸y±o_buf
 = 
‚ame
->crypto_buf;

2314 
	`fs¸y±_‰ì_fûíame
(&
«me
);

2316 
‚ame
->
¸y±o_buf
.
«me
 = 
NULL
;

2317 
‚ame
->
u§_‚ame
 = 
NULL
;

2318 
‚ame
->
disk_«me
.
«me
 = 
NULL
;

2319 
	}
}

2321 
ölöe
 
	$pxt4_‚ame_£tup_fûíame
(
öode
 *
dú
,

2322 c⁄° 
q°r
 *
öame
,

2323 
lookup
, 
pxt4_fûíame
 *
‚ame
)

2325 
‚ame
->
u§_‚ame
 = 
öame
;

2326 
‚ame
->
disk_«me
.
«me
 = (*Ë
öame
->name;

2327 
‚ame
->
disk_«me
.
Àn
 = 
öame
->len;

2329 
	}
}

2330 
ölöe
 
	$pxt4_‚ame_‰ì_fûíame
(
pxt4_fûíame
 *
‚ame
Ë{ 
	}
}

2335 
__pxt4_check_dú_íåy
(c⁄° *, , 
öode
 *,

2336 
fûe
 *,

2337 
pxt4_dú_íåy_2
 *,

2338 
buf„r_hód
 *, *, ,

2340 
	#pxt4_check_dú_íåy
(
dú
, 
fûp
, 
de
, 
bh
, 
buf
, 
size
, 
off£t
) \

2341 
	`u∆ikñy
(
	`__pxt4_check_dú_íåy
(
__func__
, 
__LINE__
, (
dú
), (
fûp
), \

2342 (
de
), (
bh
), (
buf
), (
size
), (
off£t
)))

	)

2343 
pxt4_håì_°‹e_dúít
(
fûe
 *
dú_fûe
, 
__u32
 
hash
,

2344 
__u32
 
mö‹_hash
,

2345 
pxt4_dú_íåy_2
 *
dúít
,

2346 
fs¸y±_°r
 *
ít_«me
);

2347 
pxt4_håì_‰ì_dú_öfo
(
dú_¥iv©e_öfo
 *
p
);

2348 
pxt4_föd_de°_de
(
öode
 *
dú
, inode *inode,

2349 
buf„r_hód
 *
bh
,

2350 *
buf
, 
buf_size
,

2351 
pxt4_fûíame
 *
‚ame
,

2352 
pxt4_dú_íåy_2
 **
de°_de
);

2353 
pxt4_ö£π_díåy
(
öode
 *inode,

2354 
pxt4_dú_íåy_2
 *
de
,

2355 
buf_size
,

2356 
pxt4_fûíame
 *
‚ame
);

2357 
ölöe
 
	$pxt4_upd©e_dx_Êag
(
öode
 *inode)

2359 i‡(!
	`pxt4_has_„©uª_dú_ödex
(
öode
->
i_sb
))

2360 
	`pxt4_˛ór_öode_Êag
(
öode
, 
PXT4_INODE_INDEX
);

2361 
	}
}

2362 c⁄° 
	gpxt4_fûëy≥_èbÀ
[] = {

2363 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


2366 
ölöe
 
	$gë_dty≥
(
su≥r_block
 *
sb
, 
fûëy≥
)

2368 i‡(!
	`pxt4_has_„©uª_fûëy≥
(
sb
Ë|| 
fûëy≥
 >
PXT4_FT_MAX
)

2369  
DT_UNKNOWN
;

2371  
pxt4_fûëy≥_èbÀ
[
fûëy≥
];

2372 
	}
}

2373 
pxt4_check_Æl_de
(
öode
 *
dú
, 
buf„r_hód
 *
bh
,

2374 *
buf
, 
buf_size
);

2377 
pxt4_sync_fûe
(
fûe
 *, 
loff_t
,Üoff_t, );

2380 
pxt4fs_dúhash
(c⁄° *
«me
, 
Àn
, 

2381 
dx_hash_öfo
 *
höfo
);

2384 
öode
 *
__pxt4_√w_öode
(
h™dÀ_t
 *, öodê*, 
umode_t
,

2385 c⁄° 
q°r
 *q°r, 
__u32
 
gﬂl
,

2386 
uid_t
 *
ow√r
, 
__u32
 
i_Êags
,

2387 
h™dÀ_ty≥
, 
löe_no
,

2388 
nblocks
);

2390 
	#pxt4_√w_öode
(
h™dÀ
, 
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, 
i_Êags
) \

2391 
	`__pxt4_√w_öode
((
h™dÀ
), (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2392 
i_Êags
, 0, 0, 0)

	)

2393 
	#pxt4_√w_öode_°¨t_h™dÀ
(
dú
, 
mode
, 
q°r
, 
gﬂl
, 
ow√r
, \

2394 
ty≥
, 
nblocks
) \

2395 
	`__pxt4_√w_öode
(
NULL
, (
dú
), (
mode
), (
q°r
), (
gﬂl
), (
ow√r
), \

2396 0, (
ty≥
), 
__LINE__
, (
nblocks
))

	)

2399 
pxt4_‰ì_öode
(
h™dÀ_t
 *, 
öode
 *);

2400 
öode
 * 
pxt4_‹ph™_gë
(
su≥r_block
 *, );

2401 
pxt4_cou¡_‰ì_öodes
(
su≥r_block
 *);

2402 
pxt4_cou¡_dús
(
su≥r_block
 *);

2403 
pxt4_check_öodes_bôm≠
(
su≥r_block
 *);

2404 
pxt4_m¨k_bôm≠_íd
(
°¨t_bô
, 
íd_bô
, *
bôm≠
);

2405 
pxt4_öô_öode_èbÀ
(
su≥r_block
 *
sb
,

2406 
pxt4_group_t
 
group
, 
b¨rõr
);

2407 
pxt4_íd_bôm≠_ªad
(
buf„r_hód
 *
bh
, 
u±od©e
);

2410 c⁄° 
£q_›î©i⁄s
 
pxt4_mb_£q_groups_›s
;

2411 
pxt4_mb_°©s
;

2412 
pxt4_mb_max_to_sˇn
;

2413 
pxt4_mb_öô
(
su≥r_block
 *);

2414 
pxt4_mb_ªÀa£
(
su≥r_block
 *);

2415 
pxt4_fsblk_t
 
pxt4_mb_√w_blocks
(
h™dÀ_t
 *,

2416 
pxt4_Æloˇti⁄_ªque°
 *, *);

2417 
pxt4_mb_ª£rve_blocks
(
su≥r_block
 *, );

2418 
pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
 *);

2419 
__öô
 
pxt4_öô_mbÆloc
();

2420 
pxt4_exô_mbÆloc
();

2421 
pxt4_‰ì_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2422 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
block
,

2423 
cou¡
, 
Êags
);

2424 
pxt4_mb_Æloc_groupöfo
(
su≥r_block
 *
sb
,

2425 
pxt4_group_t
 
ngroups
);

2426 
pxt4_mb_add_groupöfo
(
su≥r_block
 *
sb
,

2427 
pxt4_group_t
 
i
, 
pxt4_group_desc
 *
desc
);

2428 
pxt4_group_add_blocks
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2429 
pxt4_fsblk_t
 
block
, 
cou¡
);

2430 
pxt4_åim_fs
(
su≥r_block
 *, 
f°rim_ønge
 *);

2431 
pxt4_¥o˚ss_‰ìd_d©a
(
su≥r_block
 *
sb
, 
tid_t
 
commô_tid
);

2434 
pxt4_öode_is_Á°_symlök
(
öode
 *inode);

2435 
buf„r_hód
 *
pxt4_gëblk
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2436 
buf„r_hód
 *
pxt4_bªad
(
h™dÀ_t
 *, 
öode
 *, 
pxt4_lblk_t
, );

2437 
pxt4_bªad_b©ch
(
öode
 *öode, 
pxt4_lblk_t
 
block
, 
bh_cou¡
,

2438 
boﬁ
 
waô
, 
buf„r_hód
 **
bhs
);

2439 
pxt4_gë_block_unwrôãn
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2440 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2441 
pxt4_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2442 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2443 
pxt4_dio_gë_block
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2444 
buf„r_hód
 *
bh_ªsu…
, 
¸óã
);

2445 
pxt4_da_gë_block_¥ï
(
öode
 *öode, 
£˘‹_t
 
iblock
,

2446 
buf„r_hód
 *
bh
, 
¸óã
);

2447 
pxt4_wÆk_∑ge_buf„rs
(
h™dÀ_t
 *
h™dÀ
,

2448 
buf„r_hód
 *
hód
,

2449 
‰om
,

2450 
to
,

2451 *
∑πül
,

2452 (*
‚
)(
h™dÀ_t
 *
h™dÀ
,

2453 
buf„r_hód
 *
bh
));

2454 
	`do_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ_t
 *
h™dÀ
,

2455 
buf„r_hód
 *
bh
);

2456 
	#FALL_BACK_TO_NONDELALLOC
 1

	)

2457 
	#CONVERT_INLINE_DATA
 2

	)

2460 
PXT4_IGET_NORMAL
 = 0,

2461 
PXT4_IGET_SPECIAL
 = 0x0001,

2462 
PXT4_IGET_HANDLE
 = 0x0002

2463 } 
	tpxt4_igë_Êags
;

2465 
öode
 *
	`__pxt4_igë
(
su≥r_block
 *
sb
, 
öo
,

2466 
pxt4_igë_Êags
 
Êags
, c⁄° *
fun˘i⁄
,

2467 
löe
);

2469 
	#pxt4_igë
(
sb
, 
öo
, 
Êags
) \

2470 
	`__pxt4_igë
((
sb
), (
öo
), (
Êags
), 
__func__
, 
__LINE__
)

	)

2472 
	`pxt4_wrôe_öode
(
öode
 *, 
wrôeback_c⁄åﬁ
 *);

2473 
	`pxt4_£èâr
(
díåy
 *, 
üâr
 *);

2474 
	`pxt4_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2475 
	`pxt4_evi˘_öode
(
öode
 *);

2476 
	`pxt4_˛ór_öode
(
öode
 *);

2477 
	`pxt4_fûe_gë©å
(c⁄° 
∑th
 *, 
k°©
 *, 
u32
, );

2478 
	`pxt4_sync_öode
(
h™dÀ_t
 *, 
öode
 *);

2479 
	`pxt4_dúty_öode
(
öode
 *, );

2480 
	`pxt4_ch™ge_öode_jou∫Æ_Êag
(
öode
 *, );

2481 
	`pxt4_gë_öode_loc
(
öode
 *, 
pxt4_ûoc
 *);

2482 
	`pxt4_öode_©èch_jöode
(
öode
 *inode);

2483 
	`pxt4_ˇn_åunˇã
(
öode
 *inode);

2484 
	`pxt4_åunˇã
(
öode
 *);

2485 
	`pxt4_bªak_œyouts
(
öode
 *);

2486 
	`pxt4_punch_hﬁe
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àngth
);

2487 
	`pxt4_åunˇã_ª°¨t_å™s
(
h™dÀ_t
 *, 
öode
 *, 
nblocks
);

2488 
	`pxt4_£t_öode_Êags
(
öode
 *);

2489 
	`pxt4_Æloc_da_blocks
(
öode
 *inode);

2490 
	`pxt4_£t_a›s
(
öode
 *inode);

2491 
	`pxt4_wrôïage_å™s_blocks
(
öode
 *);

2492 
	`pxt4_chunk_å™s_blocks
(
öode
 *, 
ƒblocks
);

2493 
	`pxt4_zîo_∑πül_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2494 
loff_t
 
l°¨t
,Üoff_à
Ànd
);

2495 
vm_Áu…_t
 
	`pxt4_∑ge_mkwrôe
(
vm_Áu…
 *
vmf
);

2496 
vm_Áu…_t
 
	`pxt4_fûem≠_Áu…
(
vm_Áu…
 *
vmf
);

2497 
qsize_t
 *
	`pxt4_gë_ª£rved_•a˚
(
öode
 *inode);

2498 
	`pxt4_gë_¥ojid
(
öode
 *öode, 
k¥ojid_t
 *
¥ojid
);

2499 
	`pxt4_da_ªÀa£_•a˚
(
öode
 *öode, 
to_‰ì
);

2500 
	`pxt4_da_upd©e_ª£rve_•a˚
(
öode
 *inode,

2501 
u£d
, 
quŸa_˛aim
);

2502 
	`pxt4_issue_zîoout
(
öode
 *öode, 
pxt4_lblk_t
 
lblk
,

2503 
pxt4_fsblk_t
 
pblk
, 
pxt4_lblk_t
 
Àn
);

2506 
	`pxt4_öd_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2507 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

2508 
	`pxt4_öd_ˇlc_mëad©a_amou¡
(
öode
 *öode, 
£˘‹_t
 
lblock
);

2509 
	`pxt4_öd_å™s_blocks
(
öode
 *öode, 
ƒblocks
);

2510 
	`pxt4_öd_åunˇã
(
h™dÀ_t
 *, 
öode
 *inode);

2511 
	`pxt4_öd_ªmove_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2512 
pxt4_lblk_t
 
°¨t
,Öxt4_lblk_à
íd
);

2515 
	`pxt4_io˘l
(
fûe
 *, , );

2516 
	`pxt4_com∑t_io˘l
(
fûe
 *, , );

2519 
	`pxt4_ext_migøã
(
öode
 *);

2520 
	`pxt4_öd_migøã
(
öode
 *inode);

2523 
	`pxt4_dúít_csum_vîify
(
öode
 *inode,

2524 
pxt4_dú_íåy
 *
dúít
);

2525 
	`pxt4_‹ph™_add
(
h™dÀ_t
 *, 
öode
 *);

2526 
	`pxt4_‹ph™_dñ
(
h™dÀ_t
 *, 
öode
 *);

2527 
	`pxt4_håì_fûl_åì
(
fûe
 *
dú_fûe
, 
__u32
 
°¨t_hash
,

2528 
__u32
 
°¨t_mö‹_hash
, __u32 *
√xt_hash
);

2529 
	`pxt4_£¨ch_dú
(
buf„r_hód
 *
bh
,

2530 *
£¨ch_buf
,

2531 
buf_size
,

2532 
öode
 *
dú
,

2533 
pxt4_fûíame
 *
‚ame
,

2534 
off£t
,

2535 
pxt4_dú_íåy_2
 **
ªs_dú
);

2536 
	`pxt4_gíîic_dñëe_íåy
(
h™dÀ_t
 *
h™dÀ
,

2537 
öode
 *
dú
,

2538 
pxt4_dú_íåy_2
 *
de_dñ
,

2539 
buf„r_hód
 *
bh
,

2540 *
íåy_buf
,

2541 
buf_size
,

2542 
csum_size
);

2543 
boﬁ
 
	`pxt4_em±y_dú
(
öode
 *inode);

2546 
	`pxt4_group_add
(
su≥r_block
 *
sb
,

2547 
pxt4_√w_group_d©a
 *
öput
);

2548 
	`pxt4_group_exãnd
(
su≥r_block
 *
sb
,

2549 
pxt4_su≥r_block
 *
es
,

2550 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2551 
	`pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
);

2554 
buf„r_hód
 *
	`pxt4_sb_bªad
(
su≥r_block
 *
sb
,

2555 
£˘‹_t
 
block
, 
›_Êags
);

2556 
	`pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
);

2557 
	`pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
);

2558 
	`pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
);

2559 *
	`pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2560 *
	`pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
);

2561 
	`pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
,

2562 
pxt4_group_t
 
ngroup
);

2563 c⁄° *
	`pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

2564 
nbuf
[16]);

2565 
	`pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

2566 
pxt4_group_t
 
block_group
,

2567 
Êags
);

2569 
	$__¥ötf
(4, 5)

2570 
	`__pxt4_îr‹
(
su≥r_block
 *, const *, ,

2572 
	$__¥ötf
(5, 6)

2573 
	`__pxt4_îr‹_öode
(
öode
 *, c⁄° *, , 
pxt4_fsblk_t
,

2575 
	$__¥ötf
(5, 6)

2576 
	`__pxt4_îr‹_fûe
(
fûe
 *, c⁄° *, , 
pxt4_fsblk_t
,

2578 
	`__pxt4_°d_îr‹
(
su≥r_block
 *, const *,

2580 
	$__¥ötf
(4, 5)

2581 
	`__pxt4_ab‹t
(
su≥r_block
 *, const *, ,

2583 
	$__¥ötf
(4, 5)

2584 
	`__pxt4_w¨nög
(
su≥r_block
 *, const *, ,

2586 
	$__¥ötf
(4, 5)

2587 
	`__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

2588 
löe
, c⁄° *
fmt
, ...);

2589 
	$__¥ötf
(3, 4)

2590 
	`__pxt4_msg
(
su≥r_block
 *, const *, const *, ...);

2591 
	`__dump_mmp_msg
(
su≥r_block
 *, 
mmp_°ru˘
 *
mmp
,

2593 
	$__¥ötf
(7, 8)

2594 
	`__pxt4_gΩ_locked_îr‹
(const *, ,

2595 
su≥r_block
 *, 
pxt4_group_t
,

2596 , 
pxt4_fsblk_t
,

2599 
	#PXT4_ERROR_INODE
(
öode
, 
fmt
, 
a
...) \

2600 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, 0, (
fmt
), ## 
a
)

	)

2602 
	#PXT4_ERROR_INODE_BLOCK
(
öode
, 
block
, 
fmt
, 
a
...) \

2603 
	`pxt4_îr‹_öode
((
öode
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2605 
	#PXT4_ERROR_FILE
(
fûe
, 
block
, 
fmt
, 
a
...) \

2606 
	`pxt4_îr‹_fûe
((
fûe
), 
__func__
, 
__LINE__
, (
block
), (
fmt
), ## 
a
)

	)

2608 #ifde‡
CONFIG_PRINTK


2610 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2611 
	`__pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2612 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2613 
	`__pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ##
__VA_ARGS__
)

	)

2614 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2615 
	`__pxt4_îr‹
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2616 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2617 
	`__pxt4_ab‹t
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2618 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2619 
	`__pxt4_w¨nög
(
sb
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2620 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2621 
	`__pxt4_w¨nög_öode
(
öode
, 
__func__
, 
__LINE__
, 
fmt
, ##
__VA_ARGS__
)

	)

2622 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2623 
	`__pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ##
__VA_ARGS__
)

	)

2624 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2625 
	`__dump_mmp_msg
(
sb
, 
mmp
, 
__func__
, 
__LINE__
, 
msg
)

	)

2626 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2627 
	`__pxt4_gΩ_locked_îr‹
(
__func__
, 
__LINE__
, 
sb
, 
gΩ
, 
öo
, 
block
, \

2628 
fmt
, ##
__VA_ARGS__
)

	)

2632 
	#pxt4_îr‹_öode
(
öode
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2634 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2635 
	`__pxt4_îr‹_öode
(
öode
, "", 0, 
block
, " "); \

2636 
	}
} 0)

	)

2637 
	#pxt4_îr‹_fûe
(
fûe
, 
func
, 
löe
, 
block
, 
fmt
, ...) \

2639 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2640 
	`__pxt4_îr‹_fûe
(
fûe
, "", 0, 
block
, " "); \

2641 } 0)

	)

2642 
	#pxt4_îr‹
(
sb
, 
fmt
, ...) \

2644 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2645 
	`__pxt4_îr‹
(
sb
, "", 0, " "); \

2646 } 0)

	)

2647 
	#pxt4_ab‹t
(
sb
, 
fmt
, ...) \

2649 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2650 
	`__pxt4_ab‹t
(
sb
, "", 0, " "); \

2651 } 0)

	)

2652 
	#pxt4_w¨nög
(
sb
, 
fmt
, ...) \

2654 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2655 
	`__pxt4_w¨nög
(
sb
, "", 0, " "); \

2656 } 0)

	)

2657 
	#pxt4_w¨nög_öode
(
öode
, 
fmt
, ...) \

2659 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2660 
	`__pxt4_w¨nög_öode
(
öode
, "", 0, " "); \

2661 } 0)

	)

2662 
	#pxt4_msg
(
sb
, 
Àvñ
, 
fmt
, ...) \

2664 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2665 
	`__pxt4_msg
(
sb
, "", " "); \

2666 } 0)

	)

2667 
	#dump_mmp_msg
(
sb
, 
mmp
, 
msg
) \

2668 
	`__dump_mmp_msg
(
sb
, 
mmp
, "", 0, "")

	)

2669 
	#pxt4_gΩ_locked_îr‹
(
sb
, 
gΩ
, 
öo
, 
block
, 
fmt
, ...) \

2671 
	`no_¥ötk
(
fmt
, ##
__VA_ARGS__
); \

2672 
	`__pxt4_gΩ_locked_îr‹
("", 0, 
sb
, 
gΩ
, 
öo
, 
block
, " "); \

2673 } 0)

	)

2677 
pxt4_upd©e_com∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

2678 
__u32
 
com∑t
);

2679 
pxt4_upd©e_rocom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2680 
su≥r_block
 *
sb
, 
__u32
 
rocom∑t
);

2681 
pxt4_upd©e_öcom∑t_„©uª
(
h™dÀ_t
 *
h™dÀ
,

2682 
su≥r_block
 *
sb
, 
__u32
 
öcom∑t
);

2683 
pxt4_fsblk_t
 
pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

2684 
pxt4_group_desc
 *
bg
);

2685 
pxt4_fsblk_t
 
pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

2686 
pxt4_group_desc
 *
bg
);

2687 
pxt4_fsblk_t
 
pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

2688 
pxt4_group_desc
 *
bg
);

2689 
__u32
 
pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

2690 
pxt4_group_desc
 *
bg
);

2691 
__u32
 
pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

2692 
pxt4_group_desc
 *
bg
);

2693 
__u32
 
pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

2694 
pxt4_group_desc
 *
bg
);

2695 
__u32
 
pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

2696 
pxt4_group_desc
 *
bg
);

2697 
pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

2698 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2699 
pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

2700 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2701 
pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

2702 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
);

2703 
pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

2704 
pxt4_group_desc
 *
bg
,

2705 
__u32
 
cou¡
);

2706 
pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

2707 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2708 
pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

2709 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2710 
pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

2711 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
);

2712 
pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2713 
pxt4_group_desc
 *
gdp
);

2714 
pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
group
,

2715 
pxt4_group_desc
 *
gdp
);

2716 
pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

2717 
pxt4_group_t
 
fú°_nŸ_zî€d
);

2719 
ölöe
 
	$pxt4_has_mëad©a_csum
(
su≥r_block
 *
sb
)

2721 
	`WARN_ON_ONCE
(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2722 !
	`PXT4_SB
(
sb
)->
s_chksum_drivî
);

2724  
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

2725 (
	`PXT4_SB
(
sb
)->
s_chksum_drivî
 !
NULL
);

2726 
	}
}

2728 
ölöe
 
	$pxt4_has_group_desc_csum
(
su≥r_block
 *
sb
)

2730  
	`pxt4_has_„©uª_gdt_csum
(
sb
Ë|| 
	`pxt4_has_mëad©a_csum
(sb);

2731 
	}
}

2733 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2735  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_blocks_cou¡_hi
) << 32) |

2736 
	`À32_to_˝u
(
es
->
s_blocks_cou¡_lo
);

2737 
	}
}

2739 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_r_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2741  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_hi
) << 32) |

2742 
	`À32_to_˝u
(
es
->
s_r_blocks_cou¡_lo
);

2743 
	}
}

2745 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_‰ì_blocks_cou¡
(
pxt4_su≥r_block
 *
es
)

2747  ((
pxt4_fsblk_t
)
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_hi
) << 32) |

2748 
	`À32_to_˝u
(
es
->
s_‰ì_blocks_cou¡_lo
);

2749 
	}
}

2751 
ölöe
 
	$pxt4_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2752 
pxt4_fsblk_t
 
blk
)

2754 
es
->
s_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2755 
es
->
s_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2756 
	}
}

2758 
ölöe
 
	$pxt4_‰ì_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2759 
pxt4_fsblk_t
 
blk
)

2761 
es
->
s_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2762 
es
->
s_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2763 
	}
}

2765 
ölöe
 
	$pxt4_r_blocks_cou¡_£t
(
pxt4_su≥r_block
 *
es
,

2766 
pxt4_fsblk_t
 
blk
)

2768 
es
->
s_r_blocks_cou¡_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

2769 
es
->
s_r_blocks_cou¡_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

2770 
	}
}

2772 
ölöe
 
loff_t
 
	$pxt4_isize
(
su≥r_block
 *
sb
,

2773 
pxt4_öode
 *
øw_öode
)

2775 i‡(
	`pxt4_has_„©uª_œrgedú
(
sb
) ||

2776 
	`S_ISREG
(
	`À16_to_˝u
(
øw_öode
->
i_mode
)))

2777  ((
loff_t
)
	`À32_to_˝u
(
øw_öode
->
i_size_high
) << 32) |

2778 
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2780  (
loff_t
Ë
	`À32_to_˝u
(
øw_öode
->
i_size_lo
);

2781 
	}
}

2783 
ölöe
 
	$pxt4_isize_£t
(
pxt4_öode
 *
øw_öode
, 
loff_t
 
i_size
)

2785 
øw_öode
->
i_size_lo
 = 
	`˝u_to_À32
(
i_size
);

2786 
øw_öode
->
i_size_high
 = 
	`˝u_to_À32
(
i_size
 >> 32);

2787 
	}
}

2789 
ölöe


2790 
pxt4_group_öfo
 *
	$pxt4_gë_group_öfo
(
su≥r_block
 *
sb
,

2791 
pxt4_group_t
 
group
)

2793 
pxt4_group_öfo
 ***
gΩ_öfo
;

2794 
ödexv
, 
ödexh
;

2795 
	`BUG_ON
(
group
 >
	`PXT4_SB
(
sb
)->
s_groups_cou¡
);

2796 
gΩ_öfo
 = 
	`PXT4_SB
(
sb
)->
s_group_öfo
;

2797 
ödexv
 = 
group
 >> (
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
));

2798 
ödexh
 = 
group
 & ((
	`PXT4_DESC_PER_BLOCK
(
sb
)) - 1);

2799  
gΩ_öfo
[
ödexv
][
ödexh
];

2800 
	}
}

2807 
ölöe
 
pxt4_group_t
 
	$pxt4_gë_groups_cou¡
(
su≥r_block
 *
sb
)

2809 
pxt4_group_t
 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2811 
	`smp_rmb
();

2812  
ngroups
;

2813 
	}
}

2815 
ölöe
 
pxt4_group_t
 
	$pxt4_Êex_group
(
pxt4_sb_öfo
 *
sbi
,

2816 
pxt4_group_t
 
block_group
)

2818 
	`¥ötk
("s_log_groups_≥r_Êex : %d\n",
sbi
->
s_log_groups_≥r_Êex
);

2819  
block_group
 >> 
sbi
->
s_log_groups_≥r_Êex
;

2820 
	}
}

2822 
ölöe
 
	$pxt4_Êex_bg_size
(
pxt4_sb_öfo
 *
sbi
)

2824  1 << 
sbi
->
s_log_groups_≥r_Êex
;

2825 
	}
}

2827 
	#pxt4_°d_îr‹
(
sb
, 
î∫o
) \

2829 i‡((
î∫o
)) \

2830 
	`__pxt4_°d_îr‹
((
sb
), 
__func__
, 
__LINE__
, (
î∫o
)); \

2831 } 0)

	)

2833 #ifde‡
CONFIG_SMP


2838 
	#PXT4_FREECLUSTERS_WATERMARK
 (4 * (
≥r˝u_cou¡î_b©ch
 * 
ƒ_˝u_ids
))

	)

2840 
	#PXT4_FREECLUSTERS_WATERMARK
 0

	)

2844 
ölöe
 
	$pxt4_upd©e_i_disksize
(
öode
 *öode, 
loff_t
 
√wsize
)

2846 
	`WARN_ON_ONCE
(
	`S_ISREG
(
öode
->
i_mode
) &&

2847 !
	`öode_is_locked
(
öode
));

2848 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2849 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
)

2850 
	`PXT4_I
(
öode
)->
i_disksize
 = 
√wsize
;

2851 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_d©a_£m
);

2852 
	}
}

2855 
ölöe
 
	$pxt4_upd©e_öode_size
(
öode
 *öode, 
loff_t
 
√wsize
)

2857 
ch™ged
 = 0;

2859 i‡(
√wsize
 > 
öode
->
i_size
) {

2860 
	`i_size_wrôe
(
öode
, 
√wsize
);

2861 
ch™ged
 = 1;

2863 i‡(
√wsize
 > 
	`PXT4_I
(
öode
)->
i_disksize
) {

2864 
	`pxt4_upd©e_i_disksize
(
öode
, 
√wsize
);

2865 
ch™ged
 |= 2;

2867  
ch™ged
;

2868 
	}
}

2870 
pxt4_upd©e_disksize_bef‹e_punch
(
öode
 *öode, 
loff_t
 
off£t
,

2871 
loff_t
 
Àn
);

2873 
	spxt4_group_öfo
 {

2874 
	mbb_°©e
;

2875 
rb_roŸ
 
	mbb_‰ì_roŸ
;

2876 
pxt4_gΩblk_t
 
	mbb_fú°_‰ì
;

2877 
pxt4_gΩblk_t
 
	mbb_‰ì
;

2878 
pxt4_gΩblk_t
 
	mbb_‰agmíts
;

2879 
pxt4_gΩblk_t
 
	mbb_œrge°_‰ì_‹dî
;

2880 
li°_hód
 
	mbb_¥óŒoc_li°
;

2881 #ifde‡
DOUBLE_CHECK


2882 *
	mbb_bôm≠
;

2884 
rw_£m≠h‹e
 
	mÆloc_£m
;

2885 
pxt4_gΩblk_t
 
	mbb_cou¡îs
[];

2891 
	#PXT4_GROUP_INFO_NEED_INIT_BIT
 0

	)

2892 
	#PXT4_GROUP_INFO_WAS_TRIMMED_BIT
 1

	)

2893 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
 2

	)

2894 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
 3

	)

2895 
	#PXT4_GROUP_INFO_BBITMAP_CORRUPT
 \

2896 (1 << 
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
)

	)

2897 
	#PXT4_GROUP_INFO_IBITMAP_CORRUPT
 \

2898 (1 << 
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
)

	)

2900 
	#PXT4_MB_GRP_NEED_INIT
(
gΩ
) \

2901 (
	`ã°_bô
(
PXT4_GROUP_INFO_NEED_INIT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2902 
	#PXT4_MB_GRP_BBITMAP_CORRUPT
(
gΩ
) \

2903 (
	`ã°_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2904 
	#PXT4_MB_GRP_IBITMAP_CORRUPT
(
gΩ
) \

2905 (
	`ã°_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2907 
	#PXT4_MB_GRP_WAS_TRIMMED
(
gΩ
) \

2908 (
	`ã°_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2909 
	#PXT4_MB_GRP_SET_TRIMMED
(
gΩ
) \

2910 (
	`£t_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2911 
	#PXT4_MB_GRP_CLEAR_TRIMMED
(
gΩ
) \

2912 (
	`˛ór_bô
(
PXT4_GROUP_INFO_WAS_TRIMMED_BIT
, &((
gΩ
)->
bb_°©e
)))

	)

2914 
	#PXT4_MAX_CONTENTION
 8

	)

2915 
	#PXT4_CONTENTION_THRESHOLD
 2

	)

2917 
ölöe
 
•ölock_t
 *
	$pxt4_group_lock_±r
(
su≥r_block
 *
sb
,

2918 
pxt4_group_t
 
group
)

2920  
	`bgl_lock_±r
(
	`PXT4_SB
(
sb
)->
s_blockgroup_lock
, 
group
);

2921 
	}
}

2927 
ölöe
 
	$pxt4_fs_is_busy
(
pxt4_sb_öfo
 *
sbi
)

2929  (
	`©omic_ªad
(&
sbi
->
s_lock_busy
Ë> 
PXT4_CONTENTION_THRESHOLD
);

2930 
	}
}

2932 
ölöe
 
	$pxt4_lock_group
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
group
)

2934 
•ölock_t
 *
lock
 = 
	`pxt4_group_lock_±r
(
sb
, 
group
);

2935 i‡(
	`•ö_åylock
(
lock
))

2940 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, -1, 0);

2946 
	`©omic_add_u∆ess
(&
	`PXT4_SB
(
sb
)->
s_lock_busy
, 1,

2947 
PXT4_MAX_CONTENTION
);

2948 
	`•ö_lock
(
lock
);

2950 
	}
}

2952 
ölöe
 
	$pxt4_u∆ock_group
(
su≥r_block
 *
sb
,

2953 
pxt4_group_t
 
group
)

2955 
	`•ö_u∆ock
(
	`pxt4_group_lock_±r
(
sb
, 
group
));

2956 
	}
}

2961 
	#pxt4_check_ödúe˘_blockªf
(
öode
, 
bh
) \

2962 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

2963 (
__À32
 *)(
bh
)->
b_d©a
, \

2964 
	`PXT4_ADDR_PER_BLOCK
((
öode
)->
i_sb
))

	)

2966 
	#pxt4_öd_check_öode
(
öode
) \

2967 
	`pxt4_check_blockªf
(
__func__
, 
__LINE__
, 
öode
, \

2968 
	`PXT4_I
(
öode
)->
i_d©a
, \

2969 
PXT4_NDIR_BLOCKS
)

	)

2976 c⁄° 
fûe_›î©i⁄s
 
pxt4_dú_›î©i⁄s
;

2979 c⁄° 
öode_›î©i⁄s
 
pxt4_fûe_öode_›î©i⁄s
;

2980 c⁄° 
fûe_›î©i⁄s
 
pxt4_fûe_›î©i⁄s
;

2981 
loff_t
 
pxt4_Œ£ek
(
fûe
 *fûe,Üoff_à
off£t
, 
‹igö
);

2984 
pxt4_gë_max_ölöe_size
(
öode
 *inode);

2985 
pxt4_föd_ölöe_d©a_nﬁock
(
öode
 *inode);

2986 
pxt4_öô_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2987 
Àn
);

2988 
pxt4_de°roy_ölöe_d©a
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

2990 
pxt4_ªad∑ge_ölöe
(
öode
 *öode, 
∑ge
 *page);

2991 
pxt4_åy_to_wrôe_ölöe_d©a
(
addªss_•a˚
 *
m≠pög
,

2992 
öode
 *inode,

2993 
loff_t
 
pos
, 
Àn
,

2994 
Êags
,

2995 
∑ge
 **
∑gï
);

2996 
pxt4_wrôe_ölöe_d©a_íd
(
öode
 *inode,

2997 
loff_t
 
pos
, 
Àn
,

2998 
c›õd
,

2999 
∑ge
 *page);

3000 
buf„r_hód
 *

3001 
pxt4_jou∫ÆÀd_wrôe_ölöe_d©a
(
öode
 *inode,

3002 
Àn
,

3003 
∑ge
 *page);

3004 
pxt4_da_wrôe_ölöe_d©a_begö
(
addªss_•a˚
 *
m≠pög
,

3005 
öode
 *inode,

3006 
loff_t
 
pos
, 
Àn
,

3007 
Êags
,

3008 
∑ge
 **
∑gï
,

3009 **
fsd©a
);

3010 
pxt4_da_wrôe_ölöe_d©a_íd
(
öode
 *öode, 
loff_t
 
pos
,

3011 
Àn
, 
c›õd
,

3012 
∑ge
 *page);

3013 
pxt4_åy_add_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3014 
pxt4_fûíame
 *
‚ame
,

3015 
öode
 *
dú
, inode *inode);

3016 
pxt4_åy_¸óã_ölöe_dú
(
h™dÀ_t
 *
h™dÀ
,

3017 
öode
 *
∑ª¡
,

3018 
öode
 *inode);

3019 
pxt4_ªad_ölöe_dú
(
fûe
 *
fûp
,

3020 
dú_c⁄ãxt
 *
˘x
,

3021 *
has_ölöe_d©a
);

3022 
håì_ölöedú_to_åì
(
fûe
 *
dú_fûe
,

3023 
öode
 *
dú
, 
pxt4_lblk_t
 
block
,

3024 
dx_hash_öfo
 *
höfo
,

3025 
__u32
 
°¨t_hash
, __u32 
°¨t_mö‹_hash
,

3026 *
has_ölöe_d©a
);

3027 
buf„r_hód
 *
pxt4_föd_ölöe_íåy
(
öode
 *
dú
,

3028 
pxt4_fûíame
 *
‚ame
,

3029 
pxt4_dú_íåy_2
 **
ªs_dú
,

3030 *
has_ölöe_d©a
);

3031 
pxt4_dñëe_ölöe_íåy
(
h™dÀ_t
 *
h™dÀ
,

3032 
öode
 *
dú
,

3033 
pxt4_dú_íåy_2
 *
de_dñ
,

3034 
buf„r_hód
 *
bh
,

3035 *
has_ölöe_d©a
);

3036 
boﬁ
 
em±y_ölöe_dú
(
öode
 *
dú
, *
has_ölöe_d©a
);

3037 
buf„r_hód
 *
pxt4_gë_fú°_ölöe_block
(
öode
 *inode,

3038 
pxt4_dú_íåy_2
 **
∑ª¡_de
,

3039 *
ªtvÆ
);

3040 
pxt4_ölöe_d©a_fõm≠
(
öode
 *inode,

3041 
fõm≠_exã¡_öfo
 *
fõöfo
,

3042 *
has_ölöe
, 
__u64
 
°¨t
, __u64 
Àn
);

3044 
	giom≠
;

3045 
pxt4_ölöe_d©a_iom≠
(
öode
 *öode, 
iom≠
 *iomap);

3047 
pxt4_ölöe_d©a_åunˇã
(
öode
 *öode, *
has_ölöe
);

3049 
pxt4_c⁄vît_ölöe_d©a
(
öode
 *inode);

3051 
ölöe
 
	$pxt4_has_ölöe_d©a
(
öode
 *inode)

3053  
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_INLINE_DATA
) &&

3054 
	`PXT4_I
(
öode
)->
i_ölöe_off
;

3055 
	}
}

3058 c⁄° 
öode_›î©i⁄s
 
pxt4_dú_öode_›î©i⁄s
;

3059 c⁄° 
öode_›î©i⁄s
 
pxt4_•ecül_öode_›î©i⁄s
;

3060 
díåy
 *
pxt4_gë_∑ª¡
(díåy *
chûd
);

3061 
pxt4_dú_íåy_2
 *
pxt4_öô_dŸ_dŸdŸ
(
öode
 *inode,

3062 
pxt4_dú_íåy_2
 *
de
,

3063 
blocksize
, 
csum_size
,

3064 
∑ª¡_öo
, 
dŸdŸ_ªÆ_Àn
);

3065 
öôülize_dúít_èû
(
pxt4_dú_íåy_èû
 *
t
,

3066 
blocksize
);

3067 
pxt4_h™dÀ_dúty_dúít_node
(
h™dÀ_t
 *
h™dÀ
,

3068 
öode
 *inode,

3069 
buf„r_hód
 *
bh
);

3070 
	#S_SHIFT
 12

	)

3071 c⁄° 
	gpxt4_ty≥_by_mode
[(
S_IFMT
 >> 
S_SHIFT
) + 1] = {

3072 [
S_IFREG
 >> 
S_SHIFT
] = 
PXT4_FT_REG_FILE
,

3073 [
S_IFDIR
 >> 
S_SHIFT
] = 
PXT4_FT_DIR
,

3074 [
S_IFCHR
 >> 
S_SHIFT
] = 
PXT4_FT_CHRDEV
,

3075 [
S_IFBLK
 >> 
S_SHIFT
] = 
PXT4_FT_BLKDEV
,

3076 [
S_IFIFO
 >> 
S_SHIFT
] = 
PXT4_FT_FIFO
,

3077 [
S_IFSOCK
 >> 
S_SHIFT
] = 
PXT4_FT_SOCK
,

3078 [
S_IFLNK
 >> 
S_SHIFT
] = 
PXT4_FT_SYMLINK
,

3081 
ölöe
 
	$pxt4_£t_de_ty≥
(
su≥r_block
 *
sb
,

3082 
pxt4_dú_íåy_2
 *
de
,

3083 
umode_t
 
mode
) {

3084 i‡(
	`pxt4_has_„©uª_fûëy≥
(
sb
))

3085 
de
->
fûe_ty≥
 = 
pxt4_ty≥_by_mode
[(
mode
 & 
S_IFMT
)>>
S_SHIFT
];

3086 
	}
}

3089 
pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

3090 
li°_hód
 *
∑ges
, 
∑ge
 *page,

3091 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
);

3094 c⁄° 
öode_›î©i⁄s
 
pxt4_í¸y±ed_symlök_öode_›î©i⁄s
;

3095 c⁄° 
öode_›î©i⁄s
 
pxt4_symlök_öode_›î©i⁄s
;

3096 c⁄° 
öode_›î©i⁄s
 
pxt4_Á°_symlök_öode_›î©i⁄s
;

3099 
pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
);

3100 
pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
);

3101 
__öô
 
pxt4_öô_sysfs
();

3102 
pxt4_exô_sysfs
();

3105 
pxt4_ªÀa£_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3106 
pxt4_£tup_sy°em_z⁄e
(
su≥r_block
 *
sb
);

3107 
__öô
 
pxt4_öô_sy°em_z⁄e
();

3108 
pxt4_exô_sy°em_z⁄e
();

3109 
pxt4_d©a_block_vÆid
(
pxt4_sb_öfo
 *
sbi
,

3110 
pxt4_fsblk_t
 
°¨t_blk
,

3111 
cou¡
);

3112 
pxt4_check_blockªf
(const *, ,

3113 
öode
 *, 
__À32
 *, );

3116 
	gpxt4_ext_∑th
;

3117 
	gpxt4_exã¡
;

3123 
	#EXT_MAX_BLOCKS
 0xffffffff

	)

3125 
pxt4_ext_åì_öô
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *);

3126 
pxt4_ext_wrôïage_å™s_blocks
(
öode
 *, );

3127 
pxt4_ext_ödex_å™s_blocks
(
öode
 *öode, 
exã¡s
);

3128 
pxt4_ext_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3129 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3130 
pxt4_ext_åunˇã
(
h™dÀ_t
 *, 
öode
 *);

3131 
pxt4_ext_ªmove_•a˚
(
öode
 *öode, 
pxt4_lblk_t
 
°¨t
,

3132 
pxt4_lblk_t
 
íd
);

3133 
pxt4_ext_öô
(
su≥r_block
 *);

3134 
pxt4_ext_ªÀa£
(
su≥r_block
 *);

3135 
pxt4_ÁŒoˇã
(
fûe
 *fûe, 
mode
, 
loff_t
 
off£t
,

3136 
loff_t
 
Àn
);

3137 
pxt4_c⁄vît_unwrôãn_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3138 
loff_t
 
off£t
, 
ssize_t
 
Àn
);

3139 
pxt4_m≠_blocks
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

3140 
pxt4_m≠_blocks
 *
m≠
, 
Êags
);

3141 
pxt4_ext_ˇlc_mëad©a_amou¡
(
öode
 *inode,

3142 
pxt4_lblk_t
 
lblocks
);

3143 
pxt4_ext_ˇlc_¸edôs_f‹_sögÀ_exã¡
(
öode
 *inode,

3144 
num
,

3145 
pxt4_ext_∑th
 *
∑th
);

3146 
pxt4_ˇn_exã¡s_be_mîged
(
öode
 *inode,

3147 
pxt4_exã¡
 *
ex1
,

3148 
pxt4_exã¡
 *
ex2
);

3149 
pxt4_ext_ö£π_exã¡
(
h™dÀ_t
 *, 
öode
 *,

3150 
pxt4_ext_∑th
 **,

3151 
pxt4_exã¡
 *, );

3152 
pxt4_ext_∑th
 *
pxt4_föd_exã¡
(
öode
 *, 
pxt4_lblk_t
,

3153 
pxt4_ext_∑th
 **,

3154 
Êags
);

3155 
pxt4_ext_dr›_ªfs
(
pxt4_ext_∑th
 *);

3156 
pxt4_ext_check_öode
(
öode
 *inode);

3157 
pxt4_lblk_t
 
pxt4_ext_√xt_Æloˇãd_block
(
pxt4_ext_∑th
 *
∑th
);

3158 
pxt4_fõm≠
(
öode
 *öode, 
fõm≠_exã¡_öfo
 *
fõöfo
,

3159 
__u64
 
°¨t
, __u64 
Àn
);

3160 
pxt4_ext_¥eˇche
(
öode
 *inode);

3161 
pxt4_cﬁœp£_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3162 
pxt4_ö£π_ønge
(
öode
 *öode, 
loff_t
 
off£t
,Üoff_à
Àn
);

3163 
pxt4_sw≠_exã¡s
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
öode1
,

3164 
öode
 *
öode2
, 
pxt4_lblk_t
 
lblk1
,

3165 
pxt4_lblk_t
 
lblk2
,Öxt4_lblk_à
cou¡
,

3166 
m¨k_unwrôãn
,*
îr
);

3167 
pxt4_˛u_m≠≥d
(
öode
 *öode, 
pxt4_lblk_t
 
l˛u
);

3170 
pxt4_doubÀ_down_wrôe_d©a_£m
(
öode
 *
fú°
,

3171 
öode
 *
£c⁄d
);

3172 
pxt4_doubÀ_up_wrôe_d©a_£m
(
öode
 *
‹ig_öode
,

3173 
öode
 *
d⁄‹_öode
);

3174 
pxt4_move_exã¡s
(
fûe
 *
o_fûp
, fûê*
d_fûp
,

3175 
__u64
 
°¨t_‹ig
, __u64 
°¨t_d⁄‹
,

3176 
__u64
 
Àn
, __u64 *
moved_Àn
);

3179 
__öô
 
pxt4_öô_∑geio
();

3180 
pxt4_exô_∑geio
();

3181 
pxt4_io_íd_t
 *
pxt4_öô_io_íd
(
öode
 *öode, 
gÂ_t
 
Êags
);

3182 
pxt4_io_íd_t
 *
pxt4_gë_io_íd
’xt4_io_íd_à*
io_íd
);

3183 
pxt4_put_io_íd
(
pxt4_io_íd_t
 *
io_íd
);

3184 
pxt4_put_io_íd_de„r
(
pxt4_io_íd_t
 *
io_íd
);

3185 
pxt4_io_submô_öô
(
pxt4_io_submô
 *
io
,

3186 
wrôeback_c⁄åﬁ
 *
wbc
);

3187 
pxt4_íd_io_rsv_w‹k
(
w‹k_°ru˘
 *
w‹k
);

3188 
pxt4_io_submô
(pxt4_io_submô *
io
);

3189 
pxt4_bio_wrôe_∑ge
(
pxt4_io_submô
 *
io
,

3190 
∑ge
 *page,

3191 
Àn
,

3192 
wrôeback_c⁄åﬁ
 *
wbc
,

3193 
boﬁ
 
kìp_towrôe
);

3196 
pxt4_mu…i_mou¡_¥Ÿe˘
(
su≥r_block
 *, 
pxt4_fsblk_t
);

3203 
	#BH_BITMAP_UPTODATE
 
BH_JBDPriv©eSèπ


	)

3205 
ölöe
 
	$bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3207  (
	`buf„r_u±od©e
(
bh
) &&

3208 
	`ã°_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
));

3209 
	}
}

3210 
ölöe
 
	$£t_bôm≠_u±od©e
(
buf„r_hód
 *
bh
)

3212 
	`£t_bô
(
BH_BITMAP_UPTODATE
, &(
bh
)->
b_°©e
);

3213 
	}
}

3215 
	#ö_ønge
(
b
, 
fú°
, 
Àn
Ë((bË>(fú°Ë&& (bË<(fú°Ë+ (ÀnË- 1)

	)

3218 
	#PXT4_WQ_HASH_SZ
 37

	)

3219 
	#pxt4_i€nd_wq
(
v
Ë(&
pxt4__i€nd_wq
[(()(v)) %\

3220 
PXT4_WQ_HASH_SZ
])

	)

3221 
waô_queue_hód_t
 
pxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

3223 
pxt4_ªsize_begö
(
su≥r_block
 *
sb
);

3224 
pxt4_ªsize_íd
(
su≥r_block
 *
sb
);

3226 
ölöe
 
	$pxt4_£t_io_unwrôãn_Êag
(
öode
 *inode,

3227 
pxt4_io_íd
 *
io_íd
)

3229 i‡(!(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
)) {

3230 
io_íd
->
Êag
 |
PXT4_IO_END_UNWRITTEN
;

3231 
	`©omic_öc
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
);

3233 
	}
}

3235 
ölöe
 
	$pxt4_˛ór_io_unwrôãn_Êag
(
pxt4_io_íd_t
 *
io_íd
)

3237 
öode
 *öodê
io_íd
->inode;

3239 i‡(
io_íd
->
Êag
 & 
PXT4_IO_END_UNWRITTEN
) {

3240 
io_íd
->
Êag
 &~
PXT4_IO_END_UNWRITTEN
;

3242 i‡(
	`©omic_dec_™d_ã°
(&
	`PXT4_I
(
öode
)->
i_unwrôãn
))

3243 
	`wake_up_Æl
(
	`pxt4_i€nd_wq
(
öode
));

3245 
	}
}

3247 c⁄° 
iom≠_›s
 
pxt4_iom≠_›s
;

3251 
	#EFSBADCRC
 
EBADMSG


	)

3252 
	#EFSCORRUPTED
 
EUCLEAN


	)

	@pxt4.mod.c

1 
	~<löux/buûd-ß….h
>

2 
	~<löux/moduÀ.h
>

3 
	~<löux/vîmagic.h
>

4 
	~<löux/compûî.h
>

6 
	gBUILD_SALT
;

8 
MODULE_INFO
(
vîmagic
, 
VERMAGIC_STRING
);

9 
MODULE_INFO
(
«me
, 
KBUILD_MODNAME
);

11 
__visibÀ
 
moduÀ
 
__this_moduÀ


12 
__©åibuã__
((
£˘i⁄
(".gnu.linkonce.this_module"))) = {

13 .
«me
 = 
KBUILD_MODNAME
,

14 .
	göô
 = 
öô_moduÀ
,

15 #ifde‡
CONFIG_MODULE_UNLOAD


16 .
	gexô
 = 
˛ónup_moduÀ
,

18 .
	g¨ch
 = 
MODULE_ARCH_INIT
,

21 #ifde‡
CONFIG_RETPOLINE


22 
MODULE_INFO
(
ªçﬁöe
, "Y");

25 c⁄° 
	g__moduÀ_dïíds
[]

26 
__u£d


27 
__©åibuã__
((
£˘i⁄
(".modinfo"))) =

31 
MODULE_INFO
(
§cvîsi⁄
, "45903AD066193EDC205C508");

	@pxt4_extents.h

7 #i‚de‡
_PXT4_EXTENTS


8 
	#_PXT4_EXTENTS


	)

10 
	~"pxt4.h
"

18 
	#AGGRESSIVE_TEST_


	)

25 
	#EXTENTS_STATS__


	)

31 
	#CHECK_BINSEARCH__


	)

37 
	#EXT_STATS_


	)

55 
	spxt4_exã¡_èû
 {

56 
__À32
 
	më_checksum
;

63 
	spxt4_exã¡
 {

64 
__À32
 
	mì_block
;

65 
__À16
 
	mì_Àn
;

66 
__À16
 
	mì_°¨t_hi
;

67 
__À32
 
	mì_°¨t_lo
;

74 
	spxt4_exã¡_idx
 {

75 
__À32
 
	mei_block
;

76 
__À32
 
	mei_Àaf_lo
;

78 
__À16
 
	mei_Àaf_hi
;

79 
__u16
 
	mei_unu£d
;

85 
	spxt4_exã¡_hódî
 {

86 
__À16
 
	meh_magic
;

87 
__À16
 
	meh_íåõs
;

88 
__À16
 
	meh_max
;

89 
__À16
 
	meh_dïth
;

90 
__À32
 
	meh_gíî©i⁄
;

93 
	#PXT4_EXT_MAGIC
 
	`˝u_to_À16
(0xf30a)

	)

94 
	#PXT4_MAX_EXTENT_DEPTH
 5

	)

96 
	#PXT4_EXTENT_TAIL_OFFSET
(
hdr
) \

97 ((
pxt4_exã¡_hódî
) + \

98 ((
pxt4_exã¡
Ë* 
	`À16_to_˝u
((
hdr
)->
eh_max
)))

	)

100 
ölöe
 
pxt4_exã¡_èû
 *

101 
	$föd_pxt4_exã¡_èû
(
pxt4_exã¡_hódî
 *
eh
)

103  (
pxt4_exã¡_èû
 *)(((*)
eh
) +

104 
	`PXT4_EXTENT_TAIL_OFFSET
(
eh
));

105 
	}
}

112 
	spxt4_ext_∑th
 {

113 
pxt4_fsblk_t
 
	mp_block
;

114 
__u16
 
	mp_dïth
;

115 
__u16
 
	mp_maxdïth
;

116 
pxt4_exã¡
 *
	mp_ext
;

117 
pxt4_exã¡_idx
 *
	mp_idx
;

118 
pxt4_exã¡_hódî
 *
	mp_hdr
;

119 
buf„r_hód
 *
	mp_bh
;

129 
	s∑πül_˛u°î
 {

130 
pxt4_fsblk_t
 
	mp˛u
;

131 
pxt4_lblk_t
 
	mlblk
;

132 íum {
	möôül
, 
	mto‰ì
, 
	mno‰ì
} 
	m°©e
;

156 
	#EXT_INIT_MAX_LEN
 (1UL << 15)

	)

157 
	#EXT_UNWRITTEN_MAX_LEN
 (
EXT_INIT_MAX_LEN
 - 1)

	)

160 
	#EXT_FIRST_EXTENT
(
__hdr__
) \

161 ((
pxt4_exã¡
 *Ë(((*Ë(
__hdr__
)) + \

162 (
pxt4_exã¡_hódî
)))

	)

163 
	#EXT_FIRST_INDEX
(
__hdr__
) \

164 ((
pxt4_exã¡_idx
 *Ë(((*Ë(
__hdr__
)) + \

165 (
pxt4_exã¡_hódî
)))

	)

166 
	#EXT_HAS_FREE_INDEX
(
__∑th__
) \

167 (
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_íåõs
) \

168 < 
	`À16_to_˝u
((
__∑th__
)->
p_hdr
->
eh_max
))

	)

169 
	#EXT_LAST_EXTENT
(
__hdr__
) \

170 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

171 
	#EXT_LAST_INDEX
(
__hdr__
) \

172 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_íåõs
Ë- 1)

	)

173 
	#EXT_MAX_EXTENT
(
__hdr__
) \

174 (
	`EXT_FIRST_EXTENT
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

175 
	#EXT_MAX_INDEX
(
__hdr__
) \

176 (
	`EXT_FIRST_INDEX
((
__hdr__
)Ë+ 
	`À16_to_˝u
((__hdr__)->
eh_max
Ë- 1)

	)

178 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_öode_hdr
(
öode
 *inode)

180  (
pxt4_exã¡_hódî
 *Ë
	`PXT4_I
(
öode
)->
i_d©a
;

181 
	}
}

183 
ölöe
 
pxt4_exã¡_hódî
 *
	$ext_block_hdr
(
buf„r_hód
 *
bh
)

185  (
pxt4_exã¡_hódî
 *Ë
bh
->
b_d©a
;

186 
	}
}

188 
ölöe
 
	$ext_dïth
(
öode
 *inode)

190  
	`À16_to_˝u
(
	`ext_öode_hdr
(
öode
)->
eh_dïth
);

191 
	}
}

193 
ölöe
 
	$pxt4_ext_m¨k_unwrôãn
(
pxt4_exã¡
 *
ext
)

196 
	`BUG_ON
((
	`À16_to_˝u
(
ext
->
ì_Àn
Ë& ~
EXT_INIT_MAX_LEN
) == 0);

197 
ext
->
ì_Àn
 |
	`˝u_to_À16
(
EXT_INIT_MAX_LEN
);

198 
	}
}

200 
ölöe
 
	$pxt4_ext_is_unwrôãn
(
pxt4_exã¡
 *
ext
)

203  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë> 
EXT_INIT_MAX_LEN
);

204 
	}
}

206 
ölöe
 
	$pxt4_ext_gë_a˘uÆ_Àn
(
pxt4_exã¡
 *
ext
)

208  (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë<
EXT_INIT_MAX_LEN
 ?

209 
	`À16_to_˝u
(
ext
->
ì_Àn
) :

210 (
	`À16_to_˝u
(
ext
->
ì_Àn
Ë- 
EXT_INIT_MAX_LEN
));

211 
	}
}

213 
ölöe
 
	$pxt4_ext_m¨k_öôülized
(
pxt4_exã¡
 *
ext
)

215 
ext
->
ì_Àn
 = 
	`˝u_to_À16
(
	`pxt4_ext_gë_a˘uÆ_Àn
(ext));

216 
	}
}

222 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_ext_pblock
(
pxt4_exã¡
 *
ex
)

224 
pxt4_fsblk_t
 
block
;

226 
block
 = 
	`À32_to_˝u
(
ex
->
ì_°¨t_lo
);

227 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ex
->
ì_°¨t_hi
) << 31) << 1;

228  
block
;

229 
	}
}

235 
ölöe
 
pxt4_fsblk_t
 
	$pxt4_idx_pblock
(
pxt4_exã¡_idx
 *
ix
)

237 
pxt4_fsblk_t
 
block
;

239 
block
 = 
	`À32_to_˝u
(
ix
->
ei_Àaf_lo
);

240 
block
 |((
pxt4_fsblk_t
Ë
	`À16_to_˝u
(
ix
->
ei_Àaf_hi
) << 31) << 1;

241  
block
;

242 
	}
}

249 
ölöe
 
	$pxt4_ext_°‹e_pblock
(
pxt4_exã¡
 *
ex
,

250 
pxt4_fsblk_t
 
pb
)

252 
ex
->
ì_°¨t_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

253 
ex
->
ì_°¨t_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

255 
	}
}

262 
ölöe
 
	$pxt4_idx_°‹e_pblock
(
pxt4_exã¡_idx
 *
ix
,

263 
pxt4_fsblk_t
 
pb
)

265 
ix
->
ei_Àaf_lo
 = 
	`˝u_to_À32
((Ë(
pb
 & 0xffffffff));

266 
ix
->
ei_Àaf_hi
 = 
	`˝u_to_À16
((Ë((
pb
 >> 31) >> 1) &

268 
	}
}

270 
	#pxt4_ext_dúty
(
h™dÀ
, 
öode
, 
∑th
) \

271 
	`__pxt4_ext_dúty
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), (
∑th
))

	)

272 
__pxt4_ext_dúty
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

273 
öode
 *öode, 
pxt4_ext_∑th
 *
∑th
);

	@pxt4_jbd3.c

6 
	~"pxt4_jbd3.h
"

8 
	~<åa˚/evíts/pxt4.h
>

11 
h™dÀ_t
 *
	$pxt4_gë_nojou∫Æ
()

13 
h™dÀ_t
 *
h™dÀ
 = 
cuºít
->
jou∫Æ_öfo
;

14 
ªf_˙t
 = ()
h™dÀ
;

16 
	`BUG_ON
(
ªf_˙t
 >
PXT4_NOJOURNAL_MAX_REF_COUNT
);

18 
ªf_˙t
++;

19 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

21 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

22  
h™dÀ
;

23 
	}
}

27 
	$pxt4_put_nojou∫Æ
(
h™dÀ_t
 *
h™dÀ
)

29 
ªf_˙t
 = ()
h™dÀ
;

31 
	`BUG_ON
(
ªf_˙t
 == 0);

33 
ªf_˙t
--;

34 
h™dÀ
 = (
h™dÀ_t
 *)
ªf_˙t
;

36 
cuºít
->
jou∫Æ_öfo
 = 
h™dÀ
;

37 
	}
}

42 
	$pxt4_jou∫Æ_check_°¨t
(
su≥r_block
 *
sb
)

44 
jou∫Æ_t
 *
jou∫Æ
;

46 
	`might_¶ìp
();

48 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

49  -
EIO
;

51 i‡(
	`sb_rd⁄ly
(
sb
))

52  -
EROFS
;

53 
	`WARN_ON
(
sb
->
s_wrôîs
.
‰ozí
 =
SB_FREEZE_COMPLETE
);

54 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

60 i‡(
jou∫Æ
 && 
	`is_jou∫Æ_ab‹ãd
(journal)) {

61 
	`pxt4_ab‹t
(
sb
, "Detectedáborted journal");

62  -
EROFS
;

65 
	}
}

67 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

68 
ty≥
, 
blocks
, 
rsv_blocks
)

70 
jou∫Æ_t
 *
jou∫Æ
;

71 
îr
;

73 
	`åa˚_pxt4_jou∫Æ_°¨t
(
sb
, 
blocks
, 
rsv_blocks
, 
_RET_IP_
);

74 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

75 i‡(
îr
 < 0)

76  
	`ERR_PTR
(
îr
);

78 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

79 i‡(!
jou∫Æ
)

80  
	`pxt4_gë_nojou∫Æ
();

81  
	`jbd3__jou∫Æ_°¨t
(
jou∫Æ
, 
blocks
, 
rsv_blocks
, 
GFP_NOFS
,

82 
ty≥
, 
löe
);

83 
	}
}

85 
	$__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
)

87 
su≥r_block
 *
sb
;

88 
îr
;

89 
rc
;

91 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

92 
	`pxt4_put_nojou∫Æ
(
h™dÀ
);

96 
îr
 = 
h™dÀ
->
h_îr
;

97 i‡(!
h™dÀ
->
h_å™ß˘i⁄
) {

98 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

99  
îr
 ?Éº : 
rc
;

102 
sb
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
;

103 
rc
 = 
	`jbd3_jou∫Æ_°›
(
h™dÀ
);

105 i‡(!
îr
)

106 
îr
 = 
rc
;

107 i‡(
îr
)

108 
	`__pxt4_°d_îr‹
(
sb
, 
whîe
, 
löe
, 
îr
);

109  
îr
;

110 
	}
}

112 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ_t
 *
h™dÀ
, 
löe
,

113 
ty≥
)

115 
su≥r_block
 *
sb
;

116 
îr
;

118 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

119  
	`pxt4_gë_nojou∫Æ
();

121 
sb
 = 
h™dÀ
->
h_jou∫Æ
->
j_¥iv©e
;

122 
	`åa˚_pxt4_jou∫Æ_°¨t_ª£rved
(
sb
, 
h™dÀ
->
h_buf„r_¸edôs
,

123 
_RET_IP_
);

124 
îr
 = 
	`pxt4_jou∫Æ_check_°¨t
(
sb
);

125 i‡(
îr
 < 0) {

126 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

127  
	`ERR_PTR
(
îr
);

130 
îr
 = 
	`jbd3_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
, 
löe
);

131 i‡(
îr
 < 0)

132  
	`ERR_PTR
(
îr
);

133  
h™dÀ
;

134 
	}
}

136 
	$pxt4_jou∫Æ_ab‹t_h™dÀ
(c⁄° *
ˇŒî
, 
löe
,

137 c⁄° *
îr_‚
,

138 
buf„r_hód
 *
bh
,

139 
h™dÀ_t
 *
h™dÀ
, 
îr
)

141 
nbuf
[16];

142 c⁄° *
îr°r
 = 
	`pxt4_decode_îr‹
(
NULL
, 
îr
, 
nbuf
);

144 
	`BUG_ON
(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
));

146 i‡(
bh
)

147 
	`BUFFER_TRACE
(
bh
, "abort");

149 i‡(!
h™dÀ
->
h_îr
)

150 
h™dÀ
->
h_îr
 = 
îr
;

152 i‡(
	`is_h™dÀ_ab‹ãd
(
h™dÀ
))

155 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: %s:%d:ábortingÅransaction: %s in %s\n",

156 
ˇŒî
, 
löe
, 
îr°r
, 
îr_‚
);

158 
	`jbd3_jou∫Æ_ab‹t_h™dÀ
(
h™dÀ
);

159 
	}
}

161 
	$__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

162 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

164 
îr
 = 0;

166 
	`might_¶ìp
();

168 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

169 
îr
 = 
	`jbd3_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

170 i‡(
îr
)

171 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

172 
h™dÀ
, 
îr
);

174  
îr
;

175 
	}
}

189 
	$__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

190 
is_mëad©a
, 
öode
 *inode,

191 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
)

193 
îr
;

195 
	`might_¶ìp
();

197 
	`åa˚_pxt4_f‹gë
(
öode
, 
is_mëad©a
, 
blockƒ
);

198 
	`BUFFER_TRACE
(
bh
, "enter");

200 
	`jbd_debug
(4, "forgetting bh %p: is_metadata = %d, mode %o, "

202 
bh
, 
is_mëad©a
, 
öode
->
i_mode
,

203 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
));

206 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

207 
	`bf‹gë
(
bh
);

216 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

217 (!
is_mëad©a
 && !
	`pxt4_should_jou∫Æ_d©a
(
öode
))) {

218 i‡(
bh
) {

219 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_forget");

220 
îr
 = 
	`jbd3_jou∫Æ_f‹gë
(
h™dÀ
, 
bh
);

221 i‡(
îr
)

222 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

223 
bh
, 
h™dÀ
, 
îr
);

224  
îr
;

232 
	`BUFFER_TRACE
(
bh
, "call jbd3_journal_revoke");

233 
îr
 = 
	`jbd3_jou∫Æ_ªvoke
(
h™dÀ
, 
blockƒ
, 
bh
);

234 i‡(
îr
) {

235 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

236 
bh
, 
h™dÀ
, 
îr
);

237 
	`__pxt4_ab‹t
(
öode
->
i_sb
, 
whîe
, 
löe
,

238 "îr‹ %d whíáâem±ögÑevoke", 
îr
);

240 
	`BUFFER_TRACE
(
bh
, "exit");

241  
îr
;

242 
	}
}

244 
	$__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

245 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
)

247 
îr
 = 0;

249 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

250 
îr
 = 
	`jbd3_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
);

251 i‡(
îr
)

252 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

253 
bh
, 
h™dÀ
, 
îr
);

255  
îr
;

256 
	}
}

258 
	$__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

259 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

260 
buf„r_hód
 *
bh
)

262 
îr
 = 0;

264 
	`might_¶ìp
();

266 
	`£t_buf„r_mëa
(
bh
);

267 
	`£t_buf„r_¥io
(
bh
);

268 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

269 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

271 i‡(!
	`is_h™dÀ_ab‹ãd
(
h™dÀ
Ë&& 
	`WARN_ON_ONCE
(
îr
)) {

272 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
, 
bh
,

273 
h™dÀ
, 
îr
);

274 i‡(
öode
 =
NULL
) {

275 
	`¥_îr
("PXT4: jbd3_journal_dirty_metadata "

278 
h™dÀ
->
h_ty≥
,

279 
h™dÀ
->
h_löe_no
,

280 
h™dÀ
->
h_ªque°ed_¸edôs
,

281 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

282  
îr
;

284 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

285 
bh
->
b_blockƒ
,

289 
h™dÀ
->
h_ty≥
,

290 
h™dÀ
->
h_löe_no
,

291 
h™dÀ
->
h_ªque°ed_¸edôs
,

292 
h™dÀ
->
h_buf„r_¸edôs
, 
îr
);

295 i‡(
öode
)

296 
	`m¨k_buf„r_dúty_öode
(
bh
, 
öode
);

298 
	`m¨k_buf„r_dúty
(
bh
);

299 i‡(
öode
 && 
	`öode_√eds_sync
(inode)) {

300 
	`sync_dúty_buf„r
(
bh
);

301 i‡(
	`buf„r_ªq
(
bh
Ë&& !
	`buf„r_u±od©e
(bh)) {

302 
pxt4_su≥r_block
 *
es
;

304 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

305 
es
->
s_œ°_îr‹_block
 =

306 
	`˝u_to_À64
(
bh
->
b_blockƒ
);

307 
	`pxt4_îr‹_öode
(
öode
, 
whîe
, 
löe
,

308 
bh
->
b_blockƒ
,

310 
îr
 = -
EIO
;

314  
îr
;

315 
	}
}

317 
	$__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

318 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
)

320 
buf„r_hód
 *
bh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

321 
îr
 = 0;

323 
	`pxt4_su≥rblock_csum_£t
(
sb
);

324 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

325 
îr
 = 
	`jbd3_jou∫Æ_dúty_mëad©a
(
h™dÀ
, 
bh
);

326 i‡(
îr
)

327 
	`pxt4_jou∫Æ_ab‹t_h™dÀ
(
whîe
, 
löe
, 
__func__
,

328 
bh
, 
h™dÀ
, 
îr
);

330 
	`m¨k_buf„r_dúty
(
bh
);

331  
îr
;

332 
	}
}

	@pxt4_jbd3.h

12 #i‚de‡
_PXT4_JBD3_H


13 
	#_PXT4_JBD3_H


	)

15 
	~<löux/fs.h
>

16 
	~<löux/jbd3.h
>

17 
	~"pxt4.h
"

19 
	#PXT4_JOURNAL
(
öode
Ë(
	`PXT4_SB
((öode)->
i_sb
)->
s_jou∫Æ
)

	)

33 
	#PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
) \

34 (
	`pxt4_has_„©uª_exã¡s
(
sb
Ë? 20U : 8U)

	)

40 
	#PXT4_XATTR_TRANS_BLOCKS
 6U

	)

48 
	#PXT4_DATA_TRANS_BLOCKS
(
sb
Ë(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(sb) + \

49 
PXT4_XATTR_TRANS_BLOCKS
 - 2 + \

50 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

57 
	#PXT4_META_TRANS_BLOCKS
(
sb
Ë(
PXT4_XATTR_TRANS_BLOCKS
 + \

58 
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
))

	)

66 
	#PXT4_MAX_TRANS_DATA
 64U

	)

75 
	#PXT4_RESERVE_TRANS_BLOCKS
 12U

	)

84 
	#PXT4_INDEX_EXTRA_TRANS_BLOCKS
 12U

	)

86 #ifde‡
CONFIG_QUOTA


89 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

90 
	`pxt4_has_„©uª_quŸa
(
sb
)Ë? 1 : 0)

	)

93 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

94 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

95 (
DQUOT_INIT_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

96 +3+
DQUOT_INIT_REWRITE
Ë: 0)

	)

98 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë((
	`ã°_›t
(sb, 
QUOTA
) ||\

99 
	`pxt4_has_„©uª_quŸa
(
sb
)) ?\

100 (
DQUOT_DEL_ALLOC
*(
	`PXT4_SINGLEDATA_TRANS_BLOCKS
(
sb
)-3)\

101 +3+
DQUOT_DEL_REWRITE
Ë: 0)

	)

103 
	#PXT4_QUOTA_TRANS_BLOCKS
(
sb
Ë0

	)

104 
	#PXT4_QUOTA_INIT_BLOCKS
(
sb
Ë0

	)

105 
	#PXT4_QUOTA_DEL_BLOCKS
(
sb
Ë0

	)

107 
	#PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_TRANS_BLOCKS
(sb))

	)

108 
	#PXT4_MAXQUOTAS_INIT_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_INIT_BLOCKS
(sb))

	)

109 
	#PXT4_MAXQUOTAS_DEL_BLOCKS
(
sb
Ë(
PXT4_MAXQUOTAS
*
	`PXT4_QUOTA_DEL_BLOCKS
(sb))

	)

114 
	#PXT4_HT_MISC
 0

	)

115 
	#PXT4_HT_INODE
 1

	)

116 
	#PXT4_HT_WRITE_PAGE
 2

	)

117 
	#PXT4_HT_MAP_BLOCKS
 3

	)

118 
	#PXT4_HT_DIR
 4

	)

119 
	#PXT4_HT_TRUNCATE
 5

	)

120 
	#PXT4_HT_QUOTA
 6

	)

121 
	#PXT4_HT_RESIZE
 7

	)

122 
	#PXT4_HT_MIGRATE
 8

	)

123 
	#PXT4_HT_MOVE_EXTENTS
 9

	)

124 
	#PXT4_HT_XATTR
 10

	)

125 
	#PXT4_HT_EXT_CONVERT
 11

	)

126 
	#PXT4_HT_MAX
 12

	)

136 
	spxt4_jou∫Æ_cb_íåy
 {

138 
li°_hód
 
	mj˚_li°
;

141 (*
	mj˚_func
)(
su≥r_block
 *
	msb
,

142 
pxt4_jou∫Æ_cb_íåy
 *
	mj˚
, 
	mîr‹
);

168 
ölöe
 
	$_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

169 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

172 
	`li°_add_èû
(&
j˚
->
j˚_li°
, &
h™dÀ
->
h_å™ß˘i⁄
->
t_¥iv©e_li°
);

173 
	}
}

175 
ölöe
 
	$pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ_t
 *
h™dÀ
,

176 (*
func
)(
su≥r_block
 *
sb
,

177 
pxt4_jou∫Æ_cb_íåy
 *
j˚
,

178 
rc
),

179 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

181 
pxt4_sb_öfo
 *
sbi
 =

182 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

185 
j˚
->
j˚_func
 = 
func
;

186 
	`•ö_lock
(&
sbi
->
s_md_lock
);

187 
	`_pxt4_jou∫Æ_ˇŒback_add
(
h™dÀ
, 
j˚
);

188 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

189 
	}
}

198 
ölöe
 
boﬁ
 
	$pxt4_jou∫Æ_ˇŒback_åy_dñ
(
h™dÀ_t
 *
h™dÀ
,

199 
pxt4_jou∫Æ_cb_íåy
 *
j˚
)

201 
boﬁ
 
dñëed
;

202 
pxt4_sb_öfo
 *
sbi
 =

203 
	`PXT4_SB
(
h™dÀ
->
h_å™ß˘i⁄
->
t_jou∫Æ
->
j_¥iv©e
);

205 
	`•ö_lock
(&
sbi
->
s_md_lock
);

206 
dñëed
 = !
	`li°_em±y
(&
j˚
->
j˚_li°
);

207 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

208 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

209  
dñëed
;

210 
	}
}

213 
pxt4_m¨k_ûoc_dúty
(
h™dÀ_t
 *
h™dÀ
,

214 
öode
 *inode,

215 
pxt4_ûoc
 *
ûoc
);

222 
pxt4_ª£rve_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

223 
pxt4_ûoc
 *
ûoc
);

225 
pxt4_m¨k_öode_dúty
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode);

227 
pxt4_ex∑nd_exåa_isize
(
öode
 *inode,

228 
√w_exåa_isize
,

229 
pxt4_ûoc
 *
ûoc
);

233 
__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(c⁄° *
whîe
, 
löe
,

234 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

236 
__pxt4_f‹gë
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
,

237 
is_mëad©a
, 
öode
 *inode,

238 
buf„r_hód
 *
bh
, 
pxt4_fsblk_t
 
blockƒ
);

240 
__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(c⁄° *
whîe
, 
löe
,

241 
h™dÀ_t
 *
h™dÀ
, 
buf„r_hód
 *
bh
);

243 
__pxt4_h™dÀ_dúty_mëad©a
(c⁄° *
whîe
, 
löe
,

244 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

245 
buf„r_hód
 *
bh
);

247 
__pxt4_h™dÀ_dúty_su≥r
(c⁄° *
whîe
, 
löe
,

248 
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
);

250 
	#pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
) \

251 
	`__pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

252 
	#pxt4_f‹gë
(
h™dÀ
, 
is_mëad©a
, 
öode
, 
bh
, 
block_ƒ
) \

253 
	`__pxt4_f‹gë
(
__func__
, 
__LINE__
, (
h™dÀ
), (
is_mëad©a
), (
öode
), \

254 (
bh
), (
block_ƒ
))

	)

255 
	#pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
bh
) \

256 
	`__pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
__func__
, 
__LINE__
, (
h™dÀ
), (
bh
))

	)

257 
	#pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
) \

258 
	`__pxt4_h™dÀ_dúty_mëad©a
(
__func__
, 
__LINE__
, (
h™dÀ
), (
öode
), \

259 (
bh
))

	)

260 
	#pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
) \

261 
	`__pxt4_h™dÀ_dúty_su≥r
(
__func__
, 
__LINE__
, (
h™dÀ
), (
sb
))

	)

263 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_sb
(
su≥r_block
 *
sb
, 
löe
,

264 
ty≥
, 
blocks
, 
rsv_blocks
);

265 
__pxt4_jou∫Æ_°›
(c⁄° *
whîe
, 
löe
, 
h™dÀ_t
 *
h™dÀ
);

267 
	#PXT4_NOJOURNAL_MAX_REF_COUNT
 ((Ë4096)

	)

271 
ölöe
 
	$pxt4_h™dÀ_vÆid
(
h™dÀ_t
 *
h™dÀ
)

273 i‡(()
h™dÀ
 < 
PXT4_NOJOURNAL_MAX_REF_COUNT
)

276 
	}
}

278 
ölöe
 
	$pxt4_h™dÀ_sync
(
h™dÀ_t
 *
h™dÀ
)

280 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

281 
h™dÀ
->
h_sync
 = 1;

282 
	}
}

284 
ölöe
 
	$pxt4_h™dÀ_is_ab‹ãd
(
h™dÀ_t
 *
h™dÀ
)

286 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

287  
	`is_h™dÀ_ab‹ãd
(
h™dÀ
);

289 
	}
}

291 
ölöe
 
	$pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
√eded
)

293 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& h™dÀ->
h_buf„r_¸edôs
 < 
√eded
)

296 
	}
}

298 
	#pxt4_jou∫Æ_°¨t_sb
(
sb
, 
ty≥
, 
nblocks
) \

299 
	`__pxt4_jou∫Æ_°¨t_sb
((
sb
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

301 
	#pxt4_jou∫Æ_°¨t
(
öode
, 
ty≥
, 
nblocks
) \

302 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
nblocks
), 0)

	)

304 
	#pxt4_jou∫Æ_°¨t_wôh_ª£rve
(
öode
, 
ty≥
, 
blocks
, 
rsv_blocks
) \

305 
	`__pxt4_jou∫Æ_°¨t
((
öode
), 
__LINE__
, (
ty≥
), (
blocks
), (
rsv_blocks
))

	)

307 
ölöe
 
h™dÀ_t
 *
	$__pxt4_jou∫Æ_°¨t
(
öode
 *inode,

308 
löe
, 
ty≥
,

309 
blocks
, 
rsv_blocks
)

311  
	`__pxt4_jou∫Æ_°¨t_sb
(
öode
->
i_sb
, 
löe
, 
ty≥
, 
blocks
,

312 
rsv_blocks
);

313 
	}
}

315 
	#pxt4_jou∫Æ_°›
(
h™dÀ
) \

316 
	`__pxt4_jou∫Æ_°›
(
__func__
, 
__LINE__
, (
h™dÀ
))

	)

318 
	#pxt4_jou∫Æ_°¨t_ª£rved
(
h™dÀ
, 
ty≥
) \

319 
	`__pxt4_jou∫Æ_°¨t_ª£rved
((
h™dÀ
), 
__LINE__
, (
ty≥
))

	)

321 
h™dÀ_t
 *
__pxt4_jou∫Æ_°¨t_ª£rved
(h™dÀ_à*
h™dÀ
, 
löe
,

322 
ty≥
);

324 
ölöe
 
	$pxt4_jou∫Æ_‰ì_ª£rved
(
h™dÀ_t
 *
h™dÀ
)

326 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

327 
	`jbd3_jou∫Æ_‰ì_ª£rved
(
h™dÀ
);

328 
	}
}

330 
ölöe
 
h™dÀ_t
 *
	$pxt4_jou∫Æ_cuºít_h™dÀ
()

332  
	`jou∫Æ_cuºít_h™dÀ
();

333 
	}
}

335 
ölöe
 
	$pxt4_jou∫Æ_exãnd
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

337 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

338  
	`jbd3_jou∫Æ_exãnd
(
h™dÀ
, 
nblocks
);

340 
	}
}

342 
ölöe
 
	$pxt4_jou∫Æ_ª°¨t
(
h™dÀ_t
 *
h™dÀ
, 
nblocks
)

344 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

345  
	`jbd3_jou∫Æ_ª°¨t
(
h™dÀ
, 
nblocks
);

347 
	}
}

349 
ölöe
 
	$pxt4_jou∫Æ_blocks_≥r_∑ge
(
öode
 *inode)

351 i‡(
	`PXT4_JOURNAL
(
öode
Ë!
NULL
)

352  
	`jbd3_jou∫Æ_blocks_≥r_∑ge
(
öode
);

354 
	}
}

356 
ölöe
 
	$pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ_t
 *
jou∫Æ
)

358 i‡(
jou∫Æ
)

359  
	`jbd3_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

361 
	}
}

363 
ölöe
 
	$pxt4_jbd3_öode_add_wrôe
(
h™dÀ_t
 *
h™dÀ
,

364 
öode
 *inode)

366 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

367  
	`jbd3_jou∫Æ_öode_add_wrôe
(
h™dÀ
,

368 
	`PXT4_I
(
öode
)->
jöode
);

370 
	}
}

372 
ölöe
 
	$pxt4_jbd3_öode_add_waô
(
h™dÀ_t
 *
h™dÀ
,

373 
öode
 *inode)

375 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

376  
	`jbd3_jou∫Æ_öode_add_waô
(
h™dÀ
,

377 
	`PXT4_I
(
öode
)->
jöode
);

379 
	}
}

381 
ölöe
 
	$pxt4_upd©e_öode_fsync_å™s
(
h™dÀ_t
 *
h™dÀ
,

382 
öode
 *inode,

383 
d©async
)

385 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

387 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
Ë&& !
	`is_h™dÀ_ab‹ãd
(handle)) {

388 
ei
->
i_sync_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

389 i‡(
d©async
)

390 
ei
->
i_d©async_tid
 = 
h™dÀ
->
h_å™ß˘i⁄
->
t_tid
;

392 
	}
}

395 
pxt4_f‹˚_commô
(
su≥r_block
 *
sb
);

400 
	#PXT4_INODE_JOURNAL_DATA_MODE
 0x01

	)

401 
	#PXT4_INODE_ORDERED_DATA_MODE
 0x02

	)

402 
	#PXT4_INODE_WRITEBACK_DATA_MODE
 0x04

	)

404 
ölöe
 
	$pxt4_öode_jou∫Æ_mode
(
öode
 *inode)

406 i‡(
	`PXT4_JOURNAL
(
öode
Ë=
NULL
)

407  
PXT4_INODE_WRITEBACK_DATA_MODE
;

409 i‡(!
	`S_ISREG
(
öode
->
i_mode
) ||

410 
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
 ||

411 (
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_JOURNAL_DATA
) &&

412 !
	`ã°_›t
(
öode
->
i_sb
, 
DELALLOC
))) {

414 i‡(
	`S_ISREG
(
öode
->
i_mode
Ë&& 
	`IS_ENCRYPTED
(inode))

415  
PXT4_INODE_ORDERED_DATA_MODE
;

416  
PXT4_INODE_JOURNAL_DATA_MODE
;

418 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

419  
PXT4_INODE_ORDERED_DATA_MODE
;

420 i‡(
	`ã°_›t
(
öode
->
i_sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

421  
PXT4_INODE_WRITEBACK_DATA_MODE
;

422 
	`BUG
();

423 
	}
}

425 
ölöe
 
	$pxt4_should_jou∫Æ_d©a
(
öode
 *inode)

427  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_JOURNAL_DATA_MODE
;

428 
	}
}

430 
ölöe
 
	$pxt4_should_‹dî_d©a
(
öode
 *inode)

432  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_ORDERED_DATA_MODE
;

433 
	}
}

435 
ölöe
 
	$pxt4_should_wrôeback_d©a
(
öode
 *inode)

437  
	`pxt4_öode_jou∫Æ_mode
(
öode
Ë& 
PXT4_INODE_WRITEBACK_DATA_MODE
;

438 
	}
}

449 
ölöe
 
	$pxt4_should_di‹ód_nﬁock
(
öode
 *inode)

451 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
DIOREAD_NOLOCK
))

453 i‡(!
	`S_ISREG
(
öode
->
i_mode
))

455 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

457 i‡(
	`pxt4_should_jou∫Æ_d©a
(
öode
))

460 
	}
}

	@readpage.c

31 
	~<löux/kî√l.h
>

32 
	~<löux/exp‹t.h
>

33 
	~<löux/mm.h
>

34 
	~<löux/kdev_t.h
>

35 
	~<löux/gÂ.h
>

36 
	~<löux/bio.h
>

37 
	~<löux/fs.h
>

38 
	~<löux/buf„r_hód.h
>

39 
	~<löux/blkdev.h
>

40 
	~<löux/highmem.h
>

41 
	~<löux/¥e„tch.h
>

42 
	~<löux/m∑ge.h
>

43 
	~<löux/wrôeback.h
>

44 
	~<löux/backög-dev.h
>

45 
	~<löux/∑gevec.h
>

46 
	~<löux/˛ónˇche.h
>

48 
	~"pxt4.h
"

50 
ölöe
 
boﬁ
 
	$pxt4_bio_í¸y±ed
(
bio
 *bio)

52 #ifde‡
CONFIG_FS_ENCRYPTION


53  
	`u∆ikñy
(
bio
->
bi_¥iv©e
 !
NULL
);

55  
Ál£
;

57 
	}
}

71 
	$m∑ge_íd_io
(
bio
 *bio)

73 
bio_vec
 *
bv
;

74 
i
;

75 
bvec_ôî_Æl
 
ôî_Æl
;

77 i‡(
	`pxt4_bio_í¸y±ed
(
bio
)) {

78 i‡(
bio
->
bi_°©us
) {

79 
	`fs¸y±_ªÀa£_˘x
(
bio
->
bi_¥iv©e
);

81 
	`fs¸y±_íqueue_de¸y±_bio
(
bio
->
bi_¥iv©e
, bio);

85 
	`bio_f‹_óch_£gmít_Æl
(
bv
, 
bio
, 
i
, 
ôî_Æl
) {

86 
∑ge
 *∑gê
bv
->
bv_∑ge
;

88 i‡(!
bio
->
bi_°©us
) {

89 
	`SëPageU±od©e
(
∑ge
);

91 
	`CÀ¨PageU±od©e
(
∑ge
);

92 
	`SëPageEº‹
(
∑ge
);

94 
	`u∆ock_∑ge
(
∑ge
);

97 
	`bio_put
(
bio
);

98 
	}
}

100 
	$pxt4_m∑ge_ªad∑ges
(
addªss_•a˚
 *
m≠pög
,

101 
li°_hód
 *
∑ges
, 
∑ge
 *page,

102 
ƒ_∑ges
, 
boﬁ
 
is_ªadahód
)

104 
bio
 *biÿ
NULL
;

105 
£˘‹_t
 
œ°_block_ö_bio
 = 0;

107 
öode
 *öodê
m≠pög
->
ho°
;

108 c⁄° 
blkbôs
 = 
öode
->
i_blkbôs
;

109 c⁄° 
blocks_≥r_∑ge
 = 
PAGE_SIZE
 >> 
blkbôs
;

110 c⁄° 
blocksize
 = 1 << 
blkbôs
;

111 
£˘‹_t
 
block_ö_fûe
;

112 
£˘‹_t
 
œ°_block
;

113 
£˘‹_t
 
œ°_block_ö_fûe
;

114 
£˘‹_t
 
blocks
[
MAX_BUF_PER_PAGE
];

115 
∑ge_block
;

116 
block_devi˚
 *
bdev
 = 
öode
->
i_sb
->
s_bdev
;

117 
Àngth
;

118 
ªœtive_block
 = 0;

119 
pxt4_m≠_blocks
 
m≠
;

121 
m≠
.
m_pblk
 = 0;

122 
m≠
.
m_lblk
 = 0;

123 
m≠
.
m_Àn
 = 0;

124 
m≠
.
m_Êags
 = 0;

126 ; 
ƒ_∑ges
;Çr_pages--) {

127 
fuŒy_m≠≥d
 = 1;

128 
fú°_hﬁe
 = 
blocks_≥r_∑ge
;

130 
	`¥e„tchw
(&
∑ge
->
Êags
);

131 i‡(
∑ges
) {

132 
∑ge
 = 
	`Ãu_to_∑ge
(
∑ges
);

133 
	`li°_dñ
(&
∑ge
->
Ãu
);

134 i‡(
	`add_to_∑ge_ˇche_Ãu
(
∑ge
, 
m≠pög
,Öage->
ödex
,

135 
	`ªadahód_gÂ_mask
(
m≠pög
)))

136 
√xt_∑ge
;

139 i‡(
	`∑ge_has_buf„rs
(
∑ge
))

140 
c⁄fu£d
;

142 
block_ö_fûe
 = (
£˘‹_t
)
∑ge
->
ödex
 << (
PAGE_SHIFT
 - 
blkbôs
);

143 
œ°_block
 = 
block_ö_fûe
 + 
ƒ_∑ges
 * 
blocks_≥r_∑ge
;

144 
œ°_block_ö_fûe
 = (
	`i_size_ªad
(
öode
Ë+ 
blocksize
 - 1Ë>> 
blkbôs
;

145 i‡(
œ°_block
 > 
œ°_block_ö_fûe
)

146 
œ°_block
 = 
œ°_block_ö_fûe
;

147 
∑ge_block
 = 0;

152 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) &&

153 
block_ö_fûe
 > 
m≠
.
m_lblk
 &&

154 
block_ö_fûe
 < (
m≠
.
m_lblk
 + m≠.
m_Àn
)) {

155 
m≠_off£t
 = 
block_ö_fûe
 - 
m≠
.
m_lblk
;

156 
œ°
 = 
m≠
.
m_Àn
 - 
m≠_off£t
;

158 
ªœtive_block
 = 0; ;Ñelative_block++) {

159 i‡(
ªœtive_block
 =
œ°
) {

161 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

164 i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

166 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
 + 
m≠_off£t
 +

167 
ªœtive_block
;

168 
∑ge_block
++;

169 
block_ö_fûe
++;

177 
∑ge_block
 < 
blocks_≥r_∑ge
) {

178 i‡(
block_ö_fûe
 < 
œ°_block
) {

179 
m≠
.
m_lblk
 = 
block_ö_fûe
;

180 
m≠
.
m_Àn
 = 
œ°_block
 - 
block_ö_fûe
;

182 i‡(
	`pxt4_m≠_blocks
(
NULL
, 
öode
, &
m≠
, 0) < 0) {

183 
£t_îr‹_∑ge
:

184 
	`SëPageEº‹
(
∑ge
);

185 
	`zîo_u£r_£gmít
(
∑ge
, 0,

186 
PAGE_SIZE
);

187 
	`u∆ock_∑ge
(
∑ge
);

188 
√xt_∑ge
;

191 i‡((
m≠
.
m_Êags
 & 
PXT4_MAP_MAPPED
) == 0) {

192 
fuŒy_m≠≥d
 = 0;

193 i‡(
fú°_hﬁe
 =
blocks_≥r_∑ge
)

194 
fú°_hﬁe
 = 
∑ge_block
;

195 
∑ge_block
++;

196 
block_ö_fûe
++;

199 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
)

200 
c⁄fu£d
;

203 i‡(
∑ge_block
 && 
blocks
[∑ge_block-1] !
m≠
.
m_pblk
-1)

204 
c⁄fu£d
;

205 
ªœtive_block
 = 0; ;Ñelative_block++) {

206 i‡(
ªœtive_block
 =
m≠
.
m_Àn
) {

208 
m≠
.
m_Êags
 &~
PXT4_MAP_MAPPED
;

210 } i‡(
∑ge_block
 =
blocks_≥r_∑ge
)

212 
blocks
[
∑ge_block
] = 
m≠
.
m_pblk
+
ªœtive_block
;

213 
∑ge_block
++;

214 
block_ö_fûe
++;

217 i‡(
fú°_hﬁe
 !
blocks_≥r_∑ge
) {

218 
	`zîo_u£r_£gmít
(
∑ge
, 
fú°_hﬁe
 << 
blkbôs
,

219 
PAGE_SIZE
);

220 i‡(
fú°_hﬁe
 == 0) {

221 
	`SëPageU±od©e
(
∑ge
);

222 
	`u∆ock_∑ge
(
∑ge
);

223 
√xt_∑ge
;

225 } i‡(
fuŒy_m≠≥d
) {

226 
	`SëPageM≠≥dToDisk
(
∑ge
);

228 i‡(
fuŒy_m≠≥d
 && 
blocks_≥r_∑ge
 == 1 &&

229 !
	`PageU±od©e
(
∑ge
Ë&& 
	`˛ónˇche_gë_∑ge
(page) == 0) {

230 
	`SëPageU±od©e
(
∑ge
);

231 
c⁄fu£d
;

238 i‡(
bio
 && (
œ°_block_ö_bio
 !
blocks
[0] - 1)) {

239 
submô_™d_ªÆloc
:

240 
	`submô_bio
(
bio
);

241 
bio
 = 
NULL
;

243 i‡(
bio
 =
NULL
) {

244 
fs¸y±_˘x
 *
˘x
 = 
NULL
;

246 i‡(
	`IS_ENCRYPTED
(
öode
Ë&& 
	`S_ISREG
(öode->
i_mode
)) {

247 
˘x
 = 
	`fs¸y±_gë_˘x
(
öode
, 
GFP_NOFS
);

248 i‡(
	`IS_ERR
(
˘x
))

249 
£t_îr‹_∑ge
;

251 
bio
 = 
	`bio_Æloc
(
GFP_KERNEL
,

252 
	`mö_t
(, 
ƒ_∑ges
, 
BIO_MAX_PAGES
));

253 i‡(!
bio
) {

254 i‡(
˘x
)

255 
	`fs¸y±_ªÀa£_˘x
(
˘x
);

256 
£t_îr‹_∑ge
;

258 
	`bio_£t_dev
(
bio
, 
bdev
);

259 
bio
->
bi_ôî
.
bi_£˘‹
 = 
blocks
[0] << (
blkbôs
 - 9);

260 
bio
->
bi_íd_io
 = 
m∑ge_íd_io
;

261 
bio
->
bi_¥iv©e
 = 
˘x
;

262 
	`bio_£t_›_©ås
(
bio
, 
REQ_OP_READ
,

263 
is_ªadahód
 ? 
REQ_RAHEAD
 : 0);

266 
Àngth
 = 
fú°_hﬁe
 << 
blkbôs
;

267 i‡(
	`bio_add_∑ge
(
bio
, 
∑ge
, 
Àngth
, 0) <Üength)

268 
submô_™d_ªÆloc
;

270 i‡(((
m≠
.
m_Êags
 & 
PXT4_MAP_BOUNDARY
) &&

271 (
ªœtive_block
 =
m≠
.
m_Àn
)) ||

272 (
fú°_hﬁe
 !
blocks_≥r_∑ge
)) {

273 
	`submô_bio
(
bio
);

274 
bio
 = 
NULL
;

276 
œ°_block_ö_bio
 = 
blocks
[
blocks_≥r_∑ge
 - 1];

277 
√xt_∑ge
;

278 
c⁄fu£d
:

279 i‡(
bio
) {

280 
	`submô_bio
(
bio
);

281 
bio
 = 
NULL
;

283 i‡(!
	`PageU±od©e
(
∑ge
))

284 
	`block_ªad_fuŒ_∑ge
(
∑ge
, 
pxt4_gë_block
);

286 
	`u∆ock_∑ge
(
∑ge
);

287 
√xt_∑ge
:

288 i‡(
∑ges
)

289 
	`put_∑ge
(
∑ge
);

291 
	`BUG_ON
(
∑ges
 && !
	`li°_em±y
(pages));

292 i‡(
bio
)

293 
	`submô_bio
(
bio
);

295 
	}
}

	@resize.c

13 
	#PXT4FS_DEBUG


	)

15 
	~<löux/î∫o.h
>

16 
	~<löux/¶ab.h
>

18 
	~"pxt4_jbd3.h
"

20 
	$pxt4_ªsize_begö
(
su≥r_block
 *
sb
)

22 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

23 
ªt
 = 0;

25 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_RESOURCE
))

26  -
EPERM
;

33 i‡(
	`PXT4_B2C
(
sbi
, sbi->
s_sbh
->
b_blockƒ
) !=

34 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_fú°_d©a_block
)) {

35 
	`pxt4_w¨nög
(
sb
, "won'tÑesize using backup superblockát %llu",

36 ()
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
);

37  -
EPERM
;

44 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

45 
	`pxt4_w¨nög
(
sb
, "ThereáreÉrrors inÅhe filesystem, "

47  -
EPERM
;

50 i‡(
	`ã°_™d_£t_bô_lock
(
PXT4_FLAGS_RESIZING
,

51 &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
))

52 
ªt
 = -
EBUSY
;

54  
ªt
;

55 
	}
}

57 
	$pxt4_ªsize_íd
(
su≥r_block
 *
sb
)

59 
	`˛ór_bô_u∆ock
(
PXT4_FLAGS_RESIZING
, &
	`PXT4_SB
(
sb
)->
s_pxt4_Êags
);

60 
	`smp_mb__a·î_©omic
();

61 
	}
}

63 
pxt4_group_t
 
	$pxt4_mëa_bg_fú°_group
(
su≥r_block
 *
sb
,

64 
pxt4_group_t
 
group
) {

65  (
group
 >> 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
)) <<

66 
	`PXT4_DESC_PER_BLOCK_BITS
(
sb
);

67 
	}
}

69 
pxt4_fsblk_t
 
	$pxt4_mëa_bg_fú°_block_no
(
su≥r_block
 *
sb
,

70 
pxt4_group_t
 
group
) {

71 
group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, group);

72  
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

73 
	}
}

75 
pxt4_gΩblk_t
 
	$pxt4_group_ovîhód_blocks
(
su≥r_block
 *
sb
,

76 
pxt4_group_t
 
group
) {

77 
pxt4_gΩblk_t
 
ovîhód
;

78 
ovîhód
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

79 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

80 
ovîhód
 += 1 +

81 
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

82  
ovîhód
;

83 
	}
}

85 
	#outside
(
b
, 
fú°
, 
œ°
Ë((bË< (fú°Ë|| (bË>÷a°))

	)

86 
	#öside
(
b
, 
fú°
, 
œ°
Ë((bË>(fú°Ë&& (bË< (œ°))

	)

88 
	$vîify_group_öput
(
su≥r_block
 *
sb
,

89 
pxt4_√w_group_d©a
 *
öput
)

91 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

92 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

93 
pxt4_fsblk_t
 
°¨t
 = 
	`pxt4_blocks_cou¡
(
es
);

94 
pxt4_fsblk_t
 
íd
 = 
°¨t
 + 
öput
->
blocks_cou¡
;

95 
pxt4_group_t
 
group
 = 
öput
->group;

96 
pxt4_fsblk_t
 
ôíd
 = 
öput
->
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
;

97 
ovîhód
;

98 
pxt4_fsblk_t
 
më´nd
;

99 
buf„r_hód
 *
bh
 = 
NULL
;

100 
pxt4_gΩblk_t
 
‰ì_blocks_cou¡
, 
off£t
;

101 
îr
 = -
EINVAL
;

103 i‡(
group
 !
sbi
->
s_groups_cou¡
) {

104 
	`pxt4_w¨nög
(
sb
, "Cannotáddát group %u (only %u groups)",

105 
öput
->
group
, 
sbi
->
s_groups_cou¡
);

106  -
EINVAL
;

109 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

110 
më´nd
 = 
°¨t
 + 
ovîhód
;

111 
öput
->
‰ì_˛u°îs_cou¡
 = 
‰ì_blocks_cou¡
 =

112 
öput
->
blocks_cou¡
 - 2 - 
ovîhód
 - 
sbi
->
s_ôb_≥r_group
;

114 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

115 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádding %s group %u: %u blocks "

117 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ? "normal" :

118 "no-su≥r", 
öput
->
group
, i≈ut->
blocks_cou¡
,

119 
‰ì_blocks_cou¡
, 
öput
->
ª£rved_blocks
);

121 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
°¨t
, 
NULL
, &
off£t
);

122 i‡(
off£t
 != 0)

123 
	`pxt4_w¨nög
(
sb
, "Last groupÇot full");

124 i‡(
öput
->
ª£rved_blocks
 > i≈ut->
blocks_cou¡
 / 5)

125 
	`pxt4_w¨nög
(
sb
, "Reserved blocksÅoo high (%u)",

126 
öput
->
ª£rved_blocks
);

127 i‡(
‰ì_blocks_cou¡
 < 0)

128 
	`pxt4_w¨nög
(
sb
, "Bad blocks count %u",

129 
öput
->
blocks_cou¡
);

130 i‡(
	`IS_ERR
(
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
íd
 - 1, 0))) {

131 
îr
 = 
	`PTR_ERR
(
bh
);

132 
bh
 = 
NULL
;

133 
	`pxt4_w¨nög
(
sb
, "CannotÑeadÜast block (%llu)",

134 
íd
 - 1);

135 } i‡(
	`outside
(
öput
->
block_bôm≠
, 
°¨t
, 
íd
))

136 
	`pxt4_w¨nög
(
sb
, "Block bitmapÇot in group (block %llu)",

137 ()
öput
->
block_bôm≠
);

138 i‡(
	`outside
(
öput
->
öode_bôm≠
, 
°¨t
, 
íd
))

139 
	`pxt4_w¨nög
(
sb
, "Inode bitmapÇot in group (block %llu)",

140 ()
öput
->
öode_bôm≠
);

141 i‡(
	`outside
(
öput
->
öode_èbÀ
, 
°¨t
, 
íd
) ||

142 
	`outside
(
ôíd
 - 1, 
°¨t
, 
íd
))

143 
	`pxt4_w¨nög
(
sb
, "InodeÅableÇot in group (blocks %llu-%llu)",

144 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

145 i‡(
öput
->
öode_bôm≠
 =öput->
block_bôm≠
)

146 
	`pxt4_w¨nög
(
sb
, "Block bitmap sameás inode bitmap (%llu)",

147 ()
öput
->
block_bôm≠
);

148 i‡(
	`öside
(
öput
->
block_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

149 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in inodeÅable "

151 ()
öput
->
block_bôm≠
,

152 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

153 i‡(
	`öside
(
öput
->
öode_bôm≠
, i≈ut->
öode_èbÀ
, 
ôíd
))

154 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in inodeÅable "

156 ()
öput
->
öode_bôm≠
,

157 ()
öput
->
öode_èbÀ
, 
ôíd
 - 1);

158 i‡(
	`öside
(
öput
->
block_bôm≠
, 
°¨t
, 
më´nd
))

159 
	`pxt4_w¨nög
(
sb
, "Block bitmap (%llu) in GDTÅable (%llu-%llu)",

160 ()
öput
->
block_bôm≠
,

161 
°¨t
, 
më´nd
 - 1);

162 i‡(
	`öside
(
öput
->
öode_bôm≠
, 
°¨t
, 
më´nd
))

163 
	`pxt4_w¨nög
(
sb
, "Inode bitmap (%llu) in GDTÅable (%llu-%llu)",

164 ()
öput
->
öode_bôm≠
,

165 
°¨t
, 
më´nd
 - 1);

166 i‡(
	`öside
(
öput
->
öode_èbÀ
, 
°¨t
, 
më´nd
) ||

167 
	`öside
(
ôíd
 - 1, 
°¨t
, 
më´nd
))

168 
	`pxt4_w¨nög
(
sb
, "InodeÅable (%llu-%llu) overlaps GDTÅable "

170 ()
öput
->
öode_èbÀ
,

171 
ôíd
 - 1, 
°¨t
, 
më´nd
 - 1);

173 
îr
 = 0;

174 
	`bªl£
(
bh
);

176  
îr
;

177 
	}
}

183 
	spxt4_√w_Êex_group_d©a
 {

184 
pxt4_√w_group_d©a
 *
	mgroups
;

186 
__u16
 *
	mbg_Êags
;

188 
pxt4_group_t
 
	mcou¡
;

198 
pxt4_√w_Êex_group_d©a
 *
	$Æloc_Êex_gd
(
Êexbg_size
)

200 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
;

202 
Êex_gd
 = 
	`kmÆloc
((*Êex_gd), 
GFP_NOFS
);

203 i‡(
Êex_gd
 =
NULL
)

204 
out3
;

206 i‡(
Êexbg_size
 >
UINT_MAX
 / (
pxt4_√w_group_d©a
))

207 
out2
;

208 
Êex_gd
->
cou¡
 = 
Êexbg_size
;

210 
Êex_gd
->
groups
 = 
	`kmÆloc_¨øy
(
Êexbg_size
,

211 (
pxt4_√w_group_d©a
),

212 
GFP_NOFS
);

213 i‡(
Êex_gd
->
groups
 =
NULL
)

214 
out2
;

216 
Êex_gd
->
bg_Êags
 = 
	`kmÆloc_¨øy
(
Êexbg_size
, (
__u16
),

217 
GFP_NOFS
);

218 i‡(
Êex_gd
->
bg_Êags
 =
NULL
)

219 
out1
;

221  
Êex_gd
;

223 
out1
:

224 
	`k‰ì
(
Êex_gd
->
groups
);

225 
out2
:

226 
	`k‰ì
(
Êex_gd
);

227 
out3
:

228  
NULL
;

229 
	}
}

231 
	$‰ì_Êex_gd
(
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

233 
	`k‰ì
(
Êex_gd
->
bg_Êags
);

234 
	`k‰ì
(
Êex_gd
->
groups
);

235 
	`k‰ì
(
Êex_gd
);

236 
	}
}

251 
	$pxt4_Æloc_group_èbÀs
(
su≥r_block
 *
sb
,

252 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

253 
Êexbg_size
)

255 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

256 
pxt4_fsblk_t
 
°¨t_blk
;

257 
pxt4_fsblk_t
 
œ°_blk
;

258 
pxt4_group_t
 
§c_group
;

259 
pxt4_group_t
 
bb_ödex
 = 0;

260 
pxt4_group_t
 
ib_ödex
 = 0;

261 
pxt4_group_t
 
ô_ödex
 = 0;

262 
pxt4_group_t
 
group
;

263 
pxt4_group_t
 
œ°_group
;

264 
ovîhód
;

265 
__u16
 
unöô_mask
 = (
Êexbg_size
 > 1Ë? ~
PXT4_BG_BLOCK_UNINIT
 : ~0;

266 
i
;

268 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

270 
§c_group
 = 
group_d©a
[0].
group
;

271 
œ°_group
 = 
§c_group
 + 
Êex_gd
->
cou¡
 - 1;

273 
	`BUG_ON
((
Êexbg_size
 > 1Ë&& ((
§c_group
 & ~(flexbg_size - 1)) !=

274 (
œ°_group
 & ~(
Êexbg_size
 - 1))));

275 
√xt_group
:

276 
group
 = 
group_d©a
[0].group;

277 i‡(
§c_group
 >
group_d©a
[0].
group
 + 
Êex_gd
->
cou¡
)

278  -
ENOSPC
;

279 
°¨t_blk
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
§c_group
);

280 
œ°_blk
 = 
°¨t_blk
 + 
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

282 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

284 
°¨t_blk
 +
ovîhód
;

287 
§c_group
++;

288 ; 
§c_group
 <
œ°_group
; src_group++) {

289 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
§c_group
);

290 i‡(
ovîhód
 == 0)

291 
œ°_blk
 +
group_d©a
[
§c_group
 - 
group
].
blocks_cou¡
;

297 ; 
bb_ödex
 < 
Êex_gd
->
cou¡
; bb_index++) {

298 i‡(
°¨t_blk
 >
œ°_blk
)

299 
√xt_group
;

300 
group_d©a
[
bb_ödex
].
block_bôm≠
 = 
°¨t_blk
++;

301 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

302 
group
 -
group_d©a
[0].group;

303 
group_d©a
[
group
].
md©a_blocks
++;

304 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

308 ; 
ib_ödex
 < 
Êex_gd
->
cou¡
; ib_index++) {

309 i‡(
°¨t_blk
 >
œ°_blk
)

310 
√xt_group
;

311 
group_d©a
[
ib_ödex
].
öode_bôm≠
 = 
°¨t_blk
++;

312 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
 - 1);

313 
group
 -
group_d©a
[0].group;

314 
group_d©a
[
group
].
md©a_blocks
++;

315 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

319 ; 
ô_ödex
 < 
Êex_gd
->
cou¡
; it_index++) {

320 
ôb
 = 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

321 
pxt4_fsblk_t
 
√xt_group_°¨t
;

323 i‡(
°¨t_blk
 + 
ôb
 > 
œ°_blk
)

324 
√xt_group
;

325 
group_d©a
[
ô_ödex
].
öode_èbÀ
 = 
°¨t_blk
;

326 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
°¨t_blk
);

327 
√xt_group_°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
 + 1);

328 
group
 -
group_d©a
[0].group;

330 i‡(
°¨t_blk
 + 
ôb
 > 
√xt_group_°¨t
) {

331 
Êex_gd
->
bg_Êags
[
group
 + 1] &
unöô_mask
;

332 
ovîhód
 = 
°¨t_blk
 + 
ôb
 - 
√xt_group_°¨t
;

333 
group_d©a
[
group
 + 1].
md©a_blocks
 +
ovîhód
;

334 
ôb
 -
ovîhód
;

337 
group_d©a
[
group
].
md©a_blocks
 +
ôb
;

338 
Êex_gd
->
bg_Êags
[
group
] &
unöô_mask
;

339 
°¨t_blk
 +
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
;

343 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

344 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 -=

345 
	`PXT4_NUM_B2C
(
	`PXT4_SB
(
sb
),

346 
group_d©a
[
i
].
md©a_blocks
);

349 i‡(
	`ã°_›t
(
sb
, 
DEBUG
)) {

350 
i
;

351 
group
 = 
group_d©a
[0].group;

353 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:áddingá flex group with "

354 "%d groups, fÀxbg sizêi†%d:\n", 
Êex_gd
->
cou¡
,

355 
Êexbg_size
);

357 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

358 
	`pxt4_debug
(

360 
	`pxt4_bg_has_su≥r
(
sb
, 
group
 + 
i
) ? "normal" :

361 "no-su≥r", 
group
 + 
i
,

362 
group_d©a
[
i
].
blocks_cou¡
,

363 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
,

364 
group_d©a
[
i
].
md©a_blocks
);

368 
	}
}

370 
buf„r_hód
 *
	$b˛ón
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

371 
pxt4_fsblk_t
 
blk
)

373 
buf„r_hód
 *
bh
;

374 
îr
;

376 
bh
 = 
	`sb_gëblk
(
sb
, 
blk
);

377 i‡(
	`u∆ikñy
(!
bh
))

378  
	`ERR_PTR
(-
ENOMEM
);

379 
	`BUFFER_TRACE
(
bh
, "get_write_access");

380 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

381 
	`bªl£
(
bh
);

382 
bh
 = 
	`ERR_PTR
(
îr
);

384 
	`mem£t
(
bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

385 
	`£t_buf„r_u±od©e
(
bh
);

388  
bh
;

389 
	}
}

396 
	$exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ_t
 *
h™dÀ
, 
thªsh
)

398 
îr
;

400 i‡(
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
thªsh
))

403 
îr
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

404 i‡(
îr
 < 0)

405  
îr
;

406 i‡(
îr
) {

407 
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
);

408 i‡(
îr
)

409  
îr
;

413 
	}
}

424 
	$£t_Êexbg_block_bôm≠
(
su≥r_block
 *
sb
, 
h™dÀ_t
 *
h™dÀ
,

425 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

426 
pxt4_fsblk_t
 
fú°_˛u°î
,Öxt4_fsblk_à
œ°_˛u°î
)

428 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

429 
pxt4_group_t
 
cou¡
 = 
œ°_˛u°î
 - 
fú°_˛u°î
 + 1;

430 
pxt4_group_t
 
cou¡2
;

432 
	`pxt4_debug
("m¨k clu°î†[%Œu-%Œu] u£d\n", 
fú°_˛u°î
,

433 
œ°_˛u°î
);

434 
cou¡2
 = 
cou¡
; count > 0;

435 
cou¡
 -
cou¡2
, 
fú°_˛u°î
 += count2) {

436 
pxt4_fsblk_t
 
°¨t
;

437 
buf„r_hód
 *
bh
;

438 
pxt4_group_t
 
group
;

439 
îr
;

441 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
	`PXT4_C2B
(
sbi
, 
fú°_˛u°î
));

442 
°¨t
 = 
	`PXT4_B2C
(
sbi
, 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

443 
group
 -
Êex_gd
->
groups
[0].group;

445 
cou¡2
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
fú°_˛u°î
 - 
°¨t
);

446 i‡(
cou¡2
 > 
cou¡
)

447 
cou¡2
 = 
cou¡
;

449 i‡(
Êex_gd
->
bg_Êags
[
group
] & 
PXT4_BG_BLOCK_UNINIT
) {

450 
	`BUG_ON
(
Êex_gd
->
cou¡
 > 1);

454 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

455 i‡(
îr
)

456  
îr
;

458 
bh
 = 
	`sb_gëblk
(
sb
, 
Êex_gd
->
groups
[
group
].
block_bôm≠
);

459 i‡(
	`u∆ikñy
(!
bh
))

460  -
ENOMEM
;

462 
	`BUFFER_TRACE
(
bh
, "get_write_access");

463 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

464 i‡(
îr
) {

465 
	`bªl£
(
bh
);

466  
îr
;

468 
	`pxt4_debug
("mark block bitmap %#04llx (+%llu/%u)\n",

469 
fú°_˛u°î
, fú°_˛u°î - 
°¨t
, 
cou¡2
);

470 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 
fú°_˛u°î
 - 
°¨t
, 
cou¡2
);

472 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

473 
	`bªl£
(
bh
);

474 i‡(
	`u∆ikñy
(
îr
))

475  
îr
;

479 
	}
}

495 
	$£tup_√w_Êex_group_blocks
(
su≥r_block
 *
sb
,

496 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

498 
group_èbÀ_cou¡
[] = {1, 1, 
	`PXT4_SB
(
sb
)->
s_ôb_≥r_group
};

499 
pxt4_fsblk_t
 
°¨t
;

500 
pxt4_fsblk_t
 
block
;

501 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

502 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

503 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

504 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

505 
h™dÀ_t
 *
h™dÀ
;

506 
pxt4_group_t
 
group
, 
cou¡
;

507 
buf„r_hód
 *
bh
 = 
NULL
;

508 
ª£rved_gdb
, 
i
, 
j
, 
îr
 = 0, 
îr2
;

509 
mëa_bg
;

511 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !
group_d©a
 ||

512 
group_d©a
[0].
group
 !
sbi
->
s_groups_cou¡
);

514 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

515 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

518 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

519 i‡(
	`IS_ERR
(
h™dÀ
))

520  
	`PTR_ERR
(
h™dÀ
);

522 
group
 = 
group_d©a
[0].group;

523 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group
++) {

524 
gdblocks
;

525 
pxt4_gΩblk_t
 
ovîhód
;

527 
gdblocks
 = 
	`pxt4_bg_num_gdb
(
sb
, 
group
);

528 
°¨t
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
group
);

530 i‡(
mëa_bg
 =0 && !
	`pxt4_bg_has_su≥r
(
sb
, 
group
))

531 
h™dÀ_ôb
;

533 i‡(
mëa_bg
 == 1) {

534 
pxt4_group_t
 
fú°_group
;

535 
fú°_group
 = 
	`pxt4_mëa_bg_fú°_group
(
sb
, 
group
);

536 i‡(
fú°_group
 !
group
 + 1 &&

537 
fú°_group
 !
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1)

538 
h™dÀ_ôb
;

541 
block
 = 
°¨t
 + 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

543 
j
 = 0; j < 
gdblocks
; j++, 
block
++) {

544 
buf„r_hód
 *
gdb
;

546 
	`pxt4_debug
("upd©êbacku∞grou∞%#04Œx\n", 
block
);

547 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

548 i‡(
îr
)

549 
out
;

551 
gdb
 = 
	`sb_gëblk
(
sb
, 
block
);

552 i‡(
	`u∆ikñy
(!
gdb
)) {

553 
îr
 = -
ENOMEM
;

554 
out
;

557 
	`BUFFER_TRACE
(
gdb
, "get_write_access");

558 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb
);

559 i‡(
îr
) {

560 
	`bªl£
(
gdb
);

561 
out
;

563 
	`mem˝y
(
gdb
->
b_d©a
, 
sbi
->
s_group_desc
[
j
]->b_data,

564 
gdb
->
b_size
);

565 
	`£t_buf„r_u±od©e
(
gdb
);

567 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb
);

568 i‡(
	`u∆ikñy
(
îr
)) {

569 
	`bªl£
(
gdb
);

570 
out
;

572 
	`bªl£
(
gdb
);

578 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
group
)) {

579 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
gdblocks
 + 
°¨t
 + 1,

580 
ª£rved_gdb
, 
GFP_NOFS
);

581 i‡(
îr
)

582 
out
;

585 
h™dÀ_ôb
:

587 i‡(!(
bg_Êags
[
i
] & 
PXT4_BG_INODE_ZEROED
))

588 
h™dÀ_bb
;

591 
block
 = 
group_d©a
[
i
].
öode_èbÀ
;

592 
	`pxt4_debug
("clear inodeÅable blocks %#04llx -> %#04lx\n",

593 
block
, 
sbi
->
s_ôb_≥r_group
);

594 
îr
 = 
	`sb_issue_zîoout
(
sb
, 
block
, 
sbi
->
s_ôb_≥r_group
,

595 
GFP_NOFS
);

596 i‡(
îr
)

597 
out
;

599 
h™dÀ_bb
:

600 i‡(
bg_Êags
[
i
] & 
PXT4_BG_BLOCK_UNINIT
)

601 
h™dÀ_ib
;

604 
block
 = 
group_d©a
[
i
].
block_bôm≠
;

605 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

606 i‡(
îr
)

607 
out
;

609 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

610 i‡(
	`IS_ERR
(
bh
)) {

611 
îr
 = 
	`PTR_ERR
(
bh
);

612 
out
;

614 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
);

615 i‡(
ovîhód
 != 0) {

616 
	`pxt4_debug
("mark backup superblock %#04llx (+0)\n",

617 
°¨t
);

618 
	`pxt4_£t_bôs
(
bh
->
b_d©a
, 0,

619 
	`PXT4_NUM_B2C
(
sbi
, 
ovîhód
));

621 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_B2C
(
sbi
, 
group_d©a
[
i
].
blocks_cou¡
),

622 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

623 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

624 
	`bªl£
(
bh
);

625 i‡(
îr
)

626 
out
;

628 
h™dÀ_ib
:

629 i‡(
bg_Êags
[
i
] & 
PXT4_BG_INODE_UNINIT
)

633 
block
 = 
group_d©a
[
i
].
öode_bôm≠
;

634 
îr
 = 
	`exãnd_‹_ª°¨t_å™ß˘i⁄
(
h™dÀ
, 1);

635 i‡(
îr
)

636 
out
;

638 
bh
 = 
	`b˛ón
(
h™dÀ
, 
sb
, 
block
);

639 i‡(
	`IS_ERR
(
bh
)) {

640 
îr
 = 
	`PTR_ERR
(
bh
);

641 
out
;

644 
	`pxt4_m¨k_bôm≠_íd
(
	`PXT4_INODES_PER_GROUP
(
sb
),

645 
sb
->
s_blocksize
 * 8, 
bh
->
b_d©a
);

646 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

647 
	`bªl£
(
bh
);

648 i‡(
îr
)

649 
out
;

653 
j
 = 0; j < 
GROUP_TABLE_COUNT
; j++) {

654 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

655 
°¨t
 = (&
group_d©a
[0].
block_bôm≠
)[
j
];

656 
block
 = 
°¨t
;

657 
i
 = 1; i < 
Êex_gd
->
cou¡
; i++) {

658 
block
 +
group_èbÀ_cou¡
[
j
];

659 i‡(
block
 =(&
group_d©a
[
i
].
block_bôm≠
)[
j
]) {

660 
cou¡
 +
group_èbÀ_cou¡
[
j
];

663 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

664 
Êex_gd
,

665 
	`PXT4_B2C
(
sbi
, 
°¨t
),

666 
	`PXT4_B2C
(
sbi
,

667 
°¨t
 + 
cou¡


669 i‡(
îr
)

670 
out
;

671 
cou¡
 = 
group_èbÀ_cou¡
[
j
];

672 
°¨t
 = (&
group_d©a
[
i
].
block_bôm≠
)[
j
];

673 
block
 = 
°¨t
;

676 i‡(
cou¡
) {

677 
îr
 = 
	`£t_Êexbg_block_bôm≠
(
sb
, 
h™dÀ
,

678 
Êex_gd
,

679 
	`PXT4_B2C
(
sbi
, 
°¨t
),

680 
	`PXT4_B2C
(
sbi
,

681 
°¨t
 + 
cou¡


683 i‡(
îr
)

684 
out
;

688 
out
:

689 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

690 i‡(
îr2
 && !
îr
)

691 
îr
 = 
îr2
;

693  
îr
;

694 
	}
}

703 
	$pxt4_li°_backups
(
su≥r_block
 *
sb
, *
thªe
,

704 *
five
, *
£ví
)

706 *
mö
 = 
thªe
;

707 
mu…
 = 3;

708 
ªt
;

710 i‡(!
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

711 
ªt
 = *
mö
;

712 *
mö
 += 1;

713  
ªt
;

716 i‡(*
five
 < *
mö
) {

717 
mö
 = 
five
;

718 
mu…
 = 5;

720 i‡(*
£ví
 < *
mö
) {

721 
mö
 = 
£ví
;

722 
mu…
 = 7;

725 
ªt
 = *
mö
;

726 *
mö
 *
mu…
;

728  
ªt
;

729 
	}
}

736 
	$vîify_ª£rved_gdb
(
su≥r_block
 *
sb
,

737 
pxt4_group_t
 
íd
,

738 
buf„r_hód
 *
¥im¨y
)

740 c⁄° 
pxt4_fsblk_t
 
blk
 = 
¥im¨y
->
b_blockƒ
;

741 
thªe
 = 1;

742 
five
 = 5;

743 
£ví
 = 7;

744 
gΩ
;

745 
__À32
 *
p
 = (__À32 *)
¥im¨y
->
b_d©a
;

746 
gdbackups
 = 0;

748 (
gΩ
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
)Ë< 
íd
) {

749 i‡(
	`À32_to_˝u
(*
p
++) !=

750 
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë+ 
blk
){

751 
	`pxt4_w¨nög
(
sb
, "reserved GDT %llu"

753 
blk
, 
gΩ
,

754 
gΩ
 *

755 (
pxt4_fsblk_t
)
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

756 
blk
);

757  -
EINVAL
;

759 i‡(++
gdbackups
 > 
	`PXT4_ADDR_PER_BLOCK
(
sb
))

760  -
EFBIG
;

763  
gdbackups
;

764 
	}
}

779 
	$add_√w_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

780 
pxt4_group_t
 
group
)

782 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

783 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

784 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

785 
pxt4_fsblk_t
 
gdblock
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + 
gdb_num
;

786 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
 = 
NULL
;

787 
buf„r_hód
 *
död
 = 
NULL
;

788 
buf„r_hód
 *
gdb_bh
 = 
NULL
;

789 
gdbackups
;

790 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

791 
__À32
 *
d©a
;

792 
îr
;

794 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

795 
	`¥ötk
(
KERN_DEBUG


797 
gdb_num
);

799 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

800 i‡(
	`IS_ERR
(
gdb_bh
))

801  
	`PTR_ERR
(
gdb_bh
);

803 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
gdb_bh
);

804 i‡(
gdbackups
 < 0) {

805 
îr
 = 
gdbackups
;

806 
îrout
;

809 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

810 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

811 i‡(
	`IS_ERR
(
död
)) {

812 
îr
 = 
	`PTR_ERR
(
död
);

813 
död
 = 
NULL
;

814 
îrout
;

817 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

818 i‡(
	`À32_to_˝u
(
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)]Ë!
gdblock
) {

819 
	`pxt4_w¨nög
(
sb
, "new group %u GDT block %lluÇotÑeserved",

820 
group
, 
gdblock
);

821 
îr
 = -
EINVAL
;

822 
îrout
;

825 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

826 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

827 i‡(
	`u∆ikñy
(
îr
))

828 
îrout
;

830 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

831 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

832 i‡(
	`u∆ikñy
(
îr
))

833 
îrout
;

835 
	`BUFFER_TRACE
(
död
, "get_write_access");

836 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
död
);

837 i‡(
	`u∆ikñy
(
îr
))

838 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

841 
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
);

842 i‡(
	`u∆ikñy
(
îr
))

843 
îrout
;

845 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

846 (
buf„r_hód
 *),

847 
GFP_NOFS
);

848 i‡(!
n_group_desc
) {

849 
îr
 = -
ENOMEM
;

850 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

851 
gdb_num
 + 1);

852 
îrout
;

864 
d©a
[
gdb_num
 % 
	`PXT4_ADDR_PER_BLOCK
(
sb
)] = 0;

865 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
död
);

866 i‡(
	`u∆ikñy
(
îr
)) {

867 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

868 
îrout
;

870 
öode
->
i_blocks
 -(
gdbackups
 + 1Ë* 
sb
->
s_blocksize
 >>

871 (9 - 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
);

872 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

873 
	`mem£t
(
gdb_bh
->
b_d©a
, 0, 
sb
->
s_blocksize
);

874 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

875 i‡(
	`u∆ikñy
(
îr
)) {

876 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

877 
ûoc
.
bh
 = 
NULL
;

878 
îrout
;

880 
	`bªl£
(
död
);

882 
o_group_desc
 = 
	`PXT4_SB
(
sb
)->
s_group_desc
;

883 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

884 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

885 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

886 
	`PXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

887 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

888 
	`kv‰ì
(
o_group_desc
);

890 
	`À16_add_˝u
(&
es
->
s_ª£rved_gdt_blocks
, -1);

891 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

892 i‡(
îr
)

893 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

894  
îr
;

895 
îrout
:

896 
	`kv‰ì
(
n_group_desc
);

897 
	`bªl£
(
ûoc
.
bh
);

898 
	`bªl£
(
död
);

899 
	`bªl£
(
gdb_bh
);

901 
	`pxt4_debug
("Àavög wôhÉº‹ %d\n", 
îr
);

902  
îr
;

903 
	}
}

908 
	$add_√w_gdb_mëa_bg
(
su≥r_block
 *
sb
,

909 
h™dÀ_t
 *
h™dÀ
, 
pxt4_group_t
 
group
) {

910 
pxt4_fsblk_t
 
gdblock
;

911 
buf„r_hód
 *
gdb_bh
;

912 
buf„r_hód
 **
o_group_desc
, **
n_group_desc
;

913 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

914 
îr
;

916 
gdblock
 = 
	`pxt4_mëa_bg_fú°_block_no
(
sb
, 
group
) +

917 
	`pxt4_bg_has_su≥r
(
sb
, 
group
);

918 
gdb_bh
 = 
	`pxt4_sb_bªad
(
sb
, 
gdblock
, 0);

919 i‡(
	`IS_ERR
(
gdb_bh
))

920  
	`PTR_ERR
(
gdb_bh
);

921 
n_group_desc
 = 
	`pxt4_kvmÆloc
((
gdb_num
 + 1) *

922 (
buf„r_hód
 *),

923 
GFP_NOFS
);

924 i‡(!
n_group_desc
) {

925 
	`bªl£
(
gdb_bh
);

926 
îr
 = -
ENOMEM
;

927 
	`pxt4_w¨nög
(
sb
, "notÉnough memory for %lu groups",

928 
gdb_num
 + 1);

929  
îr
;

932 
o_group_desc
 = 
	`PXT4_SB
(
sb
)->
s_group_desc
;

933 
	`mem˝y
(
n_group_desc
, 
o_group_desc
,

934 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 * (
buf„r_hód
 *));

935 
n_group_desc
[
gdb_num
] = 
gdb_bh
;

937 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

938 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

939 i‡(
îr
) {

940 
	`kv‰ì
(
n_group_desc
);

941 
	`bªl£
(
gdb_bh
);

942  
îr
;

945 
	`PXT4_SB
(
sb
)->
s_group_desc
 = 
n_group_desc
;

946 
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
++;

947 
	`kv‰ì
(
o_group_desc
);

948  
îr
;

949 
	}
}

964 
	$ª£rve_backup_gdb
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

965 
pxt4_group_t
 
group
)

967 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

968 
ª£rved_gdb
 =
	`À16_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_ª£rved_gdt_blocks
);

969 
˛u°î_bôs
 = 
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
;

970 
buf„r_hód
 **
¥im¨y
;

971 
buf„r_hód
 *
död
;

972 
pxt4_ûoc
 
ûoc
;

973 
pxt4_fsblk_t
 
blk
;

974 
__À32
 *
d©a
, *
íd
;

975 
gdbackups
 = 0;

976 
ªs
, 
i
;

977 
îr
;

979 
¥im¨y
 = 
	`kmÆloc_¨øy
(
ª£rved_gdb
, (*¥im¨y), 
GFP_NOFS
);

980 i‡(!
¥im¨y
)

981  -
ENOMEM
;

983 
d©a
 = 
	`PXT4_I
(
öode
)->
i_d©a
 + 
PXT4_DIND_BLOCK
;

984 
död
 = 
	`pxt4_sb_bªad
(
sb
, 
	`À32_to_˝u
(*
d©a
), 0);

985 i‡(
	`IS_ERR
(
död
)) {

986 
îr
 = 
	`PTR_ERR
(
död
);

987 
död
 = 
NULL
;

988 
exô_‰ì
;

991 
blk
 = 
	`PXT4_SB
(
sb
)->
s_sbh
->
b_blockƒ
 + 1 + PXT4_SB(sb)->
s_gdb_cou¡
;

992 
d©a
 = (
__À32
 *)
död
->
b_d©a
 + (
	`PXT4_SB
(
sb
)->
s_gdb_cou¡
 %

993 
	`PXT4_ADDR_PER_BLOCK
(
sb
));

994 
íd
 = (
__À32
 *)
död
->
b_d©a
 + 
	`PXT4_ADDR_PER_BLOCK
(
sb
);

997 
ªs
 = 0;Ñe†< 
ª£rved_gdb
;Ñes++, 
blk
++) {

998 i‡(
	`À32_to_˝u
(*
d©a
Ë!
blk
) {

999 
	`pxt4_w¨nög
(
sb
, "reserved block %llu"

1001 
blk
,

1002 ()(
d©a
 - (
__À32
 *)
död
->
b_d©a
));

1003 
îr
 = -
EINVAL
;

1004 
exô_bh
;

1006 
¥im¨y
[
ªs
] = 
	`pxt4_sb_bªad
(
sb
, 
blk
, 0);

1007 i‡(
	`IS_ERR
(
¥im¨y
[
ªs
])) {

1008 
îr
 = 
	`PTR_ERR
(
¥im¨y
[
ªs
]);

1009 
¥im¨y
[
ªs
] = 
NULL
;

1010 
exô_bh
;

1012 
gdbackups
 = 
	`vîify_ª£rved_gdb
(
sb
, 
group
, 
¥im¨y
[
ªs
]);

1013 i‡(
gdbackups
 < 0) {

1014 
	`bªl£
(
¥im¨y
[
ªs
]);

1015 
îr
 = 
gdbackups
;

1016 
exô_bh
;

1018 i‡(++
d©a
 >
íd
)

1019 
d©a
 = (
__À32
 *)
död
->
b_d©a
;

1022 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1023 
	`BUFFER_TRACE
(
¥im¨y
[
i
], "get_write_access");

1024 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
¥im¨y
[
i
])))

1025 
exô_bh
;

1028 i‡((
îr
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
ûoc
)))

1029 
exô_bh
;

1035 
blk
 = 
group
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1036 
i
 = 0; i < 
ª£rved_gdb
; i++) {

1037 
îr2
;

1038 
d©a
 = (
__À32
 *)
¥im¨y
[
i
]->
b_d©a
;

1042 
d©a
[
gdbackups
] = 
	`˝u_to_À32
(
blk
 + 
¥im¨y
[
i
]->
b_blockƒ
);

1043 
îr2
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
¥im¨y
[
i
]);

1044 i‡(!
îr
)

1045 
îr
 = 
îr2
;

1048 
öode
->
i_blocks
 +
ª£rved_gdb
 * 
sb
->
s_blocksize
 >> (9 - 
˛u°î_bôs
);

1049 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
ûoc
);

1051 
exô_bh
:

1052 --
ªs
 >= 0)

1053 
	`bªl£
(
¥im¨y
[
ªs
]);

1054 
	`bªl£
(
död
);

1056 
exô_‰ì
:

1057 
	`k‰ì
(
¥im¨y
);

1059  
îr
;

1060 
	}
}

1078 
	$upd©e_backups
(
su≥r_block
 *
sb
, 
£˘‹_t
 
blk_off
, *
d©a
,

1079 
size
, 
mëa_bg
)

1081 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1082 
pxt4_group_t
 
œ°
;

1083 c⁄° 
bpg
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1084 
thªe
 = 1;

1085 
five
 = 5;

1086 
£ví
 = 7;

1087 
pxt4_group_t
 
group
 = 0;

1088 
ª°
 = 
sb
->
s_blocksize
 - 
size
;

1089 
h™dÀ_t
 *
h™dÀ
;

1090 
îr
 = 0, 
îr2
;

1092 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
PXT4_MAX_TRANS_DATA
);

1093 i‡(
	`IS_ERR
(
h™dÀ
)) {

1094 
group
 = 1;

1095 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1096 
exô_îr
;

1099 i‡(
mëa_bg
 == 0) {

1100 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1101 
œ°
 = 
sbi
->
s_groups_cou¡
;

1103 
group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
blk_off
) + 1;

1104 
œ°
 = (
pxt4_group_t
)(
group
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 2);

1107 
group
 < 
sbi
->
s_groups_cou¡
) {

1108 
buf„r_hód
 *
bh
;

1109 
pxt4_fsblk_t
 
backup_block
;

1112 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
) &&

1113 
h™dÀ
->
h_buf„r_¸edôs
 == 0 &&

1114 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
) &&

1115 (
îr
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
PXT4_MAX_TRANS_DATA
)))

1118 i‡(
mëa_bg
 == 0)

1119 
backup_block
 = ((
pxt4_fsblk_t
)
group
Ë* 
bpg
 + 
blk_off
;

1121 
backup_block
 = (
	`pxt4_group_fú°_block_no
(
sb
, 
group
) +

1122 
	`pxt4_bg_has_su≥r
(
sb
, 
group
));

1124 
bh
 = 
	`sb_gëblk
(
sb
, 
backup_block
);

1125 i‡(
	`u∆ikñy
(!
bh
)) {

1126 
îr
 = -
ENOMEM
;

1129 
	`pxt4_debug
("update metadata backup %llu(+%llu)\n",

1130 
backup_block
, backup_block -

1131 
	`pxt4_group_fú°_block_no
(
sb
, 
group
));

1132 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1133 i‡((
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
))) {

1134 
	`bªl£
(
bh
);

1137 
	`lock_buf„r
(
bh
);

1138 
	`mem˝y
(
bh
->
b_d©a
, 
d©a
, 
size
);

1139 i‡(
ª°
)

1140 
	`mem£t
(
bh
->
b_d©a
 + 
size
, 0, 
ª°
);

1141 
	`£t_buf„r_u±od©e
(
bh
);

1142 
	`u∆ock_buf„r
(
bh
);

1143 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1144 i‡(
	`u∆ikñy
(
îr
))

1145 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1146 
	`bªl£
(
bh
);

1148 i‡(
mëa_bg
 == 0)

1149 
group
 = 
	`pxt4_li°_backups
(
sb
, &
thªe
, &
five
, &
£ví
);

1150 i‡(
group
 =
œ°
)

1153 
group
 = 
œ°
;

1155 i‡((
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
)Ë&& !
îr
)

1156 
îr
 = 
îr2
;

1168 
exô_îr
:

1169 i‡(
îr
) {

1170 
	`pxt4_w¨nög
(
sb
, "can't update backup for group %u (err %d), "

1171 "f‹cög fsck o¿√xàªboŸ", 
group
, 
îr
);

1172 
sbi
->
s_mou¡_°©e
 &~
PXT4_VALID_FS
;

1173 
sbi
->
s_es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

1174 
	`m¨k_buf„r_dúty
(
sbi
->
s_sbh
);

1176 
	}
}

1188 
	$pxt4_add_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1189 
pxt4_group_t
 
group
, 
öode
 *
ªsize_öode
,

1190 
pxt4_group_t
 
cou¡
)

1192 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1193 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1194 
buf„r_hód
 *
gdb_bh
;

1195 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1196 
mëa_bg
;

1198 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1199 
i
 = 0; i < 
cou¡
; i++, 
group
++) {

1200 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
group
) ?

1201 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1203 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1204 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1212 i‡(
gdb_off
) {

1213 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1214 
	`BUFFER_TRACE
(
gdb_bh
, "get_write_access");

1215 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
gdb_bh
);

1217 i‡(!
îr
 && 
ª£rved_gdb
 && 
	`pxt4_bg_num_gdb
(
sb
, 
group
))

1218 
îr
 = 
	`ª£rve_backup_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1219 } i‡(
mëa_bg
 != 0) {

1220 
îr
 = 
	`add_√w_gdb_mëa_bg
(
sb
, 
h™dÀ
, 
group
);

1222 
îr
 = 
	`add_√w_gdb
(
h™dÀ
, 
ªsize_öode
, 
group
);

1224 i‡(
îr
)

1227  
îr
;

1228 
	}
}

1230 
buf„r_hód
 *
	$pxt4_gë_bôm≠
(
su≥r_block
 *
sb
, 
__u64
 
block
)

1232 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

1233 i‡(
	`u∆ikñy
(!
bh
))

1234  
NULL
;

1235 i‡(!
	`bh_u±od©e_‹_lock
(
bh
)) {

1236 i‡(
	`bh_submô_ªad
(
bh
) < 0) {

1237 
	`bªl£
(
bh
);

1238  
NULL
;

1242  
bh
;

1243 
	}
}

1245 
	$pxt4_£t_bôm≠_checksums
(
su≥r_block
 *
sb
,

1246 
pxt4_group_t
 
group
,

1247 
pxt4_group_desc
 *
gdp
,

1248 
pxt4_√w_group_d©a
 *
group_d©a
)

1250 
buf„r_hód
 *
bh
;

1252 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

1255 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
öode_bôm≠
);

1256 i‡(!
bh
)

1257  -
EIO
;

1258 
	`pxt4_öode_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
,

1259 
	`PXT4_INODES_PER_GROUP
(
sb
) / 8);

1260 
	`bªl£
(
bh
);

1262 
bh
 = 
	`pxt4_gë_bôm≠
(
sb
, 
group_d©a
->
block_bôm≠
);

1263 i‡(!
bh
)

1264  -
EIO
;

1265 
	`pxt4_block_bôm≠_csum_£t
(
sb
, 
group
, 
gdp
, 
bh
);

1266 
	`bªl£
(
bh
);

1269 
	}
}

1274 
	$pxt4_£tup_√w_descs
(
h™dÀ_t
 *
h™dÀ
, 
su≥r_block
 *
sb
,

1275 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1277 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1278 
pxt4_group_desc
 *
gdp
;

1279 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1280 
buf„r_hód
 *
gdb_bh
;

1281 
pxt4_group_t
 
group
;

1282 
__u16
 *
bg_Êags
 = 
Êex_gd
->bg_flags;

1283 
i
, 
gdb_off
, 
gdb_num
, 
îr
 = 0;

1286 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++, 
group_d©a
++, 
bg_Êags
++) {

1287 
group
 = 
group_d©a
->group;

1289 
gdb_off
 = 
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1290 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1295 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1297 
gdp
 = (
pxt4_group_desc
 *)(
gdb_bh
->
b_d©a
 +

1298 
gdb_off
 * 
	`PXT4_DESC_SIZE
(
sb
));

1300 
	`mem£t
(
gdp
, 0, 
	`PXT4_DESC_SIZE
(
sb
));

1301 
	`pxt4_block_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
block_bôm≠
);

1302 
	`pxt4_öode_bôm≠_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_bôm≠
);

1303 
îr
 = 
	`pxt4_£t_bôm≠_checksums
(
sb
, 
group
, 
gdp
, 
group_d©a
);

1304 i‡(
îr
) {

1305 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1309 
	`pxt4_öode_èbÀ_£t
(
sb
, 
gdp
, 
group_d©a
->
öode_èbÀ
);

1310 
	`pxt4_‰ì_group_˛u°îs_£t
(
sb
, 
gdp
,

1311 
group_d©a
->
‰ì_˛u°îs_cou¡
);

1312 
	`pxt4_‰ì_öodes_£t
(
sb
, 
gdp
, 
	`PXT4_INODES_PER_GROUP
(sb));

1313 i‡(
	`pxt4_has_group_desc_csum
(
sb
))

1314 
	`pxt4_ôabÀ_unu£d_£t
(
sb
, 
gdp
,

1315 
	`PXT4_INODES_PER_GROUP
(
sb
));

1316 
gdp
->
bg_Êags
 = 
	`˝u_to_À16
(*bg_flags);

1317 
	`pxt4_group_desc_csum_£t
(
sb
, 
group
, 
gdp
);

1319 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
gdb_bh
);

1320 i‡(
	`u∆ikñy
(
îr
)) {

1321 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1329 
îr
 = 
	`pxt4_mb_add_groupöfo
(
sb
, 
group
, 
gdp
);

1330 i‡(
îr
)

1333  
îr
;

1334 
	}
}

1343 
	$pxt4_upd©e_su≥r
(
su≥r_block
 *
sb
,

1344 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1346 
pxt4_fsblk_t
 
blocks_cou¡
 = 0;

1347 
pxt4_fsblk_t
 
‰ì_blocks
 = 0;

1348 
pxt4_fsblk_t
 
ª£rved_blocks
 = 0;

1349 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1350 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1351 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1352 
i
;

1354 
	`BUG_ON
(
Êex_gd
->
cou¡
 =0 || 
group_d©a
 =
NULL
);

1365 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1366 
blocks_cou¡
 +
group_d©a
[
i
].blocks_count;

1367 
‰ì_blocks
 +
	`PXT4_C2B
(
sbi
, 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
);

1370 
ª£rved_blocks
 = 
	`pxt4_r_blocks_cou¡
(
es
) * 100;

1371 
ª£rved_blocks
 = 
	`div64_u64
‘e£rved_blocks, 
	`pxt4_blocks_cou¡
(
es
));

1372 
ª£rved_blocks
 *
blocks_cou¡
;

1373 
	`do_div
(
ª£rved_blocks
, 100);

1375 
	`pxt4_blocks_cou¡_£t
(
es
, 
	`pxt4_blocks_cou¡
”sË+ 
blocks_cou¡
);

1376 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
‰ì_blocks
);

1377 
	`À32_add_˝u
(&
es
->
s_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1378 
Êex_gd
->
cou¡
);

1379 
	`À32_add_˝u
(&
es
->
s_‰ì_öodes_cou¡
, 
	`PXT4_INODES_PER_GROUP
(
sb
) *

1380 
Êex_gd
->
cou¡
);

1382 
	`pxt4_debug
("‰ì block†cou¡ %Œu", 
	`pxt4_‰ì_blocks_cou¡
(
es
));

1401 
	`smp_wmb
();

1404 
sbi
->
s_groups_cou¡
 +
Êex_gd
->
cou¡
;

1405 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

1406 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

1410 
	`pxt4_r_blocks_cou¡_£t
(
es
, 
	`pxt4_r_blocks_cou¡
(es) +

1411 
ª£rved_blocks
);

1414 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

1415 
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
));

1416 
	`≥r˝u_cou¡î_add
(&
sbi
->
s_‰ìöodes_cou¡î
,

1417 
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
);

1419 
	`pxt4_debug
("free blocks count %llu",

1420 
	`≥r˝u_cou¡î_ªad
(&
sbi
->
s_‰ì˛u°îs_cou¡î
));

1421 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
Ë&& 
sbi
->
s_log_groups_≥r_Êex
) {

1422 
pxt4_group_t
 
Êex_group
;

1423 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
group_d©a
[0].
group
);

1424 
	`©omic64_add
(
	`PXT4_NUM_B2C
(
sbi
, 
‰ì_blocks
),

1425 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

1426 
	`©omic_add
(
	`PXT4_INODES_PER_GROUP
(
sb
Ë* 
Êex_gd
->
cou¡
,

1427 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

1433 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

1435 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1436 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:ádded group %u:"

1437 "%Œu blocks(%Œu fªê%ŒuÑe£rved)\n", 
Êex_gd
->
cou¡
,

1438 
blocks_cou¡
, 
‰ì_blocks
, 
ª£rved_blocks
);

1439 
	}
}

1445 
	$pxt4_Êex_group_add
(
su≥r_block
 *
sb
,

1446 
öode
 *
ªsize_öode
,

1447 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
)

1449 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1450 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1451 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1452 
pxt4_gΩblk_t
 
œ°
;

1453 
pxt4_group_t
 
group
;

1454 
h™dÀ_t
 *
h™dÀ
;

1455 
ª£rved_gdb
;

1456 
îr
 = 0, 
îr2
 = 0, 
¸edô
;

1458 
	`BUG_ON
(!
Êex_gd
->
cou¡
 || !Êex_gd->
groups
 || !Êex_gd->
bg_Êags
);

1460 
ª£rved_gdb
 = 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1461 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1462 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1463 
	`BUG_ON
(
œ°
);

1465 
îr
 = 
	`£tup_√w_Êex_group_blocks
(
sb
, 
Êex_gd
);

1466 i‡(
îr
)

1467 
exô
;

1475 
¸edô
 = 3;

1477 
¸edô
 +1 + 
	`DIV_ROUND_UP
(
Êex_gd
->
cou¡
, 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1478 
¸edô
 +
ª£rved_gdb
;

1479 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edô
);

1480 i‡(
	`IS_ERR
(
h™dÀ
)) {

1481 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1482 
exô
;

1485 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1486 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1487 i‡(
îr
)

1488 
exô_jou∫Æ
;

1490 
group
 = 
Êex_gd
->
groups
[0].group;

1491 
	`BUG_ON
(
group
 !
sbi
->
s_groups_cou¡
);

1492 
îr
 = 
	`pxt4_add_√w_descs
(
h™dÀ
, 
sb
, 
group
,

1493 
ªsize_öode
, 
Êex_gd
->
cou¡
);

1494 i‡(
îr
)

1495 
exô_jou∫Æ
;

1497 
îr
 = 
	`pxt4_£tup_√w_descs
(
h™dÀ
, 
sb
, 
Êex_gd
);

1498 i‡(
îr
)

1499 
exô_jou∫Æ
;

1501 
	`pxt4_upd©e_su≥r
(
sb
, 
Êex_gd
);

1503 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1505 
exô_jou∫Æ
:

1506 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1507 i‡(!
îr
)

1508 
îr
 = 
îr2
;

1510 i‡(!
îr
) {

1511 
gdb_num
 = 
group
 / 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1512 
gdb_num_íd
 = ((
group
 + 
Êex_gd
->
cou¡
 - 1) /

1513 
	`PXT4_DESC_PER_BLOCK
(
sb
));

1514 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1515 
£˘‹_t
 
ﬁd_gdb
 = 0;

1517 
	`upd©e_backups
(
sb
, 
sbi
->
s_sbh
->
b_blockƒ
, (*)
es
,

1518 (
pxt4_su≥r_block
), 0);

1519 ; 
gdb_num
 <
gdb_num_íd
; gdb_num++) {

1520 
buf„r_hód
 *
gdb_bh
;

1522 
gdb_bh
 = 
sbi
->
s_group_desc
[
gdb_num
];

1523 i‡(
ﬁd_gdb
 =
gdb_bh
->
b_blockƒ
)

1525 
	`upd©e_backups
(
sb
, 
gdb_bh
->
b_blockƒ
, gdb_bh->
b_d©a
,

1526 
gdb_bh
->
b_size
, 
mëa_bg
);

1527 
ﬁd_gdb
 = 
gdb_bh
->
b_blockƒ
;

1530 
exô
:

1531  
îr
;

1532 
	}
}

1534 
	$pxt4_£tup_√xt_Êex_gd
(
su≥r_block
 *
sb
,

1535 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
,

1536 
pxt4_fsblk_t
 
n_blocks_cou¡
,

1537 
Êexbg_size
)

1539 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1540 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1541 
pxt4_√w_group_d©a
 *
group_d©a
 = 
Êex_gd
->
groups
;

1542 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1543 
pxt4_group_t
 
n_group
;

1544 
pxt4_group_t
 
group
;

1545 
pxt4_group_t
 
œ°_group
;

1546 
pxt4_gΩblk_t
 
œ°
;

1547 
pxt4_gΩblk_t
 
˛u°îs_≥r_group
;

1548 
i
;

1550 
˛u°îs_≥r_group
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1552 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1554 i‡(
o_blocks_cou¡
 =
n_blocks_cou¡
)

1557 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1558 
	`BUG_ON
(
œ°
);

1559 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
n_blocks_cou¡
 - 1, &
n_group
, &
œ°
);

1561 
œ°_group
 = 
group
 | (
Êexbg_size
 - 1);

1562 i‡(
œ°_group
 > 
n_group
)

1563 
œ°_group
 = 
n_group
;

1565 
Êex_gd
->
cou¡
 = 
œ°_group
 - 
group
 + 1;

1567 
i
 = 0; i < 
Êex_gd
->
cou¡
; i++) {

1568 
ovîhód
;

1570 
group_d©a
[
i
].
group
 = group + i;

1571 
group_d©a
[
i
].
blocks_cou¡
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

1572 
ovîhód
 = 
	`pxt4_group_ovîhód_blocks
(
sb
, 
group
 + 
i
);

1573 
group_d©a
[
i
].
md©a_blocks
 = 
ovîhód
;

1574 
group_d©a
[
i
].
‰ì_˛u°îs_cou¡
 = 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
);

1575 i‡(
	`pxt4_has_group_desc_csum
(
sb
)) {

1576 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_BLOCK_UNINIT
 |

1577 
PXT4_BG_INODE_UNINIT
;

1578 i‡(!
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

1579 
Êex_gd
->
bg_Êags
[
i
] |
PXT4_BG_INODE_ZEROED
;

1581 
Êex_gd
->
bg_Êags
[
i
] = 
PXT4_BG_INODE_ZEROED
;

1584 i‡(
œ°_group
 =
n_group
 && 
	`pxt4_has_group_desc_csum
(
sb
))

1586 
Êex_gd
->
bg_Êags
[
i
 - 1] &~
PXT4_BG_BLOCK_UNINIT
;

1588 i‡((
œ°_group
 =
n_group
Ë&& (
œ°
 !
˛u°îs_≥r_group
 - 1)) {

1589 
group_d©a
[
i
 - 1].
blocks_cou¡
 = 
	`PXT4_C2B
(
sbi
, 
œ°
 + 1);

1590 
group_d©a
[
i
 - 1].
‰ì_˛u°îs_cou¡
 -
˛u°îs_≥r_group
 -

1591 
œ°
 - 1;

1595 
	}
}

1610 
	$pxt4_group_add
(
su≥r_block
 *
sb
, 
pxt4_√w_group_d©a
 *
öput
)

1612 
pxt4_√w_Êex_group_d©a
 
Êex_gd
;

1613 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1614 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1615 
ª£rved_gdb
 = 
	`pxt4_bg_has_su≥r
(
sb
, 
öput
->
group
) ?

1616 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
) : 0;

1617 
öode
 *öodê
NULL
;

1618 
gdb_off
;

1619 
îr
;

1620 
__u16
 
bg_Êags
 = 0;

1622 
gdb_off
 = 
öput
->
group
 % 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1624 i‡(
gdb_off
 =0 && !
	`pxt4_has_„©uª_•¨£_su≥r
(
sb
)) {

1625 
	`pxt4_w¨nög
(
sb
, "Can'tÑesizeÇon-sparse filesystem further");

1626  -
EPERM
;

1629 i‡(
	`pxt4_blocks_cou¡
(
es
Ë+ 
öput
->
blocks_cou¡
 <

1630 
	`pxt4_blocks_cou¡
(
es
)) {

1631 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1632  -
EINVAL
;

1635 i‡(
	`À32_to_˝u
(
es
->
s_öodes_cou¡
Ë+ 
	`PXT4_INODES_PER_GROUP
(
sb
) <

1636 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

1637 
	`pxt4_w¨nög
(
sb
, "inodes_count overflow");

1638  -
EINVAL
;

1641 i‡(
ª£rved_gdb
 || 
gdb_off
 == 0) {

1642 i‡(!
	`pxt4_has_„©uª_ªsize_öode
(
sb
) ||

1643 !
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1644 
	`pxt4_w¨nög
(
sb
,

1646  -
EPERM
;

1648 
öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
, 
PXT4_IGET_SPECIAL
);

1649 i‡(
	`IS_ERR
(
öode
)) {

1650 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1651  
	`PTR_ERR
(
öode
);

1656 
îr
 = 
	`vîify_group_öput
(
sb
, 
öput
);

1657 i‡(
îr
)

1658 
out
;

1660 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
öput
->
group
 + 1);

1661 i‡(
îr
)

1662 
out
;

1664 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
öput
->
group
 + 1);

1665 i‡(
îr
)

1666 
out
;

1668 
Êex_gd
.
cou¡
 = 1;

1669 
Êex_gd
.
groups
 = 
öput
;

1670 
Êex_gd
.
bg_Êags
 = &bg_flags;

1671 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
öode
, &
Êex_gd
);

1672 
out
:

1673 
	`ùut
(
öode
);

1674  
îr
;

1675 
	}
}

1680 
	$pxt4_group_exãnd_no_check
(
su≥r_block
 *
sb
,

1681 
pxt4_fsblk_t
 
o_blocks_cou¡
, 
pxt4_gΩblk_t
 
add
)

1683 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

1684 
h™dÀ_t
 *
h™dÀ
;

1685 
îr
 = 0, 
îr2
;

1690 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 3);

1691 i‡(
	`IS_ERR
(
h™dÀ
)) {

1692 
îr
 = 
	`PTR_ERR
(
h™dÀ
);

1693 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ sèπ", 
îr
);

1694  
îr
;

1697 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

1698 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
);

1699 i‡(
îr
) {

1700 
	`pxt4_w¨nög
(
sb
, "îr‹ %d o¿jou∫Æ wrôêac˚ss", 
îr
);

1701 
îrout
;

1704 
	`pxt4_blocks_cou¡_£t
(
es
, 
o_blocks_cou¡
 + 
add
);

1705 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
, 
	`pxt4_‰ì_blocks_cou¡
”sË+ 
add
);

1706 
	`pxt4_debug
("‰ìög block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1707 
o_blocks_cou¡
 + 
add
);

1709 
îr
 = 
	`pxt4_group_add_blocks
(
h™dÀ
, 
sb
, 
o_blocks_cou¡
, 
add
);

1710 i‡(
îr
)

1711 
îrout
;

1712 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1713 
	`pxt4_debug
("‰ìd block†%ŒuÅhrough %Œu\n", 
o_blocks_cou¡
,

1714 
o_blocks_cou¡
 + 
add
);

1715 
îrout
:

1716 
îr2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1717 i‡(
îr2
 && !
îr
)

1718 
îr
 = 
îr2
;

1720 i‡(!
îr
) {

1721 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1722 
	`¥ötk
(
KERN_DEBUG
 "PXT4-fs:Éxtended groupÅo %llu "

1723 "blocks\n", 
	`pxt4_blocks_cou¡
(
es
));

1724 
	`upd©e_backups
(
sb
, 
	`PXT4_SB
(sb)->
s_sbh
->
b_blockƒ
,

1725 (*)
es
, (
pxt4_su≥r_block
), 0);

1727  
îr
;

1728 
	}
}

1740 
	$pxt4_group_exãnd
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

1741 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1743 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1744 
pxt4_gΩblk_t
 
œ°
;

1745 
pxt4_gΩblk_t
 
add
;

1746 
buf„r_hód
 *
bh
;

1747 
îr
;

1748 
pxt4_group_t
 
group
;

1750 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1752 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

1753 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

1755 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1757 i‡(
n_blocks_cou¡
 =0 ||Ç_blocks_cou¡ =
o_blocks_cou¡
)

1760 i‡(
n_blocks_cou¡
 > (
£˘‹_t
)(~0ULLË>> (
sb
->
s_blocksize_bôs
 - 9)) {

1761 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1763 
n_blocks_cou¡
);

1764 i‡((
£˘‹_t
) < 8)

1765 
	`pxt4_w¨nög
(
sb
, "CONFIG_LBDAFÇotÉnabled");

1766  -
EINVAL
;

1769 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1770 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1771  -
EINVAL
;

1775 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
, &
group
, &
œ°
);

1777 i‡(
œ°
 == 0) {

1778 
	`pxt4_w¨nög
(
sb
, "needÅo useÖxt2onlineÅoÑesize further");

1779  -
EPERM
;

1782 
add
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
œ°
;

1784 i‡(
o_blocks_cou¡
 + 
add
 < o_blocks_count) {

1785 
	`pxt4_w¨nög
(
sb
, "blocks_count overflow");

1786  -
EINVAL
;

1789 i‡(
o_blocks_cou¡
 + 
add
 > 
n_blocks_cou¡
)

1790 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

1792 i‡(
o_blocks_cou¡
 + 
add
 < 
n_blocks_cou¡
)

1793 
	`pxt4_w¨nög
(
sb
, "will only finish group (%llu blocks, %uÇew)",

1794 
o_blocks_cou¡
 + 
add
,ádd);

1797 
bh
 = 
	`sb_bªad
(
sb
, 
o_blocks_cou¡
 + 
add
 - 1);

1798 i‡(!
bh
) {

1799 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1800  -
ENOSPC
;

1802 
	`bªl£
(
bh
);

1804 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

1805  
îr
;

1806 
	}
}

1809 
	$num_desc_blocks
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
groups
)

1811  (
groups
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) / PXT4_DESC_PER_BLOCK(sb);

1812 
	}
}

1819 
	$pxt4_c⁄vît_mëa_bg
(
su≥r_block
 *
sb
, 
öode
 *inode)

1821 
h™dÀ_t
 *
h™dÀ
;

1822 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1823 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1824 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

1825 
pxt4_fsblk_t
 
ƒ
;

1826 
i
, 
ªt
, 
îr
 = 0;

1827 
¸edôs
 = 1;

1829 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Converting file systemÅo meta_bg");

1830 i‡(
öode
) {

1831 i‡(
es
->
s_ª£rved_gdt_blocks
) {

1832 
	`pxt4_îr‹
(
sb
, "UnexpectedÇon-zero "

1834  -
EPERM
;

1838 i‡(
öode
->
i_blocks
 !1 << (öode->
i_blkbôs
 -

1839 (9 - 
sbi
->
s_˛u°î_bôs
)))

1840 
övÆid_ªsize_öode
;

1841 
i
 = 0; i < 
PXT4_N_BLOCKS
; i++) {

1842 i‡(
i
 =
PXT4_DIND_BLOCK
) {

1843 i‡(
ei
->
i_d©a
[
i
])

1846 
övÆid_ªsize_öode
;

1848 i‡(
ei
->
i_d©a
[
i
])

1849 
övÆid_ªsize_öode
;

1851 
¸edôs
 += 3;

1854 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t_sb
(
sb
, 
PXT4_HT_RESIZE
, 
¸edôs
);

1855 i‡(
	`IS_ERR
(
h™dÀ
))

1856  
	`PTR_ERR
(
h™dÀ
);

1858 
	`BUFFER_TRACE
(
sbi
->
s_sbh
, "get_write_access");

1859 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
sbi
->
s_sbh
);

1860 i‡(
îr
)

1861 
îrout
;

1863 
	`pxt4_˛ór_„©uª_ªsize_öode
(
sb
);

1864 
	`pxt4_£t_„©uª_mëa_bg
(
sb
);

1865 
sbi
->
s_es
->
s_fú°_mëa_bg
 =

1866 
	`˝u_to_À32
(
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
));

1868 
îr
 = 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

1869 i‡(
îr
) {

1870 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1871 
îrout
;

1874 i‡(
öode
) {

1875 
ƒ
 = 
	`À32_to_˝u
(
ei
->
i_d©a
[
PXT4_DIND_BLOCK
]);

1876 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
ƒ
, 1,

1877 
PXT4_FREE_BLOCKS_METADATA
 |

1878 
PXT4_FREE_BLOCKS_FORGET
);

1879 
ei
->
i_d©a
[
PXT4_DIND_BLOCK
] = 0;

1880 
öode
->
i_blocks
 = 0;

1882 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1883 i‡(
îr
)

1884 
	`pxt4_°d_îr‹
(
sb
, 
îr
);

1887 
îrout
:

1888 
ªt
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1889 i‡(!
îr
)

1890 
îr
 = 
ªt
;

1891  
ªt
;

1893 
övÆid_ªsize_öode
:

1894 
	`pxt4_îr‹
(
sb
, "corrupted/inconsistentÑesize inode");

1895  -
EINVAL
;

1896 
	}
}

1904 
	$pxt4_ªsize_fs
(
su≥r_block
 *
sb
, 
pxt4_fsblk_t
 
n_blocks_cou¡
)

1906 
pxt4_√w_Êex_group_d©a
 *
Êex_gd
 = 
NULL
;

1907 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1908 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

1909 
buf„r_hód
 *
bh
;

1910 
öode
 *
ªsize_öode
 = 
NULL
;

1911 
pxt4_gΩblk_t
 
add
, 
off£t
;

1912 
n_desc_blocks
;

1913 
o_desc_blocks
;

1914 
pxt4_group_t
 
o_group
;

1915 
pxt4_group_t
 
n_group
;

1916 
pxt4_fsblk_t
 
o_blocks_cou¡
;

1917 
pxt4_fsblk_t
 
n_blocks_cou¡_ªåy
 = 0;

1918 
œ°_upd©e_time
 = 0;

1919 
îr
 = 0, 
Êexbg_size
 = 1 << 
sbi
->
s_log_groups_≥r_Êex
;

1920 
mëa_bg
;

1923 
bh
 = 
	`sb_bªad
(
sb
, 
n_blocks_cou¡
 - 1);

1924 i‡(!
bh
) {

1925 
	`pxt4_w¨nög
(
sb
, "can'tÑeadÜast block,Ñesizeáborted");

1926  -
ENOSPC
;

1928 
	`bªl£
(
bh
);

1930 
ªåy
:

1931 
o_blocks_cou¡
 = 
	`pxt4_blocks_cou¡
(
es
);

1933 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resizing filesystem from %llu "

1934 "tÿ%Œu blocks", 
o_blocks_cou¡
, 
n_blocks_cou¡
);

1936 i‡(
n_blocks_cou¡
 < 
o_blocks_cou¡
) {

1938 
	`pxt4_w¨nög
(
sb
, "can't shrink FS -Ñesizeáborted");

1939  -
EINVAL
;

1942 i‡(
n_blocks_cou¡
 =
o_blocks_cou¡
)

1946 
n_group
 = 
	`pxt4_gë_group_numbî
(
sb
, 
n_blocks_cou¡
 - 1);

1947 i‡(
n_group
 >(0xFFFFFFFFUL / 
	`PXT4_INODES_PER_GROUP
(
sb
))) {

1948 
	`pxt4_w¨nög
(
sb
, "resize would cause inodes_count overflow");

1949  -
EINVAL
;

1951 
	`pxt4_gë_group_no_™d_off£t
(
sb
, 
o_blocks_cou¡
 - 1, &
o_group
, &
off£t
);

1953 
n_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
n_group
 + 1);

1954 
o_desc_blocks
 = 
	`num_desc_blocks
(
sb
, 
sbi
->
s_groups_cou¡
);

1956 
mëa_bg
 = 
	`pxt4_has_„©uª_mëa_bg
(
sb
);

1958 i‡(
	`pxt4_has_„©uª_ªsize_öode
(
sb
)) {

1959 i‡(
mëa_bg
) {

1960 
	`pxt4_îr‹
(
sb
, "resize_inodeánd meta_bgÉnabled "

1962  -
EINVAL
;

1964 i‡(
n_desc_blocks
 > 
o_desc_blocks
 +

1965 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
)) {

1966 
n_blocks_cou¡_ªåy
 = 
n_blocks_cou¡
;

1967 
n_desc_blocks
 = 
o_desc_blocks
 +

1968 
	`À16_to_˝u
(
es
->
s_ª£rved_gdt_blocks
);

1969 
n_group
 = 
n_desc_blocks
 * 
	`PXT4_DESC_PER_BLOCK
(
sb
);

1970 
n_blocks_cou¡
 = (
pxt4_fsblk_t
)
n_group
 *

1971 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) +

1972 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
);

1973 
n_group
--;

1976 i‡(!
ªsize_öode
)

1977 
ªsize_öode
 = 
	`pxt4_igë
(
sb
, 
PXT4_RESIZE_INO
,

1978 
PXT4_IGET_SPECIAL
);

1979 i‡(
	`IS_ERR
(
ªsize_öode
)) {

1980 
	`pxt4_w¨nög
(
sb
, "Error openingÑesize inode");

1981  
	`PTR_ERR
(
ªsize_öode
);

1985 i‡((!
ªsize_öode
 && !
mëa_bg
Ë|| 
n_blocks_cou¡
 =
o_blocks_cou¡
) {

1986 
îr
 = 
	`pxt4_c⁄vît_mëa_bg
(
sb
, 
ªsize_öode
);

1987 i‡(
îr
)

1988 
out
;

1989 i‡(
ªsize_öode
) {

1990 
	`ùut
(
ªsize_öode
);

1991 
ªsize_öode
 = 
NULL
;

1993 i‡(
n_blocks_cou¡_ªåy
) {

1994 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

1995 
n_blocks_cou¡_ªåy
 = 0;

1996 
ªåy
;

2007 i‡((
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
) +

2008 
	`pxt4_group_ovîhód_blocks
(
sb
, 
n_group
) + 2 +

2009 
sbi
->
s_ôb_≥r_group
 + sbi->
s_˛u°î_øtio
Ë>
n_blocks_cou¡
) {

2010 
n_blocks_cou¡
 = 
	`pxt4_group_fú°_block_no
(
sb
, 
n_group
);

2011 
n_group
--;

2012 
n_blocks_cou¡_ªåy
 = 0;

2013 i‡(
ªsize_öode
) {

2014 
	`ùut
(
ªsize_öode
);

2015 
ªsize_öode
 = 
NULL
;

2017 
ªåy
;

2021 i‡(
n_group
 =
o_group
)

2022 
add
 = 
n_blocks_cou¡
 - 
o_blocks_cou¡
;

2024 
add
 = 
	`PXT4_C2B
(
sbi
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
Ë- (
off£t
 + 1));

2025 i‡(
add
 > 0) {

2026 
îr
 = 
	`pxt4_group_exãnd_no_check
(
sb
, 
o_blocks_cou¡
, 
add
);

2027 i‡(
îr
)

2028 
out
;

2031 i‡(
	`pxt4_blocks_cou¡
(
es
Ë=
n_blocks_cou¡
)

2032 
out
;

2034 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
n_group
 + 1);

2035 i‡(
îr
)

2036 
out
;

2038 
îr
 = 
	`pxt4_mb_Æloc_groupöfo
(
sb
, 
n_group
 + 1);

2039 i‡(
îr
)

2040 
out
;

2042 
Êex_gd
 = 
	`Æloc_Êex_gd
(
Êexbg_size
);

2043 i‡(
Êex_gd
 =
NULL
) {

2044 
îr
 = -
ENOMEM
;

2045 
out
;

2051 
	`pxt4_£tup_√xt_Êex_gd
(
sb
, 
Êex_gd
, 
n_blocks_cou¡
,

2052 
Êexbg_size
)) {

2053 i‡(
jiffõs
 - 
œ°_upd©e_time
 > 
HZ
 * 10) {

2054 i‡(
œ°_upd©e_time
)

2055 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

2057 
	`pxt4_blocks_cou¡
(
es
));

2058 
œ°_upd©e_time
 = 
jiffõs
;

2060 i‡(
	`pxt4_Æloc_group_èbÀs
(
sb
, 
Êex_gd
, 
Êexbg_size
) != 0)

2062 
îr
 = 
	`pxt4_Êex_group_add
(
sb
, 
ªsize_öode
, 
Êex_gd
);

2063 i‡(
	`u∆ikñy
(
îr
))

2067 i‡(!
îr
 && 
n_blocks_cou¡_ªåy
) {

2068 
n_blocks_cou¡
 = 
n_blocks_cou¡_ªåy
;

2069 
n_blocks_cou¡_ªåy
 = 0;

2070 
	`‰ì_Êex_gd
(
Êex_gd
);

2071 
Êex_gd
 = 
NULL
;

2072 i‡(
ªsize_öode
) {

2073 
	`ùut
(
ªsize_öode
);

2074 
ªsize_öode
 = 
NULL
;

2076 
ªåy
;

2079 
out
:

2080 i‡(
Êex_gd
)

2081 
	`‰ì_Êex_gd
(
Êex_gd
);

2082 i‡(
ªsize_öode
 !
NULL
)

2083 
	`ùut
(
ªsize_öode
);

2084 i‡(
îr
)

2085 
	`pxt4_w¨nög
(
sb
, "error (%d) occurred during "

2086 "fûêsy°emÑesize", 
îr
);

2087 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "resized filesystemÅo %llu",

2088 
	`pxt4_blocks_cou¡
(
es
));

2089  
îr
;

2090 
	}
}

	@super.c

20 
	~<löux/moduÀ.h
>

21 
	~<löux/°rög.h
>

22 
	~<löux/fs.h
>

23 
	~<löux/time.h
>

24 
	~<löux/vmÆloc.h
>

25 
	~<löux/¶ab.h
>

26 
	~<löux/öô.h
>

27 
	~<löux/blkdev.h
>

28 
	~<löux/backög-dev.h
>

29 
	~<löux/∑r£r.h
>

30 
	~<löux/buf„r_hód.h
>

31 
	~<löux/exp‹tfs.h
>

32 
	~<löux/vfs.h
>

33 
	~<löux/øndom.h
>

34 
	~<löux/mou¡.h
>

35 
	~<löux/«mei.h
>

36 
	~<löux/quŸa›s.h
>

37 
	~<löux/£q_fûe.h
>

38 
	~<löux/˘y≥.h
>

39 
	~<löux/log2.h
>

40 
	~<löux/¸c16.h
>

41 
	~<löux/dax.h
>

42 
	~<löux/˛ónˇche.h
>

43 
	~<löux/uac˚ss.h
>

44 
	~<löux/ivîsi⁄.h
>

46 
	~<löux/kthªad.h
>

47 
	~<löux/‰ìzî.h
>

49 
	~"pxt4.h
"

50 
	~"pxt4_exã¡s.h
"

51 
	~"pxt4_jbd3.h
"

52 
	~"x©å.h
"

53 
	~"a˛.h
"

54 
	~"mbÆloc.h
"

55 
	~"fsm≠.h
"

57 
	#CREATE_TRACE_POINTS


	)

58 
	~<åa˚/evíts/pxt4.h
>

60 
pxt4_œzy_öô
 *
	gpxt4_li_öfo
;

61 
muãx
 
	gpxt4_li_mtx
;

62 
øãlimô_°©e
 
	gpxt4_mou¡_msg_øãlimô
;

64 
pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *, 
pxt4_su≥r_block
 *,

65 
jou∫Æ_devnum
);

66 
pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
);

67 
pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
);

68 
pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

69 
pxt4_su≥r_block
 *
es
);

70 
pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

71 
pxt4_su≥r_block
 *
es
);

72 
pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
);

73 
pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
);

74 
pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
);

75 
pxt4_un‰ìze
(
su≥r_block
 *
sb
);

76 
pxt4_‰ìze
(
su≥r_block
 *
sb
);

77 
díåy
 *
pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

78 c⁄° *
dev_«me
, *
d©a
);

79 
ölöe
 
pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
);

80 
ölöe
 
ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
);

81 
pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
);

82 
pxt4_de°roy_œzyöô_thªad
();

83 
pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
);

84 
pxt4_˛ór_ªque°_li°
();

85 
öode
 *
pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

86 
jou∫Æ_öum
);

116 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

117 
fûe_sy°em_ty≥
 
	gpxt2_fs_ty≥
 = {

118 .
ow√r
 = 
THIS_MODULE
,

119 .
	g«me
 = "pxt2",

120 .
	gmou¡
 = 
pxt4_mou¡
,

121 .
	gkûl_sb
 = 
kûl_block_su≥r
,

122 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

124 
MODULE_ALIAS_FS
("pxt2");

125 
MODULE_ALIAS
("pxt2");

126 
	#IS_PXT2_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
pxt2_fs_ty≥
)

	)

128 
	#IS_PXT2_SB
(
sb
Ë(0)

	)

132 
fûe_sy°em_ty≥
 
	gext3_fs_ty≥
 = {

133 .
ow√r
 = 
THIS_MODULE
,

134 .
	g«me
 = "ext3",

135 .
	gmou¡
 = 
pxt4_mou¡
,

136 .
	gkûl_sb
 = 
kûl_block_su≥r
,

137 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

139 
MODULE_ALIAS_FS
("ext3");

140 
MODULE_ALIAS
("ext3");

141 
	#IS_EXT3_SB
(
sb
Ë((sb)->
s_bdev
->
bd_hﬁdî
 =&
ext3_fs_ty≥
)

	)

149 
buf„r_hód
 *

150 
	$pxt4_sb_bªad
(
su≥r_block
 *
sb
, 
£˘‹_t
 
block
, 
›_Êags
)

152 
buf„r_hód
 *
bh
 = 
	`sb_gëblk
(
sb
, 
block
);

154 i‡(
bh
 =
NULL
)

155  
	`ERR_PTR
(-
ENOMEM
);

156 i‡(
	`buf„r_u±od©e
(
bh
))

157  
bh
;

158 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
›_Êags
, 1, &
bh
);

159 
	`waô_⁄_buf„r
(
bh
);

160 i‡(
	`buf„r_u±od©e
(
bh
))

161  
bh
;

162 
	`put_bh
(
bh
);

163  
	`ERR_PTR
(-
EIO
);

164 
	}
}

166 
	$pxt4_vîify_csum_ty≥
(
su≥r_block
 *
sb
,

167 
pxt4_su≥r_block
 *
es
)

169 i‡(!
	`pxt4_has_„©uª_mëad©a_csum
(
sb
))

172  
es
->
s_checksum_ty≥
 =
PXT4_CRC32C_CHKSUM
;

173 
	}
}

175 
__À32
 
	$pxt4_su≥rblock_csum
(
su≥r_block
 *
sb
,

176 
pxt4_su≥r_block
 *
es
)

178 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

179 
off£t
 = 
	`off£tof
(
pxt4_su≥r_block
, 
s_checksum
);

180 
__u32
 
csum
;

182 
csum
 = 
	`pxt4_chksum
(
sbi
, ~0, (*)
es
, 
off£t
);

184  
	`˝u_to_À32
(
csum
);

185 
	}
}

187 
	$pxt4_su≥rblock_csum_vîify
(
su≥r_block
 *
sb
,

188 
pxt4_su≥r_block
 *
es
)

190 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

193  
es
->
s_checksum
 =
	`pxt4_su≥rblock_csum
(
sb
,És);

194 
	}
}

196 
	$pxt4_su≥rblock_csum_£t
(
su≥r_block
 *
sb
)

198 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

200 i‡(!
	`pxt4_has_mëad©a_csum
(
sb
))

203 
es
->
s_checksum
 = 
	`pxt4_su≥rblock_csum
(
sb
,És);

204 
	}
}

206 *
	$pxt4_kvmÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

208 *
ªt
;

210 
ªt
 = 
	`kmÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

211 i‡(!
ªt
)

212 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
, 
PAGE_KERNEL
);

213  
ªt
;

214 
	}
}

216 *
	$pxt4_kvzÆloc
(
size_t
 
size
, 
gÂ_t
 
Êags
)

218 *
ªt
;

220 
ªt
 = 
	`kzÆloc
(
size
, 
Êags
 | 
__GFP_NOWARN
);

221 i‡(!
ªt
)

222 
ªt
 = 
	`__vmÆloc
(
size
, 
Êags
 | 
__GFP_ZERO
, 
PAGE_KERNEL
);

223  
ªt
;

224 
	}
}

226 
pxt4_fsblk_t
 
	$pxt4_block_bôm≠
(
su≥r_block
 *
sb
,

227 
pxt4_group_desc
 *
bg
)

229  
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_lo
) |

230 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

231 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_block_bôm≠_hi
) << 32 : 0);

232 
	}
}

234 
pxt4_fsblk_t
 
	$pxt4_öode_bôm≠
(
su≥r_block
 *
sb
,

235 
pxt4_group_desc
 *
bg
)

237  
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_lo
) |

238 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

239 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_bôm≠_hi
) << 32 : 0);

240 
	}
}

242 
pxt4_fsblk_t
 
	$pxt4_öode_èbÀ
(
su≥r_block
 *
sb
,

243 
pxt4_group_desc
 *
bg
)

245  
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_lo
) |

246 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

247 (
pxt4_fsblk_t
)
	`À32_to_˝u
(
bg
->
bg_öode_èbÀ_hi
) << 32 : 0);

248 
	}
}

250 
__u32
 
	$pxt4_‰ì_group_˛u°îs
(
su≥r_block
 *
sb
,

251 
pxt4_group_desc
 *
bg
)

253  
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_lo
) |

254 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

255 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_blocks_cou¡_hi
) << 16 : 0);

256 
	}
}

258 
__u32
 
	$pxt4_‰ì_öodes_cou¡
(
su≥r_block
 *
sb
,

259 
pxt4_group_desc
 *
bg
)

261  
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_lo
) |

262 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

263 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_‰ì_öodes_cou¡_hi
) << 16 : 0);

264 
	}
}

266 
__u32
 
	$pxt4_u£d_dús_cou¡
(
su≥r_block
 *
sb
,

267 
pxt4_group_desc
 *
bg
)

269  
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_lo
) |

270 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

271 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_u£d_dús_cou¡_hi
) << 16 : 0);

272 
	}
}

274 
__u32
 
	$pxt4_ôabÀ_unu£d_cou¡
(
su≥r_block
 *
sb
,

275 
pxt4_group_desc
 *
bg
)

277  
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_lo
) |

278 (
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
 ?

279 (
__u32
)
	`À16_to_˝u
(
bg
->
bg_ôabÀ_unu£d_hi
) << 16 : 0);

280 
	}
}

282 
	$pxt4_block_bôm≠_£t
(
su≥r_block
 *
sb
,

283 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

285 
bg
->
bg_block_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

286 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

287 
bg
->
bg_block_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

288 
	}
}

290 
	$pxt4_öode_bôm≠_£t
(
su≥r_block
 *
sb
,

291 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

293 
bg
->
bg_öode_bôm≠_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

294 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

295 
bg
->
bg_öode_bôm≠_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

296 
	}
}

298 
	$pxt4_öode_èbÀ_£t
(
su≥r_block
 *
sb
,

299 
pxt4_group_desc
 *
bg
, 
pxt4_fsblk_t
 
blk
)

301 
bg
->
bg_öode_èbÀ_lo
 = 
	`˝u_to_À32
((
u32
)
blk
);

302 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

303 
bg
->
bg_öode_èbÀ_hi
 = 
	`˝u_to_À32
(
blk
 >> 32);

304 
	}
}

306 
	$pxt4_‰ì_group_˛u°îs_£t
(
su≥r_block
 *
sb
,

307 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

309 
bg
->
bg_‰ì_blocks_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

310 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

311 
bg
->
bg_‰ì_blocks_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

312 
	}
}

314 
	$pxt4_‰ì_öodes_£t
(
su≥r_block
 *
sb
,

315 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

317 
bg
->
bg_‰ì_öodes_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

318 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

319 
bg
->
bg_‰ì_öodes_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

320 
	}
}

322 
	$pxt4_u£d_dús_£t
(
su≥r_block
 *
sb
,

323 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

325 
bg
->
bg_u£d_dús_cou¡_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

326 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

327 
bg
->
bg_u£d_dús_cou¡_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

328 
	}
}

330 
	$pxt4_ôabÀ_unu£d_£t
(
su≥r_block
 *
sb
,

331 
pxt4_group_desc
 *
bg
, 
__u32
 
cou¡
)

333 
bg
->
bg_ôabÀ_unu£d_lo
 = 
	`˝u_to_À16
((
__u16
)
cou¡
);

334 i‡(
	`PXT4_DESC_SIZE
(
sb
Ë>
PXT4_MIN_DESC_SIZE_64BIT
)

335 
bg
->
bg_ôabÀ_unu£d_hi
 = 
	`˝u_to_À16
(
cou¡
 >> 16);

336 
	}
}

338 
	$__pxt4_upd©e_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

340 
time64_t
 
now
 = 
	`ktime_gë_ªÆ_£c⁄ds
();

342 
now
 = 
	`˛amp_vÆ
(now, 0, (1ull << 40) - 1);

344 *
lo
 = 
	`˝u_to_À32
(
	`lowî_32_bôs
(
now
));

345 *
hi
 = 
	`uµî_32_bôs
(
now
);

346 
	}
}

348 
time64_t
 
	$__pxt4_gë_t°amp
(
__À32
 *
lo
, 
__u8
 *
hi
)

350  ((
time64_t
)(*
hi
Ë<< 32Ë+ 
	`À32_to_˝u
(*
lo
);

351 
	}
}

352 
	#pxt4_upd©e_t°amp
(
es
, 
t°amp
) \

353 
	`__pxt4_upd©e_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

354 
	#pxt4_gë_t°amp
(
es
, 
t°amp
) \

355 
	`__pxt4_gë_t°amp
(&(
es
)->
t°amp
, &”s)->t°am∞## 
_hi
)

	)

357 
	$__ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

358 
löe
)

360 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

362 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

363 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
))

365 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

366 
	`pxt4_upd©e_t°amp
(
es
, 
s_œ°_îr‹_time
);

367 
	`°∫˝y
(
es
->
s_œ°_îr‹_func
, 
func
, (es->s_last_error_func));

368 
es
->
s_œ°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

369 i‡(!
es
->
s_fú°_îr‹_time
) {

370 
es
->
s_fú°_îr‹_time
 =És->
s_œ°_îr‹_time
;

371 
es
->
s_fú°_îr‹_time_hi
 =És->
s_œ°_îr‹_time_hi
;

372 
	`°∫˝y
(
es
->
s_fú°_îr‹_func
, 
func
,

373 (
es
->
s_fú°_îr‹_func
));

374 
es
->
s_fú°_îr‹_löe
 = 
	`˝u_to_À32
(
löe
);

375 
es
->
s_fú°_îr‹_öo
 =És->
s_œ°_îr‹_öo
;

376 
es
->
s_fú°_îr‹_block
 =És->
s_œ°_îr‹_block
;

382 i‡(!
es
->
s_îr‹_cou¡
)

383 
	`mod_timî
(&
	`PXT4_SB
(
sb
)->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

384 
	`À32_add_˝u
(&
es
->
s_îr‹_cou¡
, 1);

385 
	}
}

387 
	$ßve_îr‹_öfo
(
su≥r_block
 *
sb
, c⁄° *
func
,

388 
löe
)

390 
	`__ßve_îr‹_öfo
(
sb
, 
func
, 
löe
);

391 
	`pxt4_commô_su≥r
(
sb
, 1);

392 
	}
}

402 
	$block_devi˚_eje˘ed
(
su≥r_block
 *
sb
)

404 
öode
 *
bd_öode
 = 
sb
->
s_bdev
->bd_inode;

405 
backög_dev_öfo
 *
bdi
 = 
	`öode_to_bdi
(
bd_öode
);

407  
bdi
->
dev
 =
NULL
;

408 
	}
}

410 
	$pxt4_jou∫Æ_commô_ˇŒback
(
jou∫Æ_t
 *
jou∫Æ
, 
å™ß˘i⁄_t
 *
txn
)

412 
su≥r_block
 *
sb
 = 
jou∫Æ
->
j_¥iv©e
;

413 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

414 
îr‹
 = 
	`is_jou∫Æ_ab‹ãd
(
jou∫Æ
);

415 
pxt4_jou∫Æ_cb_íåy
 *
j˚
;

417 
	`BUG_ON
(
txn
->
t_°©e
 =
T_FINISHED
);

419 
	`pxt4_¥o˚ss_‰ìd_d©a
(
sb
, 
txn
->
t_tid
);

421 
	`•ö_lock
(&
sbi
->
s_md_lock
);

422 !
	`li°_em±y
(&
txn
->
t_¥iv©e_li°
)) {

423 
j˚
 = 
	`li°_íåy
(
txn
->
t_¥iv©e_li°
.
√xt
,

424 
pxt4_jou∫Æ_cb_íåy
, 
j˚_li°
);

425 
	`li°_dñ_öô
(&
j˚
->
j˚_li°
);

426 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

427 
j˚
->
	`j˚_func
(
sb
, j˚, 
îr‹
);

428 
	`•ö_lock
(&
sbi
->
s_md_lock
);

430 
	`•ö_u∆ock
(&
sbi
->
s_md_lock
);

431 
	}
}

433 
boﬁ
 
	$sy°em_goög_down
()

435  
sy°em_°©e
 =
SYSTEM_HALT
 || sy°em_°©ê=
SYSTEM_POWER_OFF


436 || 
sy°em_°©e
 =
SYSTEM_RESTART
;

437 
	}
}

454 
	$pxt4_h™dÀ_îr‹
(
su≥r_block
 *
sb
)

456 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

457 
	`WARN_ON_ONCE
(1);

459 i‡(
	`sb_rd⁄ly
(
sb
))

462 i‡(!
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

463 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

465 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

466 i‡(
jou∫Æ
)

467 
	`jbd3_jou∫Æ_ab‹t
(
jou∫Æ
, -
EIO
);

474 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë|| 
	`sy°em_goög_down
()) {

475 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

480 
	`smp_wmb
();

481 
sb
->
s_Êags
 |
SB_RDONLY
;

482 } i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
)) {

483 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

484 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

486 
	`∑nic
("PXT4-fs (device %s):Öanic forcedáfterÉrror\n",

487 
sb
->
s_id
);

489 
	}
}

491 
	#pxt4_îr‹_øãlimô
(
sb
) \

492 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_îr_øãlimô_°©e
), \

493 "PXT4-f†îr‹")

	)

495 
	$__pxt4_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

496 
löe
, c⁄° *
fmt
, ...)

498 
va_f‹m©
 
vaf
;

499 
va_li°
 
¨gs
;

501 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

504 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

505 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

506 
	`va_°¨t
(
¨gs
, 
fmt
);

507 
vaf
.
fmt
 = fmt;

508 
vaf
.
va
 = &
¨gs
;

509 
	`¥ötk
(
KERN_CRIT


511 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
cuºít
->
comm
, &
vaf
);

512 
	`va_íd
(
¨gs
);

514 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

515 
	`pxt4_h™dÀ_îr‹
(
sb
);

516 
	}
}

518 
	$__pxt4_îr‹_öode
(
öode
 *öode, c⁄° *
fun˘i⁄
,

519 
löe
, 
pxt4_fsblk_t
 
block
,

520 c⁄° *
fmt
, ...)

522 
va_li°
 
¨gs
;

523 
va_f‹m©
 
vaf
;

524 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

526 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

529 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

530 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

531 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

532 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

533 
	`va_°¨t
(
¨gs
, 
fmt
);

534 
vaf
.
fmt
 = fmt;

535 
vaf
.
va
 = &
¨gs
;

536 i‡(
block
)

537 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

539 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

540 
block
, 
cuºít
->
comm
, &
vaf
);

542 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: "

544 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

545 
cuºít
->
comm
, &
vaf
);

546 
	`va_íd
(
¨gs
);

548 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

549 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

550 
	}
}

552 
	$__pxt4_îr‹_fûe
(
fûe
 *fûe, c⁄° *
fun˘i⁄
,

553 
löe
, 
pxt4_fsblk_t
 
block
,

554 c⁄° *
fmt
, ...)

556 
va_li°
 
¨gs
;

557 
va_f‹m©
 
vaf
;

558 
pxt4_su≥r_block
 *
es
;

559 
öode
 *öodê
	`fûe_öode
(
fûe
);

560 
∑th«me
[80], *
∑th
;

562 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

565 
	`åa˚_pxt4_îr‹
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

566 
es
 = 
	`PXT4_SB
(
öode
->
i_sb
)->
s_es
;

567 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öode
->
i_öo
);

568 i‡(
	`pxt4_îr‹_øãlimô
(
öode
->
i_sb
)) {

569 
∑th
 = 
	`fûe_∑th
(
fûe
, 
∑th«me
, (pathname));

570 i‡(
	`IS_ERR
(
∑th
))

571 
∑th
 = "(unknown)";

572 
	`va_°¨t
(
¨gs
, 
fmt
);

573 
vaf
.
fmt
 = fmt;

574 
vaf
.
va
 = &
¨gs
;

575 i‡(
block
)

576 
	`¥ötk
(
KERN_CRIT


579 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

580 
block
, 
cuºít
->
comm
, 
∑th
, &
vaf
);

582 
	`¥ötk
(
KERN_CRIT


585 
öode
->
i_sb
->
s_id
, 
fun˘i⁄
, 
löe
, inode->
i_öo
,

586 
cuºít
->
comm
, 
∑th
, &
vaf
);

587 
	`va_íd
(
¨gs
);

589 
	`ßve_îr‹_öfo
(
öode
->
i_sb
, 
fun˘i⁄
, 
löe
);

590 
	`pxt4_h™dÀ_îr‹
(
öode
->
i_sb
);

591 
	}
}

593 c⁄° *
	$pxt4_decode_îr‹
(
su≥r_block
 *
sb
, 
î∫o
,

594 
nbuf
[16])

596 *
îr°r
 = 
NULL
;

598 
î∫o
) {

599 -
EFSCORRUPTED
:

600 
îr°r
 = "Corrupt filesystem";

602 -
EFSBADCRC
:

603 
îr°r
 = "Filesystem failed CRC";

605 -
EIO
:

606 
îr°r
 = "IO failure";

608 -
ENOMEM
:

609 
îr°r
 = "Out of memory";

611 -
EROFS
:

612 i‡(!
sb
 || (
	`PXT4_SB
(sb)->
s_jou∫Æ
 &&

613 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_ABORT
))

614 
îr°r
 = "Journal hasáborted";

616 
îr°r
 = "Readonly filesystem";

622 i‡(
nbuf
) {

624 i‡(
	`¢¥ötf
(
nbuf
, 16, "îr‹ %d", -
î∫o
) >= 0)

625 
îr°r
 = 
nbuf
;

630  
îr°r
;

631 
	}
}

636 
	$__pxt4_°d_îr‹
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

637 
löe
, 
î∫o
)

639 
nbuf
[16];

640 c⁄° *
îr°r
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

648 i‡(
î∫o
 =-
EROFS
 && 
	`jou∫Æ_cuºít_h™dÀ
(Ë=
NULL
 && 
	`sb_rd⁄ly
(
sb
))

651 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

652 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
î∫o
, 
nbuf
);

653 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s) in %s:%d: %s\n",

654 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
îr°r
);

657 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

658 
	`pxt4_h™dÀ_îr‹
(
sb
);

659 
	}
}

671 
	$__pxt4_ab‹t
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

672 
löe
, c⁄° *
fmt
, ...)

674 
va_f‹m©
 
vaf
;

675 
va_li°
 
¨gs
;

677 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

680 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

681 
	`va_°¨t
(
¨gs
, 
fmt
);

682 
vaf
.
fmt
 = fmt;

683 
vaf
.
va
 = &
¨gs
;

684 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: %pV\n",

685 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

686 
	`va_íd
(
¨gs
);

688 i‡(
	`sb_rd⁄ly
(
sb
) == 0) {

689 
	`pxt4_msg
(
sb
, 
KERN_CRIT
, "Remounting filesystemÑead-only");

690 
	`PXT4_SB
(
sb
)->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

695 
	`smp_wmb
();

696 
sb
->
s_Êags
 |
SB_RDONLY
;

697 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
)

698 
	`jbd3_jou∫Æ_ab‹t
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, -
EIO
);

699 
	`ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

701 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& !
	`sy°em_goög_down
()) {

702 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

703 !(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
->
j_Êags
 & 
JBD3_REC_ERR
))

705 
	`∑nic
("PXT4-fsÖanic fromÖreviousÉrror\n");

707 
	}
}

709 
	$__pxt4_msg
(
su≥r_block
 *
sb
,

710 c⁄° *
¥efix
, c⁄° *
fmt
, ...)

712 
va_f‹m©
 
vaf
;

713 
va_li°
 
¨gs
;

715 i‡(!
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_msg_øãlimô_°©e
), "PXT4-fs"))

718 
	`va_°¨t
(
¨gs
, 
fmt
);

719 
vaf
.
fmt
 = fmt;

720 
vaf
.
va
 = &
¨gs
;

721 
	`¥ötk
("%sPXT4-f†(%s): %pV\n", 
¥efix
, 
sb
->
s_id
, &
vaf
);

722 
	`va_íd
(
¨gs
);

723 
	}
}

725 
	#pxt4_w¨nög_øãlimô
(
sb
) \

726 
	`___øãlimô
(&(
	`PXT4_SB
(
sb
)->
s_w¨nög_øãlimô_°©e
), \

727 "PXT4-f†w¨nög")

	)

729 
	$__pxt4_w¨nög
(
su≥r_block
 *
sb
, c⁄° *
fun˘i⁄
,

730 
löe
, c⁄° *
fmt
, ...)

732 
va_f‹m©
 
vaf
;

733 
va_li°
 
¨gs
;

735 i‡(!
	`pxt4_w¨nög_øãlimô
(
sb
))

738 
	`va_°¨t
(
¨gs
, 
fmt
);

739 
vaf
.
fmt
 = fmt;

740 
vaf
.
va
 = &
¨gs
;

741 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: %pV\n",

742 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, &
vaf
);

743 
	`va_íd
(
¨gs
);

744 
	}
}

746 
	$__pxt4_w¨nög_öode
(c⁄° 
öode
 *öode, c⁄° *
fun˘i⁄
,

747 
löe
, c⁄° *
fmt
, ...)

749 
va_f‹m©
 
vaf
;

750 
va_li°
 
¨gs
;

752 i‡(!
	`pxt4_w¨nög_øãlimô
(
öode
->
i_sb
))

755 
	`va_°¨t
(
¨gs
, 
fmt
);

756 
vaf
.
fmt
 = fmt;

757 
vaf
.
va
 = &
¨gs
;

758 
	`¥ötk
(
KERN_WARNING
 "PXT4-fs warning (device %s): %s:%d: "

759 "öodê#%lu: comm %s: %pV\n", 
öode
->
i_sb
->
s_id
,

760 
fun˘i⁄
, 
löe
, 
öode
->
i_öo
, 
cuºít
->
comm
, &
vaf
);

761 
	`va_íd
(
¨gs
);

762 
	}
}

764 
	$__pxt4_gΩ_locked_îr‹
(c⁄° *
fun˘i⁄
, 
löe
,

765 
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

766 
öo
, 
pxt4_fsblk_t
 
block
,

767 c⁄° *
fmt
, ...)

768 
	$__ªÀa£s
(
bôlock
)

769 
	$__acquúes
(
bôlock
)

771 
va_f‹m©
 
vaf
;

772 
va_li°
 
¨gs
;

773 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

775 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
sb
))))

778 
	`åa˚_pxt4_îr‹
(
sb
, 
fun˘i⁄
, 
löe
);

779 
es
->
s_œ°_îr‹_öo
 = 
	`˝u_to_À32
(
öo
);

780 
es
->
s_œ°_îr‹_block
 = 
	`˝u_to_À64
(
block
);

781 
	`__ßve_îr‹_öfo
(
sb
, 
fun˘i⁄
, 
löe
);

783 i‡(
	`pxt4_îr‹_øãlimô
(
sb
)) {

784 
	`va_°¨t
(
¨gs
, 
fmt
);

785 
vaf
.
fmt
 = fmt;

786 
vaf
.
va
 = &
¨gs
;

787 
	`¥ötk
(
KERN_CRIT
 "PXT4-fsÉrror (device %s): %s:%d: group %u, ",

788 
sb
->
s_id
, 
fun˘i⁄
, 
löe
, 
gΩ
);

789 i‡(
öo
)

790 
	`¥ötk
(
KERN_CONT
 "öodê%lu: ", 
öo
);

791 i‡(
block
)

792 
	`¥ötk
(
KERN_CONT
 "block %llu:",

793 (Ë
block
);

794 
	`¥ötk
(
KERN_CONT
 "%pV\n", &
vaf
);

795 
	`va_íd
(
¨gs
);

798 i‡(
	`ã°_›t
(
sb
, 
WARN_ON_ERROR
))

799 
	`WARN_ON_ONCE
(1);

801 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
)) {

802 
	`pxt4_commô_su≥r
(
sb
, 0);

806 
	`pxt4_u∆ock_group
(
sb
, 
gΩ
);

807 
	`pxt4_commô_su≥r
(
sb
, 1);

808 
	`pxt4_h™dÀ_îr‹
(
sb
);

820 
	`pxt4_lock_group
(
sb
, 
gΩ
);

822 
	}
}

824 
	$pxt4_m¨k_group_bôm≠_c‹ru±ed
(
su≥r_block
 *
sb
,

825 
pxt4_group_t
 
group
,

826 
Êags
)

828 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

829 
pxt4_group_öfo
 *
gΩ
 = 
	`pxt4_gë_group_öfo
(
sb
, 
group
);

830 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

831 
ªt
;

833 i‡(
Êags
 & 
PXT4_GROUP_INFO_BBITMAP_CORRUPT
) {

834 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_BBITMAP_CORRUPT_BIT
,

835 &
gΩ
->
bb_°©e
);

836 i‡(!
ªt
)

837 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ì˛u°îs_cou¡î
,

838 
gΩ
->
bb_‰ì
);

841 i‡(
Êags
 & 
PXT4_GROUP_INFO_IBITMAP_CORRUPT
) {

842 
ªt
 = 
	`pxt4_ã°_™d_£t_bô
(
PXT4_GROUP_INFO_IBITMAP_CORRUPT_BIT
,

843 &
gΩ
->
bb_°©e
);

844 i‡(!
ªt
 && 
gdp
) {

845 
cou¡
;

847 
cou¡
 = 
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
);

848 
	`≥r˝u_cou¡î_sub
(&
sbi
->
s_‰ìöodes_cou¡î
,

849 
cou¡
);

852 
	}
}

854 
	$pxt4_upd©e_dy«mic_ªv
(
su≥r_block
 *
sb
)

856 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

858 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_GOOD_OLD_REV
)

861 
	`pxt4_w¨nög
(
sb
,

864 
PXT4_DYNAMIC_REV
);

866 
es
->
s_fú°_öo
 = 
	`˝u_to_À32
(
PXT4_GOOD_OLD_FIRST_INO
);

867 
es
->
s_öode_size
 = 
	`˝u_to_À16
(
PXT4_GOOD_OLD_INODE_SIZE
);

868 
es
->
s_ªv_Àvñ
 = 
	`˝u_to_À32
(
PXT4_DYNAMIC_REV
);

877 
	}
}

882 
block_devi˚
 *
	$pxt4_blkdev_gë
(
dev_t
 
dev
, 
su≥r_block
 *
sb
)

884 
block_devi˚
 *
bdev
;

885 
b
[
BDEVNAME_SIZE
];

887 
bdev
 = 
	`blkdev_gë_by_dev
(
dev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
, 
sb
);

888 i‡(
	`IS_ERR
(
bdev
))

889 
Áû
;

890  
bdev
;

892 
Áû
:

893 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo open journal device %s: %ld",

894 
	`__bdev«me
(
dev
, 
b
), 
	`PTR_ERR
(
bdev
));

895  
NULL
;

896 
	}
}

901 
	$pxt4_blkdev_put
(
block_devi˚
 *
bdev
)

903 
	`blkdev_put
(
bdev
, 
FMODE_READ
|
FMODE_WRITE
|
FMODE_EXCL
);

904 
	}
}

906 
	$pxt4_blkdev_ªmove
(
pxt4_sb_öfo
 *
sbi
)

908 
block_devi˚
 *
bdev
;

909 
bdev
 = 
sbi
->
jou∫Æ_bdev
;

910 i‡(
bdev
) {

911 
	`pxt4_blkdev_put
(
bdev
);

912 
sbi
->
jou∫Æ_bdev
 = 
NULL
;

914 
	}
}

916 
ölöe
 
öode
 *
	$‹ph™_li°_íåy
(
li°_hód
 *
l
)

918  &
	`li°_íåy
(
l
, 
pxt4_öode_öfo
, 
i_‹ph™
)->
vfs_öode
;

919 
	}
}

921 
	$dump_‹ph™_li°
(
su≥r_block
 *
sb
, 
pxt4_sb_öfo
 *
sbi
)

923 
li°_hód
 *
l
;

925 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "sb orphan head is %d",

926 
	`À32_to_˝u
(
sbi
->
s_es
->
s_œ°_‹ph™
));

928 
	`¥ötk
(
KERN_ERR
 "sb_info orphanÜist:\n");

929 
	`li°_f‹_óch
(
l
, &
sbi
->
s_‹ph™
) {

930 
öode
 *öodê
	`‹ph™_li°_íåy
(
l
);

931 
	`¥ötk
(
KERN_ERR
 " "

933 
öode
->
i_sb
->
s_id
, inode->
i_öo
, inode,

934 
öode
->
i_mode
, inode->
i_∆ök
,

935 
	`NEXT_ORPHAN
(
öode
));

937 
	}
}

939 #ifde‡
CONFIG_QUOTA


940 
pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
);

942 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

944 
ty≥
;

947 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++)

948 
	`pxt4_quŸa_off
(
sb
, 
ty≥
);

949 
	}
}

955 
ölöe
 *
	$gë_qf_«me
(
su≥r_block
 *
sb
,

956 
pxt4_sb_öfo
 *
sbi
,

957 
ty≥
)

959  
	`rcu_dîe„ªn˚_¥Ÿe˘ed
(
sbi
->
s_qf_«mes
[
ty≥
],

960 
	`lockdï_is_hñd
(&
sb
->
s_umou¡
));

961 
	}
}

963 
ölöe
 
	$pxt4_quŸa_off_umou¡
(
su≥r_block
 *
sb
)

965 
	}
}

968 
	$pxt4_put_su≥r
(
su≥r_block
 *
sb
)

970 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

971 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

972 
ab‹ãd
 = 0;

973 
i
, 
îr
;

975 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

976 
	`pxt4_quŸa_off_umou¡
(
sb
);

978 
	`de°roy_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

980 i‡(
sbi
->
s_jou∫Æ
) {

981 
ab‹ãd
 = 
	`is_jou∫Æ_ab‹ãd
(
sbi
->
s_jou∫Æ
);

982 
îr
 = 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

983 
sbi
->
s_jou∫Æ
 = 
NULL
;

984 i‡((
îr
 < 0Ë&& !
ab‹ãd
)

985 
	`pxt4_ab‹t
(
sb
, "Couldn't clean upÅhe journal");

988 
	`pxt4_uƒegi°î_sysfs
(
sb
);

989 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

990 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

991 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

992 
	`pxt4_mb_ªÀa£
(
sb
);

993 
	`pxt4_ext_ªÀa£
(
sb
);

995 i‡(!
	`sb_rd⁄ly
(
sb
Ë&& !
ab‹ãd
) {

996 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

997 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

999 i‡(!
	`sb_rd⁄ly
(
sb
))

1000 
	`pxt4_commô_su≥r
(
sb
, 1);

1002 
i
 = 0; i < 
sbi
->
s_gdb_cou¡
; i++)

1003 
	`bªl£
(
sbi
->
s_group_desc
[
i
]);

1004 
	`kv‰ì
(
sbi
->
s_group_desc
);

1005 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

1006 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

1007 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

1008 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

1009 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

1010 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

1011 #ifde‡
CONFIG_QUOTA


1012 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

1013 
	`k‰ì
(
	`gë_qf_«me
(
sb
, 
sbi
, 
i
));

1020 i‡(!
	`li°_em±y
(&
sbi
->
s_‹ph™
))

1021 
	`dump_‹ph™_li°
(
sb
, 
sbi
);

1022 
	`J_ASSERT
(
	`li°_em±y
(&
sbi
->
s_‹ph™
));

1024 
	`sync_blockdev
(
sb
->
s_bdev
);

1025 
	`övÆid©e_bdev
(
sb
->
s_bdev
);

1026 i‡(
sbi
->
jou∫Æ_bdev
 && sbi->jou∫Æ_bdev !
sb
->
s_bdev
) {

1032 
	`sync_blockdev
(
sbi
->
jou∫Æ_bdev
);

1033 
	`övÆid©e_bdev
(
sbi
->
jou∫Æ_bdev
);

1034 
	`pxt4_blkdev_ªmove
(
sbi
);

1037 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

1038 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

1040 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

1041 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

1043 i‡(
sbi
->
s_mmp_tsk
)

1044 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

1045 
	`bªl£
(
sbi
->
s_sbh
);

1046 
sb
->
s_fs_öfo
 = 
NULL
;

1051 
	`kobje˘_put
(&
sbi
->
s_kobj
);

1052 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

1053 i‡(
sbi
->
s_chksum_drivî
)

1054 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

1055 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

1056 
	`fs_put_dax
(
sbi
->
s_daxdev
);

1057 
	`k‰ì
(
sbi
);

1058 
	}
}

1060 
kmem_ˇche
 *
	gpxt4_öode_ˇchï
;

1065 
öode
 *
	$pxt4_Æloc_öode
(
su≥r_block
 *
sb
)

1067 
pxt4_öode_öfo
 *
ei
;

1069 
ei
 = 
	`kmem_ˇche_Æloc
(
pxt4_öode_ˇchï
, 
GFP_NOFS
);

1070 i‡(!
ei
)

1071  
NULL
;

1073 
	`öode_£t_ivîsi⁄
(&
ei
->
vfs_öode
, 1);

1074 
	`•ö_lock_öô
(&
ei
->
i_øw_lock
);

1075 
	`INIT_LIST_HEAD
(&
ei
->
i_¥óŒoc_li°
);

1076 
	`•ö_lock_öô
(&
ei
->
i_¥óŒoc_lock
);

1077 
	`pxt4_es_öô_åì
(&
ei
->
i_es_åì
);

1078 
	`rwlock_öô
(&
ei
->
i_es_lock
);

1079 
	`INIT_LIST_HEAD
(&
ei
->
i_es_li°
);

1080 
ei
->
i_es_Æl_ƒ
 = 0;

1081 
ei
->
i_es_shk_ƒ
 = 0;

1082 
ei
->
i_es_shrök_lblk
 = 0;

1083 
ei
->
i_ª£rved_d©a_blocks
 = 0;

1084 
ei
->
i_da_mëad©a_ˇlc_Àn
 = 0;

1085 
ei
->
i_da_mëad©a_ˇlc_œ°_lblock
 = 0;

1086 
	`•ö_lock_öô
(&(
ei
->
i_block_ª£rv©i⁄_lock
));

1087 
	`pxt4_öô_≥ndög_åì
(&
ei
->
i_≥ndög_åì
);

1088 #ifde‡
CONFIG_QUOTA


1089 
ei
->
i_ª£rved_quŸa
 = 0;

1090 
	`mem£t
(&
ei
->
i_dquŸ
, 0, (ei->i_dquot));

1092 
ei
->
jöode
 = 
NULL
;

1093 
	`INIT_LIST_HEAD
(&
ei
->
i_rsv_c⁄vîsi⁄_li°
);

1094 
	`•ö_lock_öô
(&
ei
->
i_com∂ëed_io_lock
);

1095 
ei
->
i_sync_tid
 = 0;

1096 
ei
->
i_d©async_tid
 = 0;

1097 
	`©omic_£t
(&
ei
->
i_unwrôãn
, 0);

1098 
	`INIT_WORK
(&
ei
->
i_rsv_c⁄vîsi⁄_w‹k
, 
pxt4_íd_io_rsv_w‹k
);

1099  &
ei
->
vfs_öode
;

1100 
	}
}

1102 
	$pxt4_dr›_öode
(
öode
 *inode)

1104 
dr›
 = 
	`gíîic_dr›_öode
(
öode
);

1106 
	`åa˚_pxt4_dr›_öode
(
öode
, 
dr›
);

1107  
dr›
;

1108 
	}
}

1110 
	$pxt4_i_ˇŒback
(
rcu_hód
 *
hód
)

1112 
öode
 *öodê
	`c⁄èöî_of
(
hód
, öode, 
i_rcu
);

1113 
	`kmem_ˇche_‰ì
(
pxt4_öode_ˇchï
, 
	`PXT4_I
(
öode
));

1114 
	}
}

1116 
	$pxt4_de°roy_öode
(
öode
 *inode)

1118 i‡(!
	`li°_em±y
(&(
	`PXT4_I
(
öode
)->
i_‹ph™
))) {

1119 
	`pxt4_msg
(
öode
->
i_sb
, 
KERN_ERR
,

1121 
öode
->
i_öo
, 
	`PXT4_I
(inode));

1122 
	`¥öt_hex_dump
(
KERN_INFO
, "", 
DUMP_PREFIX_ADDRESS
, 16, 4,

1123 
	`PXT4_I
(
öode
), (
pxt4_öode_öfo
),

1124 
åue
);

1125 
	`dump_°ack
();

1127 
	`ˇŒ_rcu
(&
öode
->
i_rcu
, 
pxt4_i_ˇŒback
);

1128 
	}
}

1130 
	$öô_⁄˚
(*
foo
)

1132 
pxt4_öode_öfo
 *
ei
 = (pxt4_öode_öfÿ*Ë
foo
;

1134 
	`INIT_LIST_HEAD
(&
ei
->
i_‹ph™
);

1135 
	`öô_rw£m
(&
ei
->
x©å_£m
);

1136 
	`öô_rw£m
(&
ei
->
i_d©a_£m
);

1137 
	`öô_rw£m
(&
ei
->
i_mm≠_£m
);

1138 
	`öode_öô_⁄˚
(&
ei
->
vfs_öode
);

1139 
	}
}

1141 
__öô
 
	$öô_öodeˇche
()

1143 
pxt4_öode_ˇchï
 = 
	`kmem_ˇche_¸óã_u£rc›y
("pxt4_inode_cache",

1144 (
pxt4_öode_öfo
), 0,

1145 (
SLAB_RECLAIM_ACCOUNT
|
SLAB_MEM_SPREAD
|

1146 
SLAB_ACCOUNT
),

1147 
	`off£tof
(
pxt4_öode_öfo
, 
i_d©a
),

1148 
	`sizeof_fõld
(
pxt4_öode_öfo
, 
i_d©a
),

1149 
öô_⁄˚
);

1150 i‡(
pxt4_öode_ˇchï
 =
NULL
)

1151  -
ENOMEM
;

1153 
	}
}

1155 
	$de°roy_öodeˇche
()

1161 
	`rcu_b¨rõr
();

1162 
	`kmem_ˇche_de°roy
(
pxt4_öode_ˇchï
);

1163 
	}
}

1165 
	$pxt4_˛ór_öode
(
öode
 *inode)

1167 
	`övÆid©e_öode_buf„rs
(
öode
);

1168 
	`˛ór_öode
(
öode
);

1169 
	`dquŸ_dr›
(
öode
);

1170 
	`pxt4_disˇrd_¥óŒoˇti⁄s
(
öode
);

1171 
	`pxt4_es_ªmove_exã¡
(
öode
, 0, 
EXT_MAX_BLOCKS
);

1172 i‡(
	`PXT4_I
(
öode
)->
jöode
) {

1173 
	`jbd3_jou∫Æ_ªÀa£_jbd_öode
(
	`PXT4_JOURNAL
(
öode
),

1174 
	`PXT4_I
(
öode
)->
jöode
);

1175 
	`jbd3_‰ì_öode
(
	`PXT4_I
(
öode
)->
jöode
);

1176 
	`PXT4_I
(
öode
)->
jöode
 = 
NULL
;

1178 
	`fs¸y±_put_í¸y±i⁄_öfo
(
öode
);

1179 
	}
}

1181 
öode
 *
	$pxt4_nfs_gë_öode
(
su≥r_block
 *
sb
,

1182 
u64
 
öo
, 
u32
 
gíî©i⁄
)

1184 
öode
 *inode;

1190 
öode
 = 
	`pxt4_igë
(
sb
, 
öo
, 
PXT4_IGET_HANDLE
);

1191 i‡(
	`IS_ERR
(
öode
))

1192  
	`ERR_CAST
(
öode
);

1193 i‡(
gíî©i⁄
 && 
öode
->
i_gíî©i⁄
 != generation) {

1194 
	`ùut
(
öode
);

1195  
	`ERR_PTR
(-
ESTALE
);

1198  
öode
;

1199 
	}
}

1201 
díåy
 *
	$pxt4_fh_to_díåy
(
su≥r_block
 *
sb
, 
fid
 *fid,

1202 
fh_Àn
, 
fh_ty≥
)

1204  
	`gíîic_fh_to_díåy
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1205 
pxt4_nfs_gë_öode
);

1206 
	}
}

1208 
díåy
 *
	$pxt4_fh_to_∑ª¡
(
su≥r_block
 *
sb
, 
fid
 *fid,

1209 
fh_Àn
, 
fh_ty≥
)

1211  
	`gíîic_fh_to_∑ª¡
(
sb
, 
fid
, 
fh_Àn
, 
fh_ty≥
,

1212 
pxt4_nfs_gë_öode
);

1213 
	}
}

1215 
	$pxt4_nfs_commô_mëad©a
(
öode
 *inode)

1217 
wrôeback_c⁄åﬁ
 
wbc
 = {

1218 .
sync_mode
 = 
WB_SYNC_ALL


1221 
	`åa˚_pxt4_nfs_commô_mëad©a
(
öode
);

1222  
	`pxt4_wrôe_öode
(
öode
, &
wbc
);

1223 
	}
}

1231 
	$bdev_åy_to_‰ì_∑ge
(
su≥r_block
 *
sb
, 
∑ge
 *page,

1232 
gÂ_t
 
waô
)

1234 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

1236 
	`WARN_ON
(
	`PageChecked
(
∑ge
));

1237 i‡(!
	`∑ge_has_buf„rs
(
∑ge
))

1239 i‡(
jou∫Æ
)

1240  
	`jbd3_jou∫Æ_åy_to_‰ì_buf„rs
(
jou∫Æ
, 
∑ge
,

1241 
waô
 & ~
__GFP_DIRECT_RECLAIM
);

1242  
	`åy_to_‰ì_buf„rs
(
∑ge
);

1243 
	}
}

1245 #ifde‡
CONFIG_FS_ENCRYPTION


1246 
	$pxt4_gë_c⁄ãxt
(
öode
 *öode, *
˘x
, 
size_t
 
Àn
)

1248  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1249 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
, 
˘x
, 
Àn
);

1250 
	}
}

1252 
	$pxt4_£t_c⁄ãxt
(
öode
 *öode, c⁄° *
˘x
, 
size_t
 
Àn
,

1253 *
fs_d©a
)

1255 
h™dÀ_t
 *
h™dÀ
 = 
fs_d©a
;

1256 
ªs
, 
ªs2
, 
¸edôs
, 
ªåõs
 = 0;

1264 i‡(
öode
->
i_öo
 =
PXT4_ROOT_INO
)

1265  -
EPERM
;

1267 i‡(
	`WARN_ON_ONCE
(
	`IS_DAX
(
öode
Ë&& 
	`i_size_ªad
(inode)))

1268  -
EINVAL
;

1270 
ªs
 = 
	`pxt4_c⁄vît_ölöe_d©a
(
öode
);

1271 i‡(
ªs
)

1272  
ªs
;

1282 i‡(
h™dÀ
) {

1283 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

1284 
PXT4_XATTR_INDEX_ENCRYPTION
,

1285 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1286 
˘x
, 
Àn
, 0);

1287 i‡(!
ªs
) {

1288 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1289 
	`pxt4_˛ór_öode_°©e
(
öode
,

1290 
PXT4_STATE_MAY_INLINE_DATA
);

1295 
	`pxt4_£t_öode_Êags
(
öode
);

1297  
ªs
;

1300 
ªs
 = 
	`dquŸ_öôülize
(
öode
);

1301 i‡(
ªs
)

1302  
ªs
;

1303 
ªåy
:

1304 
ªs
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
Àn
, 
Ál£
 ,

1305 &
¸edôs
);

1306 i‡(
ªs
)

1307  
ªs
;

1309 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_MISC
, 
¸edôs
);

1310 i‡(
	`IS_ERR
(
h™dÀ
))

1311  
	`PTR_ERR
(
h™dÀ
);

1313 
ªs
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
PXT4_XATTR_INDEX_ENCRYPTION
,

1314 
PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
,

1315 
˘x
, 
Àn
, 0);

1316 i‡(!
ªs
) {

1317 
	`pxt4_£t_öode_Êag
(
öode
, 
PXT4_INODE_ENCRYPT
);

1322 
	`pxt4_£t_öode_Êags
(
öode
);

1323 
ªs
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

1324 i‡(
ªs
)

1325 
	`PXT4_ERROR_INODE
(
öode
, "FailedÅo mark inode dirty");

1327 
ªs2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

1329 i‡(
ªs
 =-
ENOSPC
 && 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
))

1330 
ªåy
;

1331 i‡(!
ªs
)

1332 
ªs
 = 
ªs2
;

1333  
ªs
;

1334 
	}
}

1336 
boﬁ
 
	$pxt4_dummy_c⁄ãxt
(
öode
 *inode)

1338  
	`DUMMY_ENCRYPTION_ENABLED
(
	`PXT4_SB
(
öode
->
i_sb
));

1339 
	}
}

1341 c⁄° 
fs¸y±_›î©i⁄s
 
	gpxt4_¸y±›s
 = {

1342 .
key_¥efix
 = "pxt4:",

1343 .
	ggë_c⁄ãxt
 = 
pxt4_gë_c⁄ãxt
,

1344 .
	g£t_c⁄ãxt
 = 
pxt4_£t_c⁄ãxt
,

1345 .
	gdummy_c⁄ãxt
 = 
pxt4_dummy_c⁄ãxt
,

1346 .
	gem±y_dú
 = 
pxt4_em±y_dú
,

1347 .
	gmax_«mñí
 = 
PXT4_NAME_LEN
,

1351 #ifde‡
CONFIG_QUOTA


1352 c⁄° * c⁄° 
	gquŸ©y≥s
[] = 
INITQFNAMES
;

1353 
	#QTYPE2NAME
(
t
Ë(
quŸ©y≥s
[t])

	)

1355 
pxt4_wrôe_dquŸ
(
dquŸ
 *dquot);

1356 
pxt4_acquúe_dquŸ
(
dquŸ
 *dquot);

1357 
pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot);

1358 
pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot);

1359 
pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
);

1360 
pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1361 c⁄° 
∑th
 *path);

1362 
pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
);

1363 
ssize_t
 
pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

1364 
size_t
 
Àn
, 
loff_t
 
off
);

1365 
ssize_t
 
pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

1366 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
);

1367 
pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

1368 
Êags
);

1369 
pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
);

1370 
pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
);

1372 
dquŸ
 **
	$pxt4_gë_dquŸs
(
öode
 *inode)

1374  
	`PXT4_I
(
öode
)->
i_dquŸ
;

1375 
	}
}

1377 c⁄° 
dquŸ_›î©i⁄s
 
	gpxt4_quŸa_›î©i⁄s
 = {

1378 .
gë_ª£rved_•a˚
 = 
pxt4_gë_ª£rved_•a˚
,

1379 .
	gwrôe_dquŸ
 = 
pxt4_wrôe_dquŸ
,

1380 .
	gacquúe_dquŸ
 = 
pxt4_acquúe_dquŸ
,

1381 .
	gªÀa£_dquŸ
 = 
pxt4_ªÀa£_dquŸ
,

1382 .
	gm¨k_dúty
 = 
pxt4_m¨k_dquŸ_dúty
,

1383 .
	gwrôe_öfo
 = 
pxt4_wrôe_öfo
,

1384 .
	gÆloc_dquŸ
 = 
dquŸ_Æloc
,

1385 .
	gde°roy_dquŸ
 = 
dquŸ_de°roy
,

1386 .
	ggë_¥ojid
 = 
pxt4_gë_¥ojid
,

1387 .
	ggë_öode_ußge
 = 
pxt4_gë_öode_ußge
,

1388 .
	ggë_√xt_id
 = 
pxt4_gë_√xt_id
,

1391 c⁄° 
quŸa˘l_›s
 
	gpxt4_q˘l_›î©i⁄s
 = {

1392 .
quŸa_⁄
 = 
pxt4_quŸa_⁄
,

1393 .
	gquŸa_off
 = 
pxt4_quŸa_off
,

1394 .
	gquŸa_sync
 = 
dquŸ_quŸa_sync
,

1395 .
	ggë_°©e
 = 
dquŸ_gë_°©e
,

1396 .
	g£t_öfo
 = 
dquŸ_£t_dqöfo
,

1397 .
	ggë_dqblk
 = 
dquŸ_gë_dqblk
,

1398 .
	g£t_dqblk
 = 
dquŸ_£t_dqblk
,

1399 .
	ggë_√xtdqblk
 = 
dquŸ_gë_√xt_dqblk
,

1403 c⁄° 
su≥r_›î©i⁄s
 
	gpxt4_s›s
 = {

1404 .
Æloc_öode
 = 
pxt4_Æloc_öode
,

1405 .
	gde°roy_öode
 = 
pxt4_de°roy_öode
,

1406 .
	gwrôe_öode
 = 
pxt4_wrôe_öode
,

1407 .
	gdúty_öode
 = 
pxt4_dúty_öode
,

1408 .
	gdr›_öode
 = 
pxt4_dr›_öode
,

1409 .
	gevi˘_öode
 = 
pxt4_evi˘_öode
,

1410 .
	gput_su≥r
 = 
pxt4_put_su≥r
,

1411 .
	gsync_fs
 = 
pxt4_sync_fs
,

1412 .
	g‰ìze_fs
 = 
pxt4_‰ìze
,

1413 .
	gun‰ìze_fs
 = 
pxt4_un‰ìze
,

1414 .
	g°©fs
 = 
pxt4_°©fs
,

1415 .
	gªmou¡_fs
 = 
pxt4_ªmou¡
,

1416 .
	gshow_›ti⁄s
 = 
pxt4_show_›ti⁄s
,

1417 #ifde‡
CONFIG_QUOTA


1418 .
	gquŸa_ªad
 = 
pxt4_quŸa_ªad
,

1419 .
	gquŸa_wrôe
 = 
pxt4_quŸa_wrôe
,

1420 .
	ggë_dquŸs
 = 
pxt4_gë_dquŸs
,

1422 .
	gbdev_åy_to_‰ì_∑ge
 = 
bdev_åy_to_‰ì_∑ge
,

1425 c⁄° 
exp‹t_›î©i⁄s
 
	gpxt4_exp‹t_›s
 = {

1426 .
fh_to_díåy
 = 
pxt4_fh_to_díåy
,

1427 .
	gfh_to_∑ª¡
 = 
pxt4_fh_to_∑ª¡
,

1428 .
	ggë_∑ª¡
 = 
pxt4_gë_∑ª¡
,

1429 .
	gcommô_mëad©a
 = 
pxt4_nfs_commô_mëad©a
,

1433 
	mO±_bsd_df
, 
	mO±_möix_df
, 
	mO±_gΩid
, 
	mO±_nogΩid
,

1434 
	mO±_ªsgid
, 
	mO±_ªsuid
, 
	mO±_sb
, 
	mO±_îr_c⁄t
, 
	mO±_îr_∑nic
, 
	mO±_îr_ro
,

1435 
	mO±_nouid32
, 
	mO±_debug
, 
	mO±_ªmoved
,

1436 
	mO±_u£r_x©å
, 
	mO±_nou£r_x©å
, 
	mO±_a˛
, 
	mO±_nﬂ˛
,

1437 
	mO±_auto_da_Æloc
, 
	mO±_nﬂuto_da_Æloc
, 
	mO±_nﬁﬂd
,

1438 
	mO±_commô
, 
	mO±_mö_b©ch_time
, 
	mO±_max_b©ch_time
, 
	mO±_jou∫Æ_dev
,

1439 
	mO±_jou∫Æ_∑th
, 
	mO±_jou∫Æ_checksum
, 
	mO±_jou∫Æ_async_commô
,

1440 
	mO±_ab‹t
, 
	mO±_d©a_jou∫Æ
, 
	mO±_d©a_‹dîed
, 
	mO±_d©a_wrôeback
,

1441 
	mO±_d©a_îr_ab‹t
, 
	mO±_d©a_îr_ign‹e
, 
	mO±_ã°_dummy_í¸y±i⁄
,

1442 
	mO±_u§jquŸa
, 
	mO±_gΩjquŸa
, 
	mO±_offu§jquŸa
, 
	mO±_offgΩjquŸa
,

1443 
	mO±_jqfmt_vfsﬁd
, 
	mO±_jqfmt_vfsv0
, 
	mO±_jqfmt_vfsv1
, 
	mO±_quŸa
,

1444 
	mO±_noquŸa
, 
	mO±_b¨rõr
, 
	mO±_nob¨rõr
, 
	mO±_îr
,

1445 
	mO±_u§quŸa
, 
	mO±_gΩquŸa
, 
	mO±_¥jquŸa
, 
	mO±_i_vîsi⁄
, 
	mO±_dax
,

1446 
	mO±_°rùe
, 
	mO±_dñÆloc
, 
	mO±_nodñÆloc
, 
	mO±_w¨n_⁄_îr‹
,

1447 
	mO±_now¨n_⁄_îr‹
, 
	mO±_mblk_io_submô
,

1448 
	mO±_œzytime
, 
	mO±_nﬁazytime
, 
	mO±_debug_w™t_exåa_isize
,

1449 
	mO±_nomblk_io_submô
, 
	mO±_block_vÆidôy
, 
	mO±_noblock_vÆidôy
,

1450 
	mO±_öode_ªadahód_blks
, 
	mO±_jou∫Æ_i›rio
,

1451 
	mO±_di‹ód_nﬁock
, 
	mO±_di‹ód_lock
,

1452 
	mO±_disˇrd
, 
	mO±_nodisˇrd
, 
	mO±_öô_ôabÀ
, 
	mO±_noöô_ôabÀ
,

1453 
	mO±_max_dú_size_kb
, 
	mO±_nojou∫Æ_checksum
, 
	mO±_nombˇche
,

1456 c⁄° 
m©ch_èbÀ_t
 
	gtokís
 = {

1457 {
O±_bsd_df
, "bsddf"},

1458 {
O±_möix_df
, "minixdf"},

1459 {
O±_gΩid
, "grpid"},

1460 {
O±_gΩid
, "bsdgroups"},

1461 {
O±_nogΩid
, "nogrpid"},

1462 {
O±_nogΩid
, "sysvgroups"},

1463 {
O±_ªsgid
, "resgid=%u"},

1464 {
O±_ªsuid
, "resuid=%u"},

1465 {
O±_sb
, "sb=%u"},

1466 {
O±_îr_c⁄t
, "errors=continue"},

1467 {
O±_îr_∑nic
, "errors=panic"},

1468 {
O±_îr_ro
, "errors=remount-ro"},

1469 {
O±_nouid32
, "nouid32"},

1470 {
O±_debug
, "debug"},

1471 {
O±_ªmoved
, "oldalloc"},

1472 {
O±_ªmoved
, "orlov"},

1473 {
O±_u£r_x©å
, "user_xattr"},

1474 {
O±_nou£r_x©å
, "nouser_xattr"},

1475 {
O±_a˛
, "acl"},

1476 {
O±_nﬂ˛
, "noacl"},

1477 {
O±_nﬁﬂd
, "norecovery"},

1478 {
O±_nﬁﬂd
, "noload"},

1479 {
O±_ªmoved
, "nobh"},

1480 {
O±_ªmoved
, "bh"},

1481 {
O±_commô
, "commit=%u"},

1482 {
O±_mö_b©ch_time
, "min_batch_time=%u"},

1483 {
O±_max_b©ch_time
, "max_batch_time=%u"},

1484 {
O±_jou∫Æ_dev
, "journal_dev=%u"},

1485 {
O±_jou∫Æ_∑th
, "journal_path=%s"},

1486 {
O±_jou∫Æ_checksum
, "journal_checksum"},

1487 {
O±_nojou∫Æ_checksum
, "nojournal_checksum"},

1488 {
O±_jou∫Æ_async_commô
, "journal_async_commit"},

1489 {
O±_ab‹t
, "abort"},

1490 {
O±_d©a_jou∫Æ
, "data=journal"},

1491 {
O±_d©a_‹dîed
, "data=ordered"},

1492 {
O±_d©a_wrôeback
, "data=writeback"},

1493 {
O±_d©a_îr_ab‹t
, "data_err=abort"},

1494 {
O±_d©a_îr_ign‹e
, "data_err=ignore"},

1495 {
O±_offu§jquŸa
, "usrjquota="},

1496 {
O±_u§jquŸa
, "usrjquota=%s"},

1497 {
O±_offgΩjquŸa
, "grpjquota="},

1498 {
O±_gΩjquŸa
, "grpjquota=%s"},

1499 {
O±_jqfmt_vfsﬁd
, "jqfmt=vfsold"},

1500 {
O±_jqfmt_vfsv0
, "jqfmt=vfsv0"},

1501 {
O±_jqfmt_vfsv1
, "jqfmt=vfsv1"},

1502 {
O±_gΩquŸa
, "grpquota"},

1503 {
O±_noquŸa
, "noquota"},

1504 {
O±_quŸa
, "quota"},

1505 {
O±_u§quŸa
, "usrquota"},

1506 {
O±_¥jquŸa
, "prjquota"},

1507 {
O±_b¨rõr
, "barrier=%u"},

1508 {
O±_b¨rõr
, "barrier"},

1509 {
O±_nob¨rõr
, "nobarrier"},

1510 {
O±_i_vîsi⁄
, "i_version"},

1511 {
O±_dax
, "dax"},

1512 {
O±_°rùe
, "stripe=%u"},

1513 {
O±_dñÆloc
, "delalloc"},

1514 {
O±_w¨n_⁄_îr‹
, "warn_on_error"},

1515 {
O±_now¨n_⁄_îr‹
, "nowarn_on_error"},

1516 {
O±_œzytime
, "lazytime"},

1517 {
O±_nﬁazytime
, "nolazytime"},

1518 {
O±_debug_w™t_exåa_isize
, "debug_want_extra_isize=%u"},

1519 {
O±_nodñÆloc
, "nodelalloc"},

1520 {
O±_ªmoved
, "mblk_io_submit"},

1521 {
O±_ªmoved
, "nomblk_io_submit"},

1522 {
O±_block_vÆidôy
, "block_validity"},

1523 {
O±_noblock_vÆidôy
, "noblock_validity"},

1524 {
O±_öode_ªadahód_blks
, "inode_readahead_blks=%u"},

1525 {
O±_jou∫Æ_i›rio
, "journal_ioprio=%u"},

1526 {
O±_auto_da_Æloc
, "auto_da_alloc=%u"},

1527 {
O±_auto_da_Æloc
, "auto_da_alloc"},

1528 {
O±_nﬂuto_da_Æloc
, "noauto_da_alloc"},

1529 {
O±_di‹ód_nﬁock
, "dioread_nolock"},

1530 {
O±_di‹ód_lock
, "dioread_lock"},

1531 {
O±_disˇrd
, "discard"},

1532 {
O±_nodisˇrd
, "nodiscard"},

1533 {
O±_öô_ôabÀ
, "init_itable=%u"},

1534 {
O±_öô_ôabÀ
, "init_itable"},

1535 {
O±_noöô_ôabÀ
, "noinit_itable"},

1536 {
O±_max_dú_size_kb
, "max_dir_size_kb=%u"},

1537 {
O±_ã°_dummy_í¸y±i⁄
, "test_dummy_encryption"},

1538 {
O±_nombˇche
, "nombcache"},

1539 {
O±_nombˇche
, "no_mbcache"},

1540 {
O±_ªmoved
, "check=none"},

1541 {
O±_ªmoved
, "nocheck"},

1542 {
O±_ªmoved
, "reservation"},

1543 {
O±_ªmoved
, "noreservation"},

1544 {
O±_ªmoved
, "journal=%u"},

1545 {
O±_îr
, 
NULL
},

1548 
pxt4_fsblk_t
 
	$gë_sb_block
(**
d©a
)

1550 
pxt4_fsblk_t
 
sb_block
;

1551 *
›ti⁄s
 = (*Ë*
d©a
;

1553 i‡(!
›ti⁄s
 || 
	`°∫cmp
(options, "sb=", 3) != 0)

1556 
›ti⁄s
 += 3;

1558 
sb_block
 = 
	`sim∂e_°πoul
(
›ti⁄s
, &options, 0);

1559 i‡(*
›ti⁄s
 && *options != ',') {

1560 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: Invalid sb specification: %s\n",

1561 (*Ë*
d©a
);

1564 i‡(*
›ti⁄s
 == ',')

1565 
›ti⁄s
++;

1566 *
d©a
 = (*Ë
›ti⁄s
;

1568  
sb_block
;

1569 
	}
}

1571 
	#DEFAULT_JOURNAL_IOPRIO
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 3))

	)

1572 c⁄° 
	gdïªˇãd_msg
[] =

1576 #ifde‡
CONFIG_QUOTA


1577 
	$£t_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
, 
sub°rög_t
 *
¨gs
)

1579 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1580 *
q«me
, *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1581 
ªt
 = -1;

1583 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& !
ﬁd_q«me
) {

1584 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1589 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1590 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Journaled quota options "

1594 
q«me
 = 
	`m©ch_°rdup
(
¨gs
);

1595 i‡(!
q«me
) {

1596 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1600 i‡(
ﬁd_q«me
) {

1601 i‡(
	`°rcmp
(
ﬁd_q«me
, 
q«me
) == 0)

1602 
ªt
 = 1;

1604 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1606 
	`QTYPE2NAME
(
qty≥
));

1607 
îrout
;

1609 i‡(
	`°rchr
(
q«me
, '/')) {

1610 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1612 
îrout
;

1614 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
q«me
);

1615 
	`£t_›t
(
sb
, 
QUOTA
);

1617 
îrout
:

1618 
	`k‰ì
(
q«me
);

1619  
ªt
;

1620 
	}
}

1622 
	$˛ór_qf_«me
(
su≥r_block
 *
sb
, 
qty≥
)

1625 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1626 *
ﬁd_q«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
qty≥
);

1628 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
Ë&& 
ﬁd_q«me
) {

1629 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled quota options"

1633 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
qty≥
], 
NULL
);

1634 
	`synchr⁄ize_rcu
();

1635 
	`k‰ì
(
ﬁd_q«me
);

1637 
	}
}

1640 
	#MOPT_SET
 0x0001

	)

1641 
	#MOPT_CLEAR
 0x0002

	)

1642 
	#MOPT_NOSUPPORT
 0x0004

	)

1643 
	#MOPT_EXPLICIT
 0x0008

	)

1644 
	#MOPT_CLEAR_ERR
 0x0010

	)

1645 
	#MOPT_GTE0
 0x0020

	)

1646 #ifde‡
CONFIG_QUOTA


1647 
	#MOPT_Q
 0

	)

1648 
	#MOPT_QFMT
 0x0040

	)

1650 
	#MOPT_Q
 
MOPT_NOSUPPORT


	)

1651 
	#MOPT_QFMT
 
MOPT_NOSUPPORT


	)

1653 
	#MOPT_DATAJ
 0x0080

	)

1654 
	#MOPT_NO_PXT2
 0x0100

	)

1655 
	#MOPT_NO_EXT3
 0x0200

	)

1656 
	#MOPT_PXT4_ONLY
 (
MOPT_NO_PXT2
 | 
MOPT_NO_EXT3
)

	)

1657 
	#MOPT_STRING
 0x0400

	)

1659 c⁄° 
	smou¡_›ts
 {

1660 
	mtokí
;

1661 
	mmou¡_›t
;

1662 
	mÊags
;

1663 } 
	gpxt4_mou¡_›ts
[] = {

1664 {
O±_möix_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_SET
},

1665 {
O±_bsd_df
, 
PXT4_MOUNT_MINIX_DF
, 
MOPT_CLEAR
},

1666 {
O±_gΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_SET
},

1667 {
O±_nogΩid
, 
PXT4_MOUNT_GRPID
, 
MOPT_CLEAR
},

1668 {
O±_block_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_SET
},

1669 {
O±_noblock_vÆidôy
, 
PXT4_MOUNT_BLOCK_VALIDITY
, 
MOPT_CLEAR
},

1670 {
O±_di‹ód_nﬁock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1671 
MOPT_PXT4_ONLY
 | 
MOPT_SET
},

1672 {
O±_di‹ód_lock
, 
PXT4_MOUNT_DIOREAD_NOLOCK
,

1673 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1674 {
O±_disˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_SET
},

1675 {
O±_nodisˇrd
, 
PXT4_MOUNT_DISCARD
, 
MOPT_CLEAR
},

1676 {
O±_dñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1677 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1678 {
O±_nodñÆloc
, 
PXT4_MOUNT_DELALLOC
,

1679 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1680 {
O±_w¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_SET
},

1681 {
O±_now¨n_⁄_îr‹
, 
PXT4_MOUNT_WARN_ON_ERROR
, 
MOPT_CLEAR
},

1682 {
O±_nojou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1683 
MOPT_PXT4_ONLY
 | 
MOPT_CLEAR
},

1684 {
O±_jou∫Æ_checksum
, 
PXT4_MOUNT_JOURNAL_CHECKSUM
,

1685 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1686 {
O±_jou∫Æ_async_commô
, (
PXT4_MOUNT_JOURNAL_ASYNC_COMMIT
 |

1687 
PXT4_MOUNT_JOURNAL_CHECKSUM
),

1688 
MOPT_PXT4_ONLY
 | 
MOPT_SET
 | 
MOPT_EXPLICIT
},

1689 {
O±_nﬁﬂd
, 
PXT4_MOUNT_NOLOAD
, 
MOPT_NO_PXT2
 | 
MOPT_SET
},

1690 {
O±_îr_∑nic
, 
PXT4_MOUNT_ERRORS_PANIC
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1691 {
O±_îr_ro
, 
PXT4_MOUNT_ERRORS_RO
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1692 {
O±_îr_c⁄t
, 
PXT4_MOUNT_ERRORS_CONT
, 
MOPT_SET
 | 
MOPT_CLEAR_ERR
},

1693 {
O±_d©a_îr_ab‹t
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1694 
MOPT_NO_PXT2
},

1695 {
O±_d©a_îr_ign‹e
, 
PXT4_MOUNT_DATA_ERR_ABORT
,

1696 
MOPT_NO_PXT2
},

1697 {
O±_b¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_SET
},

1698 {
O±_nob¨rõr
, 
PXT4_MOUNT_BARRIER
, 
MOPT_CLEAR
},

1699 {
O±_nﬂuto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_SET
},

1700 {
O±_auto_da_Æloc
, 
PXT4_MOUNT_NO_AUTO_DA_ALLOC
, 
MOPT_CLEAR
},

1701 {
O±_noöô_ôabÀ
, 
PXT4_MOUNT_INIT_INODE_TABLE
, 
MOPT_CLEAR
},

1702 {
O±_commô
, 0, 
MOPT_GTE0
},

1703 {
O±_max_b©ch_time
, 0, 
MOPT_GTE0
},

1704 {
O±_mö_b©ch_time
, 0, 
MOPT_GTE0
},

1705 {
O±_öode_ªadahód_blks
, 0, 
MOPT_GTE0
},

1706 {
O±_öô_ôabÀ
, 0, 
MOPT_GTE0
},

1707 {
O±_dax
, 
PXT4_MOUNT_DAX
, 
MOPT_SET
},

1708 {
O±_°rùe
, 0, 
MOPT_GTE0
},

1709 {
O±_ªsuid
, 0, 
MOPT_GTE0
},

1710 {
O±_ªsgid
, 0, 
MOPT_GTE0
},

1711 {
O±_jou∫Æ_dev
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1712 {
O±_jou∫Æ_∑th
, 0, 
MOPT_NO_PXT2
 | 
MOPT_STRING
},

1713 {
O±_jou∫Æ_i›rio
, 0, 
MOPT_NO_PXT2
 | 
MOPT_GTE0
},

1714 {
O±_d©a_jou∫Æ
, 
PXT4_MOUNT_JOURNAL_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1715 {
O±_d©a_‹dîed
, 
PXT4_MOUNT_ORDERED_DATA
, 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1716 {
O±_d©a_wrôeback
, 
PXT4_MOUNT_WRITEBACK_DATA
,

1717 
MOPT_NO_PXT2
 | 
MOPT_DATAJ
},

1718 {
O±_u£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_SET
},

1719 {
O±_nou£r_x©å
, 
PXT4_MOUNT_XATTR_USER
, 
MOPT_CLEAR
},

1720 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


1721 {
O±_a˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_SET
},

1722 {
O±_nﬂ˛
, 
PXT4_MOUNT_POSIX_ACL
, 
MOPT_CLEAR
},

1724 {
O±_a˛
, 0, 
MOPT_NOSUPPORT
},

1725 {
O±_nﬂ˛
, 0, 
MOPT_NOSUPPORT
},

1727 {
O±_nouid32
, 
PXT4_MOUNT_NO_UID32
, 
MOPT_SET
},

1728 {
O±_debug
, 
PXT4_MOUNT_DEBUG
, 
MOPT_SET
},

1729 {
O±_debug_w™t_exåa_isize
, 0, 
MOPT_GTE0
},

1730 {
O±_quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
, 
MOPT_SET
 | 
MOPT_Q
},

1731 {
O±_u§quŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
,

1732 
MOPT_SET
 | 
MOPT_Q
},

1733 {
O±_gΩquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_GRPQUOTA
,

1734 
MOPT_SET
 | 
MOPT_Q
},

1735 {
O±_¥jquŸa
, 
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_PRJQUOTA
,

1736 
MOPT_SET
 | 
MOPT_Q
},

1737 {
O±_noquŸa
, (
PXT4_MOUNT_QUOTA
 | 
PXT4_MOUNT_USRQUOTA
 |

1738 
PXT4_MOUNT_GRPQUOTA
 | 
PXT4_MOUNT_PRJQUOTA
),

1739 
MOPT_CLEAR
 | 
MOPT_Q
},

1740 {
O±_u§jquŸa
, 0, 
MOPT_Q
},

1741 {
O±_gΩjquŸa
, 0, 
MOPT_Q
},

1742 {
O±_offu§jquŸa
, 0, 
MOPT_Q
},

1743 {
O±_offgΩjquŸa
, 0, 
MOPT_Q
},

1744 {
O±_jqfmt_vfsﬁd
, 
QFMT_VFS_OLD
, 
MOPT_QFMT
},

1745 {
O±_jqfmt_vfsv0
, 
QFMT_VFS_V0
, 
MOPT_QFMT
},

1746 {
O±_jqfmt_vfsv1
, 
QFMT_VFS_V1
, 
MOPT_QFMT
},

1747 {
O±_max_dú_size_kb
, 0, 
MOPT_GTE0
},

1748 {
O±_ã°_dummy_í¸y±i⁄
, 0, 
MOPT_GTE0
},

1749 {
O±_nombˇche
, 
PXT4_MOUNT_NO_MBCACHE
, 
MOPT_SET
},

1750 {
O±_îr
, 0, 0}

1753 
	$h™dÀ_mou¡_›t
(
su≥r_block
 *
sb
, *
›t
, 
tokí
,

1754 
sub°rög_t
 *
¨gs
, *
jou∫Æ_devnum
,

1755 *
jou∫Æ_i›rio
, 
is_ªmou¡
)

1757 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

1758 c⁄° 
mou¡_›ts
 *
m
;

1759 
kuid_t
 
uid
;

1760 
kgid_t
 
gid
;

1761 
¨g
 = 0;

1763 #ifde‡
CONFIG_QUOTA


1764 i‡(
tokí
 =
O±_u§jquŸa
)

1765  
	`£t_qf_«me
(
sb
, 
USRQUOTA
, &
¨gs
[0]);

1766 i‡(
tokí
 =
O±_gΩjquŸa
)

1767  
	`£t_qf_«me
(
sb
, 
GRPQUOTA
, &
¨gs
[0]);

1768 i‡(
tokí
 =
O±_offu§jquŸa
)

1769  
	`˛ór_qf_«me
(
sb
, 
USRQUOTA
);

1770 i‡(
tokí
 =
O±_offgΩjquŸa
)

1771  
	`˛ór_qf_«me
(
sb
, 
GRPQUOTA
);

1773 
tokí
) {

1774 
O±_nﬂ˛
:

1775 
O±_nou£r_x©å
:

1776 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, 
dïªˇãd_msg
, 
›t
, "3.5");

1778 
O±_sb
:

1780 
O±_ªmoved
:

1781 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Ign‹ögÑemoved %†›ti⁄", 
›t
);

1783 
O±_ab‹t
:

1784 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_FS_ABORTED
;

1786 
O±_i_vîsi⁄
:

1787 
sb
->
s_Êags
 |
SB_I_VERSION
;

1789 
O±_œzytime
:

1790 
sb
->
s_Êags
 |
SB_LAZYTIME
;

1792 
O±_nﬁazytime
:

1793 
sb
->
s_Êags
 &~
SB_LAZYTIME
;

1797 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++)

1798 i‡(
tokí
 =
m
->token)

1801 i‡(
m
->
tokí
 =
O±_îr
) {

1802 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Unrecognized mount option \"%s\" "

1803 "‹ missög vÆue", 
›t
);

1807 i‡((
m
->
Êags
 & 
MOPT_NO_PXT2
Ë&& 
	`IS_PXT2_SB
(
sb
)) {

1808 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1809 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÖxt2", 
›t
);

1812 i‡((
m
->
Êags
 & 
MOPT_NO_EXT3
Ë&& 
	`IS_EXT3_SB
(
sb
)) {

1813 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1814 "Mou¡ o±i⁄ \"%s\" incom∑tibÀ wôhÉxt3", 
›t
);

1818 i‡(
¨gs
->
‰om
 && !(
m
->
Êags
 & 
MOPT_STRING
Ë&& 
	`m©ch_öt
◊rgs, &
¨g
))

1820 i‡(
¨gs
->
‰om
 && (
m
->
Êags
 & 
MOPT_GTE0
Ë&& (
¨g
 < 0))

1822 i‡(
m
->
Êags
 & 
MOPT_EXPLICIT
) {

1823 i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_DELALLOC
) {

1824 
	`£t_›t2
(
sb
, 
EXPLICIT_DELALLOC
);

1825 } i‡(
m
->
mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) {

1826 
	`£t_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
);

1830 i‡(
m
->
Êags
 & 
MOPT_CLEAR_ERR
)

1831 
	`˛ór_›t
(
sb
, 
ERRORS_MASK
);

1832 i‡(
tokí
 =
O±_noquŸa
 && 
	`sb_™y_quŸa_lﬂded
(
sb
)) {

1833 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change quota "

1838 i‡(
m
->
Êags
 & 
MOPT_NOSUPPORT
) {

1839 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "%†›ti⁄ÇŸ suµ‹ãd", 
›t
);

1840 } i‡(
tokí
 =
O±_commô
) {

1841 i‡(
¨g
 == 0)

1842 
¨g
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
;

1843 
sbi
->
s_commô_öãrvÆ
 = 
HZ
 * 
¨g
;

1844 } i‡(
tokí
 =
O±_debug_w™t_exåa_isize
) {

1845 
sbi
->
s_w™t_exåa_isize
 = 
¨g
;

1846 } i‡(
tokí
 =
O±_max_b©ch_time
) {

1847 
sbi
->
s_max_b©ch_time
 = 
¨g
;

1848 } i‡(
tokí
 =
O±_mö_b©ch_time
) {

1849 
sbi
->
s_mö_b©ch_time
 = 
¨g
;

1850 } i‡(
tokí
 =
O±_öode_ªadahód_blks
) {

1851 i‡(
¨g
 && (¨g > (1 << 30Ë|| !
	`is_powî_of_2
(arg))) {

1852 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1857 
sbi
->
s_öode_ªadahód_blks
 = 
¨g
;

1858 } i‡(
tokí
 =
O±_öô_ôabÀ
) {

1859 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

1860 i‡(!
¨gs
->
‰om
)

1861 
¨g
 = 
PXT4_DEF_LI_WAIT_MULT
;

1862 
sbi
->
s_li_waô_mu…
 = 
¨g
;

1863 } i‡(
tokí
 =
O±_max_dú_size_kb
) {

1864 
sbi
->
s_max_dú_size_kb
 = 
¨g
;

1865 } i‡(
tokí
 =
O±_°rùe
) {

1866 
sbi
->
s_°rùe
 = 
¨g
;

1867 } i‡(
tokí
 =
O±_ªsuid
) {

1868 
uid
 = 
	`make_kuid
(
	`cuºít_u£r_ns
(), 
¨g
);

1869 i‡(!
	`uid_vÆid
(
uid
)) {

1870 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid uid vÆuê%d", 
¨g
);

1873 
sbi
->
s_ªsuid
 = 
uid
;

1874 } i‡(
tokí
 =
O±_ªsgid
) {

1875 
gid
 = 
	`make_kgid
(
	`cuºít_u£r_ns
(), 
¨g
);

1876 i‡(!
	`gid_vÆid
(
gid
)) {

1877 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "InvÆid gid vÆuê%d", 
¨g
);

1880 
sbi
->
s_ªsgid
 = 
gid
;

1881 } i‡(
tokí
 =
O±_jou∫Æ_dev
) {

1882 i‡(
is_ªmou¡
) {

1883 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1887 *
jou∫Æ_devnum
 = 
¨g
;

1888 } i‡(
tokí
 =
O±_jou∫Æ_∑th
) {

1889 *
jou∫Æ_∑th
;

1890 
öode
 *
jou∫Æ_öode
;

1891 
∑th
Öath;

1892 
îr‹
;

1894 i‡(
is_ªmou¡
) {

1895 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1899 
jou∫Æ_∑th
 = 
	`m©ch_°rdup
(&
¨gs
[0]);

1900 i‡(!
jou∫Æ_∑th
) {

1901 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot dup "

1906 
îr‹
 = 
	`kîn_∑th
(
jou∫Æ_∑th
, 
LOOKUP_FOLLOW
, &
∑th
);

1907 i‡(
îr‹
) {

1908 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: couldÇot find "

1909 "jou∫Æ devi˚Ö©h:Éº‹ %d", 
îr‹
);

1910 
	`k‰ì
(
jou∫Æ_∑th
);

1914 
jou∫Æ_öode
 = 
	`d_öode
(
∑th
.
díåy
);

1915 i‡(!
	`S_ISBLK
(
jou∫Æ_öode
->
i_mode
)) {

1916 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "error: journalÖath %s "

1917 "i†nŸá block devi˚", 
jou∫Æ_∑th
);

1918 
	`∑th_put
(&
∑th
);

1919 
	`k‰ì
(
jou∫Æ_∑th
);

1923 *
jou∫Æ_devnum
 = 
	`√w_ícode_dev
(
jou∫Æ_öode
->
i_rdev
);

1924 
	`∑th_put
(&
∑th
);

1925 
	`k‰ì
(
jou∫Æ_∑th
);

1926 } i‡(
tokí
 =
O±_jou∫Æ_i›rio
) {

1927 i‡(
¨g
 > 7) {

1928 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Invalid journal IOÖriority"

1932 *
jou∫Æ_i›rio
 =

1933 
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_BE
, 
¨g
);

1934 } i‡(
tokí
 =
O±_ã°_dummy_í¸y±i⁄
) {

1935 #ifde‡
CONFIG_FS_ENCRYPTION


1936 
sbi
->
s_mou¡_Êags
 |
PXT4_MF_TEST_DUMMY_ENCRYPTION
;

1937 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1940 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1943 } i‡(
m
->
Êags
 & 
MOPT_DATAJ
) {

1944 i‡(
is_ªmou¡
) {

1945 i‡(!
sbi
->
s_jou∫Æ
)

1946 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Remounting file system withÇo journal so ignoring journalled data option");

1947 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë!
m
->
mou¡_›t
) {

1948 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

1953 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

1954 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

1956 #ifde‡
CONFIG_QUOTA


1957 } i‡(
m
->
Êags
 & 
MOPT_QFMT
) {

1958 i‡(
	`sb_™y_quŸa_lﬂded
(
sb
) &&

1959 
sbi
->
s_jquŸa_fmt
 !
m
->
mou¡_›t
) {

1960 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot change journaled "

1964 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

1965 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

1970 
sbi
->
s_jquŸa_fmt
 = 
m
->
mou¡_›t
;

1972 } i‡(
tokí
 =
O±_dax
) {

1973 #ifde‡
CONFIG_FS_DAX


1974 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1976 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

1978 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "dax optionÇot supported");

1981 } i‡(
tokí
 =
O±_d©a_îr_ab‹t
) {

1982 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

1983 } i‡(
tokí
 =
O±_d©a_îr_ign‹e
) {

1984 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

1986 i‡(!
¨gs
->
‰om
)

1987 
¨g
 = 1;

1988 i‡(
m
->
Êags
 & 
MOPT_CLEAR
)

1989 
¨g
 = !arg;

1990 i‡(
	`u∆ikñy
(!(
m
->
Êags
 & 
MOPT_SET
))) {

1991 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

1992 "buggy h™dlög o‡›ti⁄ %s", 
›t
);

1993 
	`WARN_ON
(1);

1996 i‡(
¨g
 != 0)

1997 
sbi
->
s_mou¡_›t
 |
m
->
mou¡_›t
;

1999 
sbi
->
s_mou¡_›t
 &~
m
->
mou¡_›t
;

2002 
	}
}

2004 
	$∑r£_›ti⁄s
(*
›ti⁄s
, 
su≥r_block
 *
sb
,

2005 *
jou∫Æ_devnum
,

2006 *
jou∫Æ_i›rio
,

2007 
is_ªmou¡
)

2009 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2010 *
p
, 
__maybe_unu£d
 *
u§_qf_«me
, __maybe_unu£d *
gΩ_qf_«me
;

2011 
sub°rög_t
 
¨gs
[
MAX_OPT_ARGS
];

2012 
tokí
;

2014 i‡(!
›ti⁄s
)

2017 (
p
 = 
	`°r£p
(&
›ti⁄s
, ",")Ë!
NULL
) {

2018 i‡(!*
p
)

2024 
¨gs
[0].
to
 =árgs[0].
‰om
 = 
NULL
;

2025 
tokí
 = 
	`m©ch_tokí
(
p
, 
tokís
, 
¨gs
);

2026 i‡(
	`h™dÀ_mou¡_›t
(
sb
, 
p
, 
tokí
, 
¨gs
, 
jou∫Æ_devnum
,

2027 
jou∫Æ_i›rio
, 
is_ªmou¡
) < 0)

2030 #ifde‡
CONFIG_QUOTA


2036 i‡(
	`ã°_›t
(
sb
, 
PRJQUOTA
Ë&& !
	`pxt4_has_„©uª_¥oje˘
(sb)) {

2037 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Project quota featureÇotÉnabled. "

2041 
u§_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
USRQUOTA
);

2042 
gΩ_qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
GRPQUOTA
);

2043 i‡(
u§_qf_«me
 || 
gΩ_qf_«me
) {

2044 i‡(
	`ã°_›t
(
sb
, 
USRQUOTA
Ë&& 
u§_qf_«me
)

2045 
	`˛ór_›t
(
sb
, 
USRQUOTA
);

2047 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë&& 
gΩ_qf_«me
)

2048 
	`˛ór_›t
(
sb
, 
GRPQUOTA
);

2050 i‡(
	`ã°_›t
(
sb
, 
GRPQUOTA
Ë||Åe°_›t(sb, 
USRQUOTA
)) {

2051 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "oldándÇew quota "

2056 i‡(!
sbi
->
s_jquŸa_fmt
) {

2057 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journaled quota format "

2063 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

2064 
blocksize
 =

2065 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
sbi
->
s_es
->
s_log_block_size
);

2067 i‡(
blocksize
 < 
PAGE_SIZE
) {

2068 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

2074 
	}
}

2076 
ölöe
 
	$pxt4_show_quŸa_›ti⁄s
(
£q_fûe
 *
£q
,

2077 
su≥r_block
 *
sb
)

2079 #i‡
	`deföed
(
CONFIG_QUOTA
)

2080 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2081 *
u§_qf_«me
, *
gΩ_qf_«me
;

2083 i‡(
sbi
->
s_jquŸa_fmt
) {

2084 *
fmäame
 = "";

2086 
sbi
->
s_jquŸa_fmt
) {

2087 
QFMT_VFS_OLD
:

2088 
fmäame
 = "vfsold";

2090 
QFMT_VFS_V0
:

2091 
fmäame
 = "vfsv0";

2093 
QFMT_VFS_V1
:

2094 
fmäame
 = "vfsv1";

2097 
	`£q_¥ötf
(
£q
, ",jqfmt=%s", 
fmäame
);

2100 
	`rcu_ªad_lock
();

2101 
u§_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
USRQUOTA
]);

2102 
gΩ_qf_«me
 = 
	`rcu_dîe„ªn˚
(
sbi
->
s_qf_«mes
[
GRPQUOTA
]);

2103 i‡(
u§_qf_«me
)

2104 
	`£q_show_›ti⁄
(
£q
, "u§jquŸa", 
u§_qf_«me
);

2105 i‡(
gΩ_qf_«me
)

2106 
	`£q_show_›ti⁄
(
£q
, "gΩjquŸa", 
gΩ_qf_«me
);

2107 
	`rcu_ªad_u∆ock
();

2109 
	}
}

2111 c⁄° *
	$tokí2°r
(
tokí
)

2113 c⁄° 
m©ch_tokí
 *
t
;

2115 
t
 = 
tokís
;Å->
tokí
 !
O±_îr
;Å++)

2116 i‡(
t
->
tokí
 =tokí && !
	`°rchr
—->
∑âîn
, '='))

2118  
t
->
∑âîn
;

2119 
	}
}

2126 
	$_pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
su≥r_block
 *
sb
,

2127 
nodefs
)

2129 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2130 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2131 
def_îr‹s
, 
def_mou¡_›t
 = 
sbi
->
s_def_mou¡_›t
;

2132 c⁄° 
mou¡_›ts
 *
m
;

2133 
£p
 = 
nodefs
 ? '\n' : ',';

2135 
	#SEQ_OPTS_PUTS
(
°r
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
)

	)

2136 
	#SEQ_OPTS_PRINT
(
°r
, 
¨g
Ë
	`£q_¥ötf
(
£q
, "%c" så, 
£p
,árg)

	)

2138 i‡(
sbi
->
s_sb_block
 != 1)

2139 
	`SEQ_OPTS_PRINT
("sb=%Œu", 
sbi
->
s_sb_block
);

2141 
m
 = 
pxt4_mou¡_›ts
; m->
tokí
 !
O±_îr
; m++) {

2142 
w™t_£t
 = 
m
->
Êags
 & 
MOPT_SET
;

2143 i‡(((
m
->
Êags
 & (
MOPT_SET
|
MOPT_CLEAR
)) == 0) ||

2144 (
m
->
Êags
 & 
MOPT_CLEAR_ERR
))

2146 i‡(!
nodefs
 && !(
m
->
mou¡_›t
 & (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)))

2148 i‡((
w™t_£t
 &&

2149 (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
) != m->mount_opt) ||

2150 (!
w™t_£t
 && (
sbi
->
s_mou¡_›t
 & 
m
->
mou¡_›t
)))

2152 
	`SEQ_OPTS_PRINT
("%s", 
	`tokí2°r
(
m
->
tokí
));

2155 i‡(
nodefs
 || !
	`uid_eq
(
sbi
->
s_ªsuid
, 
	`make_kuid
(&
öô_u£r_ns
, 
PXT4_DEF_RESUID
)) ||

2156 
	`À16_to_˝u
(
es
->
s_def_ªsuid
Ë!
PXT4_DEF_RESUID
)

2157 
	`SEQ_OPTS_PRINT
("resuid=%u",

2158 
	`‰om_kuid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsuid
));

2159 i‡(
nodefs
 || !
	`gid_eq
(
sbi
->
s_ªsgid
, 
	`make_kgid
(&
öô_u£r_ns
, 
PXT4_DEF_RESGID
)) ||

2160 
	`À16_to_˝u
(
es
->
s_def_ªsgid
Ë!
PXT4_DEF_RESGID
)

2161 
	`SEQ_OPTS_PRINT
("resgid=%u",

2162 
	`‰om_kgid_munged
(&
öô_u£r_ns
, 
sbi
->
s_ªsgid
));

2163 
def_îr‹s
 = 
nodefs
 ? -1 : 
	`À16_to_˝u
(
es
->
s_îr‹s
);

2164 i‡(
	`ã°_›t
(
sb
, 
ERRORS_RO
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_RO
)

2165 
	`SEQ_OPTS_PUTS
("errors=remount-ro");

2166 i‡(
	`ã°_›t
(
sb
, 
ERRORS_CONT
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_CONTINUE
)

2167 
	`SEQ_OPTS_PUTS
("errors=continue");

2168 i‡(
	`ã°_›t
(
sb
, 
ERRORS_PANIC
Ë&& 
def_îr‹s
 !
PXT4_ERRORS_PANIC
)

2169 
	`SEQ_OPTS_PUTS
("errors=panic");

2170 i‡(
nodefs
 || 
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
)

2171 
	`SEQ_OPTS_PRINT
("commô=%lu", 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

2172 i‡(
nodefs
 || 
sbi
->
s_mö_b©ch_time
 !
PXT4_DEF_MIN_BATCH_TIME
)

2173 
	`SEQ_OPTS_PRINT
("mö_b©ch_time=%u", 
sbi
->
s_mö_b©ch_time
);

2174 i‡(
nodefs
 || 
sbi
->
s_max_b©ch_time
 !
PXT4_DEF_MAX_BATCH_TIME
)

2175 
	`SEQ_OPTS_PRINT
("max_b©ch_time=%u", 
sbi
->
s_max_b©ch_time
);

2176 i‡(
sb
->
s_Êags
 & 
SB_I_VERSION
)

2177 
	`SEQ_OPTS_PUTS
("i_version");

2178 i‡(
nodefs
 || 
sbi
->
s_°rùe
)

2179 
	`SEQ_OPTS_PRINT
("°rùe=%lu", 
sbi
->
s_°rùe
);

2180 i‡(
nodefs
 || 
PXT4_MOUNT_DATA_FLAGS
 &

2181 (
sbi
->
s_mou¡_›t
 ^ 
def_mou¡_›t
)) {

2182 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

2183 
	`SEQ_OPTS_PUTS
("data=journal");

2184 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

2185 
	`SEQ_OPTS_PUTS
("data=ordered");

2186 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_WRITEBACK_DATA
)

2187 
	`SEQ_OPTS_PUTS
("data=writeback");

2189 i‡(
nodefs
 ||

2190 
sbi
->
s_öode_ªadahód_blks
 !
PXT4_DEF_INODE_READAHEAD_BLKS
)

2191 
	`SEQ_OPTS_PRINT
("inode_readahead_blks=%u",

2192 
sbi
->
s_öode_ªadahód_blks
);

2194 i‡(
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
Ë&& (
nodefs
 ||

2195 (
sbi
->
s_li_waô_mu…
 !
PXT4_DEF_LI_WAIT_MULT
)))

2196 
	`SEQ_OPTS_PRINT
("öô_ôabÀ=%u", 
sbi
->
s_li_waô_mu…
);

2197 i‡(
nodefs
 || 
sbi
->
s_max_dú_size_kb
)

2198 
	`SEQ_OPTS_PRINT
("max_dú_size_kb=%u", 
sbi
->
s_max_dú_size_kb
);

2199 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

2200 
	`SEQ_OPTS_PUTS
("data_err=abort");

2201 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
))

2202 
	`SEQ_OPTS_PUTS
("test_dummy_encryption");

2204 
	`pxt4_show_quŸa_›ti⁄s
(
£q
, 
sb
);

2206 
	}
}

2208 
	$pxt4_show_›ti⁄s
(
£q_fûe
 *
£q
, 
díåy
 *
roŸ
)

2210  
	`_pxt4_show_›ti⁄s
(
£q
, 
roŸ
->
d_sb
, 0);

2211 
	}
}

2213 
	$pxt4_£q_›ti⁄s_show
(
£q_fûe
 *
£q
, *
off£t
)

2215 
su≥r_block
 *
sb
 = 
£q
->
¥iv©e
;

2216 
rc
;

2218 
	`£q_puts
(
£q
, 
	`sb_rd⁄ly
(
sb
) ? "ro" : "rw");

2219 
rc
 = 
	`_pxt4_show_›ti⁄s
(
£q
, 
sb
, 1);

2220 
	`£q_puts
(
£q
, "\n");

2221  
rc
;

2222 
	}
}

2224 
	$pxt4_£tup_su≥r
(
su≥r_block
 *
sb
, 
pxt4_su≥r_block
 *
es
,

2225 
ªad_⁄ly
)

2227 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2228 
îr
 = 0;

2230 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë> 
PXT4_MAX_SUPP_REV
) {

2231 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "revisionÜevelÅoo high, "

2233 
îr
 = -
EROFS
;

2235 i‡(
ªad_⁄ly
)

2236 
d⁄e
;

2237 i‡(!(
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

2238 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning: mounting unchecked fs, "

2240 i‡(
sbi
->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
)

2241 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2244 i‡((
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
) > 0 &&

2245 
	`À16_to_˝u
(
es
->
s_m¡_cou¡
) >=

2246 (Ë(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2247 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2250 i‡(
	`À32_to_˝u
(
es
->
s_checköãrvÆ
) &&

2251 (
	`pxt4_gë_t°amp
(
es
, 
s_œ°check
) +

2252 
	`À32_to_˝u
(
es
->
s_checköãrvÆ
Ë<
	`ktime_gë_ªÆ_£c⁄ds
()))

2253 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

2256 i‡(!
sbi
->
s_jou∫Æ
)

2257 
es
->
s_°©e
 &
	`˝u_to_À16
(~
PXT4_VALID_FS
);

2258 i‡(!(
__s16
Ë
	`À16_to_˝u
(
es
->
s_max_m¡_cou¡
))

2259 
es
->
s_max_m¡_cou¡
 = 
	`˝u_to_À16
(
PXT4_DFL_MAX_MNT_COUNT
);

2260 
	`À16_add_˝u
(&
es
->
s_m¡_cou¡
, 1);

2261 
	`pxt4_upd©e_t°amp
(
es
, 
s_mtime
);

2262 i‡(
sbi
->
s_jou∫Æ
)

2263 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

2265 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

2266 
d⁄e
:

2267 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2268 
	`¥ötk
(
KERN_INFO
 "[PXT4 FS bs=%lu, gc=%u, "

2270 
sb
->
s_blocksize
,

2271 
sbi
->
s_groups_cou¡
,

2272 
	`PXT4_BLOCKS_PER_GROUP
(
sb
),

2273 
	`PXT4_INODES_PER_GROUP
(
sb
),

2274 
sbi
->
s_mou¡_›t
, sbi->
s_mou¡_›t2
);

2276 
	`˛ónˇche_öô_fs
(
sb
);

2277  
îr
;

2278 
	}
}

2280 
	$pxt4_Æloc_Êex_bg_¨øy
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
ngroup
)

2282 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2283 
Êex_groups
 *
√w_groups
;

2284 
size
;

2286 i‡(!
sbi
->
s_log_groups_≥r_Êex
)

2289 
size
 = 
	`pxt4_Êex_group
(
sbi
, 
ngroup
 - 1) + 1;

2290 i‡(
size
 <
sbi
->
s_Êex_groups_Æloˇãd
)

2293 
size
 = 
	`roundup_pow_of_two
(sizê* (
Êex_groups
));

2294 
√w_groups
 = 
	`kvzÆloc
(
size
, 
GFP_KERNEL
);

2295 i‡(!
√w_groups
) {

2296 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory for %d flex groups",

2297 
size
 / (Ë(
Êex_groups
));

2298  -
ENOMEM
;

2301 i‡(
sbi
->
s_Êex_groups
) {

2302 
	`mem˝y
(
√w_groups
, 
sbi
->
s_Êex_groups
,

2303 (
sbi
->
s_Êex_groups_Æloˇãd
 *

2304 (
Êex_groups
)));

2305 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

2307 
sbi
->
s_Êex_groups
 = 
√w_groups
;

2308 
sbi
->
s_Êex_groups_Æloˇãd
 = 
size
 / (
Êex_groups
);

2310 
	}
}

2312 
	$pxt4_fûl_Êex_öfo
(
su≥r_block
 *
sb
)

2314 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2315 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2316 
pxt4_group_t
 
Êex_group
;

2317 
i
, 
îr
;

2319 
sbi
->
s_log_groups_≥r_Êex
 = sbi->
s_es
->s_log_groups_per_flex;

2320 i‡(
sbi
->
s_log_groups_≥r_Êex
 < 1 || sbi->s_log_groups_per_flex > 31) {

2321 
sbi
->
s_log_groups_≥r_Êex
 = 0;

2325 
îr
 = 
	`pxt4_Æloc_Êex_bg_¨øy
(
sb
, 
sbi
->
s_groups_cou¡
);

2326 i‡(
îr
)

2327 
Áûed
;

2329 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2330 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2332 
Êex_group
 = 
	`pxt4_Êex_group
(
sbi
, 
i
);

2333 
	`©omic_add
(
	`pxt4_‰ì_öodes_cou¡
(
sb
, 
gdp
),

2334 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_öodes
);

2335 
	`©omic64_add
(
	`pxt4_‰ì_group_˛u°îs
(
sb
, 
gdp
),

2336 &
sbi
->
s_Êex_groups
[
Êex_group
].
‰ì_˛u°îs
);

2337 
	`©omic_add
(
	`pxt4_u£d_dús_cou¡
(
sb
, 
gdp
),

2338 &
sbi
->
s_Êex_groups
[
Êex_group
].
u£d_dús
);

2342 
Áûed
:

2344 
	}
}

2346 
__À16
 
	$pxt4_group_desc_csum
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2347 
pxt4_group_desc
 *
gdp
)

2349 
off£t
 = 
	`off£tof
(
pxt4_group_desc
, 
bg_checksum
);

2350 
__u16
 
¸c
 = 0;

2351 
__À32
 
À_group
 = 
	`˝u_to_À32
(
block_group
);

2352 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2354 i‡(
	`pxt4_has_mëad©a_csum
(
sbi
->
s_sb
)) {

2356 
__u32
 
csum32
;

2357 
__u16
 
dummy_csum
 = 0;

2359 
csum32
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
À_group
,

2360 (
À_group
));

2361 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
, 
off£t
);

2362 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)&
dummy_csum
,

2363 (
dummy_csum
));

2364 
off£t
 +(
dummy_csum
);

2365 i‡(
off£t
 < 
sbi
->
s_desc_size
)

2366 
csum32
 = 
	`pxt4_chksum
(
sbi
, csum32, (
__u8
 *)
gdp
 + 
off£t
,

2367 
sbi
->
s_desc_size
 - 
off£t
);

2369 
¸c
 = 
csum32
 & 0xFFFF;

2370 
out
;

2374 i‡(!
	`pxt4_has_„©uª_gdt_csum
(
sb
))

2377 
¸c
 = 
	`¸c16
(~0, 
sbi
->
s_es
->
s_uuid
, (sbi->s_es->s_uuid));

2378 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)&
À_group
, (le_group));

2379 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
, 
off£t
);

2380 
off£t
 +(
gdp
->
bg_checksum
);

2382 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

2383 
off£t
 < 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
))

2384 
¸c
 = 
	`¸c16
(¸c, (
__u8
 *)
gdp
 + 
off£t
,

2385 
	`À16_to_˝u
(
sbi
->
s_es
->
s_desc_size
) -

2386 
off£t
);

2388 
out
:

2389  
	`˝u_to_À16
(
¸c
);

2390 
	}
}

2392 
	$pxt4_group_desc_csum_vîify
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2393 
pxt4_group_desc
 *
gdp
)

2395 i‡(
	`pxt4_has_group_desc_csum
(
sb
) &&

2396 (
gdp
->
bg_checksum
 !
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp)))

2400 
	}
}

2402 
	$pxt4_group_desc_csum_£t
(
su≥r_block
 *
sb
, 
__u32
 
block_group
,

2403 
pxt4_group_desc
 *
gdp
)

2405 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

2407 
gdp
->
bg_checksum
 = 
	`pxt4_group_desc_csum
(
sb
, 
block_group
, gdp);

2408 
	}
}

2411 
	$pxt4_check_des¸ùt‹s
(
su≥r_block
 *
sb
,

2412 
pxt4_fsblk_t
 
sb_block
,

2413 
pxt4_group_t
 *
fú°_nŸ_zî€d
)

2415 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2416 
pxt4_fsblk_t
 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
);

2417 
pxt4_fsblk_t
 
œ°_block
;

2418 
pxt4_fsblk_t
 
œ°_bg_block
 = 
sb_block
 + 
	`pxt4_bg_num_gdb
(
sb
, 0);

2419 
pxt4_fsblk_t
 
block_bôm≠
;

2420 
pxt4_fsblk_t
 
öode_bôm≠
;

2421 
pxt4_fsblk_t
 
öode_èbÀ
;

2422 
Êexbg_Êag
 = 0;

2423 
pxt4_group_t
 
i
, 
gΩ
 = 
sbi
->
s_groups_cou¡
;

2425 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

2426 
Êexbg_Êag
 = 1;

2428 
	`pxt4_debug
("Checking group descriptors");

2430 
i
 = 0; i < 
sbi
->
s_groups_cou¡
; i++) {

2431 
pxt4_group_desc
 *
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

2433 i‡(
i
 =
sbi
->
s_groups_cou¡
 - 1 || 
Êexbg_Êag
)

2434 
œ°_block
 = 
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) - 1;

2436 
œ°_block
 = 
fú°_block
 +

2437 (
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

2439 i‡((
gΩ
 =
sbi
->
s_groups_cou¡
) &&

2440 !(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

2441 
gΩ
 = 
i
;

2443 
block_bôm≠
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

2444 i‡(
block_bôm≠
 =
sb_block
) {

2445 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2447 "su≥rblock", 
i
);

2448 i‡(!
	`sb_rd⁄ly
(
sb
))

2451 i‡(
block_bôm≠
 >
sb_block
 + 1 &&

2452 
block_bôm≠
 <
œ°_bg_block
) {

2453 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2455 "block grou∞des¸ùt‹s", 
i
);

2456 i‡(!
	`sb_rd⁄ly
(
sb
))

2459 i‡(
block_bôm≠
 < 
fú°_block
 || block_bôm≠ > 
œ°_block
) {

2460 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2462 "(block %Œu)!", 
i
, 
block_bôm≠
);

2465 
öode_bôm≠
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

2466 i‡(
öode_bôm≠
 =
sb_block
) {

2467 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2469 "su≥rblock", 
i
);

2470 i‡(!
	`sb_rd⁄ly
(
sb
))

2473 i‡(
öode_bôm≠
 >
sb_block
 + 1 &&

2474 
öode_bôm≠
 <
œ°_bg_block
) {

2475 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2477 "block grou∞des¸ùt‹s", 
i
);

2478 i‡(!
	`sb_rd⁄ly
(
sb
))

2481 i‡(
öode_bôm≠
 < 
fú°_block
 || inode_bôm≠ > 
œ°_block
) {

2482 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2484 "(block %Œu)!", 
i
, 
öode_bôm≠
);

2487 
öode_èbÀ
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

2488 i‡(
öode_èbÀ
 =
sb_block
) {

2489 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2491 "su≥rblock", 
i
);

2492 i‡(!
	`sb_rd⁄ly
(
sb
))

2495 i‡(
öode_èbÀ
 >
sb_block
 + 1 &&

2496 
öode_èbÀ
 <
œ°_bg_block
) {

2497 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2499 "block grou∞des¸ùt‹s", 
i
);

2500 i‡(!
	`sb_rd⁄ly
(
sb
))

2503 i‡(
öode_èbÀ
 < 
fú°_block
 ||

2504 
öode_èbÀ
 + 
sbi
->
s_ôb_≥r_group
 - 1 > 
œ°_block
) {

2505 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2507 "(block %Œu)!", 
i
, 
öode_èbÀ
);

2510 
	`pxt4_lock_group
(
sb
, 
i
);

2511 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
i
, 
gdp
)) {

2512 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "pxt4_check_descriptors: "

2514 
i
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, i,

2515 
gdp
)), 
	`À16_to_˝u
(gdp->
bg_checksum
));

2516 i‡(!
	`sb_rd⁄ly
(
sb
)) {

2517 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2521 
	`pxt4_u∆ock_group
(
sb
, 
i
);

2522 i‡(!
Êexbg_Êag
)

2523 
fú°_block
 +
	`PXT4_BLOCKS_PER_GROUP
(
sb
);

2525 i‡(
NULL
 !
fú°_nŸ_zî€d
)

2526 *
fú°_nŸ_zî€d
 = 
gΩ
;

2528 
	}
}

2547 
	$pxt4_‹ph™_˛ónup
(
su≥r_block
 *
sb
,

2548 
pxt4_su≥r_block
 *
es
)

2550 
s_Êags
 = 
sb
->s_flags;

2551 
ªt
, 
ƒ_‹ph™s
 = 0, 
ƒ_åunˇãs
 = 0;

2552 #ifde‡
CONFIG_QUOTA


2553 
quŸa_upd©e
 = 0;

2554 
i
;

2556 i‡(!
es
->
s_œ°_‹ph™
) {

2557 
	`jbd_debug
(4, "no orphan inodesÅo clean up\n");

2561 i‡(
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
)) {

2562 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

2568 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

2569 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Skipping orphan cleanup dueÅo "

2574 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2576 i‡(
es
->
s_œ°_‹ph™
 && !(
s_Êags
 & 
SB_RDONLY
)) {

2577 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "Errors on filesystem, "

2579 
es
->
s_œ°_‹ph™
 = 0;

2581 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2585 i‡(
s_Êags
 & 
SB_RDONLY
) {

2586 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "orphan cleanup onÑeadonly fs");

2587 
sb
->
s_Êags
 &~
SB_RDONLY
;

2589 #ifde‡
CONFIG_QUOTA


2591 
sb
->
s_Êags
 |
SB_ACTIVE
;

2597 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& (
s_Êags
 & 
SB_RDONLY
)) {

2598 
ªt
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

2600 i‡(!
ªt
)

2601 
quŸa_upd©e
 = 1;

2603 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2604 "C™nŸÅu∫ o¿quŸas:Éº‹ %d", 
ªt
);

2608 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2609 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
i
]) {

2610 
ªt
 = 
	`pxt4_quŸa_⁄_mou¡
(
sb
, 
i
);

2612 i‡(!
ªt
)

2613 
quŸa_upd©e
 = 1;

2615 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2617 "quŸa:Åy≥ %d:Éº‹ %d", 
i
, 
ªt
);

2622 
es
->
s_œ°_‹ph™
) {

2623 
öode
 *inode;

2629 i‡(
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 & 
PXT4_ERROR_FS
) {

2630 
	`jbd_debug
(1, "Skipping orphanÑecovery on fs withÉrrors.\n");

2631 
es
->
s_œ°_‹ph™
 = 0;

2635 
öode
 = 
	`pxt4_‹ph™_gë
(
sb
, 
	`À32_to_˝u
(
es
->
s_œ°_‹ph™
));

2636 i‡(
	`IS_ERR
(
öode
)) {

2637 
es
->
s_œ°_‹ph™
 = 0;

2641 
	`li°_add
(&
	`PXT4_I
(
öode
)->
i_‹ph™
, &
	`PXT4_SB
(
sb
)->
s_‹ph™
);

2642 
	`dquŸ_öôülize
(
öode
);

2643 i‡(
öode
->
i_∆ök
) {

2644 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2645 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2647 
__func__
, 
öode
->
i_öo
, inode->
i_size
);

2648 
	`jbd_debug
(2, "truncating inode %luÅo %lld bytes\n",

2649 
öode
->
i_öo
, inode->
i_size
);

2650 
	`öode_lock
(
öode
);

2651 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

2652 
ªt
 = 
	`pxt4_åunˇã
(
öode
);

2653 i‡(
ªt
)

2654 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
ªt
);

2655 
	`öode_u∆ock
(
öode
);

2656 
ƒ_åunˇãs
++;

2658 i‡(
	`ã°_›t
(
sb
, 
DEBUG
))

2659 
	`pxt4_msg
(
sb
, 
KERN_DEBUG
,

2661 
__func__
, 
öode
->
i_öo
);

2662 
	`jbd_debug
(2, "deleting unreferenced inode %lu\n",

2663 
öode
->
i_öo
);

2664 
ƒ_‹ph™s
++;

2666 
	`ùut
(
öode
);

2669 
	#PLURAL
(
x
Ë(x), ((xË=1Ë? "" : "s"

	)

2671 i‡(
ƒ_‹ph™s
)

2672 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%d orphan inode%s deleted",

2673 
	`PLURAL
(
ƒ_‹ph™s
));

2674 i‡(
ƒ_åunˇãs
)

2675 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "%dÅruncate%s cleaned up",

2676 
	`PLURAL
(
ƒ_åunˇãs
));

2677 #ifde‡
CONFIG_QUOTA


2679 i‡(
quŸa_upd©e
) {

2680 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

2681 i‡(
	`sb_dq›t
(
sb
)->
fûes
[
i
])

2682 
	`dquŸ_quŸa_off
(
sb
, 
i
);

2686 
sb
->
s_Êags
 = s_flags;

2687 
	}
}

2704 
loff_t
 
	$pxt4_max_size
(
blkbôs
, 
has_huge_fûes
)

2706 
loff_t
 
ªs
;

2707 
loff_t
 
uµî_limô
 = 
MAX_LFS_FILESIZE
;

2710 i‡(!
has_huge_fûes
 || (
blk˙t_t
Ë< (
u64
)) {

2716 
uµî_limô
 = (1LL << 32) - 1;

2719 
uµî_limô
 >>(
blkbôs
 - 9);

2720 
uµî_limô
 <<
blkbôs
;

2728 
ªs
 = (1LL << 32) - 1;

2729 
ªs
 <<
blkbôs
;

2732 i‡(
ªs
 > 
uµî_limô
)

2733 
ªs
 = 
uµî_limô
;

2735  
ªs
;

2736 
	}
}

2743 
loff_t
 
	$pxt4_max_bôm≠_size
(
bôs
, 
has_huge_fûes
)

2745 
loff_t
 
ªs
 = 
PXT4_NDIR_BLOCKS
;

2746 
mëa_blocks
;

2747 
loff_t
 
uµî_limô
;

2756 i‡(!
has_huge_fûes
 || (
blk˙t_t
Ë< (
u64
)) {

2762 
uµî_limô
 = (1LL << 32) - 1;

2765 
uµî_limô
 >>(
bôs
 - 9);

2774 
uµî_limô
 = (1LL << 48) - 1;

2779 
mëa_blocks
 = 1;

2781 
mëa_blocks
 +1 + (1LL << (
bôs
-2));

2783 
mëa_blocks
 +1 + (1LL << (
bôs
-2)) + (1LL << (2*(bits-2)));

2785 
uµî_limô
 -
mëa_blocks
;

2786 
uµî_limô
 <<
bôs
;

2788 
ªs
 +1LL << (
bôs
-2);

2789 
ªs
 +1LL << (2*(
bôs
-2));

2790 
ªs
 +1LL << (3*(
bôs
-2));

2791 
ªs
 <<
bôs
;

2792 i‡(
ªs
 > 
uµî_limô
)

2793 
ªs
 = 
uµî_limô
;

2795 i‡(
ªs
 > 
MAX_LFS_FILESIZE
)

2796 
ªs
 = 
MAX_LFS_FILESIZE
;

2798  
ªs
;

2799 
	}
}

2801 
pxt4_fsblk_t
 
	$des¸ùt‹_loc
(
su≥r_block
 *
sb
,

2802 
pxt4_fsblk_t
 
logiˇl_sb_block
, 
ƒ
)

2804 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

2805 
pxt4_group_t
 
bg
, 
fú°_mëa_bg
;

2806 
has_su≥r
 = 0;

2808 
fú°_mëa_bg
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_mëa_bg
);

2810 i‡(!
	`pxt4_has_„©uª_mëa_bg
(
sb
Ë|| 
ƒ
 < 
fú°_mëa_bg
)

2811  
logiˇl_sb_block
 + 
ƒ
 + 1;

2812 
bg
 = 
sbi
->
s_desc_≥r_block
 * 
ƒ
;

2813 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
bg
))

2814 
has_su≥r
 = 1;

2822 i‡(
sb
->
s_blocksize
 =1024 && 
ƒ
 == 0 &&

2823 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) == 0)

2824 
has_su≥r
++;

2826  (
has_su≥r
 + 
	`pxt4_group_fú°_block_no
(
sb
, 
bg
));

2827 
	}
}

2840 
	$pxt4_gë_°rùe_size
(
pxt4_sb_öfo
 *
sbi
)

2842 
°ride
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_øid_°ride
);

2843 
°rùe_width
 =

2844 
	`À32_to_˝u
(
sbi
->
s_es
->
s_øid_°rùe_width
);

2845 
ªt
;

2847 i‡(
sbi
->
s_°rùe
 && sbi->s_°rùê<sbi->
s_blocks_≥r_group
)

2848 
ªt
 = 
sbi
->
s_°rùe
;

2849 i‡(
°rùe_width
 && såùe_width <
sbi
->
s_blocks_≥r_group
)

2850 
ªt
 = 
°rùe_width
;

2851 i‡(
°ride
 && såidê<
sbi
->
s_blocks_≥r_group
)

2852 
ªt
 = 
°ride
;

2854 
ªt
 = 0;

2860 i‡(
ªt
 <= 1)

2861 
ªt
 = 0;

2863  
ªt
;

2864 
	}
}

2872 
	$pxt4_„©uª_£t_ok
(
su≥r_block
 *
sb
, 
ªad⁄ly
)

2874 i‡(
	`pxt4_has_unknown_ext4_öcom∑t_„©uªs
(
sb
)) {

2875 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2878 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_öcom∑t
) &

2879 ~
PXT4_FEATURE_INCOMPAT_SUPP
));

2883 i‡(
ªad⁄ly
)

2886 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
)) {

2887 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "filesystem isÑead-only");

2888 
sb
->
s_Êags
 |
SB_RDONLY
;

2893 i‡(
	`pxt4_has_unknown_ext4_ro_com∑t_„©uªs
(
sb
)) {

2894 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mount RDWR because of "

2896 (
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_„©uª_ro_com∑t
) &

2897 ~
PXT4_FEATURE_RO_COMPAT_SUPP
));

2904 i‡(
	`pxt4_has_„©uª_huge_fûe
(
sb
)) {

2905 i‡((
blk˙t_t
Ë< (
u64
)) {

2906 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Filesystem with huge files "

2912 i‡(
	`pxt4_has_„©uª_bigÆloc
(
sb
Ë&& !
	`pxt4_has_„©uª_exã¡s
(sb)) {

2913 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2919 #i‚de‡
CONFIG_QUOTA


2920 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
ªad⁄ly
) {

2921 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2926 i‡(
	`pxt4_has_„©uª_¥oje˘
(
sb
Ë&& !
ªad⁄ly
) {

2927 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

2934 
	}
}

2940 
	$¥öt_daûy_îr‹_öfo
(
timî_li°
 *
t
)

2942 
pxt4_sb_öfo
 *
sbi
 = 
	`‰om_timî
(sbi, 
t
, 
s_îr_ªp‹t
);

2943 
su≥r_block
 *
sb
 = 
sbi
->
s_sb
;

2944 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

2946 i‡(
es
->
s_îr‹_cou¡
)

2948 
	`pxt4_msg
(
sb
, 
KERN_NOTICE
, "error count sinceÜast fsck: %u",

2949 
	`À32_to_˝u
(
es
->
s_îr‹_cou¡
));

2950 i‡(
es
->
s_fú°_îr‹_time
) {

2951 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s): initialÉrrorátÅime %llu: %.*s:%d",

2952 
sb
->
s_id
,

2953 
	`pxt4_gë_t°amp
(
es
, 
s_fú°_îr‹_time
),

2954 (Ë(
es
->
s_fú°_îr‹_func
),

2955 
es
->
s_fú°_îr‹_func
,

2956 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_löe
));

2957 i‡(
es
->
s_fú°_îr‹_öo
)

2958 
	`¥ötk
(
KERN_CONT
 ": inode %u",

2959 
	`À32_to_˝u
(
es
->
s_fú°_îr‹_öo
));

2960 i‡(
es
->
s_fú°_îr‹_block
)

2961 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

2962 
	`À64_to_˝u
(
es
->
s_fú°_îr‹_block
));

2963 
	`¥ötk
(
KERN_CONT
 "\n");

2965 i‡(
es
->
s_œ°_îr‹_time
) {

2966 
	`¥ötk
(
KERN_NOTICE
 "PXT4-fs (%s):ÜastÉrrorátÅime %llu: %.*s:%d",

2967 
sb
->
s_id
,

2968 
	`pxt4_gë_t°amp
(
es
, 
s_œ°_îr‹_time
),

2969 (Ë(
es
->
s_œ°_îr‹_func
),

2970 
es
->
s_œ°_îr‹_func
,

2971 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_löe
));

2972 i‡(
es
->
s_œ°_îr‹_öo
)

2973 
	`¥ötk
(
KERN_CONT
 ": inode %u",

2974 
	`À32_to_˝u
(
es
->
s_œ°_îr‹_öo
));

2975 i‡(
es
->
s_œ°_îr‹_block
)

2976 
	`¥ötk
(
KERN_CONT
 ": block %llu", ()

2977 
	`À64_to_˝u
(
es
->
s_œ°_îr‹_block
));

2978 
	`¥ötk
(
KERN_CONT
 "\n");

2980 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 24*60*60*
HZ
);

2981 
	}
}

2984 
	$pxt4_run_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

2986 
pxt4_group_desc
 *
gdp
 = 
NULL
;

2987 
pxt4_group_t
 
group
, 
ngroups
;

2988 
su≥r_block
 *
sb
;

2989 
timeout
 = 0;

2990 
ªt
 = 0;

2992 
sb
 = 
ñr
->
Ã_su≥r
;

2993 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

2995 
group
 = 
ñr
->
Ã_√xt_group
; grou∞< 
ngroups
; group++) {

2996 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

2997 i‡(!
gdp
) {

2998 
ªt
 = 1;

3002 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3006 i‡(
group
 >
ngroups
)

3007 
ªt
 = 1;

3009 i‡(!
ªt
) {

3010 
timeout
 = 
jiffõs
;

3011 
ªt
 = 
	`pxt4_öô_öode_èbÀ
(
sb
, 
group
,

3012 
ñr
->
Ã_timeout
 ? 0 : 1);

3013 i‡(
ñr
->
Ã_timeout
 == 0) {

3014 
timeout
 = (
jiffõs
 -Åimeout) *

3015 
ñr
->
Ã_sbi
->
s_li_waô_mu…
;

3016 
ñr
->
Ã_timeout
 = 
timeout
;

3018 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +ÉÃ->
Ã_timeout
;

3019 
ñr
->
Ã_√xt_group
 = 
group
 + 1;

3021  
ªt
;

3022 
	}
}

3028 
	$pxt4_ªmove_li_ªque°
(
pxt4_li_ªque°
 *
ñr
)

3030 
pxt4_sb_öfo
 *
sbi
;

3032 i‡(!
ñr
)

3035 
sbi
 = 
ñr
->
Ã_sbi
;

3037 
	`li°_dñ
(&
ñr
->
Ã_ªque°
);

3038 
sbi
->
s_li_ªque°
 = 
NULL
;

3039 
	`k‰ì
(
ñr
);

3040 
	}
}

3042 
	$pxt4_uƒegi°î_li_ªque°
(
su≥r_block
 *
sb
)

3044 
	`muãx_lock
(&
pxt4_li_mtx
);

3045 i‡(!
pxt4_li_öfo
) {

3046 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3050 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3051 
	`pxt4_ªmove_li_ªque°
(
	`PXT4_SB
(
sb
)->
s_li_ªque°
);

3052 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3053 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3054 
	}
}

3056 
èsk_°ru˘
 *
	gpxt4_œzyöô_èsk
;

3067 
	$pxt4_œzyöô_thªad
(*
¨g
)

3069 
pxt4_œzy_öô
 *
ñi
 = (pxt4_œzy_öô *)
¨g
;

3070 
li°_hód
 *
pos
, *
n
;

3071 
pxt4_li_ªque°
 *
ñr
;

3072 
√xt_wakeup
, 
cur
;

3074 
	`BUG_ON
(
NULL
 =
ñi
);

3076 
c⁄t_thªad
:

3077 
åue
) {

3078 
√xt_wakeup
 = 
MAX_JIFFY_OFFSET
;

3080 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3081 i‡(
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3082 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3083 
exô_thªad
;

3085 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
ñi
->
li_ªque°_li°
) {

3086 
îr
 = 0;

3087 
¥ogªss
 = 0;

3088 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3089 
Ã_ªque°
);

3091 i‡(
	`time_bef‹e
(
jiffõs
, 
ñr
->
Ã_√xt_sched
)) {

3092 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3093 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3096 i‡(
	`down_ªad_åylock
(&
ñr
->
Ã_su≥r
->
s_umou¡
)) {

3097 i‡(
	`sb_°¨t_wrôe_åylock
(
ñr
->
Ã_su≥r
)) {

3098 
¥ogªss
 = 1;

3104 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3105 
îr
 = 
	`pxt4_run_li_ªque°
(
ñr
);

3106 
	`sb_íd_wrôe
(
ñr
->
Ã_su≥r
);

3107 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3108 
n
 = 
pos
->
√xt
;

3110 
	`up_ªad
((&
ñr
->
Ã_su≥r
->
s_umou¡
));

3113 i‡(
îr
) {

3114 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3117 i‡(!
¥ogªss
) {

3118 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 +

3119 (
	`¥™dom_u32
()

3120 % (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3122 i‡(
	`time_bef‹e
(
ñr
->
Ã_√xt_sched
, 
√xt_wakeup
))

3123 
√xt_wakeup
 = 
ñr
->
Ã_√xt_sched
;

3125 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3127 
	`åy_to_‰ìze
();

3129 
cur
 = 
jiffõs
;

3130 i‡((
	`time_a·î_eq
(
cur
, 
√xt_wakeup
)) ||

3131 (
MAX_JIFFY_OFFSET
 =
√xt_wakeup
)) {

3132 
	`c⁄d_ªsched
();

3136 
	`scheduÀ_timeout_öãºu±ibÀ
(
√xt_wakeup
 - 
cur
);

3138 i‡(
	`kthªad_should_°›
()) {

3139 
	`pxt4_˛ór_ªque°_li°
();

3140 
exô_thªad
;

3144 
exô_thªad
:

3153 
	`muãx_lock
(&
pxt4_li_mtx
);

3154 
	`muãx_lock
(&
ñi
->
li_li°_mtx
);

3155 i‡(!
	`li°_em±y
(&
ñi
->
li_ªque°_li°
)) {

3156 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3157 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3158 
c⁄t_thªad
;

3160 
	`muãx_u∆ock
(&
ñi
->
li_li°_mtx
);

3161 
	`k‰ì
(
pxt4_li_öfo
);

3162 
pxt4_li_öfo
 = 
NULL
;

3163 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3166 
	}
}

3168 
	$pxt4_˛ór_ªque°_li°
()

3170 
li°_hód
 *
pos
, *
n
;

3171 
pxt4_li_ªque°
 *
ñr
;

3173 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3174 
	`li°_f‹_óch_ß„
(
pos
, 
n
, &
pxt4_li_öfo
->
li_ªque°_li°
) {

3175 
ñr
 = 
	`li°_íåy
(
pos
, 
pxt4_li_ªque°
,

3176 
Ã_ªque°
);

3177 
	`pxt4_ªmove_li_ªque°
(
ñr
);

3179 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3180 
	}
}

3182 
	$pxt4_run_œzyöô_thªad
()

3184 
pxt4_œzyöô_èsk
 = 
	`kthªad_run
(
pxt4_œzyöô_thªad
,

3185 
pxt4_li_öfo
, "pxt4lazyinit");

3186 i‡(
	`IS_ERR
(
pxt4_œzyöô_èsk
)) {

3187 
îr
 = 
	`PTR_ERR
(
pxt4_œzyöô_èsk
);

3188 
	`pxt4_˛ór_ªque°_li°
();

3189 
	`k‰ì
(
pxt4_li_öfo
);

3190 
pxt4_li_öfo
 = 
NULL
;

3191 
	`¥ötk
(
KERN_CRIT
 "PXT4-fs:Érror %d creating inodeÅable "

3193 
îr
);

3194  
îr
;

3196 
pxt4_li_öfo
->
li_°©e
 |
PXT4_LAZYINIT_RUNNING
;

3198 
	}
}

3206 
pxt4_group_t
 
	$pxt4_has_unöô_ôabÀ
(
su≥r_block
 *
sb
)

3208 
pxt4_group_t
 
group
, 
ngroups
 = 
	`PXT4_SB
(
sb
)->
s_groups_cou¡
;

3209 
pxt4_group_desc
 *
gdp
 = 
NULL
;

3211 i‡(!
	`pxt4_has_group_desc_csum
(
sb
))

3212  
ngroups
;

3214 
group
 = 0; grou∞< 
ngroups
; group++) {

3215 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
group
, 
NULL
);

3216 i‡(!
gdp
)

3219 i‡(!(
gdp
->
bg_Êags
 & 
	`˝u_to_À16
(
PXT4_BG_INODE_ZEROED
)))

3223  
group
;

3224 
	}
}

3226 
	$pxt4_li_öfo_√w
()

3228 
pxt4_œzy_öô
 *
ñi
 = 
NULL
;

3230 
ñi
 = 
	`kzÆloc
((*ñi), 
GFP_KERNEL
);

3231 i‡(!
ñi
)

3232  -
ENOMEM
;

3234 
	`INIT_LIST_HEAD
(&
ñi
->
li_ªque°_li°
);

3235 
	`muãx_öô
(&
ñi
->
li_li°_mtx
);

3237 
ñi
->
li_°©e
 |
PXT4_LAZYINIT_QUIT
;

3239 
pxt4_li_öfo
 = 
ñi
;

3242 
	}
}

3244 
pxt4_li_ªque°
 *
	$pxt4_li_ªque°_√w
(
su≥r_block
 *
sb
,

3245 
pxt4_group_t
 
°¨t
)

3247 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3248 
pxt4_li_ªque°
 *
ñr
;

3250 
ñr
 = 
	`kzÆloc
((*ñr), 
GFP_KERNEL
);

3251 i‡(!
ñr
)

3252  
NULL
;

3254 
ñr
->
Ã_su≥r
 = 
sb
;

3255 
ñr
->
Ã_sbi
 = 
sbi
;

3256 
ñr
->
Ã_√xt_group
 = 
°¨t
;

3263 
ñr
->
Ã_√xt_sched
 = 
jiffõs
 + (
	`¥™dom_u32
() %

3264 (
PXT4_DEF_LI_MAX_START_DELAY
 * 
HZ
));

3265  
ñr
;

3266 
	}
}

3268 
	$pxt4_ªgi°î_li_ªque°
(
su≥r_block
 *
sb
,

3269 
pxt4_group_t
 
fú°_nŸ_zî€d
)

3271 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3272 
pxt4_li_ªque°
 *
ñr
 = 
NULL
;

3273 
pxt4_group_t
 
ngroups
 = 
sbi
->
s_groups_cou¡
;

3274 
ªt
 = 0;

3276 
	`muãx_lock
(&
pxt4_li_mtx
);

3277 i‡(
sbi
->
s_li_ªque°
 !
NULL
) {

3282 
sbi
->
s_li_ªque°
->
Ã_timeout
 = 0;

3283 
out
;

3286 i‡(
fú°_nŸ_zî€d
 =
ngroups
 || 
	`sb_rd⁄ly
(
sb
) ||

3287 !
	`ã°_›t
(
sb
, 
INIT_INODE_TABLE
))

3288 
out
;

3290 
ñr
 = 
	`pxt4_li_ªque°_√w
(
sb
, 
fú°_nŸ_zî€d
);

3291 i‡(!
ñr
) {

3292 
ªt
 = -
ENOMEM
;

3293 
out
;

3296 i‡(
NULL
 =
pxt4_li_öfo
) {

3297 
ªt
 = 
	`pxt4_li_öfo_√w
();

3298 i‡(
ªt
)

3299 
out
;

3302 
	`muãx_lock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3303 
	`li°_add
(&
ñr
->
Ã_ªque°
, &
pxt4_li_öfo
->
li_ªque°_li°
);

3304 
	`muãx_u∆ock
(&
pxt4_li_öfo
->
li_li°_mtx
);

3306 
sbi
->
s_li_ªque°
 = 
ñr
;

3312 
ñr
 = 
NULL
;

3314 i‡(!(
pxt4_li_öfo
->
li_°©e
 & 
PXT4_LAZYINIT_RUNNING
)) {

3315 
ªt
 = 
	`pxt4_run_œzyöô_thªad
();

3316 i‡(
ªt
)

3317 
out
;

3319 
out
:

3320 
	`muãx_u∆ock
(&
pxt4_li_mtx
);

3321 i‡(
ªt
)

3322 
	`k‰ì
(
ñr
);

3323  
ªt
;

3324 
	}
}

3330 
	$pxt4_de°roy_œzyöô_thªad
()

3336 i‡(!
pxt4_li_öfo
 || !
pxt4_œzyöô_èsk
)

3339 
	`kthªad_°›
(
pxt4_œzyöô_èsk
);

3340 
	}
}

3342 
	$£t_jou∫Æ_csum_„©uª_£t
(
su≥r_block
 *
sb
)

3344 
ªt
 = 1;

3345 
com∑t
, 
öcom∑t
;

3346 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3348 i‡(
	`pxt4_has_mëad©a_csum
(
sb
)) {

3350 
com∑t
 = 0;

3351 
öcom∑t
 = 
JBD3_FEATURE_INCOMPAT_CSUM_V3
;

3354 
com∑t
 = 
JBD3_FEATURE_COMPAT_CHECKSUM
;

3355 
öcom∑t
 = 0;

3358 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
,

3359 
JBD3_FEATURE_COMPAT_CHECKSUM
, 0,

3360 
JBD3_FEATURE_INCOMPAT_CSUM_V3
 |

3361 
JBD3_FEATURE_INCOMPAT_CSUM_V2
);

3362 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

3363 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3364 
com∑t
, 0,

3365 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
 |

3366 
öcom∑t
);

3367 } i‡(
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

3368 
ªt
 = 
	`jbd3_jou∫Æ_£t_„©uªs
(
sbi
->
s_jou∫Æ
,

3369 
com∑t
, 0,

3370 
öcom∑t
);

3371 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3372 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3374 
	`jbd3_jou∫Æ_˛ór_„©uªs
(
sbi
->
s_jou∫Æ
, 0, 0,

3375 
JBD3_FEATURE_INCOMPAT_ASYNC_COMMIT
);

3378  
ªt
;

3379 
	}
}

3396 
	$cou¡_ovîhód
(
su≥r_block
 *
sb
, 
pxt4_group_t
 
gΩ
,

3397 *
buf
)

3399 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3400 
pxt4_group_desc
 *
gdp
;

3401 
pxt4_fsblk_t
 
fú°_block
, 
œ°_block
, 
b
;

3402 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3403 
s
, 
j
, 
cou¡
 = 0;

3405 i‡(!
	`pxt4_has_„©uª_bigÆloc
(
sb
))

3406  (
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
Ë+ 
	`pxt4_bg_num_gdb
(sb, grp) +

3407 
sbi
->
s_ôb_≥r_group
 + 2);

3409 
fú°_block
 = 
	`À32_to_˝u
(
sbi
->
s_es
->
s_fú°_d©a_block
) +

3410 (
gΩ
 * 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

3411 
œ°_block
 = 
fú°_block
 + 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1;

3412 
i
 = 0; i < 
ngroups
; i++) {

3413 
gdp
 = 
	`pxt4_gë_group_desc
(
sb
, 
i
, 
NULL
);

3414 
b
 = 
	`pxt4_block_bôm≠
(
sb
, 
gdp
);

3415 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3416 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3417 
cou¡
++;

3419 
b
 = 
	`pxt4_öode_bôm≠
(
sb
, 
gdp
);

3420 i‡(
b
 >
fú°_block
 && b <
œ°_block
) {

3421 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
), 
buf
);

3422 
cou¡
++;

3424 
b
 = 
	`pxt4_öode_èbÀ
(
sb
, 
gdp
);

3425 i‡(
b
 >
fú°_block
 && b + 
sbi
->
s_ôb_≥r_group
 <
œ°_block
)

3426 
j
 = 0; j < 
sbi
->
s_ôb_≥r_group
; j++, 
b
++) {

3427 
c
 = 
	`PXT4_B2C
(
sbi
, 
b
 - 
fú°_block
);

3428 
	`pxt4_£t_bô
(
c
, 
buf
);

3429 
cou¡
++;

3431 i‡(
i
 !
gΩ
)

3433 
s
 = 0;

3434 i‡(
	`pxt4_bg_has_su≥r
(
sb
, 
gΩ
)) {

3435 
	`pxt4_£t_bô
(
s
++, 
buf
);

3436 
cou¡
++;

3438 
j
 = 
	`pxt4_bg_num_gdb
(
sb
, 
gΩ
);

3439 i‡(
s
 + 
j
 > 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)) {

3440 
	`pxt4_îr‹
(
sb
, "InvalidÇumber of block group "

3441 "des¸ùt‹ blocks: %d", 
j
);

3442 
j
 = 
	`PXT4_BLOCKS_PER_GROUP
(
sb
Ë- 
s
;

3444 
cou¡
 +
j
;

3445 ; 
j
 > 0; j--)

3446 
	`pxt4_£t_bô
(
	`PXT4_B2C
(
sbi
, 
s
++), 
buf
);

3448 i‡(!
cou¡
)

3450  
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) -

3451 
	`pxt4_cou¡_‰ì
(
buf
, 
	`PXT4_CLUSTERS_PER_GROUP
(
sb
) / 8);

3452 
	}
}

3457 
	$pxt4_ˇlcuœã_ovîhód
(
su≥r_block
 *
sb
)

3459 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3460 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3461 
öode
 *
j_öode
;

3462 
j_blocks
, 
j_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

3463 
pxt4_group_t
 
i
, 
ngroups
 = 
	`pxt4_gë_groups_cou¡
(
sb
);

3464 
pxt4_fsblk_t
 
ovîhód
 = 0;

3465 *
buf
 = (*Ë
	`gë_zî€d_∑ge
(
GFP_NOFS
);

3467 i‡(!
buf
)

3468  -
ENOMEM
;

3479 
ovîhód
 = 
	`PXT4_B2C
(
sbi
, 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
));

3484 
i
 = 0; i < 
ngroups
; i++) {

3485 
blks
;

3487 
blks
 = 
	`cou¡_ovîhód
(
sb
, 
i
, 
buf
);

3488 
ovîhód
 +
blks
;

3489 i‡(
blks
)

3490 
	`mem£t
(
buf
, 0, 
PAGE_SIZE
);

3491 
	`c⁄d_ªsched
();

3498 i‡(
sbi
->
s_jou∫Æ
 && !sbi->
jou∫Æ_bdev
)

3499 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, sbi->
s_jou∫Æ
->
j_maxÀn
);

3500 i‡(
	`pxt4_has_„©uª_jou∫Æ
(
sb
Ë&& !
sbi
->
s_jou∫Æ
) {

3501 
j_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
j_öum
);

3502 i‡(
j_öode
) {

3503 
j_blocks
 = 
j_öode
->
i_size
 >> 
sb
->
s_blocksize_bôs
;

3504 
ovîhód
 +
	`PXT4_NUM_B2C
(
sbi
, 
j_blocks
);

3505 
	`ùut
(
j_öode
);

3507 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't get journal size");

3510 
sbi
->
s_ovîhód
 = 
ovîhód
;

3511 
	`smp_wmb
();

3512 
	`‰ì_∑ge
((Ë
buf
);

3514 
	}
}

3516 
	$pxt4_˛amp_w™t_exåa_isize
(
su≥r_block
 *
sb
)

3518 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3519 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

3522 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
 &&

3523 
sbi
->
s_w™t_exåa_isize
 == 0) {

3524 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3525 
PXT4_GOOD_OLD_INODE_SIZE
;

3526 i‡(
	`pxt4_has_„©uª_exåa_isize
(
sb
)) {

3527 i‡(
sbi
->
s_w™t_exåa_isize
 <

3528 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
))

3529 
sbi
->
s_w™t_exåa_isize
 =

3530 
	`À16_to_˝u
(
es
->
s_w™t_exåa_isize
);

3531 i‡(
sbi
->
s_w™t_exåa_isize
 <

3532 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
))

3533 
sbi
->
s_w™t_exåa_isize
 =

3534 
	`À16_to_˝u
(
es
->
s_mö_exåa_isize
);

3538 i‡(
PXT4_GOOD_OLD_INODE_SIZE
 + 
sbi
->
s_w™t_exåa_isize
 >

3539 
sbi
->
s_öode_size
) {

3540 
sbi
->
s_w™t_exåa_isize
 = (
pxt4_öode
) -

3541 
PXT4_GOOD_OLD_INODE_SIZE
;

3542 
	`pxt4_msg
(
sb
, 
KERN_INFO
,

3545 
	}
}

3547 
	$pxt4_£t_ªsv_˛u°îs
(
su≥r_block
 *
sb
)

3549 
pxt4_fsblk_t
 
ªsv_˛u°îs
;

3550 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

3558 i‡(!
	`pxt4_has_„©uª_exã¡s
(
sb
))

3568 
ªsv_˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

3569 
sbi
->
s_˛u°î_bôs
);

3571 
	`do_div
(
ªsv_˛u°îs
, 50);

3572 
ªsv_˛u°îs
 = 
	`mö_t
(
pxt4_fsblk_t
,Ñesv_clusters, 4096);

3574 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
ªsv_˛u°îs
);

3575 
	}
}

3577 
	$pxt4_fûl_su≥r
(
su≥r_block
 *
sb
, *
d©a
, 
sûít
)

3579 
dax_devi˚
 *
dax_dev
 = 
	`fs_dax_gë_by_bdev
(
sb
->
s_bdev
);

3580 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

3581 
buf„r_hód
 *
bh
;

3582 
pxt4_su≥r_block
 *
es
 = 
NULL
;

3583 
pxt4_sb_öfo
 *
sbi
 = 
	`kzÆloc
((*sbi), 
GFP_KERNEL
);

3584 
pxt4_fsblk_t
 
block
;

3585 
pxt4_fsblk_t
 
sb_block
 = 
	`gë_sb_block
(&
d©a
);

3586 
pxt4_fsblk_t
 
logiˇl_sb_block
;

3587 
off£t
 = 0;

3588 
jou∫Æ_devnum
 = 0;

3589 
def_mou¡_›ts
;

3590 
öode
 *
roŸ
;

3591 c⁄° *
des¸
;

3592 
ªt
 = -
ENOMEM
;

3593 
blocksize
, 
˛u°îsize
;

3594 
db_cou¡
;

3595 
i
;

3596 
√eds_ªcovîy
, 
has_huge_fûes
, 
has_bigÆloc
;

3597 
__u64
 
blocks_cou¡
;

3598 
îr
 = 0;

3599 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

3600 
pxt4_group_t
 
fú°_nŸ_zî€d
;

3602 i‡((
d©a
 && !
‹ig_d©a
Ë|| !
sbi
)

3603 
out_‰ì_ba£
;

3605 
sbi
->
s_daxdev
 = 
dax_dev
;

3606 
sbi
->
s_blockgroup_lock
 =

3607 
	`kzÆloc
((
blockgroup_lock
), 
GFP_KERNEL
);

3608 i‡(!
sbi
->
s_blockgroup_lock
)

3609 
out_‰ì_ba£
;

3611 
sb
->
s_fs_öfo
 = 
sbi
;

3612 
sbi
->
s_sb
 = 
sb
;

3613 
sbi
->
s_öode_ªadahód_blks
 = 
PXT4_DEF_INODE_READAHEAD_BLKS
;

3614 
sbi
->
s_sb_block
 = 
sb_block
;

3615 i‡(
sb
->
s_bdev
->
bd_∑π
)

3616 
sbi
->
s_£˘‹s_wrôãn_°¨t
 =

3617 
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
, 
£˘‹s
[
STAT_WRITE
]);

3620 
	`°ºïœ˚
(
sb
->
s_id
, '/', '!');

3623 
ªt
 = -
EINVAL
;

3624 
blocksize
 = 
	`sb_mö_blocksize
(
sb
, 
PXT4_MIN_BLOCK_SIZE
);

3625 i‡(!
blocksize
) {

3626 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅo set blocksize");

3627 
out_Áû
;

3634 i‡(
blocksize
 !
PXT4_MIN_BLOCK_SIZE
) {

3635 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3636 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3638 
logiˇl_sb_block
 = 
sb_block
;

3641 i‡(!(
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
))) {

3642 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "unableÅoÑead superblock");

3643 
out_Áû
;

3649 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

3650 
sbi
->
s_es
 = 
es
;

3651 
sb
->
s_magic
 = 
	`À16_to_˝u
(
es
->s_magic);

3652 i‡(
sb
->
s_magic
 !
PXT4_SUPER_MAGIC
)

3653 
ˇ¡föd_pxt4
;

3654 
sbi
->
s_kbyãs_wrôãn
 = 
	`À64_to_˝u
(
es
->s_kbytes_written);

3657 i‡(
	`pxt4_has_„©uª_mëad©a_csum
(
sb
) &&

3658 
	`pxt4_has_„©uª_gdt_csum
(
sb
))

3659 
	`pxt4_w¨nög
(
sb
, "metadata_csumánd uninit_bgáre "

3663 i‡(!
	`pxt4_vîify_csum_ty≥
(
sb
, 
es
)) {

3664 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3666 
sûít
 = 1;

3667 
ˇ¡föd_pxt4
;

3671 
sbi
->
s_chksum_drivî
 = 
	`¸y±o_Æloc_shash
("crc32c", 0, 0);

3672 i‡(
	`IS_ERR
(
sbi
->
s_chksum_drivî
)) {

3673 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CannotÜoad crc32c driver.");

3674 
ªt
 = 
	`PTR_ERR
(
sbi
->
s_chksum_drivî
);

3675 
sbi
->
s_chksum_drivî
 = 
NULL
;

3676 
Áûed_mou¡
;

3680 i‡(!
	`pxt4_su≥rblock_csum_vîify
(
sb
, 
es
)) {

3681 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: FoundÖxt4 filesystem with "

3683 
sûít
 = 1;

3684 
ªt
 = -
EFSBADCRC
;

3685 
ˇ¡föd_pxt4
;

3689 i‡(
	`pxt4_has_„©uª_csum_£ed
(
sb
))

3690 
sbi
->
s_csum_£ed
 = 
	`À32_to_˝u
(
es
->
s_checksum_£ed
);

3691 i‡(
	`pxt4_has_mëad©a_csum
(
sb
Ë|| 
	`pxt4_has_„©uª_ó_öode
(sb))

3692 
sbi
->
s_csum_£ed
 = 
	`pxt4_chksum
(sbi, ~0, 
es
->
s_uuid
,

3693 (
es
->
s_uuid
));

3696 
def_mou¡_›ts
 = 
	`À32_to_˝u
(
es
->
s_deÁu…_mou¡_›ts
);

3697 
	`£t_›t
(
sb
, 
INIT_INODE_TABLE
);

3698 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DEBUG
)

3699 
	`£t_›t
(
sb
, 
DEBUG
);

3700 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_BSDGROUPS
)

3701 
	`£t_›t
(
sb
, 
GRPID
);

3702 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_UID16
)

3703 
	`£t_›t
(
sb
, 
NO_UID32
);

3705 
	`£t_›t
(
sb
, 
XATTR_USER
);

3706 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


3707 
	`£t_›t
(
sb
, 
POSIX_ACL
);

3710 i‡(
	`pxt4_has_mëad©a_csum
(
sb
))

3711 
	`£t_›t
(
sb
, 
JOURNAL_CHECKSUM
);

3713 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_DATA
)

3714 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

3715 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_ORDERED
)

3716 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

3717 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_JMODE
Ë=
PXT4_DEFM_JMODE_WBACK
)

3718 
	`£t_›t
(
sb
, 
WRITEBACK_DATA
);

3720 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_PANIC
)

3721 
	`£t_›t
(
sb
, 
ERRORS_PANIC
);

3722 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_îr‹s
Ë=
PXT4_ERRORS_CONTINUE
)

3723 
	`£t_›t
(
sb
, 
ERRORS_CONT
);

3725 
	`£t_›t
(
sb
, 
ERRORS_RO
);

3727 
	`£t_›t
(
sb
, 
BLOCK_VALIDITY
);

3728 i‡(
def_mou¡_›ts
 & 
PXT4_DEFM_DISCARD
)

3729 
	`£t_›t
(
sb
, 
DISCARD
);

3731 
sbi
->
s_ªsuid
 = 
	`make_kuid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsuid
));

3732 
sbi
->
s_ªsgid
 = 
	`make_kgid
(&
öô_u£r_ns
, 
	`À16_to_˝u
(
es
->
s_def_ªsgid
));

3733 
sbi
->
s_commô_öãrvÆ
 = 
JBD3_DEFAULT_MAX_COMMIT_AGE
 * 
HZ
;

3734 
sbi
->
s_mö_b©ch_time
 = 
PXT4_DEF_MIN_BATCH_TIME
;

3735 
sbi
->
s_max_b©ch_time
 = 
PXT4_DEF_MAX_BATCH_TIME
;

3737 i‡((
def_mou¡_›ts
 & 
PXT4_DEFM_NOBARRIER
) == 0)

3738 
	`£t_›t
(
sb
, 
BARRIER
);

3744 i‡(!
	`IS_EXT3_SB
(
sb
Ë&& !
	`IS_PXT2_SB
(sb) &&

3745 ((
def_mou¡_›ts
 & 
PXT4_DEFM_NODELALLOC
) == 0))

3746 
	`£t_›t
(
sb
, 
DELALLOC
);

3752 
sbi
->
s_li_waô_mu…
 = 
PXT4_DEF_LI_WAIT_MULT
;

3754 i‡(
sbi
->
s_es
->
s_mou¡_›ts
[0]) {

3755 *
s_mou¡_›ts
 = 
	`k°∫dup
(
sbi
->
s_es
->s_mount_opts,

3756 (
sbi
->
s_es
->
s_mou¡_›ts
),

3757 
GFP_KERNEL
);

3758 i‡(!
s_mou¡_›ts
)

3759 
Áûed_mou¡
;

3760 i‡(!
	`∑r£_›ti⁄s
(
s_mou¡_›ts
, 
sb
, &
jou∫Æ_devnum
,

3761 &
jou∫Æ_i›rio
, 0)) {

3762 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3764 
s_mou¡_›ts
);

3766 
	`k‰ì
(
s_mou¡_›ts
);

3768 
sbi
->
s_def_mou¡_›t
 = sbi->
s_mou¡_›t
;

3769 i‡(!
	`∑r£_›ti⁄s
((*Ë
d©a
, 
sb
, &
jou∫Æ_devnum
,

3770 &
jou∫Æ_i›rio
, 0))

3771 
Áûed_mou¡
;

3773 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

3774 
	`¥ötk_⁄˚
(
KERN_WARNING
 "PXT4-fs: Warning: mounting "

3777 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

3778 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3780 
Áûed_mou¡
;

3782 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

3783 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3785 
Áûed_mou¡
;

3787 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

3788 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

3790 
Áûed_mou¡
;

3792 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

3793 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3797 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

3798 
	`˛ór_›t
(
sb
, 
DELALLOC
);

3800 
sb
->
s_iÊags
 |
SB_I_CGROUPWB
;

3803 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

3804 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

3806 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
 &&

3807 (
	`pxt4_has_com∑t_„©uªs
(
sb
) ||

3808 
	`pxt4_has_ro_com∑t_„©uªs
(
sb
) ||

3809 
	`pxt4_has_öcom∑t_„©uªs
(
sb
)))

3810 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

3814 i‡(
es
->
s_¸ót‹_os
 =
	`˝u_to_À32
(
PXT4_OS_HURD
)) {

3815 
	`£t_›t2
(
sb
, 
HURD_COMPAT
);

3816 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3817 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3819 
Áûed_mou¡
;

3826 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

3827 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3829 
Áûed_mou¡
;

3833 i‡(
	`IS_PXT2_SB
(
sb
)) {

3834 i‡(
	`pxt2_„©uª_£t_ok
(
sb
))

3835 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÖxt2 file system "

3842 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3843 
Áûed_mou¡
;

3844 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÖxt2 due "

3846 
Áûed_mou¡
;

3850 i‡(
	`IS_EXT3_SB
(
sb
)) {

3851 i‡(
	`ext3_„©uª_£t_ok
(
sb
))

3852 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mountingÉxt3 file system "

3859 i‡(
sûít
 && 
	`pxt4_„©uª_£t_ok
(
sb
, 
	`sb_rd⁄ly
(sb)))

3860 
Áûed_mou¡
;

3861 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn't mountásÉxt3 due "

3863 
Áûed_mou¡
;

3872 i‡(!
	`pxt4_„©uª_£t_ok
(
sb
, (
	`sb_rd⁄ly
(sb))))

3873 
Áûed_mou¡
;

3875 
blocksize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_block_size
);

3876 i‡(
blocksize
 < 
PXT4_MIN_BLOCK_SIZE
 ||

3877 
blocksize
 > 
PXT4_MAX_BLOCK_SIZE
) {

3878 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3880 
blocksize
, 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3881 
Áûed_mou¡
;

3883 i‡(
	`À32_to_˝u
(
es
->
s_log_block_size
) >

3884 (
PXT4_MAX_BLOCK_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

3885 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3887 
	`À32_to_˝u
(
es
->
s_log_block_size
));

3888 
Áûed_mou¡
;

3890 i‡(
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) >

3891 (
PXT4_MAX_CLUSTER_LOG_SIZE
 - 
PXT4_MIN_BLOCK_LOG_SIZE
)) {

3892 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3894 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
));

3895 
Áûed_mou¡
;

3898 i‡(
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
Ë> (
blocksize
 / 4)) {

3899 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3901 
	`À16_to_˝u
(
sbi
->
s_es
->
s_ª£rved_gdt_blocks
));

3902 
Áûed_mou¡
;

3905 i‡(
sbi
->
s_mou¡_›t
 & 
PXT4_MOUNT_DAX
) {

3906 i‡(
	`pxt4_has_„©uª_ölöe_d©a
(
sb
)) {

3907 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Cannot use DAX oná filesystem"

3909 
Áûed_mou¡
;

3911 i‡(!
	`bdev_dax_suµ‹ãd
(
sb
->
s_bdev
, 
blocksize
)) {

3912 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3914 
Áûed_mou¡
;

3918 i‡(
	`pxt4_has_„©uª_í¸y±
(
sb
Ë&& 
es
->
s_í¸y±i⁄_Àvñ
) {

3919 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "UnsupportedÉncryptionÜevel %d",

3920 
es
->
s_í¸y±i⁄_Àvñ
);

3921 
Áûed_mou¡
;

3924 i‡(
sb
->
s_blocksize
 !
blocksize
) {

3926 i‡(!
	`sb_£t_blocksize
(
sb
, 
blocksize
)) {

3927 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "bad block size %d",

3928 
blocksize
);

3929 
Áûed_mou¡
;

3932 
	`bªl£
(
bh
);

3933 
logiˇl_sb_block
 = 
sb_block
 * 
PXT4_MIN_BLOCK_SIZE
;

3934 
off£t
 = 
	`do_div
(
logiˇl_sb_block
, 
blocksize
);

3935 
bh
 = 
	`sb_bªad_unmovabÀ
(
sb
, 
logiˇl_sb_block
);

3936 i‡(!
bh
) {

3937 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3939 
Áûed_mou¡
;

3941 
es
 = (
pxt4_su≥r_block
 *)(
bh
->
b_d©a
 + 
off£t
);

3942 
sbi
->
s_es
 = 
es
;

3943 i‡(
es
->
s_magic
 !
	`˝u_to_À16
(
PXT4_SUPER_MAGIC
)) {

3944 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3946 
Áûed_mou¡
;

3950 
has_huge_fûes
 = 
	`pxt4_has_„©uª_huge_fûe
(
sb
);

3951 
sbi
->
s_bôm≠_maxbyãs
 = 
	`pxt4_max_bôm≠_size
(
sb
->
s_blocksize_bôs
,

3952 
has_huge_fûes
);

3953 
sb
->
s_maxbyãs
 = 
	`pxt4_max_size
(sb->
s_blocksize_bôs
, 
has_huge_fûes
);

3955 i‡(
	`À32_to_˝u
(
es
->
s_ªv_Àvñ
Ë=
PXT4_GOOD_OLD_REV
) {

3956 
sbi
->
s_öode_size
 = 
PXT4_GOOD_OLD_INODE_SIZE
;

3957 
sbi
->
s_fú°_öo
 = 
PXT4_GOOD_OLD_FIRST_INO
;

3959 
sbi
->
s_öode_size
 = 
	`À16_to_˝u
(
es
->s_inode_size);

3960 
sbi
->
s_fú°_öo
 = 
	`À32_to_˝u
(
es
->s_first_ino);

3961 i‡(
sbi
->
s_fú°_öo
 < 
PXT4_GOOD_OLD_FIRST_INO
) {

3962 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid first ino: %u",

3963 
sbi
->
s_fú°_öo
);

3964 
Áûed_mou¡
;

3966 i‡((
sbi
->
s_öode_size
 < 
PXT4_GOOD_OLD_INODE_SIZE
) ||

3967 (!
	`is_powî_of_2
(
sbi
->
s_öode_size
)) ||

3968 (
sbi
->
s_öode_size
 > 
blocksize
)) {

3969 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3971 
sbi
->
s_öode_size
);

3972 
Áûed_mou¡
;

3974 i‡(
sbi
->
s_öode_size
 > 
PXT4_GOOD_OLD_INODE_SIZE
)

3975 
sb
->
s_time_gøn
 = 1 << (
PXT4_EPOCH_BITS
 - 2);

3978 
sbi
->
s_desc_size
 = 
	`À16_to_˝u
(
es
->s_desc_size);

3979 i‡(
	`pxt4_has_„©uª_64bô
(
sb
)) {

3980 i‡(
sbi
->
s_desc_size
 < 
PXT4_MIN_DESC_SIZE_64BIT
 ||

3981 
sbi
->
s_desc_size
 > 
PXT4_MAX_DESC_SIZE
 ||

3982 !
	`is_powî_of_2
(
sbi
->
s_desc_size
)) {

3983 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

3985 
sbi
->
s_desc_size
);

3986 
Áûed_mou¡
;

3989 
sbi
->
s_desc_size
 = 
PXT4_MIN_DESC_SIZE
;

3991 
sbi
->
s_blocks_≥r_group
 = 
	`À32_to_˝u
(
es
->s_blocks_per_group);

3992 
sbi
->
s_öodes_≥r_group
 = 
	`À32_to_˝u
(
es
->s_inodes_per_group);

3994 
sbi
->
s_öodes_≥r_block
 = 
blocksize
 / 
	`PXT4_INODE_SIZE
(
sb
);

3995 i‡(
sbi
->
s_öodes_≥r_block
 == 0)

3996 
ˇ¡föd_pxt4
;

3997 i‡(
sbi
->
s_öodes_≥r_group
 < sbi->
s_öodes_≥r_block
 ||

3998 
sbi
->
s_öodes_≥r_group
 > 
blocksize
 * 8) {

3999 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid inodesÖer group: %lu\n",

4000 
sbi
->
s_blocks_≥r_group
);

4001 
Áûed_mou¡
;

4003 
sbi
->
s_ôb_≥r_group
 = sbi->
s_öodes_≥r_group
 /

4004 
sbi
->
s_öodes_≥r_block
;

4005 
sbi
->
s_desc_≥r_block
 = 
blocksize
 / 
	`PXT4_DESC_SIZE
(
sb
);

4006 
sbi
->
s_sbh
 = 
bh
;

4007 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

4008 
sbi
->
s_addr_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_ADDR_PER_BLOCK
(
sb
));

4009 
sbi
->
s_desc_≥r_block_bôs
 = 
	`ûog2
(
	`PXT4_DESC_PER_BLOCK
(
sb
));

4011 
i
 = 0; i < 4; i++)

4012 
sbi
->
s_hash_£ed
[
i
] = 
	`À32_to_˝u
(
es
->s_hash_seed[i]);

4013 
sbi
->
s_def_hash_vîsi⁄
 = 
es
->s_def_hash_version;

4014 i‡(
	`pxt4_has_„©uª_dú_ödex
(
sb
)) {

4015 
i
 = 
	`À32_to_˝u
(
es
->
s_Êags
);

4016 i‡(
i
 & 
PXT2_FLAGS_UNSIGNED_HASH
)

4017 
sbi
->
s_hash_unsig√d
 = 3;

4018 i‡((
i
 & 
PXT2_FLAGS_SIGNED_HASH
) == 0) {

4019 #ifde‡
__CHAR_UNSIGNED__


4020 i‡(!
	`sb_rd⁄ly
(
sb
))

4021 
es
->
s_Êags
 |=

4022 
	`˝u_to_À32
(
PXT2_FLAGS_UNSIGNED_HASH
);

4023 
sbi
->
s_hash_unsig√d
 = 3;

4025 i‡(!
	`sb_rd⁄ly
(
sb
))

4026 
es
->
s_Êags
 |=

4027 
	`˝u_to_À32
(
PXT2_FLAGS_SIGNED_HASH
);

4033 
˛u°îsize
 = 
BLOCK_SIZE
 << 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
);

4034 
has_bigÆloc
 = 
	`pxt4_has_„©uª_bigÆloc
(
sb
);

4035 i‡(
has_bigÆloc
) {

4036 i‡(
˛u°îsize
 < 
blocksize
) {

4037 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4039 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4040 
Áûed_mou¡
;

4042 
sbi
->
s_˛u°î_bôs
 = 
	`À32_to_˝u
(
es
->
s_log_˛u°î_size
) -

4043 
	`À32_to_˝u
(
es
->
s_log_block_size
);

4044 
sbi
->
s_˛u°îs_≥r_group
 =

4045 
	`À32_to_˝u
(
es
->
s_˛u°îs_≥r_group
);

4046 i‡(
sbi
->
s_˛u°îs_≥r_group
 > 
blocksize
 * 8) {

4047 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4049 
sbi
->
s_˛u°îs_≥r_group
);

4050 
Áûed_mou¡
;

4052 i‡(
sbi
->
s_blocks_≥r_group
 !=

4053 (
sbi
->
s_˛u°îs_≥r_group
 * (
˛u°îsize
 / 
blocksize
))) {

4054 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "blocksÖer group (%lu)ánd "

4056 
sbi
->
s_blocks_≥r_group
,

4057 
sbi
->
s_˛u°îs_≥r_group
);

4058 
Áûed_mou¡
;

4061 i‡(
˛u°îsize
 !
blocksize
) {

4062 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4064 "block sizê(%d)", 
˛u°îsize
, 
blocksize
);

4065 
Áûed_mou¡
;

4067 i‡(
sbi
->
s_blocks_≥r_group
 > 
blocksize
 * 8) {

4068 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4070 
sbi
->
s_blocks_≥r_group
);

4071 
Áûed_mou¡
;

4073 
sbi
->
s_˛u°îs_≥r_group
 = sbi->
s_blocks_≥r_group
;

4074 
sbi
->
s_˛u°î_bôs
 = 0;

4076 
sbi
->
s_˛u°î_øtio
 = 
˛u°îsize
 / 
blocksize
;

4079 i‡(
sbi
->
s_blocks_≥r_group
 =
˛u°îsize
 << 3)

4080 
	`£t_›t2
(
sb
, 
STD_GROUP_SIZE
);

4086 
îr
 = 
	`gíîic_check_addªsßbÀ
(
sb
->
s_blocksize_bôs
,

4087 
	`pxt4_blocks_cou¡
(
es
));

4088 i‡(
îr
) {

4089 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem"

4091 i‡((
£˘‹_t
) < 8)

4092 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "CONFIG_LBDAFÇotÉnabled");

4093 
Áûed_mou¡
;

4096 i‡(
	`PXT4_BLOCKS_PER_GROUP
(
sb
) == 0)

4097 
ˇ¡föd_pxt4
;

4100 
blocks_cou¡
 = 
sb
->
s_bdev
->
bd_öode
->
i_size
 >> sb->
s_blocksize_bôs
;

4101 i‡(
blocks_cou¡
 && 
	`pxt4_blocks_cou¡
(
es
) > blocks_count) {

4102 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: block count %llu "

4104 
	`pxt4_blocks_cou¡
(
es
), 
blocks_cou¡
);

4105 
Áûed_mou¡
;

4112 i‡(
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
Ë>
	`pxt4_blocks_cou¡
(es)) {

4113 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4115 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4116 
	`pxt4_blocks_cou¡
(
es
));

4117 
Áûed_mou¡
;

4119 i‡((
es
->
s_fú°_d©a_block
 =0Ë&& (es->
s_log_block_size
 == 0) &&

4120 (
sbi
->
s_˛u°î_øtio
 == 1)) {

4121 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "bad geometry: first data "

4123 
Áûed_mou¡
;

4126 
blocks_cou¡
 = (
	`pxt4_blocks_cou¡
(
es
) -

4127 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
) +

4128 
	`PXT4_BLOCKS_PER_GROUP
(
sb
) - 1);

4129 
	`do_div
(
blocks_cou¡
, 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4130 i‡(
blocks_cou¡
 > ((
uöt64_t
)1<<32Ë- 
	`PXT4_DESC_PER_BLOCK
(
sb
)) {

4131 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "groups countÅooÜarge: %u "

4133 "block†≥∏grou∞%lu)", 
sbi
->
s_groups_cou¡
,

4134 
	`pxt4_blocks_cou¡
(
es
),

4135 
	`À32_to_˝u
(
es
->
s_fú°_d©a_block
),

4136 
	`PXT4_BLOCKS_PER_GROUP
(
sb
));

4137 
Áûed_mou¡
;

4139 
sbi
->
s_groups_cou¡
 = 
blocks_cou¡
;

4140 
sbi
->
s_blockfûe_groups
 = 
	`mö_t
(
pxt4_group_t
, sbi->
s_groups_cou¡
,

4141 (
PXT4_MAX_BLOCK_FILE_PHYS
 / 
	`PXT4_BLOCKS_PER_GROUP
(
sb
)));

4142 i‡(((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
) !=

4143 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
)) {

4144 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "inodes countÇot valid: %u vs %llu",

4145 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
),

4146 ((
u64
)
sbi
->
s_groups_cou¡
 * sbi->
s_öodes_≥r_group
));

4147 
ªt
 = -
EINVAL
;

4148 
Áûed_mou¡
;

4150 
db_cou¡
 = (
sbi
->
s_groups_cou¡
 + 
	`PXT4_DESC_PER_BLOCK
(
sb
) - 1) /

4151 
	`PXT4_DESC_PER_BLOCK
(
sb
);

4152 i‡(
	`pxt4_has_„©uª_mëa_bg
(
sb
)) {

4153 i‡(
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
Ë> 
db_cou¡
) {

4154 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4157 
	`À32_to_˝u
(
es
->
s_fú°_mëa_bg
), 
db_cou¡
);

4158 
Áûed_mou¡
;

4161 
sbi
->
s_group_desc
 = 
	`kvmÆloc_¨øy
(
db_cou¡
,

4162 (
buf„r_hód
 *),

4163 
GFP_KERNEL
);

4164 i‡(
sbi
->
s_group_desc
 =
NULL
) {

4165 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "notÉnough memory");

4166 
ªt
 = -
ENOMEM
;

4167 
Áûed_mou¡
;

4170 
	`bgl_lock_öô
(
sbi
->
s_blockgroup_lock
);

4173 
i
 = 0; i < 
db_cou¡
; i++) {

4174 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4175 
	`sb_bªadahód
(
sb
, 
block
);

4178 
i
 = 0; i < 
db_cou¡
; i++) {

4179 
block
 = 
	`des¸ùt‹_loc
(
sb
, 
logiˇl_sb_block
, 
i
);

4180 
sbi
->
s_group_desc
[
i
] = 
	`sb_bªad_unmovabÀ
(
sb
, 
block
);

4181 i‡(!
sbi
->
s_group_desc
[
i
]) {

4182 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4183 "ˇn'àªad grou∞des¸ùt‹ %d", 
i
);

4184 
db_cou¡
 = 
i
;

4185 
Áûed_mou¡2
;

4188 
sbi
->
s_gdb_cou¡
 = 
db_cou¡
;

4189 i‡(!
	`pxt4_check_des¸ùt‹s
(
sb
, 
logiˇl_sb_block
, &
fú°_nŸ_zî€d
)) {

4190 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "group descriptors corrupted!");

4191 
ªt
 = -
EFSCORRUPTED
;

4192 
Áûed_mou¡2
;

4195 
	`timî_£tup
(&
sbi
->
s_îr_ªp‹t
, 
¥öt_daûy_îr‹_öfo
, 0);

4198 i‡(
	`pxt4_es_ªgi°î_shrökî
(
sbi
))

4199 
Áûed_mou¡3
;

4201 
sbi
->
s_°rùe
 = 
	`pxt4_gë_°rùe_size
(sbi);

4202 
sbi
->
s_exã¡_max_zîoout_kb
 = 32;

4207 
sb
->
s_›
 = &
pxt4_s›s
;

4208 
sb
->
s_exp‹t_›
 = &
pxt4_exp‹t_›s
;

4209 
sb
->
s_x©å
 = 
pxt4_x©å_h™dÀrs
;

4210 #ifde‡
CONFIG_FS_ENCRYPTION


4211 
sb
->
s_c›
 = &
pxt4_¸y±›s
;

4213 #ifde‡
CONFIG_QUOTA


4214 
sb
->
dq_›
 = &
pxt4_quŸa_›î©i⁄s
;

4215 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
))

4216 
sb
->
s_qc›
 = &
dquŸ_quŸa˘l_sysfûe_›s
;

4218 
sb
->
s_qc›
 = &
pxt4_q˘l_›î©i⁄s
;

4219 
sb
->
s_quŸa_ty≥s
 = 
QTYPE_MASK_USR
 | 
QTYPE_MASK_GRP
 | 
QTYPE_MASK_PRJ
;

4221 
	`mem˝y
(&
sb
->
s_uuid
, 
es
->s_uuid, (es->s_uuid));

4223 
	`INIT_LIST_HEAD
(&
sbi
->
s_‹ph™
);

4224 
	`muãx_öô
(&
sbi
->
s_‹ph™_lock
);

4226 
sb
->
s_roŸ
 = 
NULL
;

4228 
√eds_ªcovîy
 = (
es
->
s_œ°_‹ph™
 != 0 ||

4229 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
));

4231 i‡(
	`pxt4_has_„©uª_mmp
(
sb
Ë&& !
	`sb_rd⁄ly
(sb))

4232 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
, 
	`À64_to_˝u
(
es
->
s_mmp_block
)))

4233 
Áûed_mou¡3a
;

4239 i‡(!
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& 
	`pxt4_has_„©uª_jou∫Æ
(sb)) {

4240 
îr
 = 
	`pxt4_lﬂd_jou∫Æ
(
sb
, 
es
, 
jou∫Æ_devnum
);

4241 i‡(
îr
)

4242 
Áûed_mou¡3a
;

4243 } i‡(
	`ã°_›t
(
sb
, 
NOLOAD
Ë&& !
	`sb_rd⁄ly
(sb) &&

4244 
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4245 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "required journalÑecovery "

4247 
Áûed_mou¡_wq
;

4250 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_JOURNAL_CHECKSUM
)) {

4251 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4253 
Áûed_mou¡_wq
;

4255 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4256 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4258 
Áûed_mou¡_wq
;

4260 i‡(
sbi
->
s_commô_öãrvÆ
 !
JBD3_DEFAULT_MAX_COMMIT_AGE
*
HZ
) {

4261 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4263 
sbi
->
s_commô_öãrvÆ
 / 
HZ
);

4264 
Áûed_mou¡_wq
;

4266 i‡(
PXT4_MOUNT_DATA_FLAGS
 &

4267 (
sbi
->
s_mou¡_›t
 ^ sbi->
s_def_mou¡_›t
)) {

4268 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4270 
Áûed_mou¡_wq
;

4272 
sbi
->
s_def_mou¡_›t
 &~
PXT4_MOUNT_JOURNAL_CHECKSUM
;

4273 
	`˛ór_›t
(
sb
, 
JOURNAL_CHECKSUM
);

4274 
	`˛ór_›t
(
sb
, 
DATA_FLAGS
);

4275 
sbi
->
s_jou∫Æ
 = 
NULL
;

4276 
√eds_ªcovîy
 = 0;

4277 
no_jou∫Æ
;

4280 i‡(
	`pxt4_has_„©uª_64bô
(
sb
) &&

4281 !
	`jbd3_jou∫Æ_£t_„©uªs
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
, 0, 0,

4282 
JBD3_FEATURE_INCOMPAT_64BIT
)) {

4283 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set 64-bit journal feature");

4284 
Áûed_mou¡_wq
;

4287 i‡(!
	`£t_jou∫Æ_csum_„©uª_£t
(
sb
)) {

4288 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "FailedÅo set journal checksum "

4290 
Áûed_mou¡_wq
;

4295 
	`ã°_›t
(
sb
, 
DATA_FLAGS
)) {

4301 i‡(
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4302 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4303 
	`£t_›t
(
sb
, 
ORDERED_DATA
);

4304 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_ORDERED_DATA
;

4306 
	`£t_›t
(
sb
, 
JOURNAL_DATA
);

4307 
sbi
->
s_def_mou¡_›t
 |
PXT4_MOUNT_JOURNAL_DATA
;

4311 
PXT4_MOUNT_ORDERED_DATA
:

4312 
PXT4_MOUNT_WRITEBACK_DATA
:

4313 i‡(!
jbd3_jou∫Æ_check_avaûabÀ_„©uªs


4314 (
sbi
->
s_jou∫Æ
, 0, 0, 
JBD3_FEATURE_INCOMPAT_REVOKE
)) {

4315 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "Journal doesÇot support "

4317 
Áûed_mou¡_wq
;

4323 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
 &&

4324 
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

4325 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

4327 
Áûed_mou¡_wq
;

4330 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

4332 
sbi
->
s_jou∫Æ
->
j_commô_ˇŒback
 = 
pxt4_jou∫Æ_commô_ˇŒback
;

4334 
no_jou∫Æ
:

4335 i‡(!
	`ã°_›t
(
sb
, 
NO_MBCACHE
)) {

4336 
sbi
->
s_ó_block_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4337 i‡(!
sbi
->
s_ó_block_ˇche
) {

4338 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4340 
Áûed_mou¡_wq
;

4343 i‡(
	`pxt4_has_„©uª_ó_öode
(
sb
)) {

4344 
sbi
->
s_ó_öode_ˇche
 = 
	`pxt4_x©å_¸óã_ˇche
();

4345 i‡(!
sbi
->
s_ó_öode_ˇche
) {

4346 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4348 
Áûed_mou¡_wq
;

4353 i‡((
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë|| 
	`pxt4_has_„©uª_í¸y±
(
sb
)) &&

4354 (
blocksize
 !
PAGE_SIZE
)) {

4355 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4357 
Áûed_mou¡_wq
;

4360 i‡(
	`DUMMY_ENCRYPTION_ENABLED
(
sbi
Ë&& !
	`sb_rd⁄ly
(
sb
) &&

4361 !
	`pxt4_has_„©uª_í¸y±
(
sb
)) {

4362 
	`pxt4_£t_„©uª_í¸y±
(
sb
);

4363 
	`pxt4_commô_su≥r
(
sb
, 1);

4370 i‡(
es
->
s_ovîhód_˛u°îs
)

4371 
sbi
->
s_ovîhód
 = 
	`À32_to_˝u
(
es
->
s_ovîhód_˛u°îs
);

4373 
îr
 = 
	`pxt4_ˇlcuœã_ovîhód
(
sb
);

4374 i‡(
îr
)

4375 
Áûed_mou¡_wq
;

4382 
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
 =

4383 
	`Æloc_w‹kqueue
("pxt4-rsv-c⁄vîsi⁄", 
WQ_MEM_RECLAIM
 | 
WQ_UNBOUND
, 1);

4384 i‡(!
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
) {

4385 
	`¥ötk
(
KERN_ERR
 "PXT4-fs: failedÅo create workqueue\n");

4386 
ªt
 = -
ENOMEM
;

4387 
Áûed_mou¡4
;

4395 
roŸ
 = 
	`pxt4_igë
(
sb
, 
PXT4_ROOT_INO
, 
PXT4_IGET_SPECIAL
);

4396 i‡(
	`IS_ERR
(
roŸ
)) {

4397 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot inode failed");

4398 
ªt
 = 
	`PTR_ERR
(
roŸ
);

4399 
roŸ
 = 
NULL
;

4400 
Áûed_mou¡4
;

4402 i‡(!
	`S_ISDIR
(
roŸ
->
i_mode
Ë|| !roŸ->
i_blocks
 || !roŸ->
i_size
) {

4403 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "corruptÑoot inode,ÑunÉ2fsck");

4404 
	`ùut
(
roŸ
);

4405 
Áûed_mou¡4
;

4407 
sb
->
s_roŸ
 = 
	`d_make_roŸ
(
roŸ
);

4408 i‡(!
sb
->
s_roŸ
) {

4409 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "getÑoot dentry failed");

4410 
ªt
 = -
ENOMEM
;

4411 
Áûed_mou¡4
;

4414 
ªt
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 
	`sb_rd⁄ly
(sb));

4415 i‡(
ªt
 =-
EROFS
) {

4416 
sb
->
s_Êags
 |
SB_RDONLY
;

4417 
ªt
 = 0;

4418 } i‡(
ªt
)

4419 
Áûed_mou¡4a
;

4421 
	`pxt4_˛amp_w™t_exåa_isize
(
sb
);

4423 
	`pxt4_£t_ªsv_˛u°îs
(
sb
);

4425 
îr
 = 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

4426 i‡(
îr
) {

4427 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize system "

4428 "z⁄ê(%d)", 
îr
);

4429 
Áûed_mou¡4a
;

4432 
	`pxt4_ext_öô
(
sb
);

4433 
îr
 = 
	`pxt4_mb_öô
(
sb
);

4434 i‡(
îr
) {

4435 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo initialize mballoc (%d)",

4436 
îr
);

4437 
Áûed_mou¡5
;

4440 
block
 = 
	`pxt4_cou¡_‰ì_˛u°îs
(
sb
);

4441 
	`pxt4_‰ì_blocks_cou¡_£t
(
sbi
->
s_es
,

4442 
	`PXT4_C2B
(
sbi
, 
block
));

4443 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4444 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ì˛u°îs_cou¡î
, 
block
,

4445 
GFP_KERNEL
);

4446 i‡(!
îr
) {

4447 
‰ìi
 = 
	`pxt4_cou¡_‰ì_öodes
(
sb
);

4448 
sbi
->
s_es
->
s_‰ì_öodes_cou¡
 = 
	`˝u_to_À32
(
‰ìi
);

4449 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4450 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_‰ìöodes_cou¡î
, 
‰ìi
,

4451 
GFP_KERNEL
);

4453 i‡(!
îr
)

4454 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dús_cou¡î
,

4455 
	`pxt4_cou¡_dús
(
sb
), 
GFP_KERNEL
);

4456 i‡(!
îr
)

4457 
îr
 = 
	`≥r˝u_cou¡î_öô
(&
sbi
->
s_dúty˛u°îs_cou¡î
, 0,

4458 
GFP_KERNEL
);

4459 i‡(!
îr
)

4460 
îr
 = 
	`≥r˝u_öô_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

4462 i‡(
îr
) {

4463 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "insufficient memory");

4464 
Áûed_mou¡6
;

4467 i‡(
	`pxt4_has_„©uª_Êex_bg
(
sb
))

4468 i‡(!
	`pxt4_fûl_Êex_öfo
(
sb
)) {

4469 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4472 
Áûed_mou¡6
;

4475 
îr
 = 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

4476 i‡(
îr
)

4477 
Áûed_mou¡6
;

4479 
îr
 = 
	`pxt4_ªgi°î_sysfs
(
sb
);

4480 i‡(
îr
)

4481 
Áûed_mou¡7
;

4483 #ifde‡
CONFIG_QUOTA


4485 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
Ë&& !
	`sb_rd⁄ly
(sb)) {

4486 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

4487 i‡(
îr
)

4488 
Áûed_mou¡8
;

4492 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ORPHAN_FS
;

4493 
	`pxt4_‹ph™_˛ónup
(
sb
, 
es
);

4494 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 &~
PXT4_ORPHAN_FS
;

4495 i‡(
√eds_ªcovîy
) {

4496 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "recovery complete");

4497 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

4499 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

4500 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
)

4501 
des¸
 = " journalled data mode";

4502 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
)

4503 
des¸
 = " ordered data mode";

4505 
des¸
 = " writeback data mode";

4507 
des¸
 = "out journal";

4509 i‡(
	`ã°_›t
(
sb
, 
DISCARD
)) {

4510 
ªque°_queue
 *
q
 = 
	`bdev_gë_queue
(
sb
->
s_bdev
);

4511 i‡(!
	`blk_queue_disˇrd
(
q
))

4512 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

4517 i‡(
	`___øãlimô
(&
pxt4_mou¡_msg_øãlimô
, "PXT4-fs mount"))

4518 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "mounted filesystem with%s. "

4519 "O±s: %.*s%s%s", 
des¸
,

4520 (Ë(
sbi
->
s_es
->
s_mou¡_›ts
),

4521 
sbi
->
s_es
->
s_mou¡_›ts
,

4522 *
sbi
->
s_es
->
s_mou¡_›ts
 ? "; " : "", 
‹ig_d©a
);

4524 i‡(
es
->
s_îr‹_cou¡
)

4525 
	`mod_timî
(&
sbi
->
s_îr_ªp‹t
, 
jiffõs
 + 300*
HZ
);

4528 
	`øãlimô_°©e_öô
(&
sbi
->
s_îr_øãlimô_°©e
, 5 * 
HZ
, 10);

4529 
	`øãlimô_°©e_öô
(&
sbi
->
s_w¨nög_øãlimô_°©e
, 5 * 
HZ
, 10);

4530 
	`øãlimô_°©e_öô
(&
sbi
->
s_msg_øãlimô_°©e
, 5 * 
HZ
, 10);

4532 
	`k‰ì
(
‹ig_d©a
);

4535 
ˇ¡föd_pxt4
:

4536 i‡(!
sûít
)

4537 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "VFS: Can't findÖxt4 filesystem");

4538 
Áûed_mou¡
;

4540 #ifde‡
CONFIG_QUOTA


4541 
Áûed_mou¡8
:

4542 
	`pxt4_uƒegi°î_sysfs
(
sb
);

4544 
Áûed_mou¡7
:

4545 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

4546 
Áûed_mou¡6
:

4547 
	`pxt4_mb_ªÀa£
(
sb
);

4548 i‡(
sbi
->
s_Êex_groups
)

4549 
	`kv‰ì
(
sbi
->
s_Êex_groups
);

4550 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ì˛u°îs_cou¡î
);

4551 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_‰ìöodes_cou¡î
);

4552 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dús_cou¡î
);

4553 
	`≥r˝u_cou¡î_de°roy
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

4554 
	`≥r˝u_‰ì_rw£m
(&
sbi
->
s_jou∫Æ_Êag_rw£m
);

4555 
Áûed_mou¡5
:

4556 
	`pxt4_ext_ªÀa£
(
sb
);

4557 
	`pxt4_ªÀa£_sy°em_z⁄e
(
sb
);

4558 
Áûed_mou¡4a
:

4559 
	`dput
(
sb
->
s_roŸ
);

4560 
sb
->
s_roŸ
 = 
NULL
;

4561 
Áûed_mou¡4
:

4562 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "mount failed");

4563 i‡(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
)

4564 
	`de°roy_w‹kqueue
(
	`PXT4_SB
(
sb
)->
rsv_c⁄vîsi⁄_wq
);

4565 
Áûed_mou¡_wq
:

4566 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_öode_ˇche
);

4567 
sbi
->
s_ó_öode_ˇche
 = 
NULL
;

4569 
	`pxt4_x©å_de°roy_ˇche
(
sbi
->
s_ó_block_ˇche
);

4570 
sbi
->
s_ó_block_ˇche
 = 
NULL
;

4572 i‡(
sbi
->
s_jou∫Æ
) {

4573 
	`jbd3_jou∫Æ_de°roy
(
sbi
->
s_jou∫Æ
);

4574 
sbi
->
s_jou∫Æ
 = 
NULL
;

4576 
Áûed_mou¡3a
:

4577 
	`pxt4_es_uƒegi°î_shrökî
(
sbi
);

4578 
Áûed_mou¡3
:

4579 
	`dñ_timî_sync
(&
sbi
->
s_îr_ªp‹t
);

4580 i‡(
sbi
->
s_mmp_tsk
)

4581 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

4582 
Áûed_mou¡2
:

4583 
i
 = 0; i < 
db_cou¡
; i++)

4584 
	`bªl£
(
sbi
->
s_group_desc
[
i
]);

4585 
	`kv‰ì
(
sbi
->
s_group_desc
);

4586 
Áûed_mou¡
:

4587 i‡(
sbi
->
s_chksum_drivî
)

4588 
	`¸y±o_‰ì_shash
(
sbi
->
s_chksum_drivî
);

4589 #ifde‡
CONFIG_QUOTA


4590 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

4591 
	`k‰ì
(
sbi
->
s_qf_«mes
[
i
]);

4593 
	`pxt4_blkdev_ªmove
(
sbi
);

4594 
	`bªl£
(
bh
);

4595 
out_Áû
:

4596 
sb
->
s_fs_öfo
 = 
NULL
;

4597 
	`k‰ì
(
sbi
->
s_blockgroup_lock
);

4598 
out_‰ì_ba£
:

4599 
	`k‰ì
(
sbi
);

4600 
	`k‰ì
(
‹ig_d©a
);

4601 
	`fs_put_dax
(
dax_dev
);

4602  
îr
 ?Éº : 
ªt
;

4603 
	}
}

4610 
	$pxt4_öô_jou∫Æ_∑øms
(
su≥r_block
 *
sb
, 
jou∫Æ_t
 *
jou∫Æ
)

4612 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

4614 
jou∫Æ
->
j_commô_öãrvÆ
 = 
sbi
->
s_commô_öãrvÆ
;

4615 
jou∫Æ
->
j_mö_b©ch_time
 = 
sbi
->
s_mö_b©ch_time
;

4616 
jou∫Æ
->
j_max_b©ch_time
 = 
sbi
->
s_max_b©ch_time
;

4618 
	`wrôe_lock
(&
jou∫Æ
->
j_°©e_lock
);

4619 i‡(
	`ã°_›t
(
sb
, 
BARRIER
))

4620 
jou∫Æ
->
j_Êags
 |
JBD3_BARRIER
;

4622 
jou∫Æ
->
j_Êags
 &~
JBD3_BARRIER
;

4623 i‡(
	`ã°_›t
(
sb
, 
DATA_ERR_ABORT
))

4624 
jou∫Æ
->
j_Êags
 |
JBD3_ABORT_ON_SYNCDATA_ERR
;

4626 
jou∫Æ
->
j_Êags
 &~
JBD3_ABORT_ON_SYNCDATA_ERR
;

4627 
	`wrôe_u∆ock
(&
jou∫Æ
->
j_°©e_lock
);

4628 
	}
}

4630 
öode
 *
	$pxt4_gë_jou∫Æ_öode
(
su≥r_block
 *
sb
,

4631 
jou∫Æ_öum
)

4633 
öode
 *
jou∫Æ_öode
;

4640 
jou∫Æ_öode
 = 
	`pxt4_igë
(
sb
, 
jou∫Æ_öum
, 
PXT4_IGET_SPECIAL
);

4641 i‡(
	`IS_ERR
(
jou∫Æ_öode
)) {

4642 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "no journal found");

4643  
NULL
;

4645 i‡(!
jou∫Æ_öode
->
i_∆ök
) {

4646 
	`make_bad_öode
(
jou∫Æ_öode
);

4647 
	`ùut
(
jou∫Æ_öode
);

4648 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal inode is deleted");

4649  
NULL
;

4652 
	`jbd_debug
(2, "Journal inode foundát %p: %lld bytes\n",

4653 
jou∫Æ_öode
, jou∫Æ_öode->
i_size
);

4654 i‡(!
	`S_ISREG
(
jou∫Æ_öode
->
i_mode
)) {

4655 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "invalid journal inode");

4656 
	`ùut
(
jou∫Æ_öode
);

4657  
NULL
;

4659  
jou∫Æ_öode
;

4660 
	}
}

4662 
jou∫Æ_t
 *
	$pxt4_gë_jou∫Æ
(
su≥r_block
 *
sb
,

4663 
jou∫Æ_öum
)

4665 
öode
 *
jou∫Æ_öode
;

4666 
jou∫Æ_t
 *
jou∫Æ
;

4668 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4670 
jou∫Æ_öode
 = 
	`pxt4_gë_jou∫Æ_öode
(
sb
, 
jou∫Æ_öum
);

4671 i‡(!
jou∫Æ_öode
)

4672  
NULL
;

4674 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_öode
(
jou∫Æ_öode
);

4675 i‡(!
jou∫Æ
) {

4676 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "CouldÇotÜoad journal inode");

4677 
	`ùut
(
jou∫Æ_öode
);

4678  
NULL
;

4680 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4681 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4682  
jou∫Æ
;

4683 
	}
}

4685 
jou∫Æ_t
 *
	$pxt4_gë_dev_jou∫Æ
(
su≥r_block
 *
sb
,

4686 
dev_t
 
j_dev
)

4688 
buf„r_hód
 *
bh
;

4689 
jou∫Æ_t
 *
jou∫Æ
;

4690 
pxt4_fsblk_t
 
°¨t
;

4691 
pxt4_fsblk_t
 
Àn
;

4692 
hblock
, 
blocksize
;

4693 
pxt4_fsblk_t
 
sb_block
;

4694 
off£t
;

4695 
pxt4_su≥r_block
 *
es
;

4696 
block_devi˚
 *
bdev
;

4698 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4700 
bdev
 = 
	`pxt4_blkdev_gë
(
j_dev
, 
sb
);

4701 i‡(
bdev
 =
NULL
)

4702  
NULL
;

4704 
blocksize
 = 
sb
->
s_blocksize
;

4705 
hblock
 = 
	`bdev_logiˇl_block_size
(
bdev
);

4706 i‡(
blocksize
 < 
hblock
) {

4707 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

4709 
out_bdev
;

4712 
sb_block
 = 
PXT4_MIN_BLOCK_SIZE
 / 
blocksize
;

4713 
off£t
 = 
PXT4_MIN_BLOCK_SIZE
 % 
blocksize
;

4714 
	`£t_blocksize
(
bdev
, 
blocksize
);

4715 i‡(!(
bh
 = 
	`__bªad
(
bdev
, 
sb_block
, 
blocksize
))) {

4716 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "couldn'tÑead superblock of "

4718 
out_bdev
;

4721 
es
 = (
pxt4_su≥r_block
 *Ë(
bh
->
b_d©a
 + 
off£t
);

4722 i‡((
	`À16_to_˝u
(
es
->
s_magic
Ë!
PXT4_SUPER_MAGIC
) ||

4723 !(
	`À32_to_˝u
(
es
->
s_„©uª_öcom∑t
) &

4724 
PXT4_FEATURE_INCOMPAT_JOURNAL_DEV
)) {

4725 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4727 
	`bªl£
(
bh
);

4728 
out_bdev
;

4731 i‡((
	`À32_to_˝u
(
es
->
s_„©uª_ro_com∑t
) &

4732 
PXT4_FEATURE_RO_COMPAT_METADATA_CSUM
) &&

4733 
es
->
s_checksum
 !
	`pxt4_su≥rblock_csum
(
sb
,És)) {

4734 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "external journal has "

4736 
	`bªl£
(
bh
);

4737 
out_bdev
;

4740 i‡(
	`memcmp
(
	`PXT4_SB
(
sb
)->
s_es
->
s_jou∫Æ_uuid
, 
es
->
s_uuid
, 16)) {

4741 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "journal UUID doesÇot match");

4742 
	`bªl£
(
bh
);

4743 
out_bdev
;

4746 
Àn
 = 
	`pxt4_blocks_cou¡
(
es
);

4747 
°¨t
 = 
sb_block
 + 1;

4748 
	`bªl£
(
bh
);

4750 
jou∫Æ
 = 
	`jbd3_jou∫Æ_öô_dev
(
bdev
, 
sb
->
s_bdev
,

4751 
°¨t
, 
Àn
, 
blocksize
);

4752 i‡(!
jou∫Æ
) {

4753 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "failedÅo create device journal");

4754 
out_bdev
;

4756 
jou∫Æ
->
j_¥iv©e
 = 
sb
;

4757 
	`Œ_rw_block
(
REQ_OP_READ
, 
REQ_META
 | 
REQ_PRIO
, 1, &
jou∫Æ
->
j_sb_buf„r
);

4758 
	`waô_⁄_buf„r
(
jou∫Æ
->
j_sb_buf„r
);

4759 i‡(!
	`buf„r_u±od©e
(
jou∫Æ
->
j_sb_buf„r
)) {

4760 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror on journal device");

4761 
out_jou∫Æ
;

4763 i‡(
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
) != 1) {

4764 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "External journal has moreÅhan one "

4766 
	`be32_to_˝u
(
jou∫Æ
->
j_su≥rblock
->
s_ƒ_u£rs
));

4767 
out_jou∫Æ
;

4769 
	`PXT4_SB
(
sb
)->
jou∫Æ_bdev
 = 
bdev
;

4770 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
jou∫Æ
);

4771  
jou∫Æ
;

4773 
out_jou∫Æ
:

4774 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4775 
out_bdev
:

4776 
	`pxt4_blkdev_put
(
bdev
);

4777  
NULL
;

4778 
	}
}

4780 
	$pxt4_lﬂd_jou∫Æ
(
su≥r_block
 *
sb
,

4781 
pxt4_su≥r_block
 *
es
,

4782 
jou∫Æ_devnum
)

4784 
jou∫Æ_t
 *
jou∫Æ
;

4785 
jou∫Æ_öum
 = 
	`À32_to_˝u
(
es
->
s_jou∫Æ_öum
);

4786 
dev_t
 
jou∫Æ_dev
;

4787 
îr
 = 0;

4788 
ªÆly_ªad_⁄ly
;

4790 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4792 i‡(
jou∫Æ_devnum
 &&

4793 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4794 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "external journal device major/minor "

4796 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
jou∫Æ_devnum
);

4798 
jou∫Æ_dev
 = 
	`√w_decode_dev
(
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
));

4800 
ªÆly_ªad_⁄ly
 = 
	`bdev_ªad_⁄ly
(
sb
->
s_bdev
);

4807 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
)) {

4808 i‡(
	`sb_rd⁄ly
(
sb
)) {

4809 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "INFO:Ñecovery "

4811 i‡(
ªÆly_ªad_⁄ly
) {

4812 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "writeáccess "

4815  -
EROFS
;

4817 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "writeáccess will "

4822 i‡(
jou∫Æ_öum
 && 
jou∫Æ_dev
) {

4823 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "filesystem has both journal "

4825  -
EINVAL
;

4828 i‡(
jou∫Æ_öum
) {

4829 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_jou∫Æ
(
sb
, 
jou∫Æ_öum
)))

4830  -
EINVAL
;

4832 i‡(!(
jou∫Æ
 = 
	`pxt4_gë_dev_jou∫Æ
(
sb
, 
jou∫Æ_dev
)))

4833  -
EINVAL
;

4836 i‡(!(
jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
))

4837 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "barriers disabled");

4839 i‡(!
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
))

4840 
îr
 = 
	`jbd3_jou∫Æ_wùe
(
jou∫Æ
, !
ªÆly_ªad_⁄ly
);

4841 i‡(!
îr
) {

4842 *
ßve
 = 
	`kmÆloc
(
PXT4_S_ERR_LEN
, 
GFP_KERNEL
);

4843 i‡(
ßve
)

4844 
	`mem˝y
(
ßve
, ((*Ë
es
) +

4845 
PXT4_S_ERR_START
, 
PXT4_S_ERR_LEN
);

4846 
îr
 = 
	`jbd3_jou∫Æ_lﬂd
(
jou∫Æ
);

4847 i‡(
ßve
)

4848 
	`mem˝y
(((*Ë
es
Ë+ 
PXT4_S_ERR_START
,

4849 
ßve
, 
PXT4_S_ERR_LEN
);

4850 
	`k‰ì
(
ßve
);

4853 i‡(
îr
) {

4854 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "errorÜoading journal");

4855 
	`jbd3_jou∫Æ_de°roy
(
jou∫Æ
);

4856  
îr
;

4859 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 = 
jou∫Æ
;

4860 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

4862 i‡(!
ªÆly_ªad_⁄ly
 && 
jou∫Æ_devnum
 &&

4863 
jou∫Æ_devnum
 !
	`À32_to_˝u
(
es
->
s_jou∫Æ_dev
)) {

4864 
es
->
s_jou∫Æ_dev
 = 
	`˝u_to_À32
(
jou∫Æ_devnum
);

4867 
	`pxt4_commô_su≥r
(
sb
, 1);

4871 
	}
}

4873 
	$pxt4_commô_su≥r
(
su≥r_block
 *
sb
, 
sync
)

4875 
pxt4_su≥r_block
 *
es
 = 
	`PXT4_SB
(
sb
)->
s_es
;

4876 
buf„r_hód
 *
sbh
 = 
	`PXT4_SB
(
sb
)->
s_sbh
;

4877 
îr‹
 = 0;

4879 i‡(!
sbh
 || 
	`block_devi˚_eje˘ed
(
sb
))

4880  
îr‹
;

4886 i‡(!
	`buf„r_m≠≥d
(
sbh
))

4887  
îr‹
;

4899 i‡(!(
sb
->
s_Êags
 & 
SB_RDONLY
))

4900 
	`pxt4_upd©e_t°amp
(
es
, 
s_wtime
);

4901 i‡(
sb
->
s_bdev
->
bd_∑π
)

4902 
es
->
s_kbyãs_wrôãn
 =

4903 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
 +

4904 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

4905 
£˘‹s
[
STAT_WRITE
]) -

4906 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1));

4908 
es
->
s_kbyãs_wrôãn
 =

4909 
	`˝u_to_À64
(
	`PXT4_SB
(
sb
)->
s_kbyãs_wrôãn
);

4910 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
))

4911 
	`pxt4_‰ì_blocks_cou¡_£t
(
es
,

4912 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 
	`≥r˝u_cou¡î_sum_posôive
(

4913 &
	`PXT4_SB
(
sb
)->
s_‰ì˛u°îs_cou¡î
)));

4914 i‡(
	`≥r˝u_cou¡î_öôülized
(&
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
))

4915 
es
->
s_‰ì_öodes_cou¡
 =

4916 
	`˝u_to_À32
(
	`≥r˝u_cou¡î_sum_posôive
(

4917 &
	`PXT4_SB
(
sb
)->
s_‰ìöodes_cou¡î
));

4918 
	`BUFFER_TRACE
(
sbh
, "marking dirty");

4919 
	`pxt4_su≥rblock_csum_£t
(
sb
);

4920 i‡(
sync
)

4921 
	`lock_buf„r
(
sbh
);

4922 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
Ë|| !
	`buf„r_u±od©e
(sbh)) {

4931 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "previous I/OÉrrorÅo "

4933 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

4934 
	`£t_buf„r_u±od©e
(
sbh
);

4936 
	`m¨k_buf„r_dúty
(
sbh
);

4937 i‡(
sync
) {

4938 
	`u∆ock_buf„r
(
sbh
);

4939 
îr‹
 = 
	`__sync_dúty_buf„r
(
sbh
,

4940 
REQ_SYNC
 | (
	`ã°_›t
(
sb
, 
BARRIER
Ë? 
REQ_FUA
 : 0));

4941 i‡(
	`buf„r_wrôe_io_îr‹
(
sbh
)) {

4942 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "I/OÉrror while writing "

4944 
	`˛ór_buf„r_wrôe_io_îr‹
(
sbh
);

4945 
	`£t_buf„r_u±od©e
(
sbh
);

4948  
îr‹
;

4949 
	}
}

4956 
	$pxt4_m¨k_ªcovîy_com∂ëe
(
su≥r_block
 *
sb
,

4957 
pxt4_su≥r_block
 *
es
)

4959 
jou∫Æ_t
 *
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4961 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
)) {

4962 
	`BUG_ON
(
jou∫Æ
 !
NULL
);

4965 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

4966 i‡(
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
) < 0)

4967 
out
;

4969 i‡(
	`pxt4_has_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
Ë&& 
	`sb_rd⁄ly
(sb)) {

4970 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

4971 
	`pxt4_commô_su≥r
(
sb
, 1);

4974 
out
:

4975 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

4976 
	}
}

4983 
	$pxt4_˛ór_jou∫Æ_îr
(
su≥r_block
 *
sb
,

4984 
pxt4_su≥r_block
 *
es
)

4986 
jou∫Æ_t
 *
jou∫Æ
;

4987 
j_î∫o
;

4988 c⁄° *
îr°r
;

4990 
	`BUG_ON
(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
));

4992 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

4999 
j_î∫o
 = 
	`jbd3_jou∫Æ_î∫o
(
jou∫Æ
);

5000 i‡(
j_î∫o
) {

5001 
nbuf
[16];

5003 
îr°r
 = 
	`pxt4_decode_îr‹
(
sb
, 
j_î∫o
, 
nbuf
);

5004 
	`pxt4_w¨nög
(
sb
, "FilesystemÉrrorÑecorded "

5005 "‰omÖªviou†mou¡: %s", 
îr°r
);

5006 
	`pxt4_w¨nög
(
sb
, "Marking fs inÇeed of filesystem check.");

5008 
	`PXT4_SB
(
sb
)->
s_mou¡_°©e
 |
PXT4_ERROR_FS
;

5009 
es
->
s_°©e
 |
	`˝u_to_À16
(
PXT4_ERROR_FS
);

5010 
	`pxt4_commô_su≥r
(
sb
, 1);

5012 
	`jbd3_jou∫Æ_˛ór_îr
(
jou∫Æ
);

5013 
	`jbd3_jou∫Æ_upd©e_sb_î∫o
(
jou∫Æ
);

5015 
	}
}

5021 
	$pxt4_f‹˚_commô
(
su≥r_block
 *
sb
)

5023 
jou∫Æ_t
 *
jou∫Æ
;

5025 i‡(
	`sb_rd⁄ly
(
sb
))

5028 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5029  
	`pxt4_jou∫Æ_f‹˚_commô
(
jou∫Æ
);

5030 
	}
}

5032 
	$pxt4_sync_fs
(
su≥r_block
 *
sb
, 
waô
)

5034 
ªt
 = 0;

5035 
tid_t
 
èrgë
;

5036 
boﬁ
 
√eds_b¨rõr
 = 
Ál£
;

5037 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5039 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
sbi
)))

5042 
	`åa˚_pxt4_sync_fs
(
sb
, 
waô
);

5043 
	`Êush_w‹kqueue
(
sbi
->
rsv_c⁄vîsi⁄_wq
);

5048 
	`dquŸ_wrôeback_dquŸs
(
sb
, -1);

5054 i‡(
sbi
->
s_jou∫Æ
) {

5055 
èrgë
 = 
	`jbd3_gë_œã°_å™ß˘i⁄
(
sbi
->
s_jou∫Æ
);

5056 i‡(
waô
 && 
sbi
->
s_jou∫Æ
->
j_Êags
 & 
JBD3_BARRIER
 &&

5057 !
	`jbd3_å™s_wûl_£nd_d©a_b¨rõr
(
sbi
->
s_jou∫Æ
, 
èrgë
))

5058 
√eds_b¨rõr
 = 
åue
;

5060 i‡(
	`jbd3_jou∫Æ_°¨t_commô
(
sbi
->
s_jou∫Æ
, &
èrgë
)) {

5061 i‡(
waô
)

5062 
ªt
 = 
	`jbd3_log_waô_commô
(
sbi
->
s_jou∫Æ
,

5063 
èrgë
);

5065 } i‡(
waô
 && 
	`ã°_›t
(
sb
, 
BARRIER
))

5066 
√eds_b¨rõr
 = 
åue
;

5067 i‡(
√eds_b¨rõr
) {

5068 
îr
;

5069 
îr
 = 
	`blkdev_issue_Êush
(
sb
->
s_bdev
, 
GFP_KERNEL
, 
NULL
);

5070 i‡(!
ªt
)

5071 
ªt
 = 
îr
;

5074  
ªt
;

5075 
	}
}

5085 
	$pxt4_‰ìze
(
su≥r_block
 *
sb
)

5087 
îr‹
 = 0;

5088 
jou∫Æ_t
 *
jou∫Æ
;

5090 i‡(
	`sb_rd⁄ly
(
sb
))

5093 
jou∫Æ
 = 
	`PXT4_SB
(
sb
)->
s_jou∫Æ
;

5095 i‡(
jou∫Æ
) {

5097 
	`jbd3_jou∫Æ_lock_upd©es
(
jou∫Æ
);

5103 
îr‹
 = 
	`jbd3_jou∫Æ_Êush
(
jou∫Æ
);

5104 i‡(
îr‹
 < 0)

5105 
out
;

5108 
	`pxt4_˛ór_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5111 
îr‹
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5112 
out
:

5113 i‡(
jou∫Æ
)

5115 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
jou∫Æ
);

5116  
îr‹
;

5117 
	}
}

5123 
	$pxt4_un‰ìze
(
su≥r_block
 *
sb
)

5125 i‡(
	`sb_rd⁄ly
(
sb
Ë|| 
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(sb)))

5128 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
) {

5130 
	`pxt4_£t_„©uª_jou∫Æ_√eds_ªcovîy
(
sb
);

5133 
	`pxt4_commô_su≥r
(
sb
, 1);

5135 
	}
}

5140 
	spxt4_mou¡_›ti⁄s
 {

5141 
	ms_mou¡_›t
;

5142 
	ms_mou¡_›t2
;

5143 
kuid_t
 
	ms_ªsuid
;

5144 
kgid_t
 
	ms_ªsgid
;

5145 
	ms_commô_öãrvÆ
;

5146 
u32
 
	ms_mö_b©ch_time
, 
	ms_max_b©ch_time
;

5147 #ifde‡
CONFIG_QUOTA


5148 
	ms_jquŸa_fmt
;

5149 *
	ms_qf_«mes
[
PXT4_MAXQUOTAS
];

5153 
	$pxt4_ªmou¡
(
su≥r_block
 *
sb
, *
Êags
, *
d©a
)

5155 
pxt4_su≥r_block
 *
es
;

5156 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5157 
ﬁd_sb_Êags
;

5158 
pxt4_mou¡_›ti⁄s
 
ﬁd_›ts
;

5159 
íabÀ_quŸa
 = 0;

5160 
pxt4_group_t
 
g
;

5161 
jou∫Æ_i›rio
 = 
DEFAULT_JOURNAL_IOPRIO
;

5162 
îr
 = 0;

5163 #ifde‡
CONFIG_QUOTA


5164 
i
, 
j
;

5165 *
to_‰ì
[
PXT4_MAXQUOTAS
];

5167 *
‹ig_d©a
 = 
	`k°rdup
(
d©a
, 
GFP_KERNEL
);

5169 i‡(
d©a
 && !
‹ig_d©a
)

5170  -
ENOMEM
;

5173 
ﬁd_sb_Êags
 = 
sb
->
s_Êags
;

5174 
ﬁd_›ts
.
s_mou¡_›t
 = 
sbi
->s_mount_opt;

5175 
ﬁd_›ts
.
s_mou¡_›t2
 = 
sbi
->s_mount_opt2;

5176 
ﬁd_›ts
.
s_ªsuid
 = 
sbi
->s_resuid;

5177 
ﬁd_›ts
.
s_ªsgid
 = 
sbi
->s_resgid;

5178 
ﬁd_›ts
.
s_commô_öãrvÆ
 = 
sbi
->s_commit_interval;

5179 
ﬁd_›ts
.
s_mö_b©ch_time
 = 
sbi
->s_min_batch_time;

5180 
ﬁd_›ts
.
s_max_b©ch_time
 = 
sbi
->s_max_batch_time;

5181 #ifde‡
CONFIG_QUOTA


5182 
ﬁd_›ts
.
s_jquŸa_fmt
 = 
sbi
->s_jquota_fmt;

5183 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5184 i‡(
sbi
->
s_qf_«mes
[
i
]) {

5185 *
qf_«me
 = 
	`gë_qf_«me
(
sb
, 
sbi
, 
i
);

5187 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
	`k°rdup
(
qf_«me
, 
GFP_KERNEL
);

5188 i‡(!
ﬁd_›ts
.
s_qf_«mes
[
i
]) {

5189 
j
 = 0; j < 
i
; j++)

5190 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
j
]);

5191 
	`k‰ì
(
‹ig_d©a
);

5192  -
ENOMEM
;

5195 
ﬁd_›ts
.
s_qf_«mes
[
i
] = 
NULL
;

5197 i‡(
sbi
->
s_jou∫Æ
 && sbi->s_jou∫Æ->
j_èsk
->
io_c⁄ãxt
)

5198 
jou∫Æ_i›rio
 = 
sbi
->
s_jou∫Æ
->
j_èsk
->
io_c⁄ãxt
->
i›rio
;

5200 i‡(!
	`∑r£_›ti⁄s
(
d©a
, 
sb
, 
NULL
, &
jou∫Æ_i›rio
, 1)) {

5201 
îr
 = -
EINVAL
;

5202 
ª°‹e_›ts
;

5205 
	`pxt4_˛amp_w™t_exåa_isize
(
sb
);

5207 i‡((
ﬁd_›ts
.
s_mou¡_›t
 & 
PXT4_MOUNT_JOURNAL_CHECKSUM
) ^

5208 
	`ã°_›t
(
sb
, 
JOURNAL_CHECKSUM
)) {

5209 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "changing journal_checksum "

5211 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_JOURNAL_CHECKSUM
;

5214 i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_JOURNAL_DATA
) {

5215 i‡(
	`ã°_›t2
(
sb
, 
EXPLICIT_DELALLOC
)) {

5216 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5218 
îr
 = -
EINVAL
;

5219 
ª°‹e_›ts
;

5221 i‡(
	`ã°_›t
(
sb
, 
DIOREAD_NOLOCK
)) {

5222 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5224 
îr
 = -
EINVAL
;

5225 
ª°‹e_›ts
;

5227 i‡(
	`ã°_›t
(
sb
, 
DAX
)) {

5228 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5230 
îr
 = -
EINVAL
;

5231 
ª°‹e_›ts
;

5233 } i‡(
	`ã°_›t
(
sb
, 
DATA_FLAGS
Ë=
PXT4_MOUNT_ORDERED_DATA
) {

5234 i‡(
	`ã°_›t
(
sb
, 
JOURNAL_ASYNC_COMMIT
)) {

5235 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can't mount with "

5237 
îr
 = -
EINVAL
;

5238 
ª°‹e_›ts
;

5242 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_NO_MBCACHE
) {

5243 
	`pxt4_msg
(
sb
, 
KERN_ERR
, "can'tÉnableÇombcache duringÑemount");

5244 
îr
 = -
EINVAL
;

5245 
ª°‹e_›ts
;

5248 i‡((
sbi
->
s_mou¡_›t
 ^ 
ﬁd_›ts
.s_mou¡_›tË& 
PXT4_MOUNT_DAX
) {

5249 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "warning:Ñefusing change of "

5251 
sbi
->
s_mou¡_›t
 ^
PXT4_MOUNT_DAX
;

5254 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
)

5255 
	`pxt4_ab‹t
(
sb
, "Abort forced by user");

5257 
sb
->
s_Êags
 = (sb->s_Êag†& ~
SB_POSIXACL
) |

5258 (
	`ã°_›t
(
sb
, 
POSIX_ACL
Ë? 
SB_POSIXACL
 : 0);

5260 
es
 = 
sbi
->
s_es
;

5262 i‡(
sbi
->
s_jou∫Æ
) {

5263 
	`pxt4_öô_jou∫Æ_∑øms
(
sb
, 
sbi
->
s_jou∫Æ
);

5264 
	`£t_èsk_i›rio
(
sbi
->
s_jou∫Æ
->
j_èsk
, 
jou∫Æ_i›rio
);

5267 i‡(*
Êags
 & 
SB_LAZYTIME
)

5268 
sb
->
s_Êags
 |
SB_LAZYTIME
;

5270 i‡((
boﬁ
)(*
Êags
 & 
SB_RDONLY
Ë!
	`sb_rd⁄ly
(
sb
)) {

5271 i‡(
sbi
->
s_mou¡_Êags
 & 
PXT4_MF_FS_ABORTED
) {

5272 
îr
 = -
EROFS
;

5273 
ª°‹e_›ts
;

5276 i‡(*
Êags
 & 
SB_RDONLY
) {

5277 
îr
 = 
	`sync_fûesy°em
(
sb
);

5278 i‡(
îr
 < 0)

5279 
ª°‹e_›ts
;

5280 
îr
 = 
	`dquŸ_su•íd
(
sb
, -1);

5281 i‡(
îr
 < 0)

5282 
ª°‹e_›ts
;

5288 
sb
->
s_Êags
 |
SB_RDONLY
;

5295 i‡(!(
es
->
s_°©e
 & 
	`˝u_to_À16
(
PXT4_VALID_FS
)) &&

5296 (
sbi
->
s_mou¡_°©e
 & 
PXT4_VALID_FS
))

5297 
es
->
s_°©e
 = 
	`˝u_to_À16
(
sbi
->
s_mou¡_°©e
);

5299 i‡(
sbi
->
s_jou∫Æ
)

5300 
	`pxt4_m¨k_ªcovîy_com∂ëe
(
sb
, 
es
);

5301 i‡(
sbi
->
s_mmp_tsk
)

5302 
	`kthªad_°›
(
sbi
->
s_mmp_tsk
);

5305 i‡(
	`pxt4_has_„©uª_ªad⁄ly
(
sb
) ||

5306 !
	`pxt4_„©uª_£t_ok
(
sb
, 0)) {

5307 
îr
 = -
EROFS
;

5308 
ª°‹e_›ts
;

5314 
g
 = 0; g < 
sbi
->
s_groups_cou¡
; g++) {

5315 
pxt4_group_desc
 *
gdp
 =

5316 
	`pxt4_gë_group_desc
(
sb
, 
g
, 
NULL
);

5318 i‡(!
	`pxt4_group_desc_csum_vîify
(
sb
, 
g
, 
gdp
)) {

5319 
	`pxt4_msg
(
sb
, 
KERN_ERR
,

5321 
g
, 
	`À16_to_˝u
(
	`pxt4_group_desc_csum
(
sb
, g, 
gdp
)),

5322 
	`À16_to_˝u
(
gdp
->
bg_checksum
));

5323 
îr
 = -
EFSBADCRC
;

5324 
ª°‹e_›ts
;

5333 i‡(
es
->
s_œ°_‹ph™
) {

5334 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Couldn't "

5338 
îr
 = -
EINVAL
;

5339 
ª°‹e_›ts
;

5348 i‡(
sbi
->
s_jou∫Æ
)

5349 
	`pxt4_˛ór_jou∫Æ_îr
(
sb
, 
es
);

5350 
sbi
->
s_mou¡_°©e
 = 
	`À16_to_˝u
(
es
->
s_°©e
);

5352 
îr
 = 
	`pxt4_£tup_su≥r
(
sb
, 
es
, 0);

5353 i‡(
îr
)

5354 
ª°‹e_›ts
;

5356 
sb
->
s_Êags
 &~
SB_RDONLY
;

5357 i‡(
	`pxt4_has_„©uª_mmp
(
sb
))

5358 i‡(
	`pxt4_mu…i_mou¡_¥Ÿe˘
(
sb
,

5359 
	`À64_to_˝u
(
es
->
s_mmp_block
))) {

5360 
îr
 = -
EROFS
;

5361 
ª°‹e_›ts
;

5363 
íabÀ_quŸa
 = 1;

5371 i‡(
	`sb_rd⁄ly
(
sb
Ë|| !
	`ã°_›t
(sb, 
INIT_INODE_TABLE
))

5372 
	`pxt4_uƒegi°î_li_ªque°
(
sb
);

5374 
pxt4_group_t
 
fú°_nŸ_zî€d
;

5375 
fú°_nŸ_zî€d
 = 
	`pxt4_has_unöô_ôabÀ
(
sb
);

5376 
	`pxt4_ªgi°î_li_ªque°
(
sb
, 
fú°_nŸ_zî€d
);

5379 
	`pxt4_£tup_sy°em_z⁄e
(
sb
);

5380 i‡(
sbi
->
s_jou∫Æ
 =
NULL
 && !(
ﬁd_sb_Êags
 & 
SB_RDONLY
)) {

5381 
îr
 = 
	`pxt4_commô_su≥r
(
sb
, 1);

5382 i‡(
îr
)

5383 
ª°‹e_›ts
;

5386 #ifde‡
CONFIG_QUOTA


5388 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5389 
	`k‰ì
(
ﬁd_›ts
.
s_qf_«mes
[
i
]);

5390 i‡(
íabÀ_quŸa
) {

5391 i‡(
	`sb_™y_quŸa_su•íded
(
sb
))

5392 
	`dquŸ_ªsume
(
sb
, -1);

5393 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
)) {

5394 
îr
 = 
	`pxt4_íabÀ_quŸas
(
sb
);

5395 i‡(
îr
)

5396 
ª°‹e_›ts
;

5401 *
Êags
 = (*Êag†& ~
SB_LAZYTIME
Ë| (
sb
->
s_Êags
 & SB_LAZYTIME);

5402 
	`pxt4_msg
(
sb
, 
KERN_INFO
, "ª-mou¡ed. O±s: %s", 
‹ig_d©a
);

5403 
	`k‰ì
(
‹ig_d©a
);

5406 
ª°‹e_›ts
:

5407 
sb
->
s_Êags
 = 
ﬁd_sb_Êags
;

5408 
sbi
->
s_mou¡_›t
 = 
ﬁd_›ts
.s_mount_opt;

5409 
sbi
->
s_mou¡_›t2
 = 
ﬁd_›ts
.s_mount_opt2;

5410 
sbi
->
s_ªsuid
 = 
ﬁd_›ts
.s_resuid;

5411 
sbi
->
s_ªsgid
 = 
ﬁd_›ts
.s_resgid;

5412 
sbi
->
s_commô_öãrvÆ
 = 
ﬁd_›ts
.s_commit_interval;

5413 
sbi
->
s_mö_b©ch_time
 = 
ﬁd_›ts
.s_min_batch_time;

5414 
sbi
->
s_max_b©ch_time
 = 
ﬁd_›ts
.s_max_batch_time;

5415 #ifde‡
CONFIG_QUOTA


5416 
sbi
->
s_jquŸa_fmt
 = 
ﬁd_›ts
.s_jquota_fmt;

5417 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++) {

5418 
to_‰ì
[
i
] = 
	`gë_qf_«me
(
sb
, 
sbi
, i);

5419 
	`rcu_assign_poöãr
(
sbi
->
s_qf_«mes
[
i
], 
ﬁd_›ts
.s_qf_names[i]);

5421 
	`synchr⁄ize_rcu
();

5422 
i
 = 0; i < 
PXT4_MAXQUOTAS
; i++)

5423 
	`k‰ì
(
to_‰ì
[
i
]);

5425 
	`k‰ì
(
‹ig_d©a
);

5426  
îr
;

5427 
	}
}

5429 #ifde‡
CONFIG_QUOTA


5430 
	$pxt4_°©fs_¥oje˘
(
su≥r_block
 *
sb
,

5431 
k¥ojid_t
 
¥ojid
, 
k°©fs
 *
buf
)

5433 
kqid
 
qid
;

5434 
dquŸ
 *dquot;

5435 
u64
 
limô
;

5436 
u64
 
curblock
;

5438 
qid
 = 
	`make_kqid_¥ojid
(
¥ojid
);

5439 
dquŸ
 = 
	`dqgë
(
sb
, 
qid
);

5440 i‡(
	`IS_ERR
(
dquŸ
))

5441  
	`PTR_ERR
(
dquŸ
);

5442 
	`•ö_lock
(&
dquŸ
->
dq_dqb_lock
);

5444 
limô
 = (
dquŸ
->
dq_dqb
.
dqb_bso·limô
 ?

5445 
dquŸ
->
dq_dqb
.
dqb_bso·limô
 :

5446 
dquŸ
->
dq_dqb
.
dqb_bh¨dlimô
Ë>> 
sb
->
s_blocksize_bôs
;

5447 i‡(
limô
 && 
buf
->
f_blocks
 >Üimit) {

5448 
curblock
 = (
dquŸ
->
dq_dqb
.
dqb_cur•a˚
 +

5449 
dquŸ
->
dq_dqb
.
dqb_rsv•a˚
Ë>> 
sb
->
s_blocksize_bôs
;

5450 
buf
->
f_blocks
 = 
limô
;

5451 
buf
->
f_b‰ì
 = buf->
f_bavaû
 =

5452 (
buf
->
f_blocks
 > 
curblock
) ?

5453 (
buf
->
f_blocks
 - 
curblock
) : 0;

5456 
limô
 = 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 ?

5457 
dquŸ
->
dq_dqb
.
dqb_iso·limô
 :

5458 
dquŸ
->
dq_dqb
.
dqb_ih¨dlimô
;

5459 i‡(
limô
 && 
buf
->
f_fûes
 >Üimit) {

5460 
buf
->
f_fûes
 = 
limô
;

5461 
buf
->
f_f‰ì
 =

5462 (
buf
->
f_fûes
 > 
dquŸ
->
dq_dqb
.
dqb_curöodes
) ?

5463 (
buf
->
f_fûes
 - 
dquŸ
->
dq_dqb
.
dqb_curöodes
) : 0;

5466 
	`•ö_u∆ock
(&
dquŸ
->
dq_dqb_lock
);

5467 
	`dqput
(
dquŸ
);

5469 
	}
}

5472 
	$pxt4_°©fs
(
díåy
 *díåy, 
k°©fs
 *
buf
)

5474 
su≥r_block
 *
sb
 = 
díåy
->
d_sb
;

5475 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5476 
pxt4_su≥r_block
 *
es
 = 
sbi
->
s_es
;

5477 
pxt4_fsblk_t
 
ovîhód
 = 0, 
ªsv_blocks
;

5478 
u64
 
fsid
;

5479 
s64
 
b‰ì
;

5480 
ªsv_blocks
 = 
	`PXT4_C2B
(
sbi
, 
	`©omic64_ªad
(&sbi->
s_ªsv_˛u°îs
));

5482 i‡(!
	`ã°_›t
(
sb
, 
MINIX_DF
))

5483 
ovîhód
 = 
sbi
->
s_ovîhód
;

5485 
buf
->
f_ty≥
 = 
PXT4_SUPER_MAGIC
;

5486 
buf
->
f_bsize
 = 
sb
->
s_blocksize
;

5487 
buf
->
f_blocks
 = 
	`pxt4_blocks_cou¡
(
es
Ë- 
	`PXT4_C2B
(
sbi
, 
ovîhód
);

5488 
b‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ì˛u°îs_cou¡î
) -

5489 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_dúty˛u°îs_cou¡î
);

5491 
buf
->
f_b‰ì
 = 
	`PXT4_C2B
(
sbi
, 
	`max_t
(
s64
, 
b‰ì
, 0));

5492 
buf
->
f_bavaû
 = buf->
f_b‰ì
 -

5493 (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
);

5494 i‡(
buf
->
f_b‰ì
 < (
	`pxt4_r_blocks_cou¡
(
es
Ë+ 
ªsv_blocks
))

5495 
buf
->
f_bavaû
 = 0;

5496 
buf
->
f_fûes
 = 
	`À32_to_˝u
(
es
->
s_öodes_cou¡
);

5497 
buf
->
f_f‰ì
 = 
	`≥r˝u_cou¡î_sum_posôive
(&
sbi
->
s_‰ìöodes_cou¡î
);

5498 
buf
->
f_«mñí
 = 
PXT4_NAME_LEN
;

5499 
fsid
 = 
	`À64_to_˝up
((*)
es
->
s_uuid
) ^

5500 
	`À64_to_˝up
((*)
es
->
s_uuid
 + (
u64
));

5501 
buf
->
f_fsid
.
vÆ
[0] = 
fsid
 & 0xFFFFFFFFUL;

5502 
buf
->
f_fsid
.
vÆ
[1] = (
fsid
 >> 32) & 0xFFFFFFFFUL;

5504 #ifde‡
CONFIG_QUOTA


5505 i‡(
	`pxt4_ã°_öode_Êag
(
díåy
->
d_öode
, 
PXT4_INODE_PROJINHERIT
) &&

5506 
	`sb_has_quŸa_limôs_íabÀd
(
sb
, 
PRJQUOTA
))

5507 
	`pxt4_°©fs_¥oje˘
(
sb
, 
	`PXT4_I
(
díåy
->
d_öode
)->
i_¥ojid
, 
buf
);

5510 
	}
}

5513 #ifde‡
CONFIG_QUOTA


5519 
ölöe
 
öode
 *
	$dquŸ_to_öode
(
dquŸ
 *dquot)

5521  
	`sb_dq›t
(
dquŸ
->
dq_sb
)->
fûes
[dquŸ->
dq_id
.
ty≥
];

5522 
	}
}

5524 
	$pxt4_wrôe_dquŸ
(
dquŸ
 *dquot)

5526 
ªt
, 
îr
;

5527 
h™dÀ_t
 *
h™dÀ
;

5528 
öode
 *inode;

5530 
öode
 = 
	`dquŸ_to_öode
(
dquŸ
);

5531 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
,

5532 
	`PXT4_QUOTA_TRANS_BLOCKS
(
dquŸ
->
dq_sb
));

5533 i‡(
	`IS_ERR
(
h™dÀ
))

5534  
	`PTR_ERR
(
h™dÀ
);

5535 
ªt
 = 
	`dquŸ_commô
(
dquŸ
);

5536 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5537 i‡(!
ªt
)

5538 
ªt
 = 
îr
;

5539  
ªt
;

5540 
	}
}

5542 
	$pxt4_acquúe_dquŸ
(
dquŸ
 *dquot)

5544 
ªt
, 
îr
;

5545 
h™dÀ_t
 *
h™dÀ
;

5547 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5548 
	`PXT4_QUOTA_INIT_BLOCKS
(
dquŸ
->
dq_sb
));

5549 i‡(
	`IS_ERR
(
h™dÀ
))

5550  
	`PTR_ERR
(
h™dÀ
);

5551 
ªt
 = 
	`dquŸ_acquúe
(
dquŸ
);

5552 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5553 i‡(!
ªt
)

5554 
ªt
 = 
îr
;

5555  
ªt
;

5556 
	}
}

5558 
	$pxt4_ªÀa£_dquŸ
(
dquŸ
 *dquot)

5560 
ªt
, 
îr
;

5561 
h™dÀ_t
 *
h™dÀ
;

5563 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`dquŸ_to_öode
(
dquŸ
), 
PXT4_HT_QUOTA
,

5564 
	`PXT4_QUOTA_DEL_BLOCKS
(
dquŸ
->
dq_sb
));

5565 i‡(
	`IS_ERR
(
h™dÀ
)) {

5567 
	`dquŸ_ªÀa£
(
dquŸ
);

5568  
	`PTR_ERR
(
h™dÀ
);

5570 
ªt
 = 
	`dquŸ_ªÀa£
(
dquŸ
);

5571 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5572 i‡(!
ªt
)

5573 
ªt
 = 
îr
;

5574  
ªt
;

5575 
	}
}

5577 
	$pxt4_m¨k_dquŸ_dúty
(
dquŸ
 *dquot)

5579 
su≥r_block
 *
sb
 = 
dquŸ
->
dq_sb
;

5580 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

5583 i‡(
	`pxt4_has_„©uª_quŸa
(
sb
) ||

5584 
sbi
->
s_qf_«mes
[
USRQUOTA
] || sbi->s_qf_«mes[
GRPQUOTA
]) {

5585 
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5586  
	`pxt4_wrôe_dquŸ
(
dquŸ
);

5588  
	`dquŸ_m¨k_dquŸ_dúty
(
dquŸ
);

5590 
	}
}

5592 
	$pxt4_wrôe_öfo
(
su≥r_block
 *
sb
, 
ty≥
)

5594 
ªt
, 
îr
;

5595 
h™dÀ_t
 *
h™dÀ
;

5598 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
	`d_öode
(
sb
->
s_roŸ
), 
PXT4_HT_QUOTA
, 2);

5599 i‡(
	`IS_ERR
(
h™dÀ
))

5600  
	`PTR_ERR
(
h™dÀ
);

5601 
ªt
 = 
	`dquŸ_commô_öfo
(
sb
, 
ty≥
);

5602 
îr
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5603 i‡(!
ªt
)

5604 
ªt
 = 
îr
;

5605  
ªt
;

5606 
	}
}

5612 
	$pxt4_quŸa_⁄_mou¡
(
su≥r_block
 *
sb
, 
ty≥
)

5614  
	`dquŸ_quŸa_⁄_mou¡
(
sb
, 
	`gë_qf_«me
(sb, 
	`PXT4_SB
(sb), 
ty≥
),

5615 
	`PXT4_SB
(
sb
)->
s_jquŸa_fmt
, 
ty≥
);

5616 
	}
}

5618 
	$lockdï_£t_quŸa_öode
(
öode
 *öode, 
sub˛ass
)

5620 
pxt4_öode_öfo
 *
ei
 = 
	`PXT4_I
(
öode
);

5628 (Ë
ei
;

5629 
	`lockdï_£t_sub˛ass
(&
ei
->
i_d©a_£m
, 
sub˛ass
);

5630 
	}
}

5635 
	$pxt4_quŸa_⁄
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5636 c⁄° 
∑th
 *path)

5638 
îr
;

5640 i‡(!
	`ã°_›t
(
sb
, 
QUOTA
))

5641  -
EINVAL
;

5644 i‡(
∑th
->
díåy
->
d_sb
 !
sb
)

5645  -
EXDEV
;

5647 i‡(
	`PXT4_SB
(
sb
)->
s_qf_«mes
[
ty≥
]) {

5649 i‡(
∑th
->
díåy
->
d_∑ª¡
 !
sb
->
s_roŸ
)

5650 
	`pxt4_msg
(
sb
, 
KERN_WARNING
,

5653 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_NOLIST_DIRTY
;

5659 
	`sb_dq›t
(
sb
)->
Êags
 &~
DQUOT_NOLIST_DIRTY
;

5666 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 &&

5667 
	`pxt4_should_jou∫Æ_d©a
(
	`d_öode
(
∑th
->
díåy
))) {

5672 
	`jbd3_jou∫Æ_lock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5673 
îr
 = 
	`jbd3_jou∫Æ_Êush
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5674 
	`jbd3_jou∫Æ_u∆ock_upd©es
(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
);

5675 i‡(
îr
)

5676  
îr
;

5679 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
, 
I_DATA_SEM_QUOTA
);

5680 
îr
 = 
	`dquŸ_quŸa_⁄
(
sb
, 
ty≥
, 
f‹m©_id
, 
∑th
);

5681 i‡(
îr
) {

5682 
	`lockdï_£t_quŸa_öode
(
∑th
->
díåy
->
d_öode
,

5683 
I_DATA_SEM_NORMAL
);

5685 
öode
 *öodê
	`d_öode
(
∑th
->
díåy
);

5686 
h™dÀ_t
 *
h™dÀ
;

5693 
	`öode_lock
(
öode
);

5694 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5695 i‡(
	`IS_ERR
(
h™dÀ
))

5696 
u∆ock_öode
;

5697 
	`PXT4_I
(
öode
)->
i_Êags
 |
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
;

5698 
	`öode_£t_Êags
(
öode
, 
S_NOATIME
 | 
S_IMMUTABLE
,

5699 
S_NOATIME
 | 
S_IMMUTABLE
);

5700 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5701 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5702 
u∆ock_öode
:

5703 
	`öode_u∆ock
(
öode
);

5705  
îr
;

5706 
	}
}

5708 
	$pxt4_quŸa_íabÀ
(
su≥r_block
 *
sb
, 
ty≥
, 
f‹m©_id
,

5709 
Êags
)

5711 
îr
;

5712 
öode
 *
qf_öode
;

5713 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5714 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5715 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5716 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5719 
	`BUG_ON
(!
	`pxt4_has_„©uª_quŸa
(
sb
));

5721 i‡(!
qf_öums
[
ty≥
])

5722  -
EPERM
;

5724 
qf_öode
 = 
	`pxt4_igë
(
sb
, 
qf_öums
[
ty≥
], 
PXT4_IGET_SPECIAL
);

5725 i‡(
	`IS_ERR
(
qf_öode
)) {

5726 
	`pxt4_îr‹
(
sb
, "Bad quŸ®öodê# %lu", 
qf_öums
[
ty≥
]);

5727  
	`PTR_ERR
(
qf_öode
);

5731 
qf_öode
->
i_Êags
 |
S_NOQUOTA
;

5732 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_QUOTA
);

5733 
îr
 = 
	`dquŸ_íabÀ
(
qf_öode
, 
ty≥
, 
f‹m©_id
, 
Êags
);

5734 i‡(
îr
)

5735 
	`lockdï_£t_quŸa_öode
(
qf_öode
, 
I_DATA_SEM_NORMAL
);

5736 
	`ùut
(
qf_öode
);

5738  
îr
;

5739 
	}
}

5742 
	$pxt4_íabÀ_quŸas
(
su≥r_block
 *
sb
)

5744 
ty≥
, 
îr
 = 0;

5745 
qf_öums
[
PXT4_MAXQUOTAS
] = {

5746 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_u§_quŸa_öum
),

5747 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_gΩ_quŸa_öum
),

5748 
	`À32_to_˝u
(
	`PXT4_SB
(
sb
)->
s_es
->
s_¥j_quŸa_öum
)

5750 
boﬁ
 
quŸa_m›t
[
PXT4_MAXQUOTAS
] = {

5751 
	`ã°_›t
(
sb
, 
USRQUOTA
),

5752 
	`ã°_›t
(
sb
, 
GRPQUOTA
),

5753 
	`ã°_›t
(
sb
, 
PRJQUOTA
),

5756 
	`sb_dq›t
(
sb
)->
Êags
 |
DQUOT_QUOTA_SYS_FILE
 | 
DQUOT_NOLIST_DIRTY
;

5757 
ty≥
 = 0;Åy≥ < 
PXT4_MAXQUOTAS
;Åype++) {

5758 i‡(
qf_öums
[
ty≥
]) {

5759 
îr
 = 
	`pxt4_quŸa_íabÀ
(
sb
, 
ty≥
, 
QFMT_VFS_V1
,

5760 
DQUOT_USAGE_ENABLED
 |

5761 (
quŸa_m›t
[
ty≥
] ? 
DQUOT_LIMITS_ENABLED
 : 0));

5762 i‡(
îr
) {

5763 
	`pxt4_w¨nög
(
sb
,

5766 "e2fsckÅÿfix.", 
ty≥
, 
îr
);

5767 
ty≥
--;Åype >= 0;Åype--)

5768 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5770  
îr
;

5775 
	}
}

5777 
	$pxt4_quŸa_off
(
su≥r_block
 *
sb
, 
ty≥
)

5779 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5780 
h™dÀ_t
 *
h™dÀ
;

5781 
îr
;

5785 i‡(
	`ã°_›t
(
sb
, 
DELALLOC
))

5786 
	`sync_fûesy°em
(
sb
);

5788 i‡(!
öode
 || !
	`igøb
(inode))

5789 
out
;

5791 
îr
 = 
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5792 i‡(
îr
 || 
	`pxt4_has_„©uª_quŸa
(
sb
))

5793 
out_put
;

5795 
	`öode_lock
(
öode
);

5801 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_QUOTA
, 1);

5802 i‡(
	`IS_ERR
(
h™dÀ
))

5803 
out_u∆ock
;

5804 
	`PXT4_I
(
öode
)->
i_Êags
 &~(
PXT4_NOATIME_FL
 | 
PXT4_IMMUTABLE_FL
);

5805 
	`öode_£t_Êags
(
öode
, 0, 
S_NOATIME
 | 
S_IMMUTABLE
);

5806 
öode
->
i_mtime
 = inode->
i_˘ime
 = 
	`cuºít_time
(inode);

5807 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5808 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

5809 
out_u∆ock
:

5810 
	`öode_u∆ock
(
öode
);

5811 
out_put
:

5812 
	`lockdï_£t_quŸa_öode
(
öode
, 
I_DATA_SEM_NORMAL
);

5813 
	`ùut
(
öode
);

5814  
îr
;

5815 
out
:

5816  
	`dquŸ_quŸa_off
(
sb
, 
ty≥
);

5817 
	}
}

5823 
ssize_t
 
	$pxt4_quŸa_ªad
(
su≥r_block
 *
sb
, 
ty≥
, *
d©a
,

5824 
size_t
 
Àn
, 
loff_t
 
off
)

5826 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5827 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5828 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5829 
toc›y
;

5830 
size_t
 
t‹ód
;

5831 
buf„r_hód
 *
bh
;

5832 
loff_t
 
i_size
 = 
	`i_size_ªad
(
öode
);

5834 i‡(
off
 > 
i_size
)

5836 i‡(
off
+
Àn
 > 
i_size
)

5837 
Àn
 = 
i_size
-
off
;

5838 
t‹ód
 = 
Àn
;

5839 
t‹ód
 > 0) {

5840 
toc›y
 = 
sb
->
s_blocksize
 - 
off£t
 < 
t‹ód
 ?

5841 
sb
->
s_blocksize
 - 
off£t
 : 
t‹ód
;

5842 
bh
 = 
	`pxt4_bªad
(
NULL
, 
öode
, 
blk
, 0);

5843 i‡(
	`IS_ERR
(
bh
))

5844  
	`PTR_ERR
(
bh
);

5845 i‡(!
bh
)

5846 
	`mem£t
(
d©a
, 0, 
toc›y
);

5848 
	`mem˝y
(
d©a
, 
bh
->
b_d©a
+
off£t
, 
toc›y
);

5849 
	`bªl£
(
bh
);

5850 
off£t
 = 0;

5851 
t‹ód
 -
toc›y
;

5852 
d©a
 +
toc›y
;

5853 
blk
++;

5855  
Àn
;

5856 
	}
}

5860 
ssize_t
 
	$pxt4_quŸa_wrôe
(
su≥r_block
 *
sb
, 
ty≥
,

5861 c⁄° *
d©a
, 
size_t
 
Àn
, 
loff_t
 
off
)

5863 
öode
 *öodê
	`sb_dq›t
(
sb
)->
fûes
[
ty≥
];

5864 
pxt4_lblk_t
 
blk
 = 
off
 >> 
	`PXT4_BLOCK_SIZE_BITS
(
sb
);

5865 
îr
, 
off£t
 = 
off
 & (
sb
->
s_blocksize
 - 1);

5866 
ªåõs
 = 0;

5867 
buf„r_hód
 *
bh
;

5868 
h™dÀ_t
 *
h™dÀ
 = 
	`jou∫Æ_cuºít_h™dÀ
();

5870 i‡(
	`PXT4_SB
(
sb
)->
s_jou∫Æ
 && !
h™dÀ
) {

5871 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

5873 ()
off
, ()
Àn
);

5874  -
EIO
;

5880 i‡(
sb
->
s_blocksize
 - 
off£t
 < 
Àn
) {

5881 
	`pxt4_msg
(
sb
, 
KERN_WARNING
, "Quota write (off=%llu,Üen=%llu)"

5883 ()
off
, ()
Àn
);

5884  -
EIO
;

5888 
bh
 = 
	`pxt4_bªad
(
h™dÀ
, 
öode
, 
blk
,

5889 
PXT4_GET_BLOCKS_CREATE
 |

5890 
PXT4_GET_BLOCKS_METADATA_NOFAIL
);

5891 } 
	`IS_ERR
(
bh
Ë&& (
	`PTR_ERR
(bhË=-
ENOSPC
) &&

5892 
	`pxt4_should_ªåy_Æloc
(
öode
->
i_sb
, &
ªåõs
));

5893 i‡(
	`IS_ERR
(
bh
))

5894  
	`PTR_ERR
(
bh
);

5895 i‡(!
bh
)

5896 
out
;

5897 
	`BUFFER_TRACE
(
bh
, "get writeáccess");

5898 
îr
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

5899 i‡(
îr
) {

5900 
	`bªl£
(
bh
);

5901  
îr
;

5903 
	`lock_buf„r
(
bh
);

5904 
	`mem˝y
(
bh
->
b_d©a
+
off£t
, 
d©a
, 
Àn
);

5905 
	`Êush_dˇche_∑ge
(
bh
->
b_∑ge
);

5906 
	`u∆ock_buf„r
(
bh
);

5907 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

5908 
	`bªl£
(
bh
);

5909 
out
:

5910 i‡(
öode
->
i_size
 < 
off
 + 
Àn
) {

5911 
	`i_size_wrôe
(
öode
, 
off
 + 
Àn
);

5912 
	`PXT4_I
(
öode
)->
i_disksize
 = inode->
i_size
;

5913 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

5915  
Àn
;

5916 
	}
}

5918 
	$pxt4_gë_√xt_id
(
su≥r_block
 *
sb
, 
kqid
 *
qid
)

5920 c⁄° 
quŸa_f‹m©_›s
 *
›s
;

5922 i‡(!
	`sb_has_quŸa_lﬂded
(
sb
, 
qid
->
ty≥
))

5923  -
ESRCH
;

5924 
›s
 = 
	`sb_dq›t
(
sb
)->›s[
qid
->
ty≥
];

5925 i‡(!
›s
 || !›s->
gë_√xt_id
)

5926  -
ENOSYS
;

5927  
	`dquŸ_gë_√xt_id
(
sb
, 
qid
);

5928 
	}
}

5931 
díåy
 *
	$pxt4_mou¡
(
fûe_sy°em_ty≥
 *
fs_ty≥
, 
Êags
,

5932 c⁄° *
dev_«me
, *
d©a
)

5934  
	`mou¡_bdev
(
fs_ty≥
, 
Êags
, 
dev_«me
, 
d©a
, 
pxt4_fûl_su≥r
);

5935 
	}
}

5937 #i‡!
deföed
(
CONFIG_PXT2_FS
Ë&& !deföed(
CONFIG_PXT2_FS_MODULE
Ë&& deföed(
CONFIG_PXT4_USE_FOR_PXT2
)

5938 
ölöe
 
	$ªgi°î_as_pxt2
()

5940 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt2_fs_ty≥
);

5941 i‡(
îr
)

5942 
	`¥ötk
(
KERN_WARNING


5943 "PXT4-fs: U«bÀÅÿªgi°îá†pxt2 (%d)\n", 
îr
);

5944 
	}
}

5946 
ölöe
 
	$uƒegi°î_as_pxt2
()

5948 
	`uƒegi°î_fûesy°em
(&
pxt2_fs_ty≥
);

5949 
	}
}

5951 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
)

5953 i‡(
	`pxt4_has_unknown_pxt2_öcom∑t_„©uªs
(
sb
))

5955 i‡(
	`sb_rd⁄ly
(
sb
))

5957 i‡(
	`pxt4_has_unknown_pxt2_ro_com∑t_„©uªs
(
sb
))

5960 
	}
}

5962 
ölöe
 
	$ªgi°î_as_pxt2
(Ë{ 
	}
}

5963 
ölöe
 
	$uƒegi°î_as_pxt2
(Ë{ 
	}
}

5964 
ölöe
 
	$pxt2_„©uª_£t_ok
(
su≥r_block
 *
sb
Ë{  0; 
	}
}

5967 
ölöe
 
	$ªgi°î_as_ext3
()

5969 
îr
 = 
	`ªgi°î_fûesy°em
(&
ext3_fs_ty≥
);

5970 i‡(
îr
)

5971 
	`¥ötk
(
KERN_WARNING


5972 "PXT4-fs: U«bÀÅÿªgi°îá†ext3 (%d)\n", 
îr
);

5973 
	}
}

5975 
ölöe
 
	$uƒegi°î_as_ext3
()

5977 
	`uƒegi°î_fûesy°em
(&
ext3_fs_ty≥
);

5978 
	}
}

5980 
ölöe
 
	$ext3_„©uª_£t_ok
(
su≥r_block
 *
sb
)

5982 i‡(
	`pxt4_has_unknown_ext3_öcom∑t_„©uªs
(
sb
))

5984 i‡(!
	`pxt4_has_„©uª_jou∫Æ
(
sb
))

5986 i‡(
	`sb_rd⁄ly
(
sb
))

5988 i‡(
	`pxt4_has_unknown_ext3_ro_com∑t_„©uªs
(
sb
))

5991 
	}
}

5993 
fûe_sy°em_ty≥
 
	gpxt4_fs_ty≥
 = {

5994 .
ow√r
 = 
THIS_MODULE
,

5995 .
	g«me
 = "pxt4",

5996 .
	gmou¡
 = 
pxt4_mou¡
,

5997 .
	gkûl_sb
 = 
kûl_block_su≥r
,

5998 .
	gfs_Êags
 = 
FS_REQUIRES_DEV
,

6000 
MODULE_ALIAS_FS
("pxt4");

6003 
waô_queue_hód_t
 
	gpxt4__i€nd_wq
[
PXT4_WQ_HASH_SZ
];

6005 
__öô
 
	$pxt4_öô_fs
()

6007 
i
, 
îr
;

6009 
	`¥ötk
("%s, sèπ!\n", 
__func__
);

6010 
	`øãlimô_°©e_öô
(&
pxt4_mou¡_msg_øãlimô
, 30 * 
HZ
, 64);

6011 
pxt4_li_öfo
 = 
NULL
;

6012 
	`muãx_öô
(&
pxt4_li_mtx
);

6015 
	`pxt4_check_Êag_vÆues
();

6017 
i
 = 0; i < 
PXT4_WQ_HASH_SZ
; i++)

6018 
	`öô_waôqueue_hód
(&
pxt4__i€nd_wq
[
i
]);

6020 
îr
 = 
	`pxt4_öô_es
();

6021 i‡(
îr
)

6022  
îr
;

6024 
îr
 = 
	`pxt4_öô_≥ndög
();

6025 i‡(
îr
)

6026 
out6
;

6028 
îr
 = 
	`pxt4_öô_∑geio
();

6029 i‡(
îr
)

6030 
out5
;

6032 
îr
 = 
	`pxt4_öô_sy°em_z⁄e
();

6033 i‡(
îr
)

6034 
out4
;

6036 
îr
 = 
	`pxt4_öô_sysfs
();

6037 i‡(
îr
)

6038 
out3
;

6040 
îr
 = 
	`pxt4_öô_mbÆloc
();

6041 i‡(
îr
)

6042 
out2
;

6043 
îr
 = 
	`öô_öodeˇche
();

6044 i‡(
îr
)

6045 
out1
;

6046 
	`ªgi°î_as_ext3
();

6047 
	`ªgi°î_as_pxt2
();

6048 
îr
 = 
	`ªgi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6049 i‡(
îr
)

6050 
out
;

6053 
out
:

6054 
	`uƒegi°î_as_pxt2
();

6055 
	`uƒegi°î_as_ext3
();

6056 
	`de°roy_öodeˇche
();

6057 
out1
:

6058 
	`pxt4_exô_mbÆloc
();

6059 
out2
:

6060 
	`pxt4_exô_sysfs
();

6061 
out3
:

6062 
	`pxt4_exô_sy°em_z⁄e
();

6063 
out4
:

6064 
	`pxt4_exô_∑geio
();

6065 
out5
:

6066 
	`pxt4_exô_≥ndög
();

6067 
out6
:

6068 
	`pxt4_exô_es
();

6070  
îr
;

6071 
	}
}

6073 
__exô
 
	$pxt4_exô_fs
()

6075 
	`pxt4_de°roy_œzyöô_thªad
();

6076 
	`uƒegi°î_as_pxt2
();

6077 
	`uƒegi°î_as_ext3
();

6078 
	`uƒegi°î_fûesy°em
(&
pxt4_fs_ty≥
);

6079 
	`de°roy_öodeˇche
();

6080 
	`pxt4_exô_mbÆloc
();

6081 
	`pxt4_exô_sysfs
();

6082 
	`pxt4_exô_sy°em_z⁄e
();

6083 
	`pxt4_exô_∑geio
();

6084 
	`pxt4_exô_es
();

6085 
	`pxt4_exô_≥ndög
();

6086 
	}
}

6088 
MODULE_AUTHOR
("Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'oánd others");

6089 
MODULE_DESCRIPTION
("Fourth Extended Filesystem");

6090 
MODULE_LICENSE
("GPL");

6091 
MODULE_SOFTDEP
("pre: crc32c");

6092 
	$moduÀ_öô
(
pxt4_öô_fs
)

6093 
	`moduÀ_exô
(
pxt4_exô_fs
)

	@symlink.c

21 
	~<löux/fs.h
>

22 
	~<löux/«mei.h
>

23 
	~"pxt4.h
"

24 
	~"x©å.h
"

26 c⁄° *
	$pxt4_í¸y±ed_gë_lök
(
díåy
 *dentry,

27 
öode
 *inode,

28 
dñayed_ˇŒ
 *
d⁄e
)

30 
∑ge
 *
˝age
 = 
NULL
;

31 c⁄° *
ˇddr
;

32 
max_size
;

33 c⁄° *
∑ddr
;

35 i‡(!
díåy
)

36  
	`ERR_PTR
(-
ECHILD
);

38 i‡(
	`pxt4_öode_is_Á°_symlök
(
öode
)) {

39 
ˇddr
 = 
	`PXT4_I
(
öode
)->
i_d©a
;

40 
max_size
 = (
	`PXT4_I
(
öode
)->
i_d©a
);

42 
˝age
 = 
	`ªad_m≠pög_∑ge
(
öode
->
i_m≠pög
, 0, 
NULL
);

43 i‡(
	`IS_ERR
(
˝age
))

44  
	`ERR_CAST
(
˝age
);

45 
ˇddr
 = 
	`∑ge_addªss
(
˝age
);

46 
max_size
 = 
öode
->
i_sb
->
s_blocksize
;

49 
∑ddr
 = 
	`fs¸y±_gë_symlök
(
öode
, 
ˇddr
, 
max_size
, 
d⁄e
);

50 i‡(
˝age
)

51 
	`put_∑ge
(
˝age
);

52  
∑ddr
;

53 
	}
}

55 c⁄° 
öode_›î©i⁄s
 
	gpxt4_í¸y±ed_symlök_öode_›î©i⁄s
 = {

56 .
gë_lök
 = 
pxt4_í¸y±ed_gë_lök
,

57 .
	g£èâr
 = 
pxt4_£èâr
,

58 .
	ggë©å
 = 
pxt4_gë©å
,

59 .
	gli°x©å
 = 
pxt4_li°x©å
,

62 c⁄° 
öode_›î©i⁄s
 
	gpxt4_symlök_öode_›î©i⁄s
 = {

63 .
gë_lök
 = 
∑ge_gë_lök
,

64 .
	g£èâr
 = 
pxt4_£èâr
,

65 .
	ggë©å
 = 
pxt4_gë©å
,

66 .
	gli°x©å
 = 
pxt4_li°x©å
,

69 c⁄° 
öode_›î©i⁄s
 
	gpxt4_Á°_symlök_öode_›î©i⁄s
 = {

70 .
gë_lök
 = 
sim∂e_gë_lök
,

71 .
	g£èâr
 = 
pxt4_£èâr
,

72 .
	ggë©å
 = 
pxt4_gë©å
,

73 .
	gli°x©å
 = 
pxt4_li°x©å
,

	@sysfs.c

11 
	~<löux/time.h
>

12 
	~<löux/fs.h
>

13 
	~<löux/£q_fûe.h
>

14 
	~<löux/¶ab.h
>

15 
	~<löux/¥oc_fs.h
>

17 
	~"pxt4.h
"

18 
	~"pxt4_jbd3.h
"

21 
	m©å_no›
,

22 
	m©å_dñayed_Æloˇti⁄_blocks
,

23 
	m©å_£ssi⁄_wrôe_kbyãs
,

24 
	m©å_li„time_wrôe_kbyãs
,

25 
	m©å_ª£rved_˛u°îs
,

26 
	m©å_öode_ªadahód
,

27 
	m©å_åiggî_ã°_îr‹
,

28 
	m©å_fú°_îr‹_time
,

29 
	m©å_œ°_îr‹_time
,

30 
	m©å_„©uª
,

31 
	m©å_poöãr_ui
,

32 
	m©å_poöãr_©omic
,

33 
	m©å_jou∫Æ_èsk
,

34 } 
	t©å_id_t
;

37 
	m±r_ex∂icô
,

38 
	m±r_pxt4_sb_öfo_off£t
,

39 
	m±r_pxt4_su≥r_block_off£t
,

40 } 
	t©å_±r_t
;

42 c⁄° 
	g¥oc_dú«me
[] = "fs/pxt4";

43 
¥oc_dú_íåy
 *
	gpxt4_¥oc_roŸ
;

45 
	spxt4_©å
 {

46 
©åibuã
 
	m©å
;

47 
	m©å_id
;

48 
	m©å_±r
;

50 
	moff£t
;

51 *
	mex∂icô_±r
;

52 } 
	mu
;

55 
ssize_t
 
	$£ssi⁄_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

57 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

59 i‡(!
sb
->
s_bdev
->
bd_∑π
)

60  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

61  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lu\n",

62 (
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

63 
£˘‹s
[
STAT_WRITE
]) -

64 
sbi
->
s_£˘‹s_wrôãn_°¨t
) >> 1);

65 
	}
}

67 
ssize_t
 
	$li„time_wrôe_kbyãs_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

69 
su≥r_block
 *
sb
 = 
sbi
->
s_buddy_ˇche
->
i_sb
;

71 i‡(!
sb
->
s_bdev
->
bd_∑π
)

72  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "0\n");

73  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

74 ()(
sbi
->
s_kbyãs_wrôãn
 +

75 ((
	`∑π_°©_ªad
(
sb
->
s_bdev
->
bd_∑π
,

76 
£˘‹s
[
STAT_WRITE
]) -

77 
	`PXT4_SB
(
sb
)->
s_£˘‹s_wrôãn_°¨t
) >> 1)));

78 
	}
}

80 
ssize_t
 
	$öode_ªadahód_blks_°‹e
(
pxt4_sb_öfo
 *
sbi
,

81 c⁄° *
buf
, 
size_t
 
cou¡
)

83 
t
;

84 
ªt
;

86 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

87 i‡(
ªt
)

88  
ªt
;

90 i‡(
t
 && (!
	`is_powî_of_2
(t) ||Å > 0x40000000))

91  -
EINVAL
;

93 
sbi
->
s_öode_ªadahód_blks
 = 
t
;

94  
cou¡
;

95 
	}
}

97 
ssize_t
 
	$ª£rved_˛u°îs_°‹e
(
pxt4_sb_öfo
 *
sbi
,

98 c⁄° *
buf
, 
size_t
 
cou¡
)

100 
vÆ
;

101 
pxt4_fsblk_t
 
˛u°îs
 = (
	`pxt4_blocks_cou¡
(
sbi
->
s_es
) >>

102 
sbi
->
s_˛u°î_bôs
);

103 
ªt
;

105 
ªt
 = 
	`k°πouŒ
(
	`skù_•a˚s
(
buf
), 0, &
vÆ
);

106 i‡(
ªt
 || 
vÆ
 >
˛u°îs
)

107  -
EINVAL
;

109 
	`©omic64_£t
(&
sbi
->
s_ªsv_˛u°îs
, 
vÆ
);

110  
cou¡
;

111 
	}
}

113 
ssize_t
 
	$åiggî_ã°_îr‹
(
pxt4_sb_öfo
 *
sbi
,

114 c⁄° *
buf
, 
size_t
 
cou¡
)

116 
Àn
 = 
cou¡
;

118 i‡(!
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
))

119  -
EPERM
;

121 i‡(
Àn
 && 
buf
[len-1] == '\n')

122 
Àn
--;

124 i‡(
Àn
)

125 
	`pxt4_îr‹
(
sbi
->
s_sb
, "%.*s", 
Àn
, 
buf
);

126  
cou¡
;

127 
	}
}

129 
ssize_t
 
	$jou∫Æ_èsk_show
(
pxt4_sb_öfo
 *
sbi
, *
buf
)

131 i‡(!
sbi
->
s_jou∫Æ
)

132  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "<none>\n");

133  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

134 
	`èsk_pid_vƒ
(
sbi
->
s_jou∫Æ
->
j_èsk
));

135 
	}
}

137 
	#PXT4_ATTR
(
_«me
,
_mode
,
_id
) \

138 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

139 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

140 .
©å_id
 = 
©å_
##
_id
, \

141 }

	)

143 
	#PXT4_ATTR_FUNC
(
_«me
,
_mode
Ë
	`PXT4_ATTR
(_«me,_mode,_«me)

	)

145 
	#PXT4_ATTR_FEATURE
(
_«me
Ë
	`PXT4_ATTR
(_«me, 0444, 
„©uª
)

	)

147 
	#PXT4_ATTR_OFFSET
(
_«me
,
_mode
,
_id
,
_°ru˘
,
_ñ«me
) \

148 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

149 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

150 .
©å_id
 = 
©å_
##
_id
, \

151 .
©å_±r
 = 
±r_
##
_°ru˘
##
_off£t
, \

152 .
u
 = { \

153 .
off£t
 = 
	`off£tof
(
_°ru˘
, 
_ñ«me
),\

155 }

	)

157 
	#PXT4_RO_ATTR_ES_UI
(
_«me
,
_ñ«me
) \

158 
	`PXT4_ATTR_OFFSET
(
_«me
, 0444, 
poöãr_ui
, 
pxt4_su≥r_block
, 
_ñ«me
)

	)

160 
	#PXT4_RW_ATTR_SBI_UI
(
_«me
,
_ñ«me
) \

161 
	`PXT4_ATTR_OFFSET
(
_«me
, 0644, 
poöãr_ui
, 
pxt4_sb_öfo
, 
_ñ«me
)

	)

163 
	#PXT4_ATTR_PTR
(
_«me
,
_mode
,
_id
,
_±r
) \

164 
pxt4_©å
 
pxt4_©å_
##
_«me
 = { \

165 .
©å
 = {.
«me
 = 
	`__°rögify
(
_«me
), .
mode
 = 
_mode
 }, \

166 .
©å_id
 = 
©å_
##
_id
, \

167 .
©å_±r
 = 
±r_ex∂icô
, \

168 .
u
 = { \

169 .
ex∂icô_±r
 = 
_±r
, \

171 }

	)

173 
	#ATTR_LIST
(
«me
Ë&
pxt4_©å_
##«me.
©å


	)

175 
PXT4_ATTR_FUNC
(
dñayed_Æloˇti⁄_blocks
, 0444);

176 
PXT4_ATTR_FUNC
(
£ssi⁄_wrôe_kbyãs
, 0444);

177 
PXT4_ATTR_FUNC
(
li„time_wrôe_kbyãs
, 0444);

178 
PXT4_ATTR_FUNC
(
ª£rved_˛u°îs
, 0644);

180 
PXT4_ATTR_OFFSET
(
öode_ªadahód_blks
, 0644, 
öode_ªadahód
,

181 
pxt4_sb_öfo
, 
s_öode_ªadahód_blks
);

182 
PXT4_RW_ATTR_SBI_UI
(
öode_gﬂl
, 
s_öode_gﬂl
);

183 
PXT4_RW_ATTR_SBI_UI
(
mb_°©s
, 
s_mb_°©s
);

184 
PXT4_RW_ATTR_SBI_UI
(
mb_max_to_sˇn
, 
s_mb_max_to_sˇn
);

185 
PXT4_RW_ATTR_SBI_UI
(
mb_mö_to_sˇn
, 
s_mb_mö_to_sˇn
);

186 
PXT4_RW_ATTR_SBI_UI
(
mb_‹dî2_ªq
, 
s_mb_‹dî2_ªqs
);

187 
PXT4_RW_ATTR_SBI_UI
(
mb_°ªam_ªq
, 
s_mb_°ªam_ªque°
);

188 
PXT4_RW_ATTR_SBI_UI
(
mb_group_¥óŒoc
, 
s_mb_group_¥óŒoc
);

189 
PXT4_RW_ATTR_SBI_UI
(
exã¡_max_zîoout_kb
, 
s_exã¡_max_zîoout_kb
);

190 
PXT4_ATTR
(
åiggî_fs_îr‹
, 0200, 
åiggî_ã°_îr‹
);

191 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_öãrvÆ_ms
, 
s_îr_øãlimô_°©e
.
öãrvÆ
);

192 
PXT4_RW_ATTR_SBI_UI
(
îr_øãlimô_bur°
, 
s_îr_øãlimô_°©e
.
bur°
);

193 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_öãrvÆ_ms
, 
s_w¨nög_øãlimô_°©e
.
öãrvÆ
);

194 
PXT4_RW_ATTR_SBI_UI
(
w¨nög_øãlimô_bur°
, 
s_w¨nög_øãlimô_°©e
.
bur°
);

195 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_öãrvÆ_ms
, 
s_msg_øãlimô_°©e
.
öãrvÆ
);

196 
PXT4_RW_ATTR_SBI_UI
(
msg_øãlimô_bur°
, 
s_msg_øãlimô_°©e
.
bur°
);

197 
PXT4_RO_ATTR_ES_UI
(
îr‹s_cou¡
, 
s_îr‹_cou¡
);

198 
PXT4_ATTR
(
fú°_îr‹_time
, 0444, first_error_time);

199 
PXT4_ATTR
(
œ°_îr‹_time
, 0444,Üast_error_time);

200 
PXT4_ATTR
(
jou∫Æ_èsk
, 0444, journal_task);

202 
	gﬁd_bump_vÆ
 = 128;

203 
PXT4_ATTR_PTR
(
max_wrôeback_mb_bump
, 0444, 
poöãr_ui
, &
ﬁd_bump_vÆ
);

205 
©åibuã
 *
	gpxt4_©ås
[] = {

206 
ATTR_LIST
(
dñayed_Æloˇti⁄_blocks
),

207 
ATTR_LIST
(
£ssi⁄_wrôe_kbyãs
),

208 
ATTR_LIST
(
li„time_wrôe_kbyãs
),

209 
ATTR_LIST
(
ª£rved_˛u°îs
),

210 
ATTR_LIST
(
öode_ªadahód_blks
),

211 
ATTR_LIST
(
öode_gﬂl
),

212 
ATTR_LIST
(
mb_°©s
),

213 
ATTR_LIST
(
mb_max_to_sˇn
),

214 
ATTR_LIST
(
mb_mö_to_sˇn
),

215 
ATTR_LIST
(
mb_‹dî2_ªq
),

216 
ATTR_LIST
(
mb_°ªam_ªq
),

217 
ATTR_LIST
(
mb_group_¥óŒoc
),

218 
ATTR_LIST
(
max_wrôeback_mb_bump
),

219 
ATTR_LIST
(
exã¡_max_zîoout_kb
),

220 
ATTR_LIST
(
åiggî_fs_îr‹
),

221 
ATTR_LIST
(
îr_øãlimô_öãrvÆ_ms
),

222 
ATTR_LIST
(
îr_øãlimô_bur°
),

223 
ATTR_LIST
(
w¨nög_øãlimô_öãrvÆ_ms
),

224 
ATTR_LIST
(
w¨nög_øãlimô_bur°
),

225 
ATTR_LIST
(
msg_øãlimô_öãrvÆ_ms
),

226 
ATTR_LIST
(
msg_øãlimô_bur°
),

227 
ATTR_LIST
(
îr‹s_cou¡
),

228 
ATTR_LIST
(
fú°_îr‹_time
),

229 
ATTR_LIST
(
œ°_îr‹_time
),

230 
ATTR_LIST
(
jou∫Æ_èsk
),

231 
NULL
,

235 
PXT4_ATTR_FEATURE
(
œzy_ôabÀ_öô
);

236 
PXT4_ATTR_FEATURE
(
b©ched_disˇrd
);

237 
PXT4_ATTR_FEATURE
(
mëa_bg_ªsize
);

238 #ifde‡
CONFIG_FS_ENCRYPTION


239 
PXT4_ATTR_FEATURE
(
í¸y±i⁄
);

241 
PXT4_ATTR_FEATURE
(
mëad©a_csum_£ed
);

243 
©åibuã
 *
	gpxt4_„©_©ås
[] = {

244 
ATTR_LIST
(
œzy_ôabÀ_öô
),

245 
ATTR_LIST
(
b©ched_disˇrd
),

246 
ATTR_LIST
(
mëa_bg_ªsize
),

247 #ifde‡
CONFIG_FS_ENCRYPTION


248 
ATTR_LIST
(
í¸y±i⁄
),

250 
ATTR_LIST
(
mëad©a_csum_£ed
),

251 
NULL
,

254 *
	$ˇlc_±r
(
pxt4_©å
 *
a
, 
pxt4_sb_öfo
 *
sbi
)

256 
a
->
©å_±r
) {

257 
±r_ex∂icô
:

258  
a
->
u
.
ex∂icô_±r
;

259 
±r_pxt4_sb_öfo_off£t
:

260  (*Ë(((*Ë
sbi
Ë+ 
a
->
u
.
off£t
);

261 
±r_pxt4_su≥r_block_off£t
:

262  (*Ë(((*Ë
sbi
->
s_es
Ë+ 
a
->
u
.
off£t
);

264  
NULL
;

265 
	}
}

267 
ssize_t
 
	$__¥öt_t°amp
(*
buf
, 
__À32
 
lo
, 
__u8
 
hi
)

269  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%lld",

270 ((
time64_t
)
hi
 << 32Ë+ 
	`À32_to_˝u
(
lo
));

271 
	}
}

273 
	#¥öt_t°amp
(
buf
, 
es
, 
t°amp
) \

274 
	`__¥öt_t°amp
(
buf
, (
es
)->
t°amp
, (es)->t°am∞## 
_hi
)

	)

276 
ssize_t
 
	$pxt4_©å_show
(
kobje˘
 *
kobj
,

277 
©åibuã
 *
©å
, *
buf
)

279 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

280 
s_kobj
);

281 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

282 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

284 
a
->
©å_id
) {

285 
©å_dñayed_Æloˇti⁄_blocks
:

286  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

287 (
s64
Ë
	`PXT4_C2B
(
sbi
,

288 
	`≥r˝u_cou¡î_sum
(&
sbi
->
s_dúty˛u°îs_cou¡î
)));

289 
©å_£ssi⁄_wrôe_kbyãs
:

290  
	`£ssi⁄_wrôe_kbyãs_show
(
sbi
, 
buf
);

291 
©å_li„time_wrôe_kbyãs
:

292  
	`li„time_wrôe_kbyãs_show
(
sbi
, 
buf
);

293 
©å_ª£rved_˛u°îs
:

294  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%llu\n",

296 
	`©omic64_ªad
(&
sbi
->
s_ªsv_˛u°îs
));

297 
©å_öode_ªadahód
:

298 
©å_poöãr_ui
:

299 i‡(!
±r
)

301 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

302  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

303 
	`À32_to_˝up
(
±r
));

305  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%u\n",

306 *((*Ë
±r
));

307 
©å_poöãr_©omic
:

308 i‡(!
±r
)

310  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "%d\n",

311 
	`©omic_ªad
((
©omic_t
 *Ë
±r
));

312 
©å_„©uª
:

313  
	`¢¥ötf
(
buf
, 
PAGE_SIZE
, "supported\n");

314 
©å_fú°_îr‹_time
:

315  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_fú°_îr‹_time
);

316 
©å_œ°_îr‹_time
:

317  
	`¥öt_t°amp
(
buf
, 
sbi
->
s_es
, 
s_œ°_îr‹_time
);

318 
©å_jou∫Æ_èsk
:

319  
	`jou∫Æ_èsk_show
(
sbi
, 
buf
);

323 
	}
}

325 
ssize_t
 
	$pxt4_©å_°‹e
(
kobje˘
 *
kobj
,

326 
©åibuã
 *
©å
,

327 c⁄° *
buf
, 
size_t
 
Àn
)

329 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

330 
s_kobj
);

331 
pxt4_©å
 *
a
 = 
	`c⁄èöî_of
(
©å
, pxt4_attr,áttr);

332 *
±r
 = 
	`ˇlc_±r
(
a
, 
sbi
);

333 
t
;

334 
ªt
;

336 
a
->
©å_id
) {

337 
©å_ª£rved_˛u°îs
:

338  
	`ª£rved_˛u°îs_°‹e
(
sbi
, 
buf
, 
Àn
);

339 
©å_poöãr_ui
:

340 i‡(!
±r
)

342 
ªt
 = 
	`k°πoul
(
	`skù_•a˚s
(
buf
), 0, &
t
);

343 i‡(
ªt
)

344  
ªt
;

345 i‡(
a
->
©å_±r
 =
±r_pxt4_su≥r_block_off£t
)

346 *((
__À32
 *Ë
±r
Ë
	`˝u_to_À32
(
t
);

348 *((*Ë
±r
Ë
t
;

349  
Àn
;

350 
©å_öode_ªadahód
:

351  
	`öode_ªadahód_blks_°‹e
(
sbi
, 
buf
, 
Àn
);

352 
©å_åiggî_ã°_îr‹
:

353  
	`åiggî_ã°_îr‹
(
sbi
, 
buf
, 
Àn
);

356 
	}
}

358 
	$pxt4_sb_ªÀa£
(
kobje˘
 *
kobj
)

360 
pxt4_sb_öfo
 *
sbi
 = 
	`c⁄èöî_of
(
kobj
, pxt4_sb_info,

361 
s_kobj
);

362 
	`com∂ëe
(&
sbi
->
s_kobj_uƒegi°î
);

363 
	}
}

365 c⁄° 
sysfs_›s
 
	gpxt4_©å_›s
 = {

366 .
show
 = 
pxt4_©å_show
,

367 .
	g°‹e
 = 
pxt4_©å_°‹e
,

370 
kobj_ty≥
 
	gpxt4_sb_kty≥
 = {

371 .
deÁu…_©ås
 = 
pxt4_©ås
,

372 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

373 .
	gªÀa£
 = 
pxt4_sb_ªÀa£
,

376 
kobj_ty≥
 
	gpxt4_„©_kty≥
 = {

377 .
deÁu…_©ås
 = 
pxt4_„©_©ås
,

378 .
	gsysfs_›s
 = &
pxt4_©å_›s
,

379 .
	gªÀa£
 = ((*)(
kobje˘
 *))
k‰ì
,

382 
kobje˘
 *
	gpxt4_roŸ
;

384 
kobje˘
 *
	gpxt4_„©
;

386 
	$pxt4_ªgi°î_sysfs
(
su≥r_block
 *
sb
)

388 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

389 
îr
;

391 
	`öô_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

392 
îr
 = 
	`kobje˘_öô_™d_add
(&
sbi
->
s_kobj
, &
pxt4_sb_kty≥
, 
pxt4_roŸ
,

393 "%s", 
sb
->
s_id
);

394 i‡(
îr
) {

395 
	`kobje˘_put
(&
sbi
->
s_kobj
);

396 
	`waô_f‹_com∂ëi⁄
(&
sbi
->
s_kobj_uƒegi°î
);

397  
îr
;

400 i‡(
pxt4_¥oc_roŸ
)

401 
sbi
->
s_¥oc
 = 
	`¥oc_mkdú
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

402 i‡(
sbi
->
s_¥oc
) {

403 
	`¥oc_¸óã_sögÀ_d©a
("›ti⁄s", 
S_IRUGO
, 
sbi
->
s_¥oc
,

404 
pxt4_£q_›ti⁄s_show
, 
sb
);

405 
	`¥oc_¸óã_sögÀ_d©a
("es_shrökî_öfo", 
S_IRUGO
,

406 
sbi
->
s_¥oc
, 
pxt4_£q_es_shrökî_öfo_show
,

407 
sb
);

408 
	`¥oc_¸óã_£q_d©a
("mb_groups", 
S_IRUGO
, 
sbi
->
s_¥oc
,

409 &
pxt4_mb_£q_groups_›s
, 
sb
);

412 
	}
}

414 
	$pxt4_uƒegi°î_sysfs
(
su≥r_block
 *
sb
)

416 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
sb
);

418 i‡(
sbi
->
s_¥oc
)

419 
	`ªmove_¥oc_subåì
(
sb
->
s_id
, 
pxt4_¥oc_roŸ
);

420 
	`kobje˘_dñ
(&
sbi
->
s_kobj
);

421 
	}
}

423 
__öô
 
	$pxt4_öô_sysfs
()

425 
ªt
;

427 
pxt4_roŸ
 = 
	`kobje˘_¸óã_™d_add
("pxt4", 
fs_kobj
);

428 i‡(!
pxt4_roŸ
)

429  -
ENOMEM
;

431 
pxt4_„©
 = 
	`kzÆloc
((*pxt4_„©), 
GFP_KERNEL
);

432 i‡(!
pxt4_„©
) {

433 
ªt
 = -
ENOMEM
;

434 
roŸ_îr
;

437 
ªt
 = 
	`kobje˘_öô_™d_add
(
pxt4_„©
, &
pxt4_„©_kty≥
,

438 
pxt4_roŸ
, "features");

439 i‡(
ªt
)

440 
„©_îr
;

442 
pxt4_¥oc_roŸ
 = 
	`¥oc_mkdú
(
¥oc_dú«me
, 
NULL
);

443  
ªt
;

445 
„©_îr
:

446 
	`kobje˘_put
(
pxt4_„©
);

447 
pxt4_„©
 = 
NULL
;

448 
roŸ_îr
:

449 
	`kobje˘_put
(
pxt4_roŸ
);

450 
pxt4_roŸ
 = 
NULL
;

451  
ªt
;

452 
	}
}

454 
	$pxt4_exô_sysfs
()

456 
	`kobje˘_put
(
pxt4_„©
);

457 
pxt4_„©
 = 
NULL
;

458 
	`kobje˘_put
(
pxt4_roŸ
);

459 
pxt4_roŸ
 = 
NULL
;

460 
	`ªmove_¥oc_íåy
(
¥oc_dú«me
, 
NULL
);

461 
pxt4_¥oc_roŸ
 = 
NULL
;

462 
	}
}

	@truncate.h

12 
ölöe
 
	$pxt4_åunˇã_Áûed_wrôe
(
öode
 *inode)

18 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

19 
	`åunˇã_öode_∑ges
(
öode
->
i_m≠pög
, inode->
i_size
);

20 
	`pxt4_åunˇã
(
öode
);

21 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
i_mm≠_£m
);

22 
	}
}

28 
ölöe
 
	$pxt4_blocks_f‹_åunˇã
(
öode
 *inode)

30 
pxt4_lblk_t
 
√eded
;

32 
√eded
 = 
öode
->
i_blocks
 >> (öode->
i_sb
->
s_blocksize_bôs
 - 9);

40 i‡(
√eded
 < 2)

41 
√eded
 = 2;

45 i‡(
√eded
 > 
PXT4_MAX_TRANS_DATA
)

46 
√eded
 = 
PXT4_MAX_TRANS_DATA
;

48  
	`PXT4_DATA_TRANS_BLOCKS
(
öode
->
i_sb
Ë+ 
√eded
;

49 
	}
}

	@xarray.c

8 
	~<löux/bôm≠.h
>

9 
	~<löux/exp‹t.h
>

10 
	~<löux/li°.h
>

11 
	~<löux/¶ab.h
>

12 
	~<löux/x¨øy.h
>

30 
ölöe
 
	$xa_lock_ty≥
(c⁄° 
x¨øy
 *
xa
)

32  (
__f‹˚
 )
xa
->
xa_Êags
 & 3;

33 
	}
}

35 
ölöe
 
	$xas_lock_ty≥
(
xa_°©e
 *
xas
, 
lock_ty≥
)

37 i‡(
lock_ty≥
 =
XA_LOCK_IRQ
)

38 
	`xas_lock_úq
(
xas
);

39 i‡(
lock_ty≥
 =
XA_LOCK_BH
)

40 
	`xas_lock_bh
(
xas
);

42 
	`xas_lock
(
xas
);

43 
	}
}

45 
ölöe
 
	$xas_u∆ock_ty≥
(
xa_°©e
 *
xas
, 
lock_ty≥
)

47 i‡(
lock_ty≥
 =
XA_LOCK_IRQ
)

48 
	`xas_u∆ock_úq
(
xas
);

49 i‡(
lock_ty≥
 =
XA_LOCK_BH
)

50 
	`xas_u∆ock_bh
(
xas
);

52 
	`xas_u∆ock
(
xas
);

53 
	}
}

55 
ölöe
 
boﬁ
 
	$xa_åack_‰ì
(c⁄° 
x¨øy
 *
xa
)

57  
xa
->
xa_Êags
 & 
XA_FLAGS_TRACK_FREE
;

58 
	}
}

60 
ölöe
 
boﬁ
 
	$xa_zîo_busy
(c⁄° 
x¨øy
 *
xa
)

62  
xa
->
xa_Êags
 & 
XA_FLAGS_ZERO_BUSY
;

63 
	}
}

65 
ölöe
 
	$xa_m¨k_£t
(
x¨øy
 *
xa
, 
xa_m¨k_t
 
m¨k
)

67 i‡(!(
xa
->
xa_Êags
 & 
	`XA_FLAGS_MARK
(
m¨k
)))

68 
xa
->
xa_Êags
 |
	`XA_FLAGS_MARK
(
m¨k
);

69 
	}
}

71 
ölöe
 
	$xa_m¨k_˛ór
(
x¨øy
 *
xa
, 
xa_m¨k_t
 
m¨k
)

73 i‡(
xa
->
xa_Êags
 & 
	`XA_FLAGS_MARK
(
m¨k
))

74 
xa
->
xa_Êags
 &~(
	`XA_FLAGS_MARK
(
m¨k
));

75 
	}
}

77 
ölöe
 *
	$node_m¨ks
(
xa_node
 *
node
, 
xa_m¨k_t
 
m¨k
)

79  
node
->
m¨ks
[(
__f‹˚
 )
m¨k
];

80 
	}
}

82 
ölöe
 
boﬁ
 
	$node_gë_m¨k
(
xa_node
 *
node
,

83 
off£t
, 
xa_m¨k_t
 
m¨k
)

85  
	`ã°_bô
(
off£t
, 
	`node_m¨ks
(
node
, 
m¨k
));

86 
	}
}

89 
ölöe
 
boﬁ
 
	$node_£t_m¨k
(
xa_node
 *
node
, 
off£t
,

90 
xa_m¨k_t
 
m¨k
)

92  
	`__ã°_™d_£t_bô
(
off£t
, 
	`node_m¨ks
(
node
, 
m¨k
));

93 
	}
}

96 
ölöe
 
boﬁ
 
	$node_˛ór_m¨k
(
xa_node
 *
node
, 
off£t
,

97 
xa_m¨k_t
 
m¨k
)

99  
	`__ã°_™d_˛ór_bô
(
off£t
, 
	`node_m¨ks
(
node
, 
m¨k
));

100 
	}
}

102 
ölöe
 
boﬁ
 
	$node_™y_m¨k
(
xa_node
 *
node
, 
xa_m¨k_t
 
m¨k
)

104  !
	`bôm≠_em±y
(
	`node_m¨ks
(
node
, 
m¨k
), 
XA_CHUNK_SIZE
);

105 
	}
}

107 
ölöe
 
	$node_m¨k_Æl
(
xa_node
 *
node
, 
xa_m¨k_t
 
m¨k
)

109 
	`bôm≠_fûl
(
	`node_m¨ks
(
node
, 
m¨k
), 
XA_CHUNK_SIZE
);

110 
	}
}

112 
	#m¨k_öc
(
m¨k
) do { \

113 
m¨k
 = (
__f‹˚
 
xa_m¨k_t
)((__force )(mark) + 1); \

114 } 0)

	)

123 
	$xas_squash_m¨ks
(c⁄° 
xa_°©e
 *
xas
)

125 
m¨k
 = 0;

126 
limô
 = 
xas
->
xa_off£t
 + xas->
xa_sibs
 + 1;

128 i‡(!
xas
->
xa_sibs
)

132 *
m¨ks
 = 
xas
->
xa_node
->m¨ks[
m¨k
];

133 i‡(
	`föd_√xt_bô
(
m¨ks
, 
limô
, 
xas
->
xa_off£t
 + 1) ==Üimit)

135 
	`__£t_bô
(
xas
->
xa_off£t
, 
m¨ks
);

136 
	`bôm≠_˛ór
(
m¨ks
, 
xas
->
xa_off£t
 + 1, xas->
xa_sibs
);

137 } 
m¨k
++ !(
__f‹˚
 )
XA_MARK_MAX
);

138 
	}
}

141 
	$gë_off£t
(
ödex
, 
xa_node
 *
node
)

143  (
ödex
 >> 
node
->
shi·
Ë& 
XA_CHUNK_MASK
;

144 
	}
}

146 
	$xas_£t_off£t
(
xa_°©e
 *
xas
)

148 
xas
->
xa_off£t
 = 
	`gë_off£t
(xas->
xa_ödex
, xas->
xa_node
);

149 
	}
}

152 
	$xas_move_ödex
(
xa_°©e
 *
xas
, 
off£t
)

154 
shi·
 = 
xas
->
xa_node
->shift;

155 
xas
->
xa_ödex
 &~
XA_CHUNK_MASK
 << 
shi·
;

156 
xas
->
xa_ödex
 +
off£t
 << 
shi·
;

157 
	}
}

159 
	$xas_adv™˚
(
xa_°©e
 *
xas
)

161 
xas
->
xa_off£t
++;

162 
	`xas_move_ödex
(
xas
, xas->
xa_off£t
);

163 
	}
}

165 *
	$£t_bounds
(
xa_°©e
 *
xas
)

167 
xas
->
xa_node
 = 
XAS_BOUNDS
;

168  
NULL
;

169 
	}
}

178 *
	$xas_°¨t
(
xa_°©e
 *
xas
)

180 *
íåy
;

182 i‡(
	`xas_vÆid
(
xas
))

183  
	`xas_ªlﬂd
(
xas
);

184 i‡(
	`xas_îr‹
(
xas
))

185  
NULL
;

187 
íåy
 = 
	`xa_hód
(
xas
->
xa
);

188 i‡(!
	`xa_is_node
(
íåy
)) {

189 i‡(
xas
->
xa_ödex
)

190  
	`£t_bounds
(
xas
);

192 i‡((
xas
->
xa_ödex
 >> 
	`xa_to_node
(
íåy
)->
shi·
Ë> 
XA_CHUNK_MASK
)

193  
	`£t_bounds
(
xas
);

196 
xas
->
xa_node
 = 
NULL
;

197  
íåy
;

198 
	}
}

201 *
	$xas_des˚nd
(
xa_°©e
 *
xas
, 
xa_node
 *
node
)

203 
off£t
 = 
	`gë_off£t
(
xas
->
xa_ödex
, 
node
);

204 *
íåy
 = 
	`xa_íåy
(
xas
->
xa
, 
node
, 
off£t
);

206 
	`¥ötk
("xas_descend called\n");

207 
xas
->
xa_node
 = 
node
;

208 i‡(
	`xa_is_siblög
(
íåy
)) {

209 
off£t
 = 
	`xa_to_siblög
(
íåy
);

210 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, 
node
, 
off£t
);

213 
xas
->
xa_off£t
 = 
off£t
;

214  
íåy
;

215 
	}
}

232 *
	$xas_lﬂd
(
xa_°©e
 *
xas
)

234 *
íåy
 = 
	`xas_°¨t
(
xas
);

235 
	`¥ötk
("xas_load called\n");

236 
	`xa_is_node
(
íåy
)) {

237 
xa_node
 *
node
 = 
	`xa_to_node
(
íåy
);

239 i‡(
xas
->
xa_shi·
 > 
node
->
shi·
)

241 
íåy
 = 
	`xas_des˚nd
(
xas
, 
node
);

242 i‡(
node
->
shi·
 == 0)

245  
íåy
;

246 
	}
}

250 
kmem_ˇche
 *
ødix_åì_node_ˇchï
;

251 
ødix_åì_node_rcu_‰ì
(
rcu_hód
 *
hód
);

253 
	#XA_RCU_FREE
 ((
x¨øy
 *)1)

	)

255 
	$xa_node_‰ì
(
xa_node
 *
node
)

257 
	`XA_NODE_BUG_ON
(
node
, !
	`li°_em±y
(&node->
¥iv©e_li°
));

258 
node
->
¨øy
 = 
XA_RCU_FREE
;

259 
	`ˇŒ_rcu
(&
node
->
rcu_hód
, 
ødix_åì_node_rcu_‰ì
);

260 
	}
}

268 
	$xas_de°roy
(
xa_°©e
 *
xas
)

270 
xa_node
 *
node
 = 
xas
->
xa_Æloc
;

272 i‡(!
node
)

274 
	`XA_NODE_BUG_ON
(
node
, !
	`li°_em±y
(&node->
¥iv©e_li°
));

275 
	`kmem_ˇche_‰ì
(
ødix_åì_node_ˇchï
, 
node
);

276 
xas
->
xa_Æloc
 = 
NULL
;

277 
	}
}

297 
boﬁ
 
	$xas_nomem
(
xa_°©e
 *
xas
, 
gÂ_t
 
gÂ
)

299 i‡(
xas
->
xa_node
 !
	`XA_ERROR
(-
ENOMEM
)) {

300 
	`xas_de°roy
(
xas
);

301  
Ál£
;

303 
xas
->
xa_Æloc
 = 
	`kmem_ˇche_Æloc
(
ødix_åì_node_ˇchï
, 
gÂ
);

304 i‡(!
xas
->
xa_Æloc
)

305  
Ál£
;

306 
	`XA_NODE_BUG_ON
(
xas
->
xa_Æloc
, !
	`li°_em±y
(&xas->xa_Æloc->
¥iv©e_li°
));

307 
xas
->
xa_node
 = 
XAS_RESTART
;

308  
åue
;

309 
	}
}

321 
boﬁ
 
	$__xas_nomem
(
xa_°©e
 *
xas
, 
gÂ_t
 
gÂ
)

322 
	`__mu°_hﬁd
(
xas
->
xa
->
xa_lock
)

324 
lock_ty≥
 = 
	`xa_lock_ty≥
(
xas
->
xa
);

326 i‡(
xas
->
xa_node
 !
	`XA_ERROR
(-
ENOMEM
)) {

327 
	`xas_de°roy
(
xas
);

328  
Ál£
;

330 i‡(
	`gÂÊags_Ælow_blockög
(
gÂ
)) {

331 
	`xas_u∆ock_ty≥
(
xas
, 
lock_ty≥
);

332 
xas
->
xa_Æloc
 = 
	`kmem_ˇche_Æloc
(
ødix_åì_node_ˇchï
, 
gÂ
);

333 
	`xas_lock_ty≥
(
xas
, 
lock_ty≥
);

335 
xas
->
xa_Æloc
 = 
	`kmem_ˇche_Æloc
(
ødix_åì_node_ˇchï
, 
gÂ
);

337 i‡(!
xas
->
xa_Æloc
)

338  
Ál£
;

339 
	`XA_NODE_BUG_ON
(
xas
->
xa_Æloc
, !
	`li°_em±y
(&xas->xa_Æloc->
¥iv©e_li°
));

340 
xas
->
xa_node
 = 
XAS_RESTART
;

341  
åue
;

342 
	}
}

344 
	$xas_upd©e
(
xa_°©e
 *
xas
, 
xa_node
 *
node
)

346 i‡(
xas
->
xa_upd©e
)

347 
xas
->
	`xa_upd©e
(
node
);

349 
	`XA_NODE_BUG_ON
(
node
, !
	`li°_em±y
(&node->
¥iv©e_li°
));

350 
	}
}

352 *
	$xas_Æloc
(
xa_°©e
 *
xas
, 
shi·
)

354 
xa_node
 *
∑ª¡
 = 
xas
->xa_node;

355 
xa_node
 *
node
 = 
xas
->
xa_Æloc
;

357 i‡(
	`xas_övÆid
(
xas
))

358  
NULL
;

360 i‡(
node
) {

361 
xas
->
xa_Æloc
 = 
NULL
;

363 
node
 = 
	`kmem_ˇche_Æloc
(
ødix_åì_node_ˇchï
,

364 
GFP_NOWAIT
 | 
__GFP_NOWARN
);

365 i‡(!
node
) {

366 
	`xas_£t_îr
(
xas
, -
ENOMEM
);

367  
NULL
;

371 i‡(
∑ª¡
) {

372 
node
->
off£t
 = 
xas
->
xa_off£t
;

373 
∑ª¡
->
cou¡
++;

374 
	`XA_NODE_BUG_ON
(
node
, 
∑ª¡
->
cou¡
 > 
XA_CHUNK_SIZE
);

375 
	`xas_upd©e
(
xas
, 
∑ª¡
);

377 
	`XA_NODE_BUG_ON
(
node
, 
shi·
 > 
BITS_PER_LONG
);

378 
	`XA_NODE_BUG_ON
(
node
, !
	`li°_em±y
(&node->
¥iv©e_li°
));

379 
node
->
shi·
 = shift;

380 
node
->
cou¡
 = 0;

381 
node
->
ƒ_vÆues
 = 0;

382 
	`RCU_INIT_POINTER
(
node
->
∑ª¡
, 
xas
->
xa_node
);

383 
node
->
¨øy
 = 
xas
->
xa
;

385  
node
;

386 
	}
}

388 #ifde‡
CONFIG_XARRAY_MULTI


390 
	$xas_size
(c⁄° 
xa_°©e
 *
xas
)

392  (
xas
->
xa_sibs
 + 1ULË<< xas->
xa_shi·
;

393 
	}
}

402 
	$xas_max
(
xa_°©e
 *
xas
)

404 
max
 = 
xas
->
xa_ödex
;

406 #ifde‡
CONFIG_XARRAY_MULTI


407 i‡(
xas
->
xa_shi·
 || xas->
xa_sibs
) {

408 
mask
 = 
	`xas_size
(
xas
) - 1;

409 
max
 |
mask
;

410 i‡(
mask
 =
max
)

411 
max
++;

415  
max
;

416 
	}
}

419 
	$max_ödex
(*
íåy
)

421 i‡(!
	`xa_is_node
(
íåy
))

423  (
XA_CHUNK_SIZE
 << 
	`xa_to_node
(
íåy
)->
shi·
) - 1;

424 
	}
}

426 
	$xas_shrök
(
xa_°©e
 *
xas
)

428 
x¨øy
 *
xa
 = 
xas
->xa;

429 
xa_node
 *
node
 = 
xas
->xa_node;

432 *
íåy
;

434 
	`XA_NODE_BUG_ON
(
node
,Çode->
cou¡
 > 
XA_CHUNK_SIZE
);

435 i‡(
node
->
cou¡
 != 1)

437 
íåy
 = 
	`xa_íåy_locked
(
xa
, 
node
, 0);

438 i‡(!
íåy
)

440 i‡(!
	`xa_is_node
(
íåy
Ë&& 
node
->
shi·
)

442 i‡(
	`xa_is_zîo
(
íåy
Ë&& 
	`xa_zîo_busy
(
xa
))

443 
íåy
 = 
NULL
;

444 
xas
->
xa_node
 = 
XAS_BOUNDS
;

446 
	`RCU_INIT_POINTER
(
xa
->
xa_hód
, 
íåy
);

447 i‡(
	`xa_åack_‰ì
(
xa
Ë&& !
	`node_gë_m¨k
(
node
, 0, 
XA_FREE_MARK
))

448 
	`xa_m¨k_˛ór
(
xa
, 
XA_FREE_MARK
);

450 
node
->
cou¡
 = 0;

451 
node
->
ƒ_vÆues
 = 0;

452 i‡(!
	`xa_is_node
(
íåy
))

453 
	`RCU_INIT_POINTER
(
node
->
¶Ÿs
[0], 
XA_RETRY_ENTRY
);

454 
	`xas_upd©e
(
xas
, 
node
);

455 
	`xa_node_‰ì
(
node
);

456 i‡(!
	`xa_is_node
(
íåy
))

458 
node
 = 
	`xa_to_node
(
íåy
);

459 
node
->
∑ª¡
 = 
NULL
;

461 
	}
}

470 
	$xas_dñëe_node
(
xa_°©e
 *
xas
)

472 
xa_node
 *
node
 = 
xas
->xa_node;

475 
xa_node
 *
∑ª¡
;

477 
	`XA_NODE_BUG_ON
(
node
,Çode->
cou¡
 > 
XA_CHUNK_SIZE
);

478 i‡(
node
->
cou¡
)

481 
∑ª¡
 = 
	`xa_∑ª¡_locked
(
xas
->
xa
, 
node
);

482 
xas
->
xa_node
 = 
∑ª¡
;

483 
xas
->
xa_off£t
 = 
node
->
off£t
;

484 
	`xa_node_‰ì
(
node
);

486 i‡(!
∑ª¡
) {

487 
xas
->
xa
->
xa_hód
 = 
NULL
;

488 
xas
->
xa_node
 = 
XAS_BOUNDS
;

492 
∑ª¡
->
¶Ÿs
[
xas
->
xa_off£t
] = 
NULL
;

493 
∑ª¡
->
cou¡
--;

494 
	`XA_NODE_BUG_ON
(
∑ª¡
,Ö¨ít->
cou¡
 > 
XA_CHUNK_SIZE
);

495 
node
 = 
∑ª¡
;

496 
	`xas_upd©e
(
xas
, 
node
);

499 i‡(!
node
->
∑ª¡
)

500 
	`xas_shrök
(
xas
);

501 
	}
}

512 
	$xas_‰ì_nodes
(
xa_°©e
 *
xas
, 
xa_node
 *
t›
)

514 
off£t
 = 0;

515 
xa_node
 *
node
 = 
t›
;

518 *
íåy
 = 
	`xa_íåy_locked
(
xas
->
xa
, 
node
, 
off£t
);

520 i‡(
node
->
shi·
 && 
	`xa_is_node
(
íåy
)) {

521 
node
 = 
	`xa_to_node
(
íåy
);

522 
off£t
 = 0;

525 i‡(
íåy
)

526 
	`RCU_INIT_POINTER
(
node
->
¶Ÿs
[
off£t
], 
XA_RETRY_ENTRY
);

527 
off£t
++;

528 
off£t
 =
XA_CHUNK_SIZE
) {

529 
xa_node
 *
∑ª¡
;

531 
∑ª¡
 = 
	`xa_∑ª¡_locked
(
xas
->
xa
, 
node
);

532 
off£t
 = 
node
->offset + 1;

533 
node
->
cou¡
 = 0;

534 
node
->
ƒ_vÆues
 = 0;

535 
	`xas_upd©e
(
xas
, 
node
);

536 
	`xa_node_‰ì
(
node
);

537 i‡(
node
 =
t›
)

539 
node
 = 
∑ª¡
;

542 
	}
}

548 
	$xas_ex∑nd
(
xa_°©e
 *
xas
, *
hód
)

550 
x¨øy
 *
xa
 = 
xas
->xa;

551 
xa_node
 *
node
 = 
NULL
;

552 
shi·
 = 0;

553 
max
 = 
	`xas_max
(
xas
);

555 i‡(!
hód
) {

556 i‡(
max
 == 0)

558 (
max
 >> 
shi·
Ë>
XA_CHUNK_SIZE
)

559 
shi·
 +
XA_CHUNK_SHIFT
;

560  
shi·
 + 
XA_CHUNK_SHIFT
;

561 } i‡(
	`xa_is_node
(
hód
)) {

562 
node
 = 
	`xa_to_node
(
hód
);

563 
shi·
 = 
node
->shi· + 
XA_CHUNK_SHIFT
;

565 
xas
->
xa_node
 = 
NULL
;

567 
max
 > 
	`max_ödex
(
hód
)) {

568 
xa_m¨k_t
 
m¨k
 = 0;

570 
	`XA_NODE_BUG_ON
(
node
, 
shi·
 > 
BITS_PER_LONG
);

571 
node
 = 
	`xas_Æloc
(
xas
, 
shi·
);

572 i‡(!
node
)

573  -
ENOMEM
;

575 
node
->
cou¡
 = 1;

576 i‡(
	`xa_is_vÆue
(
hód
))

577 
node
->
ƒ_vÆues
 = 1;

578 
	`RCU_INIT_POINTER
(
node
->
¶Ÿs
[0], 
hód
);

582 i‡(
	`xa_åack_‰ì
(
xa
Ë&& 
m¨k
 =
XA_FREE_MARK
) {

583 
	`node_m¨k_Æl
(
node
, 
XA_FREE_MARK
);

584 i‡(!
	`xa_m¨ked
(
xa
, 
XA_FREE_MARK
)) {

585 
	`node_˛ór_m¨k
(
node
, 0, 
XA_FREE_MARK
);

586 
	`xa_m¨k_£t
(
xa
, 
XA_FREE_MARK
);

588 } i‡(
	`xa_m¨ked
(
xa
, 
m¨k
)) {

589 
	`node_£t_m¨k
(
node
, 0, 
m¨k
);

591 i‡(
m¨k
 =
XA_MARK_MAX
)

593 
	`m¨k_öc
(
m¨k
);

600 i‡(
	`xa_is_node
(
hód
)) {

601 
	`xa_to_node
(
hód
)->
off£t
 = 0;

602 
	`rcu_assign_poöãr
(
	`xa_to_node
(
hód
)->
∑ª¡
, 
node
);

604 
hód
 = 
	`xa_mk_node
(
node
);

605 
	`rcu_assign_poöãr
(
xa
->
xa_hód
, 
hód
);

606 
	`xas_upd©e
(
xas
, 
node
);

608 
shi·
 +
XA_CHUNK_SHIFT
;

611 
xas
->
xa_node
 = 
node
;

612  
shi·
;

613 
	}
}

628 *
	$xas_¸óã
(
xa_°©e
 *
xas
, 
boﬁ
 
Ælow_roŸ
)

630 
x¨øy
 *
xa
 = 
xas
->xa;

631 *
íåy
;

632 
__rcu
 **
¶Ÿ
;

633 
xa_node
 *
node
 = 
xas
->xa_node;

634 
shi·
;

635 
‹dî
 = 
xas
->
xa_shi·
;

637 i‡(
	`xas_t›
(
node
)) {

638 
íåy
 = 
	`xa_hód_locked
(
xa
);

639 
xas
->
xa_node
 = 
NULL
;

640 i‡(!
íåy
 && 
	`xa_zîo_busy
(
xa
))

641 
íåy
 = 
XA_ZERO_ENTRY
;

642 
shi·
 = 
	`xas_ex∑nd
(
xas
, 
íåy
);

643 i‡(
shi·
 < 0)

644  
NULL
;

645 i‡(!
shi·
 && !
Ælow_roŸ
)

646 
shi·
 = 
XA_CHUNK_SHIFT
;

647 
íåy
 = 
	`xa_hód_locked
(
xa
);

648 
¶Ÿ
 = &
xa
->
xa_hód
;

649 } i‡(
	`xas_îr‹
(
xas
)) {

650  
NULL
;

651 } i‡(
node
) {

652 
off£t
 = 
xas
->
xa_off£t
;

654 
shi·
 = 
node
->shift;

655 
íåy
 = 
	`xa_íåy_locked
(
xa
, 
node
, 
off£t
);

656 
¶Ÿ
 = &
node
->
¶Ÿs
[
off£t
];

658 
shi·
 = 0;

659 
íåy
 = 
	`xa_hód_locked
(
xa
);

660 
¶Ÿ
 = &
xa
->
xa_hód
;

663 
shi·
 > 
‹dî
) {

664 
shi·
 -
XA_CHUNK_SHIFT
;

665 i‡(!
íåy
) {

666 
node
 = 
	`xas_Æloc
(
xas
, 
shi·
);

667 i‡(!
node
)

669 i‡(
	`xa_åack_‰ì
(
xa
))

670 
	`node_m¨k_Æl
(
node
, 
XA_FREE_MARK
);

671 
	`rcu_assign_poöãr
(*
¶Ÿ
, 
	`xa_mk_node
(
node
));

672 } i‡(
	`xa_is_node
(
íåy
)) {

673 
node
 = 
	`xa_to_node
(
íåy
);

677 
íåy
 = 
	`xas_des˚nd
(
xas
, 
node
);

678 
¶Ÿ
 = &
node
->
¶Ÿs
[
xas
->
xa_off£t
];

681  
íåy
;

682 
	}
}

693 
	$xas_¸óã_ønge
(
xa_°©e
 *
xas
)

695 
ödex
 = 
xas
->
xa_ödex
;

696 
shi·
 = 
xas
->
xa_shi·
;

697 
sibs
 = 
xas
->
xa_sibs
;

699 
xas
->
xa_ödex
 |((
sibs
 + 1Ë<< 
shi·
) - 1;

700 i‡(
	`xas_is_node
(
xas
Ë&& xas->
xa_node
->
shi·
 =xas->
xa_shi·
)

701 
xas
->
xa_off£t
 |
sibs
;

702 
xas
->
xa_shi·
 = 0;

703 
xas
->
xa_sibs
 = 0;

706 
	`xas_¸óã
(
xas
, 
åue
);

707 i‡(
	`xas_îr‹
(
xas
))

708 
ª°‹e
;

709 i‡(
xas
->
xa_ödex
 <(
ödex
 | 
XA_CHUNK_MASK
))

710 
suc˚ss
;

711 
xas
->
xa_ödex
 -
XA_CHUNK_SIZE
;

714 
xa_node
 *
node
 = 
xas
->xa_node;

715 
xas
->
xa_node
 = 
	`xa_∑ª¡_locked
(xas->
xa
, 
node
);

716 
xas
->
xa_off£t
 = 
node
->
off£t
 - 1;

717 i‡(
node
->
off£t
 != 0)

722 
ª°‹e
:

723 
xas
->
xa_shi·
 = 
shi·
;

724 
xas
->
xa_sibs
 = 
sibs
;

725 
xas
->
xa_ödex
 = 
ödex
;

727 
suc˚ss
:

728 
xas
->
xa_ödex
 = 
ödex
;

729 i‡(
xas
->
xa_node
)

730 
	`xas_£t_off£t
(
xas
);

731 
	}
}

734 
	$upd©e_node
(
xa_°©e
 *
xas
, 
xa_node
 *
node
,

735 
cou¡
, 
vÆues
)

737 i‡(!
node
 || (!
cou¡
 && !
vÆues
))

740 
node
->
cou¡
 += count;

741 
node
->
ƒ_vÆues
 +
vÆues
;

742 
	`XA_NODE_BUG_ON
(
node
,Çode->
cou¡
 > 
XA_CHUNK_SIZE
);

743 
	`XA_NODE_BUG_ON
(
node
,Çode->
ƒ_vÆues
 > 
XA_CHUNK_SIZE
);

744 
	`xas_upd©e
(
xas
, 
node
);

745 i‡(
cou¡
 < 0)

746 
	`xas_dñëe_node
(
xas
);

747 
	}
}

762 *
	$xas_°‹e
(
xa_°©e
 *
xas
, *
íåy
)

764 
xa_node
 *
node
;

765 
__rcu
 **
¶Ÿ
 = &
xas
->
xa
->
xa_hód
;

766 
off£t
, 
max
;

767 
cou¡
 = 0;

768 
vÆues
 = 0;

769 *
fú°
, *
√xt
;

770 
boﬁ
 
vÆue
 = 
	`xa_is_vÆue
(
íåy
);

772 i‡(
íåy
) {

773 
boﬁ
 
Ælow_roŸ
 = !
	`xa_is_node
(
íåy
Ë&& !
	`xa_is_zîo
(entry);

774 
fú°
 = 
	`xas_¸óã
(
xas
, 
Ælow_roŸ
);

776 
fú°
 = 
	`xas_lﬂd
(
xas
);

779 i‡(
	`xas_övÆid
(
xas
))

780  
fú°
;

781 
node
 = 
xas
->
xa_node
;

782 i‡(
node
 && (
xas
->
xa_shi·
 <Çode->
shi·
))

783 
xas
->
xa_sibs
 = 0;

784 i‡((
fú°
 =
íåy
Ë&& !
xas
->
xa_sibs
)

785  
fú°
;

787 
√xt
 = 
fú°
;

788 
off£t
 = 
xas
->
xa_off£t
;

789 
max
 = 
xas
->
xa_off£t
 + xas->
xa_sibs
;

790 i‡(
node
) {

791 
¶Ÿ
 = &
node
->
¶Ÿs
[
off£t
];

792 i‡(
xas
->
xa_sibs
)

793 
	`xas_squash_m¨ks
(
xas
);

795 i‡(!
íåy
)

796 
	`xas_öô_m¨ks
(
xas
);

806 
	`rcu_assign_poöãr
(*
¶Ÿ
, 
íåy
);

807 i‡(
	`xa_is_node
(
√xt
Ë&& (!
node
 ||Çode->
shi·
))

808 
	`xas_‰ì_nodes
(
xas
, 
	`xa_to_node
(
√xt
));

809 i‡(!
node
)

811 
cou¡
 +!
√xt
 - !
íåy
;

812 
vÆues
 +!
	`xa_is_vÆue
(
fú°
Ë- !
vÆue
;

813 i‡(
íåy
) {

814 i‡(
off£t
 =
max
)

816 i‡(!
	`xa_is_siblög
(
íåy
))

817 
íåy
 = 
	`xa_mk_siblög
(
xas
->
xa_off£t
);

819 i‡(
off£t
 =
XA_CHUNK_MASK
)

822 
√xt
 = 
	`xa_íåy_locked
(
xas
->
xa
, 
node
, ++
off£t
);

823 i‡(!
	`xa_is_siblög
(
√xt
)) {

824 i‡(!
íåy
 && (
off£t
 > 
max
))

826 
fú°
 = 
√xt
;

828 
¶Ÿ
++;

831 
	`upd©e_node
(
xas
, 
node
, 
cou¡
, 
vÆues
);

832  
fú°
;

833 
	}
}

844 
boﬁ
 
	$xas_gë_m¨k
(c⁄° 
xa_°©e
 *
xas
, 
xa_m¨k_t
 
m¨k
)

846 i‡(
	`xas_övÆid
(
xas
))

847  
Ál£
;

848 i‡(!
xas
->
xa_node
)

849  
	`xa_m¨ked
(
xas
->
xa
, 
m¨k
);

850  
	`node_gë_m¨k
(
xas
->
xa_node
, xas->
xa_off£t
, 
m¨k
);

851 
	}
}

863 
	$xas_£t_m¨k
(c⁄° 
xa_°©e
 *
xas
, 
xa_m¨k_t
 
m¨k
)

865 
xa_node
 *
node
 = 
xas
->xa_node;

866 
off£t
 = 
xas
->
xa_off£t
;

868 i‡(
	`xas_övÆid
(
xas
))

871 
node
) {

872 i‡(
	`node_£t_m¨k
(
node
, 
off£t
, 
m¨k
))

874 
off£t
 = 
node
->offset;

875 
node
 = 
	`xa_∑ª¡_locked
(
xas
->
xa
,Çode);

878 i‡(!
	`xa_m¨ked
(
xas
->
xa
, 
m¨k
))

879 
	`xa_m¨k_£t
(
xas
->
xa
, 
m¨k
);

880 
	}
}

892 
	$xas_˛ór_m¨k
(c⁄° 
xa_°©e
 *
xas
, 
xa_m¨k_t
 
m¨k
)

894 
xa_node
 *
node
 = 
xas
->xa_node;

895 
off£t
 = 
xas
->
xa_off£t
;

897 i‡(
	`xas_övÆid
(
xas
))

900 
node
) {

901 i‡(!
	`node_˛ór_m¨k
(
node
, 
off£t
, 
m¨k
))

903 i‡(
	`node_™y_m¨k
(
node
, 
m¨k
))

906 
off£t
 = 
node
->offset;

907 
node
 = 
	`xa_∑ª¡_locked
(
xas
->
xa
,Çode);

910 i‡(
	`xa_m¨ked
(
xas
->
xa
, 
m¨k
))

911 
	`xa_m¨k_˛ór
(
xas
->
xa
, 
m¨k
);

912 
	}
}

926 
	$xas_öô_m¨ks
(c⁄° 
xa_°©e
 *
xas
)

928 
xa_m¨k_t
 
m¨k
 = 0;

931 i‡(
	`xa_åack_‰ì
(
xas
->
xa
Ë&& 
m¨k
 =
XA_FREE_MARK
)

932 
	`xas_£t_m¨k
(
xas
, 
m¨k
);

934 
	`xas_˛ór_m¨k
(
xas
, 
m¨k
);

935 i‡(
m¨k
 =
XA_MARK_MAX
)

937 
	`m¨k_öc
(
m¨k
);

939 
	}
}

957 
	$xas_∑u£
(
xa_°©e
 *
xas
)

959 
xa_node
 *
node
 = 
xas
->xa_node;

961 i‡(
	`xas_övÆid
(
xas
))

964 i‡(
node
) {

965 
off£t
 = 
xas
->
xa_off£t
;

966 ++
off£t
 < 
XA_CHUNK_SIZE
) {

967 i‡(!
	`xa_is_siblög
(
	`xa_íåy
(
xas
->
xa
, 
node
, 
off£t
)))

970 
xas
->
xa_ödex
 +(
off£t
 - xas->
xa_off£t
Ë<< 
node
->
shi·
;

972 
xas
->
xa_ödex
++;

974 
xas
->
xa_node
 = 
XAS_RESTART
;

975 
	}
}

985 *
	$__xas_¥ev
(
xa_°©e
 *
xas
)

987 *
íåy
;

989 i‡(!
	`xas_‰ozí
(
xas
->
xa_node
))

990 
xas
->
xa_ödex
--;

991 i‡(
	`xas_nŸ_node
(
xas
->
xa_node
))

992  
	`xas_lﬂd
(
xas
);

994 i‡(
xas
->
xa_off£t
 !
	`gë_off£t
(xas->
xa_ödex
, xas->
xa_node
))

995 
xas
->
xa_off£t
--;

997 
xas
->
xa_off£t
 == 255) {

998 
xas
->
xa_off£t
 = xas->
xa_node
->
off£t
 - 1;

999 
xas
->
xa_node
 = 
	`xa_∑ª¡
(xas->
xa
, xas->xa_node);

1000 i‡(!
xas
->
xa_node
)

1001  
	`£t_bounds
(
xas
);

1005 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, xas->
xa_node
, xas->
xa_off£t
);

1006 i‡(!
	`xa_is_node
(
íåy
))

1007  
íåy
;

1009 
xas
->
xa_node
 = 
	`xa_to_node
(
íåy
);

1010 
	`xas_£t_off£t
(
xas
);

1012 
	}
}

1022 *
	$__xas_√xt
(
xa_°©e
 *
xas
)

1024 *
íåy
;

1026 i‡(!
	`xas_‰ozí
(
xas
->
xa_node
))

1027 
xas
->
xa_ödex
++;

1028 i‡(
	`xas_nŸ_node
(
xas
->
xa_node
))

1029  
	`xas_lﬂd
(
xas
);

1031 i‡(
xas
->
xa_off£t
 !
	`gë_off£t
(xas->
xa_ödex
, xas->
xa_node
))

1032 
xas
->
xa_off£t
++;

1034 
xas
->
xa_off£t
 =
XA_CHUNK_SIZE
) {

1035 
xas
->
xa_off£t
 = xas->
xa_node
->
off£t
 + 1;

1036 
xas
->
xa_node
 = 
	`xa_∑ª¡
(xas->
xa
, xas->xa_node);

1037 i‡(!
xas
->
xa_node
)

1038  
	`£t_bounds
(
xas
);

1042 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, xas->
xa_node
, xas->
xa_off£t
);

1043 i‡(!
	`xa_is_node
(
íåy
))

1044  
íåy
;

1046 
xas
->
xa_node
 = 
	`xa_to_node
(
íåy
);

1047 
	`xas_£t_off£t
(
xas
);

1049 
	}
}

1068 *
	$xas_föd
(
xa_°©e
 *
xas
, 
max
)

1070 *
íåy
;

1072 i‡(
	`xas_îr‹
(
xas
))

1073  
NULL
;

1075 i‡(!
xas
->
xa_node
) {

1076 
xas
->
xa_ödex
 = 1;

1077  
	`£t_bounds
(
xas
);

1078 } i‡(
	`xas_t›
(
xas
->
xa_node
)) {

1079 
íåy
 = 
	`xas_lﬂd
(
xas
);

1080 i‡(
íåy
 || 
	`xas_nŸ_node
(
xas
->
xa_node
))

1081  
íåy
;

1082 } i‡(!
xas
->
xa_node
->
shi·
 &&

1083 
xas
->
xa_off£t
 !(xas->
xa_ödex
 & 
XA_CHUNK_MASK
)) {

1084 
xas
->
xa_off£t
 = ((xas->
xa_ödex
 - 1Ë& 
XA_CHUNK_MASK
) + 1;

1087 
	`xas_adv™˚
(
xas
);

1089 
xas
->
xa_node
 && (xas->
xa_ödex
 <
max
)) {

1090 i‡(
	`u∆ikñy
(
xas
->
xa_off£t
 =
XA_CHUNK_SIZE
)) {

1091 
xas
->
xa_off£t
 = xas->
xa_node
->
off£t
 + 1;

1092 
xas
->
xa_node
 = 
	`xa_∑ª¡
(xas->
xa
, xas->xa_node);

1096 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, xas->
xa_node
, xas->
xa_off£t
);

1097 i‡(
	`xa_is_node
(
íåy
)) {

1098 
xas
->
xa_node
 = 
	`xa_to_node
(
íåy
);

1099 
xas
->
xa_off£t
 = 0;

1102 i‡(
íåy
 && !
	`xa_is_siblög
(entry))

1103  
íåy
;

1105 
	`xas_adv™˚
(
xas
);

1108 i‡(!
xas
->
xa_node
)

1109 
xas
->
xa_node
 = 
XAS_BOUNDS
;

1110  
NULL
;

1111 
	}
}

1135 *
	$xas_föd_m¨ked
(
xa_°©e
 *
xas
, 
max
, 
xa_m¨k_t
 
m¨k
)

1137 
boﬁ
 
adv™˚
 = 
åue
;

1138 
off£t
;

1139 *
íåy
;

1141 i‡(
	`xas_îr‹
(
xas
))

1142  
NULL
;

1144 i‡(!
xas
->
xa_node
) {

1145 
xas
->
xa_ödex
 = 1;

1146 
out
;

1147 } i‡(
	`xas_t›
(
xas
->
xa_node
)) {

1148 
adv™˚
 = 
Ál£
;

1149 
íåy
 = 
	`xa_hód
(
xas
->
xa
);

1150 
xas
->
xa_node
 = 
NULL
;

1151 i‡(
xas
->
xa_ödex
 > 
	`max_ödex
(
íåy
))

1152 
out
;

1153 i‡(!
	`xa_is_node
(
íåy
)) {

1154 i‡(
	`xa_m¨ked
(
xas
->
xa
, 
m¨k
))

1155  
íåy
;

1156 
xas
->
xa_ödex
 = 1;

1157 
out
;

1159 
xas
->
xa_node
 = 
	`xa_to_node
(
íåy
);

1160 
xas
->
xa_off£t
 = xas->
xa_ödex
 >> xas->
xa_node
->
shi·
;

1163 
xas
->
xa_ödex
 <
max
) {

1164 i‡(
	`u∆ikñy
(
xas
->
xa_off£t
 =
XA_CHUNK_SIZE
)) {

1165 
xas
->
xa_off£t
 = xas->
xa_node
->
off£t
 + 1;

1166 
xas
->
xa_node
 = 
	`xa_∑ª¡
(xas->
xa
, xas->xa_node);

1167 i‡(!
xas
->
xa_node
)

1169 
adv™˚
 = 
Ál£
;

1173 i‡(!
adv™˚
) {

1174 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, xas->
xa_node
, xas->
xa_off£t
);

1175 i‡(
	`xa_is_siblög
(
íåy
)) {

1176 
xas
->
xa_off£t
 = 
	`xa_to_siblög
(
íåy
);

1177 
	`xas_move_ödex
(
xas
, xas->
xa_off£t
);

1181 
off£t
 = 
	`xas_föd_chunk
(
xas
, 
adv™˚
, 
m¨k
);

1182 i‡(
off£t
 > 
xas
->
xa_off£t
) {

1183 
adv™˚
 = 
Ál£
;

1184 
	`xas_move_ödex
(
xas
, 
off£t
);

1186 i‡((
xas
->
xa_ödex
 - 1Ë>
max
)

1187 
max
;

1188 
xas
->
xa_off£t
 = 
off£t
;

1189 i‡(
off£t
 =
XA_CHUNK_SIZE
)

1193 
íåy
 = 
	`xa_íåy
(
xas
->
xa
, xas->
xa_node
, xas->
xa_off£t
);

1194 i‡(!
	`xa_is_node
(
íåy
))

1195  
íåy
;

1196 
xas
->
xa_node
 = 
	`xa_to_node
(
íåy
);

1197 
	`xas_£t_off£t
(
xas
);

1200 
out
:

1201 i‡(
xas
->
xa_ödex
 > 
max
)

1202 
max
;

1203  
	`£t_bounds
(
xas
);

1204 
max
:

1205 
xas
->
xa_node
 = 
XAS_RESTART
;

1206  
NULL
;

1207 
	}
}

1219 *
	$xas_föd_c⁄Êi˘
(
xa_°©e
 *
xas
)

1221 *
cuº
;

1223 i‡(
	`xas_îr‹
(
xas
))

1224  
NULL
;

1226 i‡(!
xas
->
xa_node
)

1227  
NULL
;

1229 i‡(
	`xas_t›
(
xas
->
xa_node
)) {

1230 
cuº
 = 
	`xas_°¨t
(
xas
);

1231 i‡(!
cuº
)

1232  
NULL
;

1233 
	`xa_is_node
(
cuº
)) {

1234 
xa_node
 *
node
 = 
	`xa_to_node
(
cuº
);

1235 
cuº
 = 
	`xas_des˚nd
(
xas
, 
node
);

1237 i‡(
cuº
)

1238  
cuº
;

1241 i‡(
xas
->
xa_node
->
shi·
 > xas->
xa_shi·
)

1242  
NULL
;

1245 i‡(
xas
->
xa_node
->
shi·
 =xas->
xa_shi·
) {

1246 i‡((
xas
->
xa_off£t
 & xas->
xa_sibs
) == xas->xa_sibs)

1248 } i‡(
xas
->
xa_off£t
 =
XA_CHUNK_MASK
) {

1249 
xas
->
xa_off£t
 = xas->
xa_node
->
off£t
;

1250 
xas
->
xa_node
 = 
	`xa_∑ª¡_locked
(xas->
xa
, xas->xa_node);

1251 i‡(!
xas
->
xa_node
)

1255 
cuº
 = 
	`xa_íåy_locked
(
xas
->
xa
, xas->
xa_node
, ++xas->
xa_off£t
);

1256 i‡(
	`xa_is_siblög
(
cuº
))

1258 
	`xa_is_node
(
cuº
)) {

1259 
xas
->
xa_node
 = 
	`xa_to_node
(
cuº
);

1260 
xas
->
xa_off£t
 = 0;

1261 
cuº
 = 
	`xa_íåy_locked
(
xas
->
xa
, xas->
xa_node
, 0);

1263 i‡(
cuº
)

1264  
cuº
;

1266 
xas
->
xa_off£t
 -xas->
xa_sibs
;

1267  
NULL
;

1268 
	}
}

1279 *
	$xa_lﬂd
(
x¨øy
 *
xa
, 
ödex
)

1281 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1282 *
íåy
;

1284 
	`rcu_ªad_lock
();

1286 
íåy
 = 
	`xas_lﬂd
(&
xas
);

1287 i‡(
	`xa_is_zîo
(
íåy
))

1288 
íåy
 = 
NULL
;

1289 } 
	`xas_ªåy
(&
xas
, 
íåy
));

1290 
	`rcu_ªad_u∆ock
();

1292  
íåy
;

1293 
	}
}

1296 *
	$xas_ªsu…
(
xa_°©e
 *
xas
, *
cuº
)

1298 i‡(
	`xa_is_zîo
(
cuº
))

1299  
NULL
;

1300 i‡(
	`xas_îr‹
(
xas
))

1301 
cuº
 = 
xas
->
xa_node
;

1302  
cuº
;

1303 
	}
}

1317 *
	$__xa_îa£
(
x¨øy
 *
xa
, 
ödex
)

1319 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1320  
	`xas_ªsu…
(&
xas
, 
	`xas_°‹e
(&xas, 
NULL
));

1321 
	}
}

1336 *
	$xa_îa£
(
x¨øy
 *
xa
, 
ödex
)

1338 *
íåy
;

1340 
	`xa_lock
(
xa
);

1341 
íåy
 = 
	`__xa_îa£
(
xa
, 
ödex
);

1342 
	`xa_u∆ock
(
xa
);

1344  
íåy
;

1345 
	}
}

1363 *
	$__xa_°‹e
(
x¨øy
 *
xa
, 
ödex
, *
íåy
, 
gÂ_t
 
gÂ
)

1365 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1366 *
cuº
;

1368 i‡(
	`WARN_ON_ONCE
(
	`xa_is_adv™˚d
(
íåy
)))

1369  
	`XA_ERROR
(-
EINVAL
);

1370 i‡(
	`xa_åack_‰ì
(
xa
Ë&& !
íåy
)

1371 
íåy
 = 
XA_ZERO_ENTRY
;

1374 
cuº
 = 
	`xas_°‹e
(&
xas
, 
íåy
);

1375 i‡(
	`xa_åack_‰ì
(
xa
))

1376 
	`xas_˛ór_m¨k
(&
xas
, 
XA_FREE_MARK
);

1377 } 
	`__xas_nomem
(&
xas
, 
gÂ
));

1379  
	`xas_ªsu…
(&
xas
, 
cuº
);

1380 
	}
}

1400 *
	$xa_°‹e
(
x¨øy
 *
xa
, 
ödex
, *
íåy
, 
gÂ_t
 
gÂ
)

1402 *
cuº
;

1404 
	`xa_lock
(
xa
);

1405 
cuº
 = 
	`__xa_°‹e
(
xa
, 
ödex
, 
íåy
, 
gÂ
);

1406 
	`xa_u∆ock
(
xa
);

1408  
cuº
;

1409 
	}
}

1428 *
	$__xa_cmpxchg
(
x¨øy
 *
xa
, 
ödex
,

1429 *
ﬁd
, *
íåy
, 
gÂ_t
 
gÂ
)

1431 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1432 *
cuº
;

1434 i‡(
	`WARN_ON_ONCE
(
	`xa_is_adv™˚d
(
íåy
)))

1435  
	`XA_ERROR
(-
EINVAL
);

1438 
cuº
 = 
	`xas_lﬂd
(&
xas
);

1439 i‡(
cuº
 =
ﬁd
) {

1440 
	`xas_°‹e
(&
xas
, 
íåy
);

1441 i‡(
	`xa_åack_‰ì
(
xa
Ë&& 
íåy
 && !
cuº
)

1442 
	`xas_˛ór_m¨k
(&
xas
, 
XA_FREE_MARK
);

1444 } 
	`__xas_nomem
(&
xas
, 
gÂ
));

1446  
	`xas_ªsu…
(&
xas
, 
cuº
);

1447 
	}
}

1466 
	$__xa_ö£π
(
x¨øy
 *
xa
, 
ödex
, *
íåy
, 
gÂ_t
 
gÂ
)

1468 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1469 *
cuº
;

1471 i‡(
	`WARN_ON_ONCE
(
	`xa_is_adv™˚d
(
íåy
)))

1472  -
EINVAL
;

1473 i‡(!
íåy
)

1474 
íåy
 = 
XA_ZERO_ENTRY
;

1477 
cuº
 = 
	`xas_lﬂd
(&
xas
);

1478 i‡(!
cuº
) {

1479 
	`xas_°‹e
(&
xas
, 
íåy
);

1480 i‡(
	`xa_åack_‰ì
(
xa
))

1481 
	`xas_˛ór_m¨k
(&
xas
, 
XA_FREE_MARK
);

1483 
	`xas_£t_îr
(&
xas
, -
EBUSY
);

1485 } 
	`__xas_nomem
(&
xas
, 
gÂ
));

1487  
	`xas_îr‹
(&
xas
);

1488 
	}
}

1491 #ifde‡
CONFIG_XARRAY_MULTI


1492 
	$xas_£t_ønge
(
xa_°©e
 *
xas
, 
fú°
,

1493 
œ°
)

1495 
shi·
 = 0;

1496 
sibs
 = 
œ°
 - 
fú°
;

1497 
off£t
 = 
XA_CHUNK_MASK
;

1499 
	`xas_£t
(
xas
, 
fú°
);

1501 (
fú°
 & 
XA_CHUNK_MASK
) == 0) {

1502 i‡(
sibs
 < 
XA_CHUNK_MASK
)

1504 i‡((
sibs
 =
XA_CHUNK_MASK
Ë&& (
off£t
 < XA_CHUNK_MASK))

1506 
shi·
 +
XA_CHUNK_SHIFT
;

1507 i‡(
off£t
 =
XA_CHUNK_MASK
)

1508 
off£t
 = 
sibs
 & 
XA_CHUNK_MASK
;

1509 
sibs
 >>
XA_CHUNK_SHIFT
;

1510 
fú°
 >>
XA_CHUNK_SHIFT
;

1513 
off£t
 = 
fú°
 & 
XA_CHUNK_MASK
;

1514 i‡(
off£t
 + 
sibs
 > 
XA_CHUNK_MASK
)

1515 
sibs
 = 
XA_CHUNK_MASK
 - 
off£t
;

1516 i‡((((
fú°
 + 
sibs
 + 1Ë<< 
shi·
Ë- 1Ë> 
œ°
)

1517 
sibs
 -= 1;

1519 
xas
->
xa_shi·
 = 
shi·
;

1520 
xas
->
xa_sibs
 = 
sibs
;

1521 
	}
}

1541 *
	$xa_°‹e_ønge
(
x¨øy
 *
xa
, 
fú°
,

1542 
œ°
, *
íåy
, 
gÂ_t
 
gÂ
)

1544 
	`XA_STATE
(
xas
, 
xa
, 0);

1546 i‡(
	`WARN_ON_ONCE
(
	`xa_is_öã∫Æ
(
íåy
)))

1547  
	`XA_ERROR
(-
EINVAL
);

1548 i‡(
œ°
 < 
fú°
)

1549  
	`XA_ERROR
(-
EINVAL
);

1552 
	`xas_lock
(&
xas
);

1553 i‡(
íåy
) {

1554 
‹dî
 = 
BITS_PER_LONG
;

1555 i‡(
œ°
 + 1)

1556 
‹dî
 = 
	`__ffs
(
œ°
 + 1);

1557 
	`xas_£t_‹dî
(&
xas
, 
œ°
, 
‹dî
);

1558 
	`xas_¸óã
(&
xas
, 
åue
);

1559 i‡(
	`xas_îr‹
(&
xas
))

1560 
u∆ock
;

1563 
	`xas_£t_ønge
(&
xas
, 
fú°
, 
œ°
);

1564 
	`xas_°‹e
(&
xas
, 
íåy
);

1565 i‡(
	`xas_îr‹
(&
xas
))

1566 
u∆ock
;

1567 
fú°
 +
	`xas_size
(&
xas
);

1568 } 
fú°
 <
œ°
);

1569 
u∆ock
:

1570 
	`xas_u∆ock
(&
xas
);

1571 } 
	`xas_nomem
(&
xas
, 
gÂ
));

1573  
	`xas_ªsu…
(&
xas
, 
NULL
);

1574 
	}
}

1595 
	$__xa_Æloc
(
x¨øy
 *
xa
, 
u32
 *
id
, *
íåy
,

1596 
xa_limô
 
limô
, 
gÂ_t
 
gÂ
)

1598 
	`XA_STATE
(
xas
, 
xa
, 0);

1600 i‡(
	`WARN_ON_ONCE
(
	`xa_is_adv™˚d
(
íåy
)))

1601  -
EINVAL
;

1602 i‡(
	`WARN_ON_ONCE
(!
	`xa_åack_‰ì
(
xa
)))

1603  -
EINVAL
;

1605 i‡(!
íåy
)

1606 
íåy
 = 
XA_ZERO_ENTRY
;

1609 
xas
.
xa_ödex
 = 
limô
.
mö
;

1610 
	`xas_föd_m¨ked
(&
xas
, 
limô
.
max
, 
XA_FREE_MARK
);

1611 i‡(
xas
.
xa_node
 =
XAS_RESTART
)

1612 
	`xas_£t_îr
(&
xas
, -
EBUSY
);

1614 *
id
 = 
xas
.
xa_ödex
;

1615 
	`xas_°‹e
(&
xas
, 
íåy
);

1616 
	`xas_˛ór_m¨k
(&
xas
, 
XA_FREE_MARK
);

1617 } 
	`__xas_nomem
(&
xas
, 
gÂ
));

1619  
	`xas_îr‹
(&
xas
);

1620 
	}
}

1644 
	$__xa_Æloc_cy˛ic
(
x¨øy
 *
xa
, 
u32
 *
id
, *
íåy
,

1645 
xa_limô
 
limô
, 
u32
 *
√xt
, 
gÂ_t
 
gÂ
)

1647 
u32
 
mö
 = 
limô
.min;

1648 
ªt
;

1650 
limô
.
mö
 = 
	`max
(mö, *
√xt
);

1651 
ªt
 = 
	`__xa_Æloc
(
xa
, 
id
, 
íåy
, 
limô
, 
gÂ
);

1652 i‡((
xa
->
xa_Êags
 & 
XA_FLAGS_ALLOC_WRAPPED
Ë&& 
ªt
 == 0) {

1653 
xa
->
xa_Êags
 &~
XA_FLAGS_ALLOC_WRAPPED
;

1654 
ªt
 = 1;

1657 i‡(
ªt
 < 0 && 
limô
.
mö
 > min) {

1658 
limô
.
mö
 = min;

1659 
ªt
 = 
	`__xa_Æloc
(
xa
, 
id
, 
íåy
, 
limô
, 
gÂ
);

1660 i‡(
ªt
 == 0)

1661 
ªt
 = 1;

1664 i‡(
ªt
 >= 0) {

1665 *
√xt
 = *
id
 + 1;

1666 i‡(*
√xt
 == 0)

1667 
xa
->
xa_Êags
 |
XA_FLAGS_ALLOC_WRAPPED
;

1669  
ªt
;

1670 
	}
}

1683 
	$__xa_£t_m¨k
(
x¨øy
 *
xa
, 
ödex
, 
xa_m¨k_t
 
m¨k
)

1685 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1686 *
íåy
 = 
	`xas_lﬂd
(&
xas
);

1688 i‡(
íåy
)

1689 
	`xas_£t_m¨k
(&
xas
, 
m¨k
);

1690 
	}
}

1701 
	$__xa_˛ór_m¨k
(
x¨øy
 *
xa
, 
ödex
, 
xa_m¨k_t
 
m¨k
)

1703 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1704 *
íåy
 = 
	`xas_lﬂd
(&
xas
);

1706 i‡(
íåy
)

1707 
	`xas_˛ór_m¨k
(&
xas
, 
m¨k
);

1708 
	}
}

1723 
boﬁ
 
	$xa_gë_m¨k
(
x¨øy
 *
xa
, 
ödex
, 
xa_m¨k_t
 
m¨k
)

1725 
	`XA_STATE
(
xas
, 
xa
, 
ödex
);

1726 *
íåy
;

1728 
	`rcu_ªad_lock
();

1729 
íåy
 = 
	`xas_°¨t
(&
xas
);

1730 
	`xas_gë_m¨k
(&
xas
, 
m¨k
)) {

1731 i‡(!
	`xa_is_node
(
íåy
))

1732 
found
;

1733 
íåy
 = 
	`xas_des˚nd
(&
xas
, 
	`xa_to_node
(entry));

1735 
	`rcu_ªad_u∆ock
();

1736  
Ál£
;

1737 
found
:

1738 
	`rcu_ªad_u∆ock
();

1739  
åue
;

1740 
	}
}

1753 
	$xa_£t_m¨k
(
x¨øy
 *
xa
, 
ödex
, 
xa_m¨k_t
 
m¨k
)

1755 
	`xa_lock
(
xa
);

1756 
	`__xa_£t_m¨k
(
xa
, 
ödex
, 
m¨k
);

1757 
	`xa_u∆ock
(
xa
);

1758 
	}
}

1771 
	$xa_˛ór_m¨k
(
x¨øy
 *
xa
, 
ödex
, 
xa_m¨k_t
 
m¨k
)

1773 
	`xa_lock
(
xa
);

1774 
	`__xa_˛ór_m¨k
(
xa
, 
ödex
, 
m¨k
);

1775 
	`xa_u∆ock
(
xa
);

1776 
	}
}

1796 *
	$xa_föd
(
x¨øy
 *
xa
, *
ödexp
,

1797 
max
, 
xa_m¨k_t
 
fûãr
)

1799 
	`XA_STATE
(
xas
, 
xa
, *
ödexp
);

1800 *
íåy
;

1802 
	`rcu_ªad_lock
();

1804 i‡((
__f‹˚
 )
fûãr
 < 
XA_MAX_MARKS
)

1805 
íåy
 = 
	`xas_föd_m¨ked
(&
xas
, 
max
, 
fûãr
);

1807 
íåy
 = 
	`xas_föd
(&
xas
, 
max
);

1808 } 
	`xas_ªåy
(&
xas
, 
íåy
));

1809 
	`rcu_ªad_u∆ock
();

1811 i‡(
íåy
)

1812 *
ödexp
 = 
xas
.
xa_ödex
;

1813  
íåy
;

1814 
	}
}

1834 *
	$xa_föd_a·î
(
x¨øy
 *
xa
, *
ödexp
,

1835 
max
, 
xa_m¨k_t
 
fûãr
)

1837 
	`XA_STATE
(
xas
, 
xa
, *
ödexp
 + 1);

1838 *
íåy
;

1840 
	`rcu_ªad_lock
();

1842 i‡((
__f‹˚
 )
fûãr
 < 
XA_MAX_MARKS
)

1843 
íåy
 = 
	`xas_föd_m¨ked
(&
xas
, 
max
, 
fûãr
);

1845 
íåy
 = 
	`xas_föd
(&
xas
, 
max
);

1846 i‡(
xas
.
xa_node
 =
XAS_BOUNDS
)

1848 i‡(
xas
.
xa_shi·
) {

1849 i‡(
xas
.
xa_ödex
 & ((1UL << xas.
xa_shi·
) - 1))

1852 i‡(
xas
.
xa_off£t
 < (xas.
xa_ödex
 & 
XA_CHUNK_MASK
))

1855 i‡(!
	`xas_ªåy
(&
xas
, 
íåy
))

1858 
	`rcu_ªad_u∆ock
();

1860 i‡(
íåy
)

1861 *
ödexp
 = 
xas
.
xa_ödex
;

1862  
íåy
;

1863 
	}
}

1866 
	$xas_exåa˘_¥e£¡
(
xa_°©e
 *
xas
, **
d°
,

1867 
max
, 
n
)

1869 *
íåy
;

1870 
i
 = 0;

1872 
	`rcu_ªad_lock
();

1873 
	`xas_f‹_óch
(
xas
, 
íåy
, 
max
) {

1874 i‡(
	`xas_ªåy
(
xas
, 
íåy
))

1876 
d°
[
i
++] = 
íåy
;

1877 i‡(
i
 =
n
)

1880 
	`rcu_ªad_u∆ock
();

1882  
i
;

1883 
	}
}

1885 
	$xas_exåa˘_m¨ked
(
xa_°©e
 *
xas
, **
d°
,

1886 
max
, 
n
, 
xa_m¨k_t
 
m¨k
)

1888 *
íåy
;

1889 
i
 = 0;

1891 
	`rcu_ªad_lock
();

1892 
	`xas_f‹_óch_m¨ked
(
xas
, 
íåy
, 
max
, 
m¨k
) {

1893 i‡(
	`xas_ªåy
(
xas
, 
íåy
))

1895 
d°
[
i
++] = 
íåy
;

1896 i‡(
i
 =
n
)

1899 
	`rcu_ªad_u∆ock
();

1901  
i
;

1902 
	}
}

1932 
	$xa_exåa˘
(
x¨øy
 *
xa
, **
d°
, 
°¨t
,

1933 
max
, 
n
, 
xa_m¨k_t
 
fûãr
)

1935 
	`XA_STATE
(
xas
, 
xa
, 
°¨t
);

1937 i‡(!
n
)

1940 i‡((
__f‹˚
 )
fûãr
 < 
XA_MAX_MARKS
)

1941  
	`xas_exåa˘_m¨ked
(&
xas
, 
d°
, 
max
, 
n
, 
fûãr
);

1942  
	`xas_exåa˘_¥e£¡
(&
xas
, 
d°
, 
max
, 
n
);

1943 
	}
}

1956 
	$xa_de°roy
(
x¨øy
 *
xa
)

1958 
	`XA_STATE
(
xas
, 
xa
, 0);

1959 
Êags
;

1960 *
íåy
;

1962 
xas
.
xa_node
 = 
NULL
;

1963 
	`xas_lock_úqßve
(&
xas
, 
Êags
);

1964 
íåy
 = 
	`xa_hód_locked
(
xa
);

1965 
	`RCU_INIT_POINTER
(
xa
->
xa_hód
, 
NULL
);

1966 
	`xas_öô_m¨ks
(&
xas
);

1967 i‡(
	`xa_zîo_busy
(
xa
))

1968 
	`xa_m¨k_˛ór
(
xa
, 
XA_FREE_MARK
);

1970 i‡(
	`xa_is_node
(
íåy
))

1971 
	`xas_‰ì_nodes
(&
xas
, 
	`xa_to_node
(
íåy
));

1972 
	`xas_u∆ock_úqª°‹e
(&
xas
, 
Êags
);

1973 
	}
}

1976 #ifde‡
XA_DEBUG


1977 
	$xa_dump_node
(c⁄° 
xa_node
 *
node
)

1979 
i
, 
j
;

1981 i‡(!
node
)

1983 i‡(()
node
 & 3) {

1984 
	`¥_c⁄t
("nodê%px\n", 
node
);

1988 
	`¥_c⁄t
("node %px %s %dÖarent %px shift %d count %d values %d "

1990 
node
,Çode->
∑ª¡
 ? "off£t" : "max",Çode->
off£t
,

1991 
node
->
∑ª¡
,Çode->
shi·
,Çode->
cou¡
,Çode->
ƒ_vÆues
,

1992 
node
->
¨øy
,Çode->
¥iv©e_li°
.
¥ev
,Çode->¥iv©e_li°.
√xt
);

1993 
i
 = 0; i < 
XA_MAX_MARKS
; i++)

1994 
j
 = 0; j < 
XA_MARK_LONGS
; j++)

1995 
	`¥_c⁄t
(" %lx", 
node
->
m¨ks
[
i
][
j
]);

1996 
	`¥_c⁄t
("\n");

1997 
	}
}

1999 
	$xa_dump_ödex
(
ödex
, 
shi·
)

2001 i‡(!
shi·
)

2002 
	`¥_öfo
("%lu: ", 
ödex
);

2003 i‡(
shi·
 >
BITS_PER_LONG
)

2004 
	`¥_öfo
("0-%lu: ", ~0UL);

2006 
	`¥_öfo
("%lu-%lu: ", 
ödex
, index | ((1UL << 
shi·
) - 1));

2007 
	}
}

2009 
	$xa_dump_íåy
(c⁄° *
íåy
, 
ödex
, 
shi·
)

2011 i‡(!
íåy
)

2014 
	`xa_dump_ödex
(
ödex
, 
shi·
);

2016 i‡(
	`xa_is_node
(
íåy
)) {

2017 i‡(
shi·
 == 0) {

2018 
	`¥_c⁄t
("%px\n", 
íåy
);

2020 
i
;

2021 
xa_node
 *
node
 = 
	`xa_to_node
(
íåy
);

2022 
	`xa_dump_node
(
node
);

2023 
i
 = 0; i < 
XA_CHUNK_SIZE
; i++)

2024 
	`xa_dump_íåy
(
node
->
¶Ÿs
[
i
],

2025 
ödex
 + (
i
 << 
node
->
shi·
),Çode->shift);

2027 } i‡(
	`xa_is_vÆue
(
íåy
))

2028 
	`¥_c⁄t
("vÆuê%ld (0x%lxË[%px]\n", 
	`xa_to_vÆue
(
íåy
),

2029 
	`xa_to_vÆue
(
íåy
),Éntry);

2030 i‡(!
	`xa_is_öã∫Æ
(
íåy
))

2031 
	`¥_c⁄t
("%px\n", 
íåy
);

2032 i‡(
	`xa_is_ªåy
(
íåy
))

2033 
	`¥_c⁄t
("ªåy (%ld)\n", 
	`xa_to_öã∫Æ
(
íåy
));

2034 i‡(
	`xa_is_siblög
(
íåy
))

2035 
	`¥_c⁄t
("siblög (¶Ÿ %ld)\n", 
	`xa_to_siblög
(
íåy
));

2036 i‡(
	`xa_is_zîo
(
íåy
))

2037 
	`¥_c⁄t
("zîÿ(%ld)\n", 
	`xa_to_öã∫Æ
(
íåy
));

2039 
	`¥_c⁄t
("UNKNOWN ENTRY (%px)\n", 
íåy
);

2040 
	}
}

2042 
	$xa_dump
(c⁄° 
x¨øy
 *
xa
)

2044 *
íåy
 = 
xa
->
xa_hód
;

2045 
shi·
 = 0;

2047 
	`¥_öfo
("x¨øy: %px hód %px fœg†%x m¨k†%d %d %d\n", 
xa
, 
íåy
,

2048 
xa
->
xa_Êags
, 
	`xa_m¨ked
(xa, 
XA_MARK_0
),

2049 
	`xa_m¨ked
(
xa
, 
XA_MARK_1
), xa_m¨ked(xa, 
XA_MARK_2
));

2050 i‡(
	`xa_is_node
(
íåy
))

2051 
shi·
 = 
	`xa_to_node
(
íåy
)->shi· + 
XA_CHUNK_SHIFT
;

2052 
	`xa_dump_íåy
(
íåy
, 0, 
shi·
);

2053 
	}
}

	@xattr.c

54 
	~<löux/öô.h
>

55 
	~<löux/fs.h
>

56 
	~<löux/¶ab.h
>

57 
	~<löux/mbˇche.h
>

58 
	~<löux/quŸa›s.h
>

59 
	~<löux/ivîsi⁄.h
>

60 
	~"pxt4_jbd3.h
"

61 
	~"pxt4.h
"

62 
	~"x©å.h
"

63 
	~"a˛.h
"

65 #ifde‡
PXT4_XATTR_DEBUG


66 
	#ó_idebug
(
öode
, 
fmt
, ...) \

67 
	`¥ötk
(
KERN_DEBUG
 "öodê%s:%lu: " 
fmt
 "\n", \

68 
öode
->
i_sb
->
s_id
, inode->
i_öo
, ##
__VA_ARGS__
)

	)

69 
	#ó_bdebug
(
bh
, 
fmt
, ...) \

70 
	`¥ötk
(
KERN_DEBUG
 "block %pg:%lu: " 
fmt
 "\n", \

71 
bh
->
b_bdev
, ()bh->
b_blockƒ
, ##
__VA_ARGS__
)

	)

73 
	#ó_idebug
(
öode
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

74 
	#ó_bdebug
(
bh
, 
fmt
, ...Ë
	`no_¥ötk
(fmt, ##
__VA_ARGS__
)

	)

77 
pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *,

78 
buf„r_hód
 *);

79 
buf„r_hód
 *

80 
pxt4_x©å_block_ˇche_föd
(
öode
 *, 
pxt4_x©å_hódî
 *,

81 
mb_ˇche_íåy
 **);

82 
__À32
 
pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, __À32 *
vÆue
,

83 
size_t
 
vÆue_cou¡
);

84 
pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *);

86 c⁄° 
x©å_h™dÀr
 * c⁄° 
	gpxt4_x©å_h™dÀr_m≠
[] = {

87 [
PXT4_XATTR_INDEX_USER
] = &
pxt4_x©å_u£r_h™dÀr
,

88 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


89 [
PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
] = &
posix_a˛_ac˚ss_x©å_h™dÀr
,

90 [
PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
] = &
posix_a˛_deÁu…_x©å_h™dÀr
,

92 [
PXT4_XATTR_INDEX_TRUSTED
] = &
pxt4_x©å_åu°ed_h™dÀr
,

93 #ifde‡
CONFIG_PXT4_FS_SECURITY


94 [
PXT4_XATTR_INDEX_SECURITY
] = &
pxt4_x©å_£curôy_h™dÀr
,

98 c⁄° 
x©å_h™dÀr
 *
	gpxt4_x©å_h™dÀrs
[] = {

99 &
pxt4_x©å_u£r_h™dÀr
,

100 &
pxt4_x©å_åu°ed_h™dÀr
,

101 #ifde‡
CONFIG_PXT4_FS_POSIX_ACL


102 &
posix_a˛_ac˚ss_x©å_h™dÀr
,

103 &
posix_a˛_deÁu…_x©å_h™dÀr
,

105 #ifde‡
CONFIG_PXT4_FS_SECURITY


106 &
pxt4_x©å_£curôy_h™dÀr
,

108 
NULL


111 
	#EA_BLOCK_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

112 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_block_ˇche
)

	)

114 
	#EA_INODE_CACHE
(
öode
Ë(((
pxt4_sb_öfo
 *) \

115 
öode
->
i_sb
->
s_fs_öfo
)->
s_ó_öode_ˇche
)

	)

118 
pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

119 
öode
 *inode);

121 #ifde‡
CONFIG_LOCKDEP


122 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
)

124 
	`lockdï_£t_sub˛ass
(&
ó_öode
->
i_rw£m
, 1);

125 
	}
}

128 
__À32
 
	$pxt4_x©å_block_csum
(
öode
 *inode,

129 
£˘‹_t
 
block_ƒ
,

130 
pxt4_x©å_hódî
 *
hdr
)

132 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

133 
__u32
 
csum
;

134 
__À64
 
dsk_block_ƒ
 = 
	`˝u_to_À64
(
block_ƒ
);

135 
__u32
 
dummy_csum
 = 0;

136 
off£t
 = 
	`off£tof
(
pxt4_x©å_hódî
, 
h_checksum
);

138 
csum
 = 
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, (
__u8
 *)&
dsk_block_ƒ
,

139 (
dsk_block_ƒ
));

140 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
, 
off£t
);

141 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)&
dummy_csum
, (dummy_csum));

142 
off£t
 +(
dummy_csum
);

143 
csum
 = 
	`pxt4_chksum
(
sbi
, csum, (
__u8
 *)
hdr
 + 
off£t
,

144 
	`PXT4_BLOCK_SIZE
(
öode
->
i_sb
Ë- 
off£t
);

146  
	`˝u_to_À32
(
csum
);

147 
	}
}

149 
	$pxt4_x©å_block_csum_vîify
(
öode
 *inode,

150 
buf„r_hód
 *
bh
)

152 
pxt4_x©å_hódî
 *
hdr
 = 
	`BHDR
(
bh
);

153 
ªt
 = 1;

155 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
)) {

156 
	`lock_buf„r
(
bh
);

157 
ªt
 = (
hdr
->
h_checksum
 =
	`pxt4_x©å_block_csum
(
öode
,

158 
bh
->
b_blockƒ
, 
hdr
));

159 
	`u∆ock_buf„r
(
bh
);

161  
ªt
;

162 
	}
}

164 
	$pxt4_x©å_block_csum_£t
(
öode
 *inode,

165 
buf„r_hód
 *
bh
)

167 i‡(
	`pxt4_has_mëad©a_csum
(
öode
->
i_sb
))

168 
	`BHDR
(
bh
)->
h_checksum
 = 
	`pxt4_x©å_block_csum
(
öode
,

169 
bh
->
b_blockƒ
, 
	`BHDR
(bh));

170 
	}
}

172 
ölöe
 c⁄° 
x©å_h™dÀr
 *

173 
	$pxt4_x©å_h™dÀr
(
«me_ödex
)

175 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 = 
NULL
;

177 i‡(
«me_ödex
 > 0 &&Çame_ödex < 
	`ARRAY_SIZE
(
pxt4_x©å_h™dÀr_m≠
))

178 
h™dÀr
 = 
pxt4_x©å_h™dÀr_m≠
[
«me_ödex
];

179  
h™dÀr
;

180 
	}
}

183 
	$pxt4_x©å_check_íåõs
(
pxt4_x©å_íåy
 *
íåy
, *
íd
,

184 *
vÆue_°¨t
)

186 
pxt4_x©å_íåy
 *
e
 = 
íåy
;

189 !
	`IS_LAST_ENTRY
(
e
)) {

190 
pxt4_x©å_íåy
 *
√xt
 = 
	`PXT4_XATTR_NEXT
(
e
);

191 i‡((*)
√xt
 >
íd
)

192  -
EFSCORRUPTED
;

193 i‡(
	`°∫Àn
(
e
->
e_«me
,É->
e_«me_Àn
) !=É->e_name_len)

194  -
EFSCORRUPTED
;

195 
e
 = 
√xt
;

199 !
	`IS_LAST_ENTRY
(
íåy
)) {

200 
u32
 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

202 i‡(
size
 > 
PXT4_XATTR_SIZE_MAX
)

203  -
EFSCORRUPTED
;

205 i‡(
size
 !0 && 
íåy
->
e_vÆue_öum
 == 0) {

206 
u16
 
offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

207 *
vÆue
;

215 i‡(
offs
 > 
íd
 - 
vÆue_°¨t
)

216  -
EFSCORRUPTED
;

217 
vÆue
 = 
vÆue_°¨t
 + 
offs
;

218 i‡(
vÆue
 < (*)
e
 + (
u32
) ||

219 
size
 > 
íd
 - 
vÆue
 ||

220 
	`PXT4_XATTR_SIZE
(
size
Ë> 
íd
 - 
vÆue
)

221  -
EFSCORRUPTED
;

223 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry);

227 
	}
}

229 
ölöe
 

230 
	$__pxt4_x©å_check_block
(
öode
 *öode, 
buf„r_hód
 *
bh
,

231 c⁄° *
fun˘i⁄
, 
löe
)

233 
îr‹
 = -
EFSCORRUPTED
;

235 i‡(
	`BHDR
(
bh
)->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
) ||

236 
	`BHDR
(
bh
)->
h_blocks
 !
	`˝u_to_À32
(1))

237 
îrout
;

238 i‡(
	`buf„r_vîifõd
(
bh
))

241 
îr‹
 = -
EFSBADCRC
;

242 i‡(!
	`pxt4_x©å_block_csum_vîify
(
öode
, 
bh
))

243 
îrout
;

244 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`BFIRST
(
bh
), bh->
b_d©a
 + bh->
b_size
,

245 
bh
->
b_d©a
);

246 
îrout
:

247 i‡(
îr‹
)

248 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

250 (Ë
bh
->
b_blockƒ
);

252 
	`£t_buf„r_vîifõd
(
bh
);

253  
îr‹
;

254 
	}
}

256 
	#pxt4_x©å_check_block
(
öode
, 
bh
) \

257 
	`__pxt4_x©å_check_block
((
öode
), (
bh
), 
__func__
, 
__LINE__
)

	)

261 
	$__x©å_check_öode
(
öode
 *öode, 
pxt4_x©å_ibody_hódî
 *
hódî
,

262 *
íd
, c⁄° *
fun˘i⁄
, 
löe
)

264 
îr‹
 = -
EFSCORRUPTED
;

266 i‡(
íd
 - (*)
hódî
 < (*hódîË+ (
u32
) ||

267 (
hódî
->
h_magic
 !
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
)))

268 
îrout
;

269 
îr‹
 = 
	`pxt4_x©å_check_íåõs
(
	`IFIRST
(
hódî
), 
íd
, IFIRST(header));

270 
îrout
:

271 i‡(
îr‹
)

272 
	`__pxt4_îr‹_öode
(
öode
, 
fun˘i⁄
, 
löe
, 0,

274  
îr‹
;

275 
	}
}

277 
	#x©å_check_öode
(
öode
, 
hódî
, 
íd
) \

278 
	`__x©å_check_öode
((
öode
), (
hódî
), (
íd
), 
__func__
, 
__LINE__
)

	)

281 
	$x©å_föd_íåy
(
öode
 *öode, 
pxt4_x©å_íåy
 **
≥¡ry
,

282 *
íd
, 
«me_ödex
, c⁄° *
«me
, 
s‹ãd
)

284 
pxt4_x©å_íåy
 *
íåy
, *
√xt
;

285 
size_t
 
«me_Àn
;

286 
cmp
 = 1;

288 i‡(
«me
 =
NULL
)

289  -
EINVAL
;

290 
«me_Àn
 = 
	`°æí
(
«me
);

291 
íåy
 = *
≥¡ry
; !
	`IS_LAST_ENTRY
”¡ry);É¡ry = 
√xt
) {

292 
√xt
 = 
	`PXT4_XATTR_NEXT
(
íåy
);

293 i‡((*Ë
√xt
 >
íd
) {

294 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

295  -
EFSCORRUPTED
;

297 
cmp
 = 
«me_ödex
 - 
íåy
->
e_«me_ödex
;

298 i‡(!
cmp
)

299 
cmp
 = 
«me_Àn
 - 
íåy
->
e_«me_Àn
;

300 i‡(!
cmp
)

301 
cmp
 = 
	`memcmp
(
«me
, 
íåy
->
e_«me
, 
«me_Àn
);

302 i‡(
cmp
 <0 && (
s‹ãd
 || cmp == 0))

305 *
≥¡ry
 = 
íåy
;

306  
cmp
 ? -
ENODATA
 : 0;

307 
	}
}

309 
u32


310 
	$pxt4_x©å_öode_hash
(
pxt4_sb_öfo
 *
sbi
, c⁄° *
buf„r
, 
size_t
 
size
)

312  
	`pxt4_chksum
(
sbi
, sbi->
s_csum_£ed
, 
buf„r
, 
size
);

313 
	}
}

315 
u64
 
	$pxt4_x©å_öode_gë_ªf
(
öode
 *
ó_öode
)

317  ((
u64
)
ó_öode
->
i_˘ime
.
tv_£c
 << 32) |

318 (
u32
Ë
	`öode_≥ek_ivîsi⁄_øw
(
ó_öode
);

319 
	}
}

321 
	$pxt4_x©å_öode_£t_ªf
(
öode
 *
ó_öode
, 
u64
 
ªf_cou¡
)

323 
ó_öode
->
i_˘ime
.
tv_£c
 = (
u32
)(
ªf_cou¡
 >> 32);

324 
	`öode_£t_ivîsi⁄_øw
(
ó_öode
, 
ªf_cou¡
 & 0xffffffff);

325 
	}
}

327 
u32
 
	$pxt4_x©å_öode_gë_hash
(
öode
 *
ó_öode
)

329  (
u32
)
ó_öode
->
i_©ime
.
tv_£c
;

330 
	}
}

332 
	$pxt4_x©å_öode_£t_hash
(
öode
 *
ó_öode
, 
u32
 
hash
)

334 
ó_öode
->
i_©ime
.
tv_£c
 = 
hash
;

335 
	}
}

340 
	$pxt4_x©å_öode_ªad
(
öode
 *
ó_öode
, *
buf
, 
size_t
 
size
)

342 
blocksize
 = 1 << 
ó_öode
->
i_blkbôs
;

343 
bh_cou¡
 = (
size
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

344 
èû_size
 = (
size
 % 
blocksize
) ?: blocksize;

345 
buf„r_hód
 *
bhs_ölöe
[8];

346 
buf„r_hód
 **
bhs
 = 
bhs_ölöe
;

347 
i
, 
ªt
;

349 i‡(
bh_cou¡
 > 
	`ARRAY_SIZE
(
bhs_ölöe
)) {

350 
bhs
 = 
	`kmÆloc_¨øy
(
bh_cou¡
, (*bhs), 
GFP_NOFS
);

351 i‡(!
bhs
)

352  -
ENOMEM
;

355 
ªt
 = 
	`pxt4_bªad_b©ch
(
ó_öode
, 0 , 
bh_cou¡
,

356 
åue
 , 
bhs
);

357 i‡(
ªt
)

358 
‰ì_bhs
;

360 
i
 = 0; i < 
bh_cou¡
; i++) {

362 i‡(!
bhs
[
i
]) {

363 
ªt
 = -
EFSCORRUPTED
;

364 
put_bhs
;

366 
	`mem˝y
((*)
buf
 + 
blocksize
 * 
i
, 
bhs
[i]->
b_d©a
,

367 
i
 < 
bh_cou¡
 - 1 ? 
blocksize
 : 
èû_size
);

369 
ªt
 = 0;

370 
put_bhs
:

371 
i
 = 0; i < 
bh_cou¡
; i++)

372 
	`bªl£
(
bhs
[
i
]);

373 
‰ì_bhs
:

374 i‡(
bhs
 !
bhs_ölöe
)

375 
	`k‰ì
(
bhs
);

376  
ªt
;

377 
	}
}

379 
	#PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë((
__u32
)(öode)->
i_mtime
.
tv_£c
)

	)

381 
	$pxt4_x©å_öode_igë
(
öode
 *
∑ª¡
, 
ó_öo
,

382 
u32
 
ó_öode_hash
, 
öode
 **
ó_öode
)

384 
öode
 *inode;

385 
îr
;

387 
öode
 = 
	`pxt4_igë
(
∑ª¡
->
i_sb
, 
ó_öo
, 
PXT4_IGET_NORMAL
);

388 i‡(
	`IS_ERR
(
öode
)) {

389 
îr
 = 
	`PTR_ERR
(
öode
);

390 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

391 "îr‹ whûêªadög EA inodê%luÉº=%d", 
ó_öo
,

392 
îr
);

393  
îr
;

396 i‡(
	`is_bad_öode
(
öode
)) {

397 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

399 
ó_öo
);

400 
îr
 = -
EIO
;

401 
îr‹
;

404 i‡(!(
	`PXT4_I
(
öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
)) {

405 
	`pxt4_îr‹
(
∑ª¡
->
i_sb
,

407 
ó_öo
);

408 
îr
 = -
EINVAL
;

409 
îr‹
;

412 
	`pxt4_x©å_öode_£t_˛ass
(
öode
);

419 i‡(
ó_öode_hash
 !
	`pxt4_x©å_öode_gë_hash
(
öode
) &&

420 
	`PXT4_XATTR_INODE_GET_PARENT
(
öode
Ë=
∑ª¡
->
i_öo
 &&

421 
öode
->
i_gíî©i⁄
 =
∑ª¡
->i_generation) {

422 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_LUSTRE_EA_INODE
);

423 
	`pxt4_x©å_öode_£t_ªf
(
öode
, 1);

425 
	`öode_lock
(
öode
);

426 
öode
->
i_Êags
 |
S_NOQUOTA
;

427 
	`öode_u∆ock
(
öode
);

430 *
ó_öode
 = 
öode
;

432 
îr‹
:

433 
	`ùut
(
öode
);

434  
îr
;

435 
	}
}

438 
	$pxt4_x©å_öode_vîify_hashes
(
öode
 *
ó_öode
,

439 
pxt4_x©å_íåy
 *
íåy
, *
buf„r
,

440 
size_t
 
size
)

442 
u32
 
hash
;

445 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
ó_öode
->
i_sb
), 
buf„r
, 
size
);

446 i‡(
hash
 !
	`pxt4_x©å_öode_gë_hash
(
ó_öode
))

447  -
EFSCORRUPTED
;

449 i‡(
íåy
) {

450 
__À32
 
e_hash
, 
tmp_d©a
;

453 
tmp_d©a
 = 
	`˝u_to_À32
(
hash
);

454 
e_hash
 = 
	`pxt4_x©å_hash_íåy
(
íåy
->
e_«me
,É¡ry->
e_«me_Àn
,

455 &
tmp_d©a
, 1);

456 i‡(
e_hash
 !
íåy
->e_hash)

457  -
EFSCORRUPTED
;

460 
	}
}

466 
	$pxt4_x©å_öode_gë
(
öode
 *öode, 
pxt4_x©å_íåy
 *
íåy
,

467 *
buf„r
, 
size_t
 
size
)

469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

470 
öode
 *
ó_öode
;

471 
îr
;

473 
îr
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

474 
	`À32_to_˝u
(
íåy
->
e_hash
), &
ó_öode
);

475 i‡(
îr
) {

476 
ó_öode
 = 
NULL
;

477 
out
;

480 i‡(
	`i_size_ªad
(
ó_öode
Ë!
size
) {

481 
	`pxt4_w¨nög_öode
(
ó_öode
,

483 
	`i_size_ªad
(
ó_öode
), 
size
);

484 
îr
 = -
EFSCORRUPTED
;

485 
out
;

488 
îr
 = 
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
buf„r
, 
size
);

489 i‡(
îr
)

490 
out
;

492 i‡(!
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
)) {

493 
îr
 = 
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
íåy
, 
buf„r
,

494 
size
);

495 i‡(
îr
) {

496 
	`pxt4_w¨nög_öode
(
ó_öode
,

498 
out
;

501 i‡(
ó_öode_ˇche
)

502 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
, 
GFP_NOFS
,

503 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
),

504 
ó_öode
->
i_öo
, 
åue
 );

506 
out
:

507 
	`ùut
(
ó_öode
);

508  
îr
;

509 
	}
}

512 
	$pxt4_x©å_block_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

513 *
buf„r
, 
size_t
 
buf„r_size
)

515 
buf„r_hód
 *
bh
 = 
NULL
;

516 
pxt4_x©å_íåy
 *
íåy
;

517 
size_t
 
size
;

518 *
íd
;

519 
îr‹
;

520 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

522 
	`ó_idebug
(
öode
, "name=%d.%s, buffer=%p, buffer_size=%ld",

523 
«me_ödex
, 
«me
, 
buf„r
, ()
buf„r_size
);

525 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

526  -
ENODATA
;

527 
	`ó_idebug
(
öode
, "reading block %llu",

528 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

529 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

530 i‡(
	`IS_ERR
(
bh
))

531  
	`PTR_ERR
(
bh
);

532 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

533 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

534 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

535 i‡(
îr‹
)

536 
˛ónup
;

537 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bh
);

538 
íåy
 = 
	`BFIRST
(
bh
);

539 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

540 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 1);

541 i‡(
îr‹
)

542 
˛ónup
;

543 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

544 
îr‹
 = -
ERANGE
;

545 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

546 
˛ónup
;

547 i‡(
buf„r
) {

548 i‡(
size
 > 
buf„r_size
)

549 
˛ónup
;

550 i‡(
íåy
->
e_vÆue_öum
) {

551 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

552 
size
);

553 i‡(
îr‹
)

554 
˛ónup
;

556 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

557 *
p
 = 
bh
->
b_d©a
 + 
off£t
;

559 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

560 
˛ónup
;

561 
	`mem˝y
(
buf„r
, 
p
, 
size
);

564 
îr‹
 = 
size
;

566 
˛ónup
:

567 
	`bªl£
(
bh
);

568  
îr‹
;

569 
	}
}

572 
	$pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

573 *
buf„r
, 
size_t
 
buf„r_size
)

575 
pxt4_x©å_ibody_hódî
 *
hódî
;

576 
pxt4_x©å_íåy
 *
íåy
;

577 
pxt4_öode
 *
øw_öode
;

578 
pxt4_ûoc
 
ûoc
;

579 
size_t
 
size
;

580 *
íd
;

581 
îr‹
;

583 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

584  -
ENODATA
;

585 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

586 i‡(
îr‹
)

587  
îr‹
;

588 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

589 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

590 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

591 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

592 i‡(
îr‹
)

593 
˛ónup
;

594 
íåy
 = 
	`IFIRST
(
hódî
);

595 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
íåy
, 
íd
, 
«me_ödex
, 
«me
, 0);

596 i‡(
îr‹
)

597 
˛ónup
;

598 
size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

599 
îr‹
 = -
ERANGE
;

600 i‡(
	`u∆ikñy
(
size
 > 
PXT4_XATTR_SIZE_MAX
))

601 
˛ónup
;

602 i‡(
buf„r
) {

603 i‡(
size
 > 
buf„r_size
)

604 
˛ónup
;

605 i‡(
íåy
->
e_vÆue_öum
) {

606 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
,

607 
size
);

608 i‡(
îr‹
)

609 
˛ónup
;

611 
u16
 
off£t
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

612 *
p
 = (*)
	`IFIRST
(
hódî
Ë+ 
off£t
;

614 i‡(
	`u∆ikñy
(
p
 + 
size
 > 
íd
))

615 
˛ónup
;

616 
	`mem˝y
(
buf„r
, 
p
, 
size
);

619 
îr‹
 = 
size
;

621 
˛ónup
:

622 
	`bªl£
(
ûoc
.
bh
);

623  
îr‹
;

624 
	}
}

637 
	$pxt4_x©å_gë
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

638 *
buf„r
, 
size_t
 
buf„r_size
)

640 
îr‹
;

642 i‡(
	`u∆ikñy
(
	`pxt4_f‹˚d_shutdown
(
	`PXT4_SB
(
öode
->
i_sb
))))

643  -
EIO
;

645 i‡(
	`°æí
(
«me
) > 255)

646  -
ERANGE
;

648 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

649 
îr‹
 = 
	`pxt4_x©å_ibody_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

650 
buf„r_size
);

651 i‡(
îr‹
 =-
ENODATA
)

652 
îr‹
 = 
	`pxt4_x©å_block_gë
(
öode
, 
«me_ödex
, 
«me
, 
buf„r
,

653 
buf„r_size
);

654 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

655  
îr‹
;

656 
	}
}

659 
	$pxt4_x©å_li°_íåõs
(
díåy
 *díåy, 
pxt4_x©å_íåy
 *
íåy
,

660 *
buf„r
, 
size_t
 
buf„r_size
)

662 
size_t
 
ª°
 = 
buf„r_size
;

664 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry)) {

665 c⁄° 
x©å_h™dÀr
 *
h™dÀr
 =

666 
	`pxt4_x©å_h™dÀr
(
íåy
->
e_«me_ödex
);

668 i‡(
h™dÀr
 && (!h™dÀr->
li°
 || h™dÀr->
	`li°
(
díåy
))) {

669 c⁄° *
¥efix
 = 
h™dÀr
->¥efix ?: h™dÀr->
«me
;

670 
size_t
 
¥efix_Àn
 = 
	`°æí
(
¥efix
);

671 
size_t
 
size
 = 
¥efix_Àn
 + 
íåy
->
e_«me_Àn
 + 1;

673 i‡(
buf„r
) {

674 i‡(
size
 > 
ª°
)

675  -
ERANGE
;

676 
	`mem˝y
(
buf„r
, 
¥efix
, 
¥efix_Àn
);

677 
buf„r
 +
¥efix_Àn
;

678 
	`mem˝y
(
buf„r
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

679 
buf„r
 +
íåy
->
e_«me_Àn
;

680 *
buf„r
++ = 0;

682 
ª°
 -
size
;

685  
buf„r_size
 - 
ª°
;

686 
	}
}

689 
	$pxt4_x©å_block_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

691 
öode
 *öodê
	`d_öode
(
díåy
);

692 
buf„r_hód
 *
bh
 = 
NULL
;

693 
îr‹
;

695 
	`ó_idebug
(
öode
, "buffer=%p, buffer_size=%ld",

696 
buf„r
, ()
buf„r_size
);

698 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

700 
	`ó_idebug
(
öode
, "reading block %llu",

701 ()
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

702 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

703 i‡(
	`IS_ERR
(
bh
))

704  
	`PTR_ERR
(
bh
);

705 
	`ó_bdebug
(
bh
, "b_count=%d,Ñefcount=%d",

706 
	`©omic_ªad
(&(
bh
->
b_cou¡
)), 
	`À32_to_˝u
(
	`BHDR
(bh)->
h_ªfcou¡
));

707 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

708 i‡(
îr‹
)

709 
˛ónup
;

710 
	`pxt4_x©å_block_ˇche_ö£π
(
	`EA_BLOCK_CACHE
(
öode
), 
bh
);

711 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`BFIRST
(
bh
), 
buf„r
,

712 
buf„r_size
);

713 
˛ónup
:

714 
	`bªl£
(
bh
);

715  
îr‹
;

716 
	}
}

719 
	$pxt4_x©å_ibody_li°
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

721 
öode
 *öodê
	`d_öode
(
díåy
);

722 
pxt4_x©å_ibody_hódî
 *
hódî
;

723 
pxt4_öode
 *
øw_öode
;

724 
pxt4_ûoc
 
ûoc
;

725 *
íd
;

726 
îr‹
;

728 i‡(!
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
))

730 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

731 i‡(
îr‹
)

732  
îr‹
;

733 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

734 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

735 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

736 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

737 i‡(
îr‹
)

738 
˛ónup
;

739 
îr‹
 = 
	`pxt4_x©å_li°_íåõs
(
díåy
, 
	`IFIRST
(
hódî
),

740 
buf„r
, 
buf„r_size
);

742 
˛ónup
:

743 
	`bªl£
(
ûoc
.
bh
);

744  
îr‹
;

745 
	}
}

759 
ssize_t


760 
	$pxt4_li°x©å
(
díåy
 *díåy, *
buf„r
, 
size_t
 
buf„r_size
)

762 
ªt
, 
ªt2
;

764 
	`down_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

765 
ªt
 = 
ªt2
 = 
	`pxt4_x©å_ibody_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

766 i‡(
ªt
 < 0)

767 
îrout
;

768 i‡(
buf„r
) {

769 
buf„r
 +
ªt
;

770 
buf„r_size
 -
ªt
;

772 
ªt
 = 
	`pxt4_x©å_block_li°
(
díåy
, 
buf„r
, 
buf„r_size
);

773 i‡(
ªt
 < 0)

774 
îrout
;

775 
ªt
 +
ªt2
;

776 
îrout
:

777 
	`up_ªad
(&
	`PXT4_I
(
	`d_öode
(
díåy
))->
x©å_£m
);

778  
ªt
;

779 
	}
}

785 
	$pxt4_x©å_upd©e_su≥r_block
(
h™dÀ_t
 *
h™dÀ
,

786 
su≥r_block
 *
sb
)

788 i‡(
	`pxt4_has_„©uª_x©å
(
sb
))

791 
	`BUFFER_TRACE
(
	`PXT4_SB
(
sb
)->
s_sbh
, "get_write_access");

792 i‡(
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
	`PXT4_SB
(
sb
)->
s_sbh
) == 0) {

793 
	`pxt4_£t_„©uª_x©å
(
sb
);

794 
	`pxt4_h™dÀ_dúty_su≥r
(
h™dÀ
, 
sb
);

796 
	}
}

798 
	$pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
)

800 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

801 
buf„r_hód
 *
bh
 = 
NULL
;

802 
pxt4_öode
 *
øw_öode
;

803 
pxt4_x©å_ibody_hódî
 *
hódî
;

804 
pxt4_x©å_íåy
 *
íåy
;

805 
qsize_t
 
ó_öode_ªfs
 = 0;

806 *
íd
;

807 
ªt
;

809 
	`lockdï_as£π_hñd_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

811 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

812 
ªt
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

813 i‡(
ªt
)

814 
out
;

815 
øw_öode
 = 
	`pxt4_øw_öode
(&
ûoc
);

816 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

817 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

818 
ªt
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

819 i‡(
ªt
)

820 
out
;

822 
íåy
 = 
	`IFIRST
(
hódî
); !
	`IS_LAST_ENTRY
(entry);

823 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

824 i‡(
íåy
->
e_vÆue_öum
)

825 
ó_öode_ªfs
++;

828 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

829 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

830 i‡(
	`IS_ERR
(
bh
)) {

831 
ªt
 = 
	`PTR_ERR
(
bh
);

832 
bh
 = 
NULL
;

833 
out
;

836 
ªt
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

837 i‡(
ªt
)

838 
out
;

840 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

841 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry))

842 i‡(
íåy
->
e_vÆue_öum
)

843 
ó_öode_ªfs
++;

845 *
ußge
 = 
ó_öode_ªfs
 + 1;

846 
ªt
 = 0;

847 
out
:

848 
	`bªl£
(
ûoc
.
bh
);

849 
	`bªl£
(
bh
);

850  
ªt
;

851 
	}
}

853 
ölöe
 
size_t
 
	$round_up_˛u°î
(
öode
 *öode, 
size_t
 
Àngth
)

855 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

856 
size_t
 
˛u°î_size
 = 1 << (
	`PXT4_SB
(
sb
)->
s_˛u°î_bôs
 +

857 
öode
->
i_blkbôs
);

858 
size_t
 
mask
 = ~(
˛u°î_size
 - 1);

860  (
Àngth
 + 
˛u°î_size
 - 1Ë& 
mask
;

861 
	}
}

863 
	$pxt4_x©å_öode_Æloc_quŸa
(
öode
 *öode, 
size_t
 
Àn
)

865 
îr
;

867 
îr
 = 
	`dquŸ_Æloc_öode
(
öode
);

868 i‡(
îr
)

869  
îr
;

870 
îr
 = 
	`dquŸ_Æloc_•a˚_nodúty
(
öode
, 
	`round_up_˛u°î
(öode, 
Àn
));

871 i‡(
îr
)

872 
	`dquŸ_‰ì_öode
(
öode
);

873  
îr
;

874 
	}
}

876 
	$pxt4_x©å_öode_‰ì_quŸa
(
öode
 *
∑ª¡
,

877 
öode
 *
ó_öode
,

878 
size_t
 
Àn
)

880 i‡(
ó_öode
 &&

881 
	`pxt4_ã°_öode_°©e
(
ó_öode
, 
PXT4_STATE_LUSTRE_EA_INODE
))

883 
	`dquŸ_‰ì_•a˚_nodúty
(
∑ª¡
, 
	`round_up_˛u°î
’¨ít, 
Àn
));

884 
	`dquŸ_‰ì_öode
(
∑ª¡
);

885 
	}
}

887 
	$__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

888 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

889 
boﬁ
 
is_¸óã
)

891 
¸edôs
;

892 
blocks
;

907 
¸edôs
 = 7;

910 
¸edôs
 +
	`PXT4_MAXQUOTAS_TRANS_BLOCKS
(
sb
);

916 i‡(
öode
 && 
	`pxt4_has_ölöe_d©a
(inode))

917 
¸edôs
 +
	`pxt4_wrôïage_å™s_blocks
(
öode
) + 1;

920 i‡(!
	`pxt4_has_„©uª_ó_öode
(
sb
))

921  
¸edôs
;

924 
¸edôs
 += 4;

927 
blocks
 = (
vÆue_Àn
 + 
sb
->
s_blocksize
 - 1Ë>> sb->
s_blocksize_bôs
;

930 
blocks
 += 1;

933 
¸edôs
 +
blocks
 * 2;

936 
¸edôs
 +
blocks
;

938 i‡(!
is_¸óã
) {

942 
¸edôs
 += 4;

945 
blocks
 = 
XATTR_SIZE_MAX
 >> 
sb
->
s_blocksize_bôs
;

950 
blocks
 += 1;

953 
¸edôs
 +
blocks
 * 2;

959 i‡(
block_bh
) {

960 
pxt4_x©å_íåy
 *
íåy
 = 
	`BFIRST
(
block_bh
);

962 ; !
	`IS_LAST_ENTRY
(
íåy
);É¡ry = 
	`PXT4_XATTR_NEXT
(entry))

963 i‡(
íåy
->
e_vÆue_öum
)

965 
¸edôs
 += 1;

967  
¸edôs
;

968 
	}
}

970 
	$pxt4_x©å_ísuª_¸edôs
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

971 
¸edôs
, 
buf„r_hód
 *
bh
,

972 
boﬁ
 
dúty
, boﬁ 
block_csum
)

974 
îr‹
;

976 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

979 i‡(
h™dÀ
->
h_buf„r_¸edôs
 >
¸edôs
)

982 
îr‹
 = 
	`pxt4_jou∫Æ_exãnd
(
h™dÀ
, 
¸edôs
 - h™dÀ->
h_buf„r_¸edôs
);

983 i‡(!
îr‹
)

985 i‡(
îr‹
 < 0) {

986 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Exãnd jou∫Æ (îr‹ %d)", 
îr‹
);

987  
îr‹
;

990 i‡(
bh
 && 
dúty
) {

991 i‡(
block_csum
)

992 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

993 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

994 i‡(
îr‹
) {

995 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Handle metadata (error %d)",

996 
îr‹
);

997  
îr‹
;

1001 
îr‹
 = 
	`pxt4_jou∫Æ_ª°¨t
(
h™dÀ
, 
¸edôs
);

1002 i‡(
îr‹
) {

1003 
	`pxt4_w¨nög
(
öode
->
i_sb
, "Re°¨àjou∫Æ (îr‹ %d)", 
îr‹
);

1004  
îr‹
;

1007 i‡(
bh
) {

1008 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1009 i‡(
îr‹
) {

1010 
	`pxt4_w¨nög
(
öode
->
i_sb
,

1012 
îr‹
);

1013  
îr‹
;

1017 
	}
}

1019 
	$pxt4_x©å_öode_upd©e_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1020 
ªf_ch™ge
)

1022 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
ó_öode
);

1023 
pxt4_ûoc
 
ûoc
;

1024 
s64
 
ªf_cou¡
;

1025 
u32
 
hash
;

1026 
ªt
;

1028 
	`öode_lock
(
ó_öode
);

1030 
ªt
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1031 i‡(
ªt
)

1032 
out
;

1034 
ªf_cou¡
 = 
	`pxt4_x©å_öode_gë_ªf
(
ó_öode
);

1035 
ªf_cou¡
 +
ªf_ch™ge
;

1036 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 
ªf_cou¡
);

1038 i‡(
ªf_ch™ge
 > 0) {

1039 
	`WARN_ONCE
(
ªf_cou¡
 <= 0, "EA inode %luÑef_count=%lld",

1040 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1042 i‡(
ªf_cou¡
 == 1) {

1043 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
, "EA inode %lu i_nlink=%u",

1044 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1046 
	`£t_∆ök
(
ó_öode
, 1);

1047 
	`pxt4_‹ph™_dñ
(
h™dÀ
, 
ó_öode
);

1049 i‡(
ó_öode_ˇche
) {

1050 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1051 
	`mb_ˇche_íåy_¸óã
(
ó_öode_ˇche
,

1052 
GFP_NOFS
, 
hash
,

1053 
ó_öode
->
i_öo
,

1054 
åue
 );

1058 
	`WARN_ONCE
(
ªf_cou¡
 < 0, "EA inode %luÑef_count=%lld",

1059 
ó_öode
->
i_öo
, 
ªf_cou¡
);

1061 i‡(
ªf_cou¡
 == 0) {

1062 
	`WARN_ONCE
(
ó_öode
->
i_∆ök
 != 1,

1064 
ó_öode
->
i_öo
,Éa_öode->
i_∆ök
);

1066 
	`˛ór_∆ök
(
ó_öode
);

1067 
	`pxt4_‹ph™_add
(
h™dÀ
, 
ó_öode
);

1069 i‡(
ó_öode_ˇche
) {

1070 
hash
 = 
	`pxt4_x©å_öode_gë_hash
(
ó_öode
);

1071 
	`mb_ˇche_íåy_dñëe
(
ó_öode_ˇche
, 
hash
,

1072 
ó_öode
->
i_öo
);

1077 
ªt
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
ó_öode
, &
ûoc
);

1078 i‡(
ªt
)

1079 
	`pxt4_w¨nög_öode
(
ó_öode
,

1080 "pxt4_m¨k_ûoc_dúty(ËÁûedÑë=%d", 
ªt
);

1081 
out
:

1082 
	`öode_u∆ock
(
ó_öode
);

1083  
ªt
;

1084 
	}
}

1086 
	$pxt4_x©å_öode_öc_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1088  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, 1);

1089 
	}
}

1091 
	$pxt4_x©å_öode_dec_ªf
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
)

1093  
	`pxt4_x©å_öode_upd©e_ªf
(
h™dÀ
, 
ó_öode
, -1);

1094 
	}
}

1096 
	$pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1097 
pxt4_x©å_íåy
 *
fú°
)

1099 
öode
 *
ó_öode
;

1100 
pxt4_x©å_íåy
 *
íåy
;

1101 
pxt4_x©å_íåy
 *
Áûed_íåy
;

1102 
ó_öo
;

1103 
îr
, 
ßved_îr
;

1105 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1106 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1107 i‡(!
íåy
->
e_vÆue_öum
)

1109 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1110 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1111 
	`À32_to_˝u
(
íåy
->
e_hash
),

1112 &
ó_öode
);

1113 i‡(
îr
)

1114 
˛ónup
;

1115 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1116 i‡(
îr
) {

1117 
	`pxt4_w¨nög_öode
(
ó_öode
, "ö¯ª‡îr‹ %d", 
îr
);

1118 
	`ùut
(
ó_öode
);

1119 
˛ónup
;

1121 
	`ùut
(
ó_öode
);

1125 
˛ónup
:

1126 
ßved_îr
 = 
îr
;

1127 
Áûed_íåy
 = 
íåy
;

1129 
íåy
 = 
fú°
;É¡ry !
Áûed_íåy
;

1130 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1131 i‡(!
íåy
->
e_vÆue_öum
)

1133 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1134 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1135 
	`À32_to_˝u
(
íåy
->
e_hash
),

1136 &
ó_öode
);

1137 i‡(
îr
) {

1138 
	`pxt4_w¨nög
(
∑ª¡
->
i_sb
,

1139 "˛ónu∞ó_öÿ%u igëÉº‹ %d", 
ó_öo
,

1140 
îr
);

1143 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1144 i‡(
îr
)

1145 
	`pxt4_w¨nög_öode
(
ó_öode
, "cleanup decÑefÉrror %d",

1146 
îr
);

1147 
	`ùut
(
ó_öode
);

1149  
ßved_îr
;

1150 
	}
}

1153 
	$pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
∑ª¡
,

1154 
buf„r_hód
 *
bh
,

1155 
pxt4_x©å_íåy
 *
fú°
, 
boﬁ
 
block_csum
,

1156 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1157 
exåa_¸edôs
, 
boﬁ
 
skù_quŸa
)

1159 
öode
 *
ó_öode
;

1160 
pxt4_x©å_íåy
 *
íåy
;

1161 
boﬁ
 
dúty
 = 
Ál£
;

1162 
ó_öo
;

1163 
îr
;

1164 
¸edôs
;

1167 
¸edôs
 = 2 + 
exåa_¸edôs
;

1169 
íåy
 = 
fú°
; !
	`IS_LAST_ENTRY
(entry);

1170 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

1171 i‡(!
íåy
->
e_vÆue_öum
)

1173 
ó_öo
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
);

1174 
îr
 = 
	`pxt4_x©å_öode_igë
(
∑ª¡
, 
ó_öo
,

1175 
	`À32_to_˝u
(
íåy
->
e_hash
),

1176 &
ó_öode
);

1177 i‡(
îr
)

1180 
îr
 = 
	`pxt4_ex∑nd_öode_¨øy
(
ó_öode_¨øy
, 
ó_öode
);

1181 i‡(
îr
) {

1182 
	`pxt4_w¨nög_öode
(
ó_öode
,

1183 "Ex∑nd inodê¨øyÉº=%d", 
îr
);

1184 
	`ùut
(
ó_öode
);

1188 
îr
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
∑ª¡
, 
¸edôs
, 
bh
,

1189 
dúty
, 
block_csum
);

1190 i‡(
îr
) {

1191 
	`pxt4_w¨nög_öode
(
ó_öode
, "Ensure creditsÉrr=%d",

1192 
îr
);

1196 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1197 i‡(
îr
) {

1198 
	`pxt4_w¨nög_öode
(
ó_öode
, "ea_inode decÑefÉrr=%d",

1199 
îr
);

1203 i‡(!
skù_quŸa
)

1204 
	`pxt4_x©å_öode_‰ì_quŸa
(
∑ª¡
, 
ó_öode
,

1205 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

1213 
íåy
->
e_vÆue_öum
 = 0;

1214 
íåy
->
e_vÆue_size
 = 0;

1216 
dúty
 = 
åue
;

1219 i‡(
dúty
) {

1226 
îr
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
NULL
, 
bh
);

1227 i‡(
îr
)

1228 
	`pxt4_w¨nög_öode
(
∑ª¡
,

1229 "h™dÀ dúty mëad©®îr=%d", 
îr
);

1231 
	}
}

1238 
	$pxt4_x©å_ªÀa£_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1239 
buf„r_hód
 *
bh
,

1240 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

1241 
exåa_¸edôs
)

1243 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1244 
u32
 
hash
, 
ªf
;

1245 
îr‹
 = 0;

1247 
	`BUFFER_TRACE
(
bh
, "get_write_access");

1248 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1249 i‡(
îr‹
)

1250 
out
;

1252 
	`lock_buf„r
(
bh
);

1253 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_hash
);

1254 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
);

1255 i‡(
ªf
 == 1) {

1256 
	`ó_bdebug
(
bh
, "refcountÇow=0; freeing");

1261 i‡(
ó_block_ˇche
)

1262 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1263 
bh
->
b_blockƒ
);

1264 
	`gë_bh
(
bh
);

1265 
	`u∆ock_buf„r
(
bh
);

1267 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
))

1268 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
bh
,

1269 
	`BFIRST
(
bh
),

1270 
åue
 ,

1271 
ó_öode_¨øy
,

1272 
exåa_¸edôs
,

1273 
åue
 );

1274 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
bh
, 0, 1,

1275 
PXT4_FREE_BLOCKS_METADATA
 |

1276 
PXT4_FREE_BLOCKS_FORGET
);

1278 
ªf
--;

1279 
	`BHDR
(
bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

1280 i‡(
ªf
 =
PXT4_XATTR_REFCOUNT_MAX
 - 1) {

1281 
mb_ˇche_íåy
 *
˚
;

1283 i‡(
ó_block_ˇche
) {

1284 
˚
 = 
	`mb_ˇche_íåy_gë
(
ó_block_ˇche
, 
hash
,

1285 
bh
->
b_blockƒ
);

1286 i‡(
˚
) {

1287 
˚
->
e_ªußbÀ
 = 1;

1288 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

1293 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bh
);

1304 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1305 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1306 
	`u∆ock_buf„r
(
bh
);

1307 i‡(!
	`pxt4_h™dÀ_vÆid
(
h™dÀ
))

1308 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
, 
bh
);

1309 i‡(
	`IS_SYNC
(
öode
))

1310 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

1311 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(öode->
i_sb
), 1));

1312 
	`ó_bdebug
(
bh
, "refcountÇow=%d;Ñeleasing",

1313 
	`À32_to_˝u
(
	`BHDR
(
bh
)->
h_ªfcou¡
));

1315 
out
:

1316 
	`pxt4_°d_îr‹
(
öode
->
i_sb
, 
îr‹
);

1318 
	}
}

1324 
size_t
 
	$pxt4_x©å_‰ì_•a˚
(
pxt4_x©å_íåy
 *
œ°
,

1325 
size_t
 *
mö_offs
, *
ba£
, *
tŸÆ
)

1327 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

1328 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1329 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1330 i‡(
offs
 < *
mö_offs
)

1331 *
mö_offs
 = 
offs
;

1333 i‡(
tŸÆ
)

1334 *
tŸÆ
 +
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

1336  (*
mö_offs
 - ((*)
œ°
 - 
ba£
Ë- (
__u32
));

1337 
	}
}

1342 
	$pxt4_x©å_öode_wrôe
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *
ó_öode
,

1343 c⁄° *
buf
, 
bufsize
)

1345 
buf„r_hód
 *
bh
 = 
NULL
;

1346 
block
 = 0;

1347 
blocksize
 = 
ó_öode
->
i_sb
->
s_blocksize
;

1348 
max_blocks
 = (
bufsize
 + 
blocksize
 - 1Ë>> 
ó_öode
->
i_blkbôs
;

1349 
csize
, 
wsize
 = 0;

1350 
ªt
 = 0;

1351 
ªåõs
 = 0;

1353 
ªåy
:

1354 
ªt
 >0 &&Ñë < 
max_blocks
) {

1355 
pxt4_m≠_blocks
 
m≠
;

1356 
m≠
.
m_lblk
 = 
block
 +
ªt
;

1357 
m≠
.
m_Àn
 = 
max_blocks
 -
ªt
;

1359 
ªt
 = 
	`pxt4_m≠_blocks
(
h™dÀ
, 
ó_öode
, &
m≠
,

1360 
PXT4_GET_BLOCKS_CREATE
);

1361 i‡(
ªt
 <= 0) {

1362 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1363 i‡(
ªt
 =-
ENOSPC
 &&

1364 
	`pxt4_should_ªåy_Æloc
(
ó_öode
->
i_sb
, &
ªåõs
)) {

1365 
ªt
 = 0;

1366 
ªåy
;

1372 i‡(
ªt
 < 0)

1373  
ªt
;

1375 
block
 = 0;

1376 
wsize
 < 
bufsize
) {

1377 i‡(
bh
 !
NULL
)

1378 
	`bªl£
(
bh
);

1379 
csize
 = (
bufsize
 - 
wsize
Ë> 
blocksize
 ? blocksize :

1380 
bufsize
 - 
wsize
;

1381 
bh
 = 
	`pxt4_gëblk
(
h™dÀ
, 
ó_öode
, 
block
, 0);

1382 i‡(
	`IS_ERR
(
bh
))

1383  
	`PTR_ERR
(
bh
);

1384 i‡(!
bh
) {

1385 
	`WARN_ON_ONCE
(1);

1386 
	`PXT4_ERROR_INODE
(
ó_öode
,

1388  -
EFSCORRUPTED
;

1390 
ªt
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bh
);

1391 i‡(
ªt
)

1392 
out
;

1394 
	`mem˝y
(
bh
->
b_d©a
, 
buf
, 
csize
);

1395 
	`£t_buf„r_u±od©e
(
bh
);

1396 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
ó_öode
, 
bh
);

1398 
buf
 +
csize
;

1399 
wsize
 +
csize
;

1400 
block
 += 1;

1403 
	`öode_lock
(
ó_öode
);

1404 
	`i_size_wrôe
(
ó_öode
, 
wsize
);

1405 
	`pxt4_upd©e_i_disksize
(
ó_öode
, 
wsize
);

1406 
	`öode_u∆ock
(
ó_öode
);

1408 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1410 
out
:

1411 
	`bªl£
(
bh
);

1413  
ªt
;

1414 
	}
}

1419 
öode
 *
	$pxt4_x©å_öode_¸óã
(
h™dÀ_t
 *
h™dÀ
,

1420 
öode
 *öode, 
u32
 
hash
)

1422 
öode
 *
ó_öode
 = 
NULL
;

1423 
uid_t
 
ow√r
[2] = { 
	`i_uid_ªad
(
öode
), 
	`i_gid_ªad
(inode) };

1424 
îr
;

1430 
ó_öode
 = 
	`pxt4_√w_öode
(
h™dÀ
, 
öode
->
i_sb
->
s_roŸ
->
d_öode
,

1431 
S_IFREG
 | 0600, 
NULL
, 
öode
->
i_öo
 + 1, 
ow√r
,

1432 
PXT4_EA_INODE_FL
);

1433 i‡(!
	`IS_ERR
(
ó_öode
)) {

1434 
ó_öode
->
i_›
 = &
pxt4_fûe_öode_›î©i⁄s
;

1435 
ó_öode
->
i_f›
 = &
pxt4_fûe_›î©i⁄s
;

1436 
	`pxt4_£t_a›s
(
ó_öode
);

1437 
	`pxt4_x©å_öode_£t_˛ass
(
ó_öode
);

1438 
	`u∆ock_√w_öode
(
ó_öode
);

1439 
	`pxt4_x©å_öode_£t_ªf
(
ó_öode
, 1);

1440 
	`pxt4_x©å_öode_£t_hash
(
ó_öode
, 
hash
);

1441 
îr
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
ó_öode
);

1442 i‡(!
îr
)

1443 
îr
 = 
	`pxt4_öode_©èch_jöode
(
ó_öode
);

1444 i‡(
îr
) {

1445 
	`ùut
(
ó_öode
);

1446  
	`ERR_PTR
(
îr
);

1453 
	`dquŸ_‰ì_öode
(
ó_öode
);

1454 
	`dquŸ_dr›
(
ó_öode
);

1455 
	`öode_lock
(
ó_öode
);

1456 
ó_öode
->
i_Êags
 |
S_NOQUOTA
;

1457 
	`öode_u∆ock
(
ó_öode
);

1460  
ó_öode
;

1461 
	}
}

1463 
öode
 *

1464 
	$pxt4_x©å_öode_ˇche_föd
(
öode
 *öode, c⁄° *
vÆue
,

1465 
size_t
 
vÆue_Àn
, 
u32
 
hash
)

1467 
öode
 *
ó_öode
;

1468 
mb_ˇche_íåy
 *
˚
;

1469 
mb_ˇche
 *
ó_öode_ˇche
 = 
	`EA_INODE_CACHE
(
öode
);

1470 *
ó_d©a
;

1472 i‡(!
ó_öode_ˇche
)

1473  
NULL
;

1475 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_öode_ˇche
, 
hash
);

1476 i‡(!
˚
)

1477  
NULL
;

1479 
ó_d©a
 = 
	`pxt4_kvmÆloc
(
vÆue_Àn
, 
GFP_NOFS
);

1480 i‡(!
ó_d©a
) {

1481 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1482  
NULL
;

1485 
˚
) {

1486 
ó_öode
 = 
	`pxt4_igë
(
öode
->
i_sb
, 
˚
->
e_vÆue
,

1487 
PXT4_IGET_NORMAL
);

1488 i‡(!
	`IS_ERR
(
ó_öode
) &&

1489 !
	`is_bad_öode
(
ó_öode
) &&

1490 (
	`PXT4_I
(
ó_öode
)->
i_Êags
 & 
PXT4_EA_INODE_FL
) &&

1491 
	`i_size_ªad
(
ó_öode
Ë=
vÆue_Àn
 &&

1492 !
	`pxt4_x©å_öode_ªad
(
ó_öode
, 
ó_d©a
, 
vÆue_Àn
) &&

1493 !
	`pxt4_x©å_öode_vîify_hashes
(
ó_öode
, 
NULL
, 
ó_d©a
,

1494 
vÆue_Àn
) &&

1495 !
	`memcmp
(
vÆue
, 
ó_d©a
, 
vÆue_Àn
)) {

1496 
	`mb_ˇche_íåy_touch
(
ó_öode_ˇche
, 
˚
);

1497 
	`mb_ˇche_íåy_put
(
ó_öode_ˇche
, 
˚
);

1498 
	`kv‰ì
(
ó_d©a
);

1499  
ó_öode
;

1502 i‡(!
	`IS_ERR
(
ó_öode
))

1503 
	`ùut
(
ó_öode
);

1504 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_öode_ˇche
, ce);

1506 
	`kv‰ì
(
ó_d©a
);

1507  
NULL
;

1508 
	}
}

1513 
	$pxt4_x©å_öode_lookup_¸óã
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1514 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

1515 
öode
 **
ªt_öode
)

1517 
öode
 *
ó_öode
;

1518 
u32
 
hash
;

1519 
îr
;

1521 
hash
 = 
	`pxt4_x©å_öode_hash
(
	`PXT4_SB
(
öode
->
i_sb
), 
vÆue
, 
vÆue_Àn
);

1522 
ó_öode
 = 
	`pxt4_x©å_öode_ˇche_föd
(
öode
, 
vÆue
, 
vÆue_Àn
, 
hash
);

1523 i‡(
ó_öode
) {

1524 
îr
 = 
	`pxt4_x©å_öode_öc_ªf
(
h™dÀ
, 
ó_öode
);

1525 i‡(
îr
) {

1526 
	`ùut
(
ó_öode
);

1527  
îr
;

1530 *
ªt_öode
 = 
ó_öode
;

1535 
ó_öode
 = 
	`pxt4_x©å_öode_¸óã
(
h™dÀ
, 
öode
, 
hash
);

1536 i‡(
	`IS_ERR
(
ó_öode
))

1537  
	`PTR_ERR
(
ó_öode
);

1539 
îr
 = 
	`pxt4_x©å_öode_wrôe
(
h™dÀ
, 
ó_öode
, 
vÆue
, 
vÆue_Àn
);

1540 i‡(
îr
) {

1541 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

1542 
	`ùut
(
ó_öode
);

1543  
îr
;

1546 i‡(
	`EA_INODE_CACHE
(
öode
))

1547 
	`mb_ˇche_íåy_¸óã
(
	`EA_INODE_CACHE
(
öode
), 
GFP_NOFS
, 
hash
,

1548 
ó_öode
->
i_öo
, 
åue
 );

1550 *
ªt_öode
 = 
ó_öode
;

1552 
	}
}

1558 
	#PXT4_XATTR_BLOCK_RESERVE
(
öode
Ë
	`mö
(
	`i_blocksize
(öode)/8, 1024U)

	)

1560 
	$pxt4_x©å_£t_íåy
(
pxt4_x©å_öfo
 *
i
,

1561 
pxt4_x©å_£¨ch
 *
s
,

1562 
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1563 
boﬁ
 
is_block
)

1565 
pxt4_x©å_íåy
 *
œ°
, *
√xt
;

1566 
pxt4_x©å_íåy
 *
hîe
 = 
s
->here;

1567 
size_t
 
mö_offs
 = 
s
->
íd
 - s->
ba£
, 
«me_Àn
 = 
	`°æí
(
i
->
«me
);

1568 
ö_öode
 = 
i
->in_inode;

1569 
öode
 *
ﬁd_ó_öode
 = 
NULL
;

1570 
öode
 *
√w_ó_öode
 = 
NULL
;

1571 
size_t
 
ﬁd_size
, 
√w_size
;

1572 
ªt
;

1575 
ﬁd_size
 = (!
s
->
nŸ_found
 && !
hîe
->
e_vÆue_öum
) ?

1576 
	`PXT4_XATTR_SIZE
(
	`À32_to_˝u
(
hîe
->
e_vÆue_size
)) : 0;

1577 
√w_size
 = (
i
->
vÆue
 && !
ö_öode
Ë? 
	`PXT4_XATTR_SIZE
(i->
vÆue_Àn
) : 0;

1583 i‡(
√w_size
 &&Çew_sizê=
ﬁd_size
) {

1584 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1585 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1587 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1588 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1589 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1591 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1593 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0, 
√w_size
 - i->value_len);

1595 
upd©e_hash
;

1599 
œ°
 = 
s
->
fú°
;

1600 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
√xt
) {

1601 
√xt
 = 
	`PXT4_XATTR_NEXT
(
œ°
);

1602 i‡((*)
√xt
 >
s
->
íd
) {

1603 
	`PXT4_ERROR_INODE
(
öode
, "corrupted xattrÉntries");

1604 
ªt
 = -
EFSCORRUPTED
;

1605 
out
;

1607 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

1608 
size_t
 
offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1609 i‡(
offs
 < 
mö_offs
)

1610 
mö_offs
 = 
offs
;

1615 i‡(
i
->
vÆue
) {

1616 
size_t
 
‰ì
;

1618 
‰ì
 = 
mö_offs
 - ((*)
œ°
 - 
s
->
ba£
Ë- (
__u32
);

1619 i‡(!
s
->
nŸ_found
)

1620 
‰ì
 +
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
ﬁd_size
;

1622 i‡(
‰ì
 < 
	`PXT4_XATTR_LEN
(
«me_Àn
Ë+ 
√w_size
) {

1623 
ªt
 = -
ENOSPC
;

1624 
out
;

1633 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

1634 
√w_size
 && 
is_block
 &&

1635 (
mö_offs
 + 
ﬁd_size
 - 
√w_size
) <

1636 
	`PXT4_XATTR_BLOCK_RESERVE
(
öode
)) {

1637 
ªt
 = -
ENOSPC
;

1638 
out
;

1646 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_öum
) {

1647 
ªt
 = 
	`pxt4_x©å_öode_igë
(
öode
,

1648 
	`À32_to_˝u
(
hîe
->
e_vÆue_öum
),

1649 
	`À32_to_˝u
(
hîe
->
e_hash
),

1650 &
ﬁd_ó_öode
);

1651 i‡(
ªt
) {

1652 
ﬁd_ó_öode
 = 
NULL
;

1653 
out
;

1656 i‡(
i
->
vÆue
 && 
ö_öode
) {

1657 
	`WARN_ON_ONCE
(!
i
->
vÆue_Àn
);

1659 
ªt
 = 
	`pxt4_x©å_öode_Æloc_quŸa
(
öode
, 
i
->
vÆue_Àn
);

1660 i‡(
ªt
)

1661 
out
;

1663 
ªt
 = 
	`pxt4_x©å_öode_lookup_¸óã
(
h™dÀ
, 
öode
, 
i
->
vÆue
,

1664 
i
->
vÆue_Àn
,

1665 &
√w_ó_öode
);

1666 i‡(
ªt
) {

1667 
√w_ó_öode
 = 
NULL
;

1668 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
i
->
vÆue_Àn
);

1669 
out
;

1673 i‡(
ﬁd_ó_öode
) {

1675 
ªt
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ﬁd_ó_öode
);

1676 i‡(
ªt
) {

1678 i‡(
√w_ó_öode
) {

1679 
îr
;

1681 
îr
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

1682 
√w_ó_öode
);

1683 i‡(
îr
)

1684 
	`pxt4_w¨nög_öode
(
√w_ó_öode
,

1686 
îr
);

1687 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
√w_ó_öode
,

1688 
i
->
vÆue_Àn
);

1690 
out
;

1693 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ﬁd_ó_öode
,

1694 
	`À32_to_˝u
(
hîe
->
e_vÆue_size
));

1699 i‡(!
s
->
nŸ_found
 && 
hîe
->
e_vÆue_size
 && !hîe->
e_vÆue_öum
) {

1701 *
fú°_vÆ
 = 
s
->
ba£
 + 
mö_offs
;

1702 
size_t
 
offs
 = 
	`À16_to_˝u
(
hîe
->
e_vÆue_offs
);

1703 *
vÆ
 = 
s
->
ba£
 + 
offs
;

1705 
	`memmove
(
fú°_vÆ
 + 
ﬁd_size
, fú°_vÆ, 
vÆ
 - first_val);

1706 
	`mem£t
(
fú°_vÆ
, 0, 
ﬁd_size
);

1707 
mö_offs
 +
ﬁd_size
;

1710 
œ°
 = 
s
->
fú°
;

1711 !
	`IS_LAST_ENTRY
(
œ°
)) {

1712 
size_t
 
o
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
);

1714 i‡(!
œ°
->
e_vÆue_öum
 &&

1715 
œ°
->
e_vÆue_size
 && 
o
 < 
offs
)

1716 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
o
 + 
ﬁd_size
);

1717 
œ°
 = 
	`PXT4_XATTR_NEXT
(last);

1721 i‡(!
i
->
vÆue
) {

1723 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1725 
œ°
 = 
	`ENTRY
((*Óa° - 
size
);

1726 
	`memmove
(
hîe
, (*)hîê+ 
size
,

1727 (*)
œ°
 - (*)
hîe
 + (
__u32
));

1728 
	`mem£t
(
œ°
, 0, 
size
);

1729 } i‡(
s
->
nŸ_found
) {

1731 
size_t
 
size
 = 
	`PXT4_XATTR_LEN
(
«me_Àn
);

1732 
size_t
 
ª°
 = (*)
œ°
 - (*)
hîe
 + (
__u32
);

1734 
	`memmove
((*)
hîe
 + 
size
, hîe, 
ª°
);

1735 
	`mem£t
(
hîe
, 0, 
size
);

1736 
hîe
->
e_«me_ödex
 = 
i
->
«me_ödex
;

1737 
hîe
->
e_«me_Àn
 = 
«me_Àn
;

1738 
	`mem˝y
(
hîe
->
e_«me
, 
i
->
«me
, 
«me_Àn
);

1741 
hîe
->
e_vÆue_öum
 = 0;

1742 
hîe
->
e_vÆue_offs
 = 0;

1743 
hîe
->
e_vÆue_size
 = 0;

1746 i‡(
i
->
vÆue
) {

1748 i‡(
ö_öode
) {

1749 
hîe
->
e_vÆue_öum
 = 
	`˝u_to_À32
(
√w_ó_öode
->
i_öo
);

1750 } i‡(
i
->
vÆue_Àn
) {

1751 *
vÆ
 = 
s
->
ba£
 + 
mö_offs
 - 
√w_size
;

1753 
hîe
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
mö_offs
 - 
√w_size
);

1754 i‡(
i
->
vÆue
 =
PXT4_ZERO_XATTR_VALUE
) {

1755 
	`mem£t
(
vÆ
, 0, 
√w_size
);

1757 
	`mem˝y
(
vÆ
, 
i
->
vÆue
, i->
vÆue_Àn
);

1759 
	`mem£t
(
vÆ
 + 
i
->
vÆue_Àn
, 0,

1760 
√w_size
 - 
i
->
vÆue_Àn
);

1763 
hîe
->
e_vÆue_size
 = 
	`˝u_to_À32
(
i
->
vÆue_Àn
);

1766 
upd©e_hash
:

1767 i‡(
i
->
vÆue
) {

1768 
__À32
 
hash
 = 0;

1771 i‡(
ö_öode
) {

1772 
__À32
 
¸c32c_hash
;

1779 
¸c32c_hash
 = 
	`˝u_to_À32
(

1780 
	`pxt4_x©å_öode_gë_hash
(
√w_ó_öode
));

1781 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1782 
hîe
->
e_«me_Àn
,

1783 &
¸c32c_hash
, 1);

1784 } i‡(
is_block
) {

1785 
__À32
 *
vÆue
 = 
s
->
ba£
 + 
	`À16_to_˝u
(

1786 
hîe
->
e_vÆue_offs
);

1788 
hash
 = 
	`pxt4_x©å_hash_íåy
(
hîe
->
e_«me
,

1789 
hîe
->
e_«me_Àn
, 
vÆue
,

1790 
√w_size
 >> 2);

1792 
hîe
->
e_hash
 = 
hash
;

1795 i‡(
is_block
)

1796 
	`pxt4_x©å_ªhash
((
pxt4_x©å_hódî
 *)
s
->
ba£
);

1798 
ªt
 = 0;

1799 
out
:

1800 
	`ùut
(
ﬁd_ó_öode
);

1801 
	`ùut
(
√w_ó_öode
);

1802  
ªt
;

1803 
	}
}

1805 
	spxt4_x©å_block_föd
 {

1806 
pxt4_x©å_£¨ch
 
	ms
;

1807 
buf„r_hód
 *
	mbh
;

1811 
	$pxt4_x©å_block_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

1812 
pxt4_x©å_block_föd
 *
bs
)

1814 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1815 
îr‹
;

1817 
	`ó_idebug
(
öode
, "name=%d.%s, value=%p, value_len=%ld",

1818 
i
->
«me_ödex
, i->
«me
, i->
vÆue
, ()i->
vÆue_Àn
);

1820 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

1822 
bs
->
bh
 = 
	`pxt4_sb_bªad
(
sb
, 
	`PXT4_I
(
öode
)->
i_fûe_a˛
, 
REQ_PRIO
);

1823 i‡(
	`IS_ERR
(
bs
->
bh
))

1824  
	`PTR_ERR
(
bs
->
bh
);

1825 
	`ó_bdebug
(
bs
->
bh
, "b_count=%d,Ñefcount=%d",

1826 
	`©omic_ªad
(&(
bs
->
bh
->
b_cou¡
)),

1827 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_ªfcou¡
));

1828 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bs
->
bh
);

1829 i‡(
îr‹
)

1830  
îr‹
;

1832 
bs
->
s
.
ba£
 = 
	`BHDR
(bs->
bh
);

1833 
bs
->
s
.
fú°
 = 
	`BFIRST
(bs->
bh
);

1834 
bs
->
s
.
íd
 = bs->
bh
->
b_d©a
 + bs->bh->
b_size
;

1835 
bs
->
s
.
hîe
 = bs->s.
fú°
;

1836 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
bs
->
s
.
hîe
, bs->s.
íd
,

1837 
i
->
«me_ödex
, i->
«me
, 1);

1838 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

1839  
îr‹
;

1840 
bs
->
s
.
nŸ_found
 = 
îr‹
;

1843 
	}
}

1846 
	$pxt4_x©å_block_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

1847 
pxt4_x©å_öfo
 *
i
,

1848 
pxt4_x©å_block_föd
 *
bs
)

1850 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

1851 
buf„r_hód
 *
√w_bh
 = 
NULL
;

1852 
pxt4_x©å_£¨ch
 
s_c›y
 = 
bs
->
s
;

1853 
pxt4_x©å_£¨ch
 *
s
 = &
s_c›y
;

1854 
mb_ˇche_íåy
 *
˚
 = 
NULL
;

1855 
îr‹
 = 0;

1856 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

1857 
öode
 *
ó_öode
 = 
NULL
, *
tmp_öode
;

1858 
size_t
 
ﬁd_ó_öode_quŸa
 = 0;

1859 
ó_öo
;

1862 
	#hódî
(
x
Ë((
pxt4_x©å_hódî
 *)(x))

	)

1864 i‡(
s
->
ba£
) {

1865 
	`BUFFER_TRACE
(
bs
->
bh
, "get_write_access");

1866 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
bs
->
bh
);

1867 i‡(
îr‹
)

1868 
˛ónup
;

1869 
	`lock_buf„r
(
bs
->
bh
);

1871 i‡(
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 =
	`˝u_to_À32
(1)) {

1872 
__u32
 
hash
 = 
	`À32_to_˝u
(
	`BHDR
(
bs
->
bh
)->
h_hash
);

1879 i‡(
ó_block_ˇche
)

1880 
	`mb_ˇche_íåy_dñëe
(
ó_block_ˇche
, 
hash
,

1881 
bs
->
bh
->
b_blockƒ
);

1882 
	`ó_bdebug
(
bs
->
bh
, "modifying in-place");

1883 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
,

1884 
åue
 );

1885 
	`pxt4_x©å_block_csum_£t
(
öode
, 
bs
->
bh
);

1886 
	`u∆ock_buf„r
(
bs
->
bh
);

1887 i‡(
îr‹
 =-
EFSCORRUPTED
)

1888 
bad_block
;

1889 i‡(!
îr‹
)

1890 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

1891 
öode
,

1892 
bs
->
bh
);

1893 i‡(
îr‹
)

1894 
˛ónup
;

1895 
ö£πed
;

1897 
off£t
 = (*)
s
->
hîe
 - 
bs
->
bh
->
b_d©a
;

1899 
	`u∆ock_buf„r
(
bs
->
bh
);

1900 
	`ó_bdebug
(
bs
->
bh
, "cloning");

1901 
s
->
ba£
 = 
	`kmÆloc
(
bs
->
bh
->
b_size
, 
GFP_NOFS
);

1902 
îr‹
 = -
ENOMEM
;

1903 i‡(
s
->
ba£
 =
NULL
)

1904 
˛ónup
;

1905 
	`mem˝y
(
s
->
ba£
, 
	`BHDR
(
bs
->
bh
), bs->bh->
b_size
);

1906 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1907 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1908 
s
->
hîe
 = 
	`ENTRY
(s->
ba£
 + 
off£t
);

1909 
s
->
íd
 = s->
ba£
 + 
bs
->
bh
->
b_size
;

1918 i‡(!
s
->
nŸ_found
 && s->
hîe
->
e_vÆue_öum
) {

1919 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1920 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1921 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1922 &
tmp_öode
);

1923 i‡(
îr‹
)

1924 
˛ónup
;

1926 i‡(!
	`pxt4_ã°_öode_°©e
(
tmp_öode
,

1927 
PXT4_STATE_LUSTRE_EA_INODE
)) {

1932 
ﬁd_ó_öode_quŸa
 = 
	`À32_to_˝u
(

1933 
s
->
hîe
->
e_vÆue_size
);

1935 
	`ùut
(
tmp_öode
);

1937 
s
->
hîe
->
e_vÆue_öum
 = 0;

1938 
s
->
hîe
->
e_vÆue_size
 = 0;

1943 
s
->
ba£
 = 
	`kzÆloc
(
sb
->
s_blocksize
, 
GFP_NOFS
);

1945 
îr‹
 = -
ENOMEM
;

1946 i‡(
s
->
ba£
 =
NULL
)

1947 
˛ónup
;

1948 
	`hódî
(
s
->
ba£
)->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

1949 
	`hódî
(
s
->
ba£
)->
h_blocks
 = 
	`˝u_to_À32
(1);

1950 
	`hódî
(
s
->
ba£
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(1);

1951 
s
->
fú°
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1952 
s
->
hîe
 = 
	`ENTRY
(
	`hódî
(s->
ba£
)+1);

1953 
s
->
íd
 = s->
ba£
 + 
sb
->
s_blocksize
;

1956 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
åue
 );

1957 i‡(
îr‹
 =-
EFSCORRUPTED
)

1958 
bad_block
;

1959 i‡(
îr‹
)

1960 
˛ónup
;

1962 i‡(
i
->
vÆue
 && 
s
->
hîe
->
e_vÆue_öum
) {

1969 
ó_öo
 = 
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_öum
);

1970 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
, 
ó_öo
,

1971 
	`À32_to_˝u
(
s
->
hîe
->
e_hash
),

1972 &
ó_öode
);

1973 i‡(
îr‹
) {

1974 
ó_öode
 = 
NULL
;

1975 
˛ónup
;

1979 
ö£πed
:

1980 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

1981 
√w_bh
 = 
	`pxt4_x©å_block_ˇche_föd
(
öode
, 
	`hódî
(
s
->
ba£
),

1982 &
˚
);

1983 i‡(
√w_bh
) {

1985 i‡(
√w_bh
 =
bs
->
bh
)

1986 
	`ó_bdebug
(
√w_bh
, "keeping");

1988 
u32
 
ªf
;

1990 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

1994 
îr‹
 = 
	`dquŸ_Æloc_block
(
öode
,

1995 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

1996 i‡(
îr‹
)

1997 
˛ónup
;

1998 
	`BUFFER_TRACE
(
√w_bh
, "get_write_access");

1999 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
,

2000 
√w_bh
);

2001 i‡(
îr‹
)

2002 
˛ónup_dquŸ
;

2003 
	`lock_buf„r
(
√w_bh
);

2016 i‡(
	`hli°_bl_unhashed
(&
˚
->
e_hash_li°
) ||

2017 !
˚
->
e_ªußbÀ
) {

2022 
	`u∆ock_buf„r
(
√w_bh
);

2023 
	`dquŸ_‰ì_block
(
öode
,

2024 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
),

2026 
	`bªl£
(
√w_bh
);

2027 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2028 
˚
 = 
NULL
;

2029 
√w_bh
 = 
NULL
;

2030 
ö£πed
;

2032 
ªf
 = 
	`À32_to_˝u
(
	`BHDR
(
√w_bh
)->
h_ªfcou¡
) + 1;

2033 
	`BHDR
(
√w_bh
)->
h_ªfcou¡
 = 
	`˝u_to_À32
(
ªf
);

2034 i‡(
ªf
 >
PXT4_XATTR_REFCOUNT_MAX
)

2035 
˚
->
e_ªußbÀ
 = 0;

2036 
	`ó_bdebug
(
√w_bh
, "reusing;ÑefcountÇow=%d",

2037 
ªf
);

2038 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2039 
	`u∆ock_buf„r
(
√w_bh
);

2040 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
,

2041 
öode
,

2042 
√w_bh
);

2043 i‡(
îr‹
)

2044 
˛ónup_dquŸ
;

2046 
	`mb_ˇche_íåy_touch
(
ó_block_ˇche
, 
˚
);

2047 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2048 
˚
 = 
NULL
;

2049 } i‡(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
) {

2051 
	`ó_bdebug
(
bs
->
bh
, "keepingÅhis block");

2052 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
bs
->
bh
);

2053 
√w_bh
 = 
bs
->
bh
;

2054 
	`gë_bh
(
√w_bh
);

2057 
pxt4_fsblk_t
 
gﬂl
, 
block
;

2059 
	`WARN_ON_ONCE
(
	`dquŸ_öôülize_√eded
(
öode
));

2061 
gﬂl
 = 
	`pxt4_group_fú°_block_no
(
sb
,

2062 
	`PXT4_I
(
öode
)->
i_block_group
);

2065 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2066 
gﬂl
 = gﬂ»& 
PXT4_MAX_BLOCK_FILE_PHYS
;

2068 
block
 = 
	`pxt4_√w_mëa_blocks
(
h™dÀ
, 
öode
, 
gﬂl
, 0,

2069 
NULL
, &
îr‹
);

2070 i‡(
îr‹
)

2071 
˛ónup
;

2073 i‡(!(
	`pxt4_ã°_öode_Êag
(
öode
, 
PXT4_INODE_EXTENTS
)))

2074 
	`BUG_ON
(
block
 > 
PXT4_MAX_BLOCK_FILE_PHYS
);

2076 
	`ó_idebug
(
öode
, "creating block %llu",

2077 ()
block
);

2079 
√w_bh
 = 
	`sb_gëblk
(
sb
, 
block
);

2080 i‡(
	`u∆ikñy
(!
√w_bh
)) {

2081 
îr‹
 = -
ENOMEM
;

2082 
gëblk_Áûed
:

2083 
	`pxt4_‰ì_blocks
(
h™dÀ
, 
öode
, 
NULL
, 
block
, 1,

2084 
PXT4_FREE_BLOCKS_METADATA
);

2085 
˛ónup
;

2087 
îr‹
 = 
	`pxt4_x©å_öode_öc_ªf_Æl
(
h™dÀ
, 
öode
,

2088 
	`ENTRY
(
	`hódî
(
s
->
ba£
)+1));

2089 i‡(
îr‹
)

2090 
gëblk_Áûed
;

2091 i‡(
ó_öode
) {

2093 
îr‹
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
,

2094 
ó_öode
);

2095 i‡(
îr‹
)

2096 
	`pxt4_w¨nög_öode
(
ó_öode
,

2098 
îr‹
);

2099 
	`ùut
(
ó_öode
);

2100 
ó_öode
 = 
NULL
;

2103 
	`lock_buf„r
(
√w_bh
);

2104 
îr‹
 = 
	`pxt4_jou∫Æ_gë_¸óã_ac˚ss
(
h™dÀ
, 
√w_bh
);

2105 i‡(
îr‹
) {

2106 
	`u∆ock_buf„r
(
√w_bh
);

2107 
îr‹
 = -
EIO
;

2108 
gëblk_Áûed
;

2110 
	`mem˝y
(
√w_bh
->
b_d©a
, 
s
->
ba£
,Çew_bh->
b_size
);

2111 
	`pxt4_x©å_block_csum_£t
(
öode
, 
√w_bh
);

2112 
	`£t_buf„r_u±od©e
(
√w_bh
);

2113 
	`u∆ock_buf„r
(
√w_bh
);

2114 
	`pxt4_x©å_block_ˇche_ö£π
(
ó_block_ˇche
, 
√w_bh
);

2115 
îr‹
 = 
	`pxt4_h™dÀ_dúty_mëad©a
(
h™dÀ
, 
öode
,

2116 
√w_bh
);

2117 i‡(
îr‹
)

2118 
˛ónup
;

2122 i‡(
ﬁd_ó_öode_quŸa
)

2123 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
NULL
, 
ﬁd_ó_öode_quŸa
);

2126 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 
√w_bh
 ?Çew_bh->
b_blockƒ
 : 0;

2129 i‡(
bs
->
bh
 && bs->bh !
√w_bh
) {

2130 
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
 = 
NULL
;

2132 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bs
->
bh
,

2133 &
ó_öode_¨øy
,

2135 
	`pxt4_x©å_öode_¨øy_‰ì
(
ó_öode_¨øy
);

2137 
îr‹
 = 0;

2139 
˛ónup
:

2140 i‡(
ó_öode
) {

2141 
îr‹2
;

2143 
îr‹2
 = 
	`pxt4_x©å_öode_dec_ªf
(
h™dÀ
, 
ó_öode
);

2144 i‡(
îr‹2
)

2145 
	`pxt4_w¨nög_öode
(
ó_öode
, "decÑefÉrror=%d",

2146 
îr‹2
);

2149 i‡(
îr‹
)

2150 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2151 
	`i_size_ªad
(
ó_öode
));

2152 
	`ùut
(
ó_öode
);

2154 i‡(
˚
)

2155 
	`mb_ˇche_íåy_put
(
ó_block_ˇche
, 
˚
);

2156 
	`bªl£
(
√w_bh
);

2157 i‡(!(
bs
->
bh
 && 
s
->
ba£
 =bs->bh->
b_d©a
))

2158 
	`k‰ì
(
s
->
ba£
);

2160  
îr‹
;

2162 
˛ónup_dquŸ
:

2163 
	`dquŸ_‰ì_block
(
öode
, 
	`PXT4_C2B
(
	`PXT4_SB
(
sb
), 1));

2164 
˛ónup
;

2166 
bad_block
:

2167 
	`PXT4_ERROR_INODE
(
öode
, "bad block %llu",

2168 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2169 
˛ónup
;

2171 #unde‡
hódî


2172 
	}
}

2174 
	$pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

2175 
pxt4_x©å_ibody_föd
 *
is
)

2177 
pxt4_x©å_ibody_hódî
 *
hódî
;

2178 
pxt4_öode
 *
øw_öode
;

2179 
îr‹
;

2181 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2183 
øw_öode
 = 
	`pxt4_øw_öode
(&
is
->
ûoc
);

2184 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2185 
is
->
s
.
ba£
 = is->s.
fú°
 = 
	`IFIRST
(
hódî
);

2186 
is
->
s
.
hîe
 = is->s.
fú°
;

2187 
is
->
s
.
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2188 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2189 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
is
->
s
.
íd
);

2190 i‡(
îr‹
)

2191  
îr‹
;

2193 
îr‹
 = 
	`x©å_föd_íåy
(
öode
, &
is
->
s
.
hîe
, is->s.
íd
,

2194 
i
->
«me_ödex
, i->
«me
, 0);

2195 i‡(
îr‹
 &&Éº‹ !-
ENODATA
)

2196  
îr‹
;

2197 
is
->
s
.
nŸ_found
 = 
îr‹
;

2200 
	}
}

2202 
	$pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2203 
pxt4_x©å_öfo
 *
i
,

2204 
pxt4_x©å_ibody_föd
 *
is
)

2206 
pxt4_x©å_ibody_hódî
 *
hódî
;

2207 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2208 
îr‹
;

2210 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2211  -
ENOSPC
;

2212 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2213 i‡(
îr‹
)

2214  
îr‹
;

2215 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2216 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2217 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2218 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2220 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2221 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2224 
	}
}

2226 
	$pxt4_x©å_ibody_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2227 
pxt4_x©å_öfo
 *
i
,

2228 
pxt4_x©å_ibody_föd
 *
is
)

2230 
pxt4_x©å_ibody_hódî
 *
hódî
;

2231 
pxt4_x©å_£¨ch
 *
s
 = &
is
->s;

2232 
îr‹
;

2234 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 == 0)

2235  -
ENOSPC
;

2236 
îr‹
 = 
	`pxt4_x©å_£t_íåy
(
i
, 
s
, 
h™dÀ
, 
öode
, 
Ál£
 );

2237 i‡(
îr‹
)

2238  
îr‹
;

2239 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
is
->
ûoc
));

2240 i‡(!
	`IS_LAST_ENTRY
(
s
->
fú°
)) {

2241 
hódî
->
h_magic
 = 
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
);

2242 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2244 
hódî
->
h_magic
 = 
	`˝u_to_À32
(0);

2245 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
);

2248 
	}
}

2250 
	$pxt4_x©å_vÆue_ßme
(
pxt4_x©å_£¨ch
 *
s
,

2251 
pxt4_x©å_öfo
 *
i
)

2253 *
vÆue
;

2256 i‡(
s
->
hîe
->
e_vÆue_öum
)

2258 i‡(
	`À32_to_˝u
(
s
->
hîe
->
e_vÆue_size
Ë!
i
->
vÆue_Àn
)

2260 
vÆue
 = ((*)
s
->
ba£
Ë+ 
	`À16_to_˝u
(s->
hîe
->
e_vÆue_offs
);

2261  !
	`memcmp
(
vÆue
, 
i
->vÆue, i->
vÆue_Àn
);

2262 
	}
}

2264 
buf„r_hód
 *
	$pxt4_x©å_gë_block
(
öode
 *inode)

2266 
buf„r_hód
 *
bh
;

2267 
îr‹
;

2269 i‡(!
	`PXT4_I
(
öode
)->
i_fûe_a˛
)

2270  
NULL
;

2271 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2272 i‡(
	`IS_ERR
(
bh
))

2273  
bh
;

2274 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2275 i‡(
îr‹
) {

2276 
	`bªl£
(
bh
);

2277  
	`ERR_PTR
(
îr‹
);

2279  
bh
;

2280 
	}
}

2295 
	$pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, 
«me_ödex
,

2296 c⁄° *
«me
, c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
,

2297 
Êags
)

2299 
pxt4_x©å_öfo
 
i
 = {

2300 .
«me_ödex
 =Çame_index,

2301 .
«me
 =Çame,

2302 .
vÆue
 = value,

2303 .
vÆue_Àn
 = value_len,

2304 .
ö_öode
 = 0,

2306 
pxt4_x©å_ibody_föd
 
is
 = {

2307 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2309 
pxt4_x©å_block_föd
 
bs
 = {

2310 .
s
 = { .
nŸ_found
 = -
ENODATA
, },

2312 
no_ex∑nd
;

2313 
îr‹
;

2315 i‡(!
«me
)

2316  -
EINVAL
;

2317 i‡(
	`°æí
(
«me
) > 255)

2318  -
ERANGE
;

2320 
	`pxt4_wrôe_lock_x©å
(
öode
, &
no_ex∑nd
);

2323 i‡(
	`pxt4_h™dÀ_vÆid
(
h™dÀ
)) {

2324 
buf„r_hód
 *
bh
;

2325 
¸edôs
;

2327 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2328 i‡(
	`IS_ERR
(
bh
)) {

2329 
îr‹
 = 
	`PTR_ERR
(
bh
);

2330 
˛ónup
;

2333 
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2334 
vÆue_Àn
,

2335 
Êags
 & 
XATTR_CREATE
);

2336 
	`bªl£
(
bh
);

2338 i‡(!
	`pxt4_h™dÀ_has_íough_¸edôs
(
h™dÀ
, 
¸edôs
)) {

2339 
îr‹
 = -
ENOSPC
;

2340 
˛ónup
;

2344 
îr‹
 = 
	`pxt4_ª£rve_öode_wrôe
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2345 i‡(
îr‹
)

2346 
˛ónup
;

2348 i‡(
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NEW
)) {

2349 
pxt4_öode
 *
øw_öode
 = 
	`pxt4_øw_öode
(&
is
.
ûoc
);

2350 
	`mem£t
(
øw_öode
, 0, 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
);

2351 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NEW
);

2354 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, &
is
);

2355 i‡(
îr‹
)

2356 
˛ónup
;

2357 i‡(
is
.
s
.
nŸ_found
)

2358 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2359 i‡(
îr‹
)

2360 
˛ónup
;

2361 i‡(
is
.
s
.
nŸ_found
 && 
bs
.s.not_found) {

2362 
îr‹
 = -
ENODATA
;

2363 i‡(
Êags
 & 
XATTR_REPLACE
)

2364 
˛ónup
;

2365 
îr‹
 = 0;

2366 i‡(!
vÆue
)

2367 
˛ónup
;

2369 
îr‹
 = -
EEXIST
;

2370 i‡(
Êags
 & 
XATTR_CREATE
)

2371 
˛ónup
;

2374 i‡(!
vÆue
) {

2375 i‡(!
is
.
s
.
nŸ_found
)

2376 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2377 i‡(!
bs
.
s
.
nŸ_found
)

2378 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2380 
îr‹
 = 0;

2382 i‡(!
is
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&is.s, &
i
))

2383 
˛ónup
;

2384 i‡(!
bs
.
s
.
nŸ_found
 && 
	`pxt4_x©å_vÆue_ßme
(&bs.s, &
i
))

2385 
˛ónup
;

2387 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2388 (
	`PXT4_XATTR_SIZE
(
i
.
vÆue_Àn
) >

2389 
	`PXT4_XATTR_MIN_LARGE_EA_SIZE
(
öode
->
i_sb
->
s_blocksize
)))

2390 
i
.
ö_öode
 = 1;

2391 
ªåy_öode
:

2392 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, &
is
);

2393 i‡(!
îr‹
 && !
bs
.
s
.
nŸ_found
) {

2394 
i
.
vÆue
 = 
NULL
;

2395 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2396 } i‡(
îr‹
 =-
ENOSPC
) {

2397 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
 && !
bs
.
s
.
ba£
) {

2398 
	`bªl£
(
bs
.
bh
);

2399 
bs
.
bh
 = 
NULL
;

2400 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, &
bs
);

2401 i‡(
îr‹
)

2402 
˛ónup
;

2404 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, &
bs
);

2405 i‡(!
îr‹
 && !
is
.
s
.
nŸ_found
) {

2406 
i
.
vÆue
 = 
NULL
;

2407 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
,

2408 &
is
);

2409 } i‡(
îr‹
 =-
ENOSPC
) {

2414 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2415 !
i
.
ö_öode
) {

2416 
i
.
ö_öode
 = 1;

2417 
ªåy_öode
;

2422 i‡(!
îr‹
) {

2423 
	`pxt4_x©å_upd©e_su≥r_block
(
h™dÀ
, 
öode
->
i_sb
);

2424 
öode
->
i_˘ime
 = 
	`cuºít_time
(inode);

2425 i‡(!
vÆue
)

2426 
no_ex∑nd
 = 0;

2427 
îr‹
 = 
	`pxt4_m¨k_ûoc_dúty
(
h™dÀ
, 
öode
, &
is
.
ûoc
);

2432 
is
.
ûoc
.
bh
 = 
NULL
;

2433 i‡(
	`IS_SYNC
(
öode
))

2434 
	`pxt4_h™dÀ_sync
(
h™dÀ
);

2437 
˛ónup
:

2438 
	`bªl£
(
is
.
ûoc
.
bh
);

2439 
	`bªl£
(
bs
.
bh
);

2440 
	`pxt4_wrôe_u∆ock_x©å
(
öode
, &
no_ex∑nd
);

2441  
îr‹
;

2442 
	}
}

2444 
	$pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

2445 
boﬁ
 
is_¸óã
, *
¸edôs
)

2447 
buf„r_hód
 *
bh
;

2448 
îr
;

2450 *
¸edôs
 = 0;

2452 i‡(!
	`PXT4_SB
(
öode
->
i_sb
)->
s_jou∫Æ
)

2455 
	`down_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2457 
bh
 = 
	`pxt4_x©å_gë_block
(
öode
);

2458 i‡(
	`IS_ERR
(
bh
)) {

2459 
îr
 = 
	`PTR_ERR
(
bh
);

2461 *
¸edôs
 = 
	`__pxt4_x©å_£t_¸edôs
(
öode
->
i_sb
, inode, 
bh
,

2462 
vÆue_Àn
, 
is_¸óã
);

2463 
	`bªl£
(
bh
);

2464 
îr
 = 0;

2467 
	`up_ªad
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

2468  
îr
;

2469 
	}
}

2480 
	$pxt4_x©å_£t
(
öode
 *öode, 
«me_ödex
, c⁄° *
«me
,

2481 c⁄° *
vÆue
, 
size_t
 
vÆue_Àn
, 
Êags
)

2483 
h™dÀ_t
 *
h™dÀ
;

2484 
su≥r_block
 *
sb
 = 
öode
->
i_sb
;

2485 
îr‹
, 
ªåõs
 = 0;

2486 
¸edôs
;

2488 
îr‹
 = 
	`dquŸ_öôülize
(
öode
);

2489 i‡(
îr‹
)

2490  
îr‹
;

2492 
ªåy
:

2493 
îr‹
 = 
	`pxt4_x©å_£t_¸edôs
(
öode
, 
vÆue_Àn
, 
Êags
 & 
XATTR_CREATE
,

2494 &
¸edôs
);

2495 i‡(
îr‹
)

2496  
îr‹
;

2498 
h™dÀ
 = 
	`pxt4_jou∫Æ_°¨t
(
öode
, 
PXT4_HT_XATTR
, 
¸edôs
);

2499 i‡(
	`IS_ERR
(
h™dÀ
)) {

2500 
îr‹
 = 
	`PTR_ERR
(
h™dÀ
);

2502 
îr‹2
;

2504 
îr‹
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
, 
«me_ödex
, 
«me
,

2505 
vÆue
, 
vÆue_Àn
, 
Êags
);

2506 
îr‹2
 = 
	`pxt4_jou∫Æ_°›
(
h™dÀ
);

2507 i‡(
îr‹
 =-
ENOSPC
 &&

2508 
	`pxt4_should_ªåy_Æloc
(
sb
, &
ªåõs
))

2509 
ªåy
;

2510 i‡(
îr‹
 == 0)

2511 
îr‹
 = 
îr‹2
;

2514  
îr‹
;

2515 
	}
}

2521 
	$pxt4_x©å_shi·_íåõs
(
pxt4_x©å_íåy
 *
íåy
,

2522 
vÆue_offs_shi·
, *
to
,

2523 *
‰om
, 
size_t
 
n
)

2525 
pxt4_x©å_íåy
 *
œ°
 = 
íåy
;

2526 
√w_offs
;

2529 
	`BUG_ON
(
vÆue_offs_shi·
 > 0);

2532 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2533 i‡(!
œ°
->
e_vÆue_öum
 &&Üa°->
e_vÆue_size
) {

2534 
√w_offs
 = 
	`À16_to_˝u
(
œ°
->
e_vÆue_offs
) +

2535 
vÆue_offs_shi·
;

2536 
œ°
->
e_vÆue_offs
 = 
	`˝u_to_À16
(
√w_offs
);

2540 
	`memmove
(
to
, 
‰om
, 
n
);

2541 
	}
}

2546 
	$pxt4_x©å_move_to_block
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2547 
pxt4_öode
 *
øw_öode
,

2548 
pxt4_x©å_íåy
 *
íåy
)

2550 
pxt4_x©å_ibody_föd
 *
is
 = 
NULL
;

2551 
pxt4_x©å_block_föd
 *
bs
 = 
NULL
;

2552 *
buf„r
 = 
NULL
, *
b_íåy_«me
 = NULL;

2553 
size_t
 
vÆue_size
 = 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
);

2554 
pxt4_x©å_öfo
 
i
 = {

2555 .
vÆue
 = 
NULL
,

2556 .
vÆue_Àn
 = 0,

2557 .
«me_ödex
 = 
íåy
->
e_«me_ödex
,

2558 .
ö_öode
 = !!
íåy
->
e_vÆue_öum
,

2560 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2561 
îr‹
;

2563 
is
 = 
	`kzÆloc
((
pxt4_x©å_ibody_föd
), 
GFP_NOFS
);

2564 
bs
 = 
	`kzÆloc
((
pxt4_x©å_block_föd
), 
GFP_NOFS
);

2565 
buf„r
 = 
	`kmÆloc
(
vÆue_size
, 
GFP_NOFS
);

2566 
b_íåy_«me
 = 
	`kmÆloc
(
íåy
->
e_«me_Àn
 + 1, 
GFP_NOFS
);

2567 i‡(!
is
 || !
bs
 || !
buf„r
 || !
b_íåy_«me
) {

2568 
îr‹
 = -
ENOMEM
;

2569 
out
;

2572 
is
->
s
.
nŸ_found
 = -
ENODATA
;

2573 
bs
->
s
.
nŸ_found
 = -
ENODATA
;

2574 
is
->
ûoc
.
bh
 = 
NULL
;

2575 
bs
->
bh
 = 
NULL
;

2578 i‡(
íåy
->
e_vÆue_öum
) {

2579 
îr‹
 = 
	`pxt4_x©å_öode_gë
(
öode
, 
íåy
, 
buf„r
, 
vÆue_size
);

2580 i‡(
îr‹
)

2581 
out
;

2583 
size_t
 
vÆue_offs
 = 
	`À16_to_˝u
(
íåy
->
e_vÆue_offs
);

2584 
	`mem˝y
(
buf„r
, (*)
	`IFIRST
(
hódî
Ë+ 
vÆue_offs
, 
vÆue_size
);

2587 
	`mem˝y
(
b_íåy_«me
, 
íåy
->
e_«me
,É¡ry->
e_«me_Àn
);

2588 
b_íåy_«me
[
íåy
->
e_«me_Àn
] = '\0';

2589 
i
.
«me
 = 
b_íåy_«me
;

2591 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
is
->
ûoc
);

2592 i‡(
îr‹
)

2593 
out
;

2595 
îr‹
 = 
	`pxt4_x©å_ibody_föd
(
öode
, &
i
, 
is
);

2596 i‡(
îr‹
)

2597 
out
;

2600 
îr‹
 = 
	`pxt4_x©å_ibody_£t
(
h™dÀ
, 
öode
, &
i
, 
is
);

2601 i‡(
îr‹
)

2602 
out
;

2604 
i
.
vÆue
 = 
buf„r
;

2605 
i
.
vÆue_Àn
 = 
vÆue_size
;

2606 
îr‹
 = 
	`pxt4_x©å_block_föd
(
öode
, &
i
, 
bs
);

2607 i‡(
îr‹
)

2608 
out
;

2611 
îr‹
 = 
	`pxt4_x©å_block_£t
(
h™dÀ
, 
öode
, &
i
, 
bs
);

2612 i‡(
îr‹
)

2613 
out
;

2614 
îr‹
 = 0;

2615 
out
:

2616 
	`k‰ì
(
b_íåy_«me
);

2617 
	`k‰ì
(
buf„r
);

2618 i‡(
is
)

2619 
	`bªl£
(
is
->
ûoc
.
bh
);

2620 i‡(
bs
)

2621 
	`bªl£
(
bs
->
bh
);

2622 
	`k‰ì
(
is
);

2623 
	`k‰ì
(
bs
);

2625  
îr‹
;

2626 
	}
}

2628 
	$pxt4_x©å_make_öode_•a˚
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2629 
pxt4_öode
 *
øw_öode
,

2630 
isize_diff
, 
size_t
 
i‰ì
,

2631 
size_t
 
b‰ì
, *
tŸÆ_öo
)

2633 
pxt4_x©å_ibody_hódî
 *
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2634 
pxt4_x©å_íåy
 *
smÆl_íåy
;

2635 
pxt4_x©å_íåy
 *
íåy
;

2636 
pxt4_x©å_íåy
 *
œ°
;

2637 
íåy_size
;

2638 
tŸÆ_size
;

2639 
mö_tŸÆ_size
;

2640 
îr‹
;

2642 
isize_diff
 > 
i‰ì
) {

2643 
íåy
 = 
NULL
;

2644 
smÆl_íåy
 = 
NULL
;

2645 
mö_tŸÆ_size
 = ~0U;

2646 
œ°
 = 
	`IFIRST
(
hódî
);

2648 ; !
	`IS_LAST_ENTRY
(
œ°
);Üa° = 
	`PXT4_XATTR_NEXT
(last)) {

2650 i‡((
œ°
->
e_«me_Àn
 == 4) &&

2651 (
œ°
->
e_«me_ödex
 =
PXT4_XATTR_INDEX_SYSTEM
) &&

2652 !
	`memcmp
(
œ°
->
e_«me
, "data", 4))

2654 
tŸÆ_size
 = 
	`PXT4_XATTR_LEN
(
œ°
->
e_«me_Àn
);

2655 i‡(!
œ°
->
e_vÆue_öum
)

2656 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2657 
	`À32_to_˝u
(
œ°
->
e_vÆue_size
));

2658 i‡(
tŸÆ_size
 <
b‰ì
 &&

2659 
tŸÆ_size
 < 
mö_tŸÆ_size
) {

2660 i‡(
tŸÆ_size
 + 
i‰ì
 < 
isize_diff
) {

2661 
smÆl_íåy
 = 
œ°
;

2663 
íåy
 = 
œ°
;

2664 
mö_tŸÆ_size
 = 
tŸÆ_size
;

2669 i‡(
íåy
 =
NULL
) {

2670 i‡(
smÆl_íåy
 =
NULL
)

2671  -
ENOSPC
;

2672 
íåy
 = 
smÆl_íåy
;

2675 
íåy_size
 = 
	`PXT4_XATTR_LEN
(
íåy
->
e_«me_Àn
);

2676 
tŸÆ_size
 = 
íåy_size
;

2677 i‡(!
íåy
->
e_vÆue_öum
)

2678 
tŸÆ_size
 +
	`PXT4_XATTR_SIZE
(

2679 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2680 
îr‹
 = 
	`pxt4_x©å_move_to_block
(
h™dÀ
, 
öode
, 
øw_öode
,

2681 
íåy
);

2682 i‡(
îr‹
)

2683  
îr‹
;

2685 *
tŸÆ_öo
 -
íåy_size
;

2686 
i‰ì
 +
tŸÆ_size
;

2687 
b‰ì
 -
tŸÆ_size
;

2691 
	}
}

2697 
	$pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

2698 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
)

2700 
pxt4_x©å_ibody_hódî
 *
hódî
;

2701 
pxt4_sb_öfo
 *
sbi
 = 
	`PXT4_SB
(
öode
->
i_sb
);

2702 
m¡_cou¡
;

2703 
size_t
 
mö_offs
;

2704 
size_t
 
i‰ì
, 
b‰ì
;

2705 
tŸÆ_öo
;

2706 *
ba£
, *
íd
;

2707 
îr‹
 = 0, 
åõd_mö_exåa_isize
 = 0;

2708 
s_mö_exåa_isize
 = 
	`À16_to_˝u
(
sbi
->
s_es
->s_min_extra_isize);

2709 
isize_diff
;

2711 
ªåy
:

2712 
isize_diff
 = 
√w_exåa_isize
 - 
	`PXT4_I
(
öode
)->
i_exåa_isize
;

2713 i‡(
	`PXT4_I
(
öode
)->
i_exåa_isize
 >
√w_exåa_isize
)

2716 
hódî
 = 
	`IHDR
(
öode
, 
øw_öode
);

2723 
ba£
 = 
	`IFIRST
(
hódî
);

2724 
íd
 = (*)
øw_öode
 + 
	`PXT4_SB
(
öode
->
i_sb
)->
s_öode_size
;

2725 
mö_offs
 = 
íd
 - 
ba£
;

2726 
tŸÆ_öo
 = (
pxt4_x©å_ibody_hódî
Ë+ (
u32
);

2728 
îr‹
 = 
	`x©å_check_öode
(
öode
, 
hódî
, 
íd
);

2729 i‡(
îr‹
)

2730 
˛ónup
;

2732 
i‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
ba£
, &
mö_offs
, ba£, &
tŸÆ_öo
);

2733 i‡(
i‰ì
 >
isize_diff
)

2734 
shi·
;

2740 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2741 
buf„r_hód
 *
bh
;

2743 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2744 i‡(
	`IS_ERR
(
bh
)) {

2745 
îr‹
 = 
	`PTR_ERR
(
bh
);

2746 
˛ónup
;

2748 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2749 i‡(
îr‹
) {

2750 
	`bªl£
(
bh
);

2751 
˛ónup
;

2753 
ba£
 = 
	`BHDR
(
bh
);

2754 
íd
 = 
bh
->
b_d©a
 + bh->
b_size
;

2755 
mö_offs
 = 
íd
 - 
ba£
;

2756 
b‰ì
 = 
	`pxt4_x©å_‰ì_•a˚
(
	`BFIRST
(
bh
), &
mö_offs
, 
ba£
,

2757 
NULL
);

2758 
	`bªl£
(
bh
);

2759 i‡(
b‰ì
 + 
i‰ì
 < 
isize_diff
) {

2760 i‡(!
åõd_mö_exåa_isize
 && 
s_mö_exåa_isize
) {

2761 
åõd_mö_exåa_isize
++;

2762 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2763 
ªåy
;

2765 
îr‹
 = -
ENOSPC
;

2766 
˛ónup
;

2769 
b‰ì
 = 
öode
->
i_sb
->
s_blocksize
;

2772 
îr‹
 = 
	`pxt4_x©å_make_öode_•a˚
(
h™dÀ
, 
öode
, 
øw_öode
,

2773 
isize_diff
, 
i‰ì
, 
b‰ì
,

2774 &
tŸÆ_öo
);

2775 i‡(
îr‹
) {

2776 i‡(
îr‹
 =-
ENOSPC
 && !
åõd_mö_exåa_isize
 &&

2777 
s_mö_exåa_isize
) {

2778 
åõd_mö_exåa_isize
++;

2779 
√w_exåa_isize
 = 
s_mö_exåa_isize
;

2780 
ªåy
;

2782 
˛ónup
;

2784 
shi·
:

2786 
	`pxt4_x©å_shi·_íåõs
(
	`IFIRST
(
hódî
), 
	`PXT4_I
(
öode
)->
i_exåa_isize


2787 - 
√w_exåa_isize
, (*)
øw_öode
 +

2788 
PXT4_GOOD_OLD_INODE_SIZE
 + 
√w_exåa_isize
,

2789 (*)
hódî
, 
tŸÆ_öo
);

2790 
	`PXT4_I
(
öode
)->
i_exåa_isize
 = 
√w_exåa_isize
;

2792 
˛ónup
:

2793 i‡(
îr‹
 && (
m¡_cou¡
 !
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
))) {

2794 
	`pxt4_w¨nög
(
öode
->
i_sb
, "UnableÅoÉxpand inode %lu. Delete some EAs orÑunÉ2fsck.",

2795 
öode
->
i_öo
);

2796 
m¡_cou¡
 = 
	`À16_to_˝u
(
sbi
->
s_es
->
s_m¡_cou¡
);

2798  
îr‹
;

2799 
	}
}

2801 
	#EIA_INCR
 16

	)

2802 
	#EIA_MASK
 (
EIA_INCR
 - 1)

	)

2809 
	$pxt4_ex∑nd_öode_¨øy
(
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2810 
öode
 *inode)

2812 i‡(*
ó_öode_¨øy
 =
NULL
) {

2817 (*
ó_öode_¨øy
) =

2818 
	`kmÆloc
(
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2819 
öodes
[
EIA_MASK
]),

2820 
GFP_NOFS
);

2821 i‡(*
ó_öode_¨øy
 =
NULL
)

2822  -
ENOMEM
;

2823 (*
ó_öode_¨øy
)->
cou¡
 = 0;

2824 } i‡(((*
ó_öode_¨øy
)->
cou¡
 & 
EIA_MASK
) == EIA_MASK) {

2826 
pxt4_x©å_öode_¨øy
 *
√w_¨øy
 = 
NULL
;

2827 
cou¡
 = (*
ó_öode_¨øy
)->count;

2830 
√w_¨øy
 = 
	`kmÆloc
(

2831 
	`off£tof
(
pxt4_x©å_öode_¨øy
,

2832 
öodes
[
cou¡
 + 
EIA_INCR
]),

2833 
GFP_NOFS
);

2834 i‡(
√w_¨øy
 =
NULL
)

2835  -
ENOMEM
;

2836 
	`mem˝y
(
√w_¨øy
, *
ó_öode_¨øy
,

2837 
	`off£tof
(
pxt4_x©å_öode_¨øy
, 
öodes
[
cou¡
]));

2838 
	`k‰ì
(*
ó_öode_¨øy
);

2839 *
ó_öode_¨øy
 = 
√w_¨øy
;

2841 (*
ó_öode_¨øy
)->
öodes
[(*ó_öode_¨øy)->
cou¡
++] = 
öode
;

2843 
	}
}

2854 
	$pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

2855 
pxt4_x©å_öode_¨øy
 **
ó_öode_¨øy
,

2856 
exåa_¸edôs
)

2858 
buf„r_hód
 *
bh
 = 
NULL
;

2859 
pxt4_x©å_ibody_hódî
 *
hódî
;

2860 
pxt4_ûoc
 
ûoc
 = { .
bh
 = 
NULL
 };

2861 
pxt4_x©å_íåy
 *
íåy
;

2862 
öode
 *
ó_öode
;

2863 
îr‹
;

2865 
îr‹
 = 
	`pxt4_x©å_ísuª_¸edôs
(
h™dÀ
, 
öode
, 
exåa_¸edôs
,

2866 
NULL
 ,

2867 
Ál£
 ,

2868 
Ál£
 );

2869 i‡(
îr‹
) {

2870 
	`PXT4_ERROR_INODE
(
öode
, "ísuª cªdô†”º‹ %d)", 
îr‹
);

2871 
˛ónup
;

2874 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
) &&

2875 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_XATTR
)) {

2877 
îr‹
 = 
	`pxt4_gë_öode_loc
(
öode
, &
ûoc
);

2878 i‡(
îr‹
) {

2879 
	`PXT4_ERROR_INODE
(
öode
, "öodêlo¯”º‹ %d)", 
îr‹
);

2880 
˛ónup
;

2883 
îr‹
 = 
	`pxt4_jou∫Æ_gë_wrôe_ac˚ss
(
h™dÀ
, 
ûoc
.
bh
);

2884 i‡(
îr‹
) {

2885 
	`PXT4_ERROR_INODE
(
öode
, "writeáccess (error %d)",

2886 
îr‹
);

2887 
˛ónup
;

2890 
hódî
 = 
	`IHDR
(
öode
, 
	`pxt4_øw_öode
(&
ûoc
));

2891 i‡(
hódî
->
h_magic
 =
	`˝u_to_À32
(
PXT4_XATTR_MAGIC
))

2892 
	`pxt4_x©å_öode_dec_ªf_Æl
(
h™dÀ
, 
öode
, 
ûoc
.
bh
,

2893 
	`IFIRST
(
hódî
),

2894 
Ál£
 ,

2895 
ó_öode_¨øy
,

2896 
exåa_¸edôs
,

2897 
Ál£
 );

2900 i‡(
	`PXT4_I
(
öode
)->
i_fûe_a˛
) {

2901 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
	`PXT4_I
(öode)->
i_fûe_a˛
, 
REQ_PRIO
);

2902 i‡(
	`IS_ERR
(
bh
)) {

2903 
îr‹
 = 
	`PTR_ERR
(
bh
);

2904 i‡(
îr‹
 =-
EIO
)

2905 
	`PXT4_ERROR_INODE
(
öode
, "block %lluÑeadÉrror",

2906 
	`PXT4_I
(
öode
)->
i_fûe_a˛
);

2907 
bh
 = 
NULL
;

2908 
˛ónup
;

2910 
îr‹
 = 
	`pxt4_x©å_check_block
(
öode
, 
bh
);

2911 i‡(
îr‹
)

2912 
˛ónup
;

2914 i‡(
	`pxt4_has_„©uª_ó_öode
(
öode
->
i_sb
)) {

2915 
íåy
 = 
	`BFIRST
(
bh
); !
	`IS_LAST_ENTRY
(entry);

2916 
íåy
 = 
	`PXT4_XATTR_NEXT
(entry)) {

2917 i‡(!
íåy
->
e_vÆue_öum
)

2919 
îr‹
 = 
	`pxt4_x©å_öode_igë
(
öode
,

2920 
	`À32_to_˝u
(
íåy
->
e_vÆue_öum
),

2921 
	`À32_to_˝u
(
íåy
->
e_hash
),

2922 &
ó_öode
);

2923 i‡(
îr‹
)

2925 
	`pxt4_x©å_öode_‰ì_quŸa
(
öode
, 
ó_öode
,

2926 
	`À32_to_˝u
(
íåy
->
e_vÆue_size
));

2927 
	`ùut
(
ó_öode
);

2932 
	`pxt4_x©å_ªÀa£_block
(
h™dÀ
, 
öode
, 
bh
, 
ó_öode_¨øy
,

2933 
exåa_¸edôs
);

2938 
	`PXT4_I
(
öode
)->
i_fûe_a˛
 = 0;

2939 
îr‹
 = 
	`pxt4_m¨k_öode_dúty
(
h™dÀ
, 
öode
);

2940 i‡(
îr‹
) {

2941 
	`PXT4_ERROR_INODE
(
öode
, "mark inode dirty (error %d)",

2942 
îr‹
);

2943 
˛ónup
;

2946 
îr‹
 = 0;

2947 
˛ónup
:

2948 
	`bªl£
(
ûoc
.
bh
);

2949 
	`bªl£
(
bh
);

2950  
îr‹
;

2951 
	}
}

2953 
	$pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
ó_öode_¨øy
)

2955 
idx
;

2957 i‡(
ó_öode_¨øy
 =
NULL
)

2960 
idx
 = 0; idx < 
ó_öode_¨øy
->
cou¡
; ++idx)

2961 
	`ùut
(
ó_öode_¨øy
->
öodes
[
idx
]);

2962 
	`k‰ì
(
ó_öode_¨øy
);

2963 
	}
}

2974 
	$pxt4_x©å_block_ˇche_ö£π
(
mb_ˇche
 *
ó_block_ˇche
,

2975 
buf„r_hód
 *
bh
)

2977 
pxt4_x©å_hódî
 *
hódî
 = 
	`BHDR
(
bh
);

2978 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

2979 
ªußbÀ
 = 
	`À32_to_˝u
(
hódî
->
h_ªfcou¡
) <

2980 
PXT4_XATTR_REFCOUNT_MAX
;

2981 
îr‹
;

2983 i‡(!
ó_block_ˇche
)

2985 
îr‹
 = 
	`mb_ˇche_íåy_¸óã
(
ó_block_ˇche
, 
GFP_NOFS
, 
hash
,

2986 
bh
->
b_blockƒ
, 
ªußbÀ
);

2987 i‡(
îr‹
) {

2988 i‡(
îr‹
 =-
EBUSY
)

2989 
	`ó_bdebug
(
bh
, "already in cache");

2991 
	`ó_bdebug
(
bh
, "ö£πög [%x]", ()
hash
);

2992 
	}
}

3003 
	$pxt4_x©å_cmp
(
pxt4_x©å_hódî
 *
hódî1
,

3004 
pxt4_x©å_hódî
 *
hódî2
)

3006 
pxt4_x©å_íåy
 *
íåy1
, *
íåy2
;

3008 
íåy1
 = 
	`ENTRY
(
hódî1
+1);

3009 
íåy2
 = 
	`ENTRY
(
hódî2
+1);

3010 !
	`IS_LAST_ENTRY
(
íåy1
)) {

3011 i‡(
	`IS_LAST_ENTRY
(
íåy2
))

3013 i‡(
íåy1
->
e_hash
 !
íåy2
->e_hash ||

3014 
íåy1
->
e_«me_ödex
 !
íåy2
->e_name_index ||

3015 
íåy1
->
e_«me_Àn
 !
íåy2
->e_name_len ||

3016 
íåy1
->
e_vÆue_size
 !
íåy2
->e_value_size ||

3017 
íåy1
->
e_vÆue_öum
 !
íåy2
->e_value_inum ||

3018 
	`memcmp
(
íåy1
->
e_«me
, 
íåy2
->e_«me,É¡ry1->
e_«me_Àn
))

3020 i‡(!
íåy1
->
e_vÆue_öum
 &&

3021 
	`memcmp
((*)
hódî1
 + 
	`À16_to_˝u
(
íåy1
->
e_vÆue_offs
),

3022 (*)
hódî2
 + 
	`À16_to_˝u
(
íåy2
->
e_vÆue_offs
),

3023 
	`À32_to_˝u
(
íåy1
->
e_vÆue_size
)))

3026 
íåy1
 = 
	`PXT4_XATTR_NEXT
(entry1);

3027 
íåy2
 = 
	`PXT4_XATTR_NEXT
(entry2);

3029 i‡(!
	`IS_LAST_ENTRY
(
íåy2
))

3032 
	}
}

3042 
buf„r_hód
 *

3043 
	$pxt4_x©å_block_ˇche_föd
(
öode
 *inode,

3044 
pxt4_x©å_hódî
 *
hódî
,

3045 
mb_ˇche_íåy
 **
p˚
)

3047 
__u32
 
hash
 = 
	`À32_to_˝u
(
hódî
->
h_hash
);

3048 
mb_ˇche_íåy
 *
˚
;

3049 
mb_ˇche
 *
ó_block_ˇche
 = 
	`EA_BLOCK_CACHE
(
öode
);

3051 i‡(!
ó_block_ˇche
)

3052  
NULL
;

3053 i‡(!
hódî
->
h_hash
)

3054  
NULL
;

3055 
	`ó_idebug
(
öode
, "lookög f‹ cached block†[%x]", ()
hash
);

3056 
˚
 = 
	`mb_ˇche_íåy_föd_fú°
(
ó_block_ˇche
, 
hash
);

3057 
˚
) {

3058 
buf„r_hód
 *
bh
;

3060 
bh
 = 
	`pxt4_sb_bªad
(
öode
->
i_sb
, 
˚
->
e_vÆue
, 
REQ_PRIO
);

3061 i‡(
	`IS_ERR
(
bh
)) {

3062 i‡(
	`PTR_ERR
(
bh
Ë=-
ENOMEM
)

3063  
NULL
;

3064 
bh
 = 
NULL
;

3065 
	`PXT4_ERROR_INODE
(
öode
, "block %luÑeadÉrror",

3066 ()
˚
->
e_vÆue
);

3067 } i‡(
	`pxt4_x©å_cmp
(
hódî
, 
	`BHDR
(
bh
)) == 0) {

3068 *
p˚
 = 
˚
;

3069  
bh
;

3071 
	`bªl£
(
bh
);

3072 
˚
 = 
	`mb_ˇche_íåy_föd_√xt
(
ó_block_ˇche
, ce);

3074  
NULL
;

3075 
	}
}

3077 
	#NAME_HASH_SHIFT
 5

	)

3078 
	#VALUE_HASH_SHIFT
 16

	)

3085 
__À32
 
	$pxt4_x©å_hash_íåy
(*
«me
, 
size_t
 
«me_Àn
, 
__À32
 *
vÆue
,

3086 
size_t
 
vÆue_cou¡
)

3088 
__u32
 
hash
 = 0;

3090 
«me_Àn
--) {

3091 
hash
 = (hash << 
NAME_HASH_SHIFT
) ^

3092 (
hash
 >> (8*(hashË- 
NAME_HASH_SHIFT
)) ^

3093 *
«me
++;

3095 
vÆue_cou¡
--) {

3096 
hash
 = (hash << 
VALUE_HASH_SHIFT
) ^

3097 (
hash
 >> (8*(hashË- 
VALUE_HASH_SHIFT
)) ^

3098 
	`À32_to_˝u
(*
vÆue
++);

3100  
	`˝u_to_À32
(
hash
);

3101 
	}
}

3103 #unde‡
NAME_HASH_SHIFT


3104 #unde‡
VALUE_HASH_SHIFT


3106 
	#BLOCK_HASH_SHIFT
 16

	)

3113 
	$pxt4_x©å_ªhash
(
pxt4_x©å_hódî
 *
hódî
)

3115 
pxt4_x©å_íåy
 *
hîe
;

3116 
__u32
 
hash
 = 0;

3118 
hîe
 = 
	`ENTRY
(
hódî
+1);

3119 !
	`IS_LAST_ENTRY
(
hîe
)) {

3120 i‡(!
hîe
->
e_hash
) {

3122 
hash
 = 0;

3125 
hash
 = (hash << 
BLOCK_HASH_SHIFT
) ^

3126 (
hash
 >> (8*(hashË- 
BLOCK_HASH_SHIFT
)) ^

3127 
	`À32_to_˝u
(
hîe
->
e_hash
);

3128 
hîe
 = 
	`PXT4_XATTR_NEXT
(here);

3130 
hódî
->
h_hash
 = 
	`˝u_to_À32
(
hash
);

3131 
	}
}

3133 #unde‡
BLOCK_HASH_SHIFT


3135 
	#HASH_BUCKET_BITS
 10

	)

3137 
mb_ˇche
 *

3138 
	$pxt4_x©å_¸óã_ˇche
()

3140  
	`mb_ˇche_¸óã
(
HASH_BUCKET_BITS
);

3141 
	}
}

3143 
	$pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *
ˇche
)

3145 i‡(
ˇche
)

3146 
	`mb_ˇche_de°roy
(
ˇche
);

3147 
	}
}

	@xattr.h

10 
	~<löux/x©å.h
>

13 
	#PXT4_XATTR_MAGIC
 0xEA020000

	)

16 
	#PXT4_XATTR_REFCOUNT_MAX
 1024

	)

19 
	#PXT4_XATTR_INDEX_USER
 1

	)

20 
	#PXT4_XATTR_INDEX_POSIX_ACL_ACCESS
 2

	)

21 
	#PXT4_XATTR_INDEX_POSIX_ACL_DEFAULT
 3

	)

22 
	#PXT4_XATTR_INDEX_TRUSTED
 4

	)

23 
	#PXT4_XATTR_INDEX_LUSTRE
 5

	)

24 
	#PXT4_XATTR_INDEX_SECURITY
 6

	)

25 
	#PXT4_XATTR_INDEX_SYSTEM
 7

	)

26 
	#PXT4_XATTR_INDEX_RICHACL
 8

	)

27 
	#PXT4_XATTR_INDEX_ENCRYPTION
 9

	)

28 
	#PXT4_XATTR_INDEX_HURD
 10

	)

30 
	spxt4_x©å_hódî
 {

31 
__À32
 
	mh_magic
;

32 
__À32
 
	mh_ªfcou¡
;

33 
__À32
 
	mh_blocks
;

34 
__À32
 
	mh_hash
;

35 
__À32
 
	mh_checksum
;

37 
__u32
 
	mh_ª£rved
[3];

40 
	spxt4_x©å_ibody_hódî
 {

41 
__À32
 
	mh_magic
;

44 
	spxt4_x©å_íåy
 {

45 
__u8
 
	me_«me_Àn
;

46 
__u8
 
	me_«me_ödex
;

47 
__À16
 
	me_vÆue_offs
;

48 
__À32
 
	me_vÆue_öum
;

49 
__À32
 
	me_vÆue_size
;

50 
__À32
 
	me_hash
;

51 
	me_«me
[0];

54 
	#PXT4_XATTR_PAD_BITS
 2

	)

55 
	#PXT4_XATTR_PAD
 (1<<
PXT4_XATTR_PAD_BITS
)

	)

56 
	#PXT4_XATTR_ROUND
 (
PXT4_XATTR_PAD
-1)

	)

57 
	#PXT4_XATTR_LEN
(
«me_Àn
) \

58 (((
«me_Àn
Ë+ 
PXT4_XATTR_ROUND
 + \

59 (
pxt4_x©å_íåy
)Ë& ~
PXT4_XATTR_ROUND
)

	)

60 
	#PXT4_XATTR_NEXT
(
íåy
) \

61 ((
pxt4_x©å_íåy
 *)( \

62 (*)(
íåy
Ë+ 
	`PXT4_XATTR_LEN
(”¡ry)->
e_«me_Àn
)))

	)

63 
	#PXT4_XATTR_SIZE
(
size
) \

64 (((
size
Ë+ 
PXT4_XATTR_ROUND
Ë& ~PXT4_XATTR_ROUND)

	)

66 
	#IHDR
(
öode
, 
øw_öode
) \

67 ((
pxt4_x©å_ibody_hódî
 *) \

68 ((*)
øw_öode
 + \

69 
PXT4_GOOD_OLD_INODE_SIZE
 + \

70 
	`PXT4_I
(
öode
)->
i_exåa_isize
))

	)

71 
	#IFIRST
(
hdr
Ë((
pxt4_x©å_íåy
 *)((hdr)+1))

	)

82 
	#PXT4_XATTR_SIZE_MAX
 (1 << 24)

	)

88 
	#PXT4_XATTR_MIN_LARGE_EA_SIZE
(
b
) \

89 ((
b
Ë- 
	`PXT4_XATTR_LEN
(3Ë- (
pxt4_x©å_hódî
Ë- 4)

	)

91 
	#BHDR
(
bh
Ë((
pxt4_x©å_hódî
 *)((bh)->
b_d©a
))

	)

92 
	#ENTRY
(
±r
Ë((
pxt4_x©å_íåy
 *)’å))

	)

93 
	#BFIRST
(
bh
Ë
	`ENTRY
(
	`BHDR
(bh)+1)

	)

94 
	#IS_LAST_ENTRY
(
íåy
Ë(*(
__u32
 *)”¡ryË=0)

	)

96 
	#PXT4_ZERO_XATTR_VALUE
 ((*)-1)

	)

98 
	spxt4_x©å_öfo
 {

99 c⁄° *
	m«me
;

100 c⁄° *
	mvÆue
;

101 
size_t
 
	mvÆue_Àn
;

102 
	m«me_ödex
;

103 
	mö_öode
;

106 
	spxt4_x©å_£¨ch
 {

107 
pxt4_x©å_íåy
 *
	mfú°
;

108 *
	mba£
;

109 *
	míd
;

110 
pxt4_x©å_íåy
 *
	mhîe
;

111 
	mnŸ_found
;

114 
	spxt4_x©å_ibody_föd
 {

115 
pxt4_x©å_£¨ch
 
	ms
;

116 
pxt4_ûoc
 
	mûoc
;

119 
	spxt4_x©å_öode_¨øy
 {

120 
	mcou¡
;

121 
öode
 *
	möodes
[0];

124 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_u£r_h™dÀr
;

125 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_åu°ed_h™dÀr
;

126 c⁄° 
x©å_h™dÀr
 
pxt4_x©å_£curôy_h™dÀr
;

128 
	#PXT4_XATTR_NAME_ENCRYPTION_CONTEXT
 "c"

	)

139 
ölöe
 
	$pxt4_wrôe_lock_x©å
(
öode
 *öode, *
ßve
)

141 
	`down_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

142 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

143 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

144 
	}
}

146 
ölöe
 
	$pxt4_wrôe_åylock_x©å
(
öode
 *öode, *
ßve
)

148 i‡(
	`down_wrôe_åylock
(&
	`PXT4_I
(
öode
)->
x©å_£m
) == 0)

150 *
ßve
 = 
	`pxt4_ã°_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

151 
	`pxt4_£t_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

153 
	}
}

155 
ölöe
 
	$pxt4_wrôe_u∆ock_x©å
(
öode
 *öode, *
ßve
)

157 i‡(*
ßve
 == 0)

158 
	`pxt4_˛ór_öode_°©e
(
öode
, 
PXT4_STATE_NO_EXPAND
);

159 
	`up_wrôe
(&
	`PXT4_I
(
öode
)->
x©å_£m
);

160 
	}
}

162 
ssize_t
 
pxt4_li°x©å
(
díåy
 *, *, 
size_t
);

164 
pxt4_x©å_gë
(
öode
 *, , c⁄° *, *, 
size_t
);

165 
pxt4_x©å_£t
(
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

166 
pxt4_x©å_£t_h™dÀ
(
h™dÀ_t
 *, 
öode
 *, , c⁄° *, c⁄° *, 
size_t
, );

167 
pxt4_x©å_£t_¸edôs
(
öode
 *öode, 
size_t
 
vÆue_Àn
,

168 
boﬁ
 
is_¸óã
, *
¸edôs
);

169 
__pxt4_x©å_£t_¸edôs
(
su≥r_block
 *
sb
, 
öode
 *inode,

170 
buf„r_hód
 *
block_bh
, 
size_t
 
vÆue_Àn
,

171 
boﬁ
 
is_¸óã
);

173 
pxt4_x©å_dñëe_öode
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

174 
pxt4_x©å_öode_¨øy
 **
¨øy
,

175 
exåa_¸edôs
);

176 
pxt4_x©å_öode_¨øy_‰ì
(
pxt4_x©å_öode_¨øy
 *
¨øy
);

178 
pxt4_ex∑nd_exåa_isize_ó
(
öode
 *öode, 
√w_exåa_isize
,

179 
pxt4_öode
 *
øw_öode
, 
h™dÀ_t
 *
h™dÀ
);

181 c⁄° 
x©å_h™dÀr
 *
pxt4_x©å_h™dÀrs
[];

183 
pxt4_x©å_ibody_föd
(
öode
 *öode, 
pxt4_x©å_öfo
 *
i
,

184 
pxt4_x©å_ibody_föd
 *
is
);

185 
pxt4_x©å_ibody_gë
(
öode
 *öode, 
«me_ödex
,

186 c⁄° *
«me
,

187 *
buf„r
, 
size_t
 
buf„r_size
);

188 
pxt4_x©å_ibody_ölöe_£t
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

189 
pxt4_x©å_öfo
 *
i
,

190 
pxt4_x©å_ibody_föd
 *
is
);

192 
mb_ˇche
 *
pxt4_x©å_¸óã_ˇche
();

193 
pxt4_x©å_de°roy_ˇche
(
mb_ˇche
 *);

195 #ifde‡
CONFIG_EXT4_FS_SECURITY


196 
pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

197 
öode
 *
dú
, c⁄° 
q°r
 *qstr);

199 
ölöe
 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *inode,

200 
öode
 *
dú
, c⁄° 
q°r
 *qstr)

203 
	}
}

206 #ifde‡
CONFIG_LOCKDEP


207 
pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
);

209 
ölöe
 
	$pxt4_x©å_öode_£t_˛ass
(
öode
 *
ó_öode
Ë{ 
	}
}

212 
pxt4_gë_öode_ußge
(
öode
 *öode, 
qsize_t
 *
ußge
);

	@xattr_security.c

7 
	~<löux/°rög.h
>

8 
	~<löux/fs.h
>

9 
	~<löux/£curôy.h
>

10 
	~<löux/¶ab.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

16 
	$pxt4_x©å_£curôy_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

17 
díåy
 *
unu£d
, 
öode
 *inode,

18 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

20  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

21 
«me
, 
buf„r
, 
size
);

22 
	}
}

25 
	$pxt4_x©å_£curôy_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

26 
díåy
 *
unu£d
, 
öode
 *inode,

27 c⁄° *
«me
, c⁄° *
vÆue
,

28 
size_t
 
size
, 
Êags
)

30  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_SECURITY
,

31 
«me
, 
vÆue
, 
size
, 
Êags
);

32 
	}
}

35 
	$pxt4_öôx©ås
(
öode
 *öode, c⁄° 
x©å
 *
x©å_¨øy
,

36 *
fs_öfo
)

38 c⁄° 
x©å
 *xattr;

39 
h™dÀ_t
 *
h™dÀ
 = 
fs_öfo
;

40 
îr
 = 0;

42 
x©å
 = 
x©å_¨øy
; x©å->
«me
 !
NULL
; xattr++) {

43 
îr
 = 
	`pxt4_x©å_£t_h™dÀ
(
h™dÀ
, 
öode
,

44 
PXT4_XATTR_INDEX_SECURITY
,

45 
x©å
->
«me
, x©å->
vÆue
,

46 
x©å
->
vÆue_Àn
, 
XATTR_CREATE
);

47 i‡(
îr
 < 0)

50  
îr
;

51 
	}
}

54 
	$pxt4_öô_£curôy
(
h™dÀ_t
 *
h™dÀ
, 
öode
 *öode, öodê*
dú
,

55 c⁄° 
q°r
 *qstr)

57  
	`£curôy_öode_öô_£curôy
(
öode
, 
dú
, 
q°r
,

58 &
pxt4_öôx©ås
, 
h™dÀ
);

59 
	}
}

61 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_£curôy_h™dÀr
 = {

62 .
¥efix
 = 
XATTR_SECURITY_PREFIX
,

63 .
	ggë
 = 
pxt4_x©å_£curôy_gë
,

64 .
	g£t
 = 
pxt4_x©å_£curôy_£t
,

	@xattr_trusted.c

9 
	~<löux/°rög.h
>

10 
	~<löux/ˇ∑bûôy.h
>

11 
	~<löux/fs.h
>

12 
	~"pxt4_jbd3.h
"

13 
	~"pxt4.h
"

14 
	~"x©å.h
"

16 
boﬁ


17 
	$pxt4_x©å_åu°ed_li°
(
díåy
 *dentry)

19  
	`ˇ∑bÀ
(
CAP_SYS_ADMIN
);

20 
	}
}

23 
	$pxt4_x©å_åu°ed_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

24 
díåy
 *
unu£d
, 
öode
 *inode,

25 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

27  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

28 
«me
, 
buf„r
, 
size
);

29 
	}
}

32 
	$pxt4_x©å_åu°ed_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

33 
díåy
 *
unu£d
, 
öode
 *inode,

34 c⁄° *
«me
, c⁄° *
vÆue
,

35 
size_t
 
size
, 
Êags
)

37  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_TRUSTED
,

38 
«me
, 
vÆue
, 
size
, 
Êags
);

39 
	}
}

41 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_åu°ed_h™dÀr
 = {

42 .
¥efix
 = 
XATTR_TRUSTED_PREFIX
,

43 .
	gli°
 = 
pxt4_x©å_åu°ed_li°
,

44 .
	ggë
 = 
pxt4_x©å_åu°ed_gë
,

45 .
	g£t
 = 
pxt4_x©å_åu°ed_£t
,

	@xattr_user.c

9 
	~<löux/°rög.h
>

10 
	~<löux/fs.h
>

11 
	~"pxt4_jbd3.h
"

12 
	~"pxt4.h
"

13 
	~"x©å.h
"

15 
boﬁ


16 
	$pxt4_x©å_u£r_li°
(
díåy
 *dentry)

18  
	`ã°_›t
(
díåy
->
d_sb
, 
XATTR_USER
);

19 
	}
}

22 
	$pxt4_x©å_u£r_gë
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

23 
díåy
 *
unu£d
, 
öode
 *inode,

24 c⁄° *
«me
, *
buf„r
, 
size_t
 
size
)

26 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

27  -
EOPNOTSUPP
;

28  
	`pxt4_x©å_gë
(
öode
, 
PXT4_XATTR_INDEX_USER
,

29 
«me
, 
buf„r
, 
size
);

30 
	}
}

33 
	$pxt4_x©å_u£r_£t
(c⁄° 
x©å_h™dÀr
 *
h™dÀr
,

34 
díåy
 *
unu£d
, 
öode
 *inode,

35 c⁄° *
«me
, c⁄° *
vÆue
,

36 
size_t
 
size
, 
Êags
)

38 i‡(!
	`ã°_›t
(
öode
->
i_sb
, 
XATTR_USER
))

39  -
EOPNOTSUPP
;

40  
	`pxt4_x©å_£t
(
öode
, 
PXT4_XATTR_INDEX_USER
,

41 
«me
, 
vÆue
, 
size
, 
Êags
);

42 
	}
}

44 c⁄° 
x©å_h™dÀr
 
	gpxt4_x©å_u£r_h™dÀr
 = {

45 .
¥efix
 = 
XATTR_USER_PREFIX
,

46 .
	gli°
 = 
pxt4_x©å_u£r_li°
,

47 .
	ggë
 = 
pxt4_x©å_u£r_gë
,

48 .
	g£t
 = 
pxt4_x©å_u£r_£t
,

	@/usr/include/linux/capability.h

14 #i‚de‡
_LINUX_CAPABILITY_H


15 
	#_LINUX_CAPABILITY_H


	)

17 
	~<löux/ty≥s.h
>

30 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

31 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

33 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

34 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

36 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

37 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

39 
	s__u£r_ˇp_hódî_°ru˘
 {

40 
__u32
 
	mvîsi⁄
;

41 
	mpid
;

42 } *
	tˇp_u£r_hódî_t
;

44 
	s__u£r_ˇp_d©a_°ru˘
 {

45 
__u32
 
	mef„˘ive
;

46 
__u32
 
	m≥rmôãd
;

47 
__u32
 
	möhîôabÀ
;

48 } *
	tˇp_u£r_d©a_t
;

51 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

52 
	#VFS_CAP_REVISION_SHIFT
 24

	)

53 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

54 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

56 
	#VFS_CAP_REVISION_1
 0x01000000

	)

57 
	#VFS_CAP_U32_1
 1

	)

58 
	#XATTR_CAPS_SZ_1
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

60 
	#VFS_CAP_REVISION_2
 0x02000000

	)

61 
	#VFS_CAP_U32_2
 2

	)

62 
	#XATTR_CAPS_SZ_2
 ((
__À32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

64 
	#VFS_CAP_REVISION_3
 0x03000000

	)

65 
	#VFS_CAP_U32_3
 2

	)

66 
	#XATTR_CAPS_SZ_3
 ((
__À32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

68 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

69 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

70 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

72 
	svfs_ˇp_d©a
 {

73 
__À32
 
	mmagic_ëc
;

75 
__À32
 
	m≥rmôãd
;

76 
__À32
 
	möhîôabÀ
;

77 } 
	md©a
[
VFS_CAP_U32
];

83 
	svfs_ns_ˇp_d©a
 {

84 
__À32
 
	mmagic_ëc
;

86 
__À32
 
	m≥rmôãd
;

87 
__À32
 
	möhîôabÀ
;

88 } 
	md©a
[
VFS_CAP_U32
];

89 
__À32
 
	mroŸid
;

98 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

99 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

111 
	#CAP_CHOWN
 0

	)

117 
	#CAP_DAC_OVERRIDE
 1

	)

123 
	#CAP_DAC_READ_SEARCH
 2

	)

129 
	#CAP_FOWNER
 3

	)

138 
	#CAP_FSETID
 4

	)

144 
	#CAP_KILL
 5

	)

150 
	#CAP_SETGID
 6

	)

155 
	#CAP_SETUID
 7

	)

172 
	#CAP_SETPCAP
 8

	)

176 
	#CAP_LINUX_IMMUTABLE
 9

	)

181 
	#CAP_NET_BIND_SERVICE
 10

	)

185 
	#CAP_NET_BROADCAST
 11

	)

201 
	#CAP_NET_ADMIN
 12

	)

207 
	#CAP_NET_RAW
 13

	)

213 
	#CAP_IPC_LOCK
 14

	)

217 
	#CAP_IPC_OWNER
 15

	)

220 
	#CAP_SYS_MODULE
 16

	)

225 
	#CAP_SYS_RAWIO
 17

	)

229 
	#CAP_SYS_CHROOT
 18

	)

233 
	#CAP_SYS_PTRACE
 19

	)

237 
	#CAP_SYS_PACCT
 20

	)

276 
	#CAP_SYS_ADMIN
 21

	)

280 
	#CAP_SYS_BOOT
 22

	)

289 
	#CAP_SYS_NICE
 23

	)

303 
	#CAP_SYS_RESOURCE
 24

	)

309 
	#CAP_SYS_TIME
 25

	)

314 
	#CAP_SYS_TTY_CONFIG
 26

	)

318 
	#CAP_MKNOD
 27

	)

322 
	#CAP_LEASE
 28

	)

326 
	#CAP_AUDIT_WRITE
 29

	)

330 
	#CAP_AUDIT_CONTROL
 30

	)

332 
	#CAP_SETFCAP
 31

	)

340 
	#CAP_MAC_OVERRIDE
 32

	)

349 
	#CAP_MAC_ADMIN
 33

	)

353 
	#CAP_SYSLOG
 34

	)

357 
	#CAP_WAKE_ALARM
 35

	)

361 
	#CAP_BLOCK_SUSPEND
 36

	)

365 
	#CAP_AUDIT_READ
 37

	)

368 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

370 
	#ˇp_vÆid
(
x
Ë((xË>0 && (xË<
CAP_LAST_CAP
)

	)

376 
	#CAP_TO_INDEX
(
x
Ë((xË>> 5Ë

	)

377 
	#CAP_TO_MASK
(
x
Ë(1 << ((xË& 31)Ë

	)

	@/usr/include/linux/errno.h

1 
	~<asm/î∫o.h
>

	@/usr/include/linux/falloc.h

2 #i‚de‡
_FALLOC_H_


3 
	#_FALLOC_H_


	)

5 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

6 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

7 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

29 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

43 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

60 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

78 
	#FALLOC_FL_UNSHARE_RANGE
 0x40

	)

	@/usr/include/linux/fcntl.h

2 #i‚de‡
_LINUX_FCNTL_H


3 
	#_LINUX_FCNTL_H


	)

5 
	~<asm/f˙é.h
>

7 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

8 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

14 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

17 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

23 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

28 
	#F_SETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 7)

	)

29 
	#F_GETPIPE_SZ
 (
F_LINUX_SPECIFIC_BASE
 + 8)

	)

34 
	#F_ADD_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 9)

	)

35 
	#F_GET_SEALS
 (
F_LINUX_SPECIFIC_BASE
 + 10)

	)

40 
	#F_SEAL_SEAL
 0x0001

	)

41 
	#F_SEAL_SHRINK
 0x0002

	)

42 
	#F_SEAL_GROW
 0x0004

	)

43 
	#F_SEAL_WRITE
 0x0008

	)

51 
	#F_GET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 11)

	)

52 
	#F_SET_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 12)

	)

53 
	#F_GET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 13)

	)

54 
	#F_SET_FILE_RW_HINT
 (
F_LINUX_SPECIFIC_BASE
 + 14)

	)

60 
	#RWF_WRITE_LIFE_NOT_SET
 0

	)

61 
	#RWH_WRITE_LIFE_NONE
 1

	)

62 
	#RWH_WRITE_LIFE_SHORT
 2

	)

63 
	#RWH_WRITE_LIFE_MEDIUM
 3

	)

64 
	#RWH_WRITE_LIFE_LONG
 4

	)

65 
	#RWH_WRITE_LIFE_EXTREME
 5

	)

70 
	#DN_ACCESS
 0x00000001

	)

71 
	#DN_MODIFY
 0x00000002

	)

72 
	#DN_CREATE
 0x00000004

	)

73 
	#DN_DELETE
 0x00000008

	)

74 
	#DN_RENAME
 0x00000010

	)

75 
	#DN_ATTRIB
 0x00000020

	)

76 
	#DN_MULTISHOT
 0x80000000

	)

78 
	#AT_FDCWD
 -100

	)

81 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

82 
	#AT_REMOVEDIR
 0x200

	)

84 
	#AT_SYMLINK_FOLLOW
 0x400

	)

85 
	#AT_NO_AUTOMOUNT
 0x800

	)

86 
	#AT_EMPTY_PATH
 0x1000

	)

88 
	#AT_STATX_SYNC_TYPE
 0x6000

	)

89 
	#AT_STATX_SYNC_AS_STAT
 0x0000

	)

90 
	#AT_STATX_FORCE_SYNC
 0x2000

	)

91 
	#AT_STATX_DONT_SYNC
 0x4000

	)

	@/usr/include/linux/fiemap.h

12 #i‚de‡
_LINUX_FIEMAP_H


13 
	#_LINUX_FIEMAP_H


	)

15 
	~<löux/ty≥s.h
>

17 
	sfõm≠_exã¡
 {

18 
__u64
 
	m„_logiˇl
;

20 
__u64
 
	m„_physiˇl
;

22 
__u64
 
	m„_Àngth
;

23 
__u64
 
	m„_ª£rved64
[2];

24 
__u32
 
	m„_Êags
;

25 
__u32
 
	m„_ª£rved
[3];

28 
	sfõm≠
 {

29 
__u64
 
	mfm_°¨t
;

31 
__u64
 
	mfm_Àngth
;

33 
__u32
 
	mfm_Êags
;

34 
__u32
 
	mfm_m≠≥d_exã¡s
;

35 
__u32
 
	mfm_exã¡_cou¡
;

36 
__u32
 
	mfm_ª£rved
;

37 
fõm≠_exã¡
 
	mfm_exã¡s
[0];

40 
	#FIEMAP_MAX_OFFSET
 (~0ULL)

	)

42 
	#FIEMAP_FLAG_SYNC
 0x00000001

	)

43 
	#FIEMAP_FLAG_XATTR
 0x00000002

	)

44 
	#FIEMAP_FLAG_CACHE
 0x00000004

	)

46 
	#FIEMAP_FLAGS_COMPAT
 (
FIEMAP_FLAG_SYNC
 | 
FIEMAP_FLAG_XATTR
)

	)

48 
	#FIEMAP_EXTENT_LAST
 0x00000001

	)

49 
	#FIEMAP_EXTENT_UNKNOWN
 0x00000002

	)

50 
	#FIEMAP_EXTENT_DELALLOC
 0x00000004

	)

52 
	#FIEMAP_EXTENT_ENCODED
 0x00000008

	)

54 
	#FIEMAP_EXTENT_DATA_ENCRYPTED
 0x00000080

	)

56 
	#FIEMAP_EXTENT_NOT_ALIGNED
 0x00000100

	)

58 
	#FIEMAP_EXTENT_DATA_INLINE
 0x00000200

	)

60 
	#FIEMAP_EXTENT_DATA_TAIL
 0x00000400

	)

62 
	#FIEMAP_EXTENT_UNWRITTEN
 0x00000800

	)

64 
	#FIEMAP_EXTENT_MERGED
 0x00001000

	)

67 
	#FIEMAP_EXTENT_SHARED
 0x00002000

	)

	@/usr/include/linux/fs.h

2 #i‚de‡
_LINUX_FS_H


3 
	#_LINUX_FS_H


	)

13 
	~<löux/limôs.h
>

14 
	~<löux/io˘l.h
>

15 
	~<löux/ty≥s.h
>

28 #unde‡
NR_OPEN


29 
	#INR_OPEN_CUR
 1024

	)

30 
	#INR_OPEN_MAX
 4096

	)

32 
	#BLOCK_SIZE_BITS
 10

	)

33 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

35 
	#SEEK_SET
 0

	)

36 
	#SEEK_CUR
 1

	)

37 
	#SEEK_END
 2

	)

38 
	#SEEK_DATA
 3

	)

39 
	#SEEK_HOLE
 4

	)

40 
	#SEEK_MAX
 
SEEK_HOLE


	)

42 
	#RENAME_NOREPLACE
 (1 << 0Ë

	)

43 
	#RENAME_EXCHANGE
 (1 << 1Ë

	)

44 
	#RENAME_WHITEOUT
 (1 << 2Ë

	)

46 
	sfûe_˛⁄e_ønge
 {

47 
__s64
 
	m§c_fd
;

48 
__u64
 
	m§c_off£t
;

49 
__u64
 
	m§c_Àngth
;

50 
__u64
 
	mde°_off£t
;

53 
	sf°rim_ønge
 {

54 
__u64
 
	m°¨t
;

55 
__u64
 
	mÀn
;

56 
__u64
 
	mmöÀn
;

60 
	#FILE_DEDUPE_RANGE_SAME
 0

	)

61 
	#FILE_DEDUPE_RANGE_DIFFERS
 1

	)

64 
	sfûe_dedu≥_ønge_öfo
 {

65 
__s64
 
	mde°_fd
;

66 
__u64
 
	mde°_off£t
;

67 
__u64
 
	mbyãs_dedu≥d
;

74 
__s32
 
	m°©us
;

75 
__u32
 
	mª£rved
;

79 
	sfûe_dedu≥_ønge
 {

80 
__u64
 
	m§c_off£t
;

81 
__u64
 
	m§c_Àngth
;

82 
__u16
 
	mde°_cou¡
;

83 
__u16
 
	mª£rved1
;

84 
__u32
 
	mª£rved2
;

85 
fûe_dedu≥_ønge_öfo
 
	möfo
[0];

89 
	sfûes_°©_°ru˘
 {

90 
	mƒ_fûes
;

91 
	mƒ_‰ì_fûes
;

92 
	mmax_fûes
;

95 
	söodes_°©_t
 {

96 
	mƒ_öodes
;

97 
	mƒ_unu£d
;

98 
	mdummy
[5];

102 
	#NR_FILE
 8192

	)

108 
	#MS_RDONLY
 1

	)

109 
	#MS_NOSUID
 2

	)

110 
	#MS_NODEV
 4

	)

111 
	#MS_NOEXEC
 8

	)

112 
	#MS_SYNCHRONOUS
 16

	)

113 
	#MS_REMOUNT
 32

	)

114 
	#MS_MANDLOCK
 64

	)

115 
	#MS_DIRSYNC
 128

	)

116 
	#MS_NOATIME
 1024

	)

117 
	#MS_NODIRATIME
 2048

	)

118 
	#MS_BIND
 4096

	)

119 
	#MS_MOVE
 8192

	)

120 
	#MS_REC
 16384

	)

121 
	#MS_VERBOSE
 32768

	)

123 
	#MS_SILENT
 32768

	)

124 
	#MS_POSIXACL
 (1<<16Ë

	)

125 
	#MS_UNBINDABLE
 (1<<17Ë

	)

126 
	#MS_PRIVATE
 (1<<18Ë

	)

127 
	#MS_SLAVE
 (1<<19Ë

	)

128 
	#MS_SHARED
 (1<<20Ë

	)

129 
	#MS_RELATIME
 (1<<21Ë

	)

130 
	#MS_KERNMOUNT
 (1<<22Ë

	)

131 
	#MS_I_VERSION
 (1<<23Ë

	)

132 
	#MS_STRICTATIME
 (1<<24Ë

	)

133 
	#MS_LAZYTIME
 (1<<25Ë

	)

136 
	#MS_SUBMOUNT
 (1<<26)

	)

137 
	#MS_NOREMOTELOCK
 (1<<27)

	)

138 
	#MS_NOSEC
 (1<<28)

	)

139 
	#MS_BORN
 (1<<29)

	)

140 
	#MS_ACTIVE
 (1<<30)

	)

141 
	#MS_NOUSER
 (1<<31)

	)

146 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

147 
MS_LAZYTIME
)

	)

152 
	#MS_MGC_VAL
 0xC0ED0000

	)

153 
	#MS_MGC_MSK
 0xffff0000

	)

158 
	sfsx©å
 {

159 
__u32
 
	mfsx_xÊags
;

160 
__u32
 
	mfsx_extsize
;

161 
__u32
 
	mfsx_√xã¡s
;

162 
__u32
 
	mfsx_¥ojid
;

163 
__u32
 
	mfsx_cowextsize
;

164 
	mfsx_∑d
[8];

170 
	#FS_XFLAG_REALTIME
 0x00000001

	)

171 
	#FS_XFLAG_PREALLOC
 0x00000002

	)

172 
	#FS_XFLAG_IMMUTABLE
 0x00000008

	)

173 
	#FS_XFLAG_APPEND
 0x00000010

	)

174 
	#FS_XFLAG_SYNC
 0x00000020

	)

175 
	#FS_XFLAG_NOATIME
 0x00000040

	)

176 
	#FS_XFLAG_NODUMP
 0x00000080

	)

177 
	#FS_XFLAG_RTINHERIT
 0x00000100

	)

178 
	#FS_XFLAG_PROJINHERIT
 0x00000200

	)

179 
	#FS_XFLAG_NOSYMLINKS
 0x00000400

	)

180 
	#FS_XFLAG_EXTSIZE
 0x00000800

	)

181 
	#FS_XFLAG_EXTSZINHERIT
 0x00001000

	)

182 
	#FS_XFLAG_NODEFRAG
 0x00002000

	)

183 
	#FS_XFLAG_FILESTREAM
 0x00004000

	)

184 
	#FS_XFLAG_DAX
 0x00008000

	)

185 
	#FS_XFLAG_COWEXTSIZE
 0x00010000

	)

186 
	#FS_XFLAG_HASATTR
 0x80000000

	)

191 
	#BLKROSET
 
	`_IO
(0x12,93Ë

	)

192 
	#BLKROGET
 
	`_IO
(0x12,94Ë

	)

193 
	#BLKRRPART
 
	`_IO
(0x12,95Ë

	)

194 
	#BLKGETSIZE
 
	`_IO
(0x12,96Ë

	)

195 
	#BLKFLSBUF
 
	`_IO
(0x12,97Ë

	)

196 
	#BLKRASET
 
	`_IO
(0x12,98Ë

	)

197 
	#BLKRAGET
 
	`_IO
(0x12,99Ë

	)

198 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

199 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

200 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

201 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

202 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

204 
	#BLKPG
 
	`_IO
(0x12,105)

	)

208 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

209 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

214 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

215 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

216 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
Ë

	)

217 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_åa˚_£tup
)

	)

218 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

219 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

220 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

221 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

222 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

223 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

224 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

225 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

226 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

227 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

228 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

229 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

235 
	#BMAP_IOCTL
 1

	)

236 
	#FIBMAP
 
	`_IO
(0x00,1Ë

	)

237 
	#FIGETBSZ
 
	`_IO
(0x00,2Ë

	)

238 
	#FIFREEZE
 
	`_IOWR
('X', 119, Ë

	)

239 
	#FITHAW
 
	`_IOWR
('X', 120, Ë

	)

240 
	#FITRIM
 
	`_IOWR
('X', 121, 
f°rim_ønge
Ë

	)

241 
	#FICLONE
 
	`_IOW
(0x94, 9, )

	)

242 
	#FICLONERANGE
 
	`_IOW
(0x94, 13, 
fûe_˛⁄e_ønge
)

	)

243 
	#FIDEDUPERANGE
 
	`_IOWR
(0x94, 54, 
fûe_dedu≥_ønge
)

	)

245 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

246 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

247 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

248 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

249 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
fõm≠
)

	)

250 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

251 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

252 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

253 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

254 
	#FS_IOC_FSGETXATTR
 
	`_IOR
 ('X', 31, 
fsx©å
)

	)

255 
	#FS_IOC_FSSETXATTR
 
	`_IOW
 ('X', 32, 
fsx©å
)

	)

261 
	#FS_KEY_DESCRIPTOR_SIZE
 8

	)

263 
	#FS_POLICY_FLAGS_PAD_4
 0x00

	)

264 
	#FS_POLICY_FLAGS_PAD_8
 0x01

	)

265 
	#FS_POLICY_FLAGS_PAD_16
 0x02

	)

266 
	#FS_POLICY_FLAGS_PAD_32
 0x03

	)

267 
	#FS_POLICY_FLAGS_PAD_MASK
 0x03

	)

268 
	#FS_POLICY_FLAGS_VALID
 0x03

	)

271 
	#FS_ENCRYPTION_MODE_INVALID
 0

	)

272 
	#FS_ENCRYPTION_MODE_AES_256_XTS
 1

	)

273 
	#FS_ENCRYPTION_MODE_AES_256_GCM
 2

	)

274 
	#FS_ENCRYPTION_MODE_AES_256_CBC
 3

	)

275 
	#FS_ENCRYPTION_MODE_AES_256_CTS
 4

	)

276 
	#FS_ENCRYPTION_MODE_AES_128_CBC
 5

	)

277 
	#FS_ENCRYPTION_MODE_AES_128_CTS
 6

	)

279 
	sfs¸y±_pﬁicy
 {

280 
__u8
 
	mvîsi⁄
;

281 
__u8
 
	mc⁄ã¡s_í¸y±i⁄_mode
;

282 
__u8
 
	mfûíames_í¸y±i⁄_mode
;

283 
__u8
 
	mÊags
;

284 
__u8
 
	mma°î_key_des¸ùt‹
[
FS_KEY_DESCRIPTOR_SIZE
];

287 
	#FS_IOC_SET_ENCRYPTION_POLICY
 
	`_IOR
('f', 19, 
fs¸y±_pﬁicy
)

	)

288 
	#FS_IOC_GET_ENCRYPTION_PWSALT
 
	`_IOW
('f', 20, 
__u8
[16])

	)

289 
	#FS_IOC_GET_ENCRYPTION_POLICY
 
	`_IOW
('f', 21, 
fs¸y±_pﬁicy
)

	)

292 
	#FS_KEY_DESC_PREFIX
 "fs¸y±:"

	)

293 
	#FS_KEY_DESC_PREFIX_SIZE
 8

	)

296 
	#FS_MAX_KEY_SIZE
 64

	)

298 
	sfs¸y±_key
 {

299 
__u32
 
	mmode
;

300 
__u8
 
	møw
[
FS_MAX_KEY_SIZE
];

301 
__u32
 
	msize
;

324 
	#FS_SECRM_FL
 0x00000001

	)

325 
	#FS_UNRM_FL
 0x00000002

	)

326 
	#FS_COMPR_FL
 0x00000004

	)

327 
	#FS_SYNC_FL
 0x00000008

	)

328 
	#FS_IMMUTABLE_FL
 0x00000010

	)

329 
	#FS_APPEND_FL
 0x00000020

	)

330 
	#FS_NODUMP_FL
 0x00000040

	)

331 
	#FS_NOATIME_FL
 0x00000080

	)

333 
	#FS_DIRTY_FL
 0x00000100

	)

334 
	#FS_COMPRBLK_FL
 0x00000200

	)

335 
	#FS_NOCOMP_FL
 0x00000400

	)

337 
	#FS_ENCRYPT_FL
 0x00000800

	)

338 
	#FS_BTREE_FL
 0x00001000

	)

339 
	#FS_INDEX_FL
 0x00001000

	)

340 
	#FS_IMAGIC_FL
 0x00002000

	)

341 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

342 
	#FS_NOTAIL_FL
 0x00008000

	)

343 
	#FS_DIRSYNC_FL
 0x00010000

	)

344 
	#FS_TOPDIR_FL
 0x00020000

	)

345 
	#FS_HUGE_FILE_FL
 0x00040000

	)

346 
	#FS_EXTENT_FL
 0x00080000

	)

347 
	#FS_EA_INODE_FL
 0x00200000

	)

348 
	#FS_EOFBLOCKS_FL
 0x00400000

	)

349 
	#FS_NOCOW_FL
 0x00800000

	)

350 
	#FS_INLINE_DATA_FL
 0x10000000

	)

351 
	#FS_PROJINHERIT_FL
 0x20000000

	)

352 
	#FS_RESERVED_FL
 0x80000000

	)

354 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

355 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

358 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

359 
	#SYNC_FILE_RANGE_WRITE
 2

	)

360 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

366 
	t__bôwi£
 
	t__kî√l_rwf_t
;

369 
	#RWF_HIPRI
 ((
__kî√l_rwf_t
)0x00000001)

	)

372 
	#RWF_DSYNC
 ((
__kî√l_rwf_t
)0x00000002)

	)

375 
	#RWF_SYNC
 ((
__kî√l_rwf_t
)0x00000004)

	)

378 
	#RWF_NOWAIT
 ((
__kî√l_rwf_t
)0x00000008)

	)

381 
	#RWF_SUPPORTED
 (
RWF_HIPRI
 | 
RWF_DSYNC
 | 
RWF_SYNC
 | 
RWF_NOWAIT
)

	)

	@/usr/include/linux/fsmap.h

9 #i‚de‡
_LINUX_FSMAP_H


10 
	#_LINUX_FSMAP_H


	)

12 
	~<löux/ty≥s.h
>

50 
	sfsm≠
 {

51 
__u32
 
	mfmr_devi˚
;

52 
__u32
 
	mfmr_Êags
;

53 
__u64
 
	mfmr_physiˇl
;

54 
__u64
 
	mfmr_ow√r
;

55 
__u64
 
	mfmr_off£t
;

56 
__u64
 
	mfmr_Àngth
;

57 
__u64
 
	mfmr_ª£rved
[3];

60 
	sfsm≠_hód
 {

61 
__u32
 
	mfmh_iÊags
;

62 
__u32
 
	mfmh_oÊags
;

63 
__u32
 
	mfmh_cou¡
;

64 
__u32
 
	mfmh_íåõs
;

65 
__u64
 
	mfmh_ª£rved
[6];

67 
fsm≠
 
	mfmh_keys
[2];

68 
fsm≠
 
	mfmh_ªcs
[];

72 
__ölöe__
 
size_t


73 
	$fsm≠_sizeof
(

74 
ƒ
)

76  (
fsm≠_hód
Ë+ 
ƒ
 * (
fsm≠
);

77 
	}
}

80 
__ölöe__
 

81 
	$fsm≠_adv™˚
(

82 
fsm≠_hód
 *
hód
)

84 
hód
->
fmh_keys
[0] = hód->
fmh_ªcs
[hód->
fmh_íåõs
 - 1];

85 
	}
}

89 
	#FMH_IF_VALID
 0

	)

92 
	#FMH_OF_DEV_T
 0x1

	)

95 
	#FMR_OF_PREALLOC
 0x1

	)

96 
	#FMR_OF_ATTR_FORK
 0x2

	)

97 
	#FMR_OF_EXTENT_MAP
 0x4

	)

98 
	#FMR_OF_SHARED
 0x8

	)

99 
	#FMR_OF_SPECIAL_OWNER
 0x10

	)

100 
	#FMR_OF_LAST
 0x20

	)

103 
	#FMR_OWNER
(
ty≥
, 
code
Ë(((
__u64
)type << 32) | \

104 ((
__u64
)
code
 & 0xFFFFFFFFULL))

	)

105 
	#FMR_OWNER_TYPE
(
ow√r
Ë((
__u32
)((
__u64
)ow√∏>> 32))

	)

106 
	#FMR_OWNER_CODE
(
ow√r
Ë((
__u32
)(((
__u64
)ow√∏& 0xFFFFFFFFULL)))

	)

107 
	#FMR_OWN_FREE
 
	`FMR_OWNER
(0, 1Ë

	)

108 
	#FMR_OWN_UNKNOWN
 
	`FMR_OWNER
(0, 2Ë

	)

109 
	#FMR_OWN_METADATA
 
	`FMR_OWNER
(0, 3Ë

	)

111 
	#FS_IOC_GETFSMAP
 
	`_IOWR
('X', 59, 
fsm≠_hód
)

	)

	@/usr/include/linux/kdev_t.h

2 #i‚de‡
_LINUX_KDEV_T_H


3 
	#_LINUX_KDEV_T_H


	)

9 
	#MAJOR
(
dev
Ë((dev)>>8)

	)

10 
	#MINOR
(
dev
Ë((devË& 0xff)

	)

11 
	#MKDEV
(
ma
,
mi
Ë((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

2 #i‚de‡
_LINUX_KERNEL_H


3 
	#_LINUX_KERNEL_H


	)

5 
	~<löux/sysöfo.h
>

10 
	#__ALIGN_KERNEL
(
x
, 
a
Ë
	`__ALIGN_KERNEL_MASK
(x, (
	`ty≥of
(x))◊Ë- 1)

	)

11 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
Ë(((xË+ (mask)Ë& ~(mask))

	)

13 
	#__KERNEL_DIV_ROUND_UP
(
n
, 
d
Ë((“Ë+ (dË- 1Ë/ (d))

	)

	@/usr/include/linux/magic.h

2 #i‚de‡
__LINUX_MAGIC_H__


3 
	#__LINUX_MAGIC_H__


	)

5 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

6 
	#AFFS_SUPER_MAGIC
 0xadff

	)

7 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

8 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

9 
	#CODA_SUPER_MAGIC
 0x73757245

	)

10 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

11 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

12 
	#DEBUGFS_MAGIC
 0x64626720

	)

13 
	#SECURITYFS_MAGIC
 0x73636673

	)

14 
	#SELINUX_MAGIC
 0xf97cff8c

	)

15 
	#SMACK_MAGIC
 0x43415d53

	)

16 
	#RAMFS_MAGIC
 0x858458f6

	)

17 
	#TMPFS_MAGIC
 0x01021994

	)

18 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

19 
	#SQUASHFS_MAGIC
 0x73717368

	)

20 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

21 
	#EFS_SUPER_MAGIC
 0x414A53

	)

22 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

23 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

24 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

25 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

26 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

27 
	#NILFS_SUPER_MAGIC
 0x3434

	)

28 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

29 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

30 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

31 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

32 
	#PSTOREFS_MAGIC
 0x6165676C

	)

33 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

34 
	#HOSTFS_SUPER_MAGIC
 0x00c0f„e

	)

35 
	#OVERLAYFS_SUPER_MAGIC
 0x794c7630

	)

37 
	#MINIX_SUPER_MAGIC
 0x137F

	)

38 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

39 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

40 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

41 
	#MINIX3_SUPER_MAGIC
 0x4d5®

	)

43 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

44 
	#NCP_SUPER_MAGIC
 0x564¯

	)

45 
	#NFS_SUPER_MAGIC
 0x6969

	)

46 
	#OCFS2_SUPER_MAGIC
 0x7461636f

	)

47 
	#OPENPROM_SUPER_MAGIC
 0x9Á1

	)

48 
	#QNX4_SUPER_MAGIC
 0x002‡

	)

49 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

50 
	#AFS_FS_MAGIC
 0x6B414653

	)

52 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

55 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

56 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

57 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

59 
	#SMB_SUPER_MAGIC
 0x517B

	)

60 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

61 
	#CGROUP2_SUPER_MAGIC
 0x63677270

	)

63 
	#RDTGROUP_SUPER_MAGIC
 0x7655821

	)

65 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

67 
	#TRACEFS_MAGIC
 0x74726163

	)

69 
	#V9FS_MAGIC
 0x01021997

	)

71 
	#BDEVFS_MAGIC
 0x62646576

	)

72 
	#DAXFS_MAGIC
 0x64646178

	)

73 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

74 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

75 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

76 
	#PIPEFS_MAGIC
 0x50495045

	)

77 
	#PROC_SUPER_MAGIC
 0x9Á0

	)

78 
	#SOCKFS_MAGIC
 0x534F434B

	)

79 
	#SYSFS_MAGIC
 0x62656572

	)

80 
	#USBDEVICE_SUPER_MAGIC
 0x9Á2

	)

81 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

82 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

83 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

84 
	#NSFS_MAGIC
 0x6e736673

	)

85 
	#BPF_FS_MAGIC
 0xˇ„4a11

	)

86 
	#AAFS_MAGIC
 0x5a3c69f0

	)

89 
	#UDF_SUPER_MAGIC
 0x15013346

	)

90 
	#BALLOON_KVM_MAGIC
 0x13661366

	)

91 
	#ZSMALLOC_MAGIC
 0x58295829

	)

	@/usr/include/linux/mman.h

2 #i‚de‡
_LINUX_MMAN_H


3 
	#_LINUX_MMAN_H


	)

5 
	~<asm/mm™.h
>

6 
	~<asm-gíîic/hugëlb_ícode.h
>

8 
	#MREMAP_MAYMOVE
 1

	)

9 
	#MREMAP_FIXED
 2

	)

11 
	#OVERCOMMIT_GUESS
 0

	)

12 
	#OVERCOMMIT_ALWAYS
 1

	)

13 
	#OVERCOMMIT_NEVER
 2

	)

22 
	#MAP_HUGE_SHIFT
 
HUGETLB_FLAG_ENCODE_SHIFT


	)

23 
	#MAP_HUGE_MASK
 
HUGETLB_FLAG_ENCODE_MASK


	)

25 
	#MAP_HUGE_64KB
 
HUGETLB_FLAG_ENCODE_64KB


	)

26 
	#MAP_HUGE_512KB
 
HUGETLB_FLAG_ENCODE_512KB


	)

27 
	#MAP_HUGE_1MB
 
HUGETLB_FLAG_ENCODE_1MB


	)

28 
	#MAP_HUGE_2MB
 
HUGETLB_FLAG_ENCODE_2MB


	)

29 
	#MAP_HUGE_8MB
 
HUGETLB_FLAG_ENCODE_8MB


	)

30 
	#MAP_HUGE_16MB
 
HUGETLB_FLAG_ENCODE_16MB


	)

31 
	#MAP_HUGE_256MB
 
HUGETLB_FLAG_ENCODE_256MB


	)

32 
	#MAP_HUGE_1GB
 
HUGETLB_FLAG_ENCODE_1GB


	)

33 
	#MAP_HUGE_2GB
 
HUGETLB_FLAG_ENCODE_2GB


	)

34 
	#MAP_HUGE_16GB
 
HUGETLB_FLAG_ENCODE_16GB


	)

	@/usr/include/linux/module.h

2 #i‚de‡
_LINUX_MODULE_H


3 
	#_LINUX_MODULE_H


	)

6 
	#MODULE_INIT_IGNORE_MODVERSIONS
 1

	)

7 
	#MODULE_INIT_IGNORE_VERMAGIC
 2

	)

	@/usr/include/linux/posix_acl_xattr.h

18 #i‚de‡
__UAPI_POSIX_ACL_XATTR_H


19 
	#__UAPI_POSIX_ACL_XATTR_H


	)

21 
	~<löux/ty≥s.h
>

24 
	#POSIX_ACL_XATTR_VERSION
 0x0002

	)

27 
	#ACL_UNDEFINED_ID
 (-1)

	)

29 
	sposix_a˛_x©å_íåy
 {

30 
__À16
 
	me_èg
;

31 
__À16
 
	me_≥rm
;

32 
__À32
 
	me_id
;

35 
	sposix_a˛_x©å_hódî
 {

36 
__À32
 
	ma_vîsi⁄
;

	@/usr/include/linux/quota.h

33 #i‚de‡
_LINUX_QUOTA_


34 
	#_LINUX_QUOTA_


	)

36 
	~<löux/ty≥s.h
>

38 
	#__DQUOT_VERSION__
 "dquŸ_6.6.0"

	)

40 
	#MAXQUOTAS
 3

	)

41 
	#USRQUOTA
 0

	)

42 
	#GRPQUOTA
 1

	)

43 
	#PRJQUOTA
 2

	)

48 
	#INITQFNAMES
 { \

53 };

	)

61 
	#SUBCMDMASK
 0x00ff

	)

62 
	#SUBCMDSHIFT
 8

	)

63 
	#QCMD
(
cmd
, 
ty≥
Ë(((cmdË<< 
SUBCMDSHIFT
Ë| (—y≥Ë& 
SUBCMDMASK
))

	)

65 
	#Q_SYNC
 0x800001

	)

66 
	#Q_QUOTAON
 0x800002

	)

67 
	#Q_QUOTAOFF
 0x800003

	)

68 
	#Q_GETFMT
 0x800004

	)

69 
	#Q_GETINFO
 0x800005

	)

70 
	#Q_SETINFO
 0x800006

	)

71 
	#Q_GETQUOTA
 0x800007

	)

72 
	#Q_SETQUOTA
 0x800008

	)

73 
	#Q_GETNEXTQUOTA
 0x800009

	)

76 
	#QFMT_VFS_OLD
 1

	)

77 
	#QFMT_VFS_V0
 2

	)

78 
	#QFMT_OCFS2
 3

	)

79 
	#QFMT_VFS_V1
 4

	)

83 
	#QIF_DQBLKSIZE_BITS
 10

	)

84 
	#QIF_DQBLKSIZE
 (1 << 
QIF_DQBLKSIZE_BITS
)

	)

91 
	mQIF_BLIMITS_B
 = 0,

92 
	mQIF_SPACE_B
,

93 
	mQIF_ILIMITS_B
,

94 
	mQIF_INODES_B
,

95 
	mQIF_BTIME_B
,

96 
	mQIF_ITIME_B
,

99 
	#QIF_BLIMITS
 (1 << 
QIF_BLIMITS_B
)

	)

100 
	#QIF_SPACE
 (1 << 
QIF_SPACE_B
)

	)

101 
	#QIF_ILIMITS
 (1 << 
QIF_ILIMITS_B
)

	)

102 
	#QIF_INODES
 (1 << 
QIF_INODES_B
)

	)

103 
	#QIF_BTIME
 (1 << 
QIF_BTIME_B
)

	)

104 
	#QIF_ITIME
 (1 << 
QIF_ITIME_B
)

	)

105 
	#QIF_LIMITS
 (
QIF_BLIMITS
 | 
QIF_ILIMITS
)

	)

106 
	#QIF_USAGE
 (
QIF_SPACE
 | 
QIF_INODES
)

	)

107 
	#QIF_TIMES
 (
QIF_BTIME
 | 
QIF_ITIME
)

	)

108 
	#QIF_ALL
 (
QIF_LIMITS
 | 
QIF_USAGE
 | 
QIF_TIMES
)

	)

110 
	sif_dqblk
 {

111 
__u64
 
	mdqb_bh¨dlimô
;

112 
__u64
 
	mdqb_bso·limô
;

113 
__u64
 
	mdqb_cur•a˚
;

114 
__u64
 
	mdqb_ih¨dlimô
;

115 
__u64
 
	mdqb_iso·limô
;

116 
__u64
 
	mdqb_curöodes
;

117 
__u64
 
	mdqb_btime
;

118 
__u64
 
	mdqb_ôime
;

119 
__u32
 
	mdqb_vÆid
;

122 
	sif_√xtdqblk
 {

123 
__u64
 
	mdqb_bh¨dlimô
;

124 
__u64
 
	mdqb_bso·limô
;

125 
__u64
 
	mdqb_cur•a˚
;

126 
__u64
 
	mdqb_ih¨dlimô
;

127 
__u64
 
	mdqb_iso·limô
;

128 
__u64
 
	mdqb_curöodes
;

129 
__u64
 
	mdqb_btime
;

130 
__u64
 
	mdqb_ôime
;

131 
__u32
 
	mdqb_vÆid
;

132 
__u32
 
	mdqb_id
;

139 
	#IIF_BGRACE
 1

	)

140 
	#IIF_IGRACE
 2

	)

141 
	#IIF_FLAGS
 4

	)

142 
	#IIF_ALL
 (
IIF_BGRACE
 | 
IIF_IGRACE
 | 
IIF_FLAGS
)

	)

145 
	mDQF_ROOT_SQUASH_B
 = 0,

146 
	mDQF_SYS_FILE_B
 = 16,

148 
	mDQF_PRIVATE


152 
	#DQF_ROOT_SQUASH
 (1 << 
DQF_ROOT_SQUASH_B
)

	)

154 
	#DQF_SYS_FILE
 (1 << 
DQF_SYS_FILE_B
)

	)

156 
	sif_dqöfo
 {

157 
__u64
 
	mdqi_bgø˚
;

158 
__u64
 
	mdqi_igø˚
;

159 
__u32
 
	mdqi_Êags
;

160 
__u32
 
	mdqi_vÆid
;

166 
	#QUOTA_NL_NOWARN
 0

	)

167 
	#QUOTA_NL_IHARDWARN
 1

	)

168 
	#QUOTA_NL_ISOFTLONGWARN
 2

	)

169 
	#QUOTA_NL_ISOFTWARN
 3

	)

170 
	#QUOTA_NL_BHARDWARN
 4

	)

171 
	#QUOTA_NL_BSOFTLONGWARN
 5

	)

172 
	#QUOTA_NL_BSOFTWARN
 6

	)

173 
	#QUOTA_NL_IHARDBELOW
 7

	)

174 
	#QUOTA_NL_ISOFTBELOW
 8

	)

175 
	#QUOTA_NL_BHARDBELOW
 9

	)

176 
	#QUOTA_NL_BSOFTBELOW
 10

	)

179 
	mQUOTA_NL_C_UNSPEC
,

180 
	mQUOTA_NL_C_WARNING
,

181 
	m__QUOTA_NL_C_MAX
,

183 
	#QUOTA_NL_C_MAX
 (
__QUOTA_NL_C_MAX
 - 1)

	)

186 
	mQUOTA_NL_A_UNSPEC
,

187 
	mQUOTA_NL_A_QTYPE
,

188 
	mQUOTA_NL_A_EXCESS_ID
,

189 
	mQUOTA_NL_A_WARNING
,

190 
	mQUOTA_NL_A_DEV_MAJOR
,

191 
	mQUOTA_NL_A_DEV_MINOR
,

192 
	mQUOTA_NL_A_CAUSED_ID
,

193 
	mQUOTA_NL_A_PAD
,

194 
	m__QUOTA_NL_A_MAX
,

196 
	#QUOTA_NL_A_MAX
 (
__QUOTA_NL_A_MAX
 - 1)

	)

	@/usr/include/linux/random.h

8 #i‚de‡
_LINUX_RANDOM_H


9 
	#_LINUX_RANDOM_H


	)

11 
	~<löux/ty≥s.h
>

12 
	~<löux/io˘l.h
>

13 
	~<löux/úqƒ.h
>

18 
	#RNDGETENTCNT
 
	`_IOR
–'R', 0x00, )

	)

21 
	#RNDADDTOENTCNT
 
	`_IOW
–'R', 0x01, )

	)

24 
	#RNDGETPOOL
 
	`_IOR
–'R', 0x02, [2] )

	)

30 
	#RNDADDENTROPY
 
	`_IOW
–'R', 0x03, [2] )

	)

33 
	#RNDZAPENTCNT
 
	`_IO
–'R', 0x04 )

	)

36 
	#RNDCLEARPOOL
 
	`_IO
–'R', 0x06 )

	)

39 
	#RNDRESEEDCRNG
 
	`_IO
–'R', 0x07 )

	)

41 
	sønd_poﬁ_öfo
 {

42 
	míå›y_cou¡
;

43 
	mbuf_size
;

44 
__u32
 
	mbuf
[0];

53 
	#GRND_NONBLOCK
 0x0001

	)

54 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

2 #i‚de‡
_LINUX_SCHED_H


3 
	#_LINUX_SCHED_H


	)

8 
	#CSIGNAL
 0x000000f‡

	)

9 
	#CLONE_VM
 0x00000100

	)

10 
	#CLONE_FS
 0x00000200

	)

11 
	#CLONE_FILES
 0x00000400

	)

12 
	#CLONE_SIGHAND
 0x00000800

	)

13 
	#CLONE_PTRACE
 0x00002000

	)

14 
	#CLONE_VFORK
 0x00004000

	)

15 
	#CLONE_PARENT
 0x00008000

	)

16 
	#CLONE_THREAD
 0x00010000

	)

17 
	#CLONE_NEWNS
 0x00020000

	)

18 
	#CLONE_SYSVSEM
 0x00040000

	)

19 
	#CLONE_SETTLS
 0x00080000

	)

20 
	#CLONE_PARENT_SETTID
 0x00100000

	)

21 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

22 
	#CLONE_DETACHED
 0x00400000

	)

23 
	#CLONE_UNTRACED
 0x00800000

	)

24 
	#CLONE_CHILD_SETTID
 0x01000000

	)

25 
	#CLONE_NEWCGROUP
 0x02000000

	)

26 
	#CLONE_NEWUTS
 0x04000000

	)

27 
	#CLONE_NEWIPC
 0x08000000

	)

28 
	#CLONE_NEWUSER
 0x10000000

	)

29 
	#CLONE_NEWPID
 0x20000000

	)

30 
	#CLONE_NEWNET
 0x40000000

	)

31 
	#CLONE_IO
 0x80000000

	)

36 
	#SCHED_NORMAL
 0

	)

37 
	#SCHED_FIFO
 1

	)

38 
	#SCHED_RR
 2

	)

39 
	#SCHED_BATCH
 3

	)

41 
	#SCHED_IDLE
 5

	)

42 
	#SCHED_DEADLINE
 6

	)

45 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

50 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

51 
	#SCHED_FLAG_RECLAIM
 0x02

	)

	@/usr/include/linux/stat.h

2 #i‚de‡
_LINUX_STAT_H


3 
	#_LINUX_STAT_H


	)

5 
	~<löux/ty≥s.h
>

7 #i‡
deföed
(
__KERNEL__
Ë|| !deföed(
__GLIBC__
) || (__GLIBC__ < 2)

9 
	#S_IFMT
 00170000

	)

10 
	#S_IFSOCK
 0140000

	)

11 
	#S_IFLNK
 0120000

	)

12 
	#S_IFREG
 0100000

	)

13 
	#S_IFBLK
 0060000

	)

14 
	#S_IFDIR
 0040000

	)

15 
	#S_IFCHR
 0020000

	)

16 
	#S_IFIFO
 0010000

	)

17 
	#S_ISUID
 0004000

	)

18 
	#S_ISGID
 0002000

	)

19 
	#S_ISVTX
 0001000

	)

21 
	#S_ISLNK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFLNK
)

	)

22 
	#S_ISREG
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFREG
)

	)

23 
	#S_ISDIR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFDIR
)

	)

24 
	#S_ISCHR
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFCHR
)

	)

25 
	#S_ISBLK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFBLK
)

	)

26 
	#S_ISFIFO
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFIFO
)

	)

27 
	#S_ISSOCK
(
m
Ë(((mË& 
S_IFMT
Ë=
S_IFSOCK
)

	)

29 
	#S_IRWXU
 00700

	)

30 
	#S_IRUSR
 00400

	)

31 
	#S_IWUSR
 00200

	)

32 
	#S_IXUSR
 00100

	)

34 
	#S_IRWXG
 00070

	)

35 
	#S_IRGRP
 00040

	)

36 
	#S_IWGRP
 00020

	)

37 
	#S_IXGRP
 00010

	)

39 
	#S_IRWXO
 00007

	)

40 
	#S_IROTH
 00004

	)

41 
	#S_IWOTH
 00002

	)

42 
	#S_IXOTH
 00001

	)

56 
	s°©x_time°amp
 {

57 
__s64
 
	mtv_£c
;

58 
__u32
 
	mtv_n£c
;

59 
__s32
 
	m__ª£rved
;

99 
	s°©x
 {

101 
__u32
 
	m°x_mask
;

102 
__u32
 
	m°x_blksize
;

103 
__u64
 
	m°x_©åibuãs
;

105 
__u32
 
	m°x_∆ök
;

106 
__u32
 
	m°x_uid
;

107 
__u32
 
	m°x_gid
;

108 
__u16
 
	m°x_mode
;

109 
__u16
 
	m__•¨e0
[1];

111 
__u64
 
	m°x_öo
;

112 
__u64
 
	m°x_size
;

113 
__u64
 
	m°x_blocks
;

114 
__u64
 
	m°x_©åibuãs_mask
;

116 
°©x_time°amp
 
	m°x_©ime
;

117 
°©x_time°amp
 
	m°x_btime
;

118 
°©x_time°amp
 
	m°x_˘ime
;

119 
°©x_time°amp
 
	m°x_mtime
;

121 
__u32
 
	m°x_rdev_maj‹
;

122 
__u32
 
	m°x_rdev_mö‹
;

123 
__u32
 
	m°x_dev_maj‹
;

124 
__u32
 
	m°x_dev_mö‹
;

126 
__u64
 
	m__•¨e2
[14];

138 
	#STATX_TYPE
 0x00000001U

	)

139 
	#STATX_MODE
 0x00000002U

	)

140 
	#STATX_NLINK
 0x00000004U

	)

141 
	#STATX_UID
 0x00000008U

	)

142 
	#STATX_GID
 0x00000010U

	)

143 
	#STATX_ATIME
 0x00000020U

	)

144 
	#STATX_MTIME
 0x00000040U

	)

145 
	#STATX_CTIME
 0x00000080U

	)

146 
	#STATX_INO
 0x00000100U

	)

147 
	#STATX_SIZE
 0x00000200U

	)

148 
	#STATX_BLOCKS
 0x00000400U

	)

149 
	#STATX_BASIC_STATS
 0x000007ffU

	)

150 
	#STATX_BTIME
 0x00000800U

	)

151 
	#STATX_ALL
 0x00000fffU

	)

152 
	#STATX__RESERVED
 0x80000000U

	)

165 
	#STATX_ATTR_COMPRESSED
 0x00000004

	)

166 
	#STATX_ATTR_IMMUTABLE
 0x00000010

	)

167 
	#STATX_ATTR_APPEND
 0x00000020

	)

168 
	#STATX_ATTR_NODUMP
 0x00000040

	)

169 
	#STATX_ATTR_ENCRYPTED
 0x00000800

	)

171 
	#STATX_ATTR_AUTOMOUNT
 0x00001000

	)

	@/usr/include/linux/string.h

2 #i‚de‡
_LINUX_STRING_H_


3 
	#_LINUX_STRING_H_


	)

7 
	~<°rög.h
>

	@/usr/include/linux/sysctl.h

23 #i‚de‡
_LINUX_SYSCTL_H


24 
	#_LINUX_SYSCTL_H


	)

26 
	~<löux/kî√l.h
>

27 
	~<löux/ty≥s.h
>

30 
	#CTL_MAXNAME
 10

	)

35 
	s__sys˘l_¨gs
 {

36 *
	m«me
;

37 
	m∆í
;

38 *
	mﬁdvÆ
;

39 
size_t
 *
	mﬁdÀ≈
;

40 *
	m√wvÆ
;

41 
size_t
 
	m√wÀn
;

42 
	m__unu£d
[4];

51 
	mCTL_KERN
=1,

52 
	mCTL_VM
=2,

53 
	mCTL_NET
=3,

54 
	mCTL_PROC
=4,

55 
	mCTL_FS
=5,

56 
	mCTL_DEBUG
=6,

57 
	mCTL_DEV
=7,

58 
	mCTL_BUS
=8,

59 
	mCTL_ABI
=9,

60 
	mCTL_CPU
=10,

61 
	mCTL_ARLAN
=254,

62 
	mCTL_S390DBF
=5677,

63 
	mCTL_SUNRPC
=7249,

64 
	mCTL_PM
=9899,

65 
	mCTL_FRV
=9898,

71 
	mCTL_BUS_ISA
=1

77 
	mINOTIFY_MAX_USER_INSTANCES
=1,

78 
	mINOTIFY_MAX_USER_WATCHES
=2,

79 
	mINOTIFY_MAX_QUEUED_EVENTS
=3

85 
	mKERN_OSTYPE
=1,

86 
	mKERN_OSRELEASE
=2,

87 
	mKERN_OSREV
=3,

88 
	mKERN_VERSION
=4,

89 
	mKERN_SECUREMASK
=5,

90 
	mKERN_PROF
=6,

91 
	mKERN_NODENAME
=7,

92 
	mKERN_DOMAINNAME
=8,

94 
	mKERN_PANIC
=15,

95 
	mKERN_REALROOTDEV
=16,

97 
	mKERN_SPARC_REBOOT
=21,

98 
	mKERN_CTLALTDEL
=22,

99 
	mKERN_PRINTK
=23,

100 
	mKERN_NAMETRANS
=24,

101 
	mKERN_PPC_HTABRECLAIM
=25,

102 
	mKERN_PPC_ZEROPAGED
=26,

103 
	mKERN_PPC_POWERSAVE_NAP
=27,

104 
	mKERN_MODPROBE
=28,

105 
	mKERN_SG_BIG_BUFF
=29,

106 
	mKERN_ACCT
=30,

107 
	mKERN_PPC_L2CR
=31,

109 
	mKERN_RTSIGNR
=32,

110 
	mKERN_RTSIGMAX
=33,

112 
	mKERN_SHMMAX
=34,

113 
	mKERN_MSGMAX
=35,

114 
	mKERN_MSGMNB
=36,

115 
	mKERN_MSGPOOL
=37,

116 
	mKERN_SYSRQ
=38,

117 
	mKERN_MAX_THREADS
=39,

118 
	mKERN_RANDOM
=40,

119 
	mKERN_SHMALL
=41,

120 
	mKERN_MSGMNI
=42,

121 
	mKERN_SEM
=43,

122 
	mKERN_SPARC_STOP_A
=44,

123 
	mKERN_SHMMNI
=45,

124 
	mKERN_OVERFLOWUID
=46,

125 
	mKERN_OVERFLOWGID
=47,

126 
	mKERN_SHMPATH
=48,

127 
	mKERN_HOTPLUG
=49,

128 
	mKERN_IEEE_EMULATION_WARNINGS
=50,

129 
	mKERN_S390_USER_DEBUG_LOGGING
=51,

130 
	mKERN_CORE_USES_PID
=52,

131 
	mKERN_TAINTED
=53,

132 
	mKERN_CADPID
=54,

133 
	mKERN_PIDMAX
=55,

134 
	mKERN_CORE_PATTERN
=56,

135 
	mKERN_PANIC_ON_OOPS
=57,

136 
	mKERN_HPPA_PWRSW
=58,

137 
	mKERN_HPPA_UNALIGNED
=59,

138 
	mKERN_PRINTK_RATELIMIT
=60,

139 
	mKERN_PRINTK_RATELIMIT_BURST
=61,

140 
	mKERN_PTY
=62,

141 
	mKERN_NGROUPS_MAX
=63,

142 
	mKERN_SPARC_SCONS_PWROFF
=64,

143 
	mKERN_HZ_TIMER
=65,

144 
	mKERN_UNKNOWN_NMI_PANIC
=66,

145 
	mKERN_BOOTLOADER_TYPE
=67,

146 
	mKERN_RANDOMIZE
=68,

147 
	mKERN_SETUID_DUMPABLE
=69,

148 
	mKERN_SPIN_RETRY
=70,

149 
	mKERN_ACPI_VIDEO_FLAGS
=71,

150 
	mKERN_IA64_UNALIGNED
=72,

151 
	mKERN_COMPAT_LOG
=73,

152 
	mKERN_MAX_LOCK_DEPTH
=74,

153 
	mKERN_NMI_WATCHDOG
=75,

154 
	mKERN_PANIC_ON_NMI
=76,

155 
	mKERN_PANIC_ON_WARN
=77,

163 
	mVM_UNUSED1
=1,

164 
	mVM_UNUSED2
=2,

165 
	mVM_UNUSED3
=3,

166 
	mVM_UNUSED4
=4,

167 
	mVM_OVERCOMMIT_MEMORY
=5,

168 
	mVM_UNUSED5
=6,

169 
	mVM_UNUSED7
=7,

170 
	mVM_UNUSED8
=8,

171 
	mVM_UNUSED9
=9,

172 
	mVM_PAGE_CLUSTER
=10,

173 
	mVM_DIRTY_BACKGROUND
=11,

174 
	mVM_DIRTY_RATIO
=12,

175 
	mVM_DIRTY_WB_CS
=13,

176 
	mVM_DIRTY_EXPIRE_CS
=14,

177 
	mVM_NR_PDFLUSH_THREADS
=15,

178 
	mVM_OVERCOMMIT_RATIO
=16,

179 
	mVM_PAGEBUF
=17,

180 
	mVM_HUGETLB_PAGES
=18,

181 
	mVM_SWAPPINESS
=19,

182 
	mVM_LOWMEM_RESERVE_RATIO
=20,

183 
	mVM_MIN_FREE_KBYTES
=21,

184 
	mVM_MAX_MAP_COUNT
=22,

185 
	mVM_LAPTOP_MODE
=23,

186 
	mVM_BLOCK_DUMP
=24,

187 
	mVM_HUGETLB_GROUP
=25,

188 
	mVM_VFS_CACHE_PRESSURE
=26,

189 
	mVM_LEGACY_VA_LAYOUT
=27,

190 
	mVM_SWAP_TOKEN_TIMEOUT
=28,

191 
	mVM_DROP_PAGECACHE
=29,

192 
	mVM_PERCPU_PAGELIST_FRACTION
=30,

193 
	mVM_ZONE_RECLAIM_MODE
=31,

194 
	mVM_MIN_UNMAPPED
=32,

195 
	mVM_PANIC_ON_OOM
=33,

196 
	mVM_VDSO_ENABLED
=34,

197 
	mVM_MIN_SLAB
=35,

204 
	mNET_CORE
=1,

205 
	mNET_ETHER
=2,

206 
	mNET_802
=3,

207 
	mNET_UNIX
=4,

208 
	mNET_IPV4
=5,

209 
	mNET_IPX
=6,

210 
	mNET_ATALK
=7,

211 
	mNET_NETROM
=8,

212 
	mNET_AX25
=9,

213 
	mNET_BRIDGE
=10,

214 
	mNET_ROSE
=11,

215 
	mNET_IPV6
=12,

216 
	mNET_X25
=13,

217 
	mNET_TR
=14,

218 
	mNET_DECNET
=15,

219 
	mNET_ECONET
=16,

220 
	mNET_SCTP
=17,

221 
	mNET_LLC
=18,

222 
	mNET_NETFILTER
=19,

223 
	mNET_DCCP
=20,

224 
	mNET_IRDA
=412,

230 
	mRANDOM_POOLSIZE
=1,

231 
	mRANDOM_ENTROPY_COUNT
=2,

232 
	mRANDOM_READ_THRESH
=3,

233 
	mRANDOM_WRITE_THRESH
=4,

234 
	mRANDOM_BOOT_ID
=5,

235 
	mRANDOM_UUID
=6

241 
	mPTY_MAX
=1,

242 
	mPTY_NR
=2

248 
	mBUS_ISA_MEM_BASE
=1,

249 
	mBUS_ISA_PORT_BASE
=2,

250 
	mBUS_ISA_PORT_SHIFT
=3

256 
	mNET_CORE_WMEM_MAX
=1,

257 
	mNET_CORE_RMEM_MAX
=2,

258 
	mNET_CORE_WMEM_DEFAULT
=3,

259 
	mNET_CORE_RMEM_DEFAULT
=4,

261 
	mNET_CORE_MAX_BACKLOG
=6,

262 
	mNET_CORE_FASTROUTE
=7,

263 
	mNET_CORE_MSG_COST
=8,

264 
	mNET_CORE_MSG_BURST
=9,

265 
	mNET_CORE_OPTMEM_MAX
=10,

266 
	mNET_CORE_HOT_LIST_LENGTH
=11,

267 
	mNET_CORE_DIVERT_VERSION
=12,

268 
	mNET_CORE_NO_CONG_THRESH
=13,

269 
	mNET_CORE_NO_CONG
=14,

270 
	mNET_CORE_LO_CONG
=15,

271 
	mNET_CORE_MOD_CONG
=16,

272 
	mNET_CORE_DEV_WEIGHT
=17,

273 
	mNET_CORE_SOMAXCONN
=18,

274 
	mNET_CORE_BUDGET
=19,

275 
	mNET_CORE_AEVENT_ETIME
=20,

276 
	mNET_CORE_AEVENT_RSEQTH
=21,

277 
	mNET_CORE_WARNINGS
=22,

288 
	mNET_UNIX_DESTROY_DELAY
=1,

289 
	mNET_UNIX_DELETE_DELAY
=2,

290 
	mNET_UNIX_MAX_DGRAM_QLEN
=3,

296 
	mNET_NF_CONNTRACK_MAX
=1,

297 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_SYN_SENT
=2,

298 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_SYN_RECV
=3,

299 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_ESTABLISHED
=4,

300 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_FIN_WAIT
=5,

301 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_CLOSE_WAIT
=6,

302 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_LAST_ACK
=7,

303 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_TIME_WAIT
=8,

304 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_CLOSE
=9,

305 
	mNET_NF_CONNTRACK_UDP_TIMEOUT
=10,

306 
	mNET_NF_CONNTRACK_UDP_TIMEOUT_STREAM
=11,

307 
	mNET_NF_CONNTRACK_ICMP_TIMEOUT
=12,

308 
	mNET_NF_CONNTRACK_GENERIC_TIMEOUT
=13,

309 
	mNET_NF_CONNTRACK_BUCKETS
=14,

310 
	mNET_NF_CONNTRACK_LOG_INVALID
=15,

311 
	mNET_NF_CONNTRACK_TCP_TIMEOUT_MAX_RETRANS
=16,

312 
	mNET_NF_CONNTRACK_TCP_LOOSE
=17,

313 
	mNET_NF_CONNTRACK_TCP_BE_LIBERAL
=18,

314 
	mNET_NF_CONNTRACK_TCP_MAX_RETRANS
=19,

315 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_CLOSED
=20,

316 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_WAIT
=21,

317 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_ECHOED
=22,

318 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_ESTABLISHED
=23,

319 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_SENT
=24,

320 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_RECD
=25,

321 
	mNET_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_ACK_SENT
=26,

322 
	mNET_NF_CONNTRACK_COUNT
=27,

323 
	mNET_NF_CONNTRACK_ICMPV6_TIMEOUT
=28,

324 
	mNET_NF_CONNTRACK_FRAG6_TIMEOUT
=29,

325 
	mNET_NF_CONNTRACK_FRAG6_LOW_THRESH
=30,

326 
	mNET_NF_CONNTRACK_FRAG6_HIGH_THRESH
=31,

327 
	mNET_NF_CONNTRACK_CHECKSUM
=32,

334 
	mNET_IPV4_FORWARD
=8,

335 
	mNET_IPV4_DYNADDR
=9,

337 
	mNET_IPV4_CONF
=16,

338 
	mNET_IPV4_NEIGH
=17,

339 
	mNET_IPV4_ROUTE
=18,

340 
	mNET_IPV4_FIB_HASH
=19,

341 
	mNET_IPV4_NETFILTER
=20,

343 
	mNET_IPV4_TCP_TIMESTAMPS
=33,

344 
	mNET_IPV4_TCP_WINDOW_SCALING
=34,

345 
	mNET_IPV4_TCP_SACK
=35,

346 
	mNET_IPV4_TCP_RETRANS_COLLAPSE
=36,

347 
	mNET_IPV4_DEFAULT_TTL
=37,

348 
	mNET_IPV4_AUTOCONFIG
=38,

349 
	mNET_IPV4_NO_PMTU_DISC
=39,

350 
	mNET_IPV4_TCP_SYN_RETRIES
=40,

351 
	mNET_IPV4_IPFRAG_HIGH_THRESH
=41,

352 
	mNET_IPV4_IPFRAG_LOW_THRESH
=42,

353 
	mNET_IPV4_IPFRAG_TIME
=43,

354 
	mNET_IPV4_TCP_MAX_KA_PROBES
=44,

355 
	mNET_IPV4_TCP_KEEPALIVE_TIME
=45,

356 
	mNET_IPV4_TCP_KEEPALIVE_PROBES
=46,

357 
	mNET_IPV4_TCP_RETRIES1
=47,

358 
	mNET_IPV4_TCP_RETRIES2
=48,

359 
	mNET_IPV4_TCP_FIN_TIMEOUT
=49,

360 
	mNET_IPV4_IP_MASQ_DEBUG
=50,

361 
	mNET_TCP_SYNCOOKIES
=51,

362 
	mNET_TCP_STDURG
=52,

363 
	mNET_TCP_RFC1337
=53,

364 
	mNET_TCP_SYN_TAILDROP
=54,

365 
	mNET_TCP_MAX_SYN_BACKLOG
=55,

366 
	mNET_IPV4_LOCAL_PORT_RANGE
=56,

367 
	mNET_IPV4_ICMP_ECHO_IGNORE_ALL
=57,

368 
	mNET_IPV4_ICMP_ECHO_IGNORE_BROADCASTS
=58,

369 
	mNET_IPV4_ICMP_SOURCEQUENCH_RATE
=59,

370 
	mNET_IPV4_ICMP_DESTUNREACH_RATE
=60,

371 
	mNET_IPV4_ICMP_TIMEEXCEED_RATE
=61,

372 
	mNET_IPV4_ICMP_PARAMPROB_RATE
=62,

373 
	mNET_IPV4_ICMP_ECHOREPLY_RATE
=63,

374 
	mNET_IPV4_ICMP_IGNORE_BOGUS_ERROR_RESPONSES
=64,

375 
	mNET_IPV4_IGMP_MAX_MEMBERSHIPS
=65,

376 
	mNET_TCP_TW_RECYCLE
=66,

377 
	mNET_IPV4_ALWAYS_DEFRAG
=67,

378 
	mNET_IPV4_TCP_KEEPALIVE_INTVL
=68,

379 
	mNET_IPV4_INET_PEER_THRESHOLD
=69,

380 
	mNET_IPV4_INET_PEER_MINTTL
=70,

381 
	mNET_IPV4_INET_PEER_MAXTTL
=71,

382 
	mNET_IPV4_INET_PEER_GC_MINTIME
=72,

383 
	mNET_IPV4_INET_PEER_GC_MAXTIME
=73,

384 
	mNET_TCP_ORPHAN_RETRIES
=74,

385 
	mNET_TCP_ABORT_ON_OVERFLOW
=75,

386 
	mNET_TCP_SYNACK_RETRIES
=76,

387 
	mNET_TCP_MAX_ORPHANS
=77,

388 
	mNET_TCP_MAX_TW_BUCKETS
=78,

389 
	mNET_TCP_FACK
=79,

390 
	mNET_TCP_REORDERING
=80,

391 
	mNET_TCP_ECN
=81,

392 
	mNET_TCP_DSACK
=82,

393 
	mNET_TCP_MEM
=83,

394 
	mNET_TCP_WMEM
=84,

395 
	mNET_TCP_RMEM
=85,

396 
	mNET_TCP_APP_WIN
=86,

397 
	mNET_TCP_ADV_WIN_SCALE
=87,

398 
	mNET_IPV4_NONLOCAL_BIND
=88,

399 
	mNET_IPV4_ICMP_RATELIMIT
=89,

400 
	mNET_IPV4_ICMP_RATEMASK
=90,

401 
	mNET_TCP_TW_REUSE
=91,

402 
	mNET_TCP_FRTO
=92,

403 
	mNET_TCP_LOW_LATENCY
=93,

404 
	mNET_IPV4_IPFRAG_SECRET_INTERVAL
=94,

405 
	mNET_IPV4_IGMP_MAX_MSF
=96,

406 
	mNET_TCP_NO_METRICS_SAVE
=97,

407 
	mNET_TCP_DEFAULT_WIN_SCALE
=105,

408 
	mNET_TCP_MODERATE_RCVBUF
=106,

409 
	mNET_TCP_TSO_WIN_DIVISOR
=107,

410 
	mNET_TCP_BIC_BETA
=108,

411 
	mNET_IPV4_ICMP_ERRORS_USE_INBOUND_IFADDR
=109,

412 
	mNET_TCP_CONG_CONTROL
=110,

413 
	mNET_TCP_ABC
=111,

414 
	mNET_IPV4_IPFRAG_MAX_DIST
=112,

415 
	mNET_TCP_MTU_PROBING
=113,

416 
	mNET_TCP_BASE_MSS
=114,

417 
	mNET_IPV4_TCP_WORKAROUND_SIGNED_WINDOWS
=115,

418 
	mNET_TCP_DMA_COPYBREAK
=116,

419 
	mNET_TCP_SLOW_START_AFTER_IDLE
=117,

420 
	mNET_CIPSOV4_CACHE_ENABLE
=118,

421 
	mNET_CIPSOV4_CACHE_BUCKET_SIZE
=119,

422 
	mNET_CIPSOV4_RBM_OPTFMT
=120,

423 
	mNET_CIPSOV4_RBM_STRICTVALID
=121,

424 
	mNET_TCP_AVAIL_CONG_CONTROL
=122,

425 
	mNET_TCP_ALLOWED_CONG_CONTROL
=123,

426 
	mNET_TCP_MAX_SSTHRESH
=124,

427 
	mNET_TCP_FRTO_RESPONSE
=125,

431 
	mNET_IPV4_ROUTE_FLUSH
=1,

432 
	mNET_IPV4_ROUTE_MIN_DELAY
=2,

433 
	mNET_IPV4_ROUTE_MAX_DELAY
=3,

434 
	mNET_IPV4_ROUTE_GC_THRESH
=4,

435 
	mNET_IPV4_ROUTE_MAX_SIZE
=5,

436 
	mNET_IPV4_ROUTE_GC_MIN_INTERVAL
=6,

437 
	mNET_IPV4_ROUTE_GC_TIMEOUT
=7,

438 
	mNET_IPV4_ROUTE_GC_INTERVAL
=8,

439 
	mNET_IPV4_ROUTE_REDIRECT_LOAD
=9,

440 
	mNET_IPV4_ROUTE_REDIRECT_NUMBER
=10,

441 
	mNET_IPV4_ROUTE_REDIRECT_SILENCE
=11,

442 
	mNET_IPV4_ROUTE_ERROR_COST
=12,

443 
	mNET_IPV4_ROUTE_ERROR_BURST
=13,

444 
	mNET_IPV4_ROUTE_GC_ELASTICITY
=14,

445 
	mNET_IPV4_ROUTE_MTU_EXPIRES
=15,

446 
	mNET_IPV4_ROUTE_MIN_PMTU
=16,

447 
	mNET_IPV4_ROUTE_MIN_ADVMSS
=17,

448 
	mNET_IPV4_ROUTE_SECRET_INTERVAL
=18,

449 
	mNET_IPV4_ROUTE_GC_MIN_INTERVAL_MS
=19,

454 
	mNET_PROTO_CONF_ALL
=-2,

455 
	mNET_PROTO_CONF_DEFAULT
=-3

462 
	mNET_IPV4_CONF_FORWARDING
=1,

463 
	mNET_IPV4_CONF_MC_FORWARDING
=2,

464 
	mNET_IPV4_CONF_PROXY_ARP
=3,

465 
	mNET_IPV4_CONF_ACCEPT_REDIRECTS
=4,

466 
	mNET_IPV4_CONF_SECURE_REDIRECTS
=5,

467 
	mNET_IPV4_CONF_SEND_REDIRECTS
=6,

468 
	mNET_IPV4_CONF_SHARED_MEDIA
=7,

469 
	mNET_IPV4_CONF_RP_FILTER
=8,

470 
	mNET_IPV4_CONF_ACCEPT_SOURCE_ROUTE
=9,

471 
	mNET_IPV4_CONF_BOOTP_RELAY
=10,

472 
	mNET_IPV4_CONF_LOG_MARTIANS
=11,

473 
	mNET_IPV4_CONF_TAG
=12,

474 
	mNET_IPV4_CONF_ARPFILTER
=13,

475 
	mNET_IPV4_CONF_MEDIUM_ID
=14,

476 
	mNET_IPV4_CONF_NOXFRM
=15,

477 
	mNET_IPV4_CONF_NOPOLICY
=16,

478 
	mNET_IPV4_CONF_FORCE_IGMP_VERSION
=17,

479 
	mNET_IPV4_CONF_ARP_ANNOUNCE
=18,

480 
	mNET_IPV4_CONF_ARP_IGNORE
=19,

481 
	mNET_IPV4_CONF_PROMOTE_SECONDARIES
=20,

482 
	mNET_IPV4_CONF_ARP_ACCEPT
=21,

483 
	mNET_IPV4_CONF_ARP_NOTIFY
=22,

489 
	mNET_IPV4_NF_CONNTRACK_MAX
=1,

490 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_SYN_SENT
=2,

491 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_SYN_RECV
=3,

492 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_ESTABLISHED
=4,

493 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_FIN_WAIT
=5,

494 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_CLOSE_WAIT
=6,

495 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_LAST_ACK
=7,

496 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_TIME_WAIT
=8,

497 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_CLOSE
=9,

498 
	mNET_IPV4_NF_CONNTRACK_UDP_TIMEOUT
=10,

499 
	mNET_IPV4_NF_CONNTRACK_UDP_TIMEOUT_STREAM
=11,

500 
	mNET_IPV4_NF_CONNTRACK_ICMP_TIMEOUT
=12,

501 
	mNET_IPV4_NF_CONNTRACK_GENERIC_TIMEOUT
=13,

502 
	mNET_IPV4_NF_CONNTRACK_BUCKETS
=14,

503 
	mNET_IPV4_NF_CONNTRACK_LOG_INVALID
=15,

504 
	mNET_IPV4_NF_CONNTRACK_TCP_TIMEOUT_MAX_RETRANS
=16,

505 
	mNET_IPV4_NF_CONNTRACK_TCP_LOOSE
=17,

506 
	mNET_IPV4_NF_CONNTRACK_TCP_BE_LIBERAL
=18,

507 
	mNET_IPV4_NF_CONNTRACK_TCP_MAX_RETRANS
=19,

508 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_CLOSED
=20,

509 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_WAIT
=21,

510 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_COOKIE_ECHOED
=22,

511 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_ESTABLISHED
=23,

512 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_SENT
=24,

513 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_RECD
=25,

514 
	mNET_IPV4_NF_CONNTRACK_SCTP_TIMEOUT_SHUTDOWN_ACK_SENT
=26,

515 
	mNET_IPV4_NF_CONNTRACK_COUNT
=27,

516 
	mNET_IPV4_NF_CONNTRACK_CHECKSUM
=28,

521 
	mNET_IPV6_CONF
=16,

522 
	mNET_IPV6_NEIGH
=17,

523 
	mNET_IPV6_ROUTE
=18,

524 
	mNET_IPV6_ICMP
=19,

525 
	mNET_IPV6_BINDV6ONLY
=20,

526 
	mNET_IPV6_IP6FRAG_HIGH_THRESH
=21,

527 
	mNET_IPV6_IP6FRAG_LOW_THRESH
=22,

528 
	mNET_IPV6_IP6FRAG_TIME
=23,

529 
	mNET_IPV6_IP6FRAG_SECRET_INTERVAL
=24,

530 
	mNET_IPV6_MLD_MAX_MSF
=25,

534 
	mNET_IPV6_ROUTE_FLUSH
=1,

535 
	mNET_IPV6_ROUTE_GC_THRESH
=2,

536 
	mNET_IPV6_ROUTE_MAX_SIZE
=3,

537 
	mNET_IPV6_ROUTE_GC_MIN_INTERVAL
=4,

538 
	mNET_IPV6_ROUTE_GC_TIMEOUT
=5,

539 
	mNET_IPV6_ROUTE_GC_INTERVAL
=6,

540 
	mNET_IPV6_ROUTE_GC_ELASTICITY
=7,

541 
	mNET_IPV6_ROUTE_MTU_EXPIRES
=8,

542 
	mNET_IPV6_ROUTE_MIN_ADVMSS
=9,

543 
	mNET_IPV6_ROUTE_GC_MIN_INTERVAL_MS
=10

547 
	mNET_IPV6_FORWARDING
=1,

548 
	mNET_IPV6_HOP_LIMIT
=2,

549 
	mNET_IPV6_MTU
=3,

550 
	mNET_IPV6_ACCEPT_RA
=4,

551 
	mNET_IPV6_ACCEPT_REDIRECTS
=5,

552 
	mNET_IPV6_AUTOCONF
=6,

553 
	mNET_IPV6_DAD_TRANSMITS
=7,

554 
	mNET_IPV6_RTR_SOLICITS
=8,

555 
	mNET_IPV6_RTR_SOLICIT_INTERVAL
=9,

556 
	mNET_IPV6_RTR_SOLICIT_DELAY
=10,

557 
	mNET_IPV6_USE_TEMPADDR
=11,

558 
	mNET_IPV6_TEMP_VALID_LFT
=12,

559 
	mNET_IPV6_TEMP_PREFERED_LFT
=13,

560 
	mNET_IPV6_REGEN_MAX_RETRY
=14,

561 
	mNET_IPV6_MAX_DESYNC_FACTOR
=15,

562 
	mNET_IPV6_MAX_ADDRESSES
=16,

563 
	mNET_IPV6_FORCE_MLD_VERSION
=17,

564 
	mNET_IPV6_ACCEPT_RA_DEFRTR
=18,

565 
	mNET_IPV6_ACCEPT_RA_PINFO
=19,

566 
	mNET_IPV6_ACCEPT_RA_RTR_PREF
=20,

567 
	mNET_IPV6_RTR_PROBE_INTERVAL
=21,

568 
	mNET_IPV6_ACCEPT_RA_RT_INFO_MAX_PLEN
=22,

569 
	mNET_IPV6_PROXY_NDP
=23,

570 
	mNET_IPV6_ACCEPT_SOURCE_ROUTE
=25,

571 
	mNET_IPV6_ACCEPT_RA_FROM_LOCAL
=26,

572 
	mNET_IPV6_ACCEPT_RA_RT_INFO_MIN_PLEN
=27,

573 
	m__NET_IPV6_MAX


578 
	mNET_IPV6_ICMP_RATELIMIT
=1

583 
	mNET_NEIGH_MCAST_SOLICIT
=1,

584 
	mNET_NEIGH_UCAST_SOLICIT
=2,

585 
	mNET_NEIGH_APP_SOLICIT
=3,

586 
	mNET_NEIGH_RETRANS_TIME
=4,

587 
	mNET_NEIGH_REACHABLE_TIME
=5,

588 
	mNET_NEIGH_DELAY_PROBE_TIME
=6,

589 
	mNET_NEIGH_GC_STALE_TIME
=7,

590 
	mNET_NEIGH_UNRES_QLEN
=8,

591 
	mNET_NEIGH_PROXY_QLEN
=9,

592 
	mNET_NEIGH_ANYCAST_DELAY
=10,

593 
	mNET_NEIGH_PROXY_DELAY
=11,

594 
	mNET_NEIGH_LOCKTIME
=12,

595 
	mNET_NEIGH_GC_INTERVAL
=13,

596 
	mNET_NEIGH_GC_THRESH1
=14,

597 
	mNET_NEIGH_GC_THRESH2
=15,

598 
	mNET_NEIGH_GC_THRESH3
=16,

599 
	mNET_NEIGH_RETRANS_TIME_MS
=17,

600 
	mNET_NEIGH_REACHABLE_TIME_MS
=18,

605 
	mNET_DCCP_DEFAULT
=1,

610 
	mNET_IPX_PPROP_BROADCASTING
=1,

611 
	mNET_IPX_FORWARDING
=2

616 
	mNET_LLC2
=1,

617 
	mNET_LLC_STATION
=2,

622 
	mNET_LLC2_TIMEOUT
=1,

627 
	mNET_LLC_STATION_ACK_TIMEOUT
=1,

632 
	mNET_LLC2_ACK_TIMEOUT
=1,

633 
	mNET_LLC2_P_TIMEOUT
=2,

634 
	mNET_LLC2_REJ_TIMEOUT
=3,

635 
	mNET_LLC2_BUSY_TIMEOUT
=4,

640 
	mNET_ATALK_AARP_EXPIRY_TIME
=1,

641 
	mNET_ATALK_AARP_TICK_TIME
=2,

642 
	mNET_ATALK_AARP_RETRANSMIT_LIMIT
=3,

643 
	mNET_ATALK_AARP_RESOLVE_TIME
=4

649 
	mNET_NETROM_DEFAULT_PATH_QUALITY
=1,

650 
	mNET_NETROM_OBSOLESCENCE_COUNT_INITIALISER
=2,

651 
	mNET_NETROM_NETWORK_TTL_INITIALISER
=3,

652 
	mNET_NETROM_TRANSPORT_TIMEOUT
=4,

653 
	mNET_NETROM_TRANSPORT_MAXIMUM_TRIES
=5,

654 
	mNET_NETROM_TRANSPORT_ACKNOWLEDGE_DELAY
=6,

655 
	mNET_NETROM_TRANSPORT_BUSY_DELAY
=7,

656 
	mNET_NETROM_TRANSPORT_REQUESTED_WINDOW_SIZE
=8,

657 
	mNET_NETROM_TRANSPORT_NO_ACTIVITY_TIMEOUT
=9,

658 
	mNET_NETROM_ROUTING_CONTROL
=10,

659 
	mNET_NETROM_LINK_FAILS_COUNT
=11,

660 
	mNET_NETROM_RESET
=12

665 
	mNET_AX25_IP_DEFAULT_MODE
=1,

666 
	mNET_AX25_DEFAULT_MODE
=2,

667 
	mNET_AX25_BACKOFF_TYPE
=3,

668 
	mNET_AX25_CONNECT_MODE
=4,

669 
	mNET_AX25_STANDARD_WINDOW
=5,

670 
	mNET_AX25_EXTENDED_WINDOW
=6,

671 
	mNET_AX25_T1_TIMEOUT
=7,

672 
	mNET_AX25_T2_TIMEOUT
=8,

673 
	mNET_AX25_T3_TIMEOUT
=9,

674 
	mNET_AX25_IDLE_TIMEOUT
=10,

675 
	mNET_AX25_N2
=11,

676 
	mNET_AX25_PACLEN
=12,

677 
	mNET_AX25_PROTOCOL
=13,

678 
	mNET_AX25_DAMA_SLAVE_TIMEOUT
=14

683 
	mNET_ROSE_RESTART_REQUEST_TIMEOUT
=1,

684 
	mNET_ROSE_CALL_REQUEST_TIMEOUT
=2,

685 
	mNET_ROSE_RESET_REQUEST_TIMEOUT
=3,

686 
	mNET_ROSE_CLEAR_REQUEST_TIMEOUT
=4,

687 
	mNET_ROSE_ACK_HOLD_BACK_TIMEOUT
=5,

688 
	mNET_ROSE_ROUTING_CONTROL
=6,

689 
	mNET_ROSE_LINK_FAIL_TIMEOUT
=7,

690 
	mNET_ROSE_MAX_VCS
=8,

691 
	mNET_ROSE_WINDOW_SIZE
=9,

692 
	mNET_ROSE_NO_ACTIVITY_TIMEOUT
=10

697 
	mNET_X25_RESTART_REQUEST_TIMEOUT
=1,

698 
	mNET_X25_CALL_REQUEST_TIMEOUT
=2,

699 
	mNET_X25_RESET_REQUEST_TIMEOUT
=3,

700 
	mNET_X25_CLEAR_REQUEST_TIMEOUT
=4,

701 
	mNET_X25_ACK_HOLD_BACK_TIMEOUT
=5,

702 
	mNET_X25_FORWARD
=6

708 
	mNET_TR_RIF_TIMEOUT
=1

713 
	mNET_DECNET_NODE_TYPE
 = 1,

714 
	mNET_DECNET_NODE_ADDRESS
 = 2,

715 
	mNET_DECNET_NODE_NAME
 = 3,

716 
	mNET_DECNET_DEFAULT_DEVICE
 = 4,

717 
	mNET_DECNET_TIME_WAIT
 = 5,

718 
	mNET_DECNET_DN_COUNT
 = 6,

719 
	mNET_DECNET_DI_COUNT
 = 7,

720 
	mNET_DECNET_DR_COUNT
 = 8,

721 
	mNET_DECNET_DST_GC_INTERVAL
 = 9,

722 
	mNET_DECNET_CONF
 = 10,

723 
	mNET_DECNET_NO_FC_MAX_CWND
 = 11,

724 
	mNET_DECNET_MEM
 = 12,

725 
	mNET_DECNET_RMEM
 = 13,

726 
	mNET_DECNET_WMEM
 = 14,

727 
	mNET_DECNET_DEBUG_LEVEL
 = 255

732 
	mNET_DECNET_CONF_LOOPBACK
 = -2,

733 
	mNET_DECNET_CONF_DDCMP
 = -3,

734 
	mNET_DECNET_CONF_PPP
 = -4,

735 
	mNET_DECNET_CONF_X25
 = -5,

736 
	mNET_DECNET_CONF_GRE
 = -6,

737 
	mNET_DECNET_CONF_ETHER
 = -7

744 
	mNET_DECNET_CONF_DEV_PRIORITY
 = 1,

745 
	mNET_DECNET_CONF_DEV_T1
 = 2,

746 
	mNET_DECNET_CONF_DEV_T2
 = 3,

747 
	mNET_DECNET_CONF_DEV_T3
 = 4,

748 
	mNET_DECNET_CONF_DEV_FORWARDING
 = 5,

749 
	mNET_DECNET_CONF_DEV_BLKSIZE
 = 6,

750 
	mNET_DECNET_CONF_DEV_STATE
 = 7

755 
	mNET_SCTP_RTO_INITIAL
 = 1,

756 
	mNET_SCTP_RTO_MIN
 = 2,

757 
	mNET_SCTP_RTO_MAX
 = 3,

758 
	mNET_SCTP_RTO_ALPHA
 = 4,

759 
	mNET_SCTP_RTO_BETA
 = 5,

760 
	mNET_SCTP_VALID_COOKIE_LIFE
 = 6,

761 
	mNET_SCTP_ASSOCIATION_MAX_RETRANS
 = 7,

762 
	mNET_SCTP_PATH_MAX_RETRANS
 = 8,

763 
	mNET_SCTP_MAX_INIT_RETRANSMITS
 = 9,

764 
	mNET_SCTP_HB_INTERVAL
 = 10,

765 
	mNET_SCTP_PRESERVE_ENABLE
 = 11,

766 
	mNET_SCTP_MAX_BURST
 = 12,

767 
	mNET_SCTP_ADDIP_ENABLE
 = 13,

768 
	mNET_SCTP_PRSCTP_ENABLE
 = 14,

769 
	mNET_SCTP_SNDBUF_POLICY
 = 15,

770 
	mNET_SCTP_SACK_TIMEOUT
 = 16,

771 
	mNET_SCTP_RCVBUF_POLICY
 = 17,

776 
	mNET_BRIDGE_NF_CALL_ARPTABLES
 = 1,

777 
	mNET_BRIDGE_NF_CALL_IPTABLES
 = 2,

778 
	mNET_BRIDGE_NF_CALL_IP6TABLES
 = 3,

779 
	mNET_BRIDGE_NF_FILTER_VLAN_TAGGED
 = 4,

780 
	mNET_BRIDGE_NF_FILTER_PPPOE_TAGGED
 = 5,

785 
	mNET_IRDA_DISCOVERY
=1,

786 
	mNET_IRDA_DEVNAME
=2,

787 
	mNET_IRDA_DEBUG
=3,

788 
	mNET_IRDA_FAST_POLL
=4,

789 
	mNET_IRDA_DISCOVERY_SLOTS
=5,

790 
	mNET_IRDA_DISCOVERY_TIMEOUT
=6,

791 
	mNET_IRDA_SLOT_TIMEOUT
=7,

792 
	mNET_IRDA_MAX_BAUD_RATE
=8,

793 
	mNET_IRDA_MIN_TX_TURN_TIME
=9,

794 
	mNET_IRDA_MAX_TX_DATA_SIZE
=10,

795 
	mNET_IRDA_MAX_TX_WINDOW
=11,

796 
	mNET_IRDA_MAX_NOREPLY_TIME
=12,

797 
	mNET_IRDA_WARN_NOREPLY_TIME
=13,

798 
	mNET_IRDA_LAP_KEEPALIVE_TIME
=14,

805 
	mFS_NRINODE
=1,

806 
	mFS_STATINODE
=2,

807 
	mFS_MAXINODE
=3,

808 
	mFS_NRDQUOT
=4,

809 
	mFS_MAXDQUOT
=5,

810 
	mFS_NRFILE
=6,

811 
	mFS_MAXFILE
=7,

812 
	mFS_DENTRY
=8,

813 
	mFS_NRSUPER
=9,

814 
	mFS_MAXSUPER
=10,

815 
	mFS_OVERFLOWUID
=11,

816 
	mFS_OVERFLOWGID
=12,

817 
	mFS_LEASES
=13,

818 
	mFS_DIR_NOTIFY
=14,

819 
	mFS_LEASE_TIME
=15,

820 
	mFS_DQSTATS
=16,

821 
	mFS_XFS
=17,

822 
	mFS_AIO_NR
=18,

823 
	mFS_AIO_MAX_NR
=19,

824 
	mFS_INOTIFY
=20,

825 
	mFS_OCFS2
=988,

830 
	mFS_DQ_LOOKUPS
 = 1,

831 
	mFS_DQ_DROPS
 = 2,

832 
	mFS_DQ_READS
 = 3,

833 
	mFS_DQ_WRITES
 = 4,

834 
	mFS_DQ_CACHE_HITS
 = 5,

835 
	mFS_DQ_ALLOCATED
 = 6,

836 
	mFS_DQ_FREE
 = 7,

837 
	mFS_DQ_SYNCS
 = 8,

838 
	mFS_DQ_WARNINGS
 = 9,

845 
	mDEV_CDROM
=1,

846 
	mDEV_HWMON
=2,

847 
	mDEV_PARPORT
=3,

848 
	mDEV_RAID
=4,

849 
	mDEV_MAC_HID
=5,

850 
	mDEV_SCSI
=6,

851 
	mDEV_IPMI
=7,

856 
	mDEV_CDROM_INFO
=1,

857 
	mDEV_CDROM_AUTOCLOSE
=2,

858 
	mDEV_CDROM_AUTOEJECT
=3,

859 
	mDEV_CDROM_DEBUG
=4,

860 
	mDEV_CDROM_LOCK
=5,

861 
	mDEV_CDROM_CHECK_MEDIA
=6

866 
	mDEV_PARPORT_DEFAULT
=-3

871 
	mDEV_RAID_SPEED_LIMIT_MIN
=1,

872 
	mDEV_RAID_SPEED_LIMIT_MAX
=2

877 
	mDEV_PARPORT_DEFAULT_TIMESLICE
=1,

878 
	mDEV_PARPORT_DEFAULT_SPINTIME
=2

883 
	mDEV_PARPORT_SPINTIME
=1,

884 
	mDEV_PARPORT_BASE_ADDR
=2,

885 
	mDEV_PARPORT_IRQ
=3,

886 
	mDEV_PARPORT_DMA
=4,

887 
	mDEV_PARPORT_MODES
=5,

888 
	mDEV_PARPORT_DEVICES
=6,

889 
	mDEV_PARPORT_AUTOPROBE
=16

894 
	mDEV_PARPORT_DEVICES_ACTIVE
=-3,

899 
	mDEV_PARPORT_DEVICE_TIMESLICE
=1,

904 
	mDEV_MAC_HID_KEYBOARD_SENDS_LINUX_KEYCODES
=1,

905 
	mDEV_MAC_HID_KEYBOARD_LOCK_KEYCODES
=2,

906 
	mDEV_MAC_HID_MOUSE_BUTTON_EMULATION
=3,

907 
	mDEV_MAC_HID_MOUSE_BUTTON2_KEYCODE
=4,

908 
	mDEV_MAC_HID_MOUSE_BUTTON3_KEYCODE
=5,

909 
	mDEV_MAC_HID_ADB_MOUSE_SENDS_KEYCODES
=6

914 
	mDEV_SCSI_LOGGING_LEVEL
=1,

919 
	mDEV_IPMI_POWEROFF_POWERCYCLE
=1,

925 
	mABI_DEFHANDLER_COFF
=1,

926 
	mABI_DEFHANDLER_ELF
=2,

927 
	mABI_DEFHANDLER_LCALL7
=3,

928 
	mABI_DEFHANDLER_LIBCSO
=4,

929 
	mABI_TRACE
=5,

930 
	mABI_FAKE_UTSNAME
=6,

	@/usr/include/linux/time.h

2 #i‚de‡
_LINUX_TIME_H


3 
	#_LINUX_TIME_H


	)

5 
	~<löux/ty≥s.h
>

8 #i‚de‡
_STRUCT_TIMESPEC


9 
	#_STRUCT_TIMESPEC


	)

10 
	stime•ec
 {

11 
__kî√l_time_t
 
	mtv_£c
;

12 
	mtv_n£c
;

16 
	stimevÆ
 {

17 
__kî√l_time_t
 
	mtv_£c
;

18 
__kî√l_su£c⁄ds_t
 
	mtv_u£c
;

21 
	stimez⁄e
 {

22 
	mtz_möuãswe°
;

23 
	mtz_d°time
;

31 
	#ITIMER_REAL
 0

	)

32 
	#ITIMER_VIRTUAL
 1

	)

33 
	#ITIMER_PROF
 2

	)

35 
	sôimî•ec
 {

36 
time•ec
 
	mô_öãrvÆ
;

37 
time•ec
 
	mô_vÆue
;

40 
	sôimîvÆ
 {

41 
timevÆ
 
	mô_öãrvÆ
;

42 
timevÆ
 
	mô_vÆue
;

48 
	#CLOCK_REALTIME
 0

	)

49 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

51 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

52 
	#CLOCK_MONOTONIC_RAW
 4

	)

53 
	#CLOCK_REALTIME_COARSE
 5

	)

54 
	#CLOCK_MONOTONIC_COARSE
 6

	)

55 
	#CLOCK_BOOTTIME
 7

	)

56 
	#CLOCK_REALTIME_ALARM
 8

	)

57 
	#CLOCK_BOOTTIME_ALARM
 9

	)

62 
	#CLOCK_SGI_CYCLE
 10

	)

63 
	#CLOCK_TAI
 11

	)

65 
	#MAX_CLOCKS
 16

	)

66 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

67 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

72 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

2 #i‚de‡
_LINUX_TYPES_H


3 
	#_LINUX_TYPES_H


	)

5 
	~<asm/ty≥s.h
>

7 #i‚de‡
__ASSEMBLY__


9 
	~<löux/posix_ty≥s.h
>

17 #ifde‡
__CHECKER__


18 
	#__bôwi£__
 
	`__©åibuã__
((
bôwi£
))

	)

20 
	#__bôwi£__


	)

22 
	#__bôwi£
 
__bôwi£__


	)

24 
__u16
 
	t__bôwi£
 
	t__À16
;

25 
__u16
 
	t__bôwi£
 
	t__be16
;

26 
__u32
 
	t__bôwi£
 
	t__À32
;

27 
__u32
 
	t__bôwi£
 
	t__be32
;

28 
__u64
 
	t__bôwi£
 
	t__À64
;

29 
__u64
 
	t__bôwi£
 
	t__be64
;

31 
__u16
 
	t__bôwi£
 
	t__sum16
;

32 
__u32
 
	t__bôwi£
 
	t__wsum
;

43 
	#__Æig√d_u64
 
__u64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

44 
	#__Æig√d_be64
 
__be64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

45 
	#__Æig√d_À64
 
__À64
 
	`__©åibuã__
((
	`Æig√d
(8)))

	)

	@/usr/include/linux/uio.h

10 #i‚de‡
__LINUX_UIO_H


11 
	#__LINUX_UIO_H


	)

14 
	~<löux/ty≥s.h
>

17 
	siovec


19 *
	miov_ba£
;

20 
__kî√l_size_t
 
	miov_Àn
;

27 
	#UIO_FASTIOV
 8

	)

28 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/utsname.h

2 #i‚de‡
_LINUX_UTSNAME_H


3 
	#_LINUX_UTSNAME_H


	)

5 
	#__OLD_UTS_LEN
 8

	)

7 
	sﬁdﬁd_ut¢ame
 {

8 
	msy¢ame
[9];

9 
	mnodíame
[9];

10 
	mªÀa£
[9];

11 
	mvîsi⁄
[9];

12 
	mmachöe
[9];

15 
	#__NEW_UTS_LEN
 64

	)

17 
	sﬁd_ut¢ame
 {

18 
	msy¢ame
[65];

19 
	mnodíame
[65];

20 
	mªÀa£
[65];

21 
	mvîsi⁄
[65];

22 
	mmachöe
[65];

25 
	s√w_ut¢ame
 {

26 
	msy¢ame
[
__NEW_UTS_LEN
 + 1];

27 
	mnodíame
[
__NEW_UTS_LEN
 + 1];

28 
	mªÀa£
[
__NEW_UTS_LEN
 + 1];

29 
	mvîsi⁄
[
__NEW_UTS_LEN
 + 1];

30 
	mmachöe
[
__NEW_UTS_LEN
 + 1];

31 
	mdomaö«me
[
__NEW_UTS_LEN
 + 1];

	@/usr/include/linux/uuid.h

18 #i‚de‡
_LINUX_UUID_H_


19 
	#_LINUX_UUID_H_


	)

21 
	~<löux/ty≥s.h
>

22 
	~<löux/°rög.h
>

25 
__u8
 
	mb
[16];

26 } 
	tguid_t
;

28 
	#GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

29 ((
guid_t
) \

30 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

31 (
b
) & 0xff, ((b) >> 8) & 0xff, \

32 (
c
) & 0xff, ((c) >> 8) & 0xff, \

33 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
Ë}})

	)

36 
guid_t
 
	tuuid_À
;

37 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

38 
	`GUID_INIT
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
)

	)

39 
	#NULL_UUID_LE
 \

40 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

41 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 266002

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
Ë((◊Ë<< 16Ë+ ((bË<< 8Ë+ (c))

	)

	@/usr/include/linux/wait.h

2 #i‚de‡
_LINUX_WAIT_H


3 
	#_LINUX_WAIT_H


	)

5 
	#WNOHANG
 0x00000001

	)

6 
	#WUNTRACED
 0x00000002

	)

7 
	#WSTOPPED
 
WUNTRACED


	)

8 
	#WEXITED
 0x00000004

	)

9 
	#WCONTINUED
 0x00000008

	)

10 
	#WNOWAIT
 0x01000000

	)

12 
	#__WNOTHREAD
 0x20000000

	)

13 
	#__WALL
 0x40000000

	)

14 
	#__WCLONE
 0x80000000

	)

17 
	#P_ALL
 0

	)

18 
	#P_PID
 1

	)

19 
	#P_PGID
 2

	)

	@/usr/include/linux/xattr.h

12 
	~<löux/libc-com∑t.h
>

14 #i‚de‡
_LINUX_XATTR_H


15 
	#_LINUX_XATTR_H


	)

17 #i‡
__UAPI_DEF_XATTR


18 
	#__USE_KERNEL_XATTR_DEFS


	)

20 
	#XATTR_CREATE
 0x1

	)

21 
	#XATTR_REPLACE
 0x2

	)

25 
	#XATTR_OS2_PREFIX
 "os2."

	)

26 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
Ë- 1)

	)

28 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

29 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
Ë- 1)

	)

31 
	#XATTR_BTRFS_PREFIX
 "båfs."

	)

32 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
Ë- 1)

	)

34 
	#XATTR_SECURITY_PREFIX
 "£curôy."

	)

35 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
Ë- 1)

	)

37 
	#XATTR_SYSTEM_PREFIX
 "sy°em."

	)

38 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
Ë- 1)

	)

40 
	#XATTR_TRUSTED_PREFIX
 "åu°ed."

	)

41 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
Ë- 1)

	)

43 
	#XATTR_USER_PREFIX
 "u£r."

	)

44 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
Ë- 1)

	)

47 
	#XATTR_EVM_SUFFIX
 "evm"

	)

48 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

50 
	#XATTR_IMA_SUFFIX
 "ima"

	)

51 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

53 
	#XATTR_SELINUX_SUFFIX
 "£löux"

	)

54 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

56 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

57 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

58 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

59 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

60 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

61 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

62 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

63 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

64 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

65 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

66 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

67 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

69 
	#XATTR_APPARMOR_SUFFIX
 "≠∑rm‹"

	)

70 
	#XATTR_NAME_APPARMOR
 
XATTR_SECURITY_PREFIX
 
XATTR_APPARMOR_SUFFIX


	)

72 
	#XATTR_CAPS_SUFFIX
 "ˇ∑bûôy"

	)

73 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

75 
	#XATTR_POSIX_ACL_ACCESS
 "posix_a˛_ac˚ss"

	)

76 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

77 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_a˛_deÁu…"

	)

78 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/asm-generic/hugetlb_encode.h

1 #i‚de‡
_ASM_GENERIC_HUGETLB_ENCODE_H_


2 
	#_ASM_GENERIC_HUGETLB_ENCODE_H_


	)

20 
	#HUGETLB_FLAG_ENCODE_SHIFT
 26

	)

21 
	#HUGETLB_FLAG_ENCODE_MASK
 0x3f

	)

23 
	#HUGETLB_FLAG_ENCODE_64KB
 (16 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

24 
	#HUGETLB_FLAG_ENCODE_512KB
 (19 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

25 
	#HUGETLB_FLAG_ENCODE_1MB
 (20 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

26 
	#HUGETLB_FLAG_ENCODE_2MB
 (21 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

27 
	#HUGETLB_FLAG_ENCODE_8MB
 (23 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

28 
	#HUGETLB_FLAG_ENCODE_16MB
 (24 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

29 
	#HUGETLB_FLAG_ENCODE_256MB
 (28 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

30 
	#HUGETLB_FLAG_ENCODE_1GB
 (30 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

31 
	#HUGETLB_FLAG_ENCODE_2GB
 (31 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

32 
	#HUGETLB_FLAG_ENCODE_16GB
 (34 << 
HUGETLB_FLAG_ENCODE_SHIFT
)

	)

	@/usr/include/linux/ioctl.h

2 #i‚de‡
_LINUX_IOCTL_H


3 
	#_LINUX_IOCTL_H


	)

5 
	~<asm/io˘l.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

49 #i‚de‡
_LIBC_COMPAT_H


50 
	#_LIBC_COMPAT_H


	)

53 #i‡
deföed
(
__GLIBC__
)

56 #i‡
deföed
(
_NET_IF_H
Ë&& deföed(
__USE_MISC
)

61 
	#__UAPI_DEF_IF_IFCONF
 0

	)

62 
	#__UAPI_DEF_IF_IFMAP
 0

	)

63 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

64 
	#__UAPI_DEF_IF_IFREQ
 0

	)

66 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

68 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


69 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

78 
	#__UAPI_DEF_IF_IFCONF
 1

	)

79 
	#__UAPI_DEF_IF_IFMAP
 1

	)

80 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

81 
	#__UAPI_DEF_IF_IFREQ
 1

	)

83 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

85 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

90 #i‡
deföed
(
_NETINET_IN_H
)

94 
	#__UAPI_DEF_IN_ADDR
 0

	)

95 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

96 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

97 
	#__UAPI_DEF_IP_MREQ
 0

	)

98 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

99 
	#__UAPI_DEF_IN_CLASS
 0

	)

101 
	#__UAPI_DEF_IN6_ADDR
 0

	)

106 #i‡
deföed
(
__USE_MISC
Ë|| deföed (
__USE_GNU
)

107 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

109 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

111 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

112 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

113 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

114 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

115 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

116 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

123 
	#__UAPI_DEF_IN_ADDR
 1

	)

124 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

125 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

126 
	#__UAPI_DEF_IP_MREQ
 1

	)

127 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

128 
	#__UAPI_DEF_IN_CLASS
 1

	)

130 
	#__UAPI_DEF_IN6_ADDR
 1

	)

133 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

134 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

135 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

136 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

137 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

138 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

139 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

144 #i‡
deföed
(
__NETIPX_IPX_H
)

146 
	#__UAPI_DEF_SOCKADDR_IPX
 0

	)

147 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 0

	)

148 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 0

	)

149 
	#__UAPI_DEF_IPX_CONFIG_DATA
 0

	)

150 
	#__UAPI_DEF_IPX_ROUTE_DEF
 0

	)

154 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

155 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

156 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

157 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

158 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

163 #i‡
deföed
(
_SYS_XATTR_H
)

164 
	#__UAPI_DEF_XATTR
 0

	)

166 
	#__UAPI_DEF_XATTR
 1

	)

176 #i‚de‡
__UAPI_DEF_IF_IFCONF


177 
	#__UAPI_DEF_IF_IFCONF
 1

	)

179 #i‚de‡
__UAPI_DEF_IF_IFMAP


180 
	#__UAPI_DEF_IF_IFMAP
 1

	)

182 #i‚de‡
__UAPI_DEF_IF_IFNAMSIZ


183 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

185 #i‚de‡
__UAPI_DEF_IF_IFREQ


186 
	#__UAPI_DEF_IF_IFREQ
 1

	)

189 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS


190 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

193 #i‚de‡
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


194 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

198 #i‚de‡
__UAPI_DEF_IN_ADDR


199 
	#__UAPI_DEF_IN_ADDR
 1

	)

201 #i‚de‡
__UAPI_DEF_IN_IPPROTO


202 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

204 #i‚de‡
__UAPI_DEF_IN_PKTINFO


205 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

207 #i‚de‡
__UAPI_DEF_IP_MREQ


208 
	#__UAPI_DEF_IP_MREQ
 1

	)

210 #i‚de‡
__UAPI_DEF_SOCKADDR_IN


211 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

213 #i‚de‡
__UAPI_DEF_IN_CLASS


214 
	#__UAPI_DEF_IN_CLASS
 1

	)

218 #i‚de‡
__UAPI_DEF_IN6_ADDR


219 
	#__UAPI_DEF_IN6_ADDR
 1

	)

221 #i‚de‡
__UAPI_DEF_IN6_ADDR_ALT


222 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

224 #i‚de‡
__UAPI_DEF_SOCKADDR_IN6


225 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

227 #i‚de‡
__UAPI_DEF_IPV6_MREQ


228 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

230 #i‚de‡
__UAPI_DEF_IPPROTO_V6


231 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

233 #i‚de‡
__UAPI_DEF_IPV6_OPTIONS


234 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

236 #i‚de‡
__UAPI_DEF_IN6_PKTINFO


237 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

239 #i‚de‡
__UAPI_DEF_IP6_MTUINFO


240 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

244 #i‚de‡
__UAPI_DEF_SOCKADDR_IPX


245 
	#__UAPI_DEF_SOCKADDR_IPX
 1

	)

247 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEFINITION


248 
	#__UAPI_DEF_IPX_ROUTE_DEFINITION
 1

	)

250 #i‚de‡
__UAPI_DEF_IPX_INTERFACE_DEFINITION


251 
	#__UAPI_DEF_IPX_INTERFACE_DEFINITION
 1

	)

253 #i‚de‡
__UAPI_DEF_IPX_CONFIG_DATA


254 
	#__UAPI_DEF_IPX_CONFIG_DATA
 1

	)

256 #i‚de‡
__UAPI_DEF_IPX_ROUTE_DEF


257 
	#__UAPI_DEF_IPX_ROUTE_DEF
 1

	)

261 #i‚de‡
__UAPI_DEF_XATTR


262 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

2 #i‚de‡
_LINUX_LIMITS_H


3 
	#_LINUX_LIMITS_H


	)

5 
	#NR_OPEN
 1024

	)

7 
	#NGROUPS_MAX
 65536

	)

8 
	#ARG_MAX
 131072

	)

9 
	#LINK_MAX
 127

	)

10 
	#MAX_CANON
 255

	)

11 
	#MAX_INPUT
 255

	)

12 
	#NAME_MAX
 255

	)

13 
	#PATH_MAX
 4096

	)

14 
	#PIPE_BUF
 4096

	)

15 
	#XATTR_NAME_MAX
 255

	)

16 
	#XATTR_SIZE_MAX
 65536

	)

17 
	#XATTR_LIST_MAX
 65536

	)

19 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

2 #i‚de‡
_LINUX_POSIX_TYPES_H


3 
	#_LINUX_POSIX_TYPES_H


	)

5 
	~<löux/°ddef.h
>

22 #unde‡
__FD_SETSIZE


23 
	#__FD_SETSIZE
 1024

	)

26 
	mfds_bôs
[
__FD_SETSIZE
 / (8 * ())];

27 } 
	t__kî√l_fd_£t
;

30 (*
	t__kî√l_sigh™dÀr_t
)();

33 
	t__kî√l_key_t
;

34 
	t__kî√l_mqd_t
;

36 
	~<asm/posix_ty≥s.h
>

	@/usr/include/linux/sysinfo.h

2 #i‚de‡
_LINUX_SYSINFO_H


3 
	#_LINUX_SYSINFO_H


	)

5 
	~<löux/ty≥s.h
>

7 
	#SI_LOAD_SHIFT
 16

	)

8 
	ssysöfo
 {

9 
__kî√l_l⁄g_t
 
	mu±ime
;

10 
__kî√l_ul⁄g_t
 
	mlﬂds
[3];

11 
__kî√l_ul⁄g_t
 
	mtŸÆøm
;

12 
__kî√l_ul⁄g_t
 
	m‰ìøm
;

13 
__kî√l_ul⁄g_t
 
	msh¨edøm
;

14 
__kî√l_ul⁄g_t
 
	mbuf„ºam
;

15 
__kî√l_ul⁄g_t
 
	mtŸÆsw≠
;

16 
__kî√l_ul⁄g_t
 
	m‰ìsw≠
;

17 
__u16
 
	m¥ocs
;

18 
__u16
 
	m∑d
;

19 
__kî√l_ul⁄g_t
 
	mtŸÆhigh
;

20 
__kî√l_ul⁄g_t
 
	m‰ìhigh
;

21 
__u32
 
	mmem_unô
;

22 
	m_f
[20-2*(
__kî√l_ul⁄g_t
)-(
__u32
)];

	@/usr/include/string.h

22 #i‚def 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<bôs/libc-hódî-°¨t.h
>

28 
	g__BEGIN_DECLS


31 
	#__√ed_size_t


	)

32 
	#__√ed_NULL


	)

33 
	~<°ddef.h
>

36 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$mem˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

43 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

46 *
	$memmove
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
)

47 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

52 #i‡
deföed
 
__USE_MISC
 || deföed 
__USE_XOPEN


53 *
	$memc˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

63 
	$memcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

67 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

72 c⁄° *
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

75 #ifde‡
__OPTIMIZE__


76 
__exã∫_Æways_ölöe
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


79  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

82 
__exã∫_Æways_ölöe
 const *

83 
	`memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
Ë
__THROW


85  
	`__buûtö_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

94 #ifde‡
__USE_GNU


97 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$øwmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

100 "C++" c⁄° *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("øwmemchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

103 *
	$øwmemchr
 (c⁄° *
__s
, 
__c
)

104 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

108 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

111 "C++" c⁄° *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

114 *
	$memrchr
 (c⁄° *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

121 *
	$°r˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

122 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

124 *
	$°∫˝y
 (*
__ª°ri˘
 
__de°
,

125 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

126 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

129 *
	$°rˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

130 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

132 *
	$°∫ˇt
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
,

133 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

136 
	$°rcmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

137 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

139 
	$°∫cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

143 
	$°rcﬁl
 (c⁄° *
__s1
, c⁄° *
__s2
)

144 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

146 
size_t
 
	$°rx‰m
 (*
__ª°ri˘
 
__de°
,

147 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

148 
__THROW
 
	`__n⁄nuŒ
 ((2));

150 #ifde‡
__USE_XOPEN2K8


152 
	~<bôs/ty≥s/loˇÀ_t.h
>

155 
	$°rcﬁl_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__l
)

156 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

159 
size_t
 
	$°rx‰m_l
 (*
__de°
, c⁄° *
__§c
, 
size_t
 
__n
,

160 
loˇÀ_t
 
__l
Ë
__THROW
 
	`__n⁄nuŒ
 ((2, 4));

163 #i‡(
deföed
 
__USE_XOPEN_EXTENDED
 || deföed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$°rdup
 (c⁄° *
__s
)

167 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

173 #i‡
deföed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$°∫dup
 (c⁄° *
__°rög
, 
size_t
 
__n
)

175 
__THROW
 
__©åibuã_mÆloc__
 
	`__n⁄nuŒ
 ((1));

178 #i‡
deföed
 
__USE_GNU
 && deföed 
__GNUC__


180 
	#°rdu∑
(
s
) \

181 (
__exãnsi⁄__
 \

183 c⁄° *
__ﬁd
 = (
s
); \

184 
size_t
 
__Àn
 = 
	`°æí
 (
__ﬁd
) + 1; \

185 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
); \

186 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

187 
	}
}))

	)

190 
	#°∫du∑
(
s
, 
n
) \

191 (
__exãnsi⁄__
 \

193 c⁄° *
__ﬁd
 = (
s
); \

194 
size_t
 
__Àn
 = 
	`°∫Àn
 (
__ﬁd
, (
n
)); \

195 *
__√w
 = (*Ë
	`__buûtö_Æloˇ
 (
__Àn
 + 1); \

196 
__√w
[
__Àn
] = '\0'; \

197 (*Ë
	`mem˝y
 (
__√w
, 
__ﬁd
, 
__Àn
); \

198 }))

	)

202 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
°rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

207 c⁄° *
°rchr
 (c⁄° *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("°rchr"Ë
__©åibuã_puª__
 
__n⁄nuŒ
 ((1));

210 #ifde‡
__OPTIMIZE__


211 
__exã∫_Æways_ölöe
 *

212 
°rchr
 (*
__s
, 
__c
Ë
	g__THROW


214  
__buûtö_°rchr
 (
__s
, 
__c
);

217 
__exã∫_Æways_ölöe
 const *

218 
°rchr
 (c⁄° *
__s
, 
__c
Ë
	g__THROW


220  
__buûtö_°rchr
 (
__s
, 
__c
);

225 *
	$°rchr
 (c⁄° *
__s
, 
__c
)

226 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

229 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`°ºchr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

234 c⁄° *
	`°ºchr
 (c⁄° *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("°ºchr"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

237 #ifde‡
__OPTIMIZE__


238 
__exã∫_Æways_ölöe
 *

239 
	`°ºchr
 (*
__s
, 
__c
Ë
__THROW


241  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

244 
__exã∫_Æways_ölöe
 const *

245 
	`°ºchr
 (c⁄° *
__s
, 
__c
Ë
__THROW


247  
	`__buûtö_°ºchr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$°ºchr
 (c⁄° *
__s
, 
__c
)

253 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

256 #ifde‡
__USE_GNU


259 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$°rch∫ul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

262 "C++" c⁄° *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("°rch∫ul"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

265 *
	$°rch∫ul
 (c⁄° *
__s
, 
__c
)

266 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

272 
size_t
 
	$°rc•n
 (c⁄° *
__s
, c⁄° *
__ªje˘
)

273 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

276 
size_t
 
	$°r•n
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

277 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

279 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
)

283 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

284 c⁄° *
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

285 
__THROW
 
	`__asm
 ("°Ωbrk"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

287 #ifde‡
__OPTIMIZE__


288 
__exã∫_Æways_ölöe
 *

289 
	`°Ωbrk
 (*
__s
, c⁄° *
__ac˚±
Ë
__THROW


291  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

294 
__exã∫_Æways_ölöe
 const *

295 
	`°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
Ë
__THROW


297  
	`__buûtö_°Ωbrk
 (
__s
, 
__ac˚±
);

300 
	}
}

302 *
	$°Ωbrk
 (c⁄° *
__s
, c⁄° *
__ac˚±
)

303 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

306 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

310 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

311 c⁄° *
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

312 
__THROW
 
	`__asm
 ("°r°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

314 #ifde‡
__OPTIMIZE__


315 
__exã∫_Æways_ölöe
 *

316 
	`°r°r
 (*
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


318  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

321 
__exã∫_Æways_ölöe
 const *

322 
	`°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
Ë
__THROW


324  
	`__buûtö_°r°r
 (
__hay°ack
, 
__√edÀ
);

327 
	}
}

329 *
	$°r°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

330 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

335 *
	$°πok
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
)

336 
__THROW
 
	`__n⁄nuŒ
 ((2));

340 *
	$__°πok_r
 (*
__ª°ri˘
 
__s
,

341 c⁄° *
__ª°ri˘
 
__dñim
,

342 **
__ª°ri˘
 
__ßve_±r
)

343 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

344 #ifde‡
__USE_POSIX


345 *
	$°πok_r
 (*
__ª°ri˘
 
__s
, c⁄° *__ª°ri˘ 
__dñim
,

346 **
__ª°ri˘
 
__ßve_±r
)

347 
__THROW
 
	`__n⁄nuŒ
 ((2, 3));

350 #ifde‡
__USE_GNU


352 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$°rˇ£°r
 (*
__hay°ack
, c⁄° *
__√edÀ
)

354 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

355 "C++" c⁄° *
	$°rˇ£°r
 (c⁄° *
__hay°ack
,

356 c⁄° *
__√edÀ
)

357 
__THROW
 
	`__asm
 ("°rˇ£°r"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

359 *
	$°rˇ£°r
 (c⁄° *
__hay°ack
, c⁄° *
__√edÀ
)

360 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

364 #ifde‡
__USE_GNU


368 *
	$memmem
 (c⁄° *
__hay°ack
, 
size_t
 
__hay°ackÀn
,

369 c⁄° *
__√edÀ
, 
size_t
 
__√edÀÀn
)

370 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 3));

374 *
	$__memp˝y
 (*
__ª°ri˘
 
__de°
,

375 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

376 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

377 *
	$memp˝y
 (*
__ª°ri˘
 
__de°
,

378 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

379 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

384 
size_t
 
	$°æí
 (c⁄° *
__s
)

385 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$°∫Àn
 (c⁄° *
__°rög
, 
size_t
 
__maxÀn
)

391 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

396 *
	$°ªº‹
 (
__î∫um
Ë
__THROW
;

397 #ifde‡
__USE_XOPEN2K


405 #i‡
deföed
 
__USE_XOPEN2K
 && !deföed 
__USE_GNU


408 #ifde‡
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
°ªº‹_r
,

410 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
),

411 
__xpg_°ªº‹_r
Ë
	`__n⁄nuŒ
 ((2));

413 
	$__xpg_°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

414 
__THROW
 
	`__n⁄nuŒ
 ((2));

415 
	#°ªº‹_r
 
__xpg_°ªº‹_r


	)

420 *
	$°ªº‹_r
 (
__î∫um
, *
__buf
, 
size_t
 
__buÊí
)

421 
__THROW
 
	`__n⁄nuŒ
 ((2)Ë
__wur
;

425 #ifde‡
__USE_XOPEN2K8


427 *
	$°ªº‹_l
 (
__î∫um
, 
loˇÀ_t
 
__l
Ë
__THROW
;

430 #ifde‡
__USE_MISC


431 
	~<°rögs.h
>

435 
	$ex∂icô_bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

439 *
	$°r£p
 (**
__ª°ri˘
 
__°rögp
,

440 c⁄° *
__ª°ri˘
 
__dñim
)

441 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$°rsig«l
 (
__sig
Ë
__THROW
;

449 *
	$__°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

450 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

451 *
	$°p˝y
 (*
__ª°ri˘
 
__de°
, c⁄° *__ª°ri˘ 
__§c
)

452 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

456 *
	$__°≤˝y
 (*
__ª°ri˘
 
__de°
,

457 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

458 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

459 *
	$°≤˝y
 (*
__ª°ri˘
 
__de°
,

460 c⁄° *
__ª°ri˘
 
__§c
, 
size_t
 
__n
)

461 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$°rvîscmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

467 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

470 *
	$°r‰y
 (*
__°rög
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

473 *
	$mem‰ob
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

475 #i‚de‡
ba£«me


480 #ifde‡
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£«me
 (*
__fûíame
)

482 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

483 "C++" c⁄° *
	$ba£«me
 (c⁄° *
__fûíame
)

484 
__THROW
 
	`__asm
 ("ba£«me"Ë
	`__n⁄nuŒ
 ((1));

486 *
	$ba£«me
 (c⁄° *
__fûíame
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

491 #i‡
	`__GNUC_PREREQ
 (3,4)

492 #i‡
__USE_FORTIFY_LEVEL
 > 0 && 
deföed
 
__f‹tify_fun˘i⁄


494 
	~<bôs/°rög_f‹tifõd.h
>

498 
__END_DECLS


	@/usr/include/linux/stddef.h

4 #i‚de‡
__Æways_ölöe


5 
	#__Æways_ölöe
 
__ölöe__


	)

	@/usr/include/strings.h

18 #i‚def 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<„©uªs.h
>

22 
	#__√ed_size_t


	)

23 
	~<°ddef.h
>

26 #i‡
deföed
 
__˝lu•lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


34 
	$bcmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

38 
	$bc›y
 (c⁄° *
__§c
, *
__de°
, 
size_t
 
__n
)

39 
__THROW
 
	`__n⁄nuŒ
 ((1, 2));

42 
	$bzîo
 (*
__s
, 
size_t
 
__n
Ë
__THROW
 
	`__n⁄nuŒ
 ((1));

45 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`ödex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

50 c⁄° *
	`ödex
 (c⁄° *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("ödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

53 #i‡
deföed
 
__OPTIMIZE__


54 
__exã∫_Æways_ölöe
 *

55 
	`ödex
 (*
__s
, 
__c
Ë
__THROW


57  
	`__buûtö_ödex
 (
__s
, 
__c
);

60 
__exã∫_Æways_ölöe
 const *

61 
	`ödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


63  
	`__buûtö_ödex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$ödex
 (c⁄° *
__s
, 
__c
)

69 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

73 #ifde‡
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`rödex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

78 c⁄° *
	`rödex
 (c⁄° *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("rödex"Ë
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

81 #i‡
deföed
 
__OPTIMIZE__


82 
__exã∫_Æways_ölöe
 *

83 
	`rödex
 (*
__s
, 
__c
Ë
__THROW


85  
	`__buûtö_rödex
 (
__s
, 
__c
);

88 
__exã∫_Æways_ölöe
 const *

89 
	`rödex
 (c⁄° *
__s
, 
__c
Ë
__THROW


91  
	`__buûtö_rödex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$rödex
 (c⁄° *
__s
, 
__c
)

97 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1));

101 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8
 || deföed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
Ë
__THROW
 
__©åibuã_c⁄°__
;

109 #ifdef 
__USE_MISC


110 
	$ff¶
 (
__l
Ë
__THROW
 
__©åibuã_c⁄°__
;

111 
__exãnsi⁄__
 
	$ff¶l
 (
__Œ
)

112 
__THROW
 
__©åibuã_c⁄°__
;

116 
	$°rˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
)

117 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

120 
	$°∫ˇ£cmp
 (c⁄° *
__s1
, c⁄° *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<bôs/ty≥s/loˇÀ_t.h
>

128 
	$°rˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
, 
loˇÀ_t
 
__loc
)

129 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 3));

133 
	$°∫ˇ£cmp_l
 (c⁄° *
__s1
, c⁄° *
__s2
,

134 
size_t
 
__n
, 
loˇÀ_t
 
__loc
)

135 
__THROW
 
__©åibuã_puª__
 
	`__n⁄nuŒ
 ((1, 2, 4));

138 
__END_DECLS


140 #i‡
	`__GNUC_PREREQ
 (3,4Ë&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
deföed
 
__f‹tify_fun˘i⁄


143 #i‡
deföed
 
__USE_MISC
 || !deföed 
__USE_XOPEN2K8


144 
	~<bôs/°rögs_f‹tifõd.h
>

	@/usr/include/features.h

18 #i‚def 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

119 #unde‡
__USE_ISOC11


120 #unde‡
__USE_ISOC99


121 #unde‡
__USE_ISOC95


122 #unde‡
__USE_ISOCXX11


123 #unde‡
__USE_POSIX


124 #unde‡
__USE_POSIX2


125 #unde‡
__USE_POSIX199309


126 #unde‡
__USE_POSIX199506


127 #unde‡
__USE_XOPEN


128 #unde‡
__USE_XOPEN_EXTENDED


129 #unde‡
__USE_UNIX98


130 #unde‡
__USE_XOPEN2K


131 #unde‡
__USE_XOPEN2KXSI


132 #unde‡
__USE_XOPEN2K8


133 #unde‡
__USE_XOPEN2K8XSI


134 #unde‡
__USE_LARGEFILE


135 #unde‡
__USE_LARGEFILE64


136 #unde‡
__USE_FILE_OFFSET64


137 #unde‡
__USE_MISC


138 #unde‡
__USE_ATFILE


139 #unde‡
__USE_GNU


140 #unde‡
__USE_FORTIFY_LEVEL


141 #unde‡
__KERNEL_STRICT_NAMES


142 #unde‡
__GLIBC_USE_DEPRECATED_GETS


146 #i‚de‡
_LOOSE_KERNEL_NAMES


147 
	#__KERNEL_STRICT_NAMES


	)

157 #i‡
deföed
 
__GNUC__
 && deföed 
__GNUC_MINOR__


158 
	#__GNUC_PREREQ
(
maj
, 
mö
) \

159 ((
__GNUC__
 << 16Ë+ 
__GNUC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

161 
	#__GNUC_PREREQ
(
maj
, 
mö
Ë0

	)

168 #i‡
deföed
 
__˛™g_maj‹__
 && deföed 
__˛™g_mö‹__


169 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
) \

170 ((
__˛™g_maj‹__
 << 16Ë+ 
__˛™g_mö‹__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

172 
	#__glibc_˛™g_¥îeq
(
maj
, 
mö
Ë0

	)

176 
	#__GLIBC_USE
(
F
Ë
__GLIBC_USE_
 ## 
	)
F

182 #i‡(
deföed
 
_BSD_SOURCE
 || deföed 
_SVID_SOURCE
) \

183 && !
deföed
 
	g_DEFAULT_SOURCE


185 #unde‡
_DEFAULT_SOURCE


186 
	#_DEFAULT_SOURCE
 1

	)

190 #ifde‡
_GNU_SOURCE


191 #unde‡
_ISOC95_SOURCE


192 
	#_ISOC95_SOURCE
 1

	)

193 #unde‡
_ISOC99_SOURCE


194 
	#_ISOC99_SOURCE
 1

	)

195 #unde‡
_ISOC11_SOURCE


196 
	#_ISOC11_SOURCE
 1

	)

197 #unde‡
_POSIX_SOURCE


198 
	#_POSIX_SOURCE
 1

	)

199 #unde‡
_POSIX_C_SOURCE


200 
	#_POSIX_C_SOURCE
 200809L

	)

201 #unde‡
_XOPEN_SOURCE


202 
	#_XOPEN_SOURCE
 700

	)

203 #unde‡
_XOPEN_SOURCE_EXTENDED


204 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

205 #unde‡
_LARGEFILE64_SOURCE


206 
	#_LARGEFILE64_SOURCE
 1

	)

207 #unde‡
_DEFAULT_SOURCE


208 
	#_DEFAULT_SOURCE
 1

	)

209 #unde‡
_ATFILE_SOURCE


210 
	#_ATFILE_SOURCE
 1

	)

215 #i‡(
deföed
 
_DEFAULT_SOURCE
 \

216 || (!
deföed
 
	g__STRICT_ANSI__
 \

217 && !
deföed
 
	g_ISOC99_SOURCE
 \

218 && !
deföed
 
	g_POSIX_SOURCE
 && !deföed 
	g_POSIX_C_SOURCE
 \

219 && !
deföed
 
	g_XOPEN_SOURCE
))

220 #unde‡
_DEFAULT_SOURCE


221 
	#_DEFAULT_SOURCE
 1

	)

225 #i‡(
deföed
 
_ISOC11_SOURCE
 \

226 || (
deföed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

227 
	#__USE_ISOC11
 1

	)

231 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

232 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

233 
	#__USE_ISOC99
 1

	)

237 #i‡(
deföed
 
_ISOC99_SOURCE
 || deföed 
_ISOC11_SOURCE
 \

238 || (
deföed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

239 
	#__USE_ISOC95
 1

	)

242 #ifde‡
__˝lu•lus


244 #i‡
__˝lu•lus
 >= 201703L

245 
	#__USE_ISOC11
 1

	)

249 #i‡
__˝lu•lus
 >201103L || 
deföed
 
__GXX_EXPERIMENTAL_CXX0X__


250 
	#__USE_ISOCXX11
 1

	)

251 
	#__USE_ISOC99
 1

	)

258 #ifde‡
_DEFAULT_SOURCE


259 #i‡!
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE


260 
	#__USE_POSIX_IMPLICITLY
 1

	)

262 #unde‡
_POSIX_SOURCE


263 
	#_POSIX_SOURCE
 1

	)

264 #unde‡
_POSIX_C_SOURCE


265 
	#_POSIX_C_SOURCE
 200809L

	)

268 #i‡((!
deföed
 
__STRICT_ANSI__
 \

269 || (
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

270 && !
deföed
 
_POSIX_SOURCE
 && !deföed 
_POSIX_C_SOURCE
)

271 
	#_POSIX_SOURCE
 1

	)

272 #i‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

273 
	#_POSIX_C_SOURCE
 2

	)

274 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

275 
	#_POSIX_C_SOURCE
 199506L

	)

276 #ñi‡
deföed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

277 
	#_POSIX_C_SOURCE
 200112L

	)

279 
	#_POSIX_C_SOURCE
 200809L

	)

281 
	#__USE_POSIX_IMPLICITLY
 1

	)

290 #i‡((!
deföed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

291 && (
deföed
 
_REENTRANT
 || deföed 
_THREAD_SAFE
))

292 
	#_POSIX_SOURCE
 1

	)

293 #unde‡
_POSIX_C_SOURCE


294 
	#_POSIX_C_SOURCE
 199506L

	)

297 #i‡(
deföed
 
_POSIX_SOURCE
 \

298 || (
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

299 || 
deföed
 
_XOPEN_SOURCE
)

300 
	#__USE_POSIX
 1

	)

303 #i‡
deföed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >2 || deföed 
_XOPEN_SOURCE


304 
	#__USE_POSIX2
 1

	)

307 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

308 
	#__USE_POSIX199309
 1

	)

311 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

312 
	#__USE_POSIX199506
 1

	)

315 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

316 
	#__USE_XOPEN2K
 1

	)

317 #unde‡
__USE_ISOC95


318 
	#__USE_ISOC95
 1

	)

319 #unde‡
__USE_ISOC99


320 
	#__USE_ISOC99
 1

	)

323 #i‡
deföed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

324 
	#__USE_XOPEN2K8
 1

	)

325 #unde‡
_ATFILE_SOURCE


326 
	#_ATFILE_SOURCE
 1

	)

329 #ifdef 
_XOPEN_SOURCE


330 
	#__USE_XOPEN
 1

	)

331 #i‡(
_XOPEN_SOURCE
 - 0) >= 500

332 
	#__USE_XOPEN_EXTENDED
 1

	)

333 
	#__USE_UNIX98
 1

	)

334 #unde‡
_LARGEFILE_SOURCE


335 
	#_LARGEFILE_SOURCE
 1

	)

336 #i‡(
_XOPEN_SOURCE
 - 0) >= 600

337 #i‡(
_XOPEN_SOURCE
 - 0) >= 700

338 
	#__USE_XOPEN2K8
 1

	)

339 
	#__USE_XOPEN2K8XSI
 1

	)

341 
	#__USE_XOPEN2K
 1

	)

342 
	#__USE_XOPEN2KXSI
 1

	)

343 #unde‡
__USE_ISOC95


344 
	#__USE_ISOC95
 1

	)

345 #unde‡
__USE_ISOC99


346 
	#__USE_ISOC99
 1

	)

349 #ifde‡
_XOPEN_SOURCE_EXTENDED


350 
	#__USE_XOPEN_EXTENDED
 1

	)

355 #ifde‡
_LARGEFILE_SOURCE


356 
	#__USE_LARGEFILE
 1

	)

359 #ifde‡
_LARGEFILE64_SOURCE


360 
	#__USE_LARGEFILE64
 1

	)

363 #i‡
deföed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

364 
	#__USE_FILE_OFFSET64
 1

	)

367 #i‡
deföed
 
_DEFAULT_SOURCE


368 
	#__USE_MISC
 1

	)

371 #ifdef 
_ATFILE_SOURCE


372 
	#__USE_ATFILE
 1

	)

375 #ifdef 
_GNU_SOURCE


376 
	#__USE_GNU
 1

	)

379 #i‡
deföed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

380 && 
__GNUC_PREREQ
 (4, 1Ë&& 
deföed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

381 #i‡
_FORTIFY_SOURCE
 > 1

382 
	#__USE_FORTIFY_LEVEL
 2

	)

384 
	#__USE_FORTIFY_LEVEL
 1

	)

387 
	#__USE_FORTIFY_LEVEL
 0

	)

394 #i‡
deföed
 
__˝lu•lus
 ? __˝lu•lu†>201402L : deföed 
__USE_ISOC11


395 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

397 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

402 
	~<°dc-¥edef.h
>

410 #unde‡
__GNU_LIBRARY__


411 
	#__GNU_LIBRARY__
 6

	)

415 
	#__GLIBC__
 2

	)

416 
	#__GLIBC_MINOR__
 27

	)

418 
	#__GLIBC_PREREQ
(
maj
, 
mö
) \

419 ((
__GLIBC__
 << 16Ë+ 
__GLIBC_MINOR__
 >((
maj
Ë<< 16Ë+ (
mö
))

	)

422 #i‚de‡
__ASSEMBLER__


423 #i‚de‡
_SYS_CDEFS_H


424 
	~<sys/cdefs.h
>

429 #i‡
deföed
 
__USE_FILE_OFFSET64
 && !deföed 
__REDIRECT


430 
	#__USE_LARGEFILE
 1

	)

431 
	#__USE_LARGEFILE64
 1

	)

437 #i‡
__GNUC_PREREQ
 (2, 7Ë&& 
deföed
 
__OPTIMIZE__
 \

438 && !
deföed
 
	g__OPTIMIZE_SIZE__
 && !deföed 
	g__NO_INLINE__
 \

439 && 
deföed
 
	g__exã∫_ölöe


440 
	#__USE_EXTERN_INLINES
 1

	)

448 
	~<gnu/°ubs.h
>

	@/usr/include/stdc-predef.h

18 #i‚def 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifde‡
__GCC_IEC_559


37 #i‡
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifde‡
__GCC_IEC_559_COMPLEX


45 #i‡
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

61 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
92
1672
acl.c
acl.h
balloc.c
bitmap.c
block_validity.c
dir.c
extents.c
extents_status.c
extents_status.h
file.c
filemap.c
fsmap.c
fsmap.h
fsync.c
hash.c
ialloc.c
indirect.c
inline.c
inode.c
internal.h
ioctl.c
jbd3/checkpoint.c
jbd3/commit.c
jbd3/jbd3.mod.c
jbd3/journal.c
jbd3/recovery.c
jbd3/revoke.c
jbd3/transaction.c
mballoc.c
mballoc.h
migrate.c
mmp.c
move_extent.c
namei.c
page-io.c
page-writeback.c
pxt4.h
pxt4.mod.c
pxt4_extents.h
pxt4_jbd3.c
pxt4_jbd3.h
readpage.c
resize.c
super.c
symlink.c
sysfs.c
truncate.h
xarray.c
xattr.c
xattr.h
xattr_security.c
xattr_trusted.c
xattr_user.c
/usr/include/linux/capability.h
/usr/include/linux/errno.h
/usr/include/linux/falloc.h
/usr/include/linux/fcntl.h
/usr/include/linux/fiemap.h
/usr/include/linux/fs.h
/usr/include/linux/fsmap.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/mman.h
/usr/include/linux/module.h
/usr/include/linux/posix_acl_xattr.h
/usr/include/linux/quota.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/stat.h
/usr/include/linux/string.h
/usr/include/linux/sysctl.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/utsname.h
/usr/include/linux/uuid.h
/usr/include/linux/version.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/asm-generic/hugetlb_encode.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/linux/stddef.h
/usr/include/strings.h
/usr/include/features.h
/usr/include/stdc-predef.h
